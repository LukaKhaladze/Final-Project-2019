require(["jquery","ajs/pkg"],function(jQuery,ajs){var $=jQuery;define("tinymce",function(){(function(a){var b=/^\s*|\s*$/g,c,d="B".replace(/A(.)|B/,"$1")==="$1";var e={majorVersion:"@@tinymce_major_version@@",minorVersion:"@@tinymce_minor_version@@",releaseDate:"@@tinymce_release_date@@",_init:function(){var b=this,c=document,d=navigator,e=d.userAgent,f,g,h,i,j,k;b.isOpera=a.opera&&opera.buildNumber;b.isWebKit=/WebKit/.test(e);b.isChrome=b.isWebKit&&/Chrome/.test(e);b.isSafari=b.isWebKit&&!b.isChrome;b.isIE11=e.indexOf("Trident/")!=-1&&e.indexOf("rv:")!=-1;b.isIE=!b.isWebKit&&!b.isOpera&&/MSIE/gi.test(e)&&/Explorer/gi.test(d.appName)||b.isIE11;b.isIE6=b.isIE&&/MSIE [56]/.test(e);b.isIE7=b.isIE&&/MSIE [7]/.test(e);b.isIE8=b.isIE&&/MSIE [8]/.test(e);b.isIE9=b.isIE&&/MSIE [9]/.test(e);b.isIE10=b.isIE&&/MSIE [10]/.test(e);b.isGecko=!b.isWebKit&&!b.isIE11&&/Gecko/.test(e);b.isMac=e.indexOf("Mac")!=-1;b.isAir=/adobeair/i.test(e);b.isIDevice=/(iPad|iPhone)/.test(e);b.isIOS5=b.isIDevice&&e.match(/AppleWebKit\/(\d*)/)[1]>=534;if(a.tinyMCEPreInit){b.suffix=tinyMCEPreInit.suffix;b.baseURL=tinyMCEPreInit.base;b.query=tinyMCEPreInit.query;return}b.suffix="";g=c.getElementsByTagName("base");for(f=0;f<g.length;f++){k=g[f].href;if(k){if(/^https?:\/\/[^\/]+$/.test(k))k+="/";i=k?k.match(/.*\//)[0]:""}}function l(a){if(a.src&&/tiny_mce(|_gzip|_jquery|_prototype|_full)(_dev|_src)?.js/.test(a.src)){if(/_(src|dev)\.js/g.test(a.src))b.suffix="_src";if((j=a.src.indexOf("?"))!=-1)b.query=a.src.substring(j+1);b.baseURL=a.src.substring(0,a.src.lastIndexOf("/"));if(i&&b.baseURL.indexOf("://")==-1&&b.baseURL.indexOf("/")!==0)b.baseURL=i+b.baseURL;return b.baseURL}return null}g=c.getElementsByTagName("script");for(f=0;f<g.length;f++){if(l(g[f]))return}h=c.getElementsByTagName("head")[0];if(h){g=h.getElementsByTagName("script");for(f=0;f<g.length;f++){if(l(g[f]))return}}return},is:function(a,b){if(!b)return a!==c;if(b=="array"&&e.isArray(a))return true;return typeof a==b},isArray:Array.isArray||function(a){return Object.prototype.toString.call(a)==="[object Array]"},makeMap:function(a,b,c){var d;a=a||[];b=b||",";if(typeof a=="string")a=a.split(b);c=c||{};d=a.length;while(d--)c[a[d]]={};return c},each:function(a,b,d){var e,f;if(!a)return 0;d=d||a;if(a.length!==c){for(e=0,f=a.length;e<f;e++){if(b.call(d,a[e],e,a)===false)return 0}}else{for(e in a){if(a.hasOwnProperty(e)){if(b.call(d,a[e],e,a)===false)return 0}}}return 1},map:function(a,b){var c=[];e.each(a,function(a){c.push(b(a))});return c},grep:function(a,b){var c=[];e.each(a,function(a){if(!b||b(a))c.push(a)});return c},inArray:function(a,b){var c,d;if(a){for(c=0,d=a.length;c<d;c++){if(a[c]===b)return c}}return-1},extend:function(a,b){var d,e,f,g=arguments,h;for(d=1,e=g.length;d<e;d++){b=g[d];for(f in b){if(b.hasOwnProperty(f)){h=b[f];if(h!==c){a[f]=h}}}}return a},trim:function(a){return(a?""+a:"").trim()},create:function(a,b,c){var d=this,e,f,g,h,i,j=0;a=/^((static) )?([\w.]+)(:([\w.]+))?/.exec(a);g=a[3].match(/(^|\.)(\w+)$/i)[2];f=d.createNS(a[3].replace(/\.\w+$/,""),c);if(f[g])return;if(a[2]=="static"){f[g]=b;if(this.onCreate)this.onCreate(a[2],a[3],f[g]);return}if(!b[g]){b[g]=function(){};j=1}f[g]=b[g];d.extend(f[g].prototype,b);if(a[5]){e=d.resolve(a[5]).prototype;h=a[5].match(/\.(\w+)$/i)[1];i=f[g];if(j){f[g]=function(){return e[h].apply(this,arguments)}}else{f[g]=function(){this.parent=e[h];return i.apply(this,arguments)}}f[g].prototype[g]=f[g];d.each(e,function(a,b){f[g].prototype[b]=e[b]});d.each(b,function(a,b){if(e[b]){f[g].prototype[b]=function(){this.parent=e[b];return a.apply(this,arguments)}}else{if(b!=g)f[g].prototype[b]=a}})}d.each(b["static"],function(a,b){f[g][b]=a});if(this.onCreate)this.onCreate(a[2],a[3],f[g].prototype)},walk:function(a,b,c,d){d=d||this;if(a){if(c)a=a[c];e.each(a,function(a,f){if(b.call(d,a,f,c)===false)return false;e.walk(a,b,c,d)})}},createNS:function(b,c){var d,e;c=c||a;b=b.split(".");for(d=0;d<b.length;d++){e=b[d];if(!c[e])c[e]={};c=c[e]}return c},resolve:function(b,c){var d,e;c=c||a;b=b.split(".");for(d=0,e=b.length;d<e;d++){c=c[b[d]];if(!c)break}return c},addUnload:function(b,c){var d=this,e;e=function(){var b=d.unloads,c,g;if(b){for(g in b){c=b[g];if(c&&c.func)c.func.call(c.scope,1)}if(typeof a.removeEventListener==="function"){a.removeEventListener("unload",e,false)}else if(typeof a.detachEvent==="function"){a.detachEvent("onbeforeunload",f);a.detachEvent("onunload",e)}d.unloads=c=b=w=e=0;if(a.CollectGarbage)CollectGarbage()}};function f(){var b=document;function c(){b.detachEvent("onstop",c);if(e)e();b=0}if(b.readyState=="interactive"){if(b)b.attachEvent("onstop",c);a.setTimeout(function(){if(b)b.detachEvent("onstop",c)},0)}}b={func:b,scope:c||this};if(!d.unloads){if(a.attachEvent){a.attachEvent("onunload",e);a.attachEvent("onbeforeunload",f)}else if(a.addEventListener)a.addEventListener("unload",e,false);d.unloads=[b]}else d.unloads.push(b);return b},removeUnload:function(a){var b=this.unloads,c=null;e.each(b,function(d,e){if(d&&d.func==a){b.splice(e,1);c=a;return false}});return c},explode:function(a,b){if(!a||e.is(a,"array")){return a}return e.map(a.split(b||","),e.trim)},_addVer:function(a){var b;if(!this.query)return a;b=(a.indexOf("?")==-1?"?":"&")+this.query;if(a.indexOf("#")==-1)return a+b;return a.replace("#",b+"#")},_replace:function(a,b,e){if(d){return e.replace(a,function(){var a=b,d=arguments,e;for(e=0;e<d.length-2;e++){if(d[e]===c){a=a.replace(new RegExp("\\$"+e,"g"),"")}else{a=a.replace(new RegExp("\\$"+e,"g"),d[e])}}return a})}return e.replace(a,b)}};e._init();a.tinymce=a.tinyMCE=e})(window);(function($,a){var b=a.is,c=/^(href|src|style)$/i,d;if(!$&&window.console){return console.log("Load jQuery first!")}a.$=$;a.adapter={patchEditor:function(a){var b=$.fn;function e(a,c){var d=this;if(c)d.removeAttr("data-mce-style");return b.css.apply(d,arguments)}function f(e,f){var g=this;if(c.test(e)){if(f!==d){g.each(function(b,c){a.dom.setAttrib(c,e,f)});return g}else return g.attr("data-mce-"+e)}return b.attr.apply(g,arguments)}function g(c){if(c.css!==e){c.css=e;c.attr=f;c.tinymce=a;c.pushStack=function(){return g(b.pushStack.apply(this,arguments))}}return c}a.$=function(b,c){var d=a.getDoc();return g($(b||d,d||c))}}};a.extend=$.extend;a.extend(a,{map:$.map,grep:function(a,b){return $.grep(a,b||function(){return 1})},inArray:function(a,b){return $.inArray(b,a||[])}});var e={"tinymce.dom.DOMUtils":{select:function(a,b){var c=this;return $.find(a,c.get(b)||c.get(c.settings.root_element)||c.doc,[])},is:function(a,b){return $(this.get(a)).is(b)}}};a.onCreate=function(b,c,d){a.extend(d,e[c])}})(window.jQuery,tinymce);tinymce.create("tinymce.util.Dispatcher",{scope:null,listeners:null,inDispatch:false,Dispatcher:function(a){this.scope=a||this;this.listeners=[]},add:function(a,b){this.listeners.push({cb:a,scope:b||this.scope});return a},addToTop:function(a,b){var c=this,d={cb:a,scope:b||c.scope};if(c.inDispatch){c.listeners=[d].concat(c.listeners)}else{c.listeners.unshift(d)}return a},remove:function(a){var b=this.listeners,c=null;tinymce.each(b,function(d,e){if(a==d.cb){c=d;b.splice(e,1);return false}});return c},dispatch:function(){var a=this,b,c=arguments,d,e=a.listeners,f;a.inDispatch=true;for(d=0;d<e.length;d++){f=e[d];b=f.cb.apply(f.scope,c.length>0?c:[f.scope]);if(b===false)break}a.inDispatch=false;return b}});(function(){var a=tinymce.each;tinymce.create("tinymce.util.URI",{URI:function(b,c){var d=this,e,f,g,h;b=tinymce.trim(b);c=d.settings=c||{};if(/^([\w\-]+):([^\/]{2})/i.test(b)||/^\s*#/.test(b)){d.source=b;return}if(b.indexOf("/")===0&&b.indexOf("//")!==0)b=(c.base_uri?c.base_uri.protocol||"http":"http")+"://mce_host"+b;if(!/^[\w\-]*:?\/\//.test(b)){h=c.base_uri?c.base_uri.path:new tinymce.util.URI(location.href).directory;b=(c.base_uri&&c.base_uri.protocol||"http")+"://mce_host"+d.toAbsPath(h,b)}b=b.replace(/@@/g,"(mce_at)");b=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@\/]*):?([^:@\/]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/.exec(b);a(["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],function(a,c){var e=b[c];if(e)e=e.replace(/\(mce_at\)/g,"@@");d[a]=e});g=c.base_uri;if(g){if(!d.protocol)d.protocol=g.protocol;if(!d.userInfo)d.userInfo=g.userInfo;if(!d.port&&d.host==="mce_host")d.port=g.port;if(!d.host||d.host==="mce_host")d.host=g.host;d.source=""}},setPath:function(a){var b=this;a=/^(.*?)\/?(\w+)?$/.exec(a);b.path=a[0];b.directory=a[1];b.file=a[2];b.source="";b.getURI()},toRelative:function(a){var b=this,c;if(a==="./")return a;a=new tinymce.util.URI(a,{base_uri:b});if(a.host!="mce_host"&&b.host!=a.host&&a.host||b.port!=a.port||b.protocol!=a.protocol)return a.getURI();var d=b.getURI(),e=a.getURI();if(d==e||d.charAt(d.length-1)=="/"&&d.substr(0,d.length-1)==e)return d;c=b.toRelPath(b.path,a.path);if(a.query)c+="?"+a.query;if(a.anchor)c+="#"+a.anchor;return c},toAbsolute:function(a,b){a=new tinymce.util.URI(a,{base_uri:this});return a.getURI(this.host==a.host&&this.protocol==a.protocol?b:0)},toRelPath:function(a,b){var c,d=0,e="",f,g;a=a.substring(0,a.lastIndexOf("/"));a=a.split("/");c=b.split("/");if(a.length>=c.length){for(f=0,g=a.length;f<g;f++){if(f>=c.length||a[f]!=c[f]){d=f+1;break}}}if(a.length<c.length){for(f=0,g=c.length;f<g;f++){if(f>=a.length||a[f]!=c[f]){d=f+1;break}}}if(d===1)return b;for(f=0,g=a.length-(d-1);f<g;f++)e+="../";for(f=d-1,g=c.length;f<g;f++){if(f!=d-1)e+="/"+c[f];else e+=c[f]}return e},toAbsPath:function(b,c){var d,e=0,f=[],g,h;g=/\/$/.test(c)?"/":"";b=b.split("/");c=c.split("/");a(b,function(a){if(a)f.push(a)});b=f;for(d=c.length-1,f=[];d>=0;d--){if(c[d].length===0||c[d]===".")continue;if(c[d]===".."){e++;continue}if(e>0){e--;continue}f.push(c[d])}d=b.length-e;if(d<=0)h=f.reverse().join("/");else h=b.slice(0,d).join("/")+"/"+f.reverse().join("/");if(h.indexOf("/")!==0)h="/"+h;if(g&&h.lastIndexOf("/")!==h.length-1)h+=g;return h},getURI:function(a){var b,c=this;if(!c.source||a){b="";if(!a){if(c.protocol)b+=c.protocol+"://";if(c.userInfo)b+=c.userInfo+"@";if(c.host)b+=c.host;if(c.port)b+=":"+c.port}if(c.path)b+=c.path;if(c.query)b+="?"+c.query;if(c.anchor)b+="#"+c.anchor;c.source=b}return c.source}})})();(function(){var a=tinymce.each;tinymce.create("static tinymce.util.Cookie",{getHash:function(b){var c=this.get(b),d;if(c){a(c.split("&"),function(a){a=a.split("=");d=d||{};d[unescape(a[0])]=unescape(a[1])})}return d},setHash:function(b,c,d,e,f,g){var h="";a(c,function(a,b){h+=(!h?"":"&")+escape(b)+"="+escape(a)});this.set(b,h,d,e,f,g)},get:function(a){var b=document.cookie,c,d=a+"=",e;if(!b)return;e=b.indexOf("; "+d);if(e==-1){e=b.indexOf(d);if(e!==0)return null}else e+=2;c=b.indexOf(";",e);if(c==-1)c=b.length;return unescape(b.substring(e+d.length,c))},set:function(a,b,c,d,e,f){document.cookie=a+"="+escape(b)+(c?"; expires="+c.toGMTString():"")+(d?"; path="+escape(d):"")+(e?"; domain="+e:"")+(f?"; secure":"")},remove:function(a,b,c){var d=new Date;d.setTime(d.getTime()-1e3);this.set(a,"",d,b,c)}})})();(function(){function serialize(a,b){var c,d,e,f;b=b||'"';if(a==null)return"null";e=typeof a;if(e=="string"){d="\bb\tt\nn\ff\rr\"\"''\\\\";return b+a.replace(/([\u0080-\uFFFF\x00-\x1f\"\'\\])/g,function(a,e){if(b==='"'&&a==="'")return a;c=d.indexOf(e);if(c+1)return"\\"+d.charAt(c+1);a=e.charCodeAt().toString(16);return"\\u"+"0000".substring(a.length)+a})+b}if(e=="object"){if(a.hasOwnProperty&&Object.prototype.toString.call(a)==="[object Array]"){for(c=0,d="[";c<a.length;c++)d+=(c>0?",":"")+serialize(a[c],b);return d+"]"}d="{";for(f in a){if(a.hasOwnProperty(f)){d+=typeof a[f]!="function"?(d.length>1?","+b:b)+f+b+":"+serialize(a[f],b):""}}return d+"}"}return""+a}tinymce.util.JSON={serialize:serialize,parse:function(s){try{return eval("("+s+")")}catch(a){}}}})();tinymce.create("static tinymce.util.JSONP",{callbacks:{},count:0,send:function(a){var b=this,c=tinymce.DOM,d=a.count!==undefined?a.count:b.count,e="tinymce_jsonp_"+d;b.callbacks[d]=function(f){c.remove(e);delete b.callbacks[d];a.callback(f)};c.add(c.doc.body,"script",{id:e,src:a.url,type:"text/javascript"});b.count++}});tinymce.create("static tinymce.util.XHR",{send:function(a){var b,c,d=window,e=0;function f(){if(!a.async||b.readyState==4||e++>1e4){if(a.success&&e<1e4&&b.status==200)a.success.call(a.success_scope,""+b.responseText,b,a);else if(a.error)a.error.call(a.error_scope,e>1e4?"TIMED_OUT":"GENERAL",b,a);b=null}else d.setTimeout(f,10)}a.scope=a.scope||this;a.success_scope=a.success_scope||a.scope;a.error_scope=a.error_scope||a.scope;a.async=a.async===false?false:true;a.data=a.data||"";function g(a){b=0;try{b=new ActiveXObject(a)}catch(a){}return b}b=d.XMLHttpRequest?new XMLHttpRequest:g("Microsoft.XMLHTTP")||g("Msxml2.XMLHTTP");if(b){if(b.overrideMimeType)b.overrideMimeType(a.content_type);b.open(a.type||(a.data?"POST":"GET"),a.url,a.async);if(a.content_type)b.setRequestHeader("Content-Type",a.content_type);b.setRequestHeader("X-Requested-With","XMLHttpRequest");b.send(a.data);if(!a.async)return f();c=d.setTimeout(f,10)}}});(function(){var a=tinymce.extend,b=tinymce.util.JSON,c=tinymce.util.XHR;tinymce.create("tinymce.util.JSONRequest",{JSONRequest:function(b){this.settings=a({},b);this.count=0},send:function(d){var e=d.error,f=d.success;d=a(this.settings,d);d.success=function(a,c){a=b.parse(a);if(typeof a=="undefined"){a={error:"JSON Parse error."}}if(a.error)e.call(d.error_scope||d.scope,a.error,c);else f.call(d.success_scope||d.scope,a.result)};d.error=function(a,b){if(e)e.call(d.error_scope||d.scope,a,b)};d.data=b.serialize({id:d.id||"c"+this.count++,method:d.method,params:d.params});d.content_type="application/json";c.send(d)},static:{sendRPC:function(a){return(new tinymce.util.JSONRequest).send(a)}}})})();(function(a){a.VK={BACKSPACE:8,DELETE:46,DOWN:40,ENTER:13,LEFT:37,RIGHT:39,SPACEBAR:32,TAB:9,UP:38,modifierPressed:function(a){return a.shiftKey||a.ctrlKey||a.altKey},metaKeyPressed:function(b){return a.isMac?b.metaKey:b.ctrlKey&&!b.altKey}}})(tinymce);tinymce.util.Quirks=function(a){var b=tinymce.VK,c=b.BACKSPACE,d=b.DELETE,e=a.dom,f=a.selection,g=a.settings,h=a.parser,i=a.serializer,j=tinymce.each;function k(b,c){try{a.getDoc().execCommand(b,false,c)}catch(a){}}function l(){var b=a.getDoc().documentMode;return b?b:6}function m(a){return a.isDefaultPrevented()}function n(){function g(b){var c,d,g,h;c=f.getRng();d=e.getParent(c.startContainer,e.isBlock);if(b){d=e.getNext(d,e.isBlock)}if(d){g=d.firstChild;while(g&&g.nodeType==3&&g.nodeValue.length===0){g=g.nextSibling}if(g&&g.nodeName==="SPAN"){h=g.cloneNode(false)}}j(e.select("span",d),function(a){a.setAttribute("data-mce-mark","1")});a.getDoc().execCommand(b?"ForwardDelete":"Delete",false,null);d=e.getParent(c.startContainer,e.isBlock);j(e.select("span",d),function(a){var b=f.getBookmark();if(h){e.replace(h.cloneNode(false),a,true)}else if(!a.getAttribute("data-mce-mark")){e.remove(a,true)}else{a.removeAttribute("data-mce-mark")}f.moveToBookmark(b)})}a.onKeyDown.add(function(a,e){var f;f=e.keyCode==d;if(!m(e)&&(f||e.keyCode==c)&&!b.modifierPressed(e)){e.preventDefault();g(f)}});a.addCommand("Delete",function(){g()})}function o(){function b(a){var b=e.create("body");var c=a.cloneContents();b.appendChild(c);return f.serializer.serialize(b,{format:"html"})}function g(c){var d=b(c);var f=e.createRng();f.selectNode(a.getBody());var g=b(f);return d===g}a.onKeyDown.add(function(a,b){var f=b.keyCode,h;if(!m(b)&&(f==d||f==c)){h=a.selection.isCollapsed();if(h&&!e.isEmpty(a.getBody())){return}if(tinymce.isIE&&!h){return}if(!h&&!g(a.selection.getRng())){return}a.setContent("");a.selection.setCursorLocation(a.getBody(),0);a.nodeChanged()}})}function p(){a.onKeyDown.add(function(a,c){if(!m(c)&&c.keyCode==65&&b.metaKeyPressed(c)){c.preventDefault();a.execCommand("SelectAll")}})}function q(){if(!a.settings.content_editable){e.bind(a.getDoc(),"focusin",function(a){f.setRng(f.getRng())});e.bind(a.getDoc(),"mousedown",function(b){if(b.target==a.getDoc().documentElement){a.getWin().focus();f.setRng(f.getRng())}})}}function r(){a.onKeyDown.add(function(a,b){if(!m(b)&&b.keyCode===c){if(f.isCollapsed()&&f.getRng(true).startOffset===0){var d=f.getNode();var g=d.previousSibling;if(g&&g.nodeName&&g.nodeName.toLowerCase()==="hr"){e.remove(g);tinymce.dom.Event.cancel(b)}}}})}function s(){if(!Range.prototype.getClientRects){a.onMouseDown.add(function(a,b){if(!m(b)&&b.target.nodeName==="HTML"){var c=a.getBody();c.blur();setTimeout(function(){c.focus()},0)}})}}function t(){a.onClick.add(function(a,b){b=b.target;var c=b.parentNode;if(/^(IMG|HR)$/.test(b.nodeName)&&c.nodeName=="A"&&c.children.length==1){window.open(c.href,"_blank")}})}function u(){a.onClick.add(function(a,b){b=b.target;if(/^(IMG|HR)$/.test(b.nodeName)){try{f.getSel().setBaseAndExtent(b,0,b,1)}catch(a){f.getSel().setBaseAndExtent(b,0,b,0)}}if(b.nodeName=="A"&&e.hasClass(b,"mceItemAnchor")){f.select(b)}a.nodeChanged()})}function v(){function b(){var b=e.getAttribs(f.getStart().cloneNode(false));return function(){var c=f.getStart();if(c!==a.getBody()){e.setAttrib(c,"style",null);j(b,function(a){c.setAttributeNode(a.cloneNode(true))})}}}function c(){return!f.isCollapsed()&&e.getParent(f.getStart(),e.isBlock)!=e.getParent(f.getEnd(),e.isBlock)}function d(a,b){b.preventDefault();return false}a.onKeyPress.add(function(a,d){var e;if(!m(d)&&(d.keyCode==8||d.keyCode==46)&&c()){e=b();a.getDoc().execCommand("delete",false,null);e();d.preventDefault();return false}});e.bind(a.getDoc(),"cut",function(e){var f;if(!m(e)&&c()){f=b();a.onKeyUp.addToTop(d);setTimeout(function(){f();a.onKeyUp.remove(d)},0)}})}function w(){var b,c;e.bind(a.getDoc(),"selectionchange",function(){if(c){clearTimeout(c);c=0}c=window.setTimeout(function(){var c=f.getRng();if(!b||!tinymce.dom.RangeUtils.compareRanges(c,b)){a.nodeChanged();b=c}},50)})}function x(){document.body.setAttribute("role","application")}function y(){a.onKeyDown.add(function(a,b){if(!m(b)&&b.keyCode===c){if(f.isCollapsed()&&f.getRng(true).startOffset===0){var d=f.getNode().previousSibling;if(d&&d.nodeName&&d.nodeName.toLowerCase()==="table"){return tinymce.dom.Event.cancel(b)}}}})}function z(){if(l()>7){return}k("RespectVisibilityInDesign",true);a.contentStyles.push(".mceHideBrInPre pre br {display: none}");e.addClass(a.getBody(),"mceHideBrInPre");h.addNodeFilter("pre",function(a,b){var c=a.length,d,e,f,g;while(c--){d=a[c].getAll("br");e=d.length;while(e--){f=d[e];g=f.prev;if(g&&g.type===3&&g.value.charAt(g.value-1)!="\n"){g.value+="\n"}else{f.parent.insert(new tinymce.html.Node("#text",3),f,true).value="\n"}}}});i.addNodeFilter("pre",function(a,b){var c=a.length,d,e,f,g;while(c--){d=a[c].getAll("br");e=d.length;while(e--){f=d[e];g=f.prev;if(g&&g.type==3){g.value=g.value.replace(/\r?\n$/,"")}}}})}function A(){e.bind(a.getBody(),"mouseup",function(a){var b,c=f.getNode();if(c.nodeName=="IMG"){if(b=e.getStyle(c,"width")){e.setAttrib(c,"width",b.replace(/[^0-9%]+/g,""));e.setStyle(c,"width","")}if(b=e.getStyle(c,"height")){e.setAttrib(c,"height",b.replace(/[^0-9%]+/g,""));e.setStyle(c,"height","")}}})}function B(){a.onKeyDown.add(function(a,g){var h,i,j,k,l,n,o;h=g.keyCode==d;if(!m(g)&&(h||g.keyCode==c)&&!b.modifierPressed(g)){i=f.getRng();j=i.startContainer;k=i.startOffset;o=i.collapsed;if(j.nodeType==3&&j.nodeValue.length>0&&(k===0&&!o||o&&k===(h?0:1))){nonEmptyElements=a.schema.getNonEmptyElements();g.preventDefault();a.getDoc().execCommand(h?"ForwardDelete":"Delete",false,null);j=f.getRng().startContainer;n=j.previousSibling;if(n&&n.nodeType==1&&!e.isBlock(n)&&e.isEmpty(n)&&!nonEmptyElements[n.nodeName.toLowerCase()]){e.remove(n)}}}})}function C(){a.onKeyDown.add(function(a,c){var d,g,h,i,j;if(m(c)||c.keyCode!=b.BACKSPACE){return}d=f.getRng();g=d.startContainer;h=d.startOffset;i=e.getRoot();j=g;if(!d.collapsed||h!==0){return}while(j&&j.parentNode&&j.parentNode.firstChild==j&&j.parentNode!=i){j=j.parentNode}if(j.tagName==="BLOCKQUOTE"){a.formatter.toggle("blockquote",null,j);d=e.createRng();d.setStart(g,0);d.setEnd(g,0);f.setRng(d)}})}function D(){function b(){a._refreshContentEditable();k("StyleWithCSS",false);k("enableInlineTableEditing",false);if(!g.object_resizing){k("enableObjectResizing",false)}}if(!g.readonly){a.onBeforeExecCommand.add(b);a.onMouseDown.add(b)}}function E(){function b(a,b){j(e.select("a"),function(a){var b=a.parentNode,c=e.getRoot();if(b.lastChild===a){while(b&&!e.isBlock(b)){if(b.parentNode.lastChild!==b||b===c){return}b=b.parentNode}e.add(b,"br",{"data-mce-bogus":1})}})}a.onExecCommand.add(function(a,c){if(c==="CreateLink"){b(a)}});a.onSetContent.add(f.onSetContent.add(b))}function F(){if(g.forced_root_block){a.onInit.add(function(){k("DefaultParagraphSeparator",g.forced_root_block)})}}function G(){function b(b,c){if(!b||!c.initial){a.execCommand("mceRepaint")}}a.onUndo.add(b);a.onRedo.add(b);a.onSetContent.add(b)}function H(){a.onKeyDown.add(function(a,b){var d;if(!m(b)&&b.keyCode==c){d=a.getDoc().selection.createRange();if(d&&d.item){b.preventDefault();a.undoManager.beforeChange();e.remove(d.item(0));a.undoManager.add()}}})}function I(){var b;if(l()>=10){b="";j("p div h1 h2 h3 h4 h5 h6".split(" "),function(a,c){b+=(c>0?",":"")+a+":empty"});a.contentStyles.push(b+"{padding-right: 1px !important}")}}function J(){a.onSetContent.add(b);a.onChange.add(b);function b(a,b){tinymce.$(a.contentDocument).find("img").attr("unselectable","on")}}function K(){var c,d,h,i,l,m,n,o,p,q,r,s,t,u=document,v=a.getDoc();if(!g.object_resizing||g.webkit_fake_resize===false){return}k("enableObjectResizing",false);r={n:[.5,0,0,-1],e:[1,.5,1,0],s:[.5,1,0,1],w:[0,.5,-1,0],nw:[0,0,-1,-1],ne:[1,0,1,-1],se:[1,1,1,1],sw:[0,1,-1,1]};function w(a){var f,g;f=a.screenX-m;g=a.screenY-n;s=f*l[2]+o;t=g*l[3]+p;s=s<5?5:s;t=t<5?5:t;if(b.modifierPressed(a)||h.nodeName=="IMG"&&l[2]*l[3]!==0){s=Math.round(t/q);t=Math.round(s*q)}e.setStyles(i,{width:s,height:t});if(l[2]<0&&i.clientWidth<=s){e.setStyle(i,"left",c+(o-s))}if(l[3]<0&&i.clientHeight<=t){e.setStyle(i,"top",d+(p-t))}}function x(){function b(b,c){if(c){if(h.style[b]||!a.schema.isValid(h.nodeName.toLowerCase(),b)){e.setStyle(h,b,c)}else{e.setAttrib(h,b,c)}}}b("width",s);b("height",t);e.unbind(v,"mousemove",w);e.unbind(v,"mouseup",x);if(u!=v){e.unbind(u,"mousemove",w);e.unbind(u,"mouseup",x)}e.remove(i);y(h)}function y(a){var b,f,g;z();b=e.getPos(a);c=b.x;d=b.y;f=a.offsetWidth;g=a.offsetHeight;if(h!=a){h=a;s=t=0}if(h.className.indexOf("mceItemNoResize")>-1){return}j(r,function(a,b){var j;j=e.get("mceResizeHandle"+b);if(!j){j=e.add(v.documentElement,"div",{id:"mceResizeHandle"+b,class:"mceResizeHandle",style:"cursor:"+b+"-resize; margin:0; padding:0"});e.bind(j,"mousedown",function(b){b.preventDefault();x();m=b.screenX;n=b.screenY;o=h.clientWidth;p=h.clientHeight;q=p/o;l=a;i=h.cloneNode(true);e.addClass(i,"mceClonedResizable");e.setStyles(i,{left:c,top:d,margin:0});v.documentElement.appendChild(i);e.bind(v,"mousemove",w);e.bind(v,"mouseup",x);if(u!=v){e.bind(u,"mousemove",w);e.bind(u,"mouseup",x)}})}else{e.show(j)}e.setStyles(j,{left:f*a[0]+c-j.offsetWidth/2,top:g*a[1]+d-j.offsetHeight/2})});if(!tinymce.isOpera&&h.nodeName=="IMG"){h.setAttribute("data-mce-selected","1")}}function z(){if(h){h.removeAttribute("data-mce-selected")}for(var a in r){e.hide("mceResizeHandle"+a)}}a.contentStyles.push(".mceResizeHandle {"+"position: absolute;"+"border: 1px solid black;"+"background: #FFF;"+"width: 5px;"+"height: 5px;"+"z-index: 10000"+"}"+".mceResizeHandle:hover {"+"background: #000"+"}"+"img[data-mce-selected] {"+"outline: 1px solid black"+"}"+"img.mceClonedResizable, table.mceClonedResizable {"+"position: absolute;"+"outline: 1px dashed black;"+"opacity: .5;"+"z-index: 10000"+"}");function A(){var a=e.getParent(f.getNode(),"table,img");j(e.select("img[data-mce-selected]"),function(a){a.removeAttribute("data-mce-selected")});if(a){y(a)}else{z()}}a.onNodeChange.add(A);e.bind(v,"selectionchange",A);a.serializer.addAttributeFilter("data-mce-selected",function(a,b){var c=a.length;while(c--){a[c].attr(b,null)}})}function L(){if(l()<9){h.addNodeFilter("noscript",function(a){var b=a.length,c,d;while(b--){c=a[b];d=c.firstChild;if(d){c.attr("data-mce-innertext",d.value)}}});i.addNodeFilter("noscript",function(a){var b=a.length,c,d,e;while(b--){c=a[b];d=a[b].firstChild;if(d){d.value=tinymce.html.Entities.decode(d.value)}else{e=c.attributes.map["data-mce-innertext"];if(e){c.attr("data-mce-innertext",null);d=new tinymce.html.Node("#text",3);d.value=e;d.raw=true;c.append(d)}}}})}}y();t();o();if(tinymce.isWebKit){B();q();u();F();if(tinymce.isIDevice){w()}else{K();p()}}if(tinymce.isIE10||tinymce.isIE11){J();K()}if(tinymce.isIE&&!tinymce.isIE11){r();x();z();A();H();I();L()}if(tinymce.isGecko){r();s();v();D();E();G()}if(tinymce.isOpera){K()}};(function(a){var b,c,d,e=/[&<>\"\u007E-\uD7FF\uE000-\uFFEF]|[\uD800-\uDBFF][\uDC00-\uDFFF]/g,f=/[<>&\u007E-\uD7FF\uE000-\uFFEF]|[\uD800-\uDBFF][\uDC00-\uDFFF]/g,g=/[<>&\"\']/g,h=/&(#x|#)?([\w]+);/g,i={128:"€",130:"‚",131:"ƒ",132:"„",133:"…",134:"†",135:"‡",136:"ˆ",137:"‰",138:"Š",139:"‹",140:"Œ",142:"Ž",145:"‘",146:"’",147:"“",148:"”",149:"•",150:"–",151:"—",152:"˜",153:"™",154:"š",155:"›",156:"œ",158:"ž",159:"Ÿ"};c={'"':"&quot;","'":"&#39;","<":"&lt;",">":"&gt;","&":"&amp;"};d={"&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"',"&apos;":"'"};function j(a){var b;b=document.createElement("div");b.innerHTML=a;return b.textContent||b.innerText||a}function k(a,b){var d,e,f,g={};if(a){a=a.split(",");b=b||10;for(d=0;d<a.length;d+=2){e=String.fromCharCode(parseInt(a[d],b));if(!c[e]){f="&"+a[d+1]+";";g[e]=f;g[f]=e}}return g}}b=k("50,nbsp,51,iexcl,52,cent,53,pound,54,curren,55,yen,56,brvbar,57,sect,58,uml,59,copy,"+"5a,ordf,5b,laquo,5c,not,5d,shy,5e,reg,5f,macr,5g,deg,5h,plusmn,5i,sup2,5j,sup3,5k,acute,"+"5l,micro,5m,para,5n,middot,5o,cedil,5p,sup1,5q,ordm,5r,raquo,5s,frac14,5t,frac12,5u,frac34,"+"5v,iquest,60,Agrave,61,Aacute,62,Acirc,63,Atilde,64,Auml,65,Aring,66,AElig,67,Ccedil,"+"68,Egrave,69,Eacute,6a,Ecirc,6b,Euml,6c,Igrave,6d,Iacute,6e,Icirc,6f,Iuml,6g,ETH,6h,Ntilde,"+"6i,Ograve,6j,Oacute,6k,Ocirc,6l,Otilde,6m,Ouml,6n,times,6o,Oslash,6p,Ugrave,6q,Uacute,"+"6r,Ucirc,6s,Uuml,6t,Yacute,6u,THORN,6v,szlig,70,agrave,71,aacute,72,acirc,73,atilde,74,auml,"+"75,aring,76,aelig,77,ccedil,78,egrave,79,eacute,7a,ecirc,7b,euml,7c,igrave,7d,iacute,7e,icirc,"+"7f,iuml,7g,eth,7h,ntilde,7i,ograve,7j,oacute,7k,ocirc,7l,otilde,7m,ouml,7n,divide,7o,oslash,"+"7p,ugrave,7q,uacute,7r,ucirc,7s,uuml,7t,yacute,7u,thorn,7v,yuml,ci,fnof,sh,Alpha,si,Beta,"+"sj,Gamma,sk,Delta,sl,Epsilon,sm,Zeta,sn,Eta,so,Theta,sp,Iota,sq,Kappa,sr,Lambda,ss,Mu,"+"st,Nu,su,Xi,sv,Omicron,t0,Pi,t1,Rho,t3,Sigma,t4,Tau,t5,Upsilon,t6,Phi,t7,Chi,t8,Psi,"+"t9,Omega,th,alpha,ti,beta,tj,gamma,tk,delta,tl,epsilon,tm,zeta,tn,eta,to,theta,tp,iota,"+"tq,kappa,tr,lambda,ts,mu,tt,nu,tu,xi,tv,omicron,u0,pi,u1,rho,u2,sigmaf,u3,sigma,u4,tau,"+"u5,upsilon,u6,phi,u7,chi,u8,psi,u9,omega,uh,thetasym,ui,upsih,um,piv,812,bull,816,hellip,"+"81i,prime,81j,Prime,81u,oline,824,frasl,88o,weierp,88h,image,88s,real,892,trade,89l,alefsym,"+"8cg,larr,8ch,uarr,8ci,rarr,8cj,darr,8ck,harr,8dl,crarr,8eg,lArr,8eh,uArr,8ei,rArr,8ej,dArr,"+"8ek,hArr,8g0,forall,8g2,part,8g3,exist,8g5,empty,8g7,nabla,8g8,isin,8g9,notin,8gb,ni,8gf,prod,"+"8gh,sum,8gi,minus,8gn,lowast,8gq,radic,8gt,prop,8gu,infin,8h0,ang,8h7,and,8h8,or,8h9,cap,8ha,cup,"+"8hb,int,8hk,there4,8hs,sim,8i5,cong,8i8,asymp,8j0,ne,8j1,equiv,8j4,le,8j5,ge,8k2,sub,8k3,sup,8k4,"+"nsub,8k6,sube,8k7,supe,8kl,oplus,8kn,otimes,8l5,perp,8m5,sdot,8o8,lceil,8o9,rceil,8oa,lfloor,8ob,"+"rfloor,8p9,lang,8pa,rang,9ea,loz,9j0,spades,9j3,clubs,9j5,hearts,9j6,diams,ai,OElig,aj,oelig,b0,"+"Scaron,b1,scaron,bo,Yuml,m6,circ,ms,tilde,802,ensp,803,emsp,809,thinsp,80c,zwnj,80d,zwj,80e,lrm,"+"80f,rlm,80j,ndash,80k,mdash,80o,lsquo,80p,rsquo,80q,sbquo,80s,ldquo,80t,rdquo,80u,bdquo,810,dagger,"+"811,Dagger,81g,permil,81p,lsaquo,81q,rsaquo,85c,euro",32);a.html=a.html||{};a.html.Entities={encodeRaw:function(a,b){return a.replace(b?e:f,function(a){return c[a]||a})},encodeAllRaw:function(a){return(""+a).replace(g,function(a){return c[a]||a})},encodeNumeric:function(a,b){return a.replace(b?e:f,function(a){if(a.length>1)return"&#"+((a.charCodeAt(0)-55296)*1024+(a.charCodeAt(1)-56320)+65536)+";";return c[a]||"&#"+a.charCodeAt(0)+";"})},encodeNamed:function(a,d,g){g=g||b;return a.replace(d?e:f,function(a){return c[a]||g[a]||a})},getEncodeFunc:function(d,g){var h=a.html.Entities;g=k(g)||b;function i(a,b){return a.replace(b?e:f,function(a){return c[a]||g[a]||"&#"+a.charCodeAt(0)+";"||a})}function j(a,b){return h.encodeNamed(a,b,g)}d=a.makeMap(d.replace(/\+/g,","));if(d.named&&d.numeric)return i;if(d.named){if(g)return j;return h.encodeNamed}if(d.numeric)return h.encodeNumeric;return h.encodeRaw},decode:function(a){return a.replace(h,function(a,c,e){if(c){e=parseInt(e,c.length===2?16:10);if(e>65535){e-=65536;return String.fromCharCode(55296+(e>>10),56320+(e&1023))}else return i[e]||String.fromCharCode(e)}return d[a]||b[a]||j(a)})}}})(tinymce);tinymce.html.Styles=function(a,b){var c=/rgb\s*\(\s*([0-9]+)\s*,\s*([0-9]+)\s*,\s*([0-9]+)\s*\)/gi,d=/(?:url(?:(?:\(\s*\"([^\"]+)\"\s*\))|(?:\(\s*\'([^\']+)\'\s*\))|(?:\(\s*([^)\s]+)\s*\))))|(?:\'([^\']+)\')|(?:\"([^\"]+)\")/gi,e=/\s*([^:]+):\s*([^;]+);?/g,f=/\s+$/,g=/rgb/,h,i,j={},k;a=a||{};k="\\\" \\' \\; \\: ; : \ufeff".split(" ");for(i=0;i<k.length;i++){j[k[i]]="\ufeff"+i;j["\ufeff"+i]=k[i]}function l(a,b,c,d){function e(a){a=parseInt(a).toString(16);return a.length>1?a:"0"+a}return"#"+e(b)+e(c)+e(d)}return{toHex:function(a){return a.replace(c,l)},parse:function(b){var g={},h,i,k,m,n=a.url_converter,o=a.url_converter_scope||this;function p(a,b){var c,d,e,f;if(g["border-image"]==="none"){delete g["border-image"]}c=g[a+"-top"+b];if(!c)return;d=g[a+"-right"+b];if(c!=d)return;e=g[a+"-bottom"+b];if(d!=e)return;f=g[a+"-left"+b];if(e!=f)return;g[a+b]=f;delete g[a+"-top"+b];delete g[a+"-right"+b];delete g[a+"-bottom"+b];delete g[a+"-left"+b]}function q(a){var b=g[a],c;if(!b||b.indexOf(" ")<0)return;b=b.split(" ");c=b.length;while(c--){if(b[c]!==b[0])return false}g[a]=b[0];return true}function r(a,b,c,d){if(!q(b))return;if(!q(c))return;if(!q(d))return;g[a]=g[b]+" "+g[c]+" "+g[d];delete g[b];delete g[c];delete g[d]}function s(a){m=true;return j[a]}function t(a,b){if(m){a=a.replace(/\uFEFF[0-9]/g,function(a){return j[a]})}if(!b)a=a.replace(/\\([\'\";:])/g,"$1");return a}function u(a,b,c,d,e,f){e=e||f;if(e){e=t(e);return"'"+e.replace(/\'/g,"\\'")+"'"}b=t(b||c||d);if(n)b=n.call(o,b,"style");return"url('"+b.replace(/\'/g,"\\'")+"')"}if(b){b=b.replace(/\\[\"\';:\uFEFF]/g,s).replace(/\"[^\"]+\"|\'[^\']+\'/g,function(a){return a.replace(/[;:]/g,s)});while(h=e.exec(b)){i=h[1].replace(f,"").toLowerCase();k=h[2].replace(f,"");if(i&&k.length>0){if(i==="font-weight"&&k==="700")k="bold";else if(i==="color"||i==="background-color")k=k.toLowerCase();k=k.replace(c,l);k=k.replace(d,u);g[i]=m?t(k,true):k}e.lastIndex=h.index+h[0].length}p("border","");p("border","-width");p("border","-color");p("border","-style");p("padding","");p("margin","");r("border","border-width","border-style","border-color");if(g.border==="medium none")delete g.border}return g},serialize:function(a,c){var d="",e,f;function g(c){var e,f,g,i;e=b.styles[c];if(e){for(f=0,g=e.length;f<g;f++){c=e[f];i=a[c];if(i!==h&&i.length>0)d+=(d.length>0?" ":"")+c+": "+i+";"}}}if(c&&b&&b.styles){g("*");g(c)}else{for(e in a){f=a[e];if(f!==h&&f.length>0)d+=(d.length>0?" ":"")+e+": "+f+";"}}return d}}};(function(a){var b={},c=a.makeMap,d=a.each;function e(a,b){return a.split(b||",")}function f(a,b){var d,f={};function g(b){return b.replace(/[A-Z]+/g,function(b){return g(a[b])})}for(d in a){if(a.hasOwnProperty(d))a[d]=g(a[d])}g(b).replace(/#/g,"#text").replace(/(\w+)\[([^\]]+)\]\[([^\]]*)\]/g,function(a,b,d,g){d=e(d,"|");f[b]={attributes:c(d),attributesOrder:d,children:c(g,"|",{"#comment":{}})}});return f}function g(){var a=b.html5;if(!a){a=b.html5=f({A:"id|accesskey|class|dir|draggable|item|hidden|itemprop|role|spellcheck|style|subject|title|onclick|ondblclick|onmousedown|onmouseup|onmouseover|onmousemove|onmouseout|onkeypress|onkeydown|onkeyup",B:"#|a|abbr|area|audio|b|bdo|br|button|canvas|cite|code|command|datalist|del|dfn|em|embed|i|iframe|img|input|ins|kbd|keygen|label|link|map|mark|meta|"+"meter|noscript|object|output|progress|q|ruby|samp|script|select|small|span|strong|sub|sup|svg|textarea|time|var|video|wbr",C:"#|a|abbr|area|address|article|aside|audio|b|bdo|blockquote|br|button|canvas|cite|code|command|datalist|del|details|dfn|dialog|div|dl|em|embed|fieldset|"+"figure|footer|form|h1|h2|h3|h4|h5|h6|header|hgroup|hr|i|iframe|img|input|ins|kbd|keygen|label|link|map|mark|menu|meta|meter|nav|noscript|ol|object|output|"+"p|pre|progress|q|ruby|samp|script|section|select|small|span|strong|style|sub|sup|svg|table|textarea|time|ul|var|video"},"html[A|manifest][body|head]"+"head[A][base|command|link|meta|noscript|script|style|title]"+"title[A][#]"+"base[A|href|target][]"+"link[A|href|rel|media|type|sizes][]"+"meta[A|http-equiv|name|content|charset][]"+"style[A|type|media|scoped][#]"+"script[A|charset|type|src|defer|async][#]"+"noscript[A][C]"+"body[A][C]"+"section[A][C]"+"nav[A][C]"+"article[A][C]"+"aside[A][C]"+"h1[A][B]"+"h2[A][B]"+"h3[A][B]"+"h4[A][B]"+"h5[A][B]"+"h6[A][B]"+"hgroup[A][h1|h2|h3|h4|h5|h6]"+"header[A][C]"+"footer[A][C]"+"address[A][C]"+"p[A][B]"+"br[A][]"+"pre[A][B]"+"dialog[A][dd|dt]"+"blockquote[A|cite][C]"+"ol[A|start|reversed][li]"+"ul[A][li]"+"li[A|value][C]"+"dl[A][dd|dt]"+"dt[A][B]"+"dd[A][C]"+"a[A|href|target|ping|rel|media|type][B]"+"em[A][B]"+"strong[A][B]"+"small[A][B]"+"cite[A][B]"+"q[A|cite][B]"+"dfn[A][B]"+"abbr[A][B]"+"code[A][B]"+"var[A][B]"+"samp[A][B]"+"kbd[A][B]"+"sub[A][B]"+"sup[A][B]"+"i[A][B]"+"b[A][B]"+"mark[A][B]"+"progress[A|value|max][B]"+"meter[A|value|min|max|low|high|optimum][B]"+"time[A|datetime][B]"+"ruby[A][B|rt|rp]"+"rt[A][B]"+"rp[A][B]"+"bdo[A][B]"+"span[A][B]"+"ins[A|cite|datetime][B]"+"del[A|cite|datetime][B]"+"figure[A][C|legend|figcaption]"+"figcaption[A][C]"+"img[A|alt|src|height|width|usemap|ismap][]"+"iframe[A|name|src|height|width|sandbox|seamless][]"+"embed[A|src|height|width|type][]"+"object[A|data|type|height|width|usemap|name|form|classid][param]"+"param[A|name|value][]"+"details[A|open][C|legend]"+"command[A|type|label|icon|disabled|checked|radiogroup][]"+"menu[A|type|label][C|li]"+"legend[A][C|B]"+"div[A][C]"+"source[A|src|type|media][]"+"audio[A|src|autobuffer|autoplay|loop|controls][source]"+"video[A|src|autobuffer|autoplay|loop|controls|width|height|poster][source]"+"hr[A][]"+"form[A|accept-charset|action|autocomplete|enctype|method|name|novalidate|target][C]"+"fieldset[A|disabled|form|name][C|legend]"+"label[A|form|for][B]"+"input[A|type|accept|alt|autocomplete|autofocus|checked|disabled|form|formaction|formenctype|formmethod|formnovalidate|formtarget|height|list|max|maxlength|min|"+"multiple|pattern|placeholder|readonly|required|size|src|step|width|files|value|name][]"+"button[A|autofocus|disabled|form|formaction|formenctype|formmethod|formnovalidate|formtarget|name|value|type][B]"+"select[A|autofocus|disabled|form|multiple|name|size][option|optgroup]"+"datalist[A][B|option]"+"optgroup[A|disabled|label][option]"+"option[A|disabled|selected|label|value][]"+"textarea[A|autofocus|disabled|form|maxlength|name|placeholder|readonly|required|rows|cols|wrap][]"+"keygen[A|autofocus|challenge|disabled|form|keytype|name][]"+"output[A|for|form|name][B]"+"canvas[A|width|height][]"+"map[A|name][B|C]"+"area[A|shape|coords|href|alt|target|media|rel|ping|type][]"+"mathml[A][]"+"svg[A][]"+"table[A|border][caption|colgroup|thead|tfoot|tbody|tr]"+"caption[A][C]"+"colgroup[A|span][col]"+"col[A|span][]"+"thead[A][tr]"+"tfoot[A][tr]"+"tbody[A][tr]"+"tr[A][th|td]"+"th[A|headers|rowspan|colspan|scope][B]"+"td[A|headers|rowspan|colspan][C]"+"wbr[A][]")}return a}function h(){var a=b.html4;if(!a){a=b.html4=f({Z:"H|K|N|O|P",Y:"X|form|R|Q",ZG:"E|span|width|align|char|charoff|valign",X:"p|T|div|U|W|isindex|fieldset|table",ZF:"E|align|char|charoff|valign",W:"pre|hr|blockquote|address|center|noframes",ZE:"abbr|axis|headers|scope|rowspan|colspan|align|char|charoff|valign|nowrap|bgcolor|width|height",ZD:"[E][S]",U:"ul|ol|dl|menu|dir",ZC:"p|Y|div|U|W|table|br|span|bdo|object|applet|img|map|K|N|Q",T:"h1|h2|h3|h4|h5|h6",ZB:"X|S|Q",S:"R|P",ZA:"a|G|J|M|O|P",R:"a|H|K|N|O",Q:"noscript|P",P:"ins|del|script",O:"input|select|textarea|label|button",N:"M|L",M:"em|strong|dfn|code|q|samp|kbd|var|cite|abbr|acronym",L:"sub|sup",K:"J|I",J:"tt|i|b|u|s|strike",I:"big|small|font|basefont",H:"G|F",G:"br|span|bdo",F:"object|applet|img|map|iframe",E:"A|B|C",D:"accesskey|tabindex|onfocus|onblur",C:"onclick|ondblclick|onmousedown|onmouseup|onmouseover|onmousemove|onmouseout|onkeypress|onkeydown|onkeyup",B:"lang|xml:lang|dir",A:"id|class|style|title"},"script[id|charset|type|language|src|defer|xml:space][]"+"style[B|id|type|media|title|xml:space][]"+"object[E|declare|classid|codebase|data|type|codetype|archive|standby|width|height|usemap|name|tabindex|align|border|hspace|vspace][#|param|Y]"+"param[id|name|value|valuetype|type][]"+"p[E|align][#|S]"+"a[E|D|charset|type|name|href|hreflang|rel|rev|shape|coords|target][#|Z]"+"br[A|clear][]"+"span[E][#|S]"+"bdo[A|C|B][#|S]"+"applet[A|codebase|archive|code|object|alt|name|width|height|align|hspace|vspace][#|param|Y]"+"h1[E|align][#|S]"+"img[E|src|alt|name|longdesc|width|height|usemap|ismap|align|border|hspace|vspace][]"+"map[B|C|A|name][X|form|Q|area]"+"h2[E|align][#|S]"+"iframe[A|longdesc|name|src|frameborder|marginwidth|marginheight|scrolling|align|width|height][#|Y]"+"h3[E|align][#|S]"+"tt[E][#|S]"+"i[E][#|S]"+"b[E][#|S]"+"u[E][#|S]"+"s[E][#|S]"+"strike[E][#|S]"+"big[E][#|S]"+"small[E][#|S]"+"font[A|B|size|color|face][#|S]"+"basefont[id|size|color|face][]"+"em[E][#|S]"+"strong[E][#|S]"+"dfn[E][#|S]"+"code[E][#|S]"+"q[E|cite][#|S]"+"samp[E][#|S]"+"kbd[E][#|S]"+"var[E][#|S]"+"cite[E][#|S]"+"abbr[E][#|S]"+"acronym[E][#|S]"+"sub[E][#|S]"+"sup[E][#|S]"+"input[E|D|type|name|value|checked|disabled|readonly|size|maxlength|src|alt|usemap|onselect|onchange|accept|align][]"+"select[E|name|size|multiple|disabled|tabindex|onfocus|onblur|onchange][optgroup|option]"+"optgroup[E|disabled|label][option]"+"option[E|selected|disabled|label|value][]"+"textarea[E|D|name|rows|cols|disabled|readonly|onselect|onchange][]"+"label[E|for|accesskey|onfocus|onblur][#|S]"+"button[E|D|name|value|type|disabled][#|p|T|div|U|W|table|G|object|applet|img|map|K|N|Q]"+"h4[E|align][#|S]"+"ins[E|cite|datetime][#|Y]"+"h5[E|align][#|S]"+"del[E|cite|datetime][#|Y]"+"h6[E|align][#|S]"+"div[E|align][#|Y]"+"ul[E|type|compact][li]"+"li[E|type|value][#|Y]"+"ol[E|type|compact|start][li]"+"dl[E|compact][dt|dd]"+"dt[E][#|S]"+"dd[E][#|Y]"+"menu[E|compact][li]"+"dir[E|compact][li]"+"pre[E|width|xml:space][#|ZA]"+"hr[E|align|noshade|size|width][]"+"blockquote[E|cite][#|Y]"+"address[E][#|S|p]"+"center[E][#|Y]"+"noframes[E][#|Y]"+"isindex[A|B|prompt][]"+"fieldset[E][#|legend|Y]"+"legend[E|accesskey|align][#|S]"+"table[E|summary|width|border|frame|rules|cellspacing|cellpadding|align|bgcolor][caption|col|colgroup|thead|tfoot|tbody|tr]"+"caption[E|align][#|S]"+"col[ZG][]"+"colgroup[ZG][col]"+"thead[ZF][tr]"+"tr[ZF|bgcolor][th|td]"+"th[E|ZE][#|Y]"+"form[E|action|method|name|enctype|onsubmit|onreset|accept|accept-charset|target][#|X|R|Q]"+"noscript[E][#|Y]"+"td[E|ZE][#|Y]"+"tfoot[ZF][tr]"+"tbody[ZF][tr]"+"area[E|D|shape|coords|href|nohref|alt|target][]"+"base[id|href|target][]"+"body[E|onload|onunload|background|bgcolor|text|link|vlink|alink][#|Y]")}return a}a.html.Schema=function(f){var i=this,j={},k={},l=[],m,n;var o,p,q,r,s,t,u={};function v(d,e,g){var h=f[d];if(!h){h=b[d];if(!h){h=c(e," ",c(e.toUpperCase()," "));h=a.extend(h,g);b[d]=h}}else{h=c(h,",",c(h.toUpperCase()," "))}return h}f=f||{};n=f.schema=="html5"?g():h();if(f.verify_html===false)f.valid_elements="*[*]";if(f.valid_styles){m={};d(f.valid_styles,function(b,c){m[c]=a.explode(b)})}o=v("whitespace_elements","pre script noscript style textarea");p=v("self_closing_elements","colgroup dd dt li option p td tfoot th thead tr");q=v("short_ended_elements","area base basefont br col frame hr img input isindex link meta param embed source wbr");r=v("boolean_attributes","checked compact declare defer disabled ismap multiple nohref noresize noshade nowrap readonly selected autoplay loop controls");t=v("non_empty_elements","td th iframe video audio object",q);textBlockElementsMap=v("text_block_elements","h1 h2 h3 h4 h5 h6 p div address pre form "+"blockquote center dir fieldset header footer article section hgroup aside nav figure");s=v("block_elements","hr table tbody thead tfoot "+"th tr td li ol ul caption dl dt dd noscript menu isindex samp option datalist select optgroup",textBlockElementsMap);function w(a){return new RegExp("^"+a.replace(/([?+*])/g,".$1")+"$")}function x(b){var d,f,g,h,i,k,m,n,o,p,q,r,s,t,u,v,x,y,z,A,B,C,D=/^([#+\-])?([^\[\/]+)(?:\/([^\[]+))?(?:\[([^\]]+)\])?$/,E=/^([!\-])?(\w+::\w+|[^=:<]+)?(?:([=:<])(.*))?$/,F=/[*?+]/;if(b){b=e(b);if(j["@"]){x=j["@"].attributes;y=j["@"].attributesOrder}for(d=0,f=b.length;d<f;d++){k=D.exec(b[d]);if(k){u=k[1];p=k[2];v=k[3];o=k[4];s={};t=[];m={attributes:s,attributesOrder:t};if(u==="#")m.paddEmpty=true;if(u==="-")m.removeEmpty=true;if(x){for(A in x)s[A]=x[A];t.push.apply(t,y)}if(o){o=e(o,"|");for(g=0,h=o.length;g<h;g++){k=E.exec(o[g]);if(k){n={};r=k[1];q=k[2].replace(/::/g,":");u=k[3];C=k[4];if(r==="!"){m.attributesRequired=m.attributesRequired||[];m.attributesRequired.push(q);n.required=true}if(r==="-"){delete s[q];t.splice(a.inArray(t,q),1);continue}if(u){if(u==="="){m.attributesDefault=m.attributesDefault||[];m.attributesDefault.push({name:q,value:C});n.defaultValue=C}if(u===":"){m.attributesForced=m.attributesForced||[];m.attributesForced.push({name:q,value:C});n.forcedValue=C}if(u==="<")n.validValues=c(C,"?")}if(F.test(q)){m.attributePatterns=m.attributePatterns||[];n.pattern=w(q);m.attributePatterns.push(n)}else{if(!s[q])t.push(q);s[q]=n}}}}if(!x&&p=="@"){x=s;y=t}if(v){m.outputName=p;j[v]=m}if(F.test(p)){m.pattern=w(p);l.push(m)}else j[p]=m}}}}function y(a){j={};l=[];x(a);d(n,function(a,b){k[b]=a.children})}function z(a){var b=/^(~)?(.+)$/;if(a){d(e(a),function(a){var c=b.exec(a),e=c[1]==="~",f=e?"span":"div",g=c[2];k[g]=k[f];u[g]=f;if(!e){s[g.toUpperCase()]={};s[g]={}}if(!j[g]){j[g]=j[f]}d(k,function(a,b){if(a[f])a[g]=a[f]})})}}function A(a){var b=/^([+\-]?)(\w+)\[([^\]]+)\]$/;if(a){d(e(a),function(a){var c=b.exec(a),f,g;if(c){g=c[1];if(g)f=k[c[2]];else f=k[c[2]]={"#comment":{}};f=k[c[2]];d(e(c[3],"|"),function(a){if(g==="-")delete f[a];else f[a]={}})}})}}function B(a){var b=j[a],c;if(b)return b;c=l.length;while(c--){b=l[c];if(b.pattern.test(a))return b}}if(!f.valid_elements){d(n,function(a,b){j[b]={attributes:a.attributes,attributesOrder:a.attributesOrder};k[b]=a.children});if(f.schema!="html5"){d(e("strong/b,em/i"),function(a){a=e(a,"/");j[a[1]].outputName=a[0]})}j.img.attributesDefault=[{name:"alt",value:""}];d(e("ol,ul,sub,sup,blockquote,span,font,a,table,tbody,tr,strong,em,b,i"),function(a){if(j[a]){j[a].removeEmpty=true}});d(e("p,h1,h2,h3,h4,h5,h6,th,td,pre,div,address,caption"),function(a){j[a].paddEmpty=true})}else y(f.valid_elements);z(f.custom_elements);A(f.valid_children);x(f.extended_valid_elements);A("+ol[ul|ol],+ul[ul|ol]");if(f.invalid_elements){a.each(a.explode(f.invalid_elements),function(a){if(j[a])delete j[a]})}if(!B("span"))x("span[!data-mce-type|*]");i.children=k;i.styles=m;i.getBoolAttrs=function(){return r};i.getBlockElements=function(){return s};i.getTextBlockElements=function(){return textBlockElementsMap};i.getShortEndedElements=function(){return q};i.getSelfClosingElements=function(){return p};i.getNonEmptyElements=function(){return t};i.getWhiteSpaceElements=function(){return o};i.isValidChild=function(a,b){var c=k[a];return!!(c&&c[b])};i.isValid=function(a,b){var c,d,e=B(a);if(e){if(b){if(e.attributes[b]){return true}c=e.attributePatterns;if(c){d=c.length;while(d--){if(c[d].pattern.test(a)){return true}}}}else{return true}}return false};i.getElementRule=B;i.getCustomElements=function(){return u};i.addValidElements=x;i.setValidElements=y;i.addCustomElements=z;i.addValidChildren=A;i.elements=j}})(tinymce);(function(a){a.html.SaxParser=function(b,c){var d=this,e=function(){};b=b||{};d.schema=c=c||new a.html.Schema;if(b.fix_self_closing!==false)b.fix_self_closing=true;a.each("comment cdata text start end pi doctype".split(" "),function(a){if(a)d[a]=b[a]||e});d.parse=function(d){var e=this,f,g=0,h,i,j=[],k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J=0,K=a.html.Entities.decode,L,M;function N(a){var b,c;b=j.length;while(b--){if(j[b].name===a)break}if(b>=0){for(c=j.length-1;c>=b;c--){a=j[c];if(a.valid)e.end(a.name)}j.length=b}}function O(a,b,c,d,e){var f,g;b=b.toLowerCase();c=b in r?b:K(c||d||e||"");if(t&&!o&&b.indexOf("data-")!==0){f=z[b];if(!f&&A){g=A.length;while(g--){f=A[g];if(f.pattern.test(b))break}if(g===-1)f=null}if(!f)return;if(f.validValues&&!(c in f.validValues))return}k.map[b]=c;k.push({name:b,value:c})}F=new RegExp("<(?:"+"(?:!--([\\w\\W]*?)--\x3e)|"+"(?:!\\[CDATA\\[([\\w\\W]*?)\\]\\]>)|"+"(?:!DOCTYPE([\\w\\W]*?)>)|"+"(?:\\?([^\\s\\/<>]+) ?([\\w\\W]*?)[?/]>)|"+"(?:\\/([^>]+)>)|"+"(?:([A-Za-z0-9\\-\\:\\.]+)((?:\\s+[^\"'>]+(?:(?:\"[^\"]*\")|(?:'[^']*')|[^>]*))*|\\/|\\s+)>)"+")","g");G=/([\w:\-]+)(?:\s*=\s*(?:(?:\"((?:[^\"])*)\")|(?:\'((?:[^\'])*)\')|([^>\s]+)))?/g;H={script:/<\/script[^>]*>/gi,style:/<\/style[^>]*>/gi,noscript:/<\/noscript[^>]*>/gi};q=c.getShortEndedElements();E=b.self_closing_elements||c.getSelfClosingElements();r=c.getBoolAttrs();t=b.validate;p=b.remove_internals;L=b.fix_self_closing;M=a.isIE;y=/^:/;while(f=F.exec(d)){if(g<f.index)e.text(K(d.substr(g,f.index-g)));if(h=f[6]){h=h.toLowerCase();if(M&&y.test(h))h=h.substr(1);N(h)}else if(h=f[7]){h=h.toLowerCase();if(M&&y.test(h))h=h.substr(1);s=h in q;if(L&&E[h]&&j.length>0&&j[j.length-1].name===h)N(h);if(!t||(u=c.getElementRule(h))){v=true;if(t){z=u.attributes;A=u.attributePatterns}if(x=f[8]){o=x.indexOf("data-mce-type")!==-1;if(o&&p)v=false;k=[];k.map={};x.replace(G,O)}else{k=[];k.map={}}if(t&&!o){B=u.attributesRequired;C=u.attributesDefault;D=u.attributesForced;if(D){l=D.length;while(l--){w=D[l];n=w.name;I=w.value;if(I==="{$uid}")I="mce_"+J++;k.map[n]=I;k.push({name:n,value:I})}}if(C){l=C.length;while(l--){w=C[l];n=w.name;if(!(n in k.map)){I=w.value;if(I==="{$uid}")I="mce_"+J++;k.map[n]=I;k.push({name:n,value:I})}}}if(B){l=B.length;while(l--){if(B[l]in k.map)break}if(l===-1)v=false}if(k.map["data-mce-bogus"])v=false}if(v)e.start(h,k,s)}else v=false;if(i=H[h]){i.lastIndex=g=f.index+f[0].length;if(f=i.exec(d)){if(v)m=d.substr(g,f.index-g);g=f.index+f[0].length}else{m=d.substr(g);g=d.length}if(v&&m.length>0)e.text(m,true);if(v)e.end(h);F.lastIndex=g;continue}if(!s){if(!x||x.indexOf("/")!=x.length-1)j.push({name:h,valid:v});else if(v)e.end(h)}}else if(h=f[1]){e.comment(h)}else if(h=f[2]){e.cdata(h)}else if(h=f[3]){e.doctype(h)}else if(h=f[4]){e.pi(h,f[5])}g=f.index+f[0].length}if(g<d.length)e.text(K(d.substr(g)));for(l=j.length-1;l>=0;l--){h=j[l];if(h.valid)e.end(h.name)}}}})(tinymce);(function(a){var b=/^[ \t\r\n]*$/,c={"#text":3,"#comment":8,"#cdata":4,"#pi":7,"#doctype":10,"#document-fragment":11};function d(a,b,c){var d,e,f=c?"lastChild":"firstChild",g=c?"prev":"next";if(a[f])return a[f];if(a!==b){d=a[g];if(d)return d;for(e=a.parent;e&&e!==b;e=e.parent){d=e[g];if(d)return d}}}function e(a,b){this.name=a;this.type=b;if(b===1){this.attributes=[];this.attributes.map={}}}a.extend(e.prototype,{replace:function(a){var b=this;if(a.parent)a.remove();b.insert(a,b);b.remove();return b},attr:function(a,b){var c=this,d,e,f;if(typeof a!=="string"){for(e in a)c.attr(e,a[e]);return c}if(d=c.attributes){if(b!==f){if(b===null){if(a in d.map){delete d.map[a];e=d.length;while(e--){if(d[e].name===a){d=d.splice(e,1);return c}}}return c}if(a in d.map){e=d.length;while(e--){if(d[e].name===a){d[e].value=b;break}}}else d.push({name:a,value:b});d.map[a]=b;return c}else{return d.map[a]}}},clone:function(){var a=this,b=new e(a.name,a.type),c,d,f,g,h;if(f=a.attributes){h=[];h.map={};for(c=0,d=f.length;c<d;c++){g=f[c];if(g.name!=="id"){h[h.length]={name:g.name,value:g.value};h.map[g.name]=g.value}}b.attributes=h}b.value=a.value;b.shortEnded=a.shortEnded;return b},wrap:function(a){var b=this;b.parent.insert(a,b);a.append(b);return b},unwrap:function(){var a=this,b,c;for(b=a.firstChild;b;){c=b.next;a.insert(b,a,true);b=c}a.remove()},remove:function(){var a=this,b=a.parent,c=a.next,d=a.prev;if(b){if(b.firstChild===a){b.firstChild=c;if(c)c.prev=null}else{d.next=c}if(b.lastChild===a){b.lastChild=d;if(d)d.next=null}else{c.prev=d}a.parent=a.next=a.prev=null}return a},append:function(a){var b=this,c;if(a.parent)a.remove();c=b.lastChild;if(c){c.next=a;a.prev=c;b.lastChild=a}else b.lastChild=b.firstChild=a;a.parent=b;return a},insert:function(a,b,c){var d;if(a.parent)a.remove();d=b.parent||this;if(c){if(b===d.firstChild)d.firstChild=a;else b.prev.next=a;a.prev=b.prev;a.next=b;b.prev=a}else{if(b===d.lastChild)d.lastChild=a;else b.next.prev=a;a.next=b.next;a.prev=b;b.next=a}a.parent=d;return a},getAll:function(a){var b=this,c,e=[];for(c=b.firstChild;c;c=d(c,b)){if(c.name===a)e.push(c)}return e},empty:function(){var a=this,b,c,e;if(a.firstChild){b=[];for(e=a.firstChild;e;e=d(e,a))b.push(e);c=b.length;while(c--){e=b[c];e.parent=e.firstChild=e.lastChild=e.next=e.prev=null}}a.firstChild=a.lastChild=null;return a},isEmpty:function(a){var c=this,e=c.firstChild,f,g;if(e){do{if(e.type===1){if(e.attributes.map["data-mce-bogus"])continue;if(a[e.name])return false;f=e.attributes.length;while(f--){g=e.attributes[f].name;if(g==="name"||g.indexOf("data-mce-")===0)return false}}if(e.type===8)return false;if(e.type===3&&!b.test(e.value))return false}while(e=d(e,c))}return true},walk:function(a){return d(this,null,a)}});a.extend(e,{create:function(a,b){var d,f;d=new e(a,c[a]||1);if(b){for(f in b)d.attr(f,b[f])}return d}});a.html.Node=e})(tinymce);(function(a){var b=a.html.Node;a.html.DomParser=function(c,d){var e=this,f={},g=[],h={},i={};c=c||{};c.validate="validate"in c?c.validate:true;c.root_name=c.root_name||"body";e.schema=d=d||new a.html.Schema;function j(c){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;q=a.makeMap("tr,td,th,tbody,thead,tfoot,table");p=d.getNonEmptyElements();r=d.getTextBlockElements();for(f=0;f<c.length;f++){g=c[f];if(!g.parent||g.fixed)continue;if(r[g.name]&&g.parent.name=="li"){s=g.next;while(s){if(r[s.name]){s.name="li";s.fixed=true;g.parent.insert(s,g.parent)}else{break}s=s.next}g.unwrap(g);continue}i=[g];for(h=g.parent;h&&!d.isValidChild(h.name,g.name)&&!q[h.name];h=h.parent)i.push(h);if(h&&i.length>1){i.reverse();j=k=e.filterNode(i[0].clone());for(n=0;n<i.length-1;n++){if(d.isValidChild(k.name,i[n].name)){l=e.filterNode(i[n].clone());k.append(l)}else l=k;for(m=i[n].firstChild;m&&m!=i[n+1];){t=m.next;l.append(m);m=t}k=l}if(!j.isEmpty(p)){h.insert(j,i[0],true);h.insert(g,j)}else{h.insert(g,i[0],true)}h=i[0];if(h.isEmpty(p)||h.firstChild===h.lastChild&&h.firstChild.name==="br"){h.empty().remove()}}else if(g.parent){if(g.name==="li"){s=g.prev;if(s&&(s.name==="ul"||s.name==="ul")){s.append(g);continue}s=g.next;if(s&&(s.name==="ul"||s.name==="ul")){s.insert(g,s.firstChild,true);continue}g.wrap(e.filterNode(new b("ul",1)));continue}if(d.isValidChild(g.parent.name,"div")&&d.isValidChild("div",g.name)){g.wrap(e.filterNode(new b("div",1)))}else{if(g.name==="style"||g.name==="script")g.empty().remove();else g.unwrap()}}}}e.filterNode=function(a){var b,c,d;if(c in f){d=h[c];if(d)d.push(a);else h[c]=[a]}b=g.length;while(b--){c=g[b].name;if(c in a.attributes.map){d=i[c];if(d)d.push(a);else i[c]=[a]}}return a};e.addNodeFilter=function(b,c){a.each(a.explode(b),function(a){var b=f[a];if(!b)f[a]=b=[];b.push(c)})};e.addAttributeFilter=function(b,c){a.each(a.explode(b),function(a){var b;for(b=0;b<g.length;b++){if(g[b].name===a){g[b].callbacks.push(c);return}}g.push({name:a,callbacks:[c]})})};e.parse=function(e,k){var l,m,n,o,p,q,r,s,t,u,v,w,x,y=[],z,A,B,C,D,E,F,G;k=k||{};h={};i={};w=a.extend(a.makeMap("script,style,head,html,body,title,meta,param"),d.getBlockElements());F=d.getNonEmptyElements();E=d.children;v=c.validate;G="forced_root_block"in k?k.forced_root_block:c.forced_root_block;D=d.getWhiteSpaceElements();x=/^[ \t\r\n]+/;A=/[ \t\r\n]+$/;B=/[ \t\r\n]+/g;C=/^[ \t\r\n]+$/;function H(){var a=m.firstChild,b,c;while(a){b=a.next;if(a.type==3||a.type==1&&a.name!=="p"&&!w[a.name]&&!a.attr("data-mce-type")){if(!c){c=I(G,1);m.insert(c,a);c.append(a)}else c.append(a)}else{c=null}a=b}}function I(a,c){var d=new b(a,c),e;if(a in f){e=h[a];if(e)e.push(d);else h[a]=[d]}return d}function J(a){var b,c,d;for(b=a.prev;b&&b.type===3;){c=b.value.replace(A,"");if(c.length>0){b.value=c;b=b.prev}else{d=b.prev;b.remove();b=d}}}function K(a){var b,c={};for(b in a){if(b!=="li"&&b!="p"){c[b]=a[b]}}return c}l=new a.html.SaxParser({validate:v,self_closing_elements:K(d.getSelfClosingElements()),cdata:function(a){n.append(I("#cdata",4)).value=a},text:function(a,b){var c;if(!z){a=a.replace(B," ");if(n.lastChild&&w[n.lastChild.name])a=a.replace(x,"")}if(a.length!==0){c=I("#text",3);c.raw=!!b;n.append(c).value=a}},comment:function(a){n.append(I("#comment",8)).value=a},pi:function(a,b){n.append(I(a,7)).value=b;J(n)},doctype:function(a){var b;b=n.append(I("#doctype",10));b.value=a;J(n)},start:function(a,b,c){var e,f,h,j,k,l,m,o;h=v?d.getElementRule(a):{};if(h){e=I(h.outputName||a,1);e.attributes=b;e.shortEnded=c;n.append(e);o=E[n.name];if(o&&E[e.name]&&!o[e.name])y.push(e);f=g.length;while(f--){k=g[f].name;if(k in b.map){t=i[k];if(t)t.push(e);else i[k]=[e]}}if(w[a])J(e);if(!c)n=e;if(!z&&D[a]){z=true}}},end:function(a){var c,e,f,g,h;e=v?d.getElementRule(a):{};if(e){if(w[a]){if(!z){c=n.firstChild;if(c&&c.type===3){f=c.value.replace(x,"");if(f.length>0){c.value=f;c=c.next}else{g=c.next;c.remove();c=g}while(c&&c.type===3){f=c.value;g=c.next;if(f.length===0||C.test(f)){c.remove();c=g}c=g}}c=n.lastChild;if(c&&c.type===3){f=c.value.replace(A,"");if(f.length>0){c.value=f;c=c.prev}else{g=c.prev;c.remove();c=g}while(c&&c.type===3){f=c.value;g=c.prev;if(f.length===0||C.test(f)){c.remove();c=g}c=g}}}}if(z&&D[a]){z=false}if(e.removeEmpty||e.paddEmpty){if(n.isEmpty(F)){if(e.paddEmpty)n.empty().append(new b("#text","3")).value=" ";else{if(!n.attributes.map.name&&!n.attributes.map.id){h=n.parent;n.empty().remove();n=h;return}}}}n=n.parent}}},d);m=n=new b(k.context||c.root_name,11);l.parse(e);if(v&&y.length){if(!k.context)j(y);else k.invalid=true}if(G&&m.name=="body")H();if(!k.invalid){for(u in h){t=f[u];o=h[u];r=o.length;while(r--){if(!o[r].parent)o.splice(r,1)}for(p=0,q=t.length;p<q;p++)t[p](o,u,k)}for(p=0,q=g.length;p<q;p++){t=g[p];if(t.name in i){o=i[t.name];r=o.length;while(r--){if(!o[r].parent)o.splice(r,1)}for(r=0,s=t.callbacks.length;r<s;r++)t.callbacks[r](o,t.name,k)}}}return m};if(c.remove_trailing_brs){e.addNodeFilter("br",function(b,c){var e,f=b.length,g,h=a.extend({},d.getBlockElements()),i=d.getNonEmptyElements(),j,k,l,m;h.body=1;for(e=0;e<f;e++){g=b[e];j=g.parent;if(h[g.parent.name]&&g===j.lastChild){l=g.prev;while(l){m=l.name;if(m!=="span"||l.attr("data-mce-type")!=="bookmark"){if(m!=="br")break;if(m==="br"){g=null;break}}l=l.prev}if(g){g.remove();if(j.isEmpty(i)){elementRule=d.getElementRule(j.name);if(elementRule){if(elementRule.removeEmpty)j.remove();else if(elementRule.paddEmpty)j.empty().append(new a.html.Node("#text",3)).value=" "}}}}else{k=g;while(j.firstChild===k&&j.lastChild===k){k=j;if(h[j.name]){break}j=j.parent}if(k===j){textNode=new a.html.Node("#text",3);textNode.value=" ";g.replace(textNode)}}}})}if(!c.allow_html_in_named_anchor){e.addAttributeFilter("id,name",function(a,b){var c=a.length,d,e,f,g;while(c--){g=a[c];if(g.name==="a"&&g.firstChild&&!g.attr("href")){f=g.parent;d=g.lastChild;do{e=d.prev;f.insert(d,g);d=e}while(d)}}})}}})(tinymce);(function(a){a.html.Serializer=function(b,c){var d=this,e=new a.html.Writer(b);b=b||{};b.validate="validate"in b?b.validate:true;d.schema=c=c||new a.html.Schema;d.writer=e;d.serialize=function(a,d){var f,g;g=b.validate;f={3:function(a,b){e.text(a.value,a.raw)},8:function(a){e.comment(a.value)},7:function(a){e.pi(a.name,a.value)},10:function(a){e.doctype(a.value)},4:function(a){e.cdata(a.value)},11:function(a){if(a=a.firstChild){do{h(a)}while(a=a.next)}}};e.reset();function h(a){var b=f[a.type],i,j,k,l,m,n,o,p,q;if(!b){i=a.name;j=a.shortEnded;k=a.attributes;if(g&&k&&k.length>1){n=[];n.map={};q=c.getElementRule(a.name);for(o=0,p=q.attributesOrder.length;o<p;o++){l=q.attributesOrder[o];if(l in k.map){m=k.map[l];if(d&&l==="style"){m=m.replace(/position:\s*absolute;?/g,"")}n.map[l]=m;n.push({name:l,value:m})}}for(o=0,p=k.length;o<p;o++){l=k[o].name;if(!(l in n.map)){m=k.map[l];if(d&&l==="style"){m=m.replace(/position:\s*absolute;?/g,"")}n.map[l]=m;n.push({name:l,value:m})}}k=n}e.start(a.name,k,j);if(!j){if(a=a.firstChild){do{h(a)}while(a=a.next)}e.end(i)}}else b(a)}if(a.type==1&&!b.inner)h(a);else f[11](a);return e.getContent()}}})(tinymce);tinymce.html.Writer=function(a){var b=[],c,d,e,f,g;a=a||{};c=a.indent;d=tinymce.makeMap(a.indent_before||"");e=tinymce.makeMap(a.indent_after||"");f=tinymce.html.Entities.getEncodeFunc(a.entity_encoding||"raw",a.entities);g=a.element_format=="html";return{start:function(a,h,i){var j,k,l,m;if(c&&d[a]&&b.length>0){m=b[b.length-1];if(m.length>0&&m!=="\n")b.push("\n")}b.push("<",a);if(h){for(j=0,k=h.length;j<k;j++){l=h[j];b.push(" ",l.name,'="',f(l.value,true),'"')}}if(!i||g)b[b.length]=">";else b[b.length]=" />";if(i&&c&&e[a]&&b.length>0){m=b[b.length-1];if(m.length>0&&m!=="\n")b.push("\n")}},end:function(a){var d;b.push("</",a,">");if(c&&e[a]&&b.length>0){d=b[b.length-1];if(d.length>0&&d!=="\n")b.push("\n")}},text:function(a,c){if(a.length>0)b[b.length]=c?a:f(a)},cdata:function(a){b.push("<![CDATA[",a,"]]>")},comment:function(a){b.push("\x3c!--",a,"--\x3e")},pi:function(a,d){if(d)b.push("<?",a," ",d,"?>");else b.push("<?",a,"?>");if(c)b.push("\n")},doctype:function(a){b.push("<!DOCTYPE",a,">",c?"\n":"")},reset:function(){b.length=0},getContent:function(){return b.join("").replace(/\n$/,"")}}};tinymce.dom={};(function(a,b){var c=!!document.addEventListener;function d(a,b,c,d){if(a.addEventListener){a.addEventListener(b,c,d||false)}else if(a.attachEvent){a.attachEvent("on"+b,c)}}function e(a,b,c,d){if(a.removeEventListener){a.removeEventListener(b,c,d||false)}else if(a.detachEvent){a.detachEvent("on"+b,c)}}function f(a,b){var c,d=b||{};function e(){return false}function f(){return true}for(c in a){if(c!=="layerX"&&c!=="layerY"){d[c]=a[c]}}if(!d.target){d.target=d.srcElement||document}d.preventDefault=function(){d.isDefaultPrevented=f;if(a){if(a.preventDefault){a.preventDefault()}else{a.returnValue=false}}};d.stopPropagation=function(){d.isPropagationStopped=f;if(a){if(a.stopPropagation){a.stopPropagation()}else{a.cancelBubble=true}}};d.stopImmediatePropagation=function(){d.isImmediatePropagationStopped=f;d.stopPropagation()};if(!d.isDefaultPrevented){d.isDefaultPrevented=e;d.isPropagationStopped=e;d.isImmediatePropagationStopped=e}return d}function g(a,b,f){var g=a.document,h={type:"ready"};function i(){if(!f.domLoaded){f.domLoaded=true;b(h)}}if(g.readyState=="complete"||g.readyState=="interactive"){i();return}if(c){d(a,"DOMContentLoaded",i)}else{d(g,"readystatechange",function(){if(g.readyState==="complete"){e(g,"readystatechange",arguments.callee);i()}});if(g.documentElement.doScroll&&a===a.top){(function(){try{g.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}i()})()}}d(a,"load",i)}function h(a){var h=this,i={},j,k,l,m,n;m="onmouseenter"in document.documentElement;l="onfocusin"in document.documentElement;n={mouseenter:"mouseover",mouseleave:"mouseout"};j=1;h.domLoaded=false;h.events=i;function o(a,b){var c,d,e,f;c=i[b][a.type];if(c){for(d=0,e=c.length;d<e;d++){f=c[d];if(f&&f.func.call(f.scope,a)===false){a.preventDefault()}if(a.isImmediatePropagationStopped()){return}}}}h.bind=function(e,k,p,q){var r,s,t,u,v,w,x,y=window;function z(a){o(f(a||y.event),r)}if(!e||e.nodeType===3||e.nodeType===8){return}if(!e[b]){r=j++;e[b]=r;i[r]={}}else{r=e[b];if(!i[r]){i[r]={}}}q=q||e;k=k.split(" ");t=k.length;while(t--){u=k[t];w=z;v=x=false;if(u==="DOMContentLoaded"){u="ready"}if((h.domLoaded||e.readyState=="complete")&&u==="ready"){h.domLoaded=true;p.call(q,f({type:u}));continue}if(!m){v=n[u];if(v){w=function(a){var b,c;b=a.currentTarget;c=a.relatedTarget;if(c&&b.contains){c=b.contains(c)}else{while(c&&c!==b){c=c.parentNode}}if(!c){a=f(a||y.event);a.type=a.type==="mouseout"?"mouseleave":"mouseenter";a.target=b;o(a,r)}}}}if(!l&&(u==="focusin"||u==="focusout")){x=true;v=u==="focusin"?"focus":"blur";w=function(a){a=f(a||y.event);a.type=a.type==="focus"?"focusin":"focusout";o(a,r)}}s=i[r][u];if(!s){i[r][u]=s=[{func:p,scope:q}];s.fakeName=v;s.capture=x;s.nativeHandler=w;if(!c){s.proxyHandler=a(r)}if(u==="ready"){g(e,w,h)}else{d(e,v||u,c?w:s.proxyHandler,x)}}else{s.push({func:p,scope:q})}}e=s=0;return p};h.unbind=function(a,d,f){var g,j,k,l,m,n;if(!a||a.nodeType===3||a.nodeType===8){return h}g=a[b];if(g){n=i[g];if(d){d=d.split(" ");k=d.length;while(k--){m=d[k];j=n[m];if(j){if(f){l=j.length;while(l--){if(j[l].func===f){j.splice(l,1)}}}if(!f||j.length===0){delete n[m];e(a,j.fakeName||m,c?j.nativeHandler:j.proxyHandler,j.capture)}}}}else{for(m in n){j=n[m];e(a,j.fakeName||m,c?j.nativeHandler:j.proxyHandler,j.capture)}n={}}for(m in n){return h}delete i[g];try{delete a[b]}catch(c){a[b]=null}}return h};h.fire=function(a,c,d){var e,g;if(!a||a.nodeType===3||a.nodeType===8){return h}g=f(null,d);g.type=c;do{e=a[b];if(e){o(g,e)}a=a.parentNode||a.ownerDocument||a.defaultView||a.parentWindow}while(a&&!g.isPropagationStopped());return h};h.clean=function(a){var c,d,e=h.unbind;if(!a||a.nodeType===3||a.nodeType===8){return h}if(a[b]){e(a)}if(!a.getElementsByTagName){a=a.document}if(a&&a.getElementsByTagName){e(a);d=a.getElementsByTagName("*");c=d.length;while(c--){a=d[c];if(a[b]){e(a)}}}return h};h.callNativeHandler=function(a,b){if(i){i[a][b.type].nativeHandler(b)}};h.destory=function(){i={}};h.add=function(a,b,c,d){if(typeof a==="string"){a=document.getElementById(a)}if(a&&a instanceof Array){var e=a.length;while(e--){h.add(a[e],b,c,d)}return}if(b==="init"){b="ready"}return h.bind(a,b instanceof Array?b.join(" "):b,c,d)};h.remove=function(a,b,c,d){if(!a){return h}if(typeof a==="string"){a=document.getElementById(a)}if(a&&a instanceof Array){var e=a.length;while(e--){h.remove(a[e],b,c,d)}return h}return h.unbind(a,b instanceof Array?b.join(" "):b,c)};h.clear=function(a){if(typeof a==="string"){a=document.getElementById(a)}return h.clean(a)};h.cancel=function(a){if(a){h.prevent(a);h.stop(a)}return false};h.prevent=function(a){if(!a.preventDefault){a=f(a)}a.preventDefault();return false};h.stop=function(a){if(!a.stopPropagation){a=f(a)}a.stopPropagation();return false}}a.EventUtils=h;a.Event=new h(function(a){return function(b){tinymce.dom.Event.callNativeHandler(a,b)}});a.Event.bind(window,"ready",function(){});a=0})(tinymce.dom,"data-mce-expando");tinymce.dom.TreeWalker=function(a,b){var c=a;function d(a,c,d,e){var f,g;if(a){if(!e&&a[c])return a[c];if(a!=b){f=a[d];if(f)return f;for(g=a.parentNode;g&&g!=b;g=g.parentNode){f=g[d];if(f)return f}}}}this.current=function(){return c};this.next=function(a){return c=d(c,"firstChild","nextSibling",a)};this.prev=function(a){return c=d(c,"lastChild","previousSibling",a)}};(function(a){var b=a.each,c=a.is,d=a.isWebKit,e=a.isIE,f=a.html.Entities,g=/^([a-z0-9],?)+$/i,h=/^[ \t\r\n]*$/;a.create("tinymce.dom.DOMUtils",{doc:null,root:null,files:null,pixelStyles:/^(top|left|bottom|right|width|height|borderWidth)$/,props:{for:"htmlFor",class:"className",className:"className",checked:"checked",disabled:"disabled",maxlength:"maxLength",readonly:"readOnly",selected:"selected",value:"value",id:"id",name:"name",type:"type"},DOMUtils:function(b,c){var d=this,e,f,g;d.doc=b;d.win=window;d.files={};d.cssFlicker=false;d.counter=0;d.stdMode=!a.isIE||b.documentMode>=8;d.boxModel=!a.isIE||b.compatMode=="CSS1Compat"||d.stdMode;d.hasOuterHTML="outerHTML"in b.createElement("a");d.settings=c=a.extend({keep_values:false,hex_colors:1},c);d.schema=c.schema;d.styles=new a.html.Styles({url_converter:c.url_converter,url_converter_scope:c.url_converter_scope},c.schema);if(a.isIE6){try{b.execCommand("BackgroundImageCache",false,true)}catch(a){d.cssFlicker=true}}d.fixDoc(b);d.events=c.ownEvents?new a.dom.EventUtils(c.proxy):a.dom.Event;a.addUnload(d.destroy,d);g=c.schema?c.schema.getBlockElements():{};d.isBlock=function(a){if(!a){return false}var b=a.nodeType;if(b)return!!(b===1&&g[a.nodeName]);return!!g[a]}},fixDoc:function(b){var c=this.settings,d;if(e&&!a.isIE11&&c.schema){("abbr article aside audio canvas "+"details figcaption figure footer "+"header hgroup mark menu meter nav "+"output progress section summary "+"time video").replace(/\w+/g,function(a){b.createElement(a)});for(d in c.schema.getCustomElements()){b.createElement(d)}}},clone:function(c,d){var f=this,g,h;if(!e||a.isIE11||c.nodeType!==1||d){return c.cloneNode(d)}h=f.doc;if(!d){g=h.createElement(c.nodeName);b(f.getAttribs(c),function(a){f.setAttrib(g,a.nodeName,f.getAttrib(c,a.nodeName))});return g}return g.firstChild},getRoot:function(){var a=this,b=a.settings;return b&&a.get(b.root_element)||a.doc.body},getViewPort:function(a){var b,c;a=!a?this.win:a;b=a.document;c=this.boxModel?b.documentElement:b.body;return{x:a.pageXOffset||c.scrollLeft,y:a.pageYOffset||c.scrollTop,w:a.innerWidth||c.clientWidth,h:a.innerHeight||c.clientHeight}},getRect:function(a){var b,c=this,d;a=c.get(a);b=c.getPos(a);d=c.getSize(a);return{x:b.x,y:b.y,w:d.w,h:d.h}},getSize:function(a){var b=this,c,d;a=b.get(a);c=b.getStyle(a,"width");d=b.getStyle(a,"height");if(typeof c!=="string")c="";if(typeof d!=="string")d="";if(c.indexOf("px")===-1)c=0;if(d.indexOf("px")===-1)d=0;return{w:parseInt(c,10)||a.offsetWidth||a.clientWidth,h:parseInt(d,10)||a.offsetHeight||a.clientHeight}},getParent:function(a,b,c){return this.getParents(a,b,c,false)},getParents:function(a,b,d,e){var f=this,g,h=f.settings,i=[];a=f.get(a);e=e===undefined;if(h.strict_root)d=d||f.getRoot();if(c(b,"string")){g=b;if(b==="*"){b=function(a){return a.nodeType==1}}else{b=function(a){return f.is(a,g)}}}while(a){if(a==d||!a.nodeType||a.nodeType===9)break;if(!b||b(a)){if(e)i.push(a);else return a}a=a.parentNode}return e?i:null},get:function(a){var b;if(a&&this.doc&&typeof a=="string"){b=a;a=this.doc.getElementById(a);if(a&&a.id!==b)return this.doc.getElementsByName(b)[1]}return a},getNext:function(a,b){return this._findSib(a,b,"nextSibling")},getPrev:function(a,b){return this._findSib(a,b,"previousSibling")},select:function(b,c){var d=this;return a.dom.Sizzle(b,d.get(c)||d.get(d.settings.root_element)||d.doc,[])},is:function(b,c){var d;if(b.length===undefined){if(c==="*")return b.nodeType==1;if(g.test(c)){c=c.toLowerCase().split(/,/);b=b.nodeName.toLowerCase();for(d=c.length-1;d>=0;d--){if(c[d]==b)return true}return false}}return a.dom.Sizzle.matches(c,b.nodeType?[b]:b).length>0},add:function(a,b,d,e,f){var g=this;return this.run(a,function(a){var h,i;h=c(b,"string")?g.doc.createElement(b):b;g.setAttribs(h,d);if(e){if(e.nodeType)h.appendChild(e);else g.setHTML(h,e)}return!f?a.appendChild(h):h})},create:function(a,b,c){return this.add(this.doc.createElement(a),a,b,c,1)},createHTML:function(a,b,c){var d="",e=this,f;d+="<"+a;for(f in b){if(b.hasOwnProperty(f))d+=" "+f+'="'+e.encode(b[f])+'"'}if(typeof c!="undefined")return d+">"+c+"</"+a+">";return d+" />"},remove:function(b,c){return this.run(b,function(b){var d,e=b.parentNode;if(!e)return null;if(c){while(d=b.firstChild){if(!a.isIE||d.nodeType!==3||d.nodeValue)e.insertBefore(d,b);else b.removeChild(d)}}return e.removeChild(b)})},setStyle:function(b,c,d){var f=this;return f.run(b,function(g){var h,i;h=g.style;c=c.replace(/-(\D)/g,function(a,b){return b.toUpperCase()});if(f.pixelStyles.test(c)&&(a.is(d,"number")||/^[\-0-9\.]+$/.test(d)))d+="px";switch(c){case"opacity":if(e&&!a.isIE11){h.filter=d===""?"":"alpha(opacity="+d*100+")";if(!b.currentStyle||!b.currentStyle.hasLayout)h.display="inline-block"}h[c]=h["-moz-opacity"]=h["-khtml-opacity"]=d||"";break;case"float":e&&!a.isIE11?h.styleFloat=d:h.cssFloat=d;break;default:h[c]=d||""}if(f.settings.update_styles)f.setAttrib(g,"data-mce-style")})},getStyle:function(a,b,c){a=this.get(a);if(!a)return;if(this.doc.defaultView&&c){b=b.replace(/[A-Z]/g,function(a){return"-"+a});try{return this.doc.defaultView.getComputedStyle(a,null).getPropertyValue(b)}catch(a){return null}}b=b.replace(/-(\D)/g,function(a,b){return b.toUpperCase()});if(b=="float")b=e?"styleFloat":"cssFloat";if(a.currentStyle&&c)return a.currentStyle[b];return a.style?a.style[b]:undefined},setStyles:function(a,c){var d=this,e=d.settings,f;f=e.update_styles;e.update_styles=0;b(c,function(b,c){d.setStyle(a,c,b)});e.update_styles=f;if(e.update_styles)d.setAttrib(a,e.cssText)},removeAllAttribs:function(a){return this.run(a,function(a){var b,c=a.attributes;for(b=c.length-1;b>=0;b--){a.removeAttributeNode(c.item(b))}})},setAttrib:function(a,d,e){var f=this;if(!a||!d)return;if(f.settings.strict)d=d.toLowerCase();return this.run(a,function(a){var g=f.settings;var h=a.getAttribute(d);if(e!==null){switch(d){case"style":if(!c(e,"string")){b(e,function(b,c){f.setStyle(a,c,b)});return}if(g.keep_values){if(e&&!f._isRes(e))a.setAttribute("data-mce-style",e,2);else a.removeAttribute("data-mce-style",2)}a.style.cssText=e;break;case"class":a.className=e||"";break;case"src":case"href":if(g.keep_values){if(g.url_converter)e=g.url_converter.call(g.url_converter_scope||f,e,d,a);f.setAttrib(a,"data-mce-"+d,e,2)}break;case"shape":a.setAttribute("data-mce-style",e);break}}if(c(e)&&e!==null&&e.length!==0)a.setAttribute(d,""+e,2);else a.removeAttribute(d,2);if(tinyMCE.activeEditor&&h!=e){var i=tinyMCE.activeEditor;i.onSetAttrib.dispatch(i,a,d,e)}})},setAttribs:function(a,c){var d=this;return this.run(a,function(a){b(c,function(b,c){d.setAttrib(a,c,b)})})},getAttrib:function(b,f,g){var h,i=this,j;b=i.get(b);if(!b||b.nodeType!==1)return g===j?false:g;if(!c(g))g="";if(/^(src|href|style|coords|shape)$/.test(f)){h=b.getAttribute("data-mce-"+f);if(h)return h}if(e&&i.props[f]){h=b[i.props[f]];h=h&&h.nodeValue?h.nodeValue:h}if(!h)h=b.getAttribute(f,2);if(/^(checked|compact|declare|defer|disabled|ismap|multiple|nohref|noshade|nowrap|readonly|selected)$/.test(f)){if(b[i.props[f]]===true&&h==="")return f;return h?f:""}if(b.nodeName==="FORM"&&b.getAttributeNode(f))return b.getAttributeNode(f).nodeValue;if(f==="style"){h=h||b.style.cssText;if(h){h=i.serializeStyle(i.parseStyle(h),b.nodeName);if(i.settings.keep_values&&!i._isRes(h))b.setAttribute("data-mce-style",h)}}if(d&&f==="class"&&h)h=h.replace(/(apple|webkit)\-[a-z\-]+/gi,"");if(e){switch(f){case"rowspan":case"colspan":if(h===1)h="";break;case"size":if(h==="+0"||h===20||h===0)h="";break;case"width":case"height":case"vspace":case"checked":case"disabled":case"readonly":if(h===0)h="";break;case"hspace":if(h===-1)h="";break;case"maxlength":case"tabindex":if(h===32768||h===2147483647||h==="32768")h="";break;case"multiple":case"compact":case"noshade":case"nowrap":if(h===65535)return f;return g;case"shape":h=h.toLowerCase();break;default:if(f.indexOf("on")===0&&h)h=a._replace(/^function\s+\w+\(\)\s+\{\s+(.*)\s+\}$/,"$1",""+h)}}return h!==j&&h!==null&&h!==""?""+h:g},getPos:function(a,b){var c=this,d=0,e=0,f,g=c.doc,h;a=c.get(a);b=b||g.body;if(a){if(a.getBoundingClientRect){a=a.getBoundingClientRect();f=c.boxModel?g.documentElement:g.body;d=a.left+(g.documentElement.scrollLeft||g.body.scrollLeft)-f.clientTop;e=a.top+(g.documentElement.scrollTop||g.body.scrollTop)-f.clientLeft;return{x:d,y:e}}h=a;while(h&&h!=b&&h.nodeType){d+=h.offsetLeft||0;e+=h.offsetTop||0;h=h.offsetParent}h=a.parentNode;while(h&&h!=b&&h.nodeType){d-=h.scrollLeft||0;e-=h.scrollTop||0;h=h.parentNode}}return{x:d,y:e}},parseStyle:function(a){return this.styles.parse(a)},serializeStyle:function(a,b){return this.styles.serialize(a,b)},addStyle:function(a){var b=this.doc,c;styleElm=b.getElementById("mceDefaultStyles");if(!styleElm){styleElm=b.createElement("style"),styleElm.id="mceDefaultStyles";styleElm.type="text/css";c=b.getElementsByTagName("head")[0];if(c.firstChild){c.insertBefore(styleElm,c.firstChild)}else{c.appendChild(styleElm)}}if(styleElm.styleSheet){styleElm.styleSheet.cssText+=a}else{styleElm.appendChild(b.createTextNode(a))}},loadCSS:function(c){var d=this,f=d.doc,g;if(!c)c="";g=f.getElementsByTagName("head")[0];b(c.split(","),function(b){var c;if(d.files[b])return;d.files[b]=true;c=d.create("link",{rel:"stylesheet",href:a._addVer(b)});if(e&&!a.isIE11&&f.documentMode&&f.recalc){c.onload=function(){if(f.recalc)f.recalc();c.onload=null}}g.appendChild(c)})},addClass:function(a,b){return this.run(a,function(a){var c;if(!b)return 0;if(this.hasClass(a,b))return a.className;c=this.removeClass(a,b);return a.className=(c!=""?c+" ":"")+b})},removeClass:function(b,c){var d=this,e;return d.run(b,function(b){var f;if(d.hasClass(b,c)){if(!e)e=new RegExp("(^|\\s+)"+c+"(\\s+|$)","g");f=b.className.replace(e," ");f=a.trim(f!=" "?f:"");b.className=f;if(!f){b.removeAttribute("class");b.removeAttribute("className")}return f}return b.className})},hasClass:function(a,b){a=this.get(a);if(!a||!b)return false;return(" "+a.className+" ").indexOf(" "+b+" ")!==-1},show:function(a){return this.setStyle(a,"display","block")},hide:function(a){return this.setStyle(a,"display","none")},isHidden:function(a){a=this.get(a);return!a||a.style.display=="none"||this.getStyle(a,"display")=="none"},uniqueId:function(a){return(!a?"mce_":a)+this.counter++},setHTML:function(c,d){var f=this;return f.run(c,function(c){if(e){while(c.firstChild)c.removeChild(c.firstChild);try{c.innerHTML="<br />"+d;c.removeChild(c.firstChild)}catch(e){var g=f.create("div");g.innerHTML="<br />"+d;b(a.grep(g.childNodes),function(a,b){if(b&&c.canHaveHTML)c.appendChild(a)})}}else c.innerHTML=d;return d})},getOuterHTML:function(a){var b,c=this;a=c.get(a);if(!a)return null;if(a.nodeType===1&&c.hasOuterHTML)return a.outerHTML;b=(a.ownerDocument||c.doc).createElement("body");b.appendChild(a.cloneNode(true));return b.innerHTML},setOuterHTML:function(a,b,c){var d=this;function f(a,b,c){var e,f;f=c.createElement("body");f.innerHTML=b;e=f.lastChild;while(e){d.insertAfter(e.cloneNode(true),a);e=e.previousSibling}d.remove(a)}return this.run(a,function(a){a=d.get(a);if(a.nodeType==1){c=c||a.ownerDocument||d.doc;if(e){try{if(e&&a.nodeType==1)a.outerHTML=b;else f(a,b,c)}catch(d){f(a,b,c)}}else f(a,b,c)}})},decode:f.decode,encode:f.encodeAllRaw,insertAfter:function(a,b){b=this.get(b);return this.run(a,function(a){var c,d;c=b.parentNode;d=b.nextSibling;if(d)c.insertBefore(a,d);else c.appendChild(a);return a})},replace:function(d,e,f){var g=this;if(c(e,"array"))d=d.cloneNode(true);return g.run(e,function(c){if(f){b(a.grep(c.childNodes),function(a){d.appendChild(a)})}return c.parentNode.replaceChild(d,c)})},rename:function(a,c){var d=this,e;if(a.nodeName!=c.toUpperCase()){e=d.create(c);b(d.getAttribs(a),function(b){d.setAttrib(e,b.nodeName,d.getAttrib(a,b.nodeName))});d.replace(e,a,1)}return e||a},findCommonAncestor:function(a,b){var c=a,d;while(c){d=b;while(d&&c!=d)d=d.parentNode;if(c==d)break;c=c.parentNode}if(!c&&a.ownerDocument)return a.ownerDocument.documentElement;return c},toHex:function(a){var b=/^\s*rgb\s*?\(\s*?([0-9]+)\s*?,\s*?([0-9]+)\s*?,\s*?([0-9]+)\s*?\)\s*$/i.exec(a);function c(a){a=parseInt(a,10).toString(16);return a.length>1?a:"0"+a}if(b){a="#"+c(b[1])+c(b[2])+c(b[3]);return a}return a},getClasses:function(){var c=this,d=[],e,f={},g=c.settings.class_filter,h;if(c.classes)return c.classes;function i(c){b(c.imports,function(a){i(a)});b(c.cssRules||c.rules,function(c){switch(c.type||1){case 1:if(c.selectorText){b(c.selectorText.split(","),function(b){b=b.replace(/^\s*|\s*$|^\s\./g,"");if(/\.mce/.test(b)||!/\.[\w\-]+$/.test(b))return;h=b;b=a._replace(/.*\.([a-z0-9_\-]+).*/i,"$1",b);if(g&&!(b=g(b,h)))return;if(!f[b]){d.push({class:b});f[b]=1}})}break;case 3:i(c.styleSheet);break}})}try{b(c.doc.styleSheets,i)}catch(a){}if(d.length>0)c.classes=d;return d},run:function(a,c,d){var e=this,f;if(e.doc&&typeof a==="string")a=e.get(a);if(!a)return false;d=d||this;if(!a.nodeType&&(a.length||a.length===0)){f=[];b(a,function(a,b){if(a){if(typeof a==="string"){if(e.doc){a=e.doc.getElementById(a);if(a){f.push(c.call(d,a,b))}}}else{f.push(c.call(d,a,b))}}});return f}return c.call(d,a)},getAttribs:function(a){var b;a=this.get(a);if(!a)return[];if(e){b=[];if(a.nodeName=="OBJECT")return a.attributes;if(a.nodeName==="OPTION"&&this.getAttrib(a,"selected"))b.push({specified:1,nodeName:"selected"});a.cloneNode(false).outerHTML.replace(/<\/?[\w:\-]+ ?|=[\"][^\"]+\"|=\'[^\']+\'|=[\w\-]+|>/gi,"").replace(/[\w:\-]+/gi,function(a){b.push({specified:1,nodeName:a})});return b}return a.attributes},isEmpty:function(b,c){var d=this,e,f,g,i,j,k=0;b=b.firstChild;if(b){i=new a.dom.TreeWalker(b,b.parentNode);c=c||d.schema?d.schema.getNonEmptyElements():null;do{g=b.nodeType;if(g===1){if(b.getAttribute("data-mce-bogus"))continue;j=b.nodeName.toLowerCase();if(c&&c[j]){if(j==="br"){k++;continue}return false}f=d.getAttribs(b);e=b.attributes.length;while(e--){j=b.attributes[e].nodeName;if(j==="name"||j==="data-mce-bookmark")return false}}if(g==8)return false;if(g===3&&!h.test(b.nodeValue))return false}while(b=i.next())}return k<=1},destroy:function(b){var c=this;c.win=c.doc=c.root=c.events=c.frag=null;if(!b)a.removeUnload(c.destroy)},createRng:function(){var b=this.doc;return b.createRange?b.createRange():new a.dom.Range(this)},nodeIndex:function(a,b){var c=0,d,e,f;if(a){for(d=a.nodeType,a=a.previousSibling,e=a;a;a=a.previousSibling){f=a.nodeType;if(b&&f==3){if(f==d||!a.nodeValue.length)continue}c++;d=f}}return c},split:function(b,c,d){var e=this,f=e.createRng(),g,h,i;function j(b){var c,d=b.childNodes,f=b.nodeType;function g(a){var b=a.previousSibling&&a.previousSibling.nodeName=="SPAN";var c=a.nextSibling&&a.nextSibling.nodeName=="SPAN";return b&&c}if(f==1&&b.getAttribute("data-mce-type")=="bookmark")return;for(c=d.length-1;c>=0;c--)j(d[c]);if(f!=9){if(f==3&&b.nodeValue.length>0){var h=a.trim(b.nodeValue).length;if(!e.isBlock(b.parentNode)||h>0||h===0&&g(b))return}else if(f==1){d=b.childNodes;if(d.length==1&&d[0]&&d[0].nodeType==1&&d[0].getAttribute("data-mce-type")=="bookmark")b.parentNode.insertBefore(d[0],b);if(d.length||/^(br|hr|input|img)$/i.test(b.nodeName))return}e.remove(b)}return b}if(b&&c){f.setStart(b.parentNode,e.nodeIndex(b));f.setEnd(c.parentNode,e.nodeIndex(c));g=f.extractContents();f=e.createRng();f.setStart(c.parentNode,e.nodeIndex(c)+1);f.setEnd(b.parentNode,e.nodeIndex(b)+1);h=f.extractContents();i=b.parentNode;i.insertBefore(j(g),b);if(d)i.replaceChild(d,c);else i.insertBefore(c,b);i.insertBefore(j(h),b);e.remove(b);return d||c}},bind:function(a,b,c,d){return this.events.add(a,b,c,d||this)},unbind:function(a,b,c){return this.events.remove(a,b,c)},fire:function(a,b,c){return this.events.fire(a,b,c)},getContentEditable:function(a){var b;if(a.nodeType!=1){return null}b=a.getAttribute("data-mce-contenteditable");if(b&&b!=="inherit"){return b}return a.contentEditable!=="inherit"?a.contentEditable:null},dumpRng:function(a){return"startContainer: "+a.startContainer.nodeName+", startOffset: "+a.startOffset+", endContainer: "+a.endContainer.nodeName+", endOffset: "+a.endOffset},_findSib:function(a,b,d){var e=this,f=b;if(a){if(c(f,"string")){f=function(a){return e.is(a,b)}}for(a=a[d];a;a=a[d]){if(f(a))return a}}return null},_isRes:function(a){return/^(top|left|bottom|right|width|height)/i.test(a)||/;\s*(top|left|bottom|right|width|height)/i.test(a)},escapeAndCompare:function(a){var b=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");return a===b}});a.DOM=new a.dom.DOMUtils(document,{process_html:0})})(tinymce);(function(a){function b(a){var c=this,d=a.doc,e=0,f=1,g=2,h=true,i=false,j="startOffset",k="startContainer",l="endContainer",m="endOffset",n=tinymce.extend,o=a.nodeIndex;n(c,{startContainer:d,startOffset:0,endContainer:d,endOffset:0,collapsed:h,commonAncestorContainer:d,START_TO_START:0,START_TO_END:1,END_TO_END:2,END_TO_START:3,setStart:q,setEnd:r,setStartBefore:s,setStartAfter:t,setEndBefore:u,setEndAfter:v,collapse:w,selectNode:x,selectNodeContents:y,compareBoundaryPoints:z,deleteContents:A,extractContents:B,cloneContents:C,insertNode:D,surroundContents:E,cloneRange:F,toStringIE:T});function p(){return d.createDocumentFragment()}function q(a,b){J(h,a,b)}function r(a,b){J(i,a,b)}function s(a){q(a.parentNode,o(a))}function t(a){q(a.parentNode,o(a)+1)}function u(a){r(a.parentNode,o(a))}function v(a){r(a.parentNode,o(a)+1)}function w(a){if(a){c[l]=c[k];c[m]=c[j]}else{c[k]=c[l];c[j]=c[m]}c.collapsed=h}function x(a){s(a);v(a)}function y(a){q(a,0);r(a,a.nodeType===1?a.childNodes.length:a.nodeValue.length)}function z(a,b){var d=c[k],e=c[j],f=c[l],g=c[m],h=b.startContainer,i=b.startOffset,n=b.endContainer,o=b.endOffset;if(a===0)return I(d,e,h,i);if(a===1)return I(f,g,h,i);if(a===2)return I(f,g,n,o);if(a===3)return I(d,e,n,o)}function A(){K(g)}function B(){return K(e)}function C(){return K(f)}function D(b){var c=this[k],d=this[j],e,f;if((c.nodeType===3||c.nodeType===4)&&c.nodeValue){if(!d){c.parentNode.insertBefore(b,c)}else if(d>=c.nodeValue.length){a.insertAfter(b,c)}else{e=c.splitText(d);c.parentNode.insertBefore(b,e)}}else{if(c.childNodes.length>0)f=c.childNodes[d];if(f)c.insertBefore(b,f);else c.appendChild(b)}}function E(a){var b=c.extractContents();c.insertNode(a);a.appendChild(b);c.selectNode(a)}function F(){return n(new b(a),{startContainer:c[k],startOffset:c[j],endContainer:c[l],endOffset:c[m],collapsed:c.collapsed,commonAncestorContainer:c.commonAncestorContainer})}function G(a,b){var c;if(a.nodeType==3)return a;if(b<0)return a;c=a.firstChild;while(c&&b>0){--b;c=c.nextSibling}if(c)return c;return a}function H(){return c[k]==c[l]&&c[j]==c[m]}function I(b,c,d,e){var f,g,h,i,j,k;if(b==d){if(c==e)return 0;if(c<e)return-1;return 1}f=d;while(f&&f.parentNode!=b)f=f.parentNode;if(f){g=0;h=b.firstChild;while(h!=f&&g<c){g++;h=h.nextSibling}if(c<=g)return-1;return 1}f=b;while(f&&f.parentNode!=d){f=f.parentNode}if(f){g=0;h=d.firstChild;while(h!=f&&g<e){g++;h=h.nextSibling}if(g<e)return-1;return 1}i=a.findCommonAncestor(b,d);j=b;while(j&&j.parentNode!=i)j=j.parentNode;if(!j)j=i;k=d;while(k&&k.parentNode!=i)k=k.parentNode;if(!k)k=i;if(j==k)return 0;h=i.firstChild;while(h){if(h==j)return-1;if(h==k)return 1;h=h.nextSibling}}function J(b,d,e){var f,g;if(b){c[k]=d;c[j]=e}else{c[l]=d;c[m]=e}f=c[l];while(f.parentNode)f=f.parentNode;g=c[k];while(g.parentNode)g=g.parentNode;if(g==f){if(I(c[k],c[j],c[l],c[m])>0)c.collapse(b)}else c.collapse(b);c.collapsed=H();c.commonAncestorContainer=a.findCommonAncestor(c[k],c[l])}function K(a){var b,d=0,e=0,f,g,h,i,j,m;if(c[k]==c[l])return L(a);for(b=c[l],f=b.parentNode;f;b=f,f=f.parentNode){if(f==c[k])return M(b,a);++d}for(b=c[k],f=b.parentNode;f;b=f,f=f.parentNode){if(f==c[l])return N(b,a);++e}g=e-d;h=c[k];while(g>0){h=h.parentNode;g--}i=c[l];while(g<0){i=i.parentNode;g++}for(j=h.parentNode,m=i.parentNode;j!=m;j=j.parentNode,m=m.parentNode){h=j;i=m}return O(h,i,a)}function L(a){var b,e,i,l,n,o,q,r,s;if(a!=g)b=p();if(c[j]==c[m])return b;if(c[k].nodeType==3){e=c[k].nodeValue;i=e.substring(c[j],c[m]);if(a!=f){l=c[k];r=c[j];s=c[m]-c[j];if(r===0&&s>=l.nodeValue.length-1){l.parentNode.removeChild(l)}else{l.deleteData(r,s)}c.collapse(h)}if(a==g)return;if(i.length>0){b.appendChild(d.createTextNode(i))}return b}l=G(c[k],c[j]);n=c[m]-c[j];while(l&&n>0){o=l.nextSibling;q=S(l,a);if(b)b.appendChild(q);--n;l=o}if(a!=f)c.collapse(h);return b}function M(a,b){var d,e,h,k,l,m;if(b!=g)d=p();e=P(a,b);if(d)d.appendChild(e);h=o(a);k=h-c[j];if(k<=0){if(b!=f){c.setEndBefore(a);c.collapse(i)}return d}e=a.previousSibling;while(k>0){l=e.previousSibling;m=S(e,b);if(d)d.insertBefore(m,d.firstChild);--k;e=l}if(b!=f){c.setEndBefore(a);c.collapse(i)}return d}function N(a,b){var d,e,i,j,k,l;if(b!=g)d=p();i=Q(a,b);if(d)d.appendChild(i);e=o(a);++e;j=c[m]-e;i=a.nextSibling;while(i&&j>0){k=i.nextSibling;l=S(i,b);if(d)d.appendChild(l);--j;i=k}if(b!=f){c.setStartAfter(a);c.collapse(h)}return d}function O(a,b,d){var e,i,j,k,l,m,n,q;if(d!=g)i=p();e=Q(a,d);if(i)i.appendChild(e);j=a.parentNode;k=o(a);l=o(b);++k;m=l-k;n=a.nextSibling;while(m>0){q=n.nextSibling;e=S(n,d);if(i)i.appendChild(e);n=q;--m}e=P(b,d);if(i)i.appendChild(e);if(d!=f){c.setStartAfter(a);c.collapse(h)}return i}function P(a,b){var d=G(c[l],c[m]-1),e,f,j,k,n,o=d!=c[l];if(d==a)return R(d,o,i,b);e=d.parentNode;f=R(e,i,i,b);while(e){while(d){j=d.previousSibling;k=R(d,o,i,b);if(b!=g)f.insertBefore(k,f.firstChild);o=h;d=j}if(e==a)return f;d=e.previousSibling;e=e.parentNode;n=R(e,i,i,b);if(b!=g)n.appendChild(f);f=n}}function Q(a,b){var d=G(c[k],c[j]),e=d!=c[k],f,l,m,n,o;if(d==a)return R(d,e,h,b);f=d.parentNode;l=R(f,i,h,b);while(f){while(d){m=d.nextSibling;n=R(d,e,h,b);if(b!=g)l.appendChild(n);e=h;d=m}if(f==a)return l;d=f.nextSibling;f=f.parentNode;o=R(f,i,h,b);if(b!=g)o.appendChild(l);l=o}}function R(b,d,e,h){var k,l,n,o,p;if(d)return S(b,h);if(b.nodeType==3){k=b.nodeValue;if(e){o=c[j];l=k.substring(o);n=k.substring(0,o)}else{o=c[m];l=k.substring(0,o);n=k.substring(o)}if(h!=f)b.nodeValue=n;if(h==g)return;p=a.clone(b,i);p.nodeValue=l;return p}if(h==g)return;return a.clone(b,i)}function S(b,c){if(c!=g)return c==f?a.clone(b,h):b;b.parentNode.removeChild(b)}function T(){return a.create("body",null,C()).outerText}return c}a.Range=b;b.prototype.toString=function(){return this.toStringIE()}})(tinymce.dom);(function(){function a(a){var b=this,c=a.dom,d=true,e=false;function f(b,c){var d,e=0,f,g,h,i,j,k,l=-1,m;d=b.duplicate();d.collapse(c);m=d.parentElement();if(m.ownerDocument!==a.dom.doc)return;while(m.contentEditable==="false"){m=m.parentNode}if(!m.hasChildNodes()){return{node:m,inside:1}}h=m.children;f=h.length-1;while(e<=f){k=Math.floor((e+f)/2);i=h[k];d.moveToElementText(i);l=d.compareEndPoints(c?"StartToStart":"EndToEnd",b);if(l>0){f=k-1}else if(l<0){e=k+1}else{return{node:i}}}if(l<0){if(!i){d.moveToElementText(m);d.collapse(true);i=m;g=true}else d.collapse(false);j=0;while(d.compareEndPoints(c?"StartToStart":"StartToEnd",b)!==0){if(d.move("character",1)===0||m!=d.parentElement()){break}j++}}else{d.collapse(true);j=0;while(d.compareEndPoints(c?"StartToStart":"StartToEnd",b)!==0){if(d.move("character",-1)===0||m!=d.parentElement()){break}j++}}return{node:i,position:l,offset:j,inside:g}}function g(){var d=a.getRng(),e=c.createRng(),g,h,i,j,k,l;g=d.item?d.item(0):d.parentElement();if(g.ownerDocument!=c.doc)return e;h=a.isCollapsed();if(d.item){e.setStart(g.parentNode,c.nodeIndex(g));e.setEnd(e.startContainer,e.startOffset+1);return e}function m(a){var b=f(d,a),c,g,h=0,i,j,k;c=b.node;g=b.offset;if(b.inside&&!c.hasChildNodes()){e[a?"setStart":"setEnd"](c,0);return}if(g===j){e[a?"setStartBefore":"setEndAfter"](c);return}if(b.position<0){i=b.inside?c.firstChild:c.nextSibling;if(!i){e[a?"setStartAfter":"setEndAfter"](c);return}if(!g){if(i.nodeType==3)e[a?"setStart":"setEnd"](i,0);else e[a?"setStartBefore":"setEndBefore"](i);return}while(i){k=i.nodeValue;h+=k.length;if(h>=g){c=i;h-=g;h=k.length-h;break}i=i.nextSibling}}else{i=c.previousSibling;if(!i)return e[a?"setStartBefore":"setEndBefore"](c);if(!g){if(c.nodeType==3)e[a?"setStart":"setEnd"](i,c.nodeValue.length);else e[a?"setStartAfter":"setEndAfter"](i);return}while(i){h+=i.nodeValue.length;if(h>=g){c=i;h-=g;break}i=i.previousSibling}}e[a?"setStart":"setEnd"](c,h)}try{m(true);if(!h)m()}catch(c){if(c.number==-2147024809){k=b.getBookmark(2);i=d.duplicate();i.collapse(true);g=i.parentElement();if(!h){i=d.duplicate();i.collapse(false);j=i.parentElement();j.innerHTML=j.innerHTML}g.innerHTML=g.innerHTML;b.moveToBookmark(k);d=a.getRng();m(true);if(!h)m()}else throw c}return e}this.getBookmark=function(b){var d=a.getRng(),e,g,h={};function i(a){var b,d,e,f,g=[];b=a.parentNode;d=c.getRoot().parentNode;while(b!=d&&b.nodeType!==9){e=b.children;f=e.length;while(f--){if(a===e[f]){g.push(f);break}}a=b;b=b.parentNode}return g}function j(a){var b;b=f(d,a);if(b){return{position:b.position,offset:b.offset,indexes:i(b.node),inside:b.inside}}}if(b===2){if(!d.item){h.start=j(true);if(!a.isCollapsed())h.end=j()}else h.start={ctrl:true,indexes:i(d.item(0))}}return h};this.moveToBookmark=function(a){var b,d=c.doc.body;function e(a){var b,d,e,f;b=c.getRoot();for(d=a.length-1;d>=0;d--){f=b.children;e=a[d];if(e<=f.length-1){b=f[e]}}return b}function f(c){var f=a[c?"start":"end"],g,h,i;if(f){g=f.position>0;h=d.createTextRange();h.moveToElementText(e(f.indexes));offset=f.offset;if(offset!==i){h.collapse(f.inside||g);h.moveStart("character",g?-offset:offset)}else h.collapse(c);b.setEndPoint(c?"StartToStart":"EndToStart",h);if(c)b.collapse(true)}}if(a.start){if(a.start.ctrl){b=d.createControlRange();b.addElement(e(a.start.indexes));b.select()}else{b=d.createTextRange();f(true);f();b.select()}}};this.addRange=function(b){var d,f,g,h,i,j,k,l=a.dom.doc,m=l.body,n,o;function p(a){var b,f,k,n,o;k=c.create("a");b=a?g:i;f=a?h:j;n=d.duplicate();if(b==l||b==l.documentElement){b=m;f=0}if(b.nodeType==3){b.parentNode.insertBefore(k,b);n.moveToElementText(k);n.moveStart("character",f);c.remove(k);d.setEndPoint(a?"StartToStart":"EndToEnd",n)}else{o=b.childNodes;if(o.length){if(f>=o.length){c.insertAfter(k,o[o.length-1])}else{b.insertBefore(k,o[f])}n.moveToElementText(k)}else if(b.canHaveHTML){b.innerHTML="<span>\ufeff</span>";k=b.firstChild;n.moveToElementText(k);n.collapse(e)}d.setEndPoint(a?"StartToStart":"EndToEnd",n);c.remove(k)}}g=b.startContainer;h=b.startOffset;i=b.endContainer;j=b.endOffset;d=m.createTextRange();if(g==i&&g.nodeType==1){if(h==j&&!g.hasChildNodes()){if(g.canHaveHTML){k=g.previousSibling;if(k&&!k.hasChildNodes()&&c.isBlock(k)){k.innerHTML="\ufeff"}else{k=null}g.innerHTML="<span>\ufeff</span><span>\ufeff</span>";d.moveToElementText(g.lastChild);d.select();c.doc.selection.clear();g.innerHTML="";if(k){k.innerHTML=""}return}else{h=c.nodeIndex(g);g=g.parentNode}}if(h==j-1){try{o=g.childNodes[h];f=m.createControlRange();f.addElement(o);f.select();n=a.getRng();if(n.item&&o===n.item(0)){return}}catch(a){}}}p(true);p();d.select()};this.getRangeAt=g}tinymce.dom.TridentSelection=a})();(function(){var a=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,b="sizcache",c=0,d=Object.prototype.toString,e=false,f=true,g=/\\/g,h=/\r\n/g,i=/\W/;[0,0].sort(function(){f=false;return 0});var j=function(b,c,e,f){e=e||[];c=c||document;var g=c;if(c.nodeType!==1&&c.nodeType!==9){return[]}if(!b||typeof b!=="string"){return e}var h,i,k,n,o,q,r,s,t=true,v=j.isXML(c),w=[],x=b;do{a.exec("");h=a.exec(x);if(h){x=h[3];w.push(h[1]);if(h[2]){n=h[3];break}}}while(h);if(w.length>1&&m.exec(b)){if(w.length===2&&l.relative[w[0]]){i=u(w[0]+w[1],c,f)}else{i=l.relative[w[0]]?[c]:j(w.shift(),c);while(w.length){b=w.shift();if(l.relative[b]){b+=w.shift()}i=u(b,i,f)}}}else{if(!f&&w.length>1&&c.nodeType===9&&!v&&l.match.ID.test(w[0])&&!l.match.ID.test(w[w.length-1])){o=j.find(w.shift(),c,v);c=o.expr?j.filter(o.expr,o.set)[0]:o.set[0]}if(c){o=f?{expr:w.pop(),set:p(f)}:j.find(w.pop(),w.length===1&&(w[0]==="~"||w[0]==="+")&&c.parentNode?c.parentNode:c,v);i=o.expr?j.filter(o.expr,o.set):o.set;if(w.length>0){k=p(i)}else{t=false}while(w.length){q=w.pop();r=q;if(!l.relative[q]){q=""}else{r=w.pop()}if(r==null){r=c}l.relative[q](k,r,v)}}else{k=w=[]}}if(!k){k=i}if(!k){j.error(q||b)}if(d.call(k)==="[object Array]"){if(!t){e.push.apply(e,k)}else if(c&&c.nodeType===1){for(s=0;k[s]!=null;s++){if(k[s]&&(k[s]===true||k[s].nodeType===1&&j.contains(c,k[s]))){e.push(i[s])}}}else{for(s=0;k[s]!=null;s++){if(k[s]&&k[s].nodeType===1){e.push(i[s])}}}}else{p(k,e)}if(n){j(n,g,e,f);j.uniqueSort(e)}return e};j.uniqueSort=function(a){if(q){e=f;a.sort(q);if(e){for(var b=1;b<a.length;b++){if(a[b]===a[b-1]){a.splice(b--,1)}}}}return a};j.matches=function(a,b){return j(a,null,null,b)};j.matchesSelector=function(a,b){return j(b,null,null,[a]).length>0};j.find=function(a,b,c){var d,e,f,h,i,j;if(!a){return[]}for(e=0,f=l.order.length;e<f;e++){i=l.order[e];if(h=l.leftMatch[i].exec(a)){j=h[1];h.splice(1,1);if(j.substr(j.length-1)!=="\\"){h[1]=(h[1]||"").replace(g,"");d=l.find[i](h,b,c);if(d!=null){a=a.replace(l.match[i],"");break}}}}if(!d){d=typeof b.getElementsByTagName!=="undefined"?b.getElementsByTagName("*"):[]}return{set:d,expr:a}};j.filter=function(a,b,c,d){var e,f,g,h,i,k,m,n,o,p=a,q=[],r=b,s=b&&b[0]&&j.isXML(b[0]);while(a&&b.length){for(g in l.filter){if((e=l.leftMatch[g].exec(a))!=null&&e[2]){k=l.filter[g];m=e[1];f=false;e.splice(1,1);if(m.substr(m.length-1)==="\\"){continue}if(r===q){q=[]}if(l.preFilter[g]){e=l.preFilter[g](e,r,c,q,d,s);if(!e){f=h=true}else if(e===true){continue}}if(e){for(n=0;(i=r[n])!=null;n++){if(i){h=k(i,e,n,r);o=d^h;if(c&&h!=null){if(o){f=true}else{r[n]=false}}else if(o){q.push(i);f=true}}}}if(h!==undefined){if(!c){r=q}a=a.replace(l.match[g],"");if(!f){return[]}break}}}if(a===p){if(f==null){j.error(a)}else{break}}p=a}return r};j.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)};var k=j.getText=function(a){var b,c,d=a.nodeType,e="";if(d){if(d===1||d===9||d===11){if(typeof a.textContent==="string"){return a.textContent}else if(typeof a.innerText==="string"){return a.innerText.replace(h,"")}else{for(a=a.firstChild;a;a=a.nextSibling){e+=k(a)}}}else if(d===3||d===4){return a.nodeValue}}else{for(b=0;c=a[b];b++){if(c.nodeType!==8){e+=k(c)}}}return e};var l=j.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{class:"className",for:"htmlFor"},attrHandle:{href:function(a){return a.getAttribute("href")},type:function(a){return a.getAttribute("type")}},relative:{"+":function(a,b){var c=typeof b==="string",d=c&&!i.test(b),e=c&&!d;if(d){b=b.toLowerCase()}for(var f=0,g=a.length,h;f<g;f++){if(h=a[f]){while((h=h.previousSibling)&&h.nodeType!==1){}a[f]=e||h&&h.nodeName.toLowerCase()===b?h||false:h===b}}if(e){j.filter(b,a,true)}},">":function(a,b){var c,d=typeof b==="string",e=0,f=a.length;if(d&&!i.test(b)){b=b.toLowerCase();for(;e<f;e++){c=a[e];if(c){var g=c.parentNode;a[e]=g.nodeName.toLowerCase()===b?g:false}}}else{for(;e<f;e++){c=a[e];if(c){a[e]=d?c.parentNode:c.parentNode===b}}if(d){j.filter(b,a,true)}}},"":function(a,b,d){var e,f=c++,g=t;if(typeof b==="string"&&!i.test(b)){b=b.toLowerCase();e=b;g=s}g("parentNode",b,f,a,e,d)},"~":function(a,b,d){var e,f=c++,g=t;if(typeof b==="string"&&!i.test(b)){b=b.toLowerCase();e=b;g=s}g("previousSibling",b,f,a,e,d)}},find:{ID:function(a,b,c){if(typeof b.getElementById!=="undefined"&&!c){var d=b.getElementById(a[1]);return d&&d.parentNode?[d]:[]}},NAME:function(a,b){if(typeof b.getElementsByName!=="undefined"){var c=[],d=b.getElementsByName(a[1]);for(var e=0,f=d.length;e<f;e++){if(d[e].getAttribute("name")===a[1]){c.push(d[e])}}return c.length===0?null:c}},TAG:function(a,b){if(typeof b.getElementsByTagName!=="undefined"){return b.getElementsByTagName(a[1])}}},preFilter:{CLASS:function(a,b,c,d,e,f){a=" "+a[1].replace(g,"")+" ";if(f){return a}for(var h=0,i;(i=b[h])!=null;h++){if(i){if(e^(i.className&&(" "+i.className+" ").replace(/[\t\n\r]/g," ").indexOf(a)>=0)){if(!c){d.push(i)}}else if(c){b[h]=false}}}return false},ID:function(a){return a[1].replace(g,"")},TAG:function(a,b){return a[1].replace(g,"").toLowerCase()},CHILD:function(a){if(a[1]==="nth"){if(!a[2]){j.error(a[0])}a[2]=a[2].replace(/^\+|\s*/g,"");var b=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(a[2]==="even"&&"2n"||a[2]==="odd"&&"2n+1"||!/\D/.test(a[2])&&"0n+"+a[2]||a[2]);a[2]=b[1]+(b[2]||1)-0;a[3]=b[3]-0}else if(a[2]){j.error(a[0])}a[0]=c++;return a},ATTR:function(a,b,c,d,e,f){var h=a[1]=a[1].replace(g,"");if(!f&&l.attrMap[h]){a[1]=l.attrMap[h]}a[4]=(a[4]||a[5]||"").replace(g,"");if(a[2]==="~="){a[4]=" "+a[4]+" "}return a},PSEUDO:function(b,c,d,e,f){if(b[1]==="not"){if((a.exec(b[3])||"").length>1||/^\w/.test(b[3])){b[3]=j(b[3],null,null,c)}else{var g=j.filter(b[3],c,d,true^f);if(!d){e.push.apply(e,g)}return false}}else if(l.match.POS.test(b[0])||l.match.CHILD.test(b[0])){return true}return b},POS:function(a){a.unshift(true);return a}},filters:{enabled:function(a){return a.disabled===false&&a.type!=="hidden"},disabled:function(a){return a.disabled===true},checked:function(a){return a.checked===true},selected:function(a){if(a.parentNode){a.parentNode.selectedIndex}return a.selected===true},parent:function(a){return!!a.firstChild},empty:function(a){return!a.firstChild},has:function(a,b,c){return!!j(c[3],a).length},header:function(a){return/h\d/i.test(a.nodeName)},text:function(a){var b=a.getAttribute("type"),c=a.type;return a.nodeName.toLowerCase()==="input"&&"text"===c&&(b===c||b===null)},radio:function(a){return a.nodeName.toLowerCase()==="input"&&"radio"===a.type},checkbox:function(a){return a.nodeName.toLowerCase()==="input"&&"checkbox"===a.type},file:function(a){return a.nodeName.toLowerCase()==="input"&&"file"===a.type},password:function(a){return a.nodeName.toLowerCase()==="input"&&"password"===a.type},submit:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"submit"===a.type},image:function(a){return a.nodeName.toLowerCase()==="input"&&"image"===a.type},reset:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"reset"===a.type},button:function(a){var b=a.nodeName.toLowerCase();return b==="input"&&"button"===a.type||b==="button"},input:function(a){return/input|select|textarea|button/i.test(a.nodeName)},focus:function(a){return a===a.ownerDocument.activeElement}},setFilters:{first:function(a,b){return b===0},last:function(a,b,c,d){return b===d.length-1},even:function(a,b){return b%2===0},odd:function(a,b){return b%2===1},lt:function(a,b,c){return b<c[3]-0},gt:function(a,b,c){return b>c[3]-0},nth:function(a,b,c){return c[3]-0===b},eq:function(a,b,c){return c[3]-0===b}},filter:{PSEUDO:function(a,b,c,d){var e=b[1],f=l.filters[e];if(f){return f(a,c,b,d)}else if(e==="contains"){return(a.textContent||a.innerText||k([a])||"").indexOf(b[3])>=0}else if(e==="not"){var g=b[3];for(var h=0,i=g.length;h<i;h++){if(g[h]===a){return false}}return true}else{j.error(e)}},CHILD:function(a,c){var d,e,f,g,h,i,j,k=c[1],l=a;switch(k){case"only":case"first":while(l=l.previousSibling){if(l.nodeType===1){return false}}if(k==="first"){return true}l=a;case"last":while(l=l.nextSibling){if(l.nodeType===1){return false}}return true;case"nth":d=c[2];e=c[3];if(d===1&&e===0){return true}f=c[0];g=a.parentNode;if(g&&(g[b]!==f||!a.nodeIndex)){i=0;for(l=g.firstChild;l;l=l.nextSibling){if(l.nodeType===1){l.nodeIndex=++i}}g[b]=f}j=a.nodeIndex-e;if(d===0){return j===0}else{return j%d===0&&j/d>=0}}},ID:function(a,b){return a.nodeType===1&&a.getAttribute("id")===b},TAG:function(a,b){return b==="*"&&a.nodeType===1||!!a.nodeName&&a.nodeName.toLowerCase()===b},CLASS:function(a,b){return(" "+(a.className||a.getAttribute("class"))+" ").indexOf(b)>-1},ATTR:function(a,b){var c=b[1],d=j.attr?j.attr(a,c):l.attrHandle[c]?l.attrHandle[c](a):a[c]!=null?a[c]:a.getAttribute(c),e=d+"",f=b[2],g=b[4];return d==null?f==="!=":!f&&j.attr?d!=null:f==="="?e===g:f==="*="?e.indexOf(g)>=0:f==="~="?(" "+e+" ").indexOf(g)>=0:!g?e&&d!==false:f==="!="?e!==g:f==="^="?e.indexOf(g)===0:f==="$="?e.substr(e.length-g.length)===g:f==="|="?e===g||e.substr(0,g.length+1)===g+"-":false},POS:function(a,b,c,d){var e=b[2],f=l.setFilters[e];if(f){return f(a,c,b,d)}}}};var m=l.match.POS,n=function(a,b){return"\\"+(b-0+1)};for(var o in l.match){l.match[o]=new RegExp(l.match[o].source+/(?![^\[]*\])(?![^\(]*\))/.source);l.leftMatch[o]=new RegExp(/(^(?:.|\r|\n)*?)/.source+l.match[o].source.replace(/\\(\d+)/g,n))}l.match.globalPOS=m;var p=function(a,b){a=Array.prototype.slice.call(a,0);if(b){b.push.apply(b,a);return b}return a};try{Array.prototype.slice.call(document.documentElement.childNodes,0)[0].nodeType}catch(a){p=function(a,b){var c=0,e=b||[];if(d.call(a)==="[object Array]"){Array.prototype.push.apply(e,a)}else{if(typeof a.length==="number"){for(var f=a.length;c<f;c++){e.push(a[c])}}else{for(;a[c];c++){e.push(a[c])}}}return e}}var q,r;if(document.documentElement.compareDocumentPosition){q=function(a,b){if(a===b){e=true;return 0}if(!a.compareDocumentPosition||!b.compareDocumentPosition){return a.compareDocumentPosition?-1:1}return a.compareDocumentPosition(b)&4?-1:1}}else{q=function(a,b){if(a===b){e=true;return 0}else if(a.sourceIndex&&b.sourceIndex){return a.sourceIndex-b.sourceIndex}var c,d,f=[],g=[],h=a.parentNode,i=b.parentNode,j=h;if(h===i){return r(a,b)}else if(!h){return-1}else if(!i){return 1}while(j){f.unshift(j);j=j.parentNode}j=i;while(j){g.unshift(j);j=j.parentNode}c=f.length;d=g.length;for(var k=0;k<c&&k<d;k++){if(f[k]!==g[k]){return r(f[k],g[k])}}return k===c?r(a,g[k],-1):r(f[k],b,1)};r=function(a,b,c){if(a===b){return c}var d=a.nextSibling;while(d){if(d===b){return-1}d=d.nextSibling}return 1}}(function(){var a=document.createElement("div"),b="script"+(new Date).getTime(),c=document.documentElement;a.innerHTML="<a name='"+b+"'/>";c.insertBefore(a,c.firstChild);if(document.getElementById(b)){l.find.ID=function(a,b,c){if(typeof b.getElementById!=="undefined"&&!c){var d=b.getElementById(a[1]);return d?d.id===a[1]||typeof d.getAttributeNode!=="undefined"&&d.getAttributeNode("id").nodeValue===a[1]?[d]:undefined:[]}};l.filter.ID=function(a,b){var c=typeof a.getAttributeNode!=="undefined"&&a.getAttributeNode("id");return a.nodeType===1&&c&&c.nodeValue===b}}c.removeChild(a);c=a=null})();(function(){var a=document.createElement("div");a.appendChild(document.createComment(""));if(a.getElementsByTagName("*").length>0){l.find.TAG=function(a,b){var c=b.getElementsByTagName(a[1]);if(a[1]==="*"){var d=[];for(var e=0;c[e];e++){if(c[e].nodeType===1){d.push(c[e])}}c=d}return c}}a.innerHTML="<a href='#'></a>";if(a.firstChild&&typeof a.firstChild.getAttribute!=="undefined"&&a.firstChild.getAttribute("href")!=="#"){l.attrHandle.href=function(a){return a.getAttribute("href",2)}}a=null})();if(document.querySelectorAll){(function(){var a=j,b=document.createElement("div"),c="__sizzle__";b.innerHTML="<p class='TEST'></p>";if(b.querySelectorAll&&b.querySelectorAll(".TEST").length===0){return}j=function(b,d,e,f){d=d||document;if(!f&&!j.isXML(d)){var g=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(b);if(g&&(d.nodeType===1||d.nodeType===9)){if(g[1]){return p(d.getElementsByTagName(b),e)}else if(g[2]&&l.find.CLASS&&d.getElementsByClassName){return p(d.getElementsByClassName(g[2]),e)}}if(d.nodeType===9){if(b==="body"&&d.body){return p([d.body],e)}else if(g&&g[3]){var h=d.getElementById(g[3]);if(h&&h.parentNode){if(h.id===g[3]){return p([h],e)}}else{return p([],e)}}try{return p(d.querySelectorAll(b),e)}catch(a){}}else if(d.nodeType===1&&d.nodeName.toLowerCase()!=="object"){var i=d,k=d.getAttribute("id"),m=k||c,n=d.parentNode,o=/^\s*[+~]/.test(b);if(!k){d.setAttribute("id",m)}else{m=m.replace(/'/g,"\\$&")}if(o&&n){d=d.parentNode}try{if(!o||n){return p(d.querySelectorAll("[id='"+m+"'] "+b),e)}}catch(a){}finally{if(!k){i.removeAttribute("id")}}}}return a(b,d,e,f)};for(var d in a){j[d]=a[d]}b=null})()}(function(){var a=document.documentElement,b=a.matchesSelector||a.mozMatchesSelector||a.webkitMatchesSelector||a.msMatchesSelector;if(b){var c=!b.call(document.createElement("div"),"div"),d=false;try{b.call(document.documentElement,"[test!='']:sizzle")}catch(a){d=true}j.matchesSelector=function(a,e){e=e.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!j.isXML(a)){try{if(d||!l.match.PSEUDO.test(e)&&!/!=/.test(e)){var f=b.call(a,e);if(f||!c||a.document&&a.document.nodeType!==11){return f}}}catch(a){}}return j(e,null,null,[a]).length>0}}})();(function(){var a=document.createElement("div");a.innerHTML="<div class='test e'></div><div class='test'></div>";if(!a.getElementsByClassName||a.getElementsByClassName("e").length===0){return}a.lastChild.className="e";if(a.getElementsByClassName("e").length===1){return}l.order.splice(1,0,"CLASS");l.find.CLASS=function(a,b,c){if(typeof b.getElementsByClassName!=="undefined"&&!c){return b.getElementsByClassName(a[1])}};a=null})();function s(a,c,d,e,f,g){for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j){var k=false;j=j[a];while(j){if(j[b]===d){k=e[j.sizset];break}if(j.nodeType===1&&!g){j[b]=d;j.sizset=h}if(j.nodeName.toLowerCase()===c){k=j;break}j=j[a]}e[h]=k}}}function t(a,c,d,e,f,g){for(var h=0,i=e.length;h<i;h++){var k=e[h];if(k){var l=false;k=k[a];while(k){if(k[b]===d){l=e[k.sizset];break}if(k.nodeType===1){if(!g){k[b]=d;k.sizset=h}if(typeof c!=="string"){if(k===c){l=true;break}}else if(j.filter(c,[k]).length>0){l=k;break}}k=k[a]}e[h]=l}}}if(document.documentElement.contains){j.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):true)}}else if(document.documentElement.compareDocumentPosition){j.contains=function(a,b){return!!(a.compareDocumentPosition(b)&16)}}else{j.contains=function(){return false}}j.isXML=function(a){var b=(a?a.ownerDocument||a:0).documentElement;return b?b.nodeName!=="HTML":false};var u=function(a,b,c){var d,e=[],f="",g=b.nodeType?[b]:b;while(d=l.match.PSEUDO.exec(a)){f+=d[0];a=a.replace(l.match.PSEUDO,"")}a=l.relative[a]?a+"*":a;for(var h=0,i=g.length;h<i;h++){j(a,g[h],e,c)}return j.filter(f,e)};window.tinymce.dom.Sizzle=j})();(function(a){a.dom.Element=function(b,c){var d=this,e,f;d.settings=c=c||{};d.id=b;d.dom=e=c.dom||a.DOM;if(!a.isIE)f=e.get(d.id);a.each(("getPos,getRect,getParent,add,setStyle,getStyle,setStyles,"+"setAttrib,setAttribs,getAttrib,addClass,removeClass,"+"hasClass,getOuterHTML,setOuterHTML,remove,show,hide,"+"isHidden,setHTML,get").split(/,/),function(a){d[a]=function(){var c=[b],f;for(f=0;f<arguments.length;f++)c.push(arguments[f]);c=e[a].apply(e,c);d.update(a);return c}});a.extend(d,{on:function(b,c,e){return a.dom.Event.add(d.id,b,c,e)},getXY:function(){return{x:parseInt(d.getStyle("left")),y:parseInt(d.getStyle("top"))}},getSize:function(){var a=e.get(d.id);return{w:parseInt(d.getStyle("width")||a.clientWidth),h:parseInt(d.getStyle("height")||a.clientHeight)}},moveTo:function(a,b){d.setStyles({left:a,top:b})},moveBy:function(a,b){var c=d.getXY();d.moveTo(c.x+a,c.y+b)},resizeTo:function(a,b){d.setStyles({width:a,height:b})},resizeBy:function(a,b){var c=d.getSize();d.resizeTo(c.w+a,c.h+b)},update:function(b){var f;if(a.isIE6&&c.blocker){b=b||"";if(b.indexOf("get")===0||b.indexOf("has")===0||b.indexOf("is")===0)return;if(b=="remove"){e.remove(d.blocker);return}if(!d.blocker){d.blocker=e.uniqueId();f=e.add(c.container||e.getRoot(),"iframe",{id:d.blocker,style:"position:absolute;",frameBorder:0,src:'javascript:""'});e.setStyle(f,"opacity",0)}else f=e.get(d.blocker);e.setStyles(f,{left:d.getStyle("left",1),top:d.getStyle("top",1),width:d.getStyle("width",1),height:d.getStyle("height",1),display:d.getStyle("display",1),zIndex:parseInt(d.getStyle("zIndex",1)||0)-1})}}})}})(tinymce);(function(a){function b(a){return a.replace(/[\n\r]+/g,"")}var c=a.is,d=a.isIE,e=a.each,f=a.dom.TreeWalker;a.create("tinymce.dom.Selection",{Selection:function(b,c,d,f){var g=this;g.dom=b;g.win=c;g.serializer=d;g.editor=f;e(["onBeforeSetContent","onBeforeGetContent","onSetContent","onGetContent"],function(b){g[b]=new a.util.Dispatcher(g)});if(!g.win.getSelection)g.tridentSel=new a.dom.TridentSelection(g);if(a.isIE&&!a.isIE11&&b.boxModel)this._fixIESelection();a.addUnload(g.destroy,g)},setCursorLocation:function(a,b){var c=this;var d=c.dom.createRng();d.setStart(a,b);d.setEnd(a,b);c.setRng(d);c.collapse(false)},getContent:function(a){var b=this,d=b.getRng(),e=b.dom.create("body"),f=b.getSel(),g,h,i;a=a||{};g=h="";a.get=true;a.format=a.format||"html";a.forced_root_block="";b.onBeforeGetContent.dispatch(b,a);if(a.format=="text")return b.isCollapsed()?"":d.text||(f.toString?f.toString():"");if(d.cloneContents){i=d.cloneContents();if(i)e.appendChild(i)}else if(c(d.item)||c(d.htmlText)){e.innerHTML="<br>"+(d.item?d.item(0).outerHTML:d.htmlText);e.removeChild(e.firstChild)}else e.innerHTML=d.toString();if(/^\s/.test(e.innerHTML))g=" ";if(/\s+$/.test(e.innerHTML))h=" ";a.getInner=true;a.content=b.isCollapsed()?"":g+b.serializer.serialize(e,a)+h;b.onGetContent.dispatch(b,a);return a.content},setContent:function(a,b){var c=this,d=c.getRng(),e,f=c.win.document,g,h;b=b||{format:"html"};b.set=true;a=b.content=a;if(!b.no_events)c.onBeforeSetContent.dispatch(c,b);a=b.content;if(d.insertNode){a+='<span id="__caret">_</span>';if(d.startContainer==f&&d.endContainer==f){f.body.innerHTML=a}else{d.deleteContents();if(f.body.childNodes.length===0){f.body.innerHTML=a}else{if(d.createContextualFragment){try{d.insertNode(d.createContextualFragment(a))}catch(a){}}else{g=f.createDocumentFragment();h=f.createElement("div");g.appendChild(h);h.outerHTML=a;d.insertNode(g)}}}e=c.dom.get("__caret");if(e){d=f.createRange();d.setStartBefore(e);d.setEndBefore(e);c.setRng(d)}c.dom.remove("__caret");try{c.setRng(d)}catch(a){}}else{if(d.item){f.execCommand("Delete",false,null);d=c.getRng()}if(/^\s+/.test(a)){d.pasteHTML('<span id="__mce_tmp">_</span>'+a);c.dom.remove("__mce_tmp")}else d.pasteHTML(a)}if(!b.no_events)c.onSetContent.dispatch(c,b)},getStart:function(){var a=this,b=a.getRng(),c,d,e,f;if(b.duplicate||b.item){if(b.item)return b.item(0);e=b.duplicate();e.collapse(1);c=e.parentElement();if(c.ownerDocument!==a.dom.doc){c=a.dom.getRoot()}d=f=b.parentElement();while(f=f.parentNode){if(f==c){c=d;break}}return c}else{c=b.startContainer;if(c.nodeType==1&&c.hasChildNodes())c=c.childNodes[Math.min(c.childNodes.length-1,b.startOffset)];if(c&&c.nodeType==3)return c.parentNode;return c}},getEnd:function(){var a=this,b=a.getRng(),c,d;if(b.duplicate||b.item){if(b.item)return b.item(0);b=b.duplicate();b.collapse(0);c=b.parentElement();if(c.ownerDocument!==a.dom.doc){c=a.dom.getRoot()}if(c&&c.nodeName=="BODY")return c.lastChild||c;return c}else{c=b.endContainer;d=b.endOffset;if(c.nodeType==1&&c.hasChildNodes())c=c.childNodes[d>0?d-1:d];if(c&&c.nodeType==3)return c.parentNode;return c}},getBookmark:function(a,b){var c=this,d=c.dom,f,g,h,i,j,k,l,m="\ufeff",n;function o(a,b){var c=0;e(d.select(a),function(a,d){if(a==b)c=d});return c}function p(a){function b(b){var c,d,e,f=b?"start":"end";c=a[f+"Container"];d=a[f+"Offset"];if(c.nodeType==1&&c.nodeName=="TR"){e=c.childNodes;c=e[Math.min(b?d:d-1,e.length-1)];if(c){d=b?0:c.childNodes.length;a["set"+(b?"Start":"End")](c,d)}}}b(true);b();return a}function q(){var a=c.getRng(true),e=d.getRoot(),f={};function g(a,d){var f=a[d?"startContainer":"endContainer"],g=a[d?"startOffset":"endOffset"],h=[],i,j,k=0;if(f.nodeType==3){if(b){for(i=f.previousSibling;i&&i.nodeType==3;i=i.previousSibling)g+=i.nodeValue.length}h.push(g)}else{j=f.childNodes;if(g>=j.length&&j.length){k=1;g=Math.max(0,j.length-1)}h.push(c.dom.nodeIndex(j[g],b)+k)}for(;f&&f!=e;f=f.parentNode)h.push(c.dom.nodeIndex(f,b));return h}f.start=g(a,true);if(!c.isCollapsed())f.end=g(a);return f}if(a==2){if(c.tridentSel)return c.tridentSel.getBookmark(a);return q()}if(a)return{rng:c.getRng()};f=c.getRng();h=d.uniqueId();i=tinyMCE.activeEditor.selection.isCollapsed();n="overflow:hidden;line-height:0px";if(f.duplicate||f.item){if(!f.item){g=f.duplicate();try{f.collapse();f.pasteHTML('<span data-mce-type="bookmark" id="'+h+'_start" style="'+n+'">'+m+"</span>");if(!i){g.collapse(false);f.moveToElementText(g.parentElement());if(f.compareEndPoints("StartToEnd",g)===0)g.move("character",-1);g.pasteHTML('<span data-mce-type="bookmark" id="'+h+'_end" style="'+n+'">'+m+"</span>")}}catch(a){return null}}else{k=f.item(0);j=k.nodeName;return{name:j,index:o(j,k)}}}else{k=c.getNode();j=k.nodeName;if(j=="IMG")return{name:j,index:o(j,k)};g=p(f.cloneRange());if(!i){g.collapse(false);g.insertNode(d.create("span",{"data-mce-type":"bookmark",id:h+"_end",style:n},m))}f=p(f);f.collapse(true);f.insertNode(d.create("span",{"data-mce-type":"bookmark",id:h+"_start",style:n},m))}c.moveToBookmark({id:h,keep:1});return{id:h}},moveToBookmark:function(b){var c=this,f=c.dom,g,h,i,j,k,l,m,n;function o(a){var c=b[a?"start":"end"],d,e,f,g;if(c){f=c[0];for(e=j,d=c.length-1;d>=1;d--){g=e.childNodes;if(c[d]>g.length-1)return;e=g[c[d]]}if(e.nodeType===3)f=Math.min(c[0],e.nodeValue.length);if(e.nodeType===1)f=Math.min(c[0],e.childNodes.length);if(a)i.setStart(e,f);else i.setEnd(e,f)}return true}function p(c){var d=f.get(b.id+"_"+c),g,h,i,j,o=b.keep;if(d){g=d.parentNode;if(c=="start"){if(!o){h=f.nodeIndex(d)}else{g=d.firstChild;h=1}k=l=g;m=n=h}else{if(!o){h=f.nodeIndex(d)}else{g=d.firstChild;h=1}l=g;n=h}if(!o){j=d.previousSibling;i=d.nextSibling;e(a.grep(d.childNodes),function(a){if(a.nodeType==3)a.nodeValue=a.nodeValue.replace(/\uFEFF/g,"")});while(d=f.get(b.id+"_"+c))f.remove(d,1);if(j&&i&&j.nodeType==i.nodeType&&j.nodeType==3&&!a.isOpera){h=j.nodeValue.length;j.appendData(i.nodeValue);f.remove(i);if(c=="start"){k=l=j;m=n=h}else{l=j;n=h}}}}}function q(a){if(f.isBlock(a)&&!a.innerHTML&&!d)a.innerHTML='<br data-mce-bogus="1" />';return a}if(b){if(b.start){i=f.createRng();j=f.getRoot();if(c.tridentSel)return c.tridentSel.moveToBookmark(b);if(o(true)&&o()){c.setRng(i)}}else if(b.id){p("start");p("end");if(k){i=f.createRng();i.setStart(q(k),m);i.setEnd(q(l),n);c.setRng(i)}}else if(b.name){c.select(f.select(b.name)[b.index])}else if(b.rng)c.setRng(b.rng)}},select:function(b,c){var d=this,e=d.dom,g=e.createRng(),h;function i(b,c){var d=new f(b,b);do{if(b.nodeType==3&&a.trim(b.nodeValue).length!==0){if(c)g.setStart(b,0);else g.setEnd(b,b.nodeValue.length);return}if(b.nodeName=="BR"){if(c)g.setStartBefore(b);else g.setEndBefore(b);return}}while(b=c?d.next():d.prev())}if(b){h=e.nodeIndex(b);g.setStart(b.parentNode,h);g.setEnd(b.parentNode,h+1);if(c){i(b,1);i(b)}d.setRng(g)}return b},isCollapsed:function(){var a=this,b=a.getRng(),c=a.getSel();if(!b||b.item)return false;if(b.compareEndPoints)return b.compareEndPoints("StartToEnd",b)===0;return!c||b.collapsed},collapse:function(a){var b=this,c=b.getRng(),d;if(c.item){d=c.item(0);c=b.win.document.body.createTextRange();c.moveToElementText(d)}c.collapse(!!a);b.setRng(c)},getSel:function(){var a=this,b=this.win;return b.getSelection?b.getSelection():b.document.selection},getRng:function(a){var b=this,c,e,f,g=b.win.document;if(a&&b.tridentSel){return b.tridentSel.getRangeAt(0)}try{if(c=b.getSel()){e=c.rangeCount>0?c.getRangeAt(0):c.createRange?c.createRange():g.createRange()}}catch(a){}var h;if(d&&e&&e.setStart){try{h=g.selection.createRange()}catch(a){}if(h&&h.item){f=h.item(0);e=g.createRange();e.setStartBefore(f);e.setEndAfter(f)}}if(!e){e=g.createRange?g.createRange():g.body.createTextRange()}if(e.setStart&&e.startContainer.nodeType===9&&e.collapsed){f=b.dom.getRoot();e.setStart(f,0);e.setEnd(f,0)}if(b.selectedRange&&b.explicitRange){if(e.compareBoundaryPoints(e.START_TO_START,b.selectedRange)===0&&e.compareBoundaryPoints(e.END_TO_END,b.selectedRange)===0){e=b.explicitRange}else{b.selectedRange=null;b.explicitRange=null}}return e},setRng:function(a,b){var c,d=this;if(!d.tridentSel){c=d.getSel();if(c){d.explicitRange=a;try{c.removeAllRanges()}catch(a){}try{c.addRange(a)}catch(a){}if(b===false&&c.extend){c.collapse(a.endContainer,a.endOffset);c.extend(a.startContainer,a.startOffset)}d.selectedRange=c.rangeCount>0?c.getRangeAt(0):null}}else{if(a.cloneRange){try{d.tridentSel.addRange(a);return}catch(a){}}try{a.select()}catch(a){}}},setNode:function(a){var b=this;b.setContent(b.dom.getOuterHTML(a));return a},getNode:function(){var a=this,b=a.getRng(),c=a.getSel(),d,e=b.startContainer,f=b.endContainer;function g(a,b){var c=a;while(a&&a.nodeType===3&&a.length===0){a=b?a.nextSibling:a.previousSibling}return a||c}if(!b)return a.dom.getRoot();if(b.setStart){d=b.commonAncestorContainer;if(!b.collapsed){if(b.startContainer==b.endContainer){if(b.endOffset-b.startOffset<2){if(b.startContainer.hasChildNodes())d=b.startContainer.childNodes[b.startOffset]}}if(e.nodeType===3&&f.nodeType===3){if(e.length===b.startOffset){e=g(e.nextSibling,true)}else{e=e.parentNode}if(b.endOffset===0){f=g(f.previousSibling,false)}else{f=f.parentNode}if(e&&e===f)return e}}if(d&&d.nodeType==3)return d.parentNode;return d}return b.item?b.item(0):b.parentElement()},getSelectedBlocks:function(a,b){var c=this,d=c.dom,e,g,h,i=[];e=d.getParent(a||c.getStart(),d.isBlock);g=d.getParent(b||c.getEnd(),d.isBlock);if(e)i.push(e);if(e&&g&&e!=g){h=e;var j=new f(e,d.getRoot());while((h=j.next())&&h!=g){if(d.isBlock(h))i.push(h)}}if(g&&e!=g)i.push(g);return i},isForward:function(){var a=this.dom,b=this.getSel(),c,d;if(!b||b.anchorNode==null||b.focusNode==null){return true}c=a.createRng();c.setStart(b.anchorNode,b.anchorOffset);c.collapse(true);d=a.createRng();d.setStart(b.focusNode,b.focusOffset);d.collapse(true);return c.compareBoundaryPoints(c.START_TO_START,d)<=0},normalize:function(){var b=this,c,d,e,g,h;function i(a){var g,h,i,j=b.dom,k=j.getRoot(),l,m,n;function o(a,b){var c=new f(a,j.getParent(a.parentNode,j.isBlock)||k);while(a=c[b?"prev":"next"]()){if(a.nodeName==="BR"){return true}}}function p(a,b){var c,i;b=b||g;c=new f(b,j.getParent(b.parentNode,j.isBlock)||k);while(l=c[a?"prev":"next"]()){if(l.nodeType===3&&l.nodeValue.length>0){g=l;h=a?l.nodeValue.length:0;d=true;return}if(l.tagName==="A")return;if(j.isBlock(l)||m[l.nodeName.toLowerCase()]){if(b.parentNode.tagName==="A"&&!a){var n=document.createTextNode("");b.parentNode.parentNode.insertBefore(n,b.parentNode.nextSibling);g=n;h=0;d=true}return}i=l}if(e&&!i&&b.parentNode.tagName==="A"){var o=b.parentNode;var n=document.createTextNode("");o.parentNode.insertBefore(n,o);i=n}if(e&&i){g=i;d=true;h=0}}g=c[(a?"start":"end")+"Container"];h=c[(a?"start":"end")+"Offset"];m=j.schema.getNonEmptyElements();if(g.nodeType===9){g=j.getRoot();h=0}if(g===k){if(a){l=g.childNodes[h>0?h-1:0];if(l){n=l.nodeName.toLowerCase();if(m[l.nodeName]||l.nodeName=="TABLE"){return}}}if(g.hasChildNodes()){g=g.childNodes[Math.min(!a&&h>0?h-1:h,g.childNodes.length-1)];h=0;if(g.hasChildNodes()&&!/TABLE/.test(g.nodeName)){l=g;i=new f(g,k);do{if(l.nodeType===3&&l.nodeValue.length>0){h=a?0:l.nodeValue.length;g=l;d=true;break}if(m[l.nodeName.toLowerCase()]){h=j.nodeIndex(l);g=l.parentNode;if(l.nodeName=="IMG"&&!a){h++}d=true;break}}while(l=a?i.next():i.prev())}}}if(e){if(g.nodeType===3&&h===0){p(true)}if(g.nodeType===3&&g.parentNode.tagName==="A"&&g.length===h&&!(g.parentNode.previousSibling.nodeType===3&&g.parentNode.previousSibling.length===0)){var q=g.parentNode;var r=document.createTextNode("");q.parentNode.insertBefore(r,q);g=r;h=0;d=true;return}var s=j.doc.body;var t=s&&s.childNodes[s.childNodes.length-1];if(t&&t.tagName==="A"){var u=document.createTextNode("");s.appendChild(u);s.appendChild(document.createTextNode(""));g=u;h=0;d=true;return}if(g.nodeType===1){l=g.childNodes[h];if(l&&l.nodeName==="BR"&&!o(l)&&!o(l,true)){p(true,g.childNodes[h])}}}if(a&&!e&&g.nodeType===3&&h===g.nodeValue.length){p(false)}if(d){c["set"+(a?"Start":"End")](g,h)}}if(a.isIE)return;c=b.getRng();e=c.collapsed;i(true);if(!e)i();if(d){if(e){c.collapse(true)}b.setRng(c,b.isForward())}},selectorChanged:function(a,b){var c=this,d;if(!c.selectorChangedData){c.selectorChangedData={};d={};c.editor.onNodeChange.addToTop(function(a,b,f){var g=c.dom,h=g.getParents(f,null,g.getRoot()),i={};e(c.selectorChangedData,function(a,b){e(h,function(c){if(g.is(c,b)){if(!d[b]){e(a,function(a){a(true,{node:c,selector:b,parents:h})});d[b]=a}i[b]=a;return false}})});e(d,function(a,b){if(!i[b]){delete d[b];e(a,function(a){a(false,{node:f,selector:b,parents:h})})}})})}if(!c.selectorChangedData[a]){c.selectorChangedData[a]=[]}c.selectorChangedData[a].push(b);return c},scrollIntoView:function(a){var b,c,d=this,e=d.dom;c=e.getViewPort(d.editor.getWin());b=e.getPos(a).y;if(b<c.y||b+25>c.y+c.h){d.editor.getWin().scrollTo(0,b<c.y?b:b-c.h+25)}},destroy:function(b){var c=this;c.win=null;if(!b)a.removeUnload(c.destroy)},_fixIESelection:function(){var a=this.dom,b=a.doc,c=b.body,d,e,f;function g(a,b){var d=c.createTextRange();try{d.moveToPoint(a,b)}catch(a){d=null}return d}function h(a){var b;if(a.button){b=g(a.x,a.y);if(b){if(b.compareEndPoints("StartToStart",e)>0)b.setEndPoint("StartToStart",e);else b.setEndPoint("EndToEnd",e);b.select()}}else i()}function i(){var c=b.selection.createRange();if(e&&!c.item&&c.compareEndPoints("StartToEnd",c)===0)e.select();a.unbind(b,"mouseup",i);a.unbind(b,"mousemove",h);e=d=0}b.documentElement.unselectable=true;a.bind(b,["mousedown","contextmenu"],function(c){if(c.target.nodeName==="HTML"){if(d)i();f=b.documentElement;if(f.scrollHeight>f.clientHeight)return;d=1;e=g(c.x,c.y);if(e){a.bind(b,"mouseup",i);a.bind(b,"mousemove",h);a.win.focus();e.select()}}})}})})(tinymce);(function(a){a.dom.Serializer=function(b,c,d){var e,f,g=a.isIE,h=a.each,i;if(!b.apply_source_formatting)b.indent=false;c=c||a.DOM;d=d||new a.html.Schema(b);b.entity_encoding=b.entity_encoding||"named";b.remove_trailing_brs="remove_trailing_brs"in b?b.remove_trailing_brs:true;e=new a.util.Dispatcher(self);f=new a.util.Dispatcher(self);i=new a.html.DomParser(b,d);i.addAttributeFilter("src,href,style",function(a,d){var e=a.length,f,g,h="data-mce-"+d,i=b.url_converter,j=b.url_converter_scope,k;while(e--){f=a[e];g=f.attributes.map[h];if(g!==k){f.attr(d,g.length>0?g:null);f.attr(h,null)}else{g=f.attributes.map[d];if(d==="style")g=c.serializeStyle(c.parseStyle(g),f.name);else if(i)g=i.call(j,g,d,f.name);f.attr(d,g.length>0?g:null)}}});i.addAttributeFilter("class",function(a,b){var c=a.length,d,e;while(c--){d=a[c];e=d.attr("class").replace(/(?:^|\s)mce(Item\w+|Selected)(?!\S)/g,"");d.attr("class",e.length>0?e:null)}});i.addAttributeFilter("data-mce-type",function(a,b,c){var d=a.length,e;while(d--){e=a[d];if(e.attributes.map["data-mce-type"]==="bookmark"&&!c.cleanup)e.remove()}});i.addAttributeFilter("data-mce-expando",function(a,b,c){var d=a.length;while(d--){a[d].attr(b,null)}});i.addNodeFilter("noscript",function(b){var c=b.length,d;while(c--){d=b[c].firstChild;if(d){d.value=a.html.Entities.decode(d.value)}}});i.addNodeFilter("script,style",function(a,b){var c=a.length,d,e;function f(a){return a.replace(/(<!--\[CDATA\[|\]\]-->)/g,"\n").replace(/^[\r\n]*|[\r\n]*$/g,"").replace(/^\s*((<!--)?(\s*\/\/)?\s*<!\[CDATA\[|(<!--\s*)?\/\*\s*<!\[CDATA\[\s*\*\/|(\/\/)?\s*<!--|\/\*\s*<!--\s*\*\/)\s*[\r\n]*/gi,"").replace(/\s*(\/\*\s*\]\]>\s*\*\/(-->)?|\s*\/\/\s*\]\]>(-->)?|\/\/\s*(-->)?|\]\]>|\/\*\s*-->\s*\*\/|\s*-->\s*)\s*$/g,"")}while(c--){d=a[c];e=d.firstChild?d.firstChild.value:"";if(b==="script"){d.attr("type",(d.attr("type")||"text/javascript").replace(/^mce\-/,""));if(e.length>0)d.firstChild.value="// <![CDATA[\n"+f(e)+"\n// ]]>"}else{if(e.length>0)d.firstChild.value="\x3c!--\n"+f(e)+"\n--\x3e"}}});i.addNodeFilter("#comment",function(a,b){var c=a.length,d;while(c--){d=a[c];if(d.value.indexOf("[CDATA[")===0){d.name="#cdata";d.type=4;d.value=d.value.replace(/^\[CDATA\[|\]\]$/g,"")}else if(d.value.indexOf("mce:protected ")===0){d.name="#text";d.type=3;d.raw=true;d.value=unescape(d.value).substr(14)}}});i.addNodeFilter("xml:namespace,input",function(a,b){var c=a.length,d;while(c--){d=a[c];if(d.type===7)d.remove();else if(d.type===1){if(b==="input"&&!("type"in d.attributes.map))d.attr("type","text")}}});if(b.fix_list_elements){i.addNodeFilter("ul,ol",function(a,b){var c=a.length,d,e;while(c--){d=a[c];e=d.parent;if(e.name==="ul"||e.name==="ol"){if(d.prev&&d.prev.name==="li"){d.prev.append(d)}}}})}i.addAttributeFilter("data-mce-src,data-mce-href,data-mce-style",function(a,b){var c=a.length;while(c--){a[c].attr(b,null)}});return{schema:d,addNodeFilter:i.addNodeFilter,addAttributeFilter:i.addAttributeFilter,onPreProcess:e,onPostProcess:f,serialize:function(j,k){var l,m,n,o,p;if(g&&c.select("script,style,select,map").length>0){p=j.innerHTML;j=j.cloneNode(false);c.setHTML(j,p)}else j=j.cloneNode(true);l=j.ownerDocument.implementation;if(l.createHTMLDocument){m=l.createHTMLDocument("");h(j.nodeName=="BODY"?j.childNodes:[j],function(a){m.body.appendChild(m.importNode(a,true))});if(j.nodeName!="BODY")j=m.body.firstChild;else j=m.body;n=c.doc;c.doc=m}k=k||{};k.format=k.format||"html";if(!k.no_events){k.node=j;e.dispatch(self,k)}o=new a.html.Serializer(b,d);k.content=o.serialize(i.parse(a.trim(k.getInner?j.innerHTML:c.getOuterHTML(j)),k));if(!k.cleanup)k.content=k.content.replace(/\uFEFF/g,"");if(!k.no_events)f.dispatch(self,k);if(n)c.doc=n;k.node=null;return k.content},addRules:function(a){d.addValidElements(a)},setRules:function(a){d.setValidElements(a)}}}})(tinymce);(function(a){a.dom.ScriptLoader=function(b){var c=0,d=1,e=2,f={},g=[],h={},i=[],j=0,k;function l(b,c){var d=this,e=a.DOM,f,g,h,i;function j(){e.remove(i);if(f)f.onreadystatechange=f.onload=f=null;c()}function k(){if(typeof console!=="undefined"&&console.log)console.log("Failed to load: "+b)}i=e.uniqueId();if(a.isIE6){g=new a.util.URI(b);h=location;if(g.host==h.hostname&&g.port==h.port&&g.protocol+":"==h.protocol&&g.protocol.toLowerCase()!="file"){a.util.XHR.send({url:a._addVer(g.getURI()),success:function(a){var b=e.create("script",{type:"text/javascript"});b.text=a;document.getElementsByTagName("head")[0].appendChild(b);e.remove(b);j()},error:k});return}}f=document.createElement("script");f.id=i;f.type="text/javascript";f.src=a._addVer(b);if(!a.isIE||a.isIE11)f.onload=j;f.onerror=k;if(!a.isOpera){f.onreadystatechange=function(){var a=f.readyState;if(a=="complete"||a=="loaded")j()}}(document.getElementsByTagName("head")[0]||document.body).appendChild(f)}this.isDone=function(a){return f[a]==e};this.markDone=function(a){f[a]=e};this.add=this.load=function(a,b,d){var e,i=f[a];if(i==k){g.push(a);f[a]=c}if(b){if(!h[a])h[a]=[];h[a].push({func:b,scope:d||this})}};this.loadQueue=function(a,b){this.loadScripts(g,a,b)};this.loadScripts=function(b,c,g){var m;function n(b){a.each(h[b],function(a){a.func.call(a.scope)});h[b]=k}i.push({func:c,scope:g||this});m=function(){var c=a.grep(b);b.length=0;a.each(c,function(a){if(f[a]==e){n(a);return}if(f[a]!=d){f[a]=d;j++;l(a,function(){f[a]=e;j--;n(a);m()})}});if(!j){a.each(i,function(a){a.func.call(a.scope)});i.length=0}};m()}};a.ScriptLoader=new a.dom.ScriptLoader})(tinymce);(function(a){a.dom.RangeUtils=function(b){var c="\ufeff";this.walk=function(c,d){var e=c.startContainer,f=c.startOffset,g=c.endContainer,h=c.endOffset,i,j,k,l,m,n,o;o=b.select("td.mceSelected,th.mceSelected");if(o.length>0){a.each(o,function(a){d([a])});return}function p(a){var b;b=a[0];if(b.nodeType===3&&b===e&&f>=b.nodeValue.length){a.splice(0,1)}b=a[a.length-1];if(h===0&&a.length>0&&b===g&&b.nodeType===3){a.splice(a.length-1,1)}return a}function q(a,b,c){var d=[];for(;a&&a!=c;a=a[b])d.push(a);return d}function r(a,b){do{if(a.parentNode==b)return a;a=a.parentNode}while(a)}function s(a,b,c){var e=c?"nextSibling":"previousSibling";for(l=a,m=l.parentNode;l&&l!=b;l=m){m=l.parentNode;n=q(l==a?l:l[e],e);if(n.length){if(!c)n.reverse();d(p(n))}}}if(e.nodeType==1&&e.hasChildNodes())e=e.childNodes[f];if(g.nodeType==1&&g.hasChildNodes())g=g.childNodes[Math.min(h-1,g.childNodes.length-1)];if(e==g)return d(p([e]));i=b.findCommonAncestor(e,g);for(l=e;l;l=l.parentNode){if(l===g)return s(e,i,true);if(l===i)break}for(l=g;l;l=l.parentNode){if(l===e)return s(g,i);if(l===i)break}j=r(e,i)||e;k=r(g,i)||g;s(e,j,true);n=q(j==e?j:j.nextSibling,"nextSibling",k==g?k.nextSibling:k);if(n.length)d(p(n));s(g,k)};this.split=function(a){var b=a.startContainer,c=a.startOffset,d=a.endContainer,e=a.endOffset;function f(a,b){return a.splitText(b)}if(b==d&&b.nodeType==3){if(c>0&&c<b.nodeValue.length){d=f(b,c);b=d.previousSibling;if(e>c){e=e-c;b=d=f(d,e).previousSibling;e=d.nodeValue.length;c=0}else{e=0}}}else{if(b.nodeType==3&&c>0&&c<b.nodeValue.length){b=f(b,c);c=0}if(d.nodeType==3&&e>0&&e<d.nodeValue.length){d=f(d,e).previousSibling;e=d.nodeValue.length}}return{startContainer:b,startOffset:c,endContainer:d,endOffset:e}}};a.dom.RangeUtils.compareRanges=function(a,b){if(a&&b){if(a.item||a.duplicate){if(a.item&&b.item&&a.item(0)===b.item(0))return true;if(a.isEqual&&b.isEqual&&b.isEqual(a))return true}else{return a.startContainer==b.startContainer&&a.startOffset==b.startOffset}}return false}})(tinymce);(function(a){var b=a.dom.Event,c=a.each;a.create("tinymce.ui.KeyboardNavigation",{KeyboardNavigation:function(d,e){var f=this,g=d.root,h=d.items,i=d.enableUpDown,j=d.enableLeftRight||!d.enableUpDown,k=d.excludeFromTabOrder,l,m,n,o,p;e=e||a.DOM;l=function(a){p=a.target.id};m=function(a){e.setAttrib(a.target.id,"tabindex","-1")};o=function(a){var b=e.get(p);e.setAttrib(b,"tabindex","0");b.focus()};f.focus=function(){e.get(p).focus()};f.destroy=function(){c(h,function(a){var b=e.get(a.id);e.unbind(b,"focus",l);e.unbind(b,"blur",m)});var a=e.get(g);e.unbind(a,"focus",o);e.unbind(a,"keydown",n);h=e=g=f.focus=l=m=n=o=null;f.destroy=function(){}};f.moveFocus=function(a,g){var i=-1,j=f.controls,k;if(!p)return;c(h,function(a,b){if(a.id===p){i=b;return false}});i+=a;if(i<0){i=h.length-1}else if(i>=h.length){i=0}k=h[i];e.setAttrib(p,"tabindex","-1");e.setAttrib(k.id,"tabindex","0");e.get(k.id).focus();if(d.actOnFocus){d.onAction(k.id)}if(g)b.cancel(g)};n=function(a){var c=37,e=39,g=38,h=40,k=27,l=14,m=13,n=32;switch(a.keyCode){case c:if(j)f.moveFocus(-1);break;case e:if(j)f.moveFocus(1);break;case g:if(i)f.moveFocus(-1);break;case h:if(i)f.moveFocus(1);break;case k:if(d.onCancel){d.onCancel();b.cancel(a)}break;case l:case m:case n:if(d.onAction){d.onAction(p);b.cancel(a)}break}};c(h,function(a,b){var c,d;if(!a.id){a.id=e.uniqueId("_mce_item_")}d=e.get(a.id);if(k){e.bind(d,"blur",m);c="-1"}else{c=b===0?"0":"-1"}d.setAttribute("tabindex",c);e.bind(d,"focus",l)});if(h[0]){p=h[0].id}e.setAttrib(g,"tabindex","-1");var q=e.get(g);e.bind(q,"focus",o);e.bind(q,"keydown",n)}})})(tinymce);(function(a){var b=a.DOM,c=a.is;a.create("tinymce.ui.Control",{Control:function(b,c,d){this.id=b;this.settings=c=c||{};this.rendered=false;this.onRender=new a.util.Dispatcher(this);this.classPrefix="";this.scope=c.scope||this;this.disabled=0;this.active=0;this.editor=d},setAriaProperty:function(a,c){var d=b.get(this.id+"_aria")||b.get(this.id);if(d){b.setAttrib(d,"aria-"+a,!!c)}},focus:function(){b.get(this.id).focus()},setDisabled:function(a){if(a!=this.disabled){this.setAriaProperty("disabled",a);this.setState("Disabled",a);this.setState("Enabled",!a);this.disabled=a}},isDisabled:function(){return this.disabled},setActive:function(a){if(a!=this.active){this.setState("Active",a);this.active=a;this.setAriaProperty("pressed",a)}},isActive:function(){return this.active},setState:function(a,c){var d=b.get(this.id);a=this.classPrefix+a;if(c)b.addClass(d,a);else b.removeClass(d,a)},isRendered:function(){return this.rendered},renderHTML:function(){},renderTo:function(a){b.setHTML(a,this.renderHTML())},postRender:function(){var a=this,b;if(c(a.disabled)){b=a.disabled;a.disabled=-1;a.setDisabled(b)}if(c(a.active)){b=a.active;a.active=-1;a.setActive(b)}},remove:function(){b.remove(this.id);this.destroy()},destroy:function(){a.dom.Event.clear(this.id)}})})(tinymce);tinymce.create("tinymce.ui.Container:tinymce.ui.Control",{Container:function(a,b,c){this.parent(a,b,c);this.controls=[];this.lookup={}},add:function(a){this.lookup[a.id]=a;this.controls.push(a);return a},get:function(a){return this.lookup[a]}});tinymce.create("tinymce.ui.Separator:tinymce.ui.Control",{Separator:function(a,b){this.parent(a,b);this.classPrefix="mceSeparator";this.setDisabled(true)},renderHTML:function(){return tinymce.DOM.createHTML("span",{class:this.classPrefix,role:"separator","aria-orientation":"vertical",tabindex:"-1"})}});(function(a){var b=a.is,c=a.DOM,d=a.each,e=a.walk;a.create("tinymce.ui.MenuItem:tinymce.ui.Control",{MenuItem:function(a,b){this.parent(a,b);this.classPrefix="mceMenuItem"},setSelected:function(a){this.setState("Selected",a);this.setAriaProperty("checked",!!a);this.selected=a},isSelected:function(){return this.selected},postRender:function(){var a=this;a.parent();if(b(a.selected))a.setSelected(a.selected)}})})(tinymce);(function(a){var b=a.is,c=a.DOM,d=a.each,e=a.walk;a.create("tinymce.ui.Menu:tinymce.ui.MenuItem",{Menu:function(b,c){var d=this;d.parent(b,c);d.items={};d.collapsed=false;d.menuCount=0;d.onAddItem=new a.util.Dispatcher(this)},expand:function(a){var b=this;if(a){e(b,function(a){if(a.expand)a.expand()},"items",b)}b.collapsed=false},collapse:function(a){var b=this;if(a){e(b,function(a){if(a.collapse)a.collapse()},"items",b)}b.collapsed=true},isCollapsed:function(){return this.collapsed},add:function(b){if(!b.settings)b=new a.ui.MenuItem(b.id||c.uniqueId(),b);this.onAddItem.dispatch(this,b);return this.items[b.id]=b},addSeparator:function(){return this.add({separator:true})},addMenu:function(a){if(!a.collapse)a=this.createMenu(a);this.menuCount++;return this.add(a)},hasMenus:function(){return this.menuCount!==0},remove:function(a){delete this.items[a.id]},removeAll:function(){var a=this;e(a,function(a){if(a.removeAll)a.removeAll();else a.remove();a.destroy()},"items",a);a.items={}},createMenu:function(b){var d=new a.ui.Menu(b.id||c.uniqueId(),b);d.onAddItem.add(this.onAddItem.dispatch,this.onAddItem);return d}})})(tinymce);(function(a){var b=a.is,c=a.DOM,d=a.each,e=a.dom.Event,f=a.dom.Element;a.create("tinymce.ui.DropMenu:tinymce.ui.Menu",{DropMenu:function(d,e){e=e||{};e.container=e.container||c.doc.body;e.offset_x=e.offset_x||0;e.offset_y=e.offset_y||0;e.vp_offset_x=e.vp_offset_x||0;e.vp_offset_y=e.vp_offset_y||0;if(b(e.icons)&&!e.icons)e["class"]+=" mceNoIcons";this.parent(d,e);this.onShowMenu=new a.util.Dispatcher(this);this.onHideMenu=new a.util.Dispatcher(this);this.classPrefix="mceMenu"},createMenu:function(b){var d=this,e=d.settings,f;b.container=b.container||e.container;b.parent=d;b.constrain=b.constrain||e.constrain;b["class"]=b["class"]||e["class"];b.vp_offset_x=b.vp_offset_x||e.vp_offset_x;b.vp_offset_y=b.vp_offset_y||e.vp_offset_y;b.keyboard_focus=e.keyboard_focus;f=new a.ui.DropMenu(b.id||c.uniqueId(),b);f.onAddItem.add(d.onAddItem.dispatch,d.onAddItem);return f},focus:function(){var a=this;if(a.keyboardNav){a.keyboardNav.focus()}},update:function(){var a=this,b=a.settings,d=c.get("menu_"+a.id+"_tbl"),e=c.get("menu_"+a.id+"_co"),f,g;f=b.max_width?Math.min(d.clientWidth,b.max_width):d.clientWidth;g=b.max_height?Math.min(d.clientHeight,b.max_height):d.clientHeight;if(b.max_width)c.setStyle(e,"width",f);if(b.max_height){c.setStyle(e,"height",g);if(d.clientHeight<b.max_height)c.setStyle(e,"overflow","hidden")}},showMenu:function(a,b,g){var h=this,i=h.settings,j,k=c.getViewPort(),l,m,n,o,p=2,q,r,s=h.classPrefix;h.collapse(1);if(h.isMenuVisible)return;if(!h.rendered){j=c.add(h.settings.container,h.renderNode());d(h.items,function(a){a.postRender()});h.element=new f("menu_"+h.id,{blocker:1,container:i.container})}else j=c.get("menu_"+h.id);c.show(j);h.update();a+=i.offset_x||0;b+=i.offset_y||0;k.w-=4;k.h-=4;if(i.constrain){l=j.clientWidth-p;m=j.clientHeight-p;n=k.x+k.w;o=k.y+k.h;if(a+i.vp_offset_x+l>n)a=g?g-l:Math.max(0,n-i.vp_offset_x-l);if(b+i.vp_offset_y+m>o)b=Math.max(0,o-i.vp_offset_y-m)}h.element.update();h.isMenuVisible=1;h.mouseClickFunc=e.add(j,"click",function(a){var b;a=a.target;if(a&&(a=c.getParent(a,"tr"))&&!c.hasClass(a,s+"ItemSub")){b=h.items[a.id];if(!b)return;if(b.isDisabled())return;q=h;while(q){if(q.hideMenu)q.hideMenu();q=q.settings.parent}if(b.settings.onclick)b.settings.onclick(a);return e.cancel(a)}});if(h.hasMenus()){h.mouseOverFunc=e.add(j,"mouseover",function(a){var b,d,e;a=a.target;if(a&&(a=c.getParent(a,"tr"))){b=h.items[a.id];if(h.lastMenu)h.lastMenu.collapse(1);if(b.isDisabled())return;if(a&&c.hasClass(a,s+"ItemSub")){d=c.getRect(a);b.showMenu(d.x+d.w-p,d.y-p,d.x);h.lastMenu=b;c.addClass(c.get(b.id).firstChild,s+"ItemActive")}}})}e.add(j,"keydown",h._keyHandler,h);h.onShowMenu.dispatch(h);if(i.keyboard_focus){h._setupKeyboardNav()}},hideMenu:function(a){var b=this,d=c.get("menu_"+b.id),f;if(!b.isMenuVisible)return;if(b.keyboardNav)b.keyboardNav.destroy();e.remove(d,"mouseover",b.mouseOverFunc);e.remove(d,"click",b.mouseClickFunc);e.remove(d,"keydown",b._keyHandler);c.hide(d);b.isMenuVisible=0;if(!a)b.collapse(1);if(b.element)b.element.hide();if(f=c.get(b.id))c.removeClass(f.firstChild,b.classPrefix+"ItemActive");b.onHideMenu.dispatch(b)},add:function(a){var b=this,d;a=b.parent(a);if(b.isRendered&&(d=c.get("menu_"+b.id)))b._add(c.select("tbody",d)[0],a);return a},collapse:function(a){this.parent(a);this.hideMenu(1)},remove:function(a){c.remove(a.id);this.destroy();return this.parent(a)},destroy:function(){var a=this,b=c.get("menu_"+a.id);if(a.keyboardNav)a.keyboardNav.destroy();e.remove(b,"mouseover",a.mouseOverFunc);e.remove(c.select("a",b),"focus",a.mouseOverFunc);e.remove(b,"click",a.mouseClickFunc);e.remove(b,"keydown",a._keyHandler);if(a.element)a.element.remove();c.remove(b)},renderNode:function(){var a=this,b=a.settings,e,g,h,i;i=c.create("div",{role:"listbox",id:"menu_"+a.id,class:b["class"]});if(a.settings.parent){c.setAttrib(i,"aria-parent","menu_"+a.settings.parent.id)}h=c.add(i,"div",{role:"presentation",id:"menu_"+a.id+"_co",class:a.classPrefix+(b["class"]?" "+b["class"]:"")});a.element=new f("menu_"+a.id,{blocker:1,container:b.container});if(b.menu_line)c.add(h,"span",{class:a.classPrefix+"Line"});e=c.add(h,"table",{role:"presentation",id:"menu_"+a.id+"_tbl",border:0,cellPadding:0,cellSpacing:0});g=c.add(e,"tbody");d(a.items,function(b){a._add(g,b)});a.rendered=true;return i},_setupKeyboardNav:function(){var b,d,e=this;b=c.select("#menu_"+e.id)[0];d=c.select("a[role=option]","menu_"+e.id);d.splice(0,0,b);e.keyboardNav=new a.ui.KeyboardNavigation({root:"menu_"+e.id,items:d,onCancel:function(){e.hideMenu()},enableUpDown:true});b.focus()},_keyHandler:function(a){var b=this,c;switch(a.keyCode){case 37:if(b.settings.parent){b.hideMenu();b.settings.parent.focus();e.cancel(a)}break;case 39:if(b.mouseOverFunc)b.mouseOverFunc(a);break}},_add:function(a,b){var d,e=b.settings,f,g,h,i=this.classPrefix,j;if(e.separator){g=c.add(a,"tr",{id:b.id,class:i+"ItemSeparator"});c.add(g,"td",{class:i+"ItemSeparator"});if(d=g.previousSibling)c.addClass(d,"mceLast");return}d=g=c.add(a,"tr",{id:b.id,class:i+"Item "+i+"ItemEnabled"});d=h=c.add(d,e.titleItem?"th":"td");d=f=c.add(d,"a",{id:b.id+"_aria",class:"mceSplitButtonItemLink",role:e.titleItem?"presentation":"option",href:"javascript:;",onclick:"return false;",onmousedown:"return false;"});if(e.parent){c.setAttrib(f,"aria-haspopup","true");c.setAttrib(f,"aria-owns","menu_"+b.id)}c.addClass(h,e["class"]);j=c.add(d,"span",{class:"mceIcon"+(e.icon?" mce_"+e.icon:"")});if(e.icon_src)c.add(j,"img",{src:e.icon_src});d=c.add(d,e.element||"span",{class:"mceText",title:b.settings.title},b.settings.title);if(b.settings.style)c.setAttrib(d,"style",b.settings.style);if(a.childNodes.length==1)c.addClass(g,"mceFirst");if((d=g.previousSibling)&&c.hasClass(d,i+"ItemSeparator"))c.addClass(g,"mceFirst");if(b.collapse)c.addClass(g,i+"ItemSub");if(d=g.previousSibling)c.removeClass(d,"mceLast");c.addClass(g,"mceLast")}})})(tinymce);(function(a){var b=a.DOM;a.create("tinymce.ui.Button:tinymce.ui.Control",{Button:function(a,b,c){this.parent(a,b,c);this.classPrefix="mceButton"},renderHTML:function(){var a=this.classPrefix,c=this.settings,d,e;e=b.encode(c.label||"");if(c.link){a="mceToolbarLink"}var f=function(b){if(b){b+=" "}else{b=""}return'<span class="'+b+"mceIcon "+c["class"]+'"></span>'+(e?'<span class="'+a+'Label">'+e+"</span>":"")};d='<a role="button" id="'+this.id+'" href="javascript:;" class="'+a+" "+a+"Enabled "+c["class"]+'" onmousedown="return false;" onclick="return false;" aria-labelledby="'+this.id+'_voice" title="'+b.encode(c.title)+'">';if(c.image&&!(this.editor&&this.editor.forcedHighContrastMode)){d+='<img class="mceIcon" src="'+c.image+'" alt="'+b.encode(c.title)+'" />'+e}else if(c.link){var g=["mceToolbarLinkOpen"];if(c.linkAlign){if(c.linkAlign=="left"){g.push("mceToolbarLinkOpenAlignLeft")}else{g.push("mceToolbarLinkOpenAlignRight")}}d+='<span class="mceTextIcon">';if(c.linkPosition){if(c.linkPosition=="left"){g.push("mceToolbarLinkOpenPositionLeft");d+=b.createHTML("span",{class:g.join(" ")},"")+b.createHTML("span",{class:"mceToolbarLinkTitle"},c.link)}else{g.push("mceToolbarLinkOpenPositionRight");d+=b.createHTML("span",{class:"mceToolbarLinkTitle"},c.link)+b.createHTML("span",{class:g.join(" ")},"")}}else{d+=b.createHTML("span",{class:"mceToolbarLinkTitle"},c.link)}d+="</span>";d+=f("mceTextIconBoth")}else{d+=f()}d+="</a>";return d},postRender:function(){var b=this,c=b.settings;a.dom.Event.add(b.id,"click",function(a){if(!b.isDisabled())return c.onclick.call(c.scope,a)})}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.each,e=a.util.Dispatcher,f;a.create("tinymce.ui.ListBox:tinymce.ui.Control",{ListBox:function(b,c,d){var f=this;f.parent(b,c,d);f.items=[];f.onChange=new e(f);f.onPostRender=new e(f);f.onAdd=new e(f);f.onRenderMenu=new a.util.Dispatcher(this);f.classPrefix="mceListBox";f.marked={}},select:function(a){var b=this,c,e;b.marked={};if(a==f)return b.selectByIndex(-1);if(a&&typeof a=="function")e=a;else{e=function(b){return b==a}}if(a!=b.selectedValue){d(b.items,function(a,d){if(e(a.value)){c=1;b.selectByIndex(d);return false}});if(!c)b.selectByIndex(-1)}},selectByIndex:function(a){var c=this,d,e,f;c.marked={};if(a!=c.selectedIndex){d=b.get(c.id+"_text");f=b.get(c.id+"_voiceDesc");e=c.items[a];if(e){c.selectedValue=e.value;c.selectedIndex=a;b.setHTML(d,b.encode(e.title));b.setHTML(f,c.settings.title+" - "+e.title);b.removeClass(d,"mceTitle");b.setAttrib(c.id,"aria-valuenow",e.title)}else{b.setHTML(d,b.encode(c.settings.title));b.setHTML(f,b.encode(c.settings.title));b.addClass(d,"mceTitle");c.selectedValue=c.selectedIndex=null;b.setAttrib(c.id,"aria-valuenow",c.settings.title)}d=0}},mark:function(a){this.marked[a]=true},add:function(b,c,d){var e=this;d=d||{};d=a.extend(d,{title:b,value:c});e.items.push(d);e.onAdd.dispatch(e,d)},getLength:function(){return this.items.length},renderHTML:function(){var a="",c=this,d=c.settings,e=c.classPrefix;a='<span role="listbox" aria-haspopup="true" aria-labelledby="'+c.id+'_voiceDesc" aria-describedby="'+c.id+'_voiceDesc"><table role="presentation" tabindex="0" id="'+c.id+'" cellpadding="0" cellspacing="0" class="'+e+" "+e+"Enabled"+(d["class"]?" "+d["class"]:"")+'"><tbody><tr>';a+="<td>"+b.createHTML("span",{id:c.id+"_voiceDesc",class:"voiceLabel",style:"display:none;"},c.settings.title);a+=b.createHTML("a",{id:c.id+"_text",tabindex:-1,href:"javascript:;",class:"mceText",onclick:"return false;",onmousedown:"return false;"},b.encode(c.settings.title))+"</td>";a+="<td>"+b.createHTML("a",{id:c.id+"_open",tabindex:-1,href:"javascript:;",class:"mceOpen",onclick:"return false;",onmousedown:"return false;"},'<span><span style="display:none;" class="mceIconOnly" aria-hidden="true">▼</span></span>')+"</td>";a+="</tr></tbody></table></span>";return a},showMenu:function(){var e=this,f,g=b.get(this.id),h;if(e.isDisabled()||e.items.length===0)return;if(e.menu&&e.menu.isMenuVisible)return e.hideMenu();if(!e.isMenuRendered){e.renderMenu();e.isMenuRendered=true}f=b.getPos(g);h=e.menu;h.settings.offset_x=f.x;h.settings.offset_y=f.y;h.settings.keyboard_focus=!a.isOpera;d(e.items,function(a){if(h.items[a.id]){h.items[a.id].setSelected(0)}});d(e.items,function(a){if(h.items[a.id]&&e.marked[a.value]){h.items[a.id].setSelected(1)}if(a.value===e.selectedValue){h.items[a.id].setSelected(1)}});h.showMenu(0,g.clientHeight);c.add(b.doc,"mousedown",e.hideMenu,e);b.addClass(e.id,e.classPrefix+"Selected")},hideMenu:function(a){var d=this;if(d.menu&&d.menu.isMenuVisible){b.removeClass(d.id,d.classPrefix+"Selected");if(a&&a.type=="mousedown"&&(a.target.id==d.id+"_text"||a.target.id==d.id+"_open"))return;if(!a||!b.getParent(a.target,".mceMenu")){b.removeClass(d.id,d.classPrefix+"Selected");c.remove(b.doc,"mousedown",d.hideMenu,d);d.menu.hideMenu()}}},renderMenu:function(){var a=this,c;c=a.settings.control_manager.createDropMenu(a.id+"_menu",{menu_line:1,class:a.classPrefix+"Menu mceNoIcons",max_width:250,max_height:150});c.onHideMenu.add(function(){a.hideMenu();a.focus()});c.add({title:a.settings.title,class:"mceMenuItemTitle",onclick:function(){if(a.settings.onselect("")!==false)a.select("")}});d(a.items,function(d){if(d.value===f){c.add({title:d.title,role:"option",class:"mceMenuItemTitle",onclick:function(){if(a.settings.onselect("")!==false)a.select("")}})}else{d.id=b.uniqueId();d.role="option";d.onclick=function(){if(a.settings.onselect(d.value)!==false)a.select(d.value)};c.add(d)}});a.onRenderMenu.dispatch(a,c);a.menu=c},postRender:function(){var d=this,e=d.classPrefix;c.add(d.id,"click",d.showMenu,d);c.add(d.id,"keydown",function(a){if(a.keyCode==32){d.showMenu(a);c.cancel(a)}});c.add(d.id,"focus",function(){if(!d._focused){d.keyDownHandler=c.add(d.id,"keydown",function(a){if(a.keyCode==40){d.showMenu();c.cancel(a)}});d.keyPressHandler=c.add(d.id,"keypress",function(a){var b;if(a.keyCode==13){b=d.selectedValue;d.selectedValue=null;c.cancel(a);d.settings.onselect(b)}})}d._focused=1});c.add(d.id,"blur",function(){c.remove(d.id,"keydown",d.keyDownHandler);c.remove(d.id,"keypress",d.keyPressHandler);d._focused=0});if(a.isIE6||!b.boxModel){c.add(d.id,"mouseover",function(){if(!b.hasClass(d.id,e+"Disabled"))b.addClass(d.id,e+"Hover")});c.add(d.id,"mouseout",function(){if(!b.hasClass(d.id,e+"Disabled"))b.removeClass(d.id,e+"Hover")})}d.onPostRender.dispatch(d,b.get(d.id))},destroy:function(){this.parent();c.clear(this.id+"_text");c.clear(this.id+"_open")}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.each,e=a.util.Dispatcher,f;a.create("tinymce.ui.NativeListBox:tinymce.ui.ListBox",{NativeListBox:function(a,b){this.parent(a,b);this.classPrefix="mceNativeListBox"},setDisabled:function(a){b.get(this.id).disabled=a;this.setAriaProperty("disabled",a)},isDisabled:function(){return b.get(this.id).disabled},select:function(a){var b=this,c,e;if(a==f)return b.selectByIndex(-1);if(a&&typeof a=="function")e=a;else{e=function(b){return b==a}}if(a!=b.selectedValue){d(b.items,function(a,d){if(e(a.value)){c=1;b.selectByIndex(d);return false}});if(!c)b.selectByIndex(-1)}},selectByIndex:function(a){b.get(this.id).selectedIndex=a+1;this.selectedValue=this.items[a]?this.items[a].value:null},add:function(a,c,d){var e,f=this;d=d||{};d.value=c;if(f.isRendered())b.add(b.get(this.id),"option",d,a);e={title:a,value:c,attribs:d};f.items.push(e);f.onAdd.dispatch(f,e)},getLength:function(){return this.items.length},renderHTML:function(){var a,c=this;a=b.createHTML("option",{value:""},"-- "+c.settings.title+" --");d(c.items,function(c){a+=b.createHTML("option",{value:c.value},c.title)});a=b.createHTML("select",{id:c.id,class:"mceNativeListBox","aria-labelledby":c.id+"_aria"},a);a+=b.createHTML("span",{id:c.id+"_aria",style:"display: none"},c.settings.title);return a},postRender:function(){var d=this,e,f=true;d.rendered=true;function g(a){var b=d.items[a.target.selectedIndex-1];if(b&&(b=b.value)){d.onChange.dispatch(d,b);if(d.settings.onselect)d.settings.onselect(b)}}c.add(d.id,"change",g);c.add(d.id,"keydown",function(b){var h;c.remove(d.id,"change",e);f=false;h=c.add(d.id,"blur",function(){if(f)return;f=true;c.add(d.id,"change",g);c.remove(d.id,"blur",h)});if(a.isWebKit&&(b.keyCode==37||b.keyCode==39)){return c.prevent(b)}if(b.keyCode==13||b.keyCode==32){g(b);return c.cancel(b)}});d.onPostRender.dispatch(d,b.get(d.id))}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.each;a.create("tinymce.ui.MenuButton:tinymce.ui.Button",{MenuButton:function(c,d,e){this.parent(c,d,e);this.onRenderMenu=new a.util.Dispatcher(this);d.menu_container=d.menu_container||b.doc.body},showMenu:function(){var a=this,d,e,f=b.get(a.id),g;if(a.isDisabled())return;if(!a.isMenuRendered){a.renderMenu();a.isMenuRendered=true}if(a.isMenuVisible)return a.hideMenu();d=b.getPos(a.settings.menu_container);e=b.getPos(f);g=a.menu;g.settings.offset_x=e.x;g.settings.offset_y=e.y;g.settings.vp_offset_x=e.x;g.settings.vp_offset_y=e.y;g.settings.keyboard_focus=a._focused;g.showMenu(0,f.firstChild.clientHeight);c.add(b.doc,"mousedown",a.hideMenu,a);a.setState("Selected",1);a.isMenuVisible=1},renderMenu:function(){var a=this,b;b=a.settings.control_manager.createDropMenu(a.id+"_menu",{menu_line:1,class:this.classPrefix+"Menu",icons:a.settings.icons});b.onHideMenu.add(function(){a.hideMenu();a.focus()});a.onRenderMenu.dispatch(a,b);a.menu=b},hideMenu:function(a){var d=this;if(a&&a.type=="mousedown"&&b.getParent(a.target,function(a){return a.id===d.id||a.id===d.id+"_open"}))return;if(!a||!b.getParent(a.target,".mceMenu")){d.setState("Selected",0);c.remove(b.doc,"mousedown",d.hideMenu,d);if(d.menu)d.menu.hideMenu()}d.isMenuVisible=0},postRender:function(){var a=this,b=a.settings;c.add(a.id,"click",function(){if(!a.isDisabled()){if(b.onclick)b.onclick(a.value);a.showMenu()}})}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.each;a.create("tinymce.ui.SplitButton:tinymce.ui.MenuButton",{SplitButton:function(a,b,c){this.parent(a,b,c);this.classPrefix="mceSplitButton"},renderHTML:function(){var a="",c=this,d=c.settings,e;var f=function(a){if(a){a+=" "}else{a=""}return'<span class="'+a+"mceIcon "+d["class"]+'"></span>'};if(d.link){var g=["mceToolbarLinkOpen"];if(d.linkAlign){if(d.linkAlign=="left"){g.push("mceToolbarLinkOpenAlignLeft")}else{g.push("mceToolbarLinkOpenAlignRight")}}a+='<span class="mceTextIcon">';if(d.linkPosition){if(d.linkPosition=="left"){g.push("mceToolbarLinkOpenPositionLeft");a+=b.createHTML("span",{class:g.join(" ")},"")+b.createHTML("span",{class:"mceToolbarLinkTitle"},d.link)}else{g.push("mceToolbarLinkOpenPositionRight");a+=b.createHTML("span",{class:"mceToolbarLinkTitle"},d.link)+b.createHTML("span",{class:g.join(" ")},"")}}else{a+=b.createHTML("span",{class:"mceToolbarLinkTitle"},d.link)}a+="</span>";a+=f("mceTextIconBoth");a=b.createHTML("a",{role:"button",id:c.id+"_action",tabindex:"-1",href:"javascript:;",class:"mceToolbarLink "+d["class"],onclick:"return false;",onmousedown:"return false;",title:d.title},a);a=b.createHTML("div",{id:c.id,class:"mceSplitButtonContainer"},a)}else{a="<tbody><tr>";if(d.image)e=b.createHTML("img ",{src:d.image,role:"presentation",class:"mceAction "+d["class"]});else e=b.createHTML("span",{class:"mceAction "+d["class"]},"");a+="<td >"+b.createHTML("a",{role:"button",id:c.id+"_action",tabindex:"-1",href:"javascript:;",class:"mceAction "+d["class"],onclick:"return false;",onmousedown:"return false;",title:d.title},e)+"</td>";a+="</tr></tbody>";a=b.createHTML("table",{role:"presentation",class:"mceSplitButton mceSplitButtonEnabled "+d["class"],cellpadding:"0",cellspacing:"0",title:d.title},a);a=b.createHTML("div",{id:c.id,role:"button",tabindex:"0","aria-labelledby":c.id+"_voice","aria-haspopup":"true"},a)}return a},postRender:function(){var d=this,e=d.settings,f;c.add(d.id+"_action","click",function(a){d.showMenu();c.cancel(a)});c.add([d.id,d.id+"_action"],"focus",function(){d._focused=1});c.add([d.id,d.id+"_action"],"blur",function(){d._focused=0});if(a.isIE6||!b.boxModel){c.add(d.id,"mouseover",function(){if(!b.hasClass(d.id,"mceSplitButtonDisabled"))b.addClass(d.id,"mceSplitButtonHover")});c.add(d.id,"mouseout",function(){if(!b.hasClass(d.id,"mceSplitButtonDisabled"))b.removeClass(d.id,"mceSplitButtonHover")})}},destroy:function(){this.parent();c.clear(this.id+"_action");c.clear(this.id+"_open");c.clear(this.id)}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.is,e=a.each;a.create("tinymce.ui.ColorSplitButton:tinymce.ui.SplitButton",{ColorSplitButton:function(b,c,d){var e=this;e.parent(b,c,d);e.settings=c=a.extend({colors:",ffffff,bcbcbc,6c6c6c,454545,2c2c2c,000000,fcc9c9,fe8c8c,fe5e5e,fd5b36,f82e00,fb2c2c,bf0000,ffe1c6,ffc998,fcad66,ff9331,ff810f,ff9c00,ff6000,d8ffe0,92f9a7,34ff5d,b2fb82,89f641,5cd809,05840b,b7e9ec,56e5ed,21cad3,03939b,039b80,006d5a,00484c,cac8e9,9690ea,6a60ec,4866e7,173bd3,001c91,001055,f3cafb,e287f4,c238dd,a476af,b53dd2,7a00c7,520384",grid_width:7,default_color:"#000000"},e.settings);e.onShowMenu=new a.util.Dispatcher(e);e.onHideMenu=new a.util.Dispatcher(e);e.value=c.default_color},showMenu:function(){var a=this,d,e,f,g;if(a.isDisabled())return;if(!a.isMenuRendered){a.renderMenu();a.isMenuRendered=true}if(a.isMenuVisible)return a.hideMenu();f=b.get(a.id);b.show(a.id+"_menu");b.addClass(f,"mceSplitButtonSelected");f=0;c.add(b.doc,"mousedown",a.hideMenu,a);a.onShowMenu.dispatch(a);if(a._focused){a._keyHandler=c.add(a.id+"_menu","keydown",function(b){if(b.keyCode==27)a.hideMenu()});b.select("a",a.id+"_menu")[0].focus()}a.isMenuVisible=1},hideMenu:function(a){var d=this;if(d.isMenuVisible){if(a&&a.type=="mousedown"&&b.getParent(a.target,function(a){return a.id===d.id+"_action"})){return}if(!a||!b.getParent(a.target,".mceSplitButtonMenu")){b.removeClass(d.id,"mceSplitButtonSelected");c.remove(b.doc,"mousedown",d.hideMenu,d);c.remove(d.id+"_menu","keydown",d._keyHandler);b.hide(d.id+"_menu")}d.isMenuVisible=0}},renderMenu:function(){var a=this,f,g=0,h=a.settings,i,j,k,l;l=b.add(b.get(a.id+"_action").parentNode,"div",{id:a.id+"_menu",class:h["menu_class"]+" "+h["class"],style:"position:absolute;"});f=b.add(l,"div",{class:h["class"]+" mceSplitButtonMenu"});i=b.add(f,"table",{class:"mceColorSplitMenu"});j=b.add(i,"tbody");g=0;e(d(h.colors,"array")?h.colors:h.colors.split(","),function(a){if(!g--){k=b.add(j,"tr");g=h.grid_width-1}i=b.add(k,"td");var c={href:"javascript:;",style:{}};if(a){c.style.backgroundColor="#"+a;c["_mce_color"]="#"+a}else{c["class"]="color_inherit";c["_mce_color"]="transparent"}i=b.add(i,"a",c)});b.addClass(f,"mceColorSplitMenu");c.add(a.id+"_menu","mousedown",function(a){return c.cancel(a)});c.add(a.id+"_menu","click",function(b){var d;b=b.target;if(b.nodeName=="A"&&(d=b.getAttribute("_mce_color")))a.setColor(d);return c.cancel(b)});return l},setColor:function(a){this.displayColor(a);this.hideMenu();this.settings.onselect(a)},displayColor:function(a){var c=this;b.setStyle(c.id+"_preview","backgroundColor",a);c.value=a},postRender:function(){var a=this,b=a.id;a.parent()},destroy:function(){this.parent();c.clear(this.id+"_menu");c.clear(this.id+"_more");b.remove(this.id+"_menu")}})})(tinymce);(function(a){var b=a.DOM,c=a.each,d=a.dom.Event;a.create("tinymce.ui.ToolbarGroup:tinymce.ui.Container",{renderHTML:function(){var c=this,d=[],e=c.controls,f=a.each,g=c.settings;d.push('<div id="'+c.id+'" role="group" aria-labelledby="'+c.id+'_voice">');d.push("<span role='application'>");d.push('<span id="'+c.id+'_voice" class="mceVoiceLabel" style="display:none;">'+b.encode(g.name)+"</span>");f(e,function(a){d.push(a.renderHTML())});d.push("</span>");d.push("</div>");return d.join("")},focus:function(){var a=this;b.get(a.id).focus()},postRender:function(){var d=this,e=[];c(d.controls,function(a){c(a.controls,function(a){if(a.id){e.push(a)}})});d.keyNav=new a.ui.KeyboardNavigation({root:d.id,items:e,onCancel:function(){if(a.isWebKit){b.get(d.editor.id+"_ifr").focus()}d.editor.focus()},excludeFromTabOrder:!d.settings.tab_focus_toolbar})},destroy:function(){var a=this;a.parent();a.keyNav.destroy();d.clear(a.id)}})})(tinymce);(function(a){var b=a.DOM,c=a.each;a.create("tinymce.ui.Toolbar:tinymce.ui.Container",{renderHTML:function(){var a=this,c="",d,e,f=a.settings,g,h,i,j;j=a.controls;for(g=0;g<j.length;g++){e=j[g];h=j[g-1];i=j[g+1];if(g===0){d="mceToolbarStart";if(e.Button)d+=" mceToolbarStartButton";else if(e.SplitButton)d+=" mceToolbarStartSplitButton";else if(e.ListBox)d+=" mceToolbarStartListBox";c+=b.createHTML("td",{class:d},b.createHTML("span",null,"\x3c!-- IE --\x3e"));if(f.title)c+=b.createHTML("td",{class:"mceToolbarTitle"},b.createHTML("span",null,f.title))}if(h&&e.ListBox){if(h.Button||h.SplitButton)c+=b.createHTML("td",{class:"mceToolbarEnd"},b.createHTML("span",null,"\x3c!-- IE --\x3e"))}if(b.stdMode)c+='<td style="position: relative" class="compose__control">'+e.renderHTML()+"</td>";else c+="<td>"+e.renderHTML()+"</td>";if(i&&e.ListBox){if(i.Button||i.SplitButton)c+=b.createHTML("td",{class:"mceToolbarStart"},b.createHTML("span",null,"\x3c!-- IE --\x3e"))}}d="mceToolbarEnd";if(e.Button)d+=" mceToolbarEndButton";else if(e.SplitButton)d+=" mceToolbarEndSplitButton";else if(e.ListBox)d+=" mceToolbarEndListBox";c+=b.createHTML("td",{class:d},b.createHTML("span",null,"\x3c!-- IE --\x3e"));return b.createHTML("table",{id:a.id,class:"mceToolbar"+(f["class"]?" "+f["class"]:""),cellpadding:"0",cellspacing:"0",align:a.settings.align||"",role:"presentation"},"<tbody><tr>"+c+"</tr></tbody>")}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.is,e=a.each;a.create("tinymce.ui.AddLinkMenu",{AddLinkMenu:function(c){var d=this;d.onShowMenu=new a.util.Dispatcher(d);d.onHideMenu=new a.util.Dispatcher(d);d.formId=b.uniqueId();d.id=b.uniqueId();d.ed=c},showMenu:function(){var a=this,d,e,f,g=a.ed;if(!a.isMenuRendered){a.renderMenu();a.isMenuRendered=true}if(a.isMenuVisible)return a.hideMenu();var h=b.get(a.formId);var i=g.selection.getNode();var j=b.getParent(i,"A");if(j){h.elements["href"].value=j.href;if(a.isImage(b.decode(j.innerHTML))){h.elements["title"].value=""}else{h.elements["title"].value=b.decode(j.innerHTML)}}else{var k=g.selection.getContent({format:"text"});h.elements["href"].value="http://";h.elements["title"].value=k}b.show(a.id+"_menu");g.onMouseDown.add(a.hideMenu,a);c.add(b.doc,"mousedown",a.hideMenu,a);a.onShowMenu.dispatch(a);a.isMenuVisible=1},hideMenu:function(a){var d=this,e=d.ed;if(a&&a.type=="mousedown"&&b.getParent(a.target,function(a){return a.id===d.id+"_action"}))return;if(!a||!b.getParent(a.target,".mceSplitButtonMenu")){b.removeClass(d.id,"mceSplitButtonSelected");c.remove(b.doc,"mousedown",d.hideMenu,d);c.remove(d.id+"_menu","keydown",d._keyHandler);b.hide(d.id+"_menu");e.onMouseDown.remove(d.hideMenu,d)}d.onHideMenu.dispatch(d);d.isMenuVisible=0},renderMenu:function(){var a=this,d,e=0,f=a.settings,g,h,i,j,k=a.ed;var l=b.uniqueId();var m=b.uniqueId();var n="";n+='<form id="'+a.formId+'">';n+='<div class="mceLabel">'+k.getLang("compose.add_link_form_href_label")+"</div>";n+='<div class="mceField"><input type="text" name="href" value=""/></div>';n+='<div class="mceLabel">'+k.getLang("compose.add_link_form_title_label")+"</div>";n+='<div class="mceField"><input type="text" name="title"/></div>';n+='<div class="mceControls"><input type="submit" value="'+k.getLang("compose.add_link_form_add")+'" id="'+m+'"/><input type="button" value="'+k.getLang("compose.add_link_form_cancel")+'" id="'+l+'"/></div>';n+="</form>";var o=b.add(b.get(k.id+"_external"),"div",{id:a.id+"_menu",class:"defaultSkin mceSplitButtonMenu mceLinkMenu"},n);b.setStyles(o,{display:"none",position:"absolute",left:"50%"});c.add(m,"click",this._submit,this);c.add(l,"click",this._cancel,this);c.add(o,"click",c.stop)},isImage:function(a){return/^<img/i.test(a)},_submit:function(a){var d=this,e=b.get(d.formId),f=d.ed;var g=b.encode(e.elements["href"].value);var h=b.encode(e.elements["title"].value);f.selection.moveToBookmark(d.bm);var i=f.selection.getNode();var j=b.getParent(i,"A");if(/^(https?:\/\/|ssh:\/\/|ftp:\/\/|mailto:[A-Z0-9._%+-]+@)(.+)$/i.test(g)){d.hideMenu();if(j){j.href=g;if(!d.isImage(j.innerHTML)){j.innerHTML=h}}else{var k=f.selection.getContent({format:"text"});var l="";var m=f.selection.getNode();var n=m&&m.nodeName==="IMG";if(h.length){l='<a href="'+g+'">'+h+"</a>"}else if(k.length){l='<a href="'+g+'">'+k+"</a>"}else if(n){l='<a href="'+g+'">'+f.selection.getNode().outerHTML+"</a>"}else{l='<a href="'+g+'">'+g+"</a>"}if(n){m.outerHTML=l}else{f.selection.setContent(l)}}f.onChange.dispatch(f);f.focus()}else if(g===""){d.hideMenu();if(j){j.parentNode.removeChild(j);f.selection.setContent(h)}}return c.cancel(a)},_cancel:function(a){this.hideMenu();return c.cancel(a)}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.is,e=a.each;a.create("tinymce.ui.AppsButton:tinymce.ui.SplitButton",{AppsButton:function(b,c){var d=this;d.parent(b,c);var f=d.scope.editor;d.onShowMenu=new a.util.Dispatcher(d);d.onHideMenu=new a.util.Dispatcher(d);d.controls=[];e(c.controls,function(b){var c=new a.ui.Control(f.editorId+"_"+b,{cmd:f.theme.controls[b][1],title:f.getLang("compose."+f.theme.controls[b][0]),class:f.theme.controls[b][1]});d.controls.push(f.controlManager.add(c))});e(c.apps,function(b,c){var e=new a.ui.Control(f.editorId+"_app"+c,{cmd:"mceShowApp",title:b,class:"mceApp"+c,value:c});d.controls.push(f.controlManager.add(e))})},showMenu:function(){var a=this,d,e,f,g;if(a.isDisabled())return;if(!a.isMenuRendered){a.renderMenu();a.isMenuRendered=true}if(a.isMenuVisible)return a.hideMenu();f=b.get(a.id);b.show(a.id+"_menu");b.addClass(f,"mceSplitButtonSelected");f=0;c.add(b.doc,"mousedown",a.hideMenu,a);a.onShowMenu.dispatch(a);if(a._focused){a._keyHandler=c.add(a.id+"_menu","keydown",function(b){if(b.keyCode==27)a.hideMenu()});b.select("a",a.id+"_menu")[0].focus()}a.isMenuVisible=1},hideMenu:function(a){var d=this;if(a&&a.type=="mousedown"&&b.getParent(a.target,function(a){return a.id===d.id+"_action"}))return;if(!a||!b.getParent(a.target,".mceSplitButtonMenu")){b.removeClass(d.id,"mceSplitButtonSelected");c.remove(b.doc,"mousedown",d.hideMenu,d);c.remove(d.id+"_menu","keydown",d._keyHandler);b.hide(d.id+"_menu")}d.onHideMenu.dispatch(d);d.isMenuVisible=0},renderMenu:function(){var a=this,d,f=0,g=a.settings,h,i,j,k,l=a.scope.editor;k=b.add(b.get(a.id+"_action").parentNode,"div",{id:a.id+"_menu",class:g["menu_class"]+" "+g["class"],style:"position:absolute;"});d=b.add(k,"div",{class:g["class"]+" mceSplitButtonMenu"});d=b.add(d,"div",{class:g["class"]+" mceControlsButtonMenu"});e(a.controls,function(e){var f=b.add(d,"div",{class:"mceSplitButtonItem "+e.settings["class"]});var g=b.add(f,"a",{id:e.id,href:"javascript:;",onclick:"return false;",onmousedown:"return false;"},e.settings.title);c.add(g,"mouseover",function(a){return function(){b.addClass(a,"mceSplitButtonItemOver")}}(f));c.add(g,"mouseout",function(a){return function(){b.removeClass(a,"mceSplitButtonItemOver")}}(f));c.add(g,"click",function(b){return function(d){var e=b.settings;l.execCommand(e.cmd,e.ui||false,e.value);a.hideMenu();return c.cancel(d)}}(e))});return k},postRender:function(){var a=this,b=a.id;a.parent()},destroy:function(){this.parent();c.clear(this.id+"_menu");c.clear(this.id+"_more");b.remove(this.id+"_menu")}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.is,e=a.each;a.create("tinymce.ui.ControlsButton:tinymce.ui.SplitButton",{ControlsButton:function(c,d){var f=this;f.parent(c,d);var g=f.scope.editor;f.onShowMenu=new a.util.Dispatcher(f);f.onHideMenu=new a.util.Dispatcher(f);d.expandControls=d.expandControls||[];f.controlsData={};e(d.controls,function(b){var c=new a.ui.Control(g.editorId+"_"+b,{cmd:g.theme.controls[b][1],title:g.getLang("compose."+g.theme.controls[b][0])});g.controlManager.add(c)});g.onInit.add(function(){f.parentTd=b.getParent(f.id+"_action","td");f.toolbar=b.getParent(f.id+"_action",".mceToolbar");f.nextToolbar=b.getNext(f.toolbar,".mceToolbar");f.parentTd.style.display="";e(d.expandControls,function(a){var c=g.editorId+"_"+a;var d=b.getParent(c,"td");var e;var h=b.getPrev(d,"td");if(h){var i=b.select(".mceSeparator",h);if(i[0]){e=i[0];e.style.display=""}}d.style.display="";f.controlsData[c]={parent:d,separator:e}});e(d.expandControls,function(a){var b=g.editorId+"_"+a;var c=f.controlsData[b];c["width"]=c.parent.offsetWidth;if(c.separator){c["width"]+=c.separator.offsetWidth}});f.resize()});a.$(window).resize(function(){f.resize();if(a.isIE&&parseInt(a.$.browser.version)<8){setTimeout(function(){f.resize()},0)}})},showMenu:function(){var a=this,d,e,f,g;if(a.isDisabled())return;if(!a.isMenuRendered){a.renderMenu();a.isMenuRendered=true}if(a.isMenuVisible)return a.hideMenu();f=b.get(a.id);b.show(a.id+"_menu");b.addClass(f,"mceSplitButtonSelected");f=0;c.add(b.doc,"mousedown",a.hideMenu,a);a.onShowMenu.dispatch(a);if(a._focused){a._keyHandler=c.add(a.id+"_menu","keydown",function(b){if(b.keyCode==27)a.hideMenu()});b.select("a",a.id+"_menu")[0].focus()}a.isMenuVisible=1},hideMenu:function(a){var d=this;if(a&&a.type=="mousedown"&&b.getParent(a.target,function(a){return a.id===d.id+"_action"}))return;if(!a||!b.getParent(a.target,".mceSplitButtonMenu")){b.removeClass(d.id,"mceSplitButtonSelected");c.remove(b.doc,"mousedown",d.hideMenu,d);c.remove(d.id+"_menu","keydown",d._keyHandler);b.hide(d.id+"_menu")}d.onHideMenu.dispatch(d);d.isMenuVisible=0},renderMenu:function(){var a=this,d,f=0,g=a.settings,h,i,j,k,l=a.scope.editor;k=b.add(b.get(a.id+"_action").parentNode,"div",{id:a.id+"_menu",class:g["menu_class"]+" "+g["class"],style:"position:absolute;"});d=b.add(k,"div",{class:g["class"]+" mceSplitButtonMenu"});d=b.add(d,"div",{class:g["class"]+" mceControlsButtonMenu"});e(g.controls.concat(g.expandControls),function(e){var f=l.controlManager.get(l.editorId+"_"+e);var g=b.add(d,"div",{class:"mceSplitButtonItem "+f.settings.cmd,id:f.id+"_2"});var h=b.add(g,"a",{id:f.id,class:"mceSplitButtonItemLink",href:"javascript:;",onclick:"return false;",onmousedown:"return false;"},"");b.add(h,"span",{class:"mceIcon mce_"+e},"");b.add(h,"span",{class:"mceSplitButtonItemLinkTitle"},f.settings.title);c.add(h,"click",function(b){return function(d){var e=b.settings;l.execCommand(e.cmd,e.ui||false,e.value);a.hideMenu();return c.cancel(d)}}(f))});a.resize();return k},resize:function(){var a=this,c=a.settings,d=a.scope.editor;if(!(a.parentTd&&a.toolbar&&a.nextToolbar)){return}a.hideMenu();var f=false;e(c.expandControls,function(c){var e=d.editorId+"_"+c;var f=b.get(e+"_2");var g=a.controlsData[e];b.hide(g.parent);b.hide(g.separator);b.show(f)});e(c.expandControls,function(c,e){var g=d.editorId+"_"+c;var h=b.get(g+"_2");var i=a.controlsData[g];if(a.toolbar.offsetWidth+i.width>a.nextToolbar.offsetLeft){f=true}else{i.parent.style.display="";if(i.separator){i.separator.style.display=""}b.hide(h)}})},postRender:function(){var a=this,b=a.id;a.parent()},destroy:function(){this.parent();c.clear(this.id+"_menu");c.clear(this.id+"_more");b.remove(this.id+"_menu")}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.is,e=a.each;a.create("tinymce.ui.EmotionsSplitButton:tinymce.ui.SplitButton",{EmotionsSplitButton:function(b,c){var d=this;d.parent(b,c);d.onShowMenu=new a.util.Dispatcher(d);d.onChangeTab=new a.util.Dispatcher(d);d.onHideMenu=new a.util.Dispatcher(d);var e=d.scope.editor.getLang("compose.smiles");d.smiles=[{title:e[0].title,imgPrefix:"//img.imgsmail.ru/ru/btn/kolobki/",list:e[0].list},{title:e[1].title,isStatic:true,imgPrefix:"//img.imgsmail.ru/ru/btn/",list:e[1].list},{title:e[2].title,imgPrefix:"//img.imgsmail.ru/ru/btn/anim/",list:e[2].list},{title:e[3].title,isStatic:true,imgPrefix:"//img.imgsmail.ru/ru/btn/adv/",list:e[3].list},{title:e[4].title,imgPrefix:"//img.imgsmail.ru/ru/btn/set04/",list:e[4].list},{title:e[5].title,imgPrefix:"//img.imgsmail.ru/ru/btn/set05/",list:e[5].list},{title:e[6].title,imgPrefix:"//img.imgsmail.ru/ru/btn/set06/",list:e[6].list},{title:e[7].title,isStatic:true,imgPrefix:"//img."+patron.staticDomainName+"/mail/ru/images/wysiwyg/hny_icons/",list:e[7].list}]},showMenu:function(){var a=this,d,e,f,g;if(a.isDisabled())return;if(!a.isMenuRendered){a.renderMenu();a.isMenuRendered=true}if(a.isMenuVisible)return a.hideMenu();f=b.get(a.id);b.show(a.id+"_menu");b.addClass(f,"mceSplitButtonSelected");f=0;c.add(b.doc,"mousedown",a.hideMenu,a);a.onShowMenu.dispatch(a);if(a._focused){a._keyHandler=c.add(a.id+"_menu","keydown",function(b){if(b.keyCode==27)a.hideMenu()});b.select("a",a.id+"_menu")[0].focus()}a.isMenuVisible=1},hideMenu:function(a){var d=this;if(a&&a.type=="mousedown"&&b.getParent(a.target,function(a){return a.id===d.id+"_action"}))return;if(!a||!b.getParent(a.target,".mceSplitButtonMenu")){b.removeClass(d.id,"mceSplitButtonSelected");c.remove(b.doc,"mousedown",d.hideMenu,d);c.remove(d.id+"_menu","keydown",d._keyHandler);b.hide(d.id+"_menu")}d.onHideMenu.dispatch(d);d.isMenuVisible=0},renderMenu:function(){var a=this,d,e=a.settings,f,g,h,i=a.scope.editor;var j=null;var k=b.add(b.get(a.id+"_action").parentNode,"div",{id:a.id+"_menu",class:e["menu_class"]+" "+e["class"],style:"position:absolute;"});var l=b.add(k,"div",{class:"mceEmotionsContainers"});var m=b.add(k,"div",{class:"mceEmotionsTabs"});m=b.add(m,"div",{class:"clearfix"});var n=null;for(var o=0,p=a.smiles.length;o<p;o++){var q=a.smiles[o];var r=b.add(l,"div",{class:"mceEmotionsContainer"});if(o==0)n=r;var s=b.add(r,"div",{class:"mceEmotionsFrame"},this.getEmotionsHTML(o));var t=b.add(r,"div",{class:"clearfix"});b.add(t,"div",{class:"mceEmotionsTab mceEmotionsTab"+o,title:q.title});var u=b.add(m,"div",{class:"mceEmotionsTab mceEmotionsTab"+o,title:q.title});if(q.isStatic){j=function(a){return function(b){var c="";if(b.target.nodeName=="A"){var d=b.target.className;if(a.imgPrefix=="//img.imgsmail.ru/ru/btn/adv/")d=d.replace(/^c([0-9]+)/,"$1");c=location.protocol+a.imgPrefix+d+".gif"}if(this.insertImage(c))this.hideMenu()}}(q)}else{j=function(a){var b="";if(a.target.nodeName=="IMG")b=a.target.src;if(this.insertImage(b))this.hideMenu()}}c.add(s,"click",j,this);c.add(u,"click",function(d){return function(e){b.addClass(d,"mceEmotionsContainerActive");b.removeClass(n,"mceEmotionsContainerActive");n=d;this.onChangeTab.dispatch(a);return c.cancel(e)}}(r),this);c.add(u,"mousedown",function(a){return c.cancel(a)})}b.addClass(n,"mceEmotionsContainerActive");c.add(k,"mousedown",function(a){return c.cancel(a)});c.add(a.id+"_menu","click",function(a){return c.cancel(a)});return k},insertImage:function(a){var c=this,d=c.scope.editor;if(a){d.execCommand("mceInsertContent",false,b.createHTML("img",{src:a,alt:"",title:"",border:0}));return true}return false},getEmotionsHTML:function(a){var b="";var c=this.smiles[a];b+='<div class="s'+a+'">';e(c.list,function(a,d){if(c.isStatic){b+='<a title="'+a+'" class="'+d+'" href="javascript:;" onclick="return false;" onmousedown="return false;"></a>'}else{b+='<img title="'+a+'" class="'+d+'" src="'+c.imgPrefix+d+'.gif" alt="" onclick="return false;" onmousedown="return false;"/>'}});b+="</div>";return b},postRender:function(){var a=this,b=a.id;a.parent()},destroy:function(){this.parent();c.clear(this.id+"_menu");c.clear(this.id+"_more");b.remove(this.id+"_menu")}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.is,e=a.each;a.create("tinymce.ui.FontActionButton:tinymce.ui.SplitButton",{FontActionButton:function(c,d){var f=this;f.parent(c,d);f.onShowMenu=new a.util.Dispatcher(f);f.onHideMenu=new a.util.Dispatcher(f);e(d.controls,function(a,c){a.onHideMenu.add(function(){f.hideMenu()});a.onShowMenu.add(function(a){var c=b.get("mce_"+a.settings.id+"_container");var d=b.get("menu_"+a.id);var e=b.get("menu_"+a.id+"_co");b.addClass(d,"mce_"+a.settings.id+"_menu");var f=b.create("div",{class:"mceListBoxMenuTitle"},a.settings.title);e.insertBefore(f,e.firstChild);b.add(c,d);b.addClass(e,"mceListBoxMenu");a.onShowMenu.remove(arguments.callee)})});f.onHideMenu.add(function(){e(d.controls,function(a,b){a.hideMenu()})});f.onShowMenu.add(function(){e(d.controls,function(a,b){a.showMenu(0,0)})})},showMenu:function(){var a=this,d=a.settings,e,f,g,h;if(a.isDisabled())return;if(!a.isMenuRendered){a.renderMenu();a.isMenuRendered=true}if(a.isMenuVisible)return a.hideMenu();g=b.get(a.id);b.show(a.id+"_menu");b.addClass(g,"mceSplitButtonSelected");g=0;c.add(b.doc,"mousedown",a.hideMenu,a);a.onShowMenu.dispatch(a);if(a._focused){a._keyHandler=c.add(a.id+"_menu","keydown",function(b){if(b.keyCode==27)a.hideMenu()});b.select("a",a.id+"_menu")[0].focus()}a.isMenuVisible=1},hideMenu:function(a){var d=this,e=d.settings;if(a&&a.type=="mousedown"&&b.getParent(a.target,function(a){return a.id===d.id+"_action"}))return;if(!a||!b.getParent(a.target,".mceSplitButtonMenu")){b.removeClass(d.id,"mceSplitButtonSelected");c.remove(b.doc,"mousedown",d.hideMenu,d);c.remove(d.id+"_menu","keydown",d._keyHandler);b.hide(d.id+"_menu")}d.onHideMenu.dispatch(d);d.isMenuVisible=0},renderMenu:function(){var a=this,d,e=0,f=a.settings,g,h,i,j;j=b.add(b.get(a.id+"_action").parentNode,"div",{id:a.id+"_menu",class:f["menu_class"]+" "+f["class"]+"_menu mceSplitButtonMenu",style:"position:absolute;"},'<table cellpadding="0" cellspacing="0"><tbody><tr><td id="mce_fontsizeselect_container"></td><td id="mce_fontselect_container"></td></tr></tbody></table>');c.add(j,"mousedown",c.stop);return j},postRender:function(){var a=this,b=a.id;a.parent()},destroy:function(){this.parent();c.clear(this.id+"_menu");c.clear(this.id+"_more");b.remove(this.id+"_menu")}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.is,e=a.each;a.create("tinymce.ui.SignatureButton:tinymce.ui.SplitButton",{SignatureButton:function(b,c){var d=this;d.parent(b,c);var e=d.scope.editor;d.onShowMenu=new a.util.Dispatcher(d);d.onHideMenu=new a.util.Dispatcher(d)},showMenu:function(){var a=this,d,e,f,g,h=a.scope.editor,i=h.settings;if(a.isDisabled())return;if(!a.isMenuRendered){a.renderMenu();a.isMenuRendered=true}if(a.isMenuVisible)return a.hideMenu();f=b.get(a.id);var j=b.get(a.id+"_menu");var k=b.getParent(f,function(a){return b.hasClass(a,"mceExternalToolbar")},i.theme_compose_toolbar_external_id);var l=b.getParent(f,function(a){return b.hasClass(a,"mceToolbar")},k);var m=k.offsetWidth-l.offsetLeft-f.offsetWidth;b.setStyle(j,"marginRight",-m+"px");b.show(j);b.addClass(f,"mceSplitButtonSelected");f=0;c.add(b.doc,"mousedown",a.hideMenu,a);a.onShowMenu.dispatch(a);if(a._focused){a._keyHandler=c.add(a.id+"_menu","keydown",function(b){if(b.keyCode==27)a.hideMenu()});b.select("a",a.id+"_menu")[0].focus()}a.isMenuVisible=1},hideMenu:function(a){var d=this;if(a&&a.type=="mousedown"&&b.getParent(a.target,function(a){return a.id===d.id+"_action"}))return;if(!a||!b.getParent(a.target,".mceSplitButtonMenu")){b.removeClass(d.id,"mceSplitButtonSelected");c.remove(b.doc,"mousedown",d.hideMenu,d);c.remove(d.id+"_menu","keydown",d._keyHandler);b.hide(d.id+"_menu")}d.onHideMenu.dispatch(d);d.isMenuVisible=0},renderMenu:function(){var a=this,d,f=0,g=a.settings,h,i,j,k,l=a.scope.editor;k=b.add(b.get(a.id+"_action").parentNode,"div",{id:a.id+"_menu",class:"mceSignatureMenu",style:"position:absolute;"});d=b.add(k,"div",{class:"mceSplitButtonMenu"});var m=true;e(l.settings.real_names,function(c,e){var f;if(m){m=false}else{b.add(d,"div",{class:"mceSplitButtonMenuSeparator"})}if(c.selected){a.prevSelectedItem=f=b.add(d,"div",{id:"mce_signature_"+c.id,class:"mceSplitButtonItem mceSignatureSplitButtonItemSelected"})}else{f=b.add(d,"div",{id:"mce_signature_"+c.id,class:"mceSplitButtonItem"})}var g=c.signature;if(!/^[^\w0-9а-я]+$/.test(g)){g=g.replace(/^[^~&\w0-9а-я_-]+/i,"")}g=g.replace(/\n/g,"<br/>");var h=b.add(f,"a",{class:"mceSplitButtonItemLink",href:"javascript:;",onclick:"return false;",onmousedown:"return false;"});b.add(h,"span",{class:"mceSignatureSplitButtonItemWrap"},g)});var n,o;if(m){m=false;o=l.translate("compose.signature_addsign")}else{b.add(d,"div",{class:"mceSplitButtonMenuSeparator"});o=l.translate("compose.signature_editsign")}n=b.add(d,"div",{class:"mceSplitButtonItem"});b.add(n,"a",{class:"mceSplitButtonItemLink mceSplitButtonItemLinkAway",target:"_blank",href:"/settings/signature"},o);var p=/^mce_signature_(\d+)/;c.add(d,"click",function(e){var f,g=null;if(b.hasClass(e.target,"mceSplitButtonItem")){f=e.target}else{f=b.getParent(e.target,function(a){return b.hasClass(a,"mceSplitButtonItem")},d)}if(f&&f.id&&p.test(f.id)){g=f.id.match(p)[1]}a.hideMenu();if(g!==null){a.setActiveRealName(g);l.execCommand("mceSetSignature",false,g);return c.cancel(e)}});return k},setActiveRealName:function(a){var c=this;var d=b.get("mce_signature_"+a);if(c.prevSelectedItem){b.removeClass(c.prevSelectedItem,"mceSignatureSplitButtonItemSelected")}if(d){c.prevSelectedItem=d;b.addClass(d,"mceSignatureSplitButtonItemSelected")}else{var f=c.scope.editor;e(f.settings.real_names,function(b,c){b.selected=b.id==a})}},postRender:function(){var a=this,b=a.id;a.parent()},destroy:function(){this.parent();c.clear(this.id+"_menu");c.clear(this.id+"_more");b.remove(this.id+"_menu")}})})(tinymce);(function(a){var b=a.util.Dispatcher,c=a.each;a.create("tinymce.AddOnManager",{AddOnManager:function(){var a=this;a.items=[];a.urls={};a.lookup={};a.onAdd=new b(a)},get:function(a){if(this.lookup[a]){return this.lookup[a].instance}else{return undefined}},dependencies:function(a){var b;if(this.lookup[a]){b=this.lookup[a].dependencies}return b||[]},requireLangPack:function(b){var c=a.settings;if(c&&c.language&&c.language_load!==false)a.ScriptLoader.add(this.urls[b]+"/langs/"+c.language+".js")},add:function(a,b,c){this.items.push(b);this.lookup[a]={instance:b,dependencies:c};this.onAdd.dispatch(this,a,b);return b},createUrl:function(a,b){if(typeof b==="object"){return b}else{return{prefix:a.prefix,resource:b,suffix:a.suffix}}},addComponents:function(b,c){var d=this.urls[b];a.each(c,function(b){a.ScriptLoader.add(d+"/"+b)})},load:function(b,c,d,e){var f=this,g=c;function h(){var g=f.dependencies(b);a.each(g,function(a){var b=f.createUrl(c,a);f.load(b.resource,b,undefined,undefined)});if(d){if(e){d.call(e)}else{d.call(a.ScriptLoader)}}}if(f.urls[b])return;if(typeof c==="object")g=c.prefix+c.resource+c.suffix;if(g.indexOf("/")!==0&&g.indexOf("://")==-1)g=a.baseURL+"/"+g;f.urls[b]=g.substring(0,g.lastIndexOf("/"));if(f.lookup[b]){h()}else{a.ScriptLoader.add(g,h,e)}}});a.PluginManager=new a.AddOnManager;a.ThemeManager=new a.AddOnManager})(tinymce);(function(a){var b=a.each,c=a.extend,d=a.DOM,e=a.dom.Event,f=a.ThemeManager,g=a.PluginManager,h=a.explode,i=a.util.Dispatcher,j,k=0;a.documentBaseURL=window.location.href.replace(/[\?#].*$/,"").replace(/[\/\\][^\/]+$/,"");if(!/[\/\\]$/.test(a.documentBaseURL))a.documentBaseURL+="/";a.baseURL=new a.util.URI(a.documentBaseURL).toAbsolute(a.baseURL);a.baseURI=new a.util.URI(a.baseURL);a.onBeforeUnload=new i(a);e.add(window,"beforeunload",function(b){a.onBeforeUnload.dispatch(a,b)});a.onAddEditor=new i(a);a.onRemoveEditor=new i(a);a.EditorManager=c(a,{editors:[],i18n:{},activeEditor:null,init:function(c){var f=this,g,i=a.ScriptLoader,j,l=[],m;function n(a){var b=a.id;if(!b){b=a.name;if(b&&!d.get(b)){b=a.name}else{b=d.uniqueId()}a.setAttribute("id",b)}return b}function o(b,c,d){var e=b[c];if(!e)return;if(a.is(e,"string")){d=e.replace(/\.\w+$/,"");d=d?a.resolve(d):0;e=a.resolve(e)}return e.apply(d||this,Array.prototype.slice.call(arguments,2))}function p(a,b){return b.constructor===RegExp?b.test(a.className):d.hasClass(a,b)}f.settings=c;e.bind(window,"ready",function(){var e,f;o(c,"onpageload");switch(c.mode){case"exact":e=c.elements||"";if(e.length>0){b(h(e),function(e){if(d.get(e)){m=new a.Editor(e,c);l.push(m);m.render(1)}else{b(document.forms,function(f){b(f.elements,function(b){if(b.name===e){e="mce_editor_"+k++;d.setAttrib(b,"id",e);m=new a.Editor(e,c);l.push(m);m.render(1)}})})}})}break;case"textareas":case"specific_textareas":b(d.select("textarea"),function(b){if(c.editor_deselector&&p(b,c.editor_deselector))return;if(!c.editor_selector||p(b,c.editor_selector)){m=new a.Editor(n(b),c);l.push(m);m.render(1)}});break;default:if(c.types){b(c.types,function(e){b(d.select(e.selector),function(b){var d=new a.Editor(n(b),a.extend({},c,e));l.push(d);d.render(1)})})}else if(c.selector){b(d.select(c.selector),function(b){var d=new a.Editor(n(b),c);l.push(d);d.render(1)})}}if(c.oninit){e=f=0;b(l,function(a){f++;if(!a.initialized){a.onInit.add(function(){e++;if(e==f)o(c,"oninit")})}else e++;if(e==f)o(c,"oninit")})}})},get:function(a){if(a===j)return this.editors;if(!this.editors.hasOwnProperty(a))return j;return this.editors[a]},getInstanceById:function(a){return this.get(a)},add:function(b){var c=this,d=c.editors;d[b.id]=b;d.push(b);c._setActive(b);c.onAddEditor.dispatch(c,b);if(a.adapter)a.adapter.patchEditor(b);return b},remove:function(a){var b=this,c,d=b.editors;if(!d[a.id])return null;delete d[a.id];for(c=0;c<d.length;c++){if(d[c]==a){d.splice(c,1);break}}if(b.activeEditor==a)b._setActive(d[0]);a.destroy();b.onRemoveEditor.dispatch(b,a);return a},execCommand:function(b,c,d){var e=this,f=e.get(d),g;function h(){f.destroy();g.detachEvent("onunload",h);g=g.tinyMCE=g.tinymce=null}switch(b){case"mceFocus":f.focus();return true;case"mceAddEditor":case"mceAddControl":if(!e.get(d))new a.Editor(d,e.settings).render();return true;case"mceAddFrameControl":g=d.window;g.tinyMCE=tinyMCE;g.tinymce=a;a.DOM.doc=g.document;a.DOM.win=g;f=new a.Editor(d.element_id,d);f.render();if(a.isIE&&!a.isIE11){g.attachEvent("onunload",h)}d.page_window=null;return true;case"mceRemoveEditor":case"mceRemoveControl":if(f)f.remove();return true;case"mceToggleEditor":if(!f){e.execCommand("mceAddControl",0,d);return true}if(f.isHidden())f.show();else f.hide();return true}if(e.activeEditor)return e.activeEditor.execCommand(b,c,d);return false},execInstanceCommand:function(a,b,c,d){var e=this.get(a);if(e)return e.execCommand(b,c,d);return false},triggerSave:function(){b(this.editors,function(a){a.save()})},addI18n:function(c,d){var e,i18n=this.i18n;if(!a.is(c,"string")){b(c,function(a,c){b(a,function(a,d){b(a,function(a,b){if(d==="common")i18n[c+"."+b]=a;else i18n[c+"."+d+"."+b]=a})})})}else{b(d,function(a,b){i18n[c+"."+b]=a})}},_setActive:function(a){this.selectedInstance=this.activeEditor=a}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.extend,e=a.each,f=a.isGecko,g=a.isIE,h=a.isWebKit,i=a.is,j=a.ThemeManager,k=a.PluginManager,l=a.explode;a.create("tinymce.Editor",{Editor:function(b,c){var e=this,f=true;e.settings=c=d({id:b,language:"en",theme:"advanced",skin:"default",delta_width:0,delta_height:0,popup_css:"",plugins:"",document_base_url:a.documentBaseURL,add_form_submit_trigger:f,submit_patch:f,add_unload_trigger:f,convert_urls:f,relative_urls:f,remove_script_host:f,table_inline_editing:false,object_resizing:f,accessibility_focus:f,doctype:a.isIE6?'<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">':"<!DOCTYPE>",visual:f,font_size_style_values:"xx-small,x-small,small,medium,large,x-large,xx-large",font_size_legacy_values:"xx-small,small,medium,large,x-large,xx-large,300%",apply_source_formatting:f,directionality:"ltr",forced_root_block:"p",hidden_input:f,padd_empty_editor:f,render_ui:f,indentation:"30px",fix_table_elements:f,inline_styles:f,convert_fonts_to_spans:f,indent:"simple",indent_before:"p,h1,h2,h3,h4,h5,h6,blockquote,div,title,style,pre,script,td,ul,li,area,table,thead,tfoot,tbody,tr,section,article,hgroup,aside,figure,option,optgroup,datalist",indent_after:"p,h1,h2,h3,h4,h5,h6,blockquote,div,title,style,pre,script,td,ul,li,area,table,thead,tfoot,tbody,tr,section,article,hgroup,aside,figure,option,optgroup,datalist",validate:f,entity_encoding:"named",url_converter:e.convertURL,url_converter_scope:e,ie7_compat:f},c);e.id=e.editorId=b;e.isNotDirty=false;e.plugins={};e.documentBaseURI=new a.util.URI(c.document_base_url||a.documentBaseURL,{base_uri:tinyMCE.baseURI});e.baseURI=a.baseURI;e.contentCSS=[];e.contentStyles=[];e.setupEvents();e.execCommands={};e.queryStateCommands={};e.queryValueCommands={};e.execCallback("setup",e)},render:function(d){var f=this,g=f.settings,h=f.id,i=a.ScriptLoader;if(!c.domLoaded){c.add(window,"ready",function(){f.render()});return}tinyMCE.settings=g;if(!f.getElement())return;if(a.isIDevice&&!a.isIOS5)return;if(!/TEXTAREA|INPUT/i.test(f.getElement().nodeName)&&g.hidden_input&&b.getParent(h,"form"))b.insertAfter(b.create("input",{type:"hidden",name:h}),h);if(!g.content_editable){f.orgVisibility=f.getElement().style.visibility;f.getElement().style.visibility="hidden"}if(a.WindowManager)f.windowManager=new a.WindowManager(f);if(g.encoding=="xml"){f.onGetContent.add(function(a,c){if(c.save)c.content=b.encode(c.content)})}if(g.add_form_submit_trigger){f.onSubmit.addToTop(function(){if(f.initialized){f.save();f.isNotDirty=1}})}if(g.add_unload_trigger){f._beforeUnload=tinyMCE.onBeforeUnload.add(function(){if(f.initialized&&!f.destroyed&&!f.isHidden())f.save({format:"raw",no_events:true})})}a.addUnload(f.destroy,f);if(g.submit_patch){f.onBeforeRenderUI.add(function(){var b=f.getElement().form;if(!b)return;if(b._mceOldSubmit)return;if(!b.submit.nodeType&&!b.submit.length){f.formElement=b;b._mceOldSubmit=b.submit;b.submit=function(){a.triggerSave();f.isNotDirty=1;return f.formElement._mceOldSubmit(f.formElement)}}b=null})}function m(){if(g.language&&g.language_load!==false)i.add(a.baseURL+"/langs/"+g.language+".js");if(g.theme&&typeof g.theme!="function"&&g.theme.charAt(0)!="-"&&!j.urls[g.theme])j.load(g.theme,"themes/"+g.theme+"/editor_template"+a.suffix+".js");e(l(g.plugins),function(b){if(b&&!k.urls[b]){if(b.charAt(0)=="-"){b=b.substr(1,b.length);var c=k.dependencies(b);e(c,function(b){var c={prefix:"plugins/",resource:b,suffix:"/editor_plugin"+a.suffix+".js"};b=k.createUrl(c,b);k.load(b.resource,b)})}else{if(b=="safari"){return}k.load(b,{prefix:"plugins/",resource:b,suffix:"/editor_plugin"+a.suffix+".js"})}}});i.loadQueue(function(){if(!f.removed)f.init()})}m()},init:function(){var c,d=this,f=d.settings,h,i,m,n=d.getElement(),o,p,q,r,s,t,u,v=[];if(!n)return;a.add(d);f.aria_label=f.aria_label||b.getAttrib(n,"aria-label",d.getLang("aria.rich_text_area"));if(f.theme){if(typeof f.theme!="function"){f.theme=f.theme.replace(/-/,"");o=j.get(f.theme);d.theme=new o;if(d.theme.init)d.theme.init(d,j.urls[f.theme]||a.documentBaseURL.replace(/\/$/,""))}else{d.theme=f.theme}}function w(b){var c=k.get(b),f=k.urls[b]||a.documentBaseURL.replace(/\/$/,""),g;if(c&&a.inArray(v,b)===-1){e(k.dependencies(b),function(a){w(a)});g=new c(d,f);d.plugins[b]=g;if(g.init){g.init(d,f);v.push(b)}}}e(l(f.plugins.replace(/\-/g,"")),w);if(f.popup_css!==false){if(f.popup_css)f.popup_css=d.documentBaseURI.toAbsolute(f.popup_css);else f.popup_css=d.baseURI.toAbsolute("themes/"+f.theme+"/skins/"+f.skin+"/dialog.css")}if(f.popup_css_add)f.popup_css+=","+d.documentBaseURI.toAbsolute(f.popup_css_add);d.controlManager=new a.ControlManager(d);d.onBeforeRenderUI.dispatch(d,d.controlManager);if(f.render_ui&&d.theme){d.orgDisplay=n.style.display;if(typeof f.theme!="function"){h=f.width||n.style.width||n.offsetWidth;i=f.height||n.style.height||n.offsetHeight;m=f.min_height||100;t=/^[0-9\.]+(|px)$/i;if(t.test(""+h))h=Math.max(parseInt(h,10)+(o.deltaWidth||0),100);if(t.test(""+i))i=Math.max(parseInt(i,10)+(o.deltaHeight||0),m);o=d.theme.renderUI({targetNode:n,width:h,height:i,deltaWidth:f.delta_width,deltaHeight:f.delta_height});b.setStyles(o.sizeContainer||o.editorContainer,{width:h,height:i});i=(o.iframeHeight||i)+(typeof i=="number"?o.deltaHeight||0:"");if(i<m)i=m}else{o=f.theme(d,n);if(o.editorContainer.nodeType){o.editorContainer=o.editorContainer.id=o.editorContainer.id||d.id+"_parent"}if(o.iframeContainer.nodeType){o.iframeContainer=o.iframeContainer.id=o.iframeContainer.id||d.id+"_iframecontainer"}i=o.iframeHeight||n.offsetHeight;if(a.isIE11){d.onInit.add(function(a){a.dom.bind(a.getBody(),"beforedeactivate keydown keyup",function(){if(document.activeElement.id==a.id+"_ifr"){a.windowManager.bookmark=a.selection.getBookmark(1)}})});d.onNodeChange.add(function(a){if(document.activeElement.id==a.id+"_ifr"){a.windowManager.bookmark=a.selection.getBookmark(1)}})}}d.editorContainer=o.editorContainer}if(f.content_css){e(l(f.content_css),function(a){d.contentCSS.push(d.documentBaseURI.toAbsolute(a))})}if(f.content_style){d.contentStyles.push(f.content_style)}if(f.content_editable){n=c=o=null;return d.initContentBody()}if(document.domain&&location.hostname!=document.domain)a.relaxedDomain=document.domain;d.iframeHTML=f.doctype+'<html><head xmlns="http://www.w3.org/1999/xhtml">';if(f.document_base_url!=a.documentBaseURL)d.iframeHTML+='<base href="'+d.documentBaseURI.getURI()+'" />';if(a.isIE8){if(f.ie7_compat)d.iframeHTML+='<meta http-equiv="X-UA-Compatible" content="IE=7" />';else d.iframeHTML+='<meta http-equiv="X-UA-Compatible" content="IE=edge" />'}d.iframeHTML+='<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />';d.iframeHTML+='<meta name="SKYPE_TOOLBAR" content="SKYPE_TOOLBAR_PARSER_COMPATIBLE" />';d.iframeHTML+='<meta name="google" content="notranslate" />';d.iframeHTML+='<style type="text/css"> \t\t\t\tbody {font-size:12px; font-family: arial, helvetica, sans-serif; font-weight: normal; margin: 0; padding: 8px; background-color: #fff;} \t\t\t\tbody.compose2 {   \t\t\t\t\tpadding: 8 15px; \t\t\t\t}</style>';if(f.media_queries_sizes){d.iframeHTML+='<style type="text/css">body {font-size: 13px;} @media screen and (min-width: '+f.media_queries_sizes.width+"px) and (min-height: "+f.media_queries_sizes.height+"px) {body {font-size: 15px;} }</style>"}if(f.use_castom_font){d.iframeHTML+='<style type="text/css">body {font-family:"San Francisco", Arial, sans-serif;}</style>'}for(u=0;u<d.contentCSS.length;u++){d.iframeHTML+='<link type="text/css" rel="stylesheet" href="'+d.contentCSS[u]+'" />'}d.contentCSS=[];r=f.body_id||"tinymce";if(r.indexOf("=")!=-1){r=d.getParam("body_id","","hash");r=r[d.id]||r}s=f.body_class||"";if(s.indexOf("=")!=-1){s=d.getParam("body_class","","hash");s=s[d.id]||""}d.iframeHTML+='</head><body id="'+r+'" class="mceContentBody '+s+'" onload="window.parent.tinyMCE.get(\''+d.id+"').onLoad.dispatch();\"><br></body></html>";if(a.relaxedDomain&&(g||a.isOpera&&parseFloat(opera.version())<11)){q='javascript:(function(){document.open();document.domain="'+document.domain+'";var ed = window.parent.tinyMCE.get("'+d.id+'");document.write(ed.iframeHTML);document.close();ed.initContentBody();})()'}if(a.relaxedDomain&&a.isSafari){q='javascript:(function(){document.open();document.domain="'+document.domain+'";window.tinyMCE = window.parent.tinyMCE;document.write(\'<style>body {margin: 0;}</style><iframe id="inner" frameborder="0" style="width: 100%; height: 100%; display: block;"></iframe>\');document.close();})()'}c=b.add(o.iframeContainer,"iframe",{id:d.id+"_ifr",src:q||'javascript:""',frameBorder:"0",allowTransparency:"true",name:d.id+"_ifr_name",title:f.aria_label,style:{width:"100%",height:i,display:"block"}});d.contentAreaContainer=o.iframeContainer;if(o.editorContainer){b.get(o.editorContainer).style.display=d.orgDisplay}n.style.visibility=d.orgVisibility;b.get(d.id).style.display="none";b.setAttrib(d.id,"aria-hidden",true);if(!a.relaxedDomain||!q)d.initContentBody();n=c=o=null},initContentBody:function(){var c=this,d=c.settings,f=b.get(c.id),h=c.getDoc(),i,j,k;if((!g||!a.relaxedDomain)&&!d.content_editable){if(a.isSafari){var l=c.getWin();l.tinyMCE=l.parent.tinyMCE;h.open();h.write('<style>body {margin: 0;}</style><iframe id="inner" frameborder="0" style="width: 100%; height: 100%; display: block;"></iframe>');h.close();c.contentWindow=c.contentDocument=null;h=c.getDoc()}h.open();h.write(c.iframeHTML);h.close();if(a.relaxedDomain)h.domain=a.relaxedDomain}if(d.content_editable){b.addClass(f,"mceContentBody");c.contentDocument=h=d.content_document||document;c.contentWindow=d.content_window||window;c.bodyElement=f;d.content_document=d.content_window=null}j=c.getBody();j.disabled=true;if(!d.readonly)j.contentEditable=c.getParam("content_editable_state",true);j.disabled=false;c.schema=new a.html.Schema(d);c.dom=new a.dom.DOMUtils(h,{keep_values:true,url_converter:c.convertURL,url_converter_scope:c,hex_colors:d.force_hex_style_colors,class_filter:d.class_filter,update_styles:true,root_element:d.content_editable?c.id:null,schema:c.schema});c.parser=new a.html.DomParser(d,c.schema);c.parser.addAttributeFilter("src,href,style",function(a,b){var d=a.length,e,f=c.dom,g,h;while(d--){e=a[d];g=e.attr(b);h="data-mce-"+b;if(!e.attributes.map[h]){if(b==="style")e.attr(h,f.serializeStyle(f.parseStyle(g),e.name));else e.attr(h,c.convertURL(g,b,e.name))}}});c.parser.addNodeFilter("script",function(a,b){var c=a.length,d;while(c--){d=a[c];d.attr("type","mce-"+(d.attr("type")||"text/javascript"))}});c.parser.addNodeFilter("#cdata",function(a,b){var c=a.length,d;while(c--){d=a[c];d.type=8;d.name="#comment";d.value="[CDATA["+d.value+"]]"}});c.parser.addNodeFilter("p,h1,h2,h3,h4,h5,h6,div",function(b,d){var e=b.length,f,g=c.schema.getNonEmptyElements();while(e--){f=b[e];if(f.isEmpty(g))f.empty().append(new a.html.Node("br",1)).shortEnded=true}});c.serializer=new a.dom.Serializer(d,c.dom,c.schema);c.selection=new a.dom.Selection(c.dom,c.getWin(),c.serializer,c);c.formatter=new a.Formatter(c);c.undoManager=new a.UndoManager(c);c.forceBlocks=new a.ForceBlocks(c);c.enterKey=new a.EnterKey(c);c.editorCommands=new a.EditorCommands(c);c.onExecCommand.add(function(a,b){if(!/^(FontName|FontSize)$/.test(b))c.nodeChanged()});c.serializer.onPreProcess.add(function(a,b){return c.onPreProcess.dispatch(c,b,a)});c.serializer.onPostProcess.add(function(a,b){return c.onPostProcess.dispatch(c,b,a)});c.onPreInit.dispatch(c);if(!d.browser_spellcheck&&!d.gecko_spellcheck)h.body.spellcheck=false;if(!d.readonly){c.bindNativeEvents()}c.controlManager.onPostRender.dispatch(c,c.controlManager);c.onPostRender.dispatch(c);c.quirks=a.util.Quirks(c);if(d.directionality)j.dir=d.directionality;if(d.nowrap)j.style.whiteSpace="nowrap";if(d.protect){c.onBeforeSetContent.add(function(a,b){e(d.protect,function(a){b.content=b.content.replace(a,function(a){return"\x3c!--mce:protected "+escape(a)+"--\x3e"})})})}c.onSetContent.add(function(){c.addVisual(c.getBody())});if(d.padd_empty_editor){c.onPostProcess.add(function(a,b){b.content=b.content.replace(/^(<p[^>]*>(&nbsp;|&#160;|\s|\u00a0|)<\/p>[\r\n]*|<br \/>[\r\n]*)$/,"")})}c.load({initial:true,format:"html"});c.startContent=c.getContent({format:"raw"});c.initialized=true;c.onInit.dispatch(c);c.execCallback("setupcontent_callback",c.id,j,h);c.execCallback("init_instance_callback",c);c.focus(true);c.nodeChanged({initial:true});if(c.contentStyles.length>0){k="";e(c.contentStyles,function(a){k+=a+"\r\n"});c.dom.addStyle(k)}e(c.contentCSS,function(a){c.dom.loadCSS(a)});if(d.auto_focus){setTimeout(function(){var b=a.get(d.auto_focus);b.selection.select(b.getBody(),1);b.selection.collapse(1);b.getBody().focus();b.getWin().focus()},100)}f=h=j=null},focus:function(b){var c,d=this,e=d.selection,f=d.settings.content_editable,g,h,i=d.getDoc(),j;if(!b){if(d.lastIERng){e.setRng(d.lastIERng)}g=e.getRng();if(g.item){h=g.item(0)}d._refreshContentEditable();if(!f){d.getWin().focus()}if(a.isGecko||f){j=d.getBody();if(j.setActive&&!a.isIE11){j.setActive()}else{j.focus()}if(f){e.normalize()}}if(h&&h.ownerDocument==i){g=i.body.createControlRange();g.addElement(h);g.select()}}if(a.activeEditor!=d){if((c=a.activeEditor)!=null)c.onDeactivate.dispatch(c,d);d.onActivate.dispatch(d,c)}d.onFocus.dispatch(d,{skip_focus:b});a._setActive(d)},execCallback:function(b){var c=this,d=c.settings[b],e;if(!d)return;if(c.callbackLookup&&(e=c.callbackLookup[b])){d=e.func;e=e.scope}if(i(d,"string")){e=d.replace(/\.\w+$/,"");e=e?a.resolve(e):0;d=a.resolve(d);c.callbackLookup=c.callbackLookup||{};c.callbackLookup[b]={func:d,scope:e}}return d.apply(e||c,Array.prototype.slice.call(arguments,1))},translate:function(b){var c=this.settings.language||"en",i18n=a.i18n;if(!b)return"";return i18n[c+"."+b]||b.replace(/\{\#([^\}]+)\}/g,function(a,b){return i18n[c+"."+b]||"{#"+b+"}"})},getLang:function(b,c){return a.i18n[(this.settings.language||"en")+"."+b]||(i(c)?c:"{#"+b+"}")},getParam:function(b,c,d){var f=a.trim,g=i(this.settings[b])?this.settings[b]:c,h;if(d==="hash"){h={};if(i(g,"string")){e(g.indexOf("=")>0?g.split(/[;,](?![^=;,]*(?:[;,]|$))/):g.split(","),function(a){a=a.split("=");if(a.length>1)h[f(a[0])]=f(a[1]);else h[f(a[0])]=f(a)})}else h=g;return h}return g},nodeChanged:function(a){var b=this,c=b.selection,d;if(b.initialized){a=a||{};d=c.getStart()||b.getBody();d=g&&d.ownerDocument!=b.getDoc()?b.getBody():d;a.parents=[];b.dom.getParent(d,function(b){if(b.nodeName=="BODY")return true;a.parents.push(b)});b.onNodeChange.dispatch(b,a?a.controlManager||b.controlManager:b.controlManager,d,c.isCollapsed(),a)}},addButton:function(a,b){var c=this;c.buttons=c.buttons||{};c.buttons[a]=b},addCommand:function(a,b,c){this.execCommands[a]={func:b,scope:c||this}},addQueryStateHandler:function(a,b,c){this.queryStateCommands[a]={func:b,scope:c||this}},addQueryValueHandler:function(a,b,c){this.queryValueCommands[a]={func:b,scope:c||this}},addShortcut:function(a,b,c,d){var f=this,g;if(f.settings.custom_shortcuts===false)return false;f.shortcuts=f.shortcuts||{};if(i(c,"string")){g=c;c=function(){f.execCommand(g,false,null)}}if(i(c,"object")){g=c;c=function(){f.execCommand(g[0],g[1],g[2])}}e(l(a),function(a){var g={func:c,scope:d||this,desc:f.translate(b),alt:false,ctrl:false,shift:false};e(l(a,"+"),function(a){switch(a){case"alt":case"ctrl":case"shift":g[a]=true;break;default:g.charCode=a.charCodeAt(0);g.keyCode=a.toUpperCase().charCodeAt(0)}});f.shortcuts[(g.ctrl?"ctrl":"")+","+(g.alt?"alt":"")+","+(g.shift?"shift":"")+","+g.keyCode]=g});return true},execCommand:function(a,b,c,f){var g=this,h=0,i,j;if(!/^(mceAddUndoLevel|mceEndUndoLevel|mceBeginUndoLevel|mceRepaint|SelectAll)$/.test(a)&&(!f||!f.skip_focus))g.focus();f=d({},f);g.onBeforeExecCommand.dispatch(g,a,b,c,f);if(f.terminate)return false;if(g.execCallback("execcommand_callback",g.id,g.selection.getNode(),a,b,c)){g.onExecCommand.dispatch(g,a,b,c,f);return true}if(i=g.execCommands[a]){j=i.func.call(i.scope,b,c);if(j!==true){g.onExecCommand.dispatch(g,a,b,c,f);return j}}e(g.plugins,function(d){if(d.execCommand&&d.execCommand(a,b,c)){g.onExecCommand.dispatch(g,a,b,c,f);h=1;return false}});if(h)return true;if(g.theme&&g.theme.execCommand&&g.theme.execCommand(a,b,c)){g.onExecCommand.dispatch(g,a,b,c,f);return true}if(g.editorCommands.execCommand(a,b,c)){g.onExecCommand.dispatch(g,a,b,c,f);return true}g.getDoc().execCommand(a,b,c);g.onExecCommand.dispatch(g,a,b,c,f)},queryCommandState:function(a){var b=this,c,d;if(b._isHidden())return;if(c=b.queryStateCommands[a]){d=c.func.call(c.scope);if(d!==true)return d}c=b.editorCommands.queryCommandState(a);if(c!==-1)return c;try{return this.getDoc().queryCommandState(a)}catch(a){}},queryCommandValue:function(a){var b=this,c,d;if(b._isHidden())return;if(c=b.queryValueCommands[a]){d=c.func.call(c.scope);if(d!==true)return d}c=b.editorCommands.queryCommandValue(a);if(i(c))return c;try{return this.getDoc().queryCommandValue(a)}catch(a){}},show:function(){var a=this;b.show(a.getContainer());b.hide(a.id);a.load()},hide:function(){var a=this,c=a.getDoc();if(g&&c)c.execCommand("SelectAll");a.save();b.hide(a.getContainer());b.setStyle(a.id,"display",a.orgDisplay)},isHidden:function(){return!b.isHidden(this.id)},setProgressState:function(a,b,c){this.onSetProgressState.dispatch(this,a,b,c);return a},load:function(a){var b=this,c=b.getElement(),d;if(c){a=a||{};a.load=true;a.element=c;if(!a.no_events)b.onLoadContent.dispatch(b,a);a.element=c=null;return d}},save:function(a){var c=this,d=c.getElement(),f,g;if(!d||!c.initialized)return;a=a||{};a.save=true;a.element=d;f=a.content=c.getContent(a);if(!a.no_events)c.onSaveContent.dispatch(c,a);f=a.content;if(!/TEXTAREA|INPUT/i.test(d.nodeName)){d.innerHTML=f;if(g=b.getParent(c.id,"form")){e(g.elements,function(a){if(a.name==c.id){a.value=f;return false}})}}else d.value=f;a.element=d=null;return f},setContent:function(b,c){var d=this,e,f=d.getBody(),g;c=c||{};c.format=c.format||"html";c.set=true;c.content=b;if(!c.no_events)d.onBeforeSetContent.dispatch(d,c);b=c.content;if(!a.isIE&&(b.length===0||/^\s+$/.test(b))){g=d.settings.forced_root_block;if(g)b="<"+g+'><br data-mce-bogus="1"></'+g+">";else b='<br data-mce-bogus="1">'}if(c.format!=="raw"){b=new a.html.Serializer({},d.schema).serialize(d.parser.parse(b))}c.content=a.trim(b);d.dom.setHTML(f,c.content);var h=d.selection.getSel();if(h&&h.removeAllRanges){h.removeAllRanges();d.selection.setCursorLocation(f,0)}if(!c.no_events)d.onSetContent.dispatch(d,c);if(!d.settings.content_editable||document.activeElement===d.getBody()){d.selection.normalize()}return c.content},getContent:function(b){var c=this,d,e=c.getBody();b=b||{};b.format=b.format||"html";b.get=true;b.getInner=true;if(!b.no_events)c.onBeforeGetContent.dispatch(c,b);if(b.format=="raw")d=e.innerHTML;else if(b.format=="text")d=e.innerText||e.textContent;else d=c.serializer.serialize(e,b);if(b.format!="text"){if(d!==this._prevContent){this._prevContent=d;this._trimmedContent=a.trim(d)}b.content=this._trimmedContent}else{b.content=d}if(!b.no_events)c.onGetContent.dispatch(c,b);return b.content},isDirty:function(){var b=this;return a.trim(b.startContent)!=a.trim(b.getContent({format:"raw",no_events:1}))&&!b.isNotDirty},getContainer:function(){var a=this;if(!a.container)a.container=b.get(a.editorContainer||a.id+"_parent");return a.container},getContentAreaContainer:function(){return this.contentAreaContainer},getElement:function(){return b.get(this.settings.content_element||this.id)},getWin:function(){var a=this,c;if(!a.contentWindow){c=b.get(a.id+"_ifr");if(c&&c.contentDocument){c=c.contentDocument.getElementById("inner")||c}if(c)a.contentWindow=c.contentWindow}return a.contentWindow},getDoc:function(){var a=this,b;if(!a.contentDocument){b=a.getWin();if(b)a.contentDocument=b.document}return a.contentDocument},getBody:function(){return this.bodyElement||this.getDoc().body},convertURL:function(a,b,c){var d=this,e=d.settings;if(e.urlconverter_callback)return d.execCallback("urlconverter_callback",a,c,true,b);if(!e.convert_urls||c&&c.nodeName=="LINK"||a.indexOf("file:")===0)return a;if(e.relative_urls)return d.documentBaseURI.toRelative(a);a=d.documentBaseURI.toAbsolute(a,e.remove_script_host);return a},addVisual:function(a){var b=this,c=b.settings,d=b.dom,f;a=a||b.getBody();if(!i(b.hasVisual))b.hasVisual=c.visual;e(d.select("table,a",a),function(a){var e;switch(a.nodeName){case"TABLE":f=c.visual_table_class||"mceItemTable";e=d.getAttrib(a,"border");if(!e||e=="0"){if(b.hasVisual)d.addClass(a,f);else d.removeClass(a,f)}return;case"A":if(!d.getAttrib(a,"href",false)){e=d.getAttrib(a,"name")||a.id;f="mceItemAnchor";if(e){if(b.hasVisual)d.addClass(a,f);else d.removeClass(a,f)}}return}});b.onVisualAid.dispatch(b,a,b.hasVisual)},remove:function(){var d=this,e=d.getContainer(),f=d.getDoc();if(!d.removed){d.removed=1;if(g&&f)f.execCommand("SelectAll");d.save();b.setStyle(d.id,"display",d.orgDisplay);if(!d.settings.content_editable){c.unbind(d.getWin());c.unbind(d.getDoc())}c.unbind(d.getBody());c.clear(e);d.execCallback("remove_instance_callback",d);d.onRemove.dispatch(d);d.onExecCommand.listeners=[];a.remove(d);b.remove(e)}},destroy:function(b){var d=this;if(d.destroyed)return;if(f){c.unbind(d.getDoc());c.unbind(d.getWin());c.unbind(d.getBody())}if(!b){a.removeUnload(d.destroy);tinyMCE.onBeforeUnload.remove(d._beforeUnload);if(d.theme&&d.theme.destroy)d.theme.destroy();d.controlManager.destroy();d.selection.destroy();d.dom.destroy()}if(d.formElement){d.formElement.submit=d.formElement._mceOldSubmit;d.formElement._mceOldSubmit=null}d.contentAreaContainer=d.formElement=d.container=d.settings.content_element=d.bodyElement=d.contentDocument=d.contentWindow=null;if(d.selection)d.selection=d.selection.win=d.selection.dom=d.selection.dom.doc=null;d.destroyed=1},_refreshContentEditable:function(){var a=this,b,c;if(a._isHidden()){b=a.getBody();c=b.parentNode;c.removeChild(b);c.appendChild(b);b.focus()}},_isHidden:function(){var a;if(!f)return 0;a=this.selection.getSel();return!a||!a.rangeCount||a.rangeCount===0}})})(tinymce);(function(a){var b=a.each;a.Editor.prototype.setupEvents=function(){var c=this,d=c.settings;b(["onPreInit","onBeforeRenderUI","onPostRender","onLoad","onInit","onRemove","onActivate","onFocus","onDeactivate","onClick","onEvent","onMouseUp","onMouseDown","onDblClick","onKeyDown","onKeyUp","onKeyPress","onContextMenu","onSubmit","onReset","onPaste","onPreProcess","onPostProcess","onBeforeSetContent","onBeforeGetContent","onSetContent","onGetContent","onLoadContent","onSaveContent","onNodeChange","onChange","onBeforeExecCommand","onExecCommand","onUndo","onRedo","onVisualAid","onSetProgressState","onSetAttrib","onFocusOut"],function(b){c[b]=new a.util.Dispatcher(c)});if(d.cleanup_callback){c.onBeforeSetContent.add(function(a,b){b.content=a.execCallback("cleanup_callback","insert_to_editor",b.content,b)});c.onPreProcess.add(function(a,b){if(b.set)a.execCallback("cleanup_callback","insert_to_editor_dom",b.node,b);if(b.get)a.execCallback("cleanup_callback","get_from_editor_dom",b.node,b)});c.onPostProcess.add(function(a,b){if(b.set)b.content=a.execCallback("cleanup_callback","insert_to_editor",b.content,b);if(b.get)b.content=a.execCallback("cleanup_callback","get_from_editor",b.content,b)})}if(d.save_callback){c.onGetContent.add(function(a,b){if(b.save)b.content=a.execCallback("save_callback",a.id,b.content,a.getBody())})}if(d.handle_event_callback){c.onEvent.add(function(a,b,d){if(c.execCallback("handle_event_callback",b,a,d)===false){b.preventDefault();b.stopPropagation()}})}if(d.handle_node_change_callback){c.onNodeChange.add(function(a,b,c){a.execCallback("handle_node_change_callback",a.id,c,-1,-1,true,a.selection.isCollapsed())})}if(d.save_callback){c.onSaveContent.add(function(a,b){var c=a.execCallback("save_callback",a.id,b.content,a.getBody());if(c)b.content=c})}if(d.onchange_callback){c.onChange.add(function(a,b){a.execCallback("onchange_callback",a,b)})}};a.Editor.prototype.bindNativeEvents=function(){var c=this,d,e=c.settings,f=c.dom,g;g={mouseup:"onMouseUp",mousedown:"onMouseDown",focusout:"onFocusOut",click:"onClick",keyup:"onKeyUp",keydown:"onKeyDown",keypress:"onKeyPress",reset:"onReset",contextmenu:"onContextMenu",dblclick:"onDblClick",paste:"onPaste"};function h(a,b){var d=a.type;if(c.removed)return;if(c.onEvent.dispatch(c,a,b)!==false){c[g[a.fakeType||a.type]].dispatch(c,a,b)}}function i(a){c.focus(true)}function j(b,d){if(d.keyCode!=65||!a.VK.metaKeyPressed(d)){c.selection.normalize()}c.nodeChanged()}b(g,function(b,d){var g=e.content_editable?c.getBody():c.getDoc();switch(d){case"contextmenu":f.bind(g,d,h);break;case"paste":f.bind(c.getBody(),d,h);break;case"submit":case"reset":f.bind(c.getElement().form||a.DOM.getParent(c.id,"form"),d,h);break;default:f.bind(g,d,h)}});f.bind(e.content_editable?c.getBody():a.isGecko?c.getDoc():c.getWin(),"focus",function(a){c.focus(true)});if(e.content_editable&&a.isOpera){f.bind(c.getBody(),"click",i);f.bind(c.getBody(),"keydown",i)}c.onMouseUp.add(j);c.onKeyUp.add(function(b,c){var d=c.keyCode;if(d>=33&&d<=36||d>=37&&d<=40||d==13||d==45||d==46||d==8||a.isMac&&(d==91||d==93)||c.ctrlKey)j(b,c)});c.onReset.add(function(){c.setContent(c.startContent,{format:"raw"})});function k(d,e){if(d.altKey||d.ctrlKey||d.metaKey){b(c.shortcuts,function(b){var c=a.isMac?d.metaKey:d.ctrlKey;if(b.ctrl!=c||b.alt!=d.altKey||b.shift!=d.shiftKey)return;if(d.keyCode==b.keyCode||d.charCode&&d.charCode==b.charCode){d.preventDefault();if(e){b.func.call(b.scope)}return true}})}}c.onKeyUp.add(function(a,b){k(b)});c.onKeyPress.add(function(a,b){k(b)});c.onKeyDown.add(function(a,b){k(b,true)});if(a.isOpera){c.onClick.add(function(a,b){b.preventDefault()})}}})(tinymce);(function(a){var b=a.each,c,d=true,e=false;a.EditorCommands=function(f){var g=f.dom,h=f.selection,i={state:{},exec:{},value:{}},j=f.settings,k=f.formatter,l;function m(a,b,c){var f;a=a.toLowerCase();if(f=i.exec[a]){f(a,b,c);return d}return e}function n(a){var b;a=a.toLowerCase();if(b=i.state[a])return b(a);return-1}function o(a){var b;a=a.toLowerCase();if(b=i.value[a])return b(a);return e}function p(a,c){c=c||"exec";b(a,function(a,d){b(d.toLowerCase().split(","),function(b){i[c][b]=a})})}a.extend(this,{execCommand:m,queryCommandState:n,queryCommandValue:o,addCommands:p});function q(a,b,d){if(b===c)b=e;if(d===c)d=null;return f.getDoc().execCommand(a,b,d)}function r(a){return k.match(a)}function s(a,b){k.toggle(a,b?{value:b}:c)}function t(a){l=h.getBookmark(a)}function u(){h.moveToBookmark(l)}p({"mceResetDesignMode,mceBeginUndoLevel":function(){},"mceEndUndoLevel,mceAddUndoLevel":function(){f.undoManager.add()},"Cut,Copy,Paste":function(b){var c=f.getDoc(),e;try{q(b)}catch(a){e=d}if(e||!c.queryCommandSupported(b)){if(a.isGecko){f.windowManager.confirm(f.getLang("clipboard_msg"),function(a){if(a)open("http://www.mozilla.org/editor/midasdemo/securityprefs.html","_blank")})}else f.windowManager.alert(f.getLang("clipboard_no_support"))}},unlink:function(a){if(h.isCollapsed())h.select(h.getNode());q(a);h.collapse(e)},"JustifyLeft,JustifyCenter,JustifyRight,JustifyFull":function(a){var c=a.substring(7);b("left,center,right,full".split(","),function(a){if(c!=a)k.remove("align"+a)});s("align"+c);m("mceRepaint")},"InsertUnorderedList,InsertOrderedList":function(a){var b,c;q(a);b=g.getParent(h.getNode(),"ol,ul");if(b){c=b.parentNode;if(/^(H[1-6]|P|ADDRESS|PRE)$/.test(c.nodeName)){t();g.split(c,b);u()}}},"Bold,Italic,Underline,Strikethrough,Superscript,Subscript":function(a){s(a)},"ForeColor,HiliteColor,FontName":function(a,b,c){s(a,c)},FontSize:function(b,c,d){var e,f;if(d>=1&&d<=7){f=a.explode(j.font_size_style_values);e=a.explode(j.font_size_classes);if(e)d=e[d-1]||d;else d=f[d-1]||d}s(b,d)},RemoveFormat:function(a){k.remove(a)},mceBlockQuote:function(a){s("blockquote")},FormatBlock:function(a,b,c){return s(c||"p")},mceCleanup:function(){var a=h.getBookmark();f.setContent(f.getContent({cleanup:d}),{cleanup:d});h.moveToBookmark(a)},mceRemoveNode:function(a,b,c){var e=c||h.getNode();if(e!=f.getBody()){t();f.dom.remove(e,d);u()}},mceSelectNodeDepth:function(a,b,c){var d=0;g.getParent(h.getNode(),function(a){if(a.nodeType==1&&d++==c){h.select(a);return e}},f.getBody())},mceSelectNode:function(a,b,c){h.select(c)},mceInsertContent:function(b,c,d){var e,i,j,k,l,m,n,o,p,q,r,s,t,u;e=f.parser;i=new a.html.Serializer({},f.schema);t='<span id="mce_marker" data-mce-type="bookmark">\ufeff</span>';m={content:d,format:"html"};h.onBeforeSetContent.dispatch(h,m);d=m.content;if(d.indexOf("{$caret}")==-1)d+="{$caret}";d=d.replace(/\{\$caret\}/,t);if(!h.isCollapsed()&&h.getNode().getAttribute("id")!=="_mcePaste"){f.getDoc().execCommand("Delete",false,null)}j=h.getNode();m={context:j.nodeName.toLowerCase()};l=e.parse(d,m);r=l.lastChild;if(r.attr("id")=="mce_marker"){n=r;for(r=r.prev;r;r=r.walk(true)){if(r.type==3||!g.isBlock(r.name)){r.parent.insert(n,r,r.name==="br");break}}}if(!m.invalid){d=i.serialize(l,true);r=j.firstChild;s=j.lastChild;if(!r||r===s&&r.nodeName==="BR")g.setHTML(j,d);else h.setContent(d)}else{h.setContent(t);j=h.getNode();k=f.getBody();if(j.nodeType==9)j=r=k;else r=j;while(r!==k){j=r;r=r.parentNode}d=j==k?k.innerHTML:g.getOuterHTML(j);d=i.serialize(e.parse(d.replace(/<span (id="mce_marker"|id=mce_marker).+?<\/span>/i,function(){return i.serialize(l)})));if(j==k)g.setHTML(k,d);else g.setOuterHTML(j,d)}n=g.get("mce_marker");if(n){o=g.getRect(n);p=g.getViewPort(f.getWin());if(o.y+o.h>p.y+p.h||o.y<p.y||(o.x>p.x+p.w||o.x<p.x)){u=a.isIE?f.getDoc().documentElement:f.getBody();u.scrollLeft=o.x;u.scrollTop=o.y-p.h+25}q=g.createRng();r=n.previousSibling;if(r&&r.nodeType==3){q.setStart(r,r.nodeValue.length)}else{q.setStartBefore(n);q.setEndBefore(n)}g.remove(n);h.setRng(q)}h.onSetContent.dispatch(h,m);f.addVisual()},mceInsertRawHTML:function(a,b,c){h.setContent("tiny_mce_marker");f.setContent(f.getContent().replace(/tiny_mce_marker/g,function(){return c}))},mceToggleFormat:function(a,b,c){s(c)},mceSetContent:function(a,b,c){f.setContent(c)},"Indent,Outdent":function(a){var c,d,e;c=j.indentation;d=/[a-z%]+$/i.exec(c);c=parseInt(c);if(!n("InsertUnorderedList")&&!n("InsertOrderedList")){if(!j.forced_root_block&&!g.getParent(h.getNode(),g.isBlock)){k.apply("div")}b(h.getSelectedBlocks(),function(b){if(a=="outdent"){e=Math.max(0,parseInt(b.style.paddingLeft||0)-c);g.setStyle(b,"paddingLeft",e?e+d:"")}else g.setStyle(b,"paddingLeft",parseInt(b.style.paddingLeft||0)+c+d)})}else q(a)},mceRepaint:function(){var b;if(a.isGecko){try{t(d);if(h.getSel())h.getSel().selectAllChildren(f.getBody());h.collapse(d);u()}catch(a){}}},mceToggleFormat:function(a,b,c){k.toggle(c)},InsertHorizontalRule:function(){f.execCommand("mceInsertContent",false,"<hr />")},mceToggleVisualAid:function(){f.hasVisual=!f.hasVisual;f.addVisual()},mceReplaceContent:function(a,b,c){f.execCommand("mceInsertContent",false,c.replace(/\{\$selection\}/g,h.getContent({format:"text"})))},mceInsertLink:function(a,b,c){var d;if(typeof c=="string")c={href:c};d=g.getParent(h.getNode(),"a");c.href=c.href.replace(" ","%20");if(!d||!c.href){k.remove("link")}if(c.href){k.apply("link",c,d)}},selectAll:function(){var a=g.getRoot(),b=g.createRng();if(h.getRng().setStart){b.setStart(a,0);b.setEnd(a,a.childNodes.length);h.setRng(b)}else{q("SelectAll")}}});p({"JustifyLeft,JustifyCenter,JustifyRight,JustifyFull":function(b){var c="align"+b.substring(7);var e=h.isCollapsed()?[g.getParent(h.getNode(),g.isBlock)]:h.getSelectedBlocks();var f=a.map(e,function(a){return!!k.matchNode(a,c)});return a.inArray(f,d)!==-1},"Bold,Italic,Underline,Strikethrough,Superscript,Subscript":function(a){return r(a)},mceBlockQuote:function(){return r("blockquote")},Outdent:function(){var a;if(j.inline_styles){if((a=g.getParent(h.getStart(),g.isBlock))&&parseInt(a.style.paddingLeft)>0)return d;if((a=g.getParent(h.getEnd(),g.isBlock))&&parseInt(a.style.paddingLeft)>0)return d}return n("InsertUnorderedList")||n("InsertOrderedList")||!j.inline_styles&&!!g.getParent(h.getNode(),"BLOCKQUOTE")},"InsertUnorderedList,InsertOrderedList":function(a){var b=g.getParent(h.getNode(),"ul,ol");return b&&(a==="insertunorderedlist"&&b.tagName==="UL"||a==="insertorderedlist"&&b.tagName==="OL")}},"state");p({"FontSize,FontName":function(a){var b=0,c;if(c=g.getParent(h.getNode(),"span")){if(a=="fontsize")b=c.style.fontSize;else b=c.style.fontFamily.replace(/, /g,",").replace(/[\'\"]/g,"").toLowerCase()}return b}},"value");p({Undo:function(){f.undoManager.undo()},Redo:function(){f.undoManager.redo()}})}})(tinymce);(function(a){var b=a.util.Dispatcher;a.UndoManager=function(c){var d,e=0,f=[],g,h,i,j,k;function l(){var b=c.dom.select("[data-mce-bogus]").length;var d=c.getContent({format:"raw",no_events:1});var e=(d.match(/data-mce-bogus/gi)||[]).length;if(e===b){d=d.replace(/<span[^>]+data-mce-bogus[^>]+>[\u200B\uFEFF]+<\/span>/g,"")}return a.trim(d)}function m(){d.typing=false;d.add()}h=new b(d);i=new b(d);j=new b(d);k=new b(d);i.add(function(a,b){if(a.hasUndo())return c.onChange.dispatch(c,b,a)});j.add(function(a,b){return c.onUndo.dispatch(c,b,a)});k.add(function(a,b){return c.onRedo.dispatch(c,b,a)});c.onInit.add(function(){d.add()});c.onBeforeExecCommand.add(function(a,b,c,e,f){if(b!="Undo"&&b!="Redo"&&b!="mceRepaint"&&(!f||!f.skip_undo)){d.beforeChange()}});c.onExecCommand.add(function(a,b,c,e,f){if(b!="Undo"&&b!="Redo"&&b!="mceRepaint"&&(!f||!f.skip_undo)){d.add()}});c.onSaveContent.add(m);c.dom.bind(c.dom.getRoot(),"dragend",m);c.dom.bind(c.getBody(),"focusout",function(a){if(!c.removed&&d.typing){m()}});c.onKeyUp.add(function(a,b){var c=b.keyCode;if(c>=33&&c<=36||c>=37&&c<=40||c==45||c==13||b.ctrlKey){m()}});c.onKeyDown.add(function(a,b){var c=b.keyCode;if(c>=33&&c<=36||c>=37&&c<=40||c==45){if(d.typing){m()}return}if((c<16||c>20)&&c!=224&&c!=91&&!d.typing){d.beforeChange();d.typing=true;d.add()}});c.onMouseDown.add(function(a,b){if(d.typing){m()}});c.addShortcut("ctrl+z","undo_desc","Undo");c.addShortcut("ctrl+y","redo_desc","Redo");d={data:f,typing:false,onBeforeAdd:h,onAdd:i,onUndo:j,onRedo:k,beforeChange:function(){g=c.selection.getBookmark(2,true)},add:function(a){var b,h=c.settings,i;a=a||{};a.content=l();d.onBeforeAdd.dispatch(d,a);i=f[e];if(i&&i.content==a.content)return null;if(f[e])f[e].beforeBookmark=g;if(h.custom_undo_redo_levels){if(f.length>h.custom_undo_redo_levels){for(b=0;b<f.length-1;b++)f[b]=f[b+1];f.length--;e=f.length}}a.bookmark=c.selection.getBookmark(2,true);if(e<f.length-1)f.length=e+1;f.push(a);e=f.length-1;d.onAdd.dispatch(d,a);c.isNotDirty=0;return a},undo:function(){var a,b;if(d.typing){d.add();d.typing=false}if(e>0){a=f[--e];c.setContent(a.content,{format:"raw"});c.selection.moveToBookmark(a.beforeBookmark);d.onUndo.dispatch(d,a)}return a},redo:function(){var a;if(e<f.length-1){a=f[++e];c.setContent(a.content,{format:"raw"});c.selection.moveToBookmark(a.bookmark);d.onRedo.dispatch(d,a)}return a},clear:function(){f=[];e=0;d.typing=false},hasUndo:function(){return e>0||this.typing},hasRedo:function(){return e<f.length-1&&!this.typing}};return d}})(tinymce);tinymce.ForceBlocks=function(a){var b=a.settings,c=a.dom,d=a.selection,e=a.schema.getBlockElements();function f(){var f=d.getStart(),g=a.getBody(),h,i,j,k,l,m,n,o=-16777215,p,q;if(!f||f.nodeType!==1||!b.forced_root_block)return;while(f&&f!=g){if(e[f.nodeName])return;f=f.parentNode}h=d.getRng();if(h.setStart){i=h.startContainer;j=h.startOffset;k=h.endContainer;l=h.endOffset}else{if(h.item){f=h.item(0);h=a.getDoc().body.createTextRange();h.moveToElementText(f)}q=h.parentElement().ownerDocument===a.getDoc();tmpRng=h.duplicate();tmpRng.collapse(true);j=tmpRng.move("character",o)*-1;if(!tmpRng.collapsed){tmpRng=h.duplicate();tmpRng.collapse(false);l=tmpRng.move("character",o)*-1-j}}f=g.firstChild;while(f){if(f.nodeType===3||f.nodeType==1&&!e[f.nodeName]){if(f.nodeType===3&&f.nodeValue.length==0){n=f;f=f.nextSibling;c.remove(n);continue}if(!m){m=c.create(b.forced_root_block);f.parentNode.insertBefore(m,f);p=true}n=f;f=f.nextSibling;m.appendChild(n)}else{m=null;f=f.nextSibling}}if(p){if(h.setStart){h.setStart(i,j);h.setEnd(k,l);d.setRng(h)}else{if(q){try{h=a.getDoc().body.createTextRange();h.moveToElementText(g);h.collapse(true);h.moveStart("character",j);if(l>0)h.moveEnd("character",l);h.select()}catch(a){}}}a.nodeChanged()}}if(b.forced_root_block){a.onKeyUp.add(f);a.onNodeChange.add(f)}};(function(a){var b=a.DOM,c=a.dom.Event,d=a.each,e=a.extend;a.create("tinymce.ControlManager",{ControlManager:function(b,c){var e=this,f;c=c||{};e.editor=b;e.controls={};e.onAdd=new a.util.Dispatcher(e);e.onPostRender=new a.util.Dispatcher(e);e.prefix=c.prefix||b.id+"_";e._cls={};e.onPostRender.add(function(){d(e.controls,function(a){a.postRender()})})},get:function(a){return this.controls[this.prefix+a]||this.controls[a]},setActive:function(a,b){var c=null;if(c=this.get(a))c.setActive(b);return c},setDisabled:function(a,b){var c=null;if(c=this.get(a))c.setDisabled(b);return c},add:function(a){var b=this;if(a){b.controls[a.id]=a;b.onAdd.dispatch(a,b)}return a},createControl:function(a){var b,c,e,f=this,g=f.editor,h,i;if(!f.controlFactories){f.controlFactories=[];d(g.plugins,function(a){if(a.createControl){f.controlFactories.push(a)}})}h=f.controlFactories;for(c=0,e=h.length;c<e;c++){b=h[c].createControl(a,f);if(b){return f.add(b)}}if(a==="|"||a==="separator"){return f.createSeparator()}if(g.buttons&&(b=g.buttons[a])){return f.createButton(a,b)}return f.add(b)},createDropMenu:function(b,c,d){var f=this,g=f.editor,h,i,j,k;c=e({class:"mceDropDown",constrain:g.settings.constrain_menus},c);c["class"]=c["class"]+" "+g.getParam("skin")+"Skin";if(j=g.getParam("skin_variant"))c["class"]+=" "+g.getParam("skin")+"Skin"+j.substring(0,1).toUpperCase()+j.substring(1);c["class"]+=g.settings.directionality=="rtl"?" mceRtl":"";b=f.prefix+b;k=d||f._cls.dropmenu||a.ui.DropMenu;h=f.controls[b]=new k(b,c);h.onAddItem.add(function(a,b){var c=b.settings;c.title=g.getLang(c.title,c.title);if(!c.onclick){c.onclick=function(a){if(c.cmd)g.execCommand(c.cmd,c.ui||false,c.value)}}});g.onRemove.add(function(){h.destroy()});if(a.isIE){h.onShowMenu.add(function(){g.focus();i=g.selection.getBookmark(1)});h.onHideMenu.add(function(){if(i){g.selection.moveToBookmark(i);i=0}})}return f.add(h)},createListBox:function(b,d,f){var g=this,h=g.editor,i,j,k;if(g.get(b))return null;d.title=h.translate(d.title);d.scope=d.scope||h;if(!d.onselect){d.onselect=function(a){h.execCommand(d.cmd,d.ui||false,a||d.value)}}d=e({title:d.title,class:"mce_"+b,scope:d.scope,control_manager:g},d);b=g.prefix+b;function l(b){return b.settings.use_accessible_selects&&!a.isGecko}if(h.settings.use_native_selects||l(h))j=new a.ui.NativeListBox(b,d);else{k=f||g._cls.listbox||a.ui.ListBox;j=new k(b,d,h)}g.controls[b]=j;if(a.isWebKit){j.onPostRender.add(function(a,b){c.add(b,"mousedown",function(){h.bookmark=h.selection.getBookmark(1)});c.add(b,"focus",function(){h.selection.moveToBookmark(h.bookmark);h.bookmark=null})})}if(j.hideMenu)h.onMouseDown.add(j.hideMenu,j);return g.add(j)},createButton:function(b,c,d){var f=this,g=f.editor,h,i,j;if(f.get(b))return null;c.title=g.translate(c.title);c.label=g.translate(c.label);c.scope=c.scope||g;if(!c.onclick&&!c.menu_button){c.onclick=function(){g.execCommand(c.cmd,c.ui||false,c.value)}}c=e({title:c.title,class:"mce_"+b,unavailable_prefix:g.getLang("unavailable",""),scope:c.scope,control_manager:f},c);b=f.prefix+b;if(c.menu_button){j=d||f._cls.menubutton||a.ui.MenuButton;i=new j(b,c,g);g.onMouseDown.add(i.hideMenu,i)}else{j=f._cls.button||a.ui.Button;i=new j(b,c,g)}return f.add(i)},createMenuButton:function(a,b,c){b=b||{};b.menu_button=1;return this.createButton(a,b,c)},createSplitButton:function(b,c,d){var f=this,g=f.editor,h,i,j;if(f.get(b))return null;c.title=g.translate(c.title);c.scope=c.scope||g;if(!c.onclick){c.onclick=function(a){g.execCommand(c.cmd,c.ui||false,a||c.value)}}if(!c.onselect){c.onselect=function(a){g.execCommand(c.cmd,c.ui||false,a||c.value)}}c=e({title:c.title,class:"mce_"+b,scope:c.scope,control_manager:f},c);b=f.prefix+b;j=d||f._cls.splitbutton||a.ui.SplitButton;i=f.add(new j(b,c,g));g.onMouseDown.add(i.hideMenu,i);return i},createSignatureButton:function(b,c,d){var f=this,g=f.editor,h,i,j;if(f.get(b))return null;c.title=g.translate(c.title);c.scope=c.scope||g;if(!c.onclick){c.onclick=function(a){g.execCommand(c.cmd,c.ui||false,a||c.value)}}if(!c.onselect){c.onselect=function(a){g.execCommand(c.cmd,c.ui||false,a||c.value)}}c=e({title:c.title,class:"mce_"+b,scope:c.scope,control_manager:f},c);b=f.prefix+b;j=d||f._cls.splitbutton||a.ui.SignatureButton;i=f.add(new j(b,c,g));g.onMouseDown.add(i.hideMenu,i);return i},createFontButton:function(b,c,d){var f=this,g=f.editor,h,i,j,k;if(f.get(b))return null;c.title=g.translate(c.title);c.scope=c.scope||g;if(!c.onclick){c.onclick=function(b){if(a.isIE)k=g.selection.getBookmark(1);g.execCommand(c.cmd,c.ui||false,b||c.value)}}if(!c.onselect){c.onselect=function(a){}}c=e({title:c.title,class:"mce_"+b,menu_class:g.getParam("skin")+"Skin",scope:c.scope},c);b=f.prefix+b;j=d||f._cls.fontactionbutton||a.ui.FontActionButton;i=new j(b,c);g.onMouseDown.add(i.hideMenu,i);g.onRemove.add(function(){i.destroy()});if(a.isIE){i.onShowMenu.add(function(){g.focus();k=g.selection.getBookmark(1)});i.onHideMenu.add(function(){if(k){g.selection.moveToBookmark(k);k=0}})}return f.add(i)},createControlsButton:function(b,c,d){var f=this,g=f.editor,h,i,j,k;if(f.get(b))return null;c.title=g.translate(c.title);c.scope=c.scope||g;if(!c.onclick){c.onclick=function(b){if(a.isIE)k=g.selection.getBookmark(1);g.execCommand(c.cmd,c.ui||false,b||c.value)}}if(!c.onselect){c.onselect=function(a){g.execCommand(c.cmd,c.ui||false,a||c.value)}}c=e({title:c.title,class:"mce_"+b,menu_class:g.getParam("skin")+"Skin",scope:c.scope},c);b=f.prefix+b;j=d||f._cls.controlsbutton||a.ui.ControlsButton;i=new j(b,c);g.onMouseDown.add(i.hideMenu,i);g.onRemove.add(function(){i.destroy()});if(a.isIE){i.onShowMenu.add(function(){g.focus();k=g.selection.getBookmark(1)});i.onHideMenu.add(function(){if(k){g.selection.moveToBookmark(k);k=0}})}return f.add(i)},createEmotionsSplitButton:function(b,c,d){var f=this,g=f.editor,h,i,j,k;if(f.get(b))return null;c.title=g.translate(c.title);c.scope=c.scope||g;if(!c.onclick){c.onclick=function(a){g.execCommand(c.cmd,c.ui||false,a||c.value)}}if(!c.onselect){c.onselect=function(a){g.execCommand(c.cmd,c.ui||false,a||c.value)}}c=e({title:c.title,class:"mce_"+b,menu_class:g.getParam("skin")+"Skin",scope:c.scope},c);b=f.prefix+b;j=d||f._cls.emotionssplitbutton||a.ui.EmotionsSplitButton;i=new j(b,c);g.onMouseDown.add(i.hideMenu,i);g.onRemove.add(function(){i.destroy()});if(a.isIE){i.onShowMenu.add(function(){g.focus();k=g.selection.getBookmark(1)});i.onChangeTab.add(function(){if(k){g.selection.moveToBookmark(k)}});i.onHideMenu.add(function(){if(k){g.selection.moveToBookmark(k);g.selection.collapse();k=0}})}return f.add(i)},createColorSplitButton:function(b,c,d){var f=this,g=f.editor,h,i,j,k;if(f.get(b))return null;c.title=g.translate(c.title);c.scope=c.scope||g;if(!c.onclick){c.onclick=function(b){if(a.isIE)k=g.selection.getBookmark(1);g.execCommand(c.cmd,c.ui||false,b||c.value)}}if(!c.onselect){c.onselect=function(a){g.execCommand(c.cmd,c.ui||false,a||c.value)}}c=e({title:c.title,class:"mce_"+b,menu_class:g.getParam("skin")+"Skin",scope:c.scope,more_colors_title:g.getLang("more_colors")},c);b=f.prefix+b;j=d||f._cls.colorsplitbutton||a.ui.ColorSplitButton;i=new j(b,c,g);g.onMouseDown.add(i.hideMenu,i);g.onRemove.add(function(){i.destroy()});if(a.isIE){i.onShowMenu.add(function(){g.focus();k=g.selection.getBookmark(1)});i.onHideMenu.add(function(){if(k){g.selection.moveToBookmark(k);k=0}})}return f.add(i)},createToolbar:function(b,c,d){var e,f=this,g;b=f.prefix+b;g=d||f._cls.toolbar||a.ui.Toolbar;e=new g(b,c,f.editor);if(f.get(b))return null;return f.add(e)},createToolbarGroup:function(b,c,d){var e,f=this,g;b=f.prefix+b;g=d||this._cls.toolbarGroup||a.ui.ToolbarGroup;e=new g(b,c,f.editor);if(f.get(b))return null;return f.add(e)},createSeparator:function(b){var c=b||this._cls.separator||a.ui.Separator;return new c},setControlType:function(a,b){return this._cls[a.toLowerCase()]=b},destroy:function(){d(this.controls,function(a){a.destroy()});this.controls=null}})})(tinymce);(function(a){var b=a.util.Dispatcher,c=a.each,d=a.isIE,e=a.isOpera;a.create("tinymce.WindowManager",{WindowManager:function(a){var c=this;c.editor=a;c.onOpen=new b(c);c.onClose=new b(c);c.params={};c.features={}},open:function(b,f){var g=this,h="",i,j,k=g.editor.settings.dialog_type=="modal",l,m,n,o=a.DOM.getViewPort(),p;b=b||{};f=f||{};m=e?o.w:screen.width;n=e?o.h:screen.height;b.name=b.name||"mc_"+(new Date).getTime();b.width=parseInt(b.width||320);b.height=parseInt(b.height||240);b.resizable=true;b.left=b.left||parseInt(m/2)-b.width/2;b.top=b.top||parseInt(n/2)-b.height/2;f.inline=false;f.mce_width=b.width;f.mce_height=b.height;f.mce_auto_focus=b.auto_focus;if(k){if(d){b.center=true;b.help=false;b.dialogWidth=b.width+"px";b.dialogHeight=b.height+"px";b.scroll=b.scrollbars||false}}c(b,function(b,c){if(a.is(b,"boolean"))b=b?"yes":"no";if(!/^(name|url)$/.test(c)){if(d&&k)h+=(h?";":"")+c+":"+b;else h+=(h?",":"")+c+"="+b}});g.features=b;g.params=f;g.onOpen.dispatch(g,b,f);p=b.url||b.file;p=a._addVer(p);try{if(d&&k){l=1;window.showModalDialog(p,window,h)}else l=window.open(p,b.name,h)}catch(a){}if(!l)alert(g.editor.getLang("popup_blocked"))},close:function(a){a.close();this.onClose.dispatch(this)},createInstance:function(b,c,d,e,f,g){var h=a.resolve(b);return new h(c,d,e,f,g)},confirm:function(a,b,c,d){d=d||window;b.call(c||this,d.confirm(this._decode(this.editor.getLang(a,a))))},alert:function(a,b,c,d){var e=this;d=d||window;d.alert(e._decode(e.editor.getLang(a,a)));if(b)b.call(c||e)},resizeBy:function(a,b,c){c.resizeBy(a,b)},_decode:function(b){return a.DOM.decode(b).replace(/\\n/g,"\n")}})})(tinymce);(function(a){a.Formatter=function(b){var c={},d=a.each,e=b.dom,f=b.selection,g=a.dom.TreeWalker,h=new a.dom.RangeUtils(e),i=b.schema.isValidChild,j=a.isArray,k=e.isBlock,l=b.settings.forced_root_block,m=e.nodeIndex,n="\ufeff",o=/^(src|href|style)$/,p=false,q=true,r,s,t=e.getContentEditable;function u(a){return!!b.schema.getTextBlocks()[a.toLowerCase()]}function v(a,b){return e.getParents(a,b,e.getRoot())}function w(a){return a.nodeType===1&&a.id==="_mce_caret"}function x(){A({alignleft:[{selector:"figure,p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li",styles:{textAlign:"left"},defaultBlock:"div"},{selector:"img,table",collapsed:false,styles:{float:"left"}}],aligncenter:[{selector:"figure,p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li",styles:{textAlign:"center"},defaultBlock:"div"},{selector:"img",collapsed:false,styles:{display:"block",marginLeft:"auto",marginRight:"auto"}},{selector:"table",collapsed:false,styles:{marginLeft:"auto",marginRight:"auto"}}],alignright:[{selector:"figure,p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li",styles:{textAlign:"right"},defaultBlock:"div"},{selector:"img,table",collapsed:false,styles:{float:"right"}}],alignfull:[{selector:"figure,p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li",styles:{textAlign:"justify"},defaultBlock:"div"}],bold:[{inline:"strong",remove:"all"},{inline:"span",styles:{fontWeight:"bold"}},{inline:"b",remove:"all"}],italic:[{inline:"em",remove:"all"},{inline:"span",styles:{fontStyle:"italic"}},{inline:"i",remove:"all"}],underline:[{inline:"span",styles:{textDecoration:"underline"},exact:true},{inline:"u",remove:"all"}],strikethrough:[{inline:"span",styles:{textDecoration:"line-through"},exact:true},{inline:"strike",remove:"all"}],forecolor:{inline:"span",styles:{color:"%value"},wrap_links:false},hilitecolor:{inline:"span",styles:{backgroundColor:"%value"},wrap_links:false},fontname:{inline:"span",styles:{fontFamily:"%value"}},fontsize:{inline:"span",styles:{fontSize:"%value"}},fontsize_class:{inline:"span",attributes:{class:"%value"}},blockquote:{block:"blockquote",wrapper:1,remove:"all"},subscript:{inline:"sub"},superscript:{inline:"sup"},link:{inline:"a",selector:"a",remove:"all",split:true,deep:true,onmatch:function(a){return true},onformat:function(a,b,c){d(c,function(b,c){e.setAttrib(a,c,b)})}},removeformat:[{selector:"b,strong,em,i,font,u,strike",remove:"all",split:true,expand:false,block_expand:true,deep:true},{selector:"span",attributes:["style","class"],remove:"empty",split:true,expand:false,deep:true},{selector:"*",attributes:["style","class"],split:false,expand:false,deep:true}]});d("p h1 h2 h3 h4 h5 h6 div address pre div code dt dd samp".split(/\s/),function(a){A(a,{block:a,remove:"all"})});A(b.settings.formats)}function y(){b.addShortcut("ctrl+b","bold_desc","Bold");b.addShortcut("ctrl+i","italic_desc","Italic");b.addShortcut("ctrl+u","underline_desc","Underline")}function z(a){return a?c[a]:c}function A(a,b){if(a){if(typeof a!=="string"){d(a,function(a,b){A(b,a)})}else{b=b.length?b:[b];d(b,function(a){if(a.deep===s)a.deep=!a.selector;if(a.split===s)a.split=!a.selector||a.inline;if(a.remove===s&&a.selector&&!a.inline)a.remove="none";if(a.selector&&a.inline){a.mixed=true;a.block_expand=true}if(typeof a.classes==="string")a.classes=a.classes.split(/\s+/)});c[a]=b}}}var B=function(a){var c;b.dom.getParent(a,function(a){c=b.dom.getStyle(a,"text-decoration");return c&&c!=="none"});return c};var C=function(a){var c;if(a.nodeType===1&&a.parentNode&&a.parentNode.nodeType===1){c=B(a.parentNode);if(b.dom.getStyle(a,"color")&&c){b.dom.setStyle(a,"text-decoration",c)}else if(b.dom.getStyle(a,"textdecoration")===c){b.dom.setStyle(a,"text-decoration",null)}}};function D(c,j,m){var n=z(c),o=n[0],r,s,v,x=f.isCollapsed();function y(a,b){b=b||o;if(a){if(b.onformat){b.onformat(a,b,j,m)}d(b.styles,function(b,c){e.setStyle(a,c,O(b,j))});d(b.attributes,function(b,c){e.setAttrib(a,c,O(b,j))});d(b.classes,function(b){b=O(b,j);if(!e.hasClass(a,b))e.addClass(a,b)})}}function A(){function a(a,b){var c=new g(b);for(m=c.current();m;m=c.prev()){if(m.childNodes.length>1||m==a||m.tagName=="BR"){return m}}}var c=b.selection.getRng();var d=c.startContainer;var e=c.endContainer;if(d!=e&&c.endOffset===0){var f=a(d,e);var h=f.nodeType==3?f.length:f.childNodes.length;c.setEnd(f,h)}return c}function B(b,c,f,g,h){var i=[],j=-1,k,l=-1,m=-1,n;d(b.childNodes,function(a,b){if(a.nodeName==="UL"||a.nodeName==="OL"){j=b;k=a;return false}});d(b.childNodes,function(a,b){if(a.nodeName==="SPAN"&&e.getAttrib(a,"data-mce-type")=="bookmark"){if(a.id==c.id+"_start"){l=b}else if(a.id==c.id+"_end"){m=b}}});if(j<=0||l<j&&m>j){d(a.grep(b.childNodes),h);return 0}else{n=e.clone(f,p);d(a.grep(b.childNodes),function(a,b){if(l<j&&b<j||l>j&&b>j){i.push(a);a.parentNode.removeChild(a)}});if(l<j){b.insertBefore(n,k)}else if(l>j){b.insertBefore(n,k.nextSibling)}g.push(n);d(i,function(a){n.appendChild(a)});return n}}function E(b,f,g){var l=[],m,r,s=true;m=o.inline||o.block;r=e.create(m);y(r);h.walk(b,function(b){var h;function k(b){var q,v,z,A,C;C=s;q=b.nodeName.toLowerCase();v=b.parentNode.nodeName.toLowerCase();if(b.nodeType===1&&t(b)){C=s;s=t(b)==="true";A=true}if(M(q,"br")){h=0;if(o.block)e.remove(b);return}if(o.wrapper&&G(b,c,j)){h=0;return}if(s&&!A&&o.block&&!o.wrapper&&u(q)){b=e.rename(b,m);y(b);l.push(b);h=0;return}if(o.selector){d(n,function(a){if("collapsed"in a&&a.collapsed!==x){return}if(e.is(b,a.selector)&&!w(b)){y(b,a);z=true}});if(!o.inline||z){h=0;return}}if(s&&!A&&i(m,q)&&i(v,m)&&!(!g&&b.nodeType===3&&b.nodeValue.length===1&&b.nodeValue.charCodeAt(0)===65279)&&!w(b)){if(!h){h=e.clone(r,p);b.parentNode.insertBefore(h,b);l.push(h)}h.appendChild(b)}else if(q=="li"&&f){h=B(b,f,r,l,k)}else{h=0;d(a.grep(b.childNodes),k);if(A){s=C}h=0}}d(b,k)});if(o.wrap_links===false){d(l,function(b){function c(b){var f,g,h;if(b.nodeName==="A"){g=e.clone(r,p);l.push(g);h=a.grep(b.childNodes);for(f=0;f<h.length;f++)g.appendChild(h[f]);b.appendChild(g)}d(a.grep(b.childNodes),c)}c(b)})}d(l,function(a){var b;function f(a){var b=0;d(a.childNodes,function(a){if(!P(a)&&!V(a))b++});return b}function g(a){var b,c;d(a.childNodes,function(a){if(a.nodeType==1&&!V(a)&&!w(a)){b=a;return p}});if(b&&L(b,o)){c=e.clone(b,p);y(c);e.replace(c,a,q);e.remove(b,1)}return c||a}b=f(a);if((l.length>1||!k(a))&&b===0){e.remove(a,1);return}if(o.inline||o.wrapper){if(!o.exact&&b===1)a=g(a);d(n,function(b){d(e.select(b.inline,a),function(a){var c;if(b.wrap_links===false){c=a.parentNode;do{if(c.nodeName==="A")return}while(c=c.parentNode)}S(b,j,a,b.exact?a:null)})});if(G(a.parentNode,c,j)){e.remove(a,1);a=0;return q}if(o.merge_with_parents){e.getParent(a.parentNode,function(b){if(G(b,c,j)){e.remove(a,1);a=0;return q}})}if(a&&o.merge_siblings!==false){a=W(U(a),a);a=W(a,U(a,q))}}})}if(o){if(m){if(m.nodeType){s=e.createRng();s.setStartBefore(m);s.setEndAfter(m);E(R(s,n),null,true)}else{E(m,null,true)}}else{if(!x||!o.inline||e.select("td.mceSelected,th.mceSelected").length){var F=b.selection.getNode();if(!l&&n[0].defaultBlock&&!e.getParent(F,e.isBlock)){D(n[0].defaultBlock)}b.selection.setRng(A());r=f.getBookmark();E(R(f.getRng(q),n),r);if(o.styles&&(o.styles.color||o.styles.textDecoration)){a.walk(F,C,"childNodes");C(F)}f.moveToBookmark(r);Z(f.getRng(q));b.nodeChanged()}else Y("apply",c,j)}}}function E(c,g,i){var j=z(c),l=j[0],n,o,r,s=true;function u(b){var c,d,e,f,h,i;if(b.nodeType===3){return}if(b.nodeType===1&&t(b)){h=s;s=t(b)==="true";i=true}c=a.grep(b.childNodes);if(s&&!i){for(d=0,e=j.length;d<e;d++){if(S(j[d],g,b,b))break}}if(l.deep){if(c.length){for(d=0,e=c.length;d<e;d++)u(c[d]);if(i){s=h}}}}function w(a){var b;d(v(a.parentNode).reverse(),function(a){var d;if(!b&&a.id!="_start"&&a.id!="_end"){d=G(a,c,g);if(d&&d.split!==false)b=a}});return b}function x(a,b,c,d){var f,h,i,m,n,o;if(a){o=a.parentNode;for(f=b.parentNode;f&&f!=o;f=f.parentNode){h=e.clone(f,p);for(n=0;n<j.length;n++){if(S(j[n],g,h,h)){h=0;break}}if(h){if(i)h.appendChild(i);if(!m)m=h;i=h}}if(d&&(!l.mixed||!k(a)))b=e.split(a,b);if(i){c.parentNode.insertBefore(i,c);m.appendChild(c)}}return b}function y(a){return x(w(a),a,a,true)}function A(a){var b=e.get(a?"_start":"_end"),c=b[a?"firstChild":"lastChild"];if(V(c))c=c[a?"firstChild":"lastChild"];e.remove(b,true);return c}function C(a){var c,e,f;a=R(a,j,q);if(l.split){c=X(a,q);e=X(a);if(c!=e){if(/^(TR|TD)$/.test(c.nodeName)&&c.firstChild){c=(c.nodeName=="TD"?c.firstChild:c.firstChild.firstChild)||c}c=Q(c,"span",{id:"_start","data-mce-type":"bookmark"});e=Q(e,"span",{id:"_end","data-mce-type":"bookmark"});y(c);y(e);c=A(q);e=A()}else c=e=y(c);if(!c||!e)return;a.startContainer=c.parentNode;a.startOffset=m(c);a.endContainer=e.parentNode;a.endOffset=m(e)+1}h.walk(a,function(a){d(a,function(a){u(a);if(a.nodeType===1&&b.dom.getStyle(a,"text-decoration")==="underline"&&a.parentNode&&B(a.parentNode)==="underline"){S({deep:false,exact:true,inline:"span",styles:{textDecoration:"underline"}},null,a)}})})}if(i){if(i.nodeType){r=e.createRng();r.setStartBefore(i);r.setEndAfter(i);C(r)}else{C(i)}return}if(!f.isCollapsed()||!l.inline||e.select("td.mceSelected,th.mceSelected").length){n=f.getBookmark();C(f.getRng(q));f.moveToBookmark(n);if(l.inline&&H(c,g,f.getStart())){Z(f.getRng(true))}b.nodeChanged()}else Y("remove",c,g)}function F(a,b,c){var d=z(a);if(H(a,b,c)&&(!("toggle"in d[0])||d[0].toggle))E(a,b,c);else D(a,b,c)}function G(a,b,c,d){var f=z(b),g,h,i;function j(a,b,f){var g,h,i=b[f],j;if(b.onmatch){return b.onmatch(a,b,f)}if(i){if(i.length===s){for(g in i){if(i.hasOwnProperty(g)){if(f==="attributes")h=e.getAttrib(a,g);else h=N(a,g);if(d&&!h&&!b.exact)return;if((!d||b.exact)&&!M(h,O(i[g],c)))return}}}else{for(j=0;j<i.length;j++){if(f==="attributes"?e.getAttrib(a,i[j]):N(a,i[j]))return b}}}return b}if(f&&a){for(h=0;h<f.length;h++){g=f[h];if(L(a,g)&&j(a,g,"attributes")&&j(a,g,"styles")){if(i=g.classes){for(h=0;h<i.length;h++){if(!e.hasClass(a,i[h]))return}}return g}}}}function H(a,b,c){var d;function g(c){c=e.getParent(c,function(c){return!!G(c,a,b,true)});return G(c,a,b)}if(c)return g(c);c=f.getNode();if(g(c))return q;d=f.getStart();if(d!=c){if(g(d))return q}return p}function I(a,b){var c,d=[],g={},h,i,j;c=f.getStart();e.getParent(c,function(c){var e,f;for(e=0;e<a.length;e++){f=a[e];if(!g[f]&&G(c,f,b)){g[f]=true;d.push(f)}}},e.getRoot());return d}function J(a){var b=z(a),c,d,g,h,i;if(b){c=f.getStart();d=v(c);for(h=b.length-1;h>=0;h--){i=b[h].selector;if(!i)return q;for(g=d.length-1;g>=0;g--){if(e.is(d[g],i))return q}}}return p}function K(a,c,e){var f;if(!r){r={};f={};b.onNodeChange.addToTop(function(a,b,c){var e=v(c),g={};d(r,function(a,b){d(e,function(c){if(G(c,b,{},a.similar)){if(!f[b]){d(a,function(a){a(true,{node:c,format:b,parents:e})});f[b]=a}g[b]=a;return false}})});d(f,function(a,b){if(!g[b]){delete f[b];d(a,function(a){a(false,{node:c,format:b,parents:e})})}})})}d(a.split(","),function(a){if(!r[a]){r[a]=[];r[a].similar=e}r[a].push(c)});return this}a.extend(this,{get:z,register:A,apply:D,remove:E,toggle:F,match:H,matchAll:I,matchNode:G,canApply:J,formatChanged:K});x();y();function L(a,b){if(M(a,b.inline))return q;if(M(a,b.block))return q;if(b.selector)return e.is(a,b.selector)}function M(a,b){a=a||"";b=b||"";a=""+(a.nodeName||a);b=""+(b.nodeName||b);return a.toLowerCase()==b.toLowerCase()}function N(a,b){var c=e.getStyle(a,b);if(b=="color"||b=="backgroundColor")c=e.toHex(c);if(b=="fontWeight"&&c==700)c="bold";return""+c}function O(a,b){if(typeof a!="string")a=a(b);else if(b){a=a.replace(/%(\w+)/g,function(a,c){return b[c]||a})}return a}function P(a){return a&&a.nodeType===3&&/^([\t \r\n]+|)$/.test(a.nodeValue)}function Q(a,b,c){var d=e.create(b,c);a.parentNode.insertBefore(d,a);d.appendChild(a);return d}function R(a,c,d){var f,h,i,j,l=a.startContainer,n=a.startOffset,o=a.endContainer,q=a.endOffset;function r(a){var b,d,f,g,h,i;b=d=a?l:o;h=a?"previousSibling":"nextSibling";i=e.getRoot();function j(a){return a.nodeName=="BR"&&a.getAttribute("data-mce-bogus")&&!a.nextSibling}if(b.nodeType==3&&!P(b)){if(a?n>0:q<b.nodeValue.length){return b}}for(;;){if(!c[0].block_expand&&k(d))return d;for(g=d[h];g;g=g[h]){if(!V(g)&&!P(g)&&!j(g)){return d}}if(d.parentNode==i){b=d;break}d=d.parentNode}return b}function w(a,b){if(b===s)b=a.nodeType===3?a.length:a.childNodes.length;while(a&&a.hasChildNodes()){a=a.childNodes[b];if(a)b=a.nodeType===3?a.length:a.childNodes.length}return{node:a,offset:b}}if(l.nodeType==1&&l.hasChildNodes()){h=l.childNodes.length-1;l=l.childNodes[n>h?h:n];if(l.nodeType==3)n=0}if(o.nodeType==1&&o.hasChildNodes()){h=o.childNodes.length-1;o=o.childNodes[q>h?h:Math.max(0,q-1)];if(o.nodeType==3)q=o.nodeValue.length}function x(a){var b=a;while(b){if(b.nodeType===1&&t(b)){return t(b)==="false"?b:a}b=b.parentNode}return a}function y(a,c,f){var h,i,j,l;function m(a,b){var c,e,g=a.nodeValue;if(typeof b=="undefined"){b=f?g.length:0}if(f){c=g.lastIndexOf(" ",b);e=g.lastIndexOf(" ",b);c=c>e?c:e;if(c!==-1&&!d){c++}}else{c=g.indexOf(" ",b);e=g.indexOf(" ",b);c=c!==-1&&(e===-1||c<e)?c:e}return c}if(a.nodeType===3){j=m(a,c);if(j!==-1){return{container:a,offset:j}}l=a}h=new g(a,e.getParent(a,k)||b.getBody());while(i=h[f?"prev":"next"]()){if(i.nodeType===3){l=i;j=m(i);if(j!==-1){return{container:i,offset:j}}}else if(k(i)){break}}if(l){if(f){c=0}else{c=l.length}return{container:l,offset:c}}}function z(b,d){var f,g,h,i;if(b.nodeType==3&&b.nodeValue.length===0&&b[d])b=b[d];f=v(b);for(g=0;g<f.length;g++){for(h=0;h<c.length;h++){i=c[h];if("collapsed"in i&&i.collapsed!==a.collapsed)continue;if(e.is(f[g],i.selector))return f[g]}}return b}function A(a,b,d){var f;if(!c[0].wrapper)f=e.getParent(a,c[0].block);if(!f)f=e.getParent(a.nodeType==3?a.parentNode:a,u);if(f&&c[0].wrapper)f=v(f,"ul,ol").reverse()[0]||f;if(!f){f=a;while(f[b]&&!k(f[b])){f=f[b];if(M(f,"br"))break}}return f||a}l=x(l);o=x(o);if(V(l.parentNode)||V(l)){l=V(l)?l:l.parentNode;l=l.nextSibling||l;if(l.nodeType==3)n=0}if(V(o.parentNode)||V(o)){o=V(o)?o:o.parentNode;o=o.previousSibling||o;if(o.nodeType==3)q=o.length}if(c[0].inline){if(a.collapsed){j=y(l,n,true);if(j){l=j.container;n=j.offset}j=y(o,q);if(j){o=j.container;q=j.offset}}i=w(o,q);if(i.node){while(i.node&&i.offset===0&&i.node.previousSibling)i=w(i.node.previousSibling);if(i.node&&i.offset>0&&i.node.nodeType===3&&i.node.nodeValue.charAt(i.offset-1)===" "){if(i.offset>1){o=i.node;o.splitText(i.offset-1)}}}}if(c[0].inline||c[0].block_expand){if(!c[0].inline||(l.nodeType!=3||n===0)){l=r(true)}if(!c[0].inline||(o.nodeType!=3||q===o.nodeValue.length)){o=r()}}if(c[0].selector&&c[0].expand!==p&&!c[0].inline){l=z(l,"previousSibling");o=z(o,"nextSibling")}if(c[0].block||c[0].selector){l=A(l,"previousSibling");o=A(o,"nextSibling");if(c[0].block){if(!k(l))l=r(true);if(!k(o))o=r()}}if(l.nodeType==1){n=m(l);l=l.parentNode}if(o.nodeType==1){q=m(o)+1;o=o.parentNode}return{startContainer:l,startOffset:n,endContainer:o,endOffset:q}}function S(a,b,c,f){var g,h,i;if(!L(c,a))return p;if(a.remove!="all"){d(a.styles,function(a,d){a=O(a,b);if(typeof d==="number"){d=a;f=0}if(!f||M(N(f,d),a))e.setStyle(c,d,"");i=1});if(i&&e.getAttrib(c,"style")==""){c.removeAttribute("style");c.removeAttribute("data-mce-style")}d(a.attributes,function(a,g){var h;a=O(a,b);if(typeof g==="number"){g=a;f=0}if(!f||M(e.getAttrib(f,g),a)){if(g=="class"){a=e.getAttrib(c,g);if(a){h="";d(a.split(/\s+/),function(a){if(/mce\w+/.test(a))h+=(h?" ":"")+a});if(h){e.setAttrib(c,g,h);return}}}if(g=="class")c.removeAttribute("className");if(o.test(g))c.removeAttribute("data-mce-"+g);c.removeAttribute(g)}});d(a.classes,function(a){a=O(a,b);if(!f||e.hasClass(f,a))e.removeClass(c,a)});h=e.getAttribs(c);for(g=0;g<h.length;g++){if(h[g].nodeName.indexOf("_")!==0)return p}}if(a.remove!="none"){T(c,a);return q}}function T(b,c){var f=b.parentNode,g;function h(a,b,c){a=U(a,b,c);return!a||(a.nodeName=="BR"||k(a))}if(c.block){if(!l){if(k(b)&&!k(f)){if(!h(b,p)&&!h(b.firstChild,q,1))b.insertBefore(e.create("br"),b.firstChild);if(!h(b,q)&&!h(b.lastChild,p,1))b.appendChild(e.create("br"))}}else{if(f==e.getRoot()){if(!c.list_block||!M(b,c.list_block)){d(a.grep(b.childNodes),function(a){if(i(l,a.nodeName.toLowerCase())){if(!g)g=Q(a,l);else g.appendChild(a)}else g=0})}}}}if(c.selector&&c.inline&&!M(c.inline,b))return;e.remove(b,1)}function U(a,b,c){if(a){b=b?"nextSibling":"previousSibling";for(a=c?a:a[b];a;a=a[b]){if(a.nodeType==1||!P(a))return a}}}function V(a){return a&&a.nodeType==1&&a.getAttribute("data-mce-type")=="bookmark"}function W(b,c){var f,g,h;function i(a,b){if(a.nodeName!=b.nodeName)return p;function c(a){var b={};d(e.getAttribs(a),function(c){var d=c.nodeName.toLowerCase();if(d.indexOf("_")!==0&&d!=="style")b[d]=e.getAttrib(a,d)});return b}function f(a,b){var c,d;for(d in a){if(a.hasOwnProperty(d)){c=b[d];if(c===s)return p;if(a[d]!=c)return p;delete b[d]}}for(d in b){if(b.hasOwnProperty(d))return p}return q}if(!f(c(a),c(b)))return p;if(!f(e.parseStyle(e.getAttrib(a,"style")),e.parseStyle(e.getAttrib(b,"style"))))return p;return q}function j(a,b){for(g=a;g;g=g[b]){if(g.nodeType==3&&g.nodeValue.length!==0)return a;if(g.nodeType==1&&!V(g))return g}return a}if(b&&c){b=j(b,"previousSibling");c=j(c,"nextSibling");if(i(b,c)){for(g=b.nextSibling;g&&g!=c;){h=g;g=g.nextSibling;b.appendChild(h)}e.remove(c);d(a.grep(c.childNodes),function(a){b.appendChild(a)});return b}}return c}function u(a){return/^(h[1-6]|p|div|pre|address|dl|dt|dd)$/.test(a)}function X(a,c){var d,e,f,h;d=a[c?"startContainer":"endContainer"];e=a[c?"startOffset":"endOffset"];if(d.nodeType==1){f=d.childNodes.length-1;if(!c&&e)e--;d=d.childNodes[e>f?f:e]}if(d.nodeType===3&&c&&e>=d.nodeValue.length){d=new g(d,b.getBody()).next()||d}if(d.nodeType===3&&!c&&e===0){d=new g(d,b.getBody()).prev()||d}return d}function Y(c,d,i){var j="_mce_caret",k=b.settings.caret_debug;function l(a){var c=e.create("span",{id:j,"data-mce-bogus":true,style:k?"color:red":""});if(a){c.appendChild(b.getDoc().createTextNode(n))}return c}function m(a,b){while(a){if(a.nodeType===3&&a.nodeValue!==n||a.childNodes.length>1){return false}if(b&&a.nodeType===1){b.push(a)}a=a.firstChild}return true}function o(a){while(a){if(a.id===j){return a}a=a.parentNode}}function p(a){var b;if(a){b=new g(a,a);for(a=b.current();a;a=b.next()){if(a.nodeType===3){return a}}}}function q(a,b){var c,d;if(!a){a=o(f.getStart());if(!a){while(a=e.get(j)){q(a,false)}}}else{d=f.getRng(true);if(m(a)){if(b!==false){d.setStartBefore(a);d.setEndBefore(a)}e.remove(a)}else{c=p(a);if(c.nodeValue.charAt(0)===n){c=c.deleteData(0,1)}e.remove(a,1)}f.setRng(d)}}function r(){var a,b,c,e,g,j,k;a=f.getRng(true);e=a.startOffset;j=a.startContainer;k=j.nodeValue;b=o(f.getStart());if(b){c=p(b)}if(k&&e>0&&e<k.length&&/\w/.test(k.charAt(e))&&/\w/.test(k.charAt(e-1))){g=f.getBookmark();a.collapse(true);a=R(a,z(d));a=h.split(a);D(d,i,a);f.moveToBookmark(g)}else{if(!b||c.nodeValue!==n){b=l(true);c=b.firstChild;a.insertNode(b);e=1;D(d,i,b)}else{D(d,i,b)}f.setCursorLocation(c,e)}}function s(){var a=f.getRng(true),b,c,g,j,k,m,o=[],p,q;b=a.startContainer;c=a.startOffset;k=b;if(b.nodeType==3){if(c!=b.nodeValue.length||b.nodeValue===n){j=true}k=k.parentNode}while(k){if(G(k,d,i)){m=k;break}if(k.nextSibling){j=true}o.push(k);k=k.parentNode}if(!m){return}if(j){g=f.getBookmark();a.collapse(true);a=R(a,z(d),true);a=h.split(a);E(d,i,a);f.moveToBookmark(g)}else{g=f.getBookmark();k=e.get(g.id+"_start");k.removeAttribute("id");k.removeAttribute("data-mce-style");k.removeAttribute("data-mce-type");k.removeAttribute("style");e.split(m,k);f.select(k);f.collapse(1);f.scrollIntoView(k);return;q=l();k=q;for(p=o.length-1;p>=0;p--){k.appendChild(e.clone(o[p],false));k=k.firstChild}k.appendChild(e.doc.createTextNode(n));k=k.firstChild;e.insertAfter(q,m);f.setCursorLocation(k,1)}}function t(){var b,c,d;c=o(f.getStart());if(c&&!e.isEmpty(c)){a.walk(c,function(a){if(a.nodeType==1&&a.id!==j&&!e.isEmpty(a)){e.setAttrib(a,"data-mce-bogus",null)}},"childNodes")}}if(!self._hasCaretEvents){b.onBeforeGetContent.addToTop(function(){var a=[],b;if(m(o(f.getStart()),a)){b=a.length;while(b--){e.setAttrib(a[b],"data-mce-bogus","1")}}});a.each("onMouseUp onKeyUp".split(" "),function(a){b[a].addToTop(function(){q();t()})});b.onKeyDown.addToTop(function(a,b){var c=b.keyCode;if(c==8||c==37||c==39){q(o(f.getStart()))}t()});f.onSetContent.add(t);self._hasCaretEvents=true}if(c=="apply"){r()}else{s()}}function Z(a){var b=a.startContainer,c=a.startOffset,d,h,i,j,k;if(b.nodeType==3&&c>=b.nodeValue.length){c=m(b);b=b.parentNode;d=true}if(b.nodeType==1){j=b.childNodes;b=j[Math.min(c,j.length-1)];h=new g(b,e.getParent(b,e.isBlock));if(c>j.length-1||d)h.next();for(i=h.current();i;i=h.next()){if(i.nodeType==3&&!P(i)){k=e.create("a",null,n);i.parentNode.insertBefore(k,i);a.setStart(i,0);f.setRng(a);e.remove(k);return}}}}}})(tinymce);tinymce.onAddEditor.add(function(a,b){var c,d,e,f=b.settings;function g(b,c){a.each(c,function(a,c){if(a)e.setStyle(b,c,a)});e.rename(b,"span")}function h(d,g){e=d.dom;if(f.convert_fonts_to_spans){a.each(e.select("font,u,strike",g.node),function(a){c[a.nodeName.toLowerCase()](b.dom,a)})}}if(f.inline_styles){d=a.explode(f.font_size_legacy_values);c={font:function(a,b){g(b,{backgroundColor:b.style.backgroundColor,color:b.color,fontFamily:b.face,fontSize:d[parseInt(b.size,10)-1]})},u:function(a,b){g(b,{textDecoration:"underline"})},strike:function(a,b){g(b,{textDecoration:"line-through"})}};b.onPreProcess.add(h);b.onSetContent.add(h);b.onInit.add(function(){b.selection.onSetContent.add(h)})}});(function(a){var b=a.dom.TreeWalker;a.EnterKey=function(c){var d=c.dom,e=c.selection,f=c.settings,g=c.undoManager,h=c.schema.getNonEmptyElements();function i(i){var j=e.getRng(true),k,l,m,n,o,p,q,r,s,t,u,v,w,x;function y(a){return a&&d.isBlock(a)&&!/^(TD|TH|CAPTION|FORM)$/.test(a.nodeName)&&!/^(fixed|absolute)/i.test(a.style.position)&&d.getContentEditable(a)!=="true"}function z(b){var c;if(a.isIE&&!a.isIE11&&d.isBlock(b)){c=e.getRng();b.appendChild(d.create("span",null," "));e.select(b);b.lastChild.outerHTML="";e.setRng(c)}}function A(a){var b=a,c=[],e;while(b=b.firstChild){if(d.isBlock(b)){return}if(b.nodeType==1&&!h[b.nodeName.toLowerCase()]){c.push(b)}}e=c.length;while(e--){b=c[e];if(!b.hasChildNodes()||b.firstChild==b.lastChild&&b.firstChild.nodeValue===""){d.remove(b)}else{if(b.nodeName=="A"&&(b.innerText||b.textContent)===" "){d.remove(b)}}}}function B(a){var f,g,i,j,k,l=a,m;i=d.createRng();if(a.hasChildNodes()){f=new b(a,a);while(g=f.current()){if(g.nodeType==3){i.setStart(g,0);i.setEnd(g,0);break}if(h[g.nodeName.toLowerCase()]){i.setStartBefore(g);i.setEndBefore(g);break}l=g;g=f.next()}if(!g){i.setStart(l,0);i.setEnd(l,0)}}else{if(a.nodeName=="BR"){if(a.nextSibling&&d.isBlock(a.nextSibling)){if(!p||p<9){m=d.create("br");a.parentNode.insertBefore(m,a)}i.setStartBefore(a);i.setEndBefore(a)}else{i.setStartAfter(a);i.setEndAfter(a)}}else{i.setStart(a,0);i.setEnd(a,0)}}e.setRng(i);d.remove(m);k=d.getViewPort(c.getWin());j=d.getPos(a).y;if(j<k.y||j+25>k.y+k.h){c.getWin().scrollTo(0,j<k.y?j:j-k.h+25)}}function C(b){var c=m,e,g,h;e=b||u=="TABLE"?d.create(b||w):o.cloneNode(false);h=e;if(f.keep_styles!==false){do{if(/^(SPAN|STRONG|B|EM|I|FONT|STRIKE|U)$/.test(c.nodeName)){if(c.id=="_mce_caret"){continue}g=c.cloneNode(false);d.setAttrib(g,"id","");if(e.hasChildNodes()){g.appendChild(e.firstChild);e.appendChild(g)}else{h=g;e.appendChild(g)}}}while(c=c.parentNode)}if(!a.isIE||a.isIE11){h.innerHTML='<br data-mce-bogus="1">'}return e}function D(a){var c,d,e;if(m.nodeType==3&&(a?n>0:n<m.nodeValue.length)){return false}if(m.parentNode==o&&x&&!a){return true}if(a&&m.nodeType==1&&m==o.firstChild){return true}if(m.nodeName==="TABLE"||m.previousSibling&&m.previousSibling.nodeName=="TABLE"){return x&&!a||!x&&a}c=new b(m,o);if(m.nodeType==3){if(a&&n==0){c.prev()}else if(!a&&n==m.nodeValue.length){c.next()}}while(d=c.current()){if(d.nodeType===1){if(!d.getAttribute("data-mce-bogus")){e=d.nodeName.toLowerCase();if(h[e]&&e!=="br"){return false}}}else if(d.nodeType===3&&!/^[ \t\r\n]*$/.test(d.nodeValue)){return false}if(a){c.prev()}else{c.next()}}return true}function E(a,b){var c,e,f,g,h,i=w||"P";e=d.getParent(a,d.isBlock);if(!e||!y(e)){e=e||l;if(!e.hasChildNodes()){c=d.create(i);e.appendChild(c);j.setStart(c,0);j.setEnd(c,0);return c}g=a;while(g.parentNode!=e){g=g.parentNode}while(g&&!d.isBlock(g)){f=g;g=g.previousSibling}if(f){c=d.create(i);f.parentNode.insertBefore(c,f);g=f;while(g&&!d.isBlock(g)){h=g.nextSibling;c.appendChild(g);g=h}j.setStart(a,b);j.setEnd(a,b)}}return a}function F(){function a(a){var b=t[a?"firstChild":"lastChild"];while(b){if(b.nodeType==1){break}b=b[a?"nextSibling":"previousSibling"]}return b===o}r=w?C(w):d.create("BR");if(a(true)&&a()){d.replace(r,t)}else if(a(true)){t.parentNode.insertBefore(r,t)}else if(a()){d.insertAfter(r,t);z(r)}else{k=j.cloneRange();k.setStartAfter(o);k.setEndAfter(t);s=k.extractContents();d.insertAfter(s,t);d.insertAfter(r,t)}d.remove(o);B(r);g.add()}function G(){var a=new b(m,o),c;while(c=a.current()){if(c.nodeName=="BR"){return true}c=a.next()}}function H(){var a=new b(m,o),c;while(c=a.next()){if(h[c.nodeName.toLowerCase()]||c.length>0){return true}}}function I(){var b,c,f;if(m&&m.nodeType==3&&n>=m.nodeValue.length){if((!a.isIE||a.isIE11)&&!H()){b=d.create("br");j.insertNode(b);j.setStartAfter(b);j.setEndAfter(b);c=true}}b=d.create("br");j.insertNode(b);if(a.isIE&&!a.isIE11&&u=="PRE"&&(!p||p<8)){b.parentNode.insertBefore(d.doc.createTextNode("\r"),b)}f=d.create("span",{},"&nbsp;");b.parentNode.insertBefore(f,b);e.scrollIntoView(f);d.remove(f);if(!c){j.setStartAfter(b);j.setEndAfter(b)}else{j.setStartBefore(b);j.setEndBefore(b)}e.setRng(j);g.add()}function J(a){do{if(a.nodeType===3){a.nodeValue=a.nodeValue.replace(/^[\r\n]+/,"")}a=a.firstChild}while(a)}function K(a){var b=d.getRoot(),c,e;c=a;while(c!==b&&d.getContentEditable(c)!=="false"){if(d.getContentEditable(c)==="true"){e=c}c=c.parentNode}return c!==b?e:b}function L(b){var c;if(!a.isIE||a.isIE11){b.normalize();c=b.lastChild;if(!c||/^(left|right)$/gi.test(d.getStyle(c,"float",true))){d.add(b,"br")}}}if(!j.collapsed){c.execCommand("Delete");return}if(i.isDefaultPrevented()){return}m=j.startContainer;n=j.startOffset;w=(f.force_p_newlines?"p":"")||f.forced_root_block;w=w?w.toUpperCase():"";p=d.doc.documentMode;q=i.shiftKey;if(m.nodeType==1&&m.hasChildNodes()){x=n>m.childNodes.length-1;m=m.childNodes[Math.min(n,m.childNodes.length-1)]||m;if(x&&m.nodeType==3){n=m.nodeValue.length}else{n=0}}l=K(m);if(!l){return}g.beforeChange();if(!d.isBlock(l)&&l!=d.getRoot()){if(!w||q){I()}return}if(w&&!q||!w&&q){m=E(m,n)}o=d.getParent(m,d.isBlock);t=o?d.getParent(o.parentNode,d.isBlock):null;u=o?o.nodeName.toUpperCase():"";v=t?t.nodeName.toUpperCase():"";if(v=="LI"&&!i.ctrlKey){o=t;u=v}if(u=="LI"){if(!w&&q){I();return}if(d.isEmpty(o)){if(/^(UL|OL|LI)$/.test(t.parentNode.nodeName)){return false}F();return}}if(u=="PRE"&&f.br_in_pre!==false){if(!q){I();return}}else{var M=d.getParent(e.getNode(),"blockquote");if(M){var N="__";e.setContent('<br id="'+N+'" /> ',{format:"raw"});var O=d.get(N);O.removeAttribute("id");d.split(M,O);e.select(O);e.collapse(1);e.scrollIntoView(O);g.add();return}if(!w&&!q&&u!="LI"||w&&q){I();return}}w=w||"P";if(D()){if(/^(H[1-6]|PRE)$/.test(u)&&v!="HGROUP"){r=C(w)}else{r=C()}if(f.end_container_on_empty_block&&y(t)&&d.isEmpty(o)){r=d.split(t,o)}else{d.insertAfter(r,o)}B(r)}else if(D(true)){r=o.parentNode.insertBefore(C(),o);z(r)}else{k=j.cloneRange();k.setEndAfter(o);s=k.extractContents();J(s);r=s.firstChild;d.insertAfter(s,o);A(r);L(o);B(r)}d.setAttrib(r,"id","");g.add()}c.onKeyDown.add(function(a,b){if(b.keyCode==13){if(i(b)!==false){b.preventDefault()}}})}})(tinymce);(function(){var a=tinymce.each,b=tinymce.dom.Event,c;function d(a,b){while(a&&(a.nodeType===8||a.nodeType===3&&/^[ \t\n\r]*$/.test(a.nodeValue))){a=b(a)}return a}function e(a){return d(a,function(a){return a.previousSibling})}function f(a){return d(a,function(a){return a.nextSibling})}function g(a,b,c){return a.dom.getParent(b,function(a){return tinymce.inArray(c,a)!==-1})}function h(a){return a&&(a.tagName==="OL"||a.tagName==="UL")}function i(a,b){var c,d,f;c=e(a.lastChild);while(h(c)){d=c;c=e(d.previousSibling)}if(d){f=b.create("li",{style:"list-style-type: none;"});b.split(a,d);b.insertAfter(f,d);f.appendChild(d);f.appendChild(d);a=f.previousSibling}return a}function j(a,b,c){a=k(a,b,c);return l(a,b,c)}function k(a,b,c){var d=e(a.previousSibling);if(d){return m(d,a,b?d:false,c)}else{return a}}function l(a,b,c){var d=f(a.nextSibling);if(d){return m(a,d,b?d:false,c)}else{return a}}function m(a,b,c,d){if(n(a,b,!!c,d)){return q(a,b,c)}else if(a&&a.tagName==="LI"&&h(b)){a.appendChild(b)}return b}function n(a,b,c,d){if(!a||!b){return false}else if(a.tagName==="LI"&&b.tagName==="LI"){return b.style.listStyleType==="none"||p(b)}else if(h(a)){return a.tagName===b.tagName&&(c||a.style.listStyleType===b.style.listStyleType)||o(b)}else return d&&a.tagName==="P"&&b.tagName==="P"}function o(a){var b=f(a.firstChild),c=e(a.lastChild);return b&&c&&h(a)&&b===c&&(h(b)||b.style.listStyleType==="none"||p(b))}function p(a){var b=f(a.firstChild),c=e(a.lastChild);return b&&c&&b===c&&h(b)}function q(a,b,c){var d=e(a.lastChild),g=f(b.firstChild);if(a.tagName==="P"){a.appendChild(a.ownerDocument.createElement("br"))}while(b.firstChild){a.appendChild(b.firstChild)}if(c){a.style.listStyleType=c.style.listStyleType}b.parentNode.removeChild(b);m(d,g,false);return a}function r(a,b){var c;if(!b.is(a,"li,ol,ul")){c=b.getParent(a,"li");if(c){a=c}}return a}tinymce.create("tinymce.plugins.Lists",{init:function(a){var c="TABBING";var d="EMPTY";var e="ESCAPE";var f="PARAGRAPH";var g="UNKNOWN";var i=g;function j(b){return b.keyCode===tinymce.VK.TAB&&!(b.altKey||b.ctrlKey)&&(a.queryCommandState("InsertUnorderedList")||a.queryCommandState("InsertOrderedList"))}function k(){var a=n();var b=a.parentNode.parentNode;var c=a.parentNode.lastChild===a;return c&&!l(b)&&o(a)}function l(a){if(h(a)){return a.parentNode&&a.parentNode.tagName==="LI"}else{return a.tagName==="LI"}}function m(){return a.selection.isCollapsed()&&o(n())}function n(){var b=a.selection.getStart();return(b.tagName=="BR"||b.tagName=="")&&b.parentNode.tagName=="LI"?b.parentNode:b}function o(a){var b=a.childNodes.length;if(a.tagName==="LI"){return b==0?true:b==1&&(a.firstChild.tagName==""||a.firstChild.tagName=="BR"||p(a))}return false}function p(a){var b=tinymce.grep(a.parentNode.childNodes,function(a){return a.tagName=="LI"});var c=a==b[b.length-1];var d=a.firstChild;return tinymce.isIE9&&c&&(d.nodeValue==String.fromCharCode(160)||d.nodeValue==String.fromCharCode(32))}function q(a){return a.keyCode===tinymce.VK.ENTER}function r(a){return q(a)&&!a.shiftKey}function s(a){if(j(a)){return c}else if(r(a)&&k()){return g}else if(r(a)&&m()){return d}else{return g}}function t(a,f){if(i==c||i==d||tinymce.isGecko&&i==e){b.cancel(f)}}function u(){var b=a.selection.getRng(true);var c=b.startContainer;if(c.nodeType==3){var d=c.nodeValue;if(tinymce.isIE9&&d.length>1&&d.charCodeAt(d.length-1)==32){return b.endOffset==d.length-1}else{return b.endOffset==d.length}}else if(c.nodeType==1){return b.endOffset==c.childNodes.length}return false}function v(){var b=a.selection.getNode();var c="h1,h2,h3,h4,h5,h6,p,div";var d=a.dom.is(b,c)&&b.parentNode.tagName==="LI"&&b.parentNode.lastChild===b;return a.selection.isCollapsed()&&d&&u()}function w(a,b){if(r(b)&&v()){var c=a.selection.getNode();var d=a.dom.create("li");var e=a.dom.getParent(c,"li");a.dom.insertAfter(d,e);if(tinymce.isIE6||tinymce.isIE7||tinyMCE.isIE8){a.selection.setCursorLocation(d,1)}else{a.selection.setCursorLocation(d,0)}b.preventDefault()}}function x(a,b){var c;if(!tinymce.isGecko)return;var d=a.selection.getStart();if(b.keyCode!=tinymce.VK.BACKSPACE||d.tagName!=="IMG")return;function e(a){var b=a.firstChild;var c=null;do{if(!b)break;if(b.tagName==="LI")c=b}while(b=b.nextSibling);return c}function f(a,b){while(a.childNodes.length>0)b.appendChild(a.childNodes[0])}c=d.parentNode.previousSibling;if(!c)return;var g;if(c.tagName==="UL"||c.tagName==="OL")g=c;else if(c.previousSibling&&(c.previousSibling.tagName==="UL"||c.previousSibling.tagName==="OL"))g=c.previousSibling;else return;var h=e(g);var i=a.dom.createRng();i.setStart(h,1);i.setEnd(h,1);a.selection.setRng(i);a.selection.collapse(true);var j=a.selection.getBookmark();var k=d.parentNode.cloneNode(true);if(k.tagName==="P"||k.tagName==="DIV")f(k,h);else h.appendChild(k);d.parentNode.parentNode.removeChild(d.parentNode);a.selection.moveToBookmark(j)}function y(b){var c=a.dom.getParent(b,"ol,ul");if(c!=null){var d=c.lastChild;a.selection.setCursorLocation(d,0)}}this.ed=a;a.addCommand("Indent",this.indent,this);a.addCommand("Outdent",this.outdent,this);a.addCommand("InsertUnorderedList",function(){this.applyList("UL","OL")},this);a.addCommand("InsertOrderedList",function(){this.applyList("OL","UL")},this);a.onInit.add(function(){a.editorCommands.addCommands({outdent:function(){var b=a.selection,c=a.dom;function d(b){b=c.getParent(b,c.isBlock);return b&&parseInt(a.dom.getStyle(b,"margin-left")||0,10)+parseInt(a.dom.getStyle(b,"padding-left")||0,10)>0}return d(b.getStart())||d(b.getEnd())||a.queryCommandState("InsertOrderedList")||a.queryCommandState("InsertUnorderedList")}},"state")});a.onKeyUp.add(function(a,f){if(i==c){a.execCommand(f.shiftKey?"Outdent":"Indent",true,null);i=g;return b.cancel(f)}else if(i==d){var h=n();var j=a.settings.list_outdent_on_enter===true||f.shiftKey;a.execCommand(j?"Outdent":"Indent",true,null);if(tinymce.isIE){y(h)}return b.cancel(f)}else if(i==e){if(tinymce.isIE6||tinymce.isIE7||tinymce.isIE8){var k=a.getDoc().createTextNode("\ufeff");a.selection.getNode().appendChild(k)}else if(tinymce.isIE9||tinymce.isGecko){a.execCommand("Outdent");return b.cancel(f)}}});function z(b,c){var d=a.getDoc().createTextNode("\ufeff");b.insertBefore(d,c);a.selection.setCursorLocation(d,0);a.execCommand("mceRepaint")}function A(a,b){if(q(b)){var c=n();if(c){var d=c.parentNode;var e=d&&d.parentNode;if(e&&e.nodeName=="LI"&&e.firstChild==d&&c==d.firstChild){z(e,d)}}}}function B(a,b){if(q(b)){var c=n();if(a.dom.select("ul li",c).length===1){var d=c.firstChild;z(c,d)}}}function C(a,c){function d(b){var c=[];var d=new tinymce.dom.TreeWalker(b.firstChild,b);for(var e=d.current();e;e=d.next()){if(a.dom.is(e,"ol,ul,li")){c.push(e)}}return c}if(c.keyCode==tinymce.VK.BACKSPACE){var e=n();if(e){var f=a.dom.getParent(e,"ol,ul"),g=a.selection.getRng();if(f&&f.firstChild===e&&g.startOffset==0){var h=d(e);h.unshift(e);a.execCommand("Outdent",false,h);a.undoManager.add();return b.cancel(c)}}}}function D(a,c){var d=n();if(c.keyCode===tinymce.VK.BACKSPACE&&a.dom.is(d,"li")&&d.parentNode.firstChild!==d){if(a.dom.select("ul,ol",d).length===1){var e=d.previousSibling;a.dom.remove(a.dom.select("br",d));a.dom.remove(d,true);var f=tinymce.grep(e.childNodes,function(a){return a.nodeType===3});if(f.length===1){var g=f[0];a.selection.setCursorLocation(g,g.length)}a.undoManager.add();return b.cancel(c)}}}a.onKeyDown.add(function(a,b){i=s(b)});a.onKeyDown.add(t);a.onKeyDown.add(x);a.onKeyDown.add(w);if(tinymce.isGecko){a.onKeyUp.add(A)}if(tinymce.isIE8){a.onKeyUp.add(B)}if(tinymce.isGecko||tinymce.isWebKit){a.onKeyDown.add(C)}if(tinymce.isWebKit){a.onKeyDown.add(D)}},applyList:function(b,d){var e=this,f=e.ed,g=f.dom,h=[],k=false,m=false,n=false,o,p=f.selection.getSelectedBlocks();function q(a){if(a&&a.tagName==="BR"){g.remove(a)}}function s(a){var c=g.create(b),d;function f(a){if(a.style.marginLeft||a.style.paddingLeft){e.adjustPaddingFunction(false)(a)}}if(a.tagName==="LI"){}else if(a.tagName==="P"||a.tagName==="DIV"||a.tagName==="BODY"){u(a,function(b,c){t(b,c,a.tagName==="BODY"?null:b.parentNode);d=b.parentNode;f(d);q(c)});if(d){if(d.tagName==="LI"&&(a.tagName==="P"||p.length>1)){g.split(d.parentNode.parentNode,d.parentNode)}j(d.parentNode,true)}return}else{d=g.create("li");g.insertAfter(d,a);d.appendChild(a);f(a);a=d}g.insertAfter(c,a);c.appendChild(a);j(c,true);h.push(a)}function t(a,b,c){var d,e=a,f;while(!g.isBlock(a.parentNode)&&a.parentNode!==g.getRoot()){a=g.split(a.parentNode,a.previousSibling);a=a.nextSibling;e=a}if(c){d=c.cloneNode(true);a.parentNode.insertBefore(d,a);while(d.firstChild)g.remove(d.firstChild);d=g.rename(d,"li")}else{d=g.create("li");a.parentNode.insertBefore(d,a)}while(e&&e!=b){f=e.nextSibling;d.appendChild(e);e=f}if(d.childNodes.length===0){d.innerHTML='<br _mce_bogus="1" />'}s(d)}function u(b,d){var e,h,i=3,j=1,k="br,ul,ol,p,div,h1,h2,h3,h4,h5,h6,table,blockquote,address,pre,form,center,dl";function l(a,b){var d=g.createRng(),e;c.keep=true;f.selection.moveToBookmark(c);c.keep=false;e=f.selection.getRng(true);if(!b){b=a.parentNode.lastChild}d.setStartBefore(a);d.setEndAfter(b);return!(d.compareBoundaryPoints(i,e)>0||d.compareBoundaryPoints(j,e)<=0)}function m(a){if(a.nextSibling)return a.nextSibling;if(!g.isBlock(a.parentNode)&&a.parentNode!==g.getRoot())return m(a.parentNode)}e=b.firstChild;var n=false;a(g.select(k,b),function(a){if(a.hasAttribute&&a.hasAttribute("_mce_bogus")){return true}if(l(e,a)){g.addClass(a,"_mce_tagged_br");e=m(a)}});n=e&&l(e,undefined);e=b.firstChild;a(g.select(k,b),function(a){var b=m(a);if(a.hasAttribute&&a.hasAttribute("_mce_bogus")){return true}if(g.hasClass(a,"_mce_tagged_br")){d(e,a,h);h=null}else{h=a}e=b});if(n){d(e,undefined,h)}}function v(a){u(a,function(a,b,c){t(a,b);q(b);q(c)})}function w(a){if(tinymce.inArray(h,a)!==-1){return}if(a.parentNode.tagName===d){g.split(a.parentNode,a);s(a);l(a.parentNode,false)}h.push(a)}function x(a){var b,c,d,e;if(tinymce.inArray(h,a)!==-1){return}a=i(a,g);while(g.is(a.parentNode,"ol,ul,li")){g.split(a.parentNode,a)}h.push(a);a=g.rename(a,"p");d=j(a,false,f.settings.force_br_newlines);if(d===a){b=a.firstChild;while(b){if(g.isBlock(b)){b=g.split(b.parentNode,b);e=true;c=b.nextSibling&&b.nextSibling.firstChild}else{c=b.nextSibling;if(e&&b.tagName==="BR"){g.remove(b)}e=false}b=c}}}a(p,function(a){a=r(a,g);if(a.tagName===d||a.tagName==="LI"&&a.parentNode.tagName===d){m=true}else if(a.tagName===b||a.tagName==="LI"&&a.parentNode.tagName===b){k=true}else{n=true}});if(n&&!k||m||p.length===0){o={LI:w,H1:s,H2:s,H3:s,H4:s,H5:s,H6:s,P:s,BODY:s,DIV:p.length>1?s:v,defaultAction:v,elements:this.selectedBlocks()}}else{o={defaultAction:x,elements:this.selectedBlocks(),processEvenIfEmpty:true}}this.process(o)},indent:function(){var a=this.ed,b=a.dom,c=[];function d(a){var c=b.create("li",{style:"list-style-type: none;"});b.insertAfter(c,a);return c}function e(a){var c=d(a),e=b.getParent(a,"ol,ul"),f=e.tagName,g=b.getStyle(e,"list-style-type"),h={},i;if(g!==""){h.style="list-style-type: "+g+";"}i=b.create(f,h);c.appendChild(i);return i}function f(d){if(!g(a,d,c)){d=i(d,b);var f=e(d);f.appendChild(d);j(f.parentNode,false);j(f,false);c.push(d)}}this.process({LI:f,defaultAction:this.adjustPaddingFunction(true),elements:this.selectedBlocks()})},outdent:function(b,c){var d=this,e=d.ed,f=e.dom,h=[];function k(a){var b,c,j;if(!g(e,a,h)){if(f.getStyle(a,"margin-left")!==""||f.getStyle(a,"padding-left")!==""){return d.adjustPaddingFunction(false)(a)}j=f.getStyle(a,"text-align",true);if(j==="center"||j==="right"){f.setStyle(a,"text-align","left");return}a=i(a,f);b=a.parentNode;c=a.parentNode.parentNode;if(c.tagName==="P"){f.split(c,a.parentNode)}else{f.split(b,a);if(c.tagName==="LI"){f.split(c,a)}else if(!f.is(c,"ol,ul")){f.rename(a,"p")}}h.push(a)}}var l=c&&tinymce.is(c,"array")?c:this.selectedBlocks();this.process({LI:k,defaultAction:this.adjustPaddingFunction(false),elements:l});a(h,j)},process:function(a){var b=this,d=b.ed.selection,e=b.ed.dom,f,g;function h(a){var b=tinymce.grep(a.childNodes,function(a){return!(a.nodeName==="BR"||a.nodeName==="SPAN"&&e.getAttrib(a,"data-mce-type")=="bookmark"||a.nodeType==3&&(a.nodeValue==String.fromCharCode(160)||a.nodeValue==""))});return b.length===0}function i(b){e.removeClass(b,"_mce_act_on");if(!b||b.nodeType!==1||!a.processEvenIfEmpty&&f.length>1&&h(b)){return}b=r(b,e);var c=a[b.tagName];if(!c){c=a.defaultAction}c(b)}function j(a){b.splitSafeEach(a.childNodes,i,true)}function k(a,b){return b>=0&&a.hasChildNodes()&&b<a.childNodes.length&&a.childNodes[b].tagName==="BR"}function l(){var a=d.getNode();var b=e.getParent(a,"td");return b!==null}f=a.elements;g=d.getRng(true);if(!g.collapsed){if(k(g.endContainer,g.endOffset-1)){g.setEnd(g.endContainer,g.endOffset-1);d.setRng(g)}if(k(g.startContainer,g.startOffset)){g.setStart(g.startContainer,g.startOffset+1);d.setRng(g)}}if(tinymce.isIE8){var m=b.ed.selection.getNode();if(m.tagName==="LI"&&!(m.parentNode.lastChild===m)){var n=b.ed.getDoc().createTextNode("\ufeff");m.appendChild(n)}}c=d.getBookmark();a.OL=a.UL=j;b.splitSafeEach(f,i);d.moveToBookmark(c);c=null;if(!l()){b.ed.execCommand("mceRepaint")}},splitSafeEach:function(b,c,d){if(d||tinymce.isGecko&&(/Firefox\/[12]\.[0-9]/.test(navigator.userAgent)||/Firefox\/3\.[0-4]/.test(navigator.userAgent))){this.classBasedEach(b,c)}else{a(b,c)}},classBasedEach:function(b,c){var d=this.ed.dom,e,f;a(b,function(a){d.addClass(a,"_mce_act_on")});e=d.select("._mce_act_on");while(e.length>0){f=e.shift();d.removeClass(f,"_mce_act_on");c(f);e=d.select("._mce_act_on")}},adjustPaddingFunction:function(a){var b,c,d=this.ed;b=d.settings.indentation;c=/[a-z%]+/i.exec(b);b=parseInt(b,10);return function(e){var f,g;f=parseInt(d.dom.getStyle(e,"margin-left")||0,10)+parseInt(d.dom.getStyle(e,"padding-left")||0,10);if(a){g=f+b}else{g=f-b}d.dom.setStyle(e,"padding-left","");d.dom.setStyle(e,"margin-left",g>0?g+c:"")}},selectedBlocks:function(){var a=this.ed,b=a.selection.getSelectedBlocks();return b.length==0?[a.dom.getRoot()]:b},getInfo:function(){return{longname:"Lists",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/lists",version:tinymce.majorVersion+"."+tinymce.minorVersion}}});tinymce.PluginManager.add("lists",tinymce.plugins.Lists)})();(function(a){var b=a.each;function c(a,b){var c=b.ownerDocument,d=c.createRange(),e;d.setStartBefore(b);d.setEnd(a.endContainer,a.endOffset);e=c.createElement("body");e.appendChild(d.cloneContents());return e.innerHTML.replace(/<(br|img|object|embed|input|textarea)[^>]*>/gi,"-").replace(/<[^>]+>/g,"").length==0}function d(a,b){return parseInt(a.getAttribute(b)||1)}function e(c,e,f){var g,h,j,k;m();k=e.getParent(f.getStart(),"th,td");if(k){h=E(k);j=G();k=n(h.x,h.y)}function l(a,b){a=a.cloneNode(b);a.removeAttribute("id");return a}function m(){var a=0;g=[];b(["thead","tbody","tfoot"],function(f){var h=e.select("> "+f+" tr",c);b(h,function(c,h){h+=a;b(e.select("> td, > th",c),function(a,b){var c,e,i,j;if(g[h]){while(g[h][b])b++}i=d(a,"rowspan");j=d(a,"colspan");for(e=h;e<h+i;e++){if(!g[e])g[e]=[];for(c=b;c<b+j;c++){g[e][c]={part:f,real:e==h&&c==b,elm:a,rowspan:i,colspan:j}}}})});a+=h.length})}function n(a,b){var c;c=g[b];if(c)return c[a]}function o(a,b,c){if(a){c=parseInt(c);if(c===1)a.removeAttribute(b,1);else a.setAttribute(b,c,1)}}function p(a){return a&&(e.hasClass(a.elm,"mceSelected")||a==k)}function q(){var a=[];b(c.rows,function(c){b(c.cells,function(b){if(e.hasClass(b,"mceSelected")||b==k.elm){a.push(c);return false}})});return a}function r(){var a=e.createRng();a.setStartAfter(c);a.setEndAfter(c);f.setRng(a);e.remove(c)}function s(c){var d;a.walk(c,function(f){var g;if(f.nodeType==3){b(e.getParents(f.parentNode,null,c).reverse(),function(a){a=l(a,false);if(!d)d=g=a;else if(g)g.appendChild(a);g=a});if(g)g.innerHTML=a.isIE&&!a.isIE11?"&nbsp;":'<br data-mce-bogus="1" />';return false}},"childNodes");c=l(c,false);o(c,"rowSpan",1);o(c,"colSpan",1);if(d){c.appendChild(d)}else{if(!a.isIE||a.isIE11)c.innerHTML='<br data-mce-bogus="1" />'}return c}function t(){var a=e.createRng();b(e.select("tr",c),function(a){if(a.cells.length==0)e.remove(a)});if(e.select("tr",c).length==0){a.setStartAfter(c);a.setEndAfter(c);f.setRng(a);e.remove(c);return}b(e.select("thead,tbody,tfoot",c),function(a){if(a.rows.length==0)e.remove(a)});m();row=g[Math.min(g.length-1,h.y)];if(row){f.select(row[Math.min(row.length-1,h.x)].elm,true);f.collapse(true)}}function u(a,b,c,d){var f,h,i,j,k;f=g[b][a].elm.parentNode;for(i=1;i<=c;i++){f=e.getNext(f,"tr");if(f){for(h=a;h>=0;h--){k=g[b+i][h].elm;if(k.parentNode==f){for(j=1;j<=d;j++)e.insertAfter(s(k),k);break}}if(h==-1){for(j=1;j<=d;j++)f.insertBefore(s(f.cells[0]),f.cells[0])}}}}function v(){b(g,function(a,c){b(a,function(a,b){var f,g,h,i;if(p(a)){a=a.elm;f=d(a,"colspan");g=d(a,"rowspan");if(f>1||g>1){o(a,"rowSpan",1);o(a,"colSpan",1);for(i=0;i<f-1;i++)e.insertAfter(s(a),a);u(b,c,g-1,f)}}})})}function w(c,d,f){var i,k,l,q,r,s,u,w,c,x,y;if(c){pos=E(c);i=pos.x;k=pos.y;l=i+(d-1);q=k+(f-1)}else{h=j=null;b(g,function(a,c){b(a,function(a,b){if(p(a)){if(!h){h={x:b,y:c}}j={x:b,y:c}}})});i=h.x;k=h.y;l=j.x;q=j.y}u=n(i,k);w=n(l,q);if(u&&w&&u.part==w.part){v();m();u=n(i,k).elm;o(u,"colSpan",l-i+1);o(u,"rowSpan",q-k+1);for(s=k;s<=q;s++){for(r=i;r<=l;r++){if(!g[s]||!g[s][r])continue;c=g[s][r].elm;if(c!=u){x=a.grep(c.childNodes);b(x,function(a){u.appendChild(a)});if(x.length){x=a.grep(u.childNodes);y=0;b(x,function(a){if(a.nodeName=="BR"&&e.getAttrib(a,"data-mce-bogus")&&y++<x.length-1)u.removeChild(a)})}e.remove(c)}}}t()}}function x(a){var c,f,h,i,j,k,m,n,q;b(g,function(d,e){b(d,function(b,d){if(p(b)){b=b.elm;j=b.parentNode;k=l(j,false);c=e;if(a)return false}});if(a)return!c});for(i=0;i<g[0].length;i++){if(!g[c][i])continue;f=g[c][i].elm;if(f!=h){if(!a){q=d(f,"rowspan");if(q>1){o(f,"rowSpan",q+1);continue}}else{if(c>0&&g[c-1][i]){n=g[c-1][i].elm;q=d(n,"rowSpan");if(q>1){o(n,"rowSpan",q+1);continue}}}m=s(f);o(m,"colSpan",f.colSpan);k.appendChild(m);h=f}}if(k.hasChildNodes()){if(!a)e.insertAfter(k,j);else j.parentNode.insertBefore(k,j)}}function y(a){var c,f;b(g,function(d,e){b(d,function(b,d){if(p(b)){c=d;if(a)return false}});if(a)return!c});b(g,function(b,g){var h,i,j;if(!b[c])return;h=b[c].elm;if(h!=f){j=d(h,"colspan");i=d(h,"rowspan");if(j==1){if(!a){e.insertAfter(s(h),h);u(c,g,i-1,j)}else{h.parentNode.insertBefore(s(h),h);u(c,g,i-1,j)}}else o(h,"colSpan",h.colSpan+1);f=h}})}function z(){var c=[];b(g,function(f,h){b(f,function(f,h){if(p(f)&&a.inArray(c,h)===-1){b(g,function(a){var b=a[h].elm,c;c=d(b,"colSpan");if(c>1)o(b,"colSpan",c-1);else e.remove(b)});c.push(h)}})});t()}function A(){var a;function c(a){var c,f,h;c=e.getNext(a,"tr");b(a.cells,function(a){var b=d(a,"rowSpan");if(b>1){o(a,"rowSpan",b-1);f=E(a);u(f.x,f.y,1,1)}});f=E(a.cells[0]);b(g[f.y],function(a){var b;a=a.elm;if(a!=h){b=d(a,"rowSpan");if(b<=1)e.remove(a);else o(a,"rowSpan",b-1);h=a}})}a=q();b(a.reverse(),function(a){c(a)});t()}function B(){var a=q();e.remove(a);t();return a}function C(){var a=q();b(a,function(b,c){a[c]=l(b,true)});return a}function D(a,c){if(!a)return;var d=q(),f=d[c?0:d.length-1],h=f.cells.length;b(g,function(a){var c;h=0;b(a,function(a,b){if(a.real)h+=a.colspan;if(a.elm.parentNode==f)c=1});if(c)return false});if(!c)a.reverse();b(a,function(a){var b=a.cells.length,d;for(i=0;i<b;i++){d=a.cells[i];o(d,"colSpan",1);o(d,"rowSpan",1)}for(i=b;i<h;i++)a.appendChild(s(a.cells[b-1]));for(i=h;i<b;i++)e.remove(a.cells[i]);if(c)f.parentNode.insertBefore(a,f);else e.insertAfter(a,f)});e.removeClass(e.select("td.mceSelected,th.mceSelected"),"mceSelected")}function E(a){var c;b(g,function(d,e){b(d,function(b,d){if(b.elm==a){c={x:d,y:e};return false}});return!c});return c}function F(a){h=E(a)}function G(){var a,c,d;c=d=0;b(g,function(a,e){b(a,function(a,b){var f,h;if(p(a)){a=g[e][b];if(b>c)c=b;if(e>d)d=e;if(a.real){f=a.colspan-1;h=a.rowspan-1;if(f){if(b+f>c)c=b+f}if(h){if(e+h>d)d=e+h}}}})});return{x:c,y:d}}function H(a){var b,c,d,f,i,k,l,m,n,o;j=E(a);if(h&&j){b=Math.min(h.x,j.x);c=Math.min(h.y,j.y);d=Math.max(h.x,j.x);f=Math.max(h.y,j.y);i=d;k=f;for(o=c;o<=k;o++){a=g[o][b];if(!a)continue;if(!a.real){if(b-(a.colspan-1)<b)b-=a.colspan-1}}for(n=b;n<=i;n++){a=g[c][n];if(!a.real){if(c-(a.rowspan-1)<c)c-=a.rowspan-1}}for(o=c;o<=f;o++){for(n=b;n<=d;n++){a=g[o][n];if(a.real){l=a.colspan-1;m=a.rowspan-1;if(l){if(n+l>i)i=n+l}if(m){if(o+m>k)k=o+m}}}}e.removeClass(e.select("td.mceSelected,th.mceSelected"),"mceSelected");for(o=c;o<=k;o++){for(n=b;n<=i;n++){if(g[o][n])e.addClass(g[o][n].elm,"mceSelected")}}}}a.extend(this,{deleteTable:r,split:v,merge:w,insertRow:x,insertCol:y,deleteCols:z,deleteRows:A,cutRows:B,copyRows:C,pasteRows:D,getPos:E,setStartCell:F,setEndCell:H})}a.create("tinymce.plugins.TablePlugin",{init:function(f,g){var h,i,j=true;function k(a){var b=f.selection,c=f.dom.getParent(a||b.getNode(),"table");if(c)return new e(c,f.dom,b)}function l(){f.getBody().style.webkitUserSelect="";if(j){f.dom.removeClass(f.dom.select("td.mceSelected,th.mceSelected"),"mceSelected");j=false}}b([["table","table.desc","mceInsertTable",true],["delete_table","table.del","mceTableDelete"],["delete_col","table.delete_col_desc","mceTableDeleteCol"],["delete_row","table.delete_row_desc","mceTableDeleteRow"],["col_after","table.col_after_desc","mceTableInsertColAfter"],["col_before","table.col_before_desc","mceTableInsertColBefore"],["row_after","table.row_after_desc","mceTableInsertRowAfter"],["row_before","table.row_before_desc","mceTableInsertRowBefore"],["row_props","table.row_desc","mceTableRowProps",true],["cell_props","table.cell_desc","mceTableCellProps",true],["split_cells","table.split_cells_desc","mceTableSplitCells",true],["merge_cells","table.merge_cells_desc","mceTableMergeCells",true]],function(a){f.addButton(a[0],{title:a[1],cmd:a[2],ui:a[3]})});if(!a.isIE){f.onClick.add(function(a,b){b=b.target;if(b.nodeName==="TABLE"){a.selection.select(b);a.nodeChanged()}})}f.onPreProcess.add(function(a,b){var c,d,e,f=a.dom,g;c=f.select("table",b.node);d=c.length;while(d--){e=c[d];f.setAttrib(e,"data-mce-style","");if(g=f.getAttrib(e,"width")){f.setStyle(e,"width",g);f.setAttrib(e,"width","")}if(g=f.getAttrib(e,"height")){f.setStyle(e,"height",g);f.setAttrib(e,"height","")}}});f.onNodeChange.add(function(a,b,c){var d;c=a.selection.getStart();d=a.dom.getParent(c,"td,th,caption");b.setActive("table",c.nodeName==="TABLE"||!!d);if(d&&d.nodeName==="CAPTION")d=0;b.setDisabled("delete_table",!d);b.setDisabled("delete_col",!d);b.setDisabled("delete_table",!d);b.setDisabled("delete_row",!d);b.setDisabled("col_after",!d);b.setDisabled("col_before",!d);b.setDisabled("row_after",!d);b.setDisabled("row_before",!d);b.setDisabled("row_props",!d);b.setDisabled("cell_props",!d);b.setDisabled("split_cells",!d);b.setDisabled("merge_cells",!d)});f.onInit.add(function(e){var f,g,m=e.dom,n;h=e.windowManager;e.onMouseDown.add(function(a,b){if(b.button!=2){l();g=m.getParent(b.target,"td,th");f=m.getParent(g,"table")}});m.bind(e.getDoc(),"mouseover",function(a){var b,c,d=a.target;if(g&&(n||d!=g)&&(d.nodeName=="TD"||d.nodeName=="TH")){c=m.getParent(d,"table");if(c==f){if(!n){n=k(c);n.setStartCell(g);e.getBody().style.webkitUserSelect="none"}n.setEndCell(d);j=true}b=e.selection.getSel();try{if(b.removeAllRanges)b.removeAllRanges();else b.empty()}catch(a){}a.preventDefault()}});e.onMouseUp.add(function(b,c){var d,e=b.selection,h,i=e.getSel(),j,k,l,o;if(g){if(n)b.getBody().style.webkitUserSelect="";function p(b,c){var e=new a.dom.TreeWalker(b,b);do{if(b.nodeType==3&&a.trim(b.nodeValue).length!=0){if(c)d.setStart(b,0);else d.setEnd(b,b.nodeValue.length);return}if(b.nodeName=="BR"){if(c)d.setStartBefore(b);else d.setEndBefore(b);return}}while(b=c?e.next():e.prev())}h=m.select("td.mceSelected,th.mceSelected");if(h.length>0){d=m.createRng();k=h[0];o=h[h.length-1];d.setStartBefore(k);d.setEndAfter(k);p(k,1);j=new a.dom.TreeWalker(k,m.getParent(h[0],"table"));do{if(k.nodeName=="TD"||k.nodeName=="TH"){if(!m.hasClass(k,"mceSelected"))break;l=k}}while(k=j.next());p(l);e.setRng(d)}b.nodeChanged();g=n=f=null}});e.onKeyUp.add(function(a,b){l()});e.onKeyDown.add(function(a,b){p(a)});e.onMouseDown.add(function(a,b){if(b.button!=2){p(a)}});function o(a,b,c,d){var e=3,f=a.dom.getParent(b.startContainer,"TABLE"),g,h,i;if(f)g=f.parentNode;h=b.startContainer.nodeType==e&&b.startOffset==0&&b.endOffset==0&&d&&(c.nodeName=="TR"||c==g);i=(c.nodeName=="TD"||c.nodeName=="TH")&&!d;return h||i}function p(b){if(!a.isWebKit)return;var c=b.selection.getRng();var d=b.selection.getNode();var e=b.dom.getParent(c.startContainer,"TD,TH");if(!o(b,c,d,e))return;if(!e){e=d}var f=e.lastChild;while(f.lastChild)f=f.lastChild;c.setEnd(f,f.nodeValue.length);b.selection.setRng(c)}e.plugins.table.fixTableCellSelection=p;if(e&&e.plugins.contextmenu){e.plugins.contextmenu.onContextMenu.add(function(a,b,c){var d,f=e.selection,g=f.getNode()||e.getBody();if(e.dom.getParent(c,"td")||e.dom.getParent(c,"th")||e.dom.select("td.mceSelected,th.mceSelected").length){b.removeAll();if(g.nodeName=="A"&&!e.dom.getAttrib(g,"name")){b.add({title:"advanced.link_desc",icon:"link",cmd:e.plugins.advlink?"mceAdvLink":"mceLink",ui:true});b.add({title:"advanced.unlink_desc",icon:"unlink",cmd:"UnLink"});b.addSeparator()}if(g.nodeName=="IMG"&&g.className.indexOf("mceItem")==-1){b.add({title:"advanced.image_desc",icon:"image",cmd:e.plugins.advimage?"mceAdvImage":"mceImage",ui:true});b.addSeparator()}b.add({title:"table.desc",icon:"table",cmd:"mceInsertTable",value:{action:"insert"}});b.add({title:"table.props_desc",icon:"table_props",cmd:"mceInsertTable"});b.add({title:"table.del",icon:"delete_table",cmd:"mceTableDelete"});b.addSeparator();d=b.addMenu({title:"table.cell"});d.add({title:"table.cell_desc",icon:"cell_props",cmd:"mceTableCellProps"});d.add({title:"table.split_cells_desc",icon:"split_cells",cmd:"mceTableSplitCells"});d.add({title:"table.merge_cells_desc",icon:"merge_cells",cmd:"mceTableMergeCells"});d=b.addMenu({title:"table.row"});d.add({title:"table.row_desc",icon:"row_props",cmd:"mceTableRowProps"});d.add({title:"table.row_before_desc",icon:"row_before",cmd:"mceTableInsertRowBefore"});d.add({title:"table.row_after_desc",icon:"row_after",cmd:"mceTableInsertRowAfter"});d.add({title:"table.delete_row_desc",icon:"delete_row",cmd:"mceTableDeleteRow"});d.addSeparator();d.add({title:"table.cut_row_desc",icon:"cut",cmd:"mceTableCutRow"});d.add({title:"table.copy_row_desc",icon:"copy",cmd:"mceTableCopyRow"});d.add({title:"table.paste_row_before_desc",icon:"paste",cmd:"mceTablePasteRowBefore"}).setDisabled(!i);d.add({title:"table.paste_row_after_desc",icon:"paste",cmd:"mceTablePasteRowAfter"}).setDisabled(!i);d=b.addMenu({title:"table.col"});d.add({title:"table.col_before_desc",icon:"col_before",cmd:"mceTableInsertColBefore"});d.add({title:"table.col_after_desc",icon:"col_after",cmd:"mceTableInsertColAfter"});d.add({title:"table.delete_col_desc",icon:"delete_col",cmd:"mceTableDeleteCol"})}else b.add({title:"table.desc",icon:"table",cmd:"mceInsertTable"})})}if(a.isWebKit){function q(c,e){var f=a.VK;var g=e.keyCode;function h(b,d,e){var f=b?"previousSibling":"nextSibling";var g=c.dom.getParent(d,"tr");var h=g[f];if(h){s(c,d,h,b);a.dom.Event.cancel(e);return true}else{var j=c.dom.getParent(g,"table");var m=g.parentNode;var n=m.nodeName.toLowerCase();if(n==="tbody"||n===(b?"tfoot":"thead")){var o=i(b,j,m,"tbody");if(o!==null){return k(b,o,d,e)}}return l(b,g,f,j,e)}}function i(a,b,d,e){var f=c.dom.select(">"+e,b);var g=f.indexOf(d);if(a&&g===0||!a&&g===f.length-1){return j(a,b)}else if(g===-1){var h=d.tagName.toLowerCase()==="thead"?0:f.length-1;return f[h]}else{return f[g+(a?-1:1)]}}function j(a,b){var d=a?"thead":"tfoot";var e=c.dom.select(">"+d,b);return e.length!==0?e[0]:null}function k(b,d,e,f){var g=m(d,b);g&&s(c,e,g,b);a.dom.Event.cancel(f);return true}function l(b,d,e,f,g){var i=f[e];if(i){n(i);return true}else{var j=c.dom.getParent(f,"td,th");if(j){return h(b,j,g)}else{var k=m(d,!b);n(k);return a.dom.Event.cancel(g)}}}function m(a,b){var d=a&&a[b?"lastChild":"firstChild"];return d&&d.nodeName==="BR"?c.dom.getParent(d,"td,th"):d}function n(a){c.selection.setCursorLocation(a,0)}function o(){return g==f.UP||g==f.DOWN}function p(a){var b=a.selection.getNode();var c=a.dom.getParent(b,"tr");return c!==null}function q(a){var b=0;var c=a;while(c.previousSibling){c=c.previousSibling;b=b+d(c,"colspan")}return b}function r(a,c){var e=0;var f=0;b(a.children,function(a,b){e=e+d(a,"colspan");f=b;if(e>c)return false});return f}function s(a,b,c,d){var e=q(a.dom.getParent(b,"td,th"));var f=r(c,e);var g=c.childNodes[f];var h=m(g,d);n(h||g)}function t(a){var b=c.selection.getNode();var d=c.dom.getParent(b,"td,th");var e=c.dom.getParent(a,"td,th");return d&&d!==e&&u(d,e)}function u(a,b){return c.dom.getParent(a,"TABLE")===c.dom.getParent(b,"TABLE")}if(o()&&p(c)){var v=c.selection.getNode();setTimeout(function(){if(t(v)){h(!e.shiftKey&&g===f.UP,v,e)}},0)}}e.onKeyDown.add(q)}function r(){var b;for(b=e.getBody().lastChild;b&&b.nodeType==3&&!b.nodeValue.length;b=b.previousSibling);if(b&&b.nodeName=="TABLE"){if(e.settings.forced_root_block)e.dom.add(e.getBody(),e.settings.forced_root_block,null,a.isIE&&!a.isIE11?"&nbsp;":'<br data-mce-bogus="1" />');else e.dom.add(e.getBody(),"br",{"data-mce-bogus":"1"})}}if(a.isGecko){e.onKeyDown.add(function(a,b){var d,e,f=a.dom;if(b.keyCode==37||b.keyCode==38){d=a.selection.getRng();e=f.getParent(d.startContainer,"table");if(e&&a.getBody().firstChild==e){if(c(d,e)){d=f.createRng();d.setStartBefore(e);d.setEndBefore(e);a.selection.setRng(d);b.preventDefault()}}}})}e.onKeyUp.add(r);e.onSetContent.add(r);e.onVisualAid.add(r);e.onPreProcess.add(function(a,b){var c=b.node.lastChild;if(c&&(c.nodeName=="BR"||c.childNodes.length==1&&(c.firstChild.nodeName=="BR"||c.firstChild.nodeValue==" "))&&c.previousSibling&&c.previousSibling.nodeName=="TABLE"){a.dom.remove(c)}});r();e.startContent=e.getContent({format:"raw"})});b({mceTableSplitCells:function(a){a.split()},mceTableMergeCells:function(a){var b,c,d;d=f.dom.getParent(f.selection.getNode(),"th,td");if(d){b=d.rowSpan;c=d.colSpan}if(!f.dom.select("td.mceSelected,th.mceSelected").length){h.open({url:g+"/merge_cells.htm",width:240+parseInt(f.getLang("table.merge_cells_delta_width",0)),height:110+parseInt(f.getLang("table.merge_cells_delta_height",0)),inline:1},{rows:b,cols:c,onaction:function(b){a.merge(d,b.cols,b.rows)},plugin_url:g})}else a.merge()},mceTableInsertRowBefore:function(a){a.insertRow(true)},mceTableInsertRowAfter:function(a){a.insertRow()},mceTableInsertColBefore:function(a){a.insertCol(true)},mceTableInsertColAfter:function(a){a.insertCol()},mceTableDeleteCol:function(a){a.deleteCols()},mceTableDeleteRow:function(a){a.deleteRows()},mceTableCutRow:function(a){i=a.cutRows()},mceTableCopyRow:function(a){i=a.copyRows()},mceTablePasteRowBefore:function(a){a.pasteRows(i,true)},mceTablePasteRowAfter:function(a){a.pasteRows(i)},mceTableDelete:function(a){a.deleteTable()}},function(a,b){f.addCommand(b,function(){var b=k();if(b){a(b);f.execCommand("mceRepaint");l()}})});b({mceInsertTable:function(a){h.open({url:g+"/table.htm",width:400+parseInt(f.getLang("table.table_delta_width",0)),height:320+parseInt(f.getLang("table.table_delta_height",0)),inline:1},{plugin_url:g,action:a?a.action:0})},mceTableRowProps:function(){h.open({url:g+"/row.htm",width:400+parseInt(f.getLang("table.rowprops_delta_width",0)),height:295+parseInt(f.getLang("table.rowprops_delta_height",0)),inline:1},{plugin_url:g})},mceTableCellProps:function(){h.open({url:g+"/cell.htm",width:400+parseInt(f.getLang("table.cellprops_delta_width",0)),height:295+parseInt(f.getLang("table.cellprops_delta_height",0)),inline:1},{plugin_url:g})}},function(a,b){f.addCommand(b,function(b,c){a(c)})})}});a.PluginManager.add("table",a.plugins.TablePlugin)})(tinymce);(function(){var a=tinymce.each,b={paste_auto_cleanup_on_paste:true,paste_enable_default_filters:true,paste_block_drop:false,paste_retain_style_properties:"none",paste_strip_class_attributes:"mso",paste_remove_spans:false,paste_remove_styles:false,paste_remove_styles_if_webkit:true,paste_convert_middot_lists:true,paste_convert_headers_to_strong:false,paste_dialog_width:"450",paste_dialog_height:"400",paste_max_consecutive_linebreaks:2,paste_text_use_dialog:false,paste_text_sticky:false,paste_text_sticky_default:false,paste_text_notifyalways:false,paste_text_linebreaktype:"combined",paste_text_replacements:[[/\u2026/g,"..."],[/[\x93\x94\u201c\u201d]/g,'"'],[/[\x60\x91\x92\u2018\u2019]/g,"'"]]};function c(a,c){return a.getParam(c,b[c])}tinymce.create("tinymce.plugins.PastePlugin",{init:function(b,d){var e=this;e.editor=b;e.url=d;e.onPreProcess=new tinymce.util.Dispatcher(e);e.onPostProcess=new tinymce.util.Dispatcher(e);e.onPreProcess.add(e._preProcess);e.onPostProcess.add(e._postProcess);e.onPreProcess.add(function(a,c){b.execCallback("paste_preprocess",a,c)});e.onPostProcess.add(function(a,c){b.execCallback("paste_postprocess",a,c)});b.onKeyDown.addToTop(function(a,b){if((tinymce.isMac?b.metaKey:b.ctrlKey)&&b.keyCode==86||b.shiftKey&&b.keyCode==45)return false});b.pasteAsPlainText=c(b,"paste_text_sticky_default");function f(a,d){var f=b.dom,g;e.onPreProcess.dispatch(e,a);a.node=f.create("div",0,a.content);if(tinymce.isGecko){g=b.selection.getRng(true);if(g.startContainer==g.endContainer&&g.startContainer.nodeType==3){if(a.node.childNodes.length===1&&/^(p|h[1-6]|pre)$/i.test(a.node.firstChild.nodeName)&&a.content.indexOf("__MCE_ITEM__")===-1)f.remove(a.node.firstChild,true)}}e.onPostProcess.dispatch(e,a);var h=a.node.childNodes[0];if(!(h.nodeName=="IMG"||h.nodeName=="A"&&h.childNodes.length==1&&h.childNodes[0].nodeName=="IMG")){a.content=b.serializer.serialize(a.node,{getInner:1,forced_root_block:""})}if(!d&&b.pasteAsPlainText){e._insertPlainText(a.content);if(!c(b,"paste_text_sticky")){b.pasteAsPlainText=false;b.controlManager.setActive("pastetext",false)}}else{e._insert(a.content)}}b.addCommand("mceInsertClipboardContent",function(a,b){f(b,true)});if(!c(b,"paste_text_use_dialog")){b.addCommand("mcePasteText",function(a,d){var e=tinymce.util.Cookie;b.pasteAsPlainText=!b.pasteAsPlainText;b.controlManager.setActive("pastetext",b.pasteAsPlainText);if(b.pasteAsPlainText&&!e.get("tinymcePasteText")){if(c(b,"paste_text_sticky")){b.windowManager.alert(b.translate("paste.plaintext_mode_sticky"))}else{b.windowManager.alert(b.translate("paste.plaintext_mode"))}if(!c(b,"paste_text_notifyalways")){e.set("tinymcePasteText","1",new Date((new Date).getFullYear()+1,12,31))}}})}b.addButton("pastetext",{title:"paste.paste_text_desc",cmd:"mcePasteText"});b.addButton("selectall",{title:"paste.selectall_desc",cmd:"selectall"});function g(c){var d,e,g,h,i=b.selection,j=b.dom,k=b.getBody(),l,m;if(c.clipboardData||j.doc.dataTransfer){m=(c.clipboardData||j.doc.dataTransfer).getData("Text");if(b.pasteAsPlainText){c.preventDefault();f({content:j.encode(m).replace(/\r?\n/g,"<br />")});return}}if(j.get("_mcePaste"))return;d=j.add(k,"div",{id:"_mcePaste",class:"mcePaste","data-mce-bogus":"1"},"\ufeff\ufeff");if(k!=b.getDoc().body)l=j.getPos(b.selection.getStart(),k).y;else l=k.scrollTop+j.getViewPort(b.getWin()).y;j.setStyles(d,{position:"absolute",left:tinymce.isGecko?-40:0,top:l-25,width:1,height:1,overflow:"hidden"});if(tinymce.isIE){h=i.getRng();g=j.doc.body.createTextRange();g.moveToElementText(d);g.execCommand("Paste");j.remove(d);if(d.innerHTML==="\ufeff\ufeff"){b.execCommand("mcePasteWord");c.preventDefault();return}i.setRng(h);i.setContent("");setTimeout(function(){f({content:d.innerHTML})},0);return tinymce.dom.Event.cancel(c)}else{function n(a){a.preventDefault()}j.bind(b.getDoc(),"mousedown",n);j.bind(b.getDoc(),"keydown",n);e=b.selection.getRng();d=d.firstChild;g=b.getDoc().createRange();g.setStart(d,0);g.setEnd(d,2);i.setRng(g);var o=j.getViewPort(b.getWin()).y;window.setTimeout(function(){var c="",d;j.doc.body.scrollTop=o;if(!j.select("div.mcePaste > div.mcePaste").length){d=j.select("div.mcePaste");a(d,function(b){var d=b.firstChild;if(d&&d.nodeName=="DIV"&&d.style.marginTop&&d.style.backgroundColor){j.remove(d,1)}a(j.select("span.Apple-style-span",b),function(a){j.remove(a,1)});a(j.select("br[data-mce-bogus]",b),function(a){j.remove(a)});if(b.parentNode.className!="mcePaste")c+=b.innerHTML})}else{c="<p>"+j.encode(m).replace(/\r?\n\r?\n/g,"</p><p>").replace(/\r?\n/g,"<br />")+"</p>"}a(j.select("div.mcePaste"),function(a){j.remove(a)});if(e)i.setRng(e);f({content:c});j.unbind(b.getDoc(),"mousedown",n);j.unbind(b.getDoc(),"keydown",n)},0)}}if(c(b,"paste_auto_cleanup_on_paste")){if(tinymce.isOpera||/Firefox\/2/.test(navigator.userAgent)){b.onKeyDown.addToTop(function(a,b){if((tinymce.isMac?b.metaKey:b.ctrlKey)&&b.keyCode==86||b.shiftKey&&b.keyCode==45)g(b)})}else{b.onPaste.addToTop(function(a,b){return g(b)})}}b.onInit.add(function(){b.controlManager.setActive("pastetext",b.pasteAsPlainText);if(c(b,"paste_block_drop")){b.dom.bind(b.getBody(),["dragend","dragover","draggesture","dragdrop","drop","drag"],function(a){a.preventDefault();a.stopPropagation();return false})}});e._legacySupport()},getInfo:function(){return{longname:"Paste text/word",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/paste",version:tinymce.majorVersion+"."+tinymce.minorVersion}},_preProcess:function(b,d){var e=this.editor,f=d.content,g=tinymce.grep,h=tinymce.explode,i=tinymce.trim,j,k;function l(b){a(b,function(a){if(a.constructor==RegExp)f=f.replace(a,"");else f=f.replace(a[0],a[1])})}if(e.settings.paste_enable_default_filters==false){return}if(tinymce.isIE&&document.documentMode>=9&&/<(h[1-6r]|p|div|address|pre|form|table|tbody|thead|tfoot|th|tr|td|li|ol|ul|caption|blockquote|center|dl|dt|dd|dir|fieldset)/.test(d.content)){l([[/(?:<br>&nbsp;[\s\r\n]+|<br>)*(<\/?(h[1-6r]|p|div|address|pre|form|table|tbody|thead|tfoot|th|tr|td|li|ol|ul|caption|blockquote|center|dl|dt|dd|dir|fieldset)[^>]*>)(?:<br>&nbsp;[\s\r\n]+|<br>)*/g,"$1"]]);l([[/<br><br>/g,"<BR><BR>"],[/<br>/g," "],[/<BR><BR>/g,"<br>"]])}if(/class="?Mso|style="[^"]*\bmso-|w:WordDocument/i.test(f)||d.wordContent){d.wordContent=true;l([/^\s*(&nbsp;)+/gi,/(&nbsp;|<br[^>]*>)+\s*$/gi]);if(c(e,"paste_convert_headers_to_strong")){f=f.replace(/<p [^>]*class="?MsoHeading"?[^>]*>(.*?)<\/p>/gi,"<p><strong>$1</strong></p>")}if(c(e,"paste_convert_middot_lists")){l([[/<!--\[if !supportLists\]-->/gi,"$&__MCE_ITEM__"],[/(<span[^>]+(?:mso-list:|:\s*symbol)[^>]+>)/gi,"$1__MCE_ITEM__"],[/(<p[^>]+(?:MsoListParagraph)[^>]+>)/gi,"$1__MCE_ITEM__"]])}l([/<!--[\s\S]+?-->/gi,/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|img|meta|link|style|\w:\w+)(?=[\s\/>]))[^>]*>/gi,[/<(\/?)s>/gi,"<$1strike>"],[/&nbsp;/gi," "]]);do{j=f.length;f=f.replace(/(<[a-z][^>]*\s)(?:id|name|language|type|on\w+|\w+:\w+)=(?:"[^"]*"|\w+)\s?/gi,"$1")}while(j!=f.length);if(c(e,"paste_retain_style_properties").replace(/^none$/i,"").length==0){f=f.replace(/<\/?span[^>]*>/gi,"")}else{l([[/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(a,b){return b.length>0?b.replace(/./," ").slice(Math.floor(b.length/2)).split("").join(" "):""}],[/(<[a-z][^>]*)\sstyle="([^"]*)"/gi,function(b,c,d){var e=[],f=0,g=h(i(d).replace(/&quot;/gi,"'"),";");a(g,function(a){var b,c,d=h(a,":");function g(a){return a+(a!=="0"&&/\d$/.test(a))?"px":""}if(d.length==2){b=d[0].toLowerCase();c=d[1].toLowerCase();switch(b){case"mso-padding-alt":case"mso-padding-top-alt":case"mso-padding-right-alt":case"mso-padding-bottom-alt":case"mso-padding-left-alt":case"mso-margin-alt":case"mso-margin-top-alt":case"mso-margin-right-alt":case"mso-margin-bottom-alt":case"mso-margin-left-alt":case"mso-table-layout-alt":case"mso-height":case"mso-width":case"mso-vertical-align-alt":e[f++]=b.replace(/^mso-|-alt$/g,"")+":"+g(c);return;case"horiz-align":e[f++]="text-align:"+c;return;case"vert-align":e[f++]="vertical-align:"+c;return;case"font-color":case"mso-foreground":e[f++]="color:"+c;return;case"mso-background":case"mso-highlight":e[f++]="background:"+c;return;case"mso-default-height":e[f++]="min-height:"+g(c);return;case"mso-default-width":e[f++]="min-width:"+g(c);return;case"mso-padding-between-alt":e[f++]="border-collapse:separate;border-spacing:"+g(c);return;case"text-line-through":if(c=="single"||c=="double"){e[f++]="text-decoration:line-through"}return;case"mso-zero-height":if(c=="yes"){e[f++]="display:none"}return}if(/^(mso|column|font-emph|lang|layout|line-break|list-image|nav|panose|punct|row|ruby|sep|size|src|tab-|table-border|text-(?!align|decor|indent|trans)|top-bar|version|vnd|word-break)/.test(b)){return}e[f++]=b+":"+d[1]}});if(f>0){return c+' style="'+e.join(";")+'"'}else{return c}}]])}}if(c(e,"paste_convert_headers_to_strong")){l([[/<h[1-6][^>]*>/gi,"<p><strong>"],[/<\/h[1-6][^>]*>/gi,"</strong></p>"]])}l([[/Version:[\d.]+\nStartHTML:\d+\nEndHTML:\d+\nStartFragment:\d+\nEndFragment:\d+/gi,""]]);k=c(e,"paste_strip_class_attributes");if(k!=="none"){function m(a,b){if(k==="all")return"";var c=g(h(b.replace(/^(["'])(.*)\1$/,"$2")," "),function(a){return/^(?!mso)/i.test(a)});return c.length?' class="'+c.join(" ")+'"':""}f=f.replace(/ class="([^"]+)"/gi,m);f=f.replace(/ class=([\-\w]+)/gi,m)}if(c(e,"paste_remove_spans")){f=f.replace(/<\/?span[^>]*>/gi,"")}d.content=f},_postProcess:function(b,d){var e=this,f=e.editor,g=f.dom,h;if(f.settings.paste_enable_default_filters==false){return}if(d.wordContent){a(g.select("a",d.node),function(a){if(!a.href||a.href.indexOf("#_Toc")!=-1)g.remove(a,1)});if(c(f,"paste_convert_middot_lists")){e._convertLists(b,d)}h=c(f,"paste_retain_style_properties");if(tinymce.is(h,"string")&&h!=="all"&&h!=="*"){h=tinymce.explode(h.replace(/^none$/i,""));a(g.select("*",d.node),function(a){var b={},c=0,d,e,f;if(h){for(d=0;d<h.length;d++){e=h[d];f=g.getStyle(a,e);if(f){b[e]=f;c++}}}g.setAttrib(a,"style","");if(h&&c>0)g.setStyles(a,b);else if(a.nodeName=="SPAN"&&!a.className)g.remove(a,true)})}}if(c(f,"paste_remove_styles")||c(f,"paste_remove_styles_if_webkit")&&tinymce.isWebKit){a(g.select("*[style]",d.node),function(a){a.removeAttribute("style");a.removeAttribute("data-mce-style")})}else{if(tinymce.isWebKit){a(g.select("*",d.node),function(a){a.removeAttribute("data-mce-style")})}}},_convertLists:function(b,c){var d=b.editor.dom,e,f,g=-1,h,i=[],j,k;a(d.select("p",c.node),function(b){var c,k="",l,m,n,o;for(c=b.firstChild;c&&c.nodeType==3;c=c.nextSibling)k+=c.nodeValue;k=b.innerHTML.replace(/<\/?\w+[^>]*>/gi,"").replace(/&nbsp;/g," ");if(/^(__MCE_ITEM__)+[\u2022\u00b7\u00a7\u00d8o\u25CF]\s*\u00a0*/.test(k))l="ul";if(/^__MCE_ITEM__\s*\w+\.\s*\u00a0+/.test(k))l="ol";if(l){h=parseFloat(b.style.marginLeft||0);if(h>g)i.push(h);if(!e||l!=j){e=d.create(l);d.insertAfter(e,b)}else{if(h>g){e=f.appendChild(d.create(l))}else if(h<g){n=tinymce.inArray(i,h);o=d.getParents(e.parentNode,l);e=o[o.length-1-n]||e}}a(d.select("span",b),function(a){var b=a.innerHTML.replace(/<\/?\w+[^>]*>/gi,"");if(l=="ul"&&/^__MCE_ITEM__[\u2022\u00b7\u00a7\u00d8o\u25CF]/.test(b))d.remove(a);else if(/^__MCE_ITEM__[\s\S]*\w+\.(&nbsp;|\u00a0)*\s*/.test(b))d.remove(a)});m=b.innerHTML;if(l=="ul")m=b.innerHTML.replace(/__MCE_ITEM__/g,"").replace(/^[\u2022\u00b7\u00a7\u00d8o\u25CF]\s*(&nbsp;|\u00a0)+\s*/,"");else m=b.innerHTML.replace(/__MCE_ITEM__/g,"").replace(/^\s*\w+\.(&nbsp;|\u00a0)+\s*/,"");f=e.appendChild(d.create("li",0,m));d.remove(b);g=h;j=l}else e=g=0});k=c.node.innerHTML;if(k.indexOf("__MCE_ITEM__")!=-1)c.node.innerHTML=k.replace(/__MCE_ITEM__/g,"")},_insert:function(a,b){var c=this.editor,d=c.selection.getRng();if(!c.selection.isCollapsed()&&d.startContainer!=d.endContainer)c.getDoc().execCommand("Delete",false,null);c.execCommand("mceInsertContent",false,a,{skip_undo:b})},_insertPlainText:function(b){var d=this.editor,e=c(d,"paste_text_linebreaktype"),f=c(d,"paste_text_replacements"),g=tinymce.is;function h(c){a(c,function(a){if(a.constructor==RegExp)b=b.replace(a,"");else b=b.replace(a[0],a[1])})}if(typeof b==="string"&&b.length>0){if(/<(?:p|br|h[1-6]|ul|ol|dl|table|t[rdh]|div|blockquote|fieldset|pre|address|center)[^>]*>/i.test(b)){h([/[\n\r]+/g])}else{h([/\r+/g])}h([[/<\/(?:p|h[1-6]|ul|ol|dl|table|div|blockquote|fieldset|pre|address|center)>/gi,"\n\n"],[/<br[^>]*>|<\/tr>/gi,"\n"],[/<\/t[dh]>\s*<t[dh][^>]*>/gi,"\t"],/<[a-z!\/?][^>]*>/gi,[/&nbsp;/gi," "],[/(?:(?!\n)\s)*(\n+)(?:(?!\n)\s)*/gi,"$1"]]);var i=Number(c(d,"paste_max_consecutive_linebreaks"));if(i>-1){var j=new RegExp("\n{"+(i+1)+",}","g");var k="";while(k.length<i){k+="\n"}h([[j,k]])}b=d.dom.decode(tinymce.html.Entities.encodeRaw(b));if(g(f,"array")){h(f)}else if(g(f,"string")){h(new RegExp(f,"gi"))}if(e=="none"){h([[/\n+/g," "]])}else if(e=="br"){h([[/\n/g,"<br />"]])}else if(e=="p"){h([[/\n+/g,"</p><p>"],[/^(.*<\/p>)(<p>)$/,"<p>$1"]])}else{h([[/\n\n/g,"</p><p>"],[/^(.*<\/p>)(<p>)$/,"<p>$1"],[/\n/g,"<br />"]])}d.execCommand("mceInsertContent",false,b)}},_legacySupport:function(){var a=this,b=a.editor;b.addCommand("mcePasteWord",function(){b.windowManager.open({file:a.url+"/pasteword.htm",width:parseInt(c(b,"paste_dialog_width")),height:parseInt(c(b,"paste_dialog_height")),inline:1})});if(c(b,"paste_text_use_dialog")){b.addCommand("mcePasteText",function(){b.windowManager.open({file:a.url+"/pastetext.htm",width:parseInt(c(b,"paste_dialog_width")),height:parseInt(c(b,"paste_dialog_height")),inline:1})})}b.addButton("pasteword",{title:"paste.paste_word_desc",cmd:"mcePasteWord"})}});tinymce.PluginManager.add("paste",tinymce.plugins.PastePlugin)})();(function(){tinymce.create("tinymce.plugins.AutolinkPlugin",{init:function(a,b){var c=this;a.onCreateLink=new tinymce.util.Dispatcher(c);a.onKeyDown.addToTop(function(a,b){if(b.keyCode==13)return c.handleEnter(a)});if(tinyMCE.isIE){var d;a.onFocusOut.add(function(){if(!d){d=true;try{a.execCommand("AutoUrlDetect",false,true)}catch(a){}}});return}a.onKeyPress.add(function(a,b){if(b.keyCode==41)return c.handleEclipse(a)});a.onKeyUp.add(function(a,b){if(b.keyCode==32)return c.handleSpacebar(a)});a.onFocusOut.add(this.handleFocusOut.bind(this))},handleEclipse:function(a){this.parseCurrentLine(a,-1,"(",true)},handleSpacebar:function(a){this.parseCurrentLine(a,0,"",true)},handleEnter:function(a){this.parseCurrentLine(a,-1,"",false,true,true)},handleFocusOut:function(a){this.parseCurrentLine(a,-1,"",false,true)},parseCurrentLine:function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o;var p=a.dom;g=a.selection.getRng(true).cloneRange();j=g.endContainer;var q;if(q=z(j)){if(f){if(q.childNodes[0].nodeName=="IMG"){return}var r=q.parentNode;var s=q.nextSibling;var t=p.create("a");var u=p.create("a");A(q,t,g.startContainer,g.startOffset);A(q,u,g.endContainer,g.endOffset,true);r.removeChild(q);t.href=q.href;u.href=q.href;var v=document.createTextNode("");r.insertBefore(t,s);r.insertBefore(v,s);r.insertBefore(u,s);g.setEnd(v,0);g.setStart(v,0);a.selection.setRng(g)}return}if(g.startOffset<5){n=g.endContainer.previousSibling;if(n==null){if(g.endContainer.firstChild==null||g.endContainer.firstChild.nextSibling==null)return;n=g.endContainer.firstChild.nextSibling}o=n.length;g.setStart(n,o);g.setEnd(n,o);if(g.endOffset<5)return;h=g.endOffset;j=n}else{j=g.endContainer;if(j.nodeType!=3&&j.firstChild){while(j.nodeType!=3&&j.firstChild)j=j.firstChild;if(j.nodeType==3){g.setStart(j,0);g.setEnd(j,j.nodeValue.length)}}if(g.endOffset==1)h=2;else h=g.endOffset-1-b}if(j.nodeType!=3){return}i=h;var w=j.length;do{g.setStart(j,i<=w?i:w);g.setEnd(j,i<=w-1?i+1:w);i+=1}while(g.toString()!=" "&&g.toString()!=""&&g.toString().charCodeAt(0)!=160&&i<=w&&g.toString()!=c);i-=1;i=Math.min(i,w);do{g.setStart(j,h>=2?h-2:0);g.setEnd(j,h>=1?h-1:0);h-=1}while(g.toString()!=" "&&g.toString()!=""&&g.toString().charCodeAt(0)!=160&&h-2>=0&&g.toString()!=c);h=Math.max(h,0);if(g.toString()==c||g.toString().charCodeAt(0)==160){g.setStart(j,h);g.setEnd(j,i);h+=1}else if(g.startOffset==0){g.setStart(j,0);g.setEnd(j,i)}else{g.setStart(j,h);g.setEnd(j,i)}var l=g.toString();var x=l.match(/[^\wа-яё\/]+$/i);if(x&&x[0]){g.setEnd(j,l.length-x[0].length)}l=g.toString();m=l.match(/^(https?:\/\/|ssh:\/\/|ftp:\/\/|file:\/|www\.|(?:mailto:)?[A-Z0-9._%+-]+@)(.+)$/i);if(m){var y=m[1].toLowerCase();if(y==="www."){y="http://"+y}else if(/@$/.test(m[1])&&!/^mailto:/.test(y)){y="mailto:"+y}k=a.selection.getBookmark();a.selection.setRng(g);a.selection.setContent('<a href="'+a.dom.encode(y+m[2])+'">'+a.selection.getContent()+"</a>");a.onCreateLink.dispatch(a,l);if(e){tinyMCE.execCommand("mceInsertContent",false,"&nbsp;")}a.selection.moveToBookmark(k);a.nodeChanged()}function z(a){if(a.tagName!=="BODY"){if(a.tagName==="A"){return a}else{return z(a.parentNode)}}else{return null}}function A(a,b,c,d,e){if(e){var f=a.lastChild}else{var f=a.firstChild}while(f){if(f.nodeType===3){if(f===c){var g=f.cloneNode();if(e){g.textContent=f.textContent.slice(d,f.length);b.insertBefore(g,b.firstChild)}else{g.textContent=f.textContent.slice(0,d);b.appendChild(g)}return true}else{var g=f.cloneNode(true);if(e){b.insertBefore(g,b.firstChild)}else{b.appendChild(g)}}}else{var g=f.cloneNode();if(e){b.insertBefore(g,b.firstChild)}else{b.appendChild(g)}if(A(f,g,c,d,e)){return true}}if(e){f=f.previousSibling}else{f=f.nextSibling}}}},getInfo:function(){return{longname:"Autolink",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/autolink",version:tinymce.majorVersion+"."+tinymce.minorVersion}}});tinymce.PluginManager.add("autolink",tinymce.plugins.AutolinkPlugin)})();(function(){tinymce.PluginManager.requireLangPack("emoji");tinymce.create("tinymce.plugins.Emoji",{parseDebounce:null,init:function(a,b){var c=a.getParam("emoji_lib");var d=!!a.getParam("emoji_needReplace");var e=function(a,b){var d=a.selection.getBookmark();c.replace(a.contentDocument);tinymce.$(a.contentDocument).find("img.emoji").addClass("mceItemNoResize").attr("unselectable","on");a.selection.moveToBookmark(d)};if(d){a.onSetContent.add(e);a.onChange.add(e);a.onGetContent.add(function(a,b){if(b.format!=="text"){var c=$("<div />");var d=0;var e="";c[0].innerHTML=b.content;c.find("img.emoji").each(function(a,b){if(!b.hasAttribute("alt")){return true}e=b.getAttribute("alt");if(!tinymce.DOM.escapeAndCompare(e)){return true}d++;$(b).replaceWith(e)});if(d){b.content=c.html()}}})}},createControl:function(a,b){if(a!=="emoji")return null;var c=b.editor.settings;var d={title:"compose.emotions_desc",cmd:"Emoji",class:"mce_emotions",scope:b};return b.createEmotionsSplitButton("emoji",d,tinymce.ui.EmojiSplitButton)},getInfo:function(){return{longname:"Emoji plugin",author:"Andrew Tereshko",authorurl:"http://sys.mail.ru/",version:"0.1"}}});tinymce.PluginManager.add("emoji",tinymce.plugins.Emoji)})();(function(a){var b=a.DOM,c=a.dom.Event,d=a.is,e=a.each;a.create("tinymce.ui.EmojiSplitButton:tinymce.ui.SplitButton",{emojiList:[{list:["😄","😃","😀","😊","☺","😉","😍","😘","😚","😗","😙","😜","😝","😛","😳","😁","😔","😌","😒","😞","😣","😢","😂","😭","😪","😥","😰","😅","😓","😩","😫","😨","😱","😠","😡","😤","😖","😆","😋","😷","😎","😴","😵","😲","😟","😦","😧","😈","👿","😮","😬","😐","😕","😯","😶","😇","😏","😑","👲","👳","👮","👷","💂","👶","👦","👧","👨","👩","👴","👵","👱","👼","👸","😺","😸","😻","😽","😼","🙀","😿","😹","😾","👹","👺","🙈","🙉","🙊","💀","👽","💩","🔥","✨","🌟","💫","💥","💢","💦","💧","💤","💨","👂","👀","👃","👅","👄","👍","👎","👌","👊","✊","✌","👋","✋","👐","👆","👇","👉","👈","🙌","🙏","☝","👏","💪","🚶","🏃","💃","👫","👪","👬","👭","💏","💑","👯","🙆","🙅","💁","🙋","💆","💇","💅","👰","🙎","🙍","🙇","🎩","👑","👒","👟","👞","👡","👠","👢","👕","👔","👚","👗","🎽","👖","👘","👙","💼","👜","👝","👛","👓","🎀","🌂","💄","💛","💙","💜","💚","❤","💔","💗","💓","💕","💖","💞","💘","💌","💋","💍","💎","👤","👥","💬","👣","💭"]},{list:["🐶","🐺","🐱","🐭","🐹","🐰","🐸","🐯","🐨","🐻","🐷","🐽","🐮","🐗","🐵","🐒","🐴","🐑","🐘","🐼","🐧","🐦","🐤","🐥","🐣","🐔","🐍","🐢","🐛","🐝","🐜","🐞","🐌","🐙","🐚","🐠","🐟","🐬","🐳","🐋","🐄","🐏","🐀","🐃","🐅","🐇","🐉","🐎","🐐","🐓","🐕","🐖","🐁","🐂","🐲","🐡","🐊","🐫","🐪","🐆","🐈","🐩","🐾","💐","🌸","🌷","🍀","🌹","🌻","🌺","🍁","🍃","🍂","🌿","🌾","🍄","🌵","🌴","🌲","🌳","🌰","🌱","🌼","🌐","🌞","🌝","🌚","🌑","🌒","🌓","🌔","🌕","🌖","🌗","🌘","🌜","🌛","🌙","🌍","🌎","🌏","🌋","🌌","🌠","⭐","☀","⛅","☁","⚡","☔","❄","⛄","🌀","🌁","🌈","🌊"]},{list:["🎍","💝","🎎","🎒","🎓","🎏","🎆","🎇","🎐","🎑","🎃","👻","🎅","🎄","🎁","🎋","🎉","🎊","🎈","🎌","🔮","🎥","📷","📹","📼","💿","📀","💽","💾","💻","📱","☎","📞","📟","📠","📡","📺","📻","🔊","🔉","🔈","🔇","🔔","🔕","📢","📣","⏳","⌛","⏰","⌚","🔓","🔒","🔏","🔐","🔑","🔎","💡","🔦","🔆","🔅","🔌","🔋","🔍","🛁","🛀","🚿","🚽","🔧","🔩","🔨","🚪","🚬","💣","🔫","🔪","💊","💉","💰","💴","💵","💷","💶","💳","💸","📲","📧","📥","📤","✉","📩","📨","📯","📫","📪","📬","📭","📮","📦","📝","📄","📃","📑","📊","📈","📉","📜","📋","📅","📆","📇","📁","📂","✂","📌","📎","✒","✏","📏","📐","📕","📗","📘","📙","📓","📔","📒","📚","📖","🔖","📛","🔬","🔭","📰","🎨","🎬","🎤","🎧","🎼","🎵","🎶","🎹","🎻","🎺","🎷","🎸","👾","🎮","🃏","🎴","🀄","🎲","🎯","🏈","🏀","⚽","⚾","🎾","🎱","🏉","🎳","⛳","🚵","🚴","🏁","🏇","🏆","🎿","🏂","🏊","🏄","🎣","☕","🍵","🍶","🍼","🍺","🍻","🍸","🍹","🍷","🍴","🍕","🍔","🍟","🍗","🍖","🍝","🍛","🍤","🍱","🍣","🍥","🍙","🍘","🍚","🍜","🍲","🍢","🍡","🍳","🍞","🍩","🍮","🍦","🍨","🍧","🎂","🍰","🍪","🍫","🍬","🍭","🍯","🍎","🍏","🍊","🍋","🍒","🍇","🍉","🍓","🍑","🍈","🍌","🍐","🍍","🍠","🍆","🍅","🌽"]},{list:["🏠","🏡","🏫","🏢","🏣","🏥","🏦","🏪","🏩","🏨","💒","⛪","🏬","🏤","🌇","🌆","🏯","🏰","⛺","🏭","🗼","🗾","🗻","🌄","🌅","🌃","🗽","🌉","🎠","🎡","⛲","🎢","🚢","⛵","🚤","🚣","⚓","🚀","✈","💺","🚁","🚂","🚊","🚉","🚞","🚆","🚄","🚅","🚈","🚇","🚝","🚋","🚃","🚎","🚌","🚍","🚙","🚘","🚗","🚕","🚖","🚛","🚚","🚨","🚓","🚔","🚒","🚑","🚐","🚲","🚡","🚟","🚠","🚜","💈","🚏","🎫","🚦","🚥","⚠","🚧","🔰","⛽","🏮","🎰","♨","🗿","🎪","🎭","📍","🚩",""]},{list:["🔟","🔢","🔣","⬆","⬇","⬅","➡","🔠","🔡","🔤","↗","↖","↘","↙","↔","↕","🔄","◀","▶","🔼","🔽","↩","↪","ℹ","⏪","⏩","⏫","⏬","⤵","⤴","🆗","🔀","🔁","🔂","🆕","🆙","🆒","🆓","🆖","📶","🎦","🈁","🈯","🈳","🈵","🈴","🈲","🉐","🈹","🈺","🈶","🈚","🚻","🚹","🚺","🚼","🚾","🚰","🚮","🅿","♿","🚭","🈷","🈸","🈂","Ⓜ","🛂","🛄","🛅","🛃","🉑","㊙","㊗","🆑","🆘","🆔","🚫","🔞","📵","🚯","🚱","🚳","🚷","🚸","⛔","✳","❇","❎","✅","✴","💟","🆚","📳","📴","🅰","🅱","🆎","🅾","💠","➿","♻","♈","♉","♊","♋","♌","♍","♎","♏","♐","♑","♒","♓","⛎","🔯","🏧","💹","💲","💱","❌","‼","⁉","❗","❓","❕","❔","⭕","🔝","🔚","🔙","🔛","🔜","🔃","🕛","🕧","🕐","🕜","🕑","🕝","🕒","🕞","🕓","🕟","🕔","🕠","🕕","🕖","🕗","🕘","🕙","🕚","🕡","🕢","🕣","🕤","🕥","🕦","✖","➕","➖","➗","♠","♥","♣","♦","💮","💯","✔","☑","🔘","🔗","➰","〰","〽","🔱","◼","◻","◾","◽","▪","▫","🔺","🔲","🔳","⚫","⚪","🔴","🔵","🔻","⬜","⬛","🔶","🔷","🔸","🔹"]},{list:["🇨🇳","🇫🇷","🇩🇪","🇮🇹","🇯🇵","🇷🇺","🇰🇷","🇪🇸","🇬🇧","🇺🇸"]},{list:["🇦","🇧","🇨","🇩","🇪","🇫","🇬","🇭","🇮","🇯","🇰","🇱","🇲","🇳","🇴","🇵","🇶","🇷","🇸","🇹","🇺","🇻","🇼","🇽","🇾","🇿","⬜","▪","❗","❓"]}],EmojiSplitButton:function(b,c){var d=this;d.parent(b,c);d.onShowMenu=new a.util.Dispatcher(d);d.onChangeTab=new a.util.Dispatcher(d);d.onHideMenu=new a.util.Dispatcher(d);var e=d.scope.editor.getLang("compose.smiles");d.smiles=[{title:e[0].title,imgPrefix:"//img.imgsmail.ru/ru/btn/kolobki/",list:e[0].list}]},showMenu:function(){var a=this,d,e,f,g;if(a.isDisabled())return;if(!a.isMenuRendered){a.renderMenu();a.isMenuRendered=true}if(a.isMenuVisible)return a.hideMenu();f=b.get(a.id);b.show(a.id+"_menu");b.addClass(f,"mceSplitButtonSelected");f=0;c.add(b.doc,"mousedown",a.hideMenu,a);a.onShowMenu.dispatch(a);if(a._focused){a._keyHandler=c.add(a.id+"_menu","keydown",function(b){if(b.keyCode==27)a.hideMenu()});b.select("a",a.id+"_menu")[0].focus()}a.isMenuVisible=1},hideMenu:function(a){var d=this;if(a&&a.type=="mousedown"&&b.getParent(a.target,function(a){return a.id===d.id+"_action"}))return;if(!a||!b.getParent(a.target,".mceSplitButtonMenu")){this.emojiWrapper&&(this.emojiWrapper.scrollTop=0);b.removeClass(d.id,"mceSplitButtonSelected");c.remove(b.doc,"mousedown",d.hideMenu,d);c.remove(d.id+"_menu","keydown",d._keyHandler);b.hide(d.id+"_menu")}d.onHideMenu.dispatch(d);d.isMenuVisible=0},renderMenu:function(){var a=this.scope.editor;var d=!!a.getParam("emoji_needReplace");var e=b.add(b.get(this.id+"_action").parentNode,"div",{id:this.id+"_menu",class:this.settings["menu_class"]+" mce-emoji-menu",style:"position:absolute;"});var f=this.emojiWrapper=b.add(e,"div",{class:"mce-emoji-menu__wrap"});var g=this.emojiList.length;var h;var i;var j;try{j=JSON.parse(window.localStorage.getItem("mce_emoji_last-used"))}catch(a){}j=j||[];var k=b.add(f,"div",{class:"mce-emoji-menu__wrap__group mce-emoji-menu__wrap__group_bordered",style:j.length?"":"display: none"},this.getEmotionsHTML(j));for(h=0;h<g;h++){i=this.emojiList[h];b.add(f,"div",{class:"mce-emoji-menu__wrap__group"},this.getEmotionsHTML(i.list))}c.add(e,"click",function(b){var c=b.target.nodeName==(d?"IMG":"A");var e=c&&(d?b.target.alt:b.target.innerText);var f;if(e){a.execCommand("mceInsertContent",false,e);this.hideMenu();(f=j.indexOf(e))>-1&&j.splice(f,1);j.unshift(e);j=j.slice(0,10);try{window.localStorage.setItem("mce_emoji_last-used",JSON.stringify(j));k.style.display="";k.innerHTML=this.getEmotionsHTML(j)}catch(b){}}},this);c.add(e,"mousedown",function(a){return c.cancel(a)});c.add(this.id+"_menu","click",function(a){return c.cancel(a)});return e},getEmotionsHTML:function(a){var c=this.scope.editor.getParam("emoji_lib");var d=!!this.scope.editor.getParam("emoji_needReplace");var e=(this.scope.editor.getParam("emoji_exclude")||"").split(",");var f="";var g=a&&a.length;var h;var i;var j;for(h=0;h<g;h++){i=a[h];if(e.indexOf(i)>-1)continue;if(!b.escapeAndCompare(i))continue;if(d){j=c.replace(i);j=j.replace(/\/?>/g,' title="" onclick="return false;" onmousedown="return false;"/>')}else{j='<a href="#" title="" onclick="return false;" onmousedown="return false;" class="emoji">'+i+"</a>"}f+=j}return f},postRender:function(){var a=this,b=a.id;a.parent()},destroy:function(){this.parent();c.clear(this.id+"_menu");c.clear(this.id+"_more");b.remove(this.id+"_menu")}})})(tinymce);(function(){tinymce.create("tinymce.plugins.InlineAttach",{init:function(a,b){},createControl:function(a,b){if(a!=="inlineattach")return null;var c=b.editor.settings;var d={title:"compose.inlineattach_desc",cmd:"InlineAttach",class:"mce_inlineattach",scope:b};return b.createMenuButton("inlineattach",d,tinymce.ui.InlineAttachButton)},getInfo:function(){return{longname:"Inline attach plugin",author:"Mail.Ru",authorurl:"http://sys.mail.ru/",version:"0.1"}}});tinymce.PluginManager.add("inlineattach",tinymce.plugins.InlineAttach)})();(function(a){var b=a.DOM,c=a.dom.Event,d=a.is,e=a.each;a.create("tinymce.ui.InlineAttachButton:tinymce.ui.MenuButton",{InlineAttachButton:function(a,b,c){var d=this;d.parent(a,b,c);d.title=b.title},renderHTML:function(){return this._renderInput()+this.parent()},_renderInput:function(){return'<div class="mce-input-holder">'+'<input name="inlinefiles" type="file" title="'+this.title+'" class="js-inline-input-file mce-input-file"/>'+"</div>"},postRender:function(){},destroy:function(){this.parent()}})})(tinymce);(function(a){var b=a.DOM,c=a.dom.Event,d=a.extend,e=a.each,f=a.util.Cookie,g,h=a.explode;a.create("tinymce.themes.ComposeTheme",{sizes:[10,12,16,20,24,30,48],controls:{bold:["bold_desc","Bold"],italic:["italic_desc","Italic"],underline:["underline_desc","Underline"],strikethrough:["striketrough_desc","Strikethrough"],justifyleft:["justifyleft_desc","JustifyLeft"],justifycenter:["justifycenter_desc","JustifyCenter"],justifyright:["justifyright_desc","JustifyRight"],justifyfull:["justifyfull_desc","JustifyFull"],bullist:["bullist_desc","InsertUnorderedList"],numlist:["numlist_desc","InsertOrderedList"],outdent:["outdent_desc","Outdent"],indent:["indent_desc","Indent"],cut:["cut_desc","Cut"],copy:["copy_desc","Copy"],paste:["paste_desc","Paste"],undo:["undo_desc","Undo"],redo:["redo_desc","Redo"],addlink:["link_desc","mceLink"],unlink:["unlink_desc","unlink"],image:["image_desc","mceImage"],cleanup:["cleanup_desc","mceCleanup"],help:["help_desc","mceHelp"],code:["code_desc","mceCodeEditor"],hr:["hr_desc","InsertHorizontalRule"],removeformat:["removeformat_desc","RemoveFormat"],sub:["sub_desc","subscript"],sup:["sup_desc","superscript"],forecolor:["forecolor_desc","ForeColor"],forecolorpicker:["forecolor_desc","mceForeColor"],backcolor:["backcolor_desc","HiliteColor"],backcolorpicker:["backcolor_desc","mceBackColor"],charmap:["charmap_desc","mceCharMap"],visualaid:["visualaid_desc","mceToggleVisualAid"],anchor:["anchor_desc","mceInsertAnchor"],newdocument:["newdocument_desc","mceNewDocument"],blockquote:["blockquote_desc","mceBlockQuote"],justifyselect:["justifyselect_desc","JustifySelect"],moreactions:["moreactions_desc","MoreActions"],fontactions:["fontactions_desc","FontActions"],textindentactions:["textindentactions_desc","TextIndentActions"],bullistactions:["bullistactions_desc","bullistActions"],signature:["signature_desc","mceSignature"],design:["design_desc","mceDesign"],cards:["cards_desc","mceCards"],apptransfer:["apptransfer_desc","mceAppTransfer"],appkeyboard:["appkeyboard_desc","mceAppKeyboard"],apptranslit:["apptranslit_desc","mceAppTranslit"],appspelling:["appspelling_desc","mceAppSpelling"],apptransfer2:["apptransfer_desc","mceAppTransfer"],appkeyboard2:["appkeyboard_desc","mceAppKeyboard"],apptranslit2:["apptranslit_desc","mceAppTranslit"],appspelling2:["appspelling_desc","mceAppSpelling"],moreapps:["appmoreapps_desc","moreApps"],enableTextEditor:["enabletexteditor_desc","mceEnableTextEditor"],enableHTMLEditor:["enablehtmleditor_desc","mceEnableHTMLEditor"]},stateControls:["bold","italic","underline","strikethrough","bullist","numlist","justifyleft","justifycenter","justifyright","justifyfull","sub","sup","blockquote"],init:function(c,f){var g=this,h,i,j;g.editor=c;g.url=f;g.onResolveName=new a.util.Dispatcher(this);g.settings=h=d({theme_compose_path:true,theme_compose_toolbar_location:"bottom",theme_compose_buttons1:"bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,styleselect,formatselect",theme_compose_buttons2:"bullist,numlist,|,outdent,indent,|,undo,redo,|,link,unlink,anchor,image,cleanup,help,code",theme_compose_buttons3:"hr,removeformat,visualaid,|,sub,sup,|,charmap",theme_compose_blockformats:"p,address,pre,h1,h2,h3,h4,h5,h6",theme_compose_toolbar_align:"center",theme_compose_fonts:"Andale Mono=andale mono,times;Arial=arial,helvetica,sans-serif;Arial Black=arial black,avant garde;Book Antiqua=book antiqua,palatino;Comic Sans MS=comic sans ms,sans-serif;Courier New=courier new,courier;Georgia=georgia,palatino;Helvetica=helvetica;Impact=impact,chicago;Symbol=symbol;Tahoma=tahoma,arial,helvetica,sans-serif;Times New Roman=times new roman,times;Trebuchet MS=trebuchet ms,geneva;Verdana=verdana,geneva;Webdings=webdings;Wingdings=wingdings,zapf dingbats",theme_compose_more_colors:1,theme_compose_row_height:23,theme_compose_resize_horizontal:1,theme_compose_resizing_use_cookie:false,theme_compose_font_sizes:"1,2,3,4,5,6,7",readonly:c.settings.readonly},c.settings);if(!h.font_size_style_values)h.font_size_style_values="8pt,10pt,12pt,14pt,18pt,24pt,36pt";if(a.is(h.theme_compose_font_sizes,"string")){h.font_size_style_values=a.explode(h.font_size_style_values);h.font_size_classes=a.explode(h.font_size_classes||"");j={};c.settings.theme_compose_font_sizes=h.theme_compose_font_sizes;e(c.getParam("theme_compose_font_sizes","","hash"),function(a,b){var c;if(b==a&&a>=1&&a<=7){b=a;c=h.font_size_classes[a-1];a=h.font_size_style_values[a-1]||g.sizes[a-1]+"pt"}if(/^\s*\./.test(a))c=a.replace(/\./g,"");j[b]=c?{class:c}:{fontSize:a}});h.theme_compose_font_sizes=j}if((i=h.theme_compose_path_location)&&i!="none")h.theme_compose_statusbar_location=h.theme_compose_path_location;if(h.theme_compose_statusbar_location=="none")h.theme_compose_statusbar_location=0;c.onInit.add(function(){if(!c.settings.readonly)c.onNodeChange.add(g._nodeChanged,g)});c.onSetProgressState.add(function(a,c,d){var e,f=a.id,h;if(c){g.progressTimer=setTimeout(function(){e=a.getContainer();e=e.insertBefore(b.create("DIV",{style:"position:relative"}),e.firstChild);h=b.get(a.id+"_tbl");b.add(e,"div",{id:f+"_blocker",class:"mceBlocker",style:{width:h.clientWidth+2,height:h.clientHeight+2}});b.add(e,"div",{id:f+"_progress",class:"mceProgress",style:{left:h.clientWidth/2,top:h.clientHeight/2}})},d||0)}else{b.remove(f+"_blocker");b.remove(f+"_progress");clearTimeout(g.progressTimer)}})},createControl:function(a,b,c){var d,e;if(e=b.createControl(a))return e;switch(a){case"styleselect":return this._createStyleSelect();case"formatselect":return this._createBlockFormats();case"fontselect":return this._createFontSelect();case"fontsizeselect":return this._createFontSizeSelect();case"forecolor":return this._createForeColorMenu();case"emotions":return this._createEmotionsMenu();case"inlineattach":return this._createInlineAttachButton();case"backcolor":return this._createBackColorMenu();case"justifyselect":return this._createJustifySelectMenu();case"moreactions":return this._createMoreActionsMenu(c);case"fontactions":return this._createFontActionsMenu();case"textindentactions":return this._createTextIndentActionsMenu();case"bullistactions":return this._createBullistActionsMenu();case"signature":return this._createSignatureButton();case"design":case"cards":if(d=this.controls[a]){return b.createButton(a,{cmd:d[1],ui:d[2],value:d[3],link:this.editor.getLang("compose."+d[0])})}break;case"enableTextEditor":if(d=this.controls[a]){return b.createButton(a,{cmd:d[1],ui:d[2],value:d[3],link:this.editor.getLang("compose."+d[0]),linkPosition:"left",linkAlign:"left"})}break;case"enableHTMLEditor":if(d=this.controls[a]){return b.createButton(a,{title:"compose."+d[0],cmd:d[1],ui:d[2],value:d[3],link:this.editor.getLang("compose."+d[0]),linkPosition:"right",linkAlign:"right"})}break}if(d=this.controls[a])return b.createButton(a,{title:"compose."+d[0],cmd:d[1],ui:d[2],value:d[3]})},execCommand:function(a,b,c){var d=this["_"+a];if(d){d.call(this,b,c);return true}return false},_importClasses:function(a){var b=this.editor,c=b.controlManager.get("styleselect");if(c.getLength()==0){e(b.dom.getClasses(),function(a,d){var e="style_"+d;b.formatter.register(e,{inline:"span",attributes:{class:a["class"]},selector:"*"});c.add(a["class"],e)})}},_createStyleSelect:function(a){var b=this,d=b.editor,f=d.controlManager,g;g=f.createListBox("styleselect",{title:"compose.style_select",onselect:function(a){var b,c=[];e(g.items,function(a){c.push(a.value)});d.focus();d.undoManager.add();b=d.formatter.matchAll(c);if(!a||b[0]==a){if(b[0])d.formatter.remove(b[0])}else d.formatter.apply(a);d.undoManager.add();d.nodeChanged();return false}});d.onInit.add(function(){var a=0,c=d.getParam("style_formats");if(c){e(c,function(b){var c,f=0;e(b,function(){f++});if(f>1){c=b.name=b.name||"style_"+a++;d.formatter.register(c,b);g.add(b.title,c)}else g.add(b.title)})}else{e(d.getParam("theme_compose_styles","","hash"),function(c,e){var f;if(c){f="style_"+a++;d.formatter.register(f,{inline:"span",classes:c,selector:"*"});g.add(b.editor.translate(e),f)}})}});if(g.getLength()==0){g.onPostRender.add(function(a,d){if(!g.NativeListBox){c.add(d.id+"_text","focus",b._importClasses,b);c.add(d.id+"_text","mousedown",b._importClasses,b);c.add(d.id+"_open","focus",b._importClasses,b);c.add(d.id+"_open","mousedown",b._importClasses,b)}else c.add(d.id,"focus",b._importClasses,b)})}return g},_createFontSelect:function(){var a,b=this,c=b.editor;a=c.controlManager.createListBox("fontselect",{title:"compose.fontdefault",onselect:function(b){var d=a.items[a.selectedIndex];if(!b&&d){c.execCommand("FontName",false,d.value);return null}c.execCommand("FontName",false,b);a.select(function(a){return b==a});return false}});if(a){e(c.getParam("theme_compose_fonts",b.settings.theme_compose_fonts,"hash"),function(b,d){a.add(c.translate(d),b,{style:b.indexOf("dings")==-1?"font-family:"+b:""})})}return a},_createFontSizeSelect:function(){var a=this,b=a.editor,c,d=0,f=[];c=b.controlManager.createListBox("fontsizeselect",{title:"compose.font_size",onselect:function(a){var d=c.items[c.selectedIndex];if(!a&&d){d=d.value;if(d["class"]){b.formatter.toggle("fontsize_class",{value:d["class"]});b.undoManager.add();b.nodeChanged()}else{b.execCommand("FontSize",false,d.fontSize)}return null}if(a["class"]){b.focus();b.undoManager.add();b.formatter.toggle("fontsize_class",{value:a["class"]});b.undoManager.add();b.nodeChanged()}else b.execCommand("FontSize",false,a.fontSize);c.select(function(b){return a==b});return false}});if(c){e(a.settings.theme_compose_font_sizes,function(b,e){var f=b.fontSize;if(f>=1&&f<=7)f=a.sizes[parseInt(f)-1]+"pt";c.add(e,b,{style:"font-size:"+f,class:"mceFontSize"+d+++(" "+(b["class"]||""))})})}return c},_createBlockFormats:function(){var a,b={p:"compose.paragraph",address:"compose.address",pre:"compose.pre",h1:"compose.h1",h2:"compose.h2",h3:"compose.h3",h4:"compose.h4",h5:"compose.h5",h6:"compose.h6",div:"compose.div",blockquote:"compose.blockquote",code:"compose.code",dt:"compose.dt",dd:"compose.dd",samp:"compose.samp"},c=this;a=c.editor.controlManager.createListBox("formatselect",{title:"compose.block",cmd:"FormatBlock"});if(a){e(c.editor.getParam("theme_compose_blockformats",c.settings.theme_compose_blockformats,"hash"),function(d,e){a.add(c.editor.translate(e!=d?e:b[d]),d,{class:"mce_formatPreview mce_"+d})})}return a},_createFontActionsMenu:function(){var a,c=this,d=c.settings,f=0,g={},h,i=c.editor;g.title="compose.fontactions_desc";g.scope=this;var j=i.controlManager.createDropMenu("fontsizeselect",{menu_line:1,id:"fontsizeselect",relative:true,title:i.getLang("compose.font_size")});j.select=function(a){e(j.items,function(a){a.setSelected(false)});if(a){e(j.items,function(b){if(a(b.settings.value)){b.setSelected(true);return false}})}};e(c.settings.theme_compose_font_sizes,function(a,d){var g=a.fontSize;if(g>=1&&g<=7)g=c.sizes[parseInt(g)-1]+"px";if(f==2)d+=" "+i.getLang("compose.font_normal_label");var h={title:d,value:a,style:"font-size:"+g,class:"mceFontSize"+f+++(" "+(a["class"]||""))};h.id=b.uniqueId();h.onclick=function(b){e(j.items,function(a){a.setSelected(false)});var c=b.getAttribute("id");var d=j.items[c];d.setSelected(true);i.execCommand("FontSize",false,d.settings.value.fontSize);j.select(function(b){return a==b});return false};j.add(h)});var k=i.controlManager.createDropMenu("fontselect",{menu_line:1,id:"fontselect",relative:true,title:i.getLang("compose.fontdefault")});k.select=function(a){e(k.items,function(a){a.setSelected(false)});if(a){e(k.items,function(b){if(a(b.settings.value)){b.setSelected(true);return false}})}};e(c.editor.getParam("theme_compose_fonts",c.settings.theme_compose_fonts,"hash"),function(a,c){var d={title:i.translate(c),value:a,style:a.indexOf("dings")==-1?"font-family:"+a:""};d.id=b.uniqueId();d.onclick=function(b){e(k.items,function(a){a.setSelected(false)});var c=b.getAttribute("id");var d=k.items[c];d.setSelected(true);i.execCommand("FontName",false,d.settings.value);k.select(function(b){return a==b});return false};k.add(d)});g.controls=[j,k];a=i.controlManager.createFontButton("fontactions",g);return a},_createTextIndentActionsMenu:function(){var a,b=this,c=b.settings,d={},e;d.title="compose.textindentactions_desc";d.scope=this;d.controls=["outdent","indent"];a=b.editor.controlManager.createControlsButton("textindentactions",d);return a},_createSignatureButton:function(){var a,b=this,c=b.settings,d={},e;d.title="compose.signature_desc";d.link=b.editor.getLang(d.title);d.title=null;d.cmd="mceSignature";d.scope=this;d.onclick=function(){this.execCommand(d.cmd,false,a.isActive())};a=b.editor.controlManager.createSignatureButton("signature",d);return a},_createBullistActionsMenu:function(){var a,b=this,c=b.settings,d={},e;d.title="compose.bullistactions_desc";d.scope=this;d.controls=["numlist","bullist"];a=b.editor.controlManager.createControlsButton("bullistactions",d);return a},_createMoreActionsMenu:function(a){var b,c=this,d=c.settings,e={},f;e.link=c.editor.getLang("compose.more");e.scope=this;e.linkPosition="right";e.expandControls=[];e.controls=[];if(d.moreactions_controls){e.expandControls=d.moreactions_controls.expand_controls;e.controls=d.moreactions_controls.controls}b=c.editor.controlManager.createControlsButton("moreactions",e);return b},_createJustifySelectMenu:function(){var a,b=this,c={};c.title="compose.justifyselect_desc";c.scope=this;c.controls=["justifyleft","justifycenter","justifyright"];a=b.editor.controlManager.createControlsButton("justifyselect",c);return a},_createEmotionsMenu:function(){var a,b=this,c=b.settings,d={},e;d.title="compose.emotions_desc";d.cmd="ForeColor";d.scope=this;a=b.editor.controlManager.createEmotionsSplitButton("emotions",d);return a},_createInlineAttachButton:function(){var a,b=this,c=b.settings,d={},e;d.title="compose.inlineattach_desc";d.cmd="InlineAttach";d.scope=this;a=b.editor.controlManager.createButton("inlineattach",d);return a},_createForeColorMenu:function(){var a,b=this,c=b.settings,d={},e;if(c.theme_compose_more_colors){d.more_colors_func=function(){b._mceColorPicker(0,{color:a.value,func:function(b){a.setColor(b)}})}}if(e=c.theme_compose_text_colors)d.colors=e;if(c.theme_compose_default_foreground_color)d.default_color=c.theme_compose_default_foreground_color;d.title="compose.forecolor_desc";d.cmd="ForeColor";d.scope=this;a=b.editor.controlManager.createColorSplitButton("forecolor",d);return a},_createBackColorMenu:function(){var a,b=this,c=b.settings,d={},e;if(e=c.theme_compose_background_colors)d.colors=e;if(c.theme_compose_default_background_color)d.default_color=c.theme_compose_default_background_color;d.title="compose.backcolor_desc";d.cmd="HiliteColor";d.scope=this;a=b.editor.controlManager.createColorSplitButton("backcolor",d);return a},renderUI:function(a){var d,f,g,h=this,i=h.editor,j=h.settings,k,l,m;d=l=b.create("span",{id:i.id+"_parent",class:"mceEditor "+i.settings.skin+"Skin"+(j.skin_variant?" "+i.settings.skin+"Skin"+h._ufirst(j.skin_variant):"")});if(!b.boxModel)d=b.add(d,"div",{class:"mceOldBoxModel"});d=k=b.add(d,"table",{id:i.id+"_tbl",class:"mceLayout",cellSpacing:0,cellPadding:0});d=g=b.add(d,"tbody");switch((j.theme_compose_layout_manager||"").toLowerCase()){case"rowlayout":f=h._rowLayout(j,g,a);break;case"customlayout":f=i.execCallback("theme_compose_custom_layout",j,g,a,l);break;default:f=h._simpleLayout(j,g,a,l)}d=a.targetNode;m=b.stdMode?k.getElementsByTagName("tr"):k.rows;b.addClass(m[0],"mceFirst");b.addClass(m[m.length-1],"mceLast");e(b.select("tr",g),function(a){b.addClass(a.firstChild,"mceFirst");b.addClass(a.childNodes[a.childNodes.length-1],"mceLast")});if(b.get(j.theme_compose_toolbar_container))b.get(j.theme_compose_toolbar_container).appendChild(l);else b.insertAfter(l,d);c.add(i.id+"_path_row","click",function(a){a=a.target;if(a.nodeName=="A"){h._sel(a.className.replace(/^.*mcePath_([0-9]+).*$/,"$1"));return c.cancel(a)}});if(!i.getParam("accessibility_focus"))c.add(b.add(l,"a",{href:"#"},"\x3c!-- IE --\x3e"),"focus",function(){tinyMCE.get(i.id).focus()});if(j.theme_compose_toolbar_location=="external")a.deltaHeight=0;h.deltaHeight=a.deltaHeight;a.targetNode=null;return{iframeContainer:f,editorContainer:i.id+"_parent",sizeContainer:k,deltaHeight:a.deltaHeight}},resizeBy:function(a,c){var d=b.get(this.editor.id+"_tbl");this.resizeTo(d.clientWidth+a,d.clientHeight+c)},resizeTo:function(a,c){var d=this.editor,e=this.settings,f=b.get(d.id+"_tbl"),g=b.get(d.id+"_ifr");a=Math.max(e.theme_compose_resizing_min_width||100,a);c=Math.max(e.theme_compose_resizing_min_height||100,c);a=Math.min(e.theme_compose_resizing_max_width||65535,a);c=Math.min(e.theme_compose_resizing_max_height||65535,c);b.setStyle(f,"height","");b.setStyle(g,"height",c);if(e.theme_compose_resize_horizontal){b.setStyle(f,"width","");b.setStyle(g,"width",a);if(a<f.clientWidth)b.setStyle(g,"width",f.clientWidth)}},destroy:function(){var a=this.editor.id;c.clear(a+"_resize");c.clear(a+"_path_row");c.clear(a+"_external_close")},_simpleLayout:function(a,d,e,f){var h=this,i=h.editor,j=a.theme_compose_toolbar_location,k=a.theme_compose_statusbar_location,l,m,n,o;if(a.readonly){l=b.add(d,"tr");l=m=b.add(l,"td",{class:"mceIframeContainer"});return m}if(j=="top")h._addToolbars(d,e);if(j=="external"){if(a.theme_compose_toolbar_external_id){l=o=b.get(a.theme_compose_toolbar_external_id);b.addClass(l,"defaultSkin");l=b.add(l,"div",{id:i.id+"_external",class:"mceExternalToolbar",style:"position:relative;display:block"})}else{l=o=b.create("div",{style:"position:relative"});l=b.add(l,"div",{id:i.id+"_external",class:"mceExternalToolbar"});b.add(l,"a",{id:i.id+"_external_close",href:"javascript:;",class:"mceExternalClose"})}l=b.add(l,"table",{id:i.id+"_tblext",cellSpacing:0,cellPadding:0,style:"width:100%;"});n=b.add(l,"tbody");if(!a.theme_compose_toolbar_external_id){if(f.firstChild.className=="mceOldBoxModel")f.firstChild.appendChild(o);else f.insertBefore(o,f.firstChild)}h._addToolbars(n,e);if(!a.theme_compose_toolbar_external_id){i.onMouseUp.add(function(){var a=b.get(i.id+"_external");b.show(a);b.hide(g);var d=c.add(i.id+"_external_close","click",function(){b.hide(i.id+"_external");c.remove(i.id+"_external_close","click",d)});b.show(a);b.setStyle(a,"top",0-b.getRect(i.id+"_tblext").h-1);b.hide(a);b.show(a);a.style.filter="";g=i.id+"_external";a=null})}}if(k=="top")h._addStatusBar(d,e);if(!a.theme_compose_toolbar_container){l=b.add(d,"tr");l=m=b.add(l,"td",{class:"mceIframeContainer"})}if(j=="bottom")h._addToolbars(d,e);if(k=="bottom")h._addStatusBar(d,e);return m},_rowLayout:function(a,c,d){var f=this,g=f.editor,i,j,k=g.controlManager,l,m,n,o;i=a.theme_compose_containers_default_class||"";j=a.theme_compose_containers_default_align||"center";e(h(a.theme_compose_containers||""),function(e,g){var h=a["theme_compose_container_"+e]||"";switch(h.toLowerCase()){case"mceeditor":l=b.add(c,"tr");l=m=b.add(l,"td",{class:"mceIframeContainer"});break;case"mceelementpath":f._addStatusBar(c,d);break;default:o=(a["theme_compose_container_"+e+"_align"]||j).toLowerCase();o="mce"+f._ufirst(o);l=b.add(b.add(c,"tr"),"td",{class:"mceToolbar "+(a["theme_compose_container_"+e+"_class"]||i)+" "+o||j});n=k.createToolbar("toolbar"+g);f._addControls(h,n);b.setHTML(l,n.renderHTML());d.deltaHeight-=a.theme_compose_row_height}});return m},_addControls:function(a,b){var c=this,d=c.settings,f,g=c.editor.controlManager;if(d.theme_compose_disable&&!c._disabled){f={};e(h(d.theme_compose_disable),function(a){f[a]=1});c._disabled=f}else f=c._disabled;e(h(a),function(a){var d;if(f&&f[a])return;if(a=="tablecontrols"){e(["table","|","row_props","cell_props","|","row_before","row_after","delete_row","|","col_before","col_after","delete_col","|","split_cells","merge_cells"],function(a){a=c.createControl(a,g);if(a)b.add(a)});return}d=c.createControl(a,g,b);if(d)b.add(d)})},_addToolbars:function(a,c){var d=this,e,f,g=d.editor,h=d.settings,i,j=g.controlManager,k,l,m=[],n;n=h.theme_compose_toolbar_align.toLowerCase();n="mce"+d._ufirst(n);l=b.add(b.add(a,"tr"),"td",{class:"mceToolbar "+n});if(!g.getParam("accessibility_focus"))m.push(b.createHTML("a",{href:"#",onfocus:"tinyMCE.get('"+g.id+"').focus();"},"\x3c!-- IE --\x3e"));for(e=1;i=h["theme_compose_buttons"+e];e++){f=j.createToolbar("toolbar"+e,{class:"mceToolbarRow"+e});if(h["theme_compose_buttons"+e+"_add"])i+=","+h["theme_compose_buttons"+e+"_add"];if(h["theme_compose_buttons"+e+"_add_before"])i=h["theme_compose_buttons"+e+"_add_before"]+","+i;d._addControls(i,f);m.push(f.renderHTML());c.deltaHeight-=h.theme_compose_row_height}b.setHTML(l,m.join(""))},_addStatusBar:function(a,d){var e,g=this,h=g.editor,i=g.settings,j,k,l,m;e=b.add(a,"tr");e=m=b.add(e,"td",{class:"mceStatusbar"});e=b.add(e,"div",{id:h.id+"_path_row"},i.theme_compose_path?h.translate("compose.path")+": ":"&#160;");b.add(e,"a",{href:"#",accesskey:"x"});if(i.theme_compose_resizing){b.add(m,"a",{id:h.id+"_resize",href:"javascript:;",onclick:"return false;",class:"mceResize"});if(i.theme_compose_resizing_use_cookie){h.onPostRender.add(function(){var a=f.getHash("TinyMCE_"+h.id+"_size"),c=b.get(h.id+"_tbl");if(!a)return;g.resizeTo(a.cw,a.ch)})}h.onPostRender.add(function(){c.add(h.id+"_resize","mousedown",function(a){var d,e,j,k,l,m,n,o,p,q,r;function s(a){p=n+(a.screenX-l);q=o+(a.screenY-m);g.resizeTo(p,q)}function t(a){c.remove(b.doc,"mousemove",d);c.remove(h.getDoc(),"mousemove",e);c.remove(b.doc,"mouseup",j);c.remove(h.getDoc(),"mouseup",k);if(i.theme_compose_resizing_use_cookie){f.setHash("TinyMCE_"+h.id+"_size",{cw:p,ch:q})}}a.preventDefault();l=a.screenX;m=a.screenY;r=b.get(g.editor.id+"_ifr");n=p=r.clientWidth;o=q=r.clientHeight;d=c.add(b.doc,"mousemove",s);e=c.add(h.getDoc(),"mousemove",s);j=c.add(b.doc,"mouseup",t);k=c.add(h.getDoc(),"mouseup",t)})})}d.deltaHeight-=21;e=a=null},_nodeChanged:function(c,d,f,g,h){var i=this,j,k=0,l,m,n=i.settings,o,p,q,r,s;a.each(i.stateControls,function(a){d.setActive(a,c.queryCommandState(i.controls[a][1]))});function t(a){var b,c=h.parents,d=a;if(typeof a=="string"){d=function(b){return b.nodeName==a}}for(b=0;b<c.length;b++){if(d(c[b]))return c[b]}}d.setActive("visualaid",c.hasVisual);d.setDisabled("undo",!c.undoManager.hasUndo()&&!c.typing);d.setDisabled("redo",!c.undoManager.hasRedo());d.setDisabled("outdent",!c.queryCommandState("Outdent"));j=t("A");if(m=d.get("link")){if(!j||!j.name){m.setDisabled(!j&&g);m.setActive(!!j)}}if(m=d.get("unlink")){m.setDisabled(!j&&g);m.setActive(!!j&&!j.name)}if(m=d.get("anchor")){m.setActive(!!j&&j.name)}j=t("IMG");if(m=d.get("image"))m.setActive(!!j&&f.className.indexOf("mceItem")==-1);if(m=d.get("styleselect")){i._importClasses();r=[];e(m.items,function(a){r.push(a.value)});s=c.formatter.matchAll(r);m.select(s[0])}if(m=d.get("formatselect")){j=t(b.isBlock);if(j)m.select(j.nodeName.toLowerCase())}t(function(a){if(a.nodeName==="SPAN"){if(!o&&a.className)o=a.className;if(!p&&a.style.fontSize)p=a.style.fontSize;if(!q&&a.style.fontFamily)q=a.style.fontFamily.replace(/[\"\']+/g,"").replace(/^([^,]+).*/,"$1").toLowerCase()}return false});if(m=d.get("fontselect")){m.select(function(a){return a.replace(/^([^,]+).*/,"$1").toLowerCase()==q})}if(m=d.get("fontsizeselect")){if(n.theme_compose_runtime_fontsize&&!p&&!o)p=c.dom.getStyle(f,"fontSize",true);m.select(function(a){if(a.fontSize&&a.fontSize===p)return true;if(a["class"]&&a["class"]===o)return true})}if(n.theme_compose_path&&n.theme_compose_statusbar_location){j=b.get(c.id+"_path")||b.add(c.id+"_path_row","span",{id:c.id+"_path"});b.setHTML(j,"");t(function(c){var d=c.nodeName.toLowerCase(),e,f,g="";if(c.nodeType!=1||c.nodeName==="BR"||(b.hasClass(c,"mceItemHidden")||b.hasClass(c,"mceItemRemoved")))return;if(l=b.getAttrib(c,"mce_name"))d=l;if(a.isIE&&c.scopeName!=="HTML")d=c.scopeName+":"+d;d=d.replace(/mce\:/g,"");switch(d){case"b":d="strong";break;case"i":d="em";break;case"img":if(l=b.getAttrib(c,"src"))g+="src: "+l+" ";break;case"a":if(l=b.getAttrib(c,"name")){g+="name: "+l+" ";d+="#"+l}if(l=b.getAttrib(c,"href"))g+="href: "+l+" ";break;case"font":if(l=b.getAttrib(c,"face"))g+="font: "+l+" ";if(l=b.getAttrib(c,"size"))g+="size: "+l+" ";if(l=b.getAttrib(c,"color"))g+="color: "+l+" ";break;case"span":if(l=b.getAttrib(c,"style"))g+="style: "+l+" ";break}if(l=b.getAttrib(c,"id"))g+="id: "+l+" ";if(l=c.className){l=l.replace(/\b\s*(webkit|mce|Apple-)\w+\s*\b/g,"");if(l){g+="class: "+l+" ";if(b.isBlock(c)||d=="img"||d=="span")d+="."+l}}d=d.replace(/(html:)/g,"");d={name:d,node:c,title:g};i.onResolveName.dispatch(i,d);g=d.title;d=d.name;f=b.create("a",{href:"javascript:;",onmousedown:"return false;",title:g,class:"mcePath_"+k++},d);if(j.hasChildNodes()){j.insertBefore(b.doc.createTextNode(" » "),j.firstChild);j.insertBefore(f,j.firstChild)}else j.appendChild(f)},c.getBody())}},_sel:function(a){this.editor.execCommand("mceSelectNodeDepth",false,a)},_mceLink:function(b,c){this.linkMenu=this.linkMenu||new a.ui.AddLinkMenu(this.editor);this.linkMenu.bm=this.editor.selection.getBookmark(1);this.linkMenu.showMenu()},_mceForeColor:function(){var a=this;this._mceColorPicker(0,{color:a.fgColor,func:function(b){a.fgColor=b;a.editor.execCommand("ForeColor",false,b)}})},_mceBackColor:function(){var a=this;this._mceColorPicker(0,{color:a.bgColor,func:function(b){a.bgColor=b;a.editor.execCommand("HiliteColor",false,b)}})},_ufirst:function(a){return a.substring(0,1).toUpperCase()+a.substring(1)},_mceDesign:function(){var a=this,b=a.editor,c=b.controlManager.get("design");if(c.isActive()){b.execCommand("mceHideTemplates")}else{b.execCommand("mceShowTemplates")}},_mceCards:function(){var a=this,b=a.editor,c=b.controlManager.get("cards");if(c.isActive()){b.execCommand("mceHideCards")}else{b.execCommand("mceShowCards")}},_mceSignature:function(){},_mceSetSignature:function(){},_mceAppKeyboard:function(){},_mceAppTransfer:function(){},_mceAppTranslit:function(){},_mceAppSpelling:function(){},_mceInlineAttach:function(){},_mceShowTemplates:function(){},_mceHideTemplates:function(){},_mceShowCards:function(){},_mceHideCards:function(){},_mceEnableTextEditor:function(){},_mceEnableHTMLEditor:function(){}});a.ThemeManager.add("compose",a.themes.ComposeTheme)})(tinymce)});define("patron.v2/models/mail.FileSearchAttachment",["RPCModel","RPC","utils/extension"],function(a,b,c){"use strict";var d=a.extend({className:"attacheSearch",findUrl:"/cgi-bin/filesearch_ajax",parse:function(a){this.meta=a;return a.list},isFileSearch:true,getExtension:function(){var a=c.getExtByName(this.get("name"));return a?a.toLowerCase():"unknown"}});return d});define("patron.v2/models/Mail.Double",["ajs/pkg","patron.v2/models/mail.FileSearchAttachment","Promise"],function(a,b,c){"use strict";var d=null;function e(b,c,d){var e={},f,g=0,h;for(h=0;h<b.length;h++){if(b[h].attributes.parent!=d){continue}f=a.extend({},b[h]);f.attributes=a.extend({},f.attributes);if(f.attributes.children){f.attributes.count={folders:1}}e[g]=f;g++}var i={MainMailHost:location.host,MailAttachPreviewHost:patron.MailAttachPreviewHost};for(h=0;h<c.length;h++){var j=a.extend({},c[h].attributes);j.PartID=j.id;j.id=j.id.replace(/;\d+;\d+$/,"");i.id=j.id;if(j.content_type_id==1){j.IsImage=j.ShowThumbnail=1}j=patron.FullAttachViewer.Utils.createFileDescription(i,j,h);c[h].attributes=j;e[g]=c[h];g++}e.length=g;return e}var f={find:function(a){return new c(function(c,f){var g=2,h,i,j;function k(){g--;if(g!==0){return}if(a.offset||a.name_needle){c(e([],h,a.id))}else{c(e(d,h,a.id))}}i={folder_id:a.id,limit:a.limit,offset:a.offset,func_name:"ajax_search"};if(a.name_needle){i.name_needle=a.name_needle}b.find(i).then(function(a){h=a;k()});d=patron.Folders.getAll();k()})},secureOpen:function(a,b){var e;for(var f=d.length-1;f>=0;f--){if(d[f].id==a){e=d[f];break}}return new c(function(a,c){var d=e.secureOpen(b);d.then(function(){a("ico_folder_secret_open")});d["catch"](function(a){try{if(a.status===429){c("Неверный пароль, попробуйте позднее");return}if(a.body["folders[0].secret.folder_password"].error==="invalid"){c("Неверный пароль, попробуйте еще раз");return}}catch(a){}c("Ошибка, попробуйте еще раз")})})}};return f});define("patron.v2/utils/radars/ComposeAttachmentsManager",["patron.v2/utils/patron.utils.ui.radar"],function(a){"use strict";return{_CHAIN_ROOT:"compose-attache-manager",_CHAIN_ROOT_DWH:"compose-attache-manager-dwh",checkAll:function(){a([this._CHAIN_ROOT,"checkall"])},uncheckAll:function(){a([this._CHAIN_ROOT,"uncheckall"])},selectClick:function(b){if(b){a([this._CHAIN_ROOT,"select"])}else{a([this._CHAIN_ROOT,"unselect"])}},activeFolder:function(b,c){var d={dwh:JSON.stringify({folderID:c})};a([this._CHAIN_ROOT_DWH,"active-folder",b],undefined,d)},search:function(b,c){var d={dwh:JSON.stringify({query:c})};a([this._CHAIN_ROOT_DWH,"search",b],undefined,d)},close:function(){a([this._CHAIN_ROOT,"close"])},cancel:function(){a([this._CHAIN_ROOT,"cancel"])},cancelEscape:function(){a([this._CHAIN_ROOT,"cancel","escape"])},open:function(){a([this._CHAIN_ROOT,"open"])},attache:function(b){var c={dwh:JSON.stringify({count:b})};a([this._CHAIN_ROOT_DWH,"attache"],undefined,c)}}});define("fest!pages/promo/cloud-license",[],function(){var a=Function("return this")();if(!a.fest)a.fest={};a.fest["pages/promo/cloud-license"]=function(a){"use strict";var b=this,c=[],d=[],e,f=[],g,h,i,j,k,l=[],m={},n,o,p="",q="",r="",s=/[&<>"]/g,t=/[&<>"]/,u={area:true,base:true,br:true,col:true,command:true,embed:true,hr:true,img:true,input:true,keygen:true,link:true,meta:true,param:true,source:true,wbr:true},v=[],w={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},x=/[\\'"\/\n\r\t\b\f<>]/g,y=/[\\'"\/\n\r\t\b\f<>]/,z={'"':'\\"',"\\":"\\\\","/":"\\/","\n":"\\n","\r":"\\r","\t":"\\t","\b":"\\b","\f":"\\f","'":"\\'","<":"\\u003C",">":"\\u003E"},i18n=b&&typeof b.i18n==="function"?b.i18n:function(a){return a},A;if(typeof __fest_error==="undefined"){A=typeof console!=="undefined"&&console.error?function(){return Function.prototype.apply.call(console.error,console,arguments)}:function(){}}else{A=__fest_error}function B(a){A(a+'\nin block "'+r+'" at line: '+q+"\nfile: "+p)}function C(a){return w[a]}function D(a){return z[a]}function E(a,b){for(var c in b)if(b.hasOwnProperty(c))a[c]=b[c]}function F(a){a.param=true;return a}function G(a,c,d){if(d)for(var e in c)if(typeof c[e]=="function"&&c[e].param)c[e]=c[e]();return a.call(b,c)}function H(a){if(typeof a==="string"){if(y.test(a))return a.replace(x,D)}else if(typeof a==="undefined")return"";return a}function I(a){if(typeof a==="string"){if(t.test(a))return a.replace(s,C)}else if(typeof a==="undefined")return"";return a}p="data/ru/fest/pages/promo/cloud-license.xml";q="1";r="fest:template";var J=a;p="data/ru/fest/pages/promo/cloud-license.xml";q="3";r="div";c.push('<div class="popup_attach-to-compose__cloud-promo__wrapper"');p="data/ru/fest/pages/promo/cloud-license.xml";q="4";r="div";c.push('><div class="popup_attach-to-compose__cloud-promo__row popup_attach-to-compose__cloud-promo__row_minimal-height"');p="data/ru/fest/pages/promo/cloud-license.xml";q="5";r="div";c.push('><div class="popup_attach-to-compose__cloud-promo__splash"></div></div>');p="data/ru/fest/pages/promo/cloud-license.xml";q="7";r="fest:value";try{c.push(J.text)}catch(a){B(a.message+"7")}c.push("</div>");j=d.length;if(j){i=0;for(;i<j;i++){e=d[i];if(typeof e==="string"){l.push(e)}else{k=m[e.name];if(k)l.push(G(k,e.params,e.cp))}}l.push(c.join(""));return l.join("")}else{return c.join("")}};return a.fest["pages/promo/cloud-license"]});define("patron.v2.layer/ComposeAttachmentsManager/cloud",["mrg-explorer/b-explorer/b-explorer","toolkit/b-layer/b-layer","cloud/Entry","patron.v2.utils/userStore","patron.v2/utils/radars/ComposeAttachmentsManager","features","mrg-i18n-utils","fest!pages/promo/cloud-license"],function(a,b,c,d,e,f,i18n){"use strict";function g(a){a=a||{};this._attachedFiles=ajs.extend({},a.checkedFilesMap,a.attachedFilesMap,a.linkedFilesMap);this._initLayer();this._initRadars();this._freeSpace=a.freeSpace||0;this._recalcFreeSpace();if(!f.has("compose-attache-unlimit")){this._explorer.setFreeSpace(this._freeSpace)}this._setFilesCountLimit(a.totalAttachedFiels);this._onAttache=a.onAttache;this._generateDefaultChecked();this._explorer.setDefaultSelected(this._explorerDefaultSelected);this._initModel(true);e.open()}g.prototype={_generateDefaultChecked:function(){var a={cloud:[],mail:[]};this._explorerDefaultSelected={cloud:[],mail:[]};Object.keys(this._attachedFiles).forEach(function(b){b=this._attachedFiles[b];var c={id:b.PartId,size:b.isFiles?0:b.size};if(b.fromCloud){this._explorerDefaultSelected.cloud.push(c);a.cloud.push(b)}else{this._explorerDefaultSelected.mail.push(c);a.mail.push(b)}},this);this._attachedFiles=a;return a},_setFilesCountLimit:function(a){var b=this._COUNT_LIMIT-a+Object.keys(this._attachedFiles).length;this._explorer.setMaxSelectedCount(b)},_COUNT_LIMIT:100,_recalcFreeSpace:function(){this._freeSpace=+this._freeSpace;Object.keys(this._attachedFiles).forEach(function(a){a=this._attachedFiles[a];if(a.size&&!a.isFiles){this._freeSpace+=+a.size}},this)},_MODEL_IDS:["cloud"],_HEADER:Lang.get("popup.attache").cloud,_SEARCH_TITLE:Lang.get("popup.attache")["search.cloud"],_PASSWORD_PARAMS:null,_LICENSE_PARAMS:{btnEnter:i18n("Продолжить"),html:$.fest("pages/promo/cloud-license",{text:"<p>"+i18n("{bo}Облако Mail.Ru{bc} {mdash} это ваш персональный диск в интернете. Надежное хранилище, доступное вам в любой точке мира с компьютера или телефона.",{"unsafe-bo":"<b>","unsafe-bc":"</b>","unsafe-mdash":"&mdash;"})+"</p>"+"<p>"+i18n("{bo}Объем вашего облака {mdash} {CloudCapacity}Гб.{bc} Используйте его для хранения любых файлов, например: фото, видео, музыки, документов.",{"unsafe-bo":"<b>","unsafe-bc":"</b>","unsafe-mdash":"&mdash;",CloudCapacity:patron.CloudCapacity})+"</p>"})},_ACTIVATE_PARAMS:{html:$.fest("pages/promo/cloud-license",{text:"<p>"+i18n("{bo}Облако Mail.Ru{bc} недоступно для вашей учетной записи.{br}Обратитесь к администратору вашего домена.",{"unsafe-bo":"<b>","unsafe-bc":"</b>","unsafe-br":"<br/>"})+"</p>"})},_initLayer:function(){this._layer=new b({$el:$("<div></div>").appendTo($("body")),renderMode:"replace",template:"pages/lego",onHide:this.cancel.bind(this),data:{block:"b-explorer",params:{title:this._HEADER,modelsList:this._MODEL_IDS,searchTitle:this._SEARCH_TITLE,sortItems:this._SORT_FIELDS,defaultSort:"timestamp",defaultSortReverse:true,password:this._PASSWORD_PARAMS,license:this._LICENSE_PARAMS,activate:this._ACTIVATE_PARAMS,viewMods:["thumb","filelabel"],defaultViewMode:d.get("ComposeAttachmentsManager.viewMode")||"thumb",emptyFolderText:Lang.get("popup.attache").emptyFolder,emptySearchText:Lang.get("popup.attache").emptySearch},controls:[{block:"btn",text:Lang.get("popup.attache").btn.attache,mods:["main"],id:"popup_ok"},{block:"btn",text:Lang.get("popup.attache").btn.cancel,id:"popup_cancel"}]}});this._layer.show();this._layer.initInner();this._explorer=this._layer.$(".b-explorer").getBlock();this._explorer.render();this._explorer.on("viewmodechange",function(a,b){d.set("ComposeAttachmentsManager.viewMode",b.viewMode)});this._initCancelBtn();this._initOkBtn();this._layer.on("escape",function(){e.cancelEscape()})},_SORT_FIELDS:[{title:Lang.get("popup.attache").sort.name,field:"text"},{title:Lang.get("popup.attache").sort.date,field:"timestamp"},{title:Lang.get("popup.attache").sort.size,field:"size"}],_initModel:function(a){this._explorer.initModel({model:c,modelConvertor:function(a){var b={};b.id=a.id;if(a.isFolder()){b.type="folder"}else if(a.attributes.kind==="image"){b.type="image"}else{b.type=a.getExtension()}b.selectable=b.type!=="folder";b.text=a.attributes.name;if(a.attributes.kind==="image"){b.src=a.attributes.thumbnails["160x120"]}b.count=a.attributes.count;b.humanSize=String.sizeFormat(a.attributes.size);b.size=a.attributes.size;b.timestamp=a.attributes.mtime;return b},acceptLicense:function(){var a=$.Deferred();patron.API({url:"cloud/user/agree-la",complete:function(b){if(b.isOk()){a.resolve()}else{a.reject()}}});return a.promise()},findIDParams:function(a){return{folder:a}},loadLimit:40,rootTitle:Lang.get("popup.attache").cloud.toUpperCase(),enableSearch:false,hasServerSort:true,addSortParams:function(a,b,c){a.sort={};switch(b){case"timestamp":a.sort.type="mtime";break;case"text":a.sort.type="name";break;case"size":a.sort.type="size"}a.sort.order=c?"desc":"asc"},unlimitedSpace:true,id:"cloud"},!a)},_initCancelBtn:function(){this._layer.$('[data-id="popup_cancel"]').on("click",function(){this._layer.hide();e.cancel()}.bind(this))},_initOkBtn:function(){this._layer.$('[data-id="popup_ok"]').on("click",function(){var a=this.getSelected(),b=0;this._onAttache(a);this._destroy();Object.keys(a).forEach(function(c){b+=a[c].length});if(b){e.attache(b)}}.bind(this))},cancel:function(){this._destroy()},_destroy:function(){var a=this._layer.$el;this._layer.close();delete this._explorer;delete this._layer;a.remove()},getSelected:function(){var a=this._explorer.getSelected(),b=this._explorer.getUloadedDefaultSelected(),c;a.cloud=a.cloud.map(this._mapConvertSelected,this);for(var d=b.cloud.length-1;d>=0;d--){c=this._getFileDataFromAttache({id:b.cloud[d]});if(c){a.cloud.push(c)}}return a},_mapConvertSelected:function(a,b){var c=g.prototype._getFileDataFromAttache.call(this,a);if(c){return c}if(!a.uid){a.uid=ajs.uniqId()}var d=patron.FullAttachViewer.Utils.createFileDescription({MainMailHost:location.host,Id:a.id},a.attributes,b);d.uid=a.uid;if(d.thumbnails&&d.thumbnails["160x120"]){d.previewSrc=d.previewWithCropUrl=d.thumbnails["160x120"]}return d},_getFileDataFromAttache:function(a){for(var b=this._attachedFiles.cloud.length-1;b>=0;b--){if(this._attachedFiles.cloud[b].PartId==a.id){return this._attachedFiles.cloud[b]}}return null},_initRadars:function(){this._explorer.on("checkall",function(a,b){if(b.checked){e.uncheckAll()}else{e.checkAll()}});this._explorer.on("folderclick",function(a,b){e.activeFolder(b.modelID,b.id)});this._explorer.on("search",function(a,b){e.search(b.modelID,b.id)})}};return g});define("patron.v2.layer/ComposeAttachmentsManager/mail",["patron.v2/models/Mail.Double","patron.v2.layer/ComposeAttachmentsManager/cloud","mail/Folder","features"],function(a,b,c,d){"use strict";function e(){b.apply(this,arguments)}e.prototype={_MODEL_IDS:["mail"],_HEADER:Lang.get("popup.attache").mail,_SEARCH_TITLE:Lang.get("popup.attache")["search.mail"],_PASSWORD_PARAMS:{title:Lang.get("popup.attache").password.title,btnEnter:Lang.get("popup.attache").password.btnEnter,forgotPassword:Lang.get("popup.attache").password.forgotPassword,emptyPassword:Lang.get("popup.attache").password.emptyPassword,restoreURL:"/folder/restore/?folder={id}",folderRecovery:d.has("folder-recovery")},_LICENSE_PARAMS:null,_initModel:function(b){this._explorer.initModel({model:a,modelConvertor:function(a){var b={};b.id=a.id;if(!a.isFileSearch){b.type="folder";switch(true){case a.isSecure():b.secure=true;if(a.isSecureOpen()){b.icon="ico_folder_secret_open";b.open=true}else{b.icon="ico_folder_secret";b.open=false}break;case a.id==c.INBOX:b.icon="ico_folder_inbox";break;case a.id==c.ARCHIVE:b.icon="ico_folder_archive";break;case a.id==c.SPAM:b.icon="ico_folder_spam";break;case a.id==c.TRASH:b.icon="ico_folder_trash";break;case a.id==c.TEMPLATES:b.icon="ico_folder_templates";break;case a.id==c.DRAFTS:b.icon="ico_folder_drafts";break;case a.id==c.SENT:b.icon="ico_folder_send";break;case a.id==c.SOCIAL:b.icon="ico_folder_social";break;case a.id==c.PROMOTIONS:b.icon="ico_folder_promotions";break;case a.id==c.NEWSLETTERS:b.icon="ico_folder_newsletters";break}}else if(a.attributes.type==="image"){b.type="image"}else{b.type=a.getExtension()}b.selectable=b.type!=="folder";b.text=a.attributes.name;b.src=a.attributes.previewWithCropUrl;b.count=a.attributes.count;b.humanSize=String.sizeFormat(a.attributes.size);b.size=a.attributes.size;b.timestamp=a.attributes.time;return b},findIDParams:function(a){return{id:a}},searchQueryParams:function(a,b){return{name_needle:a}},openSecureFolder:function(b,c){return a.secureOpen(b,c)},loadLimit:40,rootTitle:Lang.get("popup.attache").mail.toUpperCase(),rootID:"-1",hideFolders:true,enableSearch:true,id:"mail"},!b)},getSelected:function(){var a=this._explorer.getSelected(),b=this._explorer.getUloadedDefaultSelected(),c;a.mail=a.mail.map(this._mapConvertSelected,this);for(var d=b.mail.length-1;d>=0;d--){c=this._getFileDataFromAttache({attributes:{PartId:b.mail[d]}});if(c){a.mail.push(c)}}return a},_mapConvertSelected:function(a,b){var c=e.prototype._getFileDataFromAttache.call(this,a);if(c){return c}if(!a.uid){a.uid=ajs.MD5(a.id)}var d=patron.FullAttachViewer.Utils.createFileDescription({MainMailHost:location.host,Id:a.attributes.id},a.attributes,b);d.uid=a.uid;if(d.imageUrl){d.previewSrc=d.previewWithCropUrl=d.imageUrl}return d},_getFileDataFromAttache:function(a){for(var b=this._attachedFiles.mail.length-1;b>=0;b--){if(this._attachedFiles.mail[b].PartId==a.attributes.PartId){return this._attachedFiles.mail[b]}}return null}};e.prototype=ajs.extend({},b.prototype,e.prototype);return e});define("patron.v2.layer/ComposeAttachmentsManager/popupCloudMail",["ajs/pkg","patron.v2.layer/ComposeAttachmentsManager/mail","patron.v2.layer/ComposeAttachmentsManager/cloud"],function(a,b,c){"use strict";function d(){c.apply(this,arguments)}d.prototype={_MODEL_IDS:["cloud","mail"],_HEADER:Lang.get("popup.attache").files,_SEARCH_TITLE:Lang.get("popup.attache").search,_PASSWORD_PARAMS:b.prototype._PASSWORD_PARAMS,_LICENSE_PARAMS:b.prototype._LICENSE_PARAMS,_initModel:function(){c.prototype._initModel.call(this,true);b.prototype._initModel.call(this,false)},getSelected:function(){var a=this._explorer.getSelected(),d=this._explorer.getUloadedDefaultSelected(),e,f;a.cloud=a.cloud.map(c.prototype._mapConvertSelected,this);a.mail=a.mail.map(b.prototype._mapConvertSelected,this);for(f=d.mail.length-1;f>=0;f--){e=b.prototype._getFileDataFromAttache.call(this,{attributes:{PartId:d.mail[f]}});if(e){a.mail.push(e)}}for(f=d.cloud.length-1;f>=0;f--){e=c.prototype._getFileDataFromAttache.call(this,{id:d.cloud[f]});if(e){a.cloud.push(e)}}return a}};d.prototype=a.extend({},c.prototype,d.prototype);return d});define("patron.v2/langs/tinymce",function(require){var i18n=require("mrg-i18n-utils");return{font_size:i18n("Размер"),fontdefault:i18n("Шрифт"),bold_desc:i18n("Жирный текст"),italic_desc:i18n("Наклонный текст"),underline_desc:i18n("Подчеркнутый текст"),striketrough_desc:i18n("Зачеркнутый текст"),justifyleft_desc:i18n("По левому краю"),justifycenter_desc:i18n("По центру"),justifyright_desc:i18n("По правому краю"),bullist_desc:i18n("Маркированный","Unordered_list"),numlist_desc:i18n("Нумерованный","Ordered_list"),outdent_desc:i18n("Уменьшить отступ"),indent_desc:i18n("Увеличить отступ"),undo_desc:i18n("Отменить действие"),redo_desc:i18n("Повторить действие"),link_desc:i18n("Ссылка"),cleanup_desc:i18n("Очистить форматирование"),hr_desc:i18n("Горизонтальная линия"),removeformat_desc:i18n("Очистить форматирование"),forecolor_desc:i18n("Цвет текста"),backcolor_desc:i18n("Цвет фона"),justifyselect_desc:i18n("Выравнивание"),moreactions_desc:i18n("Дополнительно"),fontactions_desc:i18n("Шрифт"),textindentactions_desc:i18n("Отступ"),bullistactions_desc:i18n("Список"),emotions_desc:i18n("Смайлики"),apptransfer_desc:i18n("Перевести текст"),appkeyboard_desc:i18n("Клавиатура"),apptranslit_desc:i18n("Транслитерация"),appspelling_desc:i18n("Проверить орфографию"),inlineattach_desc:i18n("Вставить картинку"),apppresents_desc:i18n("Мои подарки"),appmailstatistic_desc:i18n("Статистика письма"),appcripto_desc:i18n("Крипто"),moreapps_desc:i18n("Ещё приложения"),signature_desc:i18n("Подпись"),signature_addsign:i18n("Добавить подпись"),signature_editsign:i18n("Изменить подпись"),design_desc:i18n("Стили"),cards_desc:i18n("Открытки"),enabletexteditor_desc:i18n("Убрать оформление"),enablehtmleditor_desc:i18n("Расширенное оформление"),more:i18n("Еще"),font_normal_label:i18n("(нормальный)"),add_link_form_href_label:i18n("Введите адрес ссылки"),add_link_form_title_label:i18n("Введите текст ссылки"),add_link_form_add:i18n("Добавить"),add_link_form_cancel:i18n("Отмена"),appearance_without_style:i18n("Без стиля"),cards_without:i18n("Без открытки"),smiles:[{title:i18n("Колобки"),list:{angel:i18n("Ангелочек"),bad:i18n("Тошнит"),biggrin:i18n("Улыбка до ушей"),blum:i18n("Дразнюсь"),blush:i18n("Смущаюсь"),cray:i18n("Рыдаю"),crazy:i18n("Сумасшествие"),dance:i18n("Танцую"),diablo:i18n("Чертовски злюсь"),dirol:i18n("Я круче"),drinks:i18n("Пиво"),fool:i18n("Ты что!"),give_rose:i18n("Дарю цветочек"),good:i18n("Ок!"),kiss_mini:i18n("Целую","Smile_Kiss"),man_in_love:i18n("Поцеловали"),mocking:i18n("Хихикаю"),music:i18n("Слушаю музыку"),nea:i18n("Не-а"),pardon:i18n("Извини"),rofl:i18n("Лопну от смеха"),rolleyes:i18n("Мечтаю"),sad:i18n("В печали"),"scratch_one-s_head":i18n("Надо подумать"),shok:i18n("Ой, ё"),shout:i18n("Кричу"),smile:i18n("Улыбаюсь"),unknw:i18n("Не знаю"),wacko2:i18n("В изнеможении"),wink:i18n("Подмигиваю"),yahoo:i18n("Уррра!"),boian:i18n("Бойан"),kut:i18n("Ктулху")}},{title:i18n("Классические"),list:{smile:":)",blink:";)",laughter:":-))",bee:";-P",coolguy:"8-)",biggrin:":-D",pig:"}:o)",bazilio:"$-)",hm:":-'",dissapointed:":-(",tears:"8-(",cry:":'(",crocodile:":''()",really:"S:-o",oo:"(:-o",amazed:"8-0",aaa:"8-[o]",bullshit:"):-p",angry:"):-(",rrr:"):-$",zloradstvo:"):-D",biganger:":-E",devil:i18n("Чертенок"),vampire:i18n("Вампирчик"),plug:":-][",detzl:":-|",sceptic:"B-j",shy:":~o",ass:"(_I_)",heart:i18n("Сердце"),kiss:":-*",sleepy:i18n("Сплю"),live:i18n("Отлично!"),victory:i18n("Peace!"),ok:i18n("OK"),koza_left:i18n('Левая \"коза\"'),koza_right:i18n('Правая \"коза\"'),die:i18n("Плохо"),fingerup:i18n("Внимание!"),kukes:i18n("Фига"),fist:i18n("Кулак"),fuck:i18n("Отвали!")}},{title:i18n("Анимированные"),list:{angel:i18n("Ангелочек"),appl:i18n("Аплодисменты"),beauty:i18n("Красотка"),beer:i18n("Пиво"),book:i18n("Читаю"),could:i18n("Мёрзну"),cry:i18n("Рыдаю"),dance:i18n("Танцую"),devil:i18n("Чертовски злюсь"),eat:i18n("Жую"),fight:i18n("Побью"),fingal:i18n("Побили"),flowr:i18n("Дарю цветочек"),gg:i18n("Смеюсь"),gg2:i18n("Смеюсь и плачу"),gift:i18n("Подарок"),hungry:i18n("Ворчу"),kiss:i18n("Целую","Smile_Kiss"),love:i18n("Люблю"),pistolet:i18n("Застрелю"),poison:i18n("Выпей яду"),rainbow:i18n("Лучезарно"),red:i18n("Смущаюсь"),sad:i18n("Расстраиваюсь"),sing:i18n("Пою"),skuka:i18n("Скучаю"),sleep:i18n("Засыпаю"),smile:i18n("Улыбаюсь"),tongue:i18n("Показываю язык"),victory:i18n("Peace!"),wonder:i18n("Удивляюсь"),blew:i18n("Тошнит")}},{title:i18n("Продвинутые","Advanced_smiles"),list:{c03:i18n("Улыбаюсь"),c05:i18n("Злорадствую"),c07:i18n("Радуюсь"),c09:i18n("Старичок"),c11:i18n("Свирепствую"),c13:i18n("Пугаюсь"),c21:i18n("Показываю язык"),c22:i18n("Умник"),c23:i18n("Алкоголик"),c24:i18n("Вояка"),c25:i18n("Удивляюсь"),c26:i18n("Чертовски злюсь"),c33:i18n("Расстраиваюсь"),c34:i18n("Панк"),c35:i18n("Лопну от смеха"),c36:i18n("Подмигиваю"),c37:i18n("Думаю"),c38:i18n("Люблю"),c45:i18n("Подавлен"),c46:i18n("Рыдаю"),c47:i18n("Сейчас расплачусь"),c48:i18n("Злюсь"),c49:i18n("Тошнит"),c50:i18n("Сумасшествие"),c57:i18n("Целую","Smile_Kiss"),c58:i18n("Поцеловали"),c59:i18n("Красотка"),c60:i18n("Ангелочек"),c61:i18n("Подозрительно"),c62:i18n("Жую"),c69:i18n("Смущаюсь"),c70:i18n("Стыдно")}},{title:i18n("Иронические"),list:{s001:i18n("Ура!"),s002:i18n("Привет!"),s003:i18n("Кушаю"),s004:i18n("Танцую"),s006:i18n("Пока!"),s007:i18n("Слушаю музыку"),s008:i18n("Помоги"),s009:i18n("Бабло!"),s010:i18n("Да!"),s011:i18n("Головой об стену"),s012:i18n("В атаку!"),s013:i18n("Пацанчик"),s014:i18n("Нет!"),s015:i18n("Мир!"),s016:i18n("Дракончик")}},{title:i18n("Гиганты"),list:{s001:i18n("Лопну от смеха"),s002:i18n("Чертовски злюсь"),s003:i18n("Секрет"),s004:i18n("В изнеможении"),s017:i18n("Требую"),s006:i18n("Целую","Smile_Kiss"),s007:i18n("Обида"),s008:i18n("Устал"),s009:i18n("Подмигиваю"),s010:i18n("Гадость"),s011:i18n("Виноват"),s013:i18n("Разочарование"),s014:i18n("Сплю"),s015:i18n("Ой, ё"),s016:i18n("Прыгаю"),s020:i18n("Подозреваю"),s018:i18n("Тошнит")}},{title:i18n("Романтические"),list:{s001:i18n("Обожаю тебя"),s002:i18n("Ангелок"),s004:i18n("С любовью"),s003:i18n("Девочка с косичками"),s020:i18n("Целую","Smile_Kiss"),s005:i18n("Сердечко"),s019:i18n("Дарю цветочек"),s006:i18n("Крылья любви"),s011:i18n("Кондитер"),s010:i18n("Голубки"),s007:i18n("Тюльпаны"),s008:i18n("Сердце"),s009:i18n("Купидон"),s012:i18n("Карусель"),s013:i18n("Кот"),s014:i18n("Пёс"),s015:i18n("Заяц с цветком"),s016:i18n("Бабочка"),s017:i18n("Цветы"),s018:i18n("Букет")}},{title:i18n("Новогодние"),list:{a1:i18n("Новогодний шар"),a2:i18n("Носок подарков"),a3:i18n("Карамелька"),a4:i18n("Снеговик"),b1:i18n("Ель"),b2:i18n("Шампанское"),b3:i18n("Варежка"),b4:i18n("Я - сам Новый год!"),c1:i18n("Подмигиваю"),c2:i18n("Новогодний смех"),c3:i18n("Дед Мороз"),c4:i18n("Снегурочка"),d1:i18n("Звезда"),d2:i18n("Подарок"),d3:i18n("Зайчик с морковкой"),d4:i18n("Ослик"),e1:i18n("Колокольчик"),e2:i18n("Снежинка"),e3:i18n("Парад звезд"),e4:i18n("Куранты"),f1:i18n("Мешок подарков"),f2:i18n("Еловая ветка")}}]}});define("patron.v2/utils/tinyMCESettings",["patron.v2/utils/features","patron.v2/utils/parsers/emoji"],function(a,b){return function(c){c=$.extend({doctype:"",content_css:patron.editorContentCss,language:"ru",language_load:false,mode:"exact",theme:"compose",plugins:"lists,table,autolink",add_form_submit_trigger:false,submit_patch:false,convert_fonts_to_spans:false,add_unload_trigger:false,cleanup:false,br_in_pre:false,update_styles:false,keep_values:false,gecko_spellcheck:true,forced_root_block:false,force_br_newlines:true,force_p_newlines:false,remove_linebreaks:false,no_content_load:true,extended_valid_elements:"style",font_size_style_values:"8px,10px,12px,14px,18px,24px,36px",theme_compose_toolbar_location:"external",theme_compose_toolbar_align:"left",theme_compose_more_colors:0,theme_compose_buttons1:"",theme_compose_buttons2:"",theme_compose_buttons3:""},c);if(a.has("compose2-inlinefromeditor")){c.plugins+=",inlineattach"}else{var d=c.theme_compose_buttons1.split(",");d.splice(d.indexOf("inlineattach"),1);c.theme_compose_buttons1=d.join(",")}if(a.has("emoji-editor")&&!patron.IsMSIE8){c.plugins+=",emoji";c.emoji_lib=b;c.emoji_needReplace=a.has("emoji");c.theme_compose_buttons1=c.theme_compose_buttons1.replace("emotions","emoji");c.emoji_exclude="";if(!a.has("emoji")){c.emoji_exclude+=",🇦,🇧,🇨,🇩,🇪,🇫,🇬,🇭,🇮,🇯,🇰,🇱,🇲,🇳,🇴,🇵,🇶,🇷,🇸,🇹,🇺,🇻,🇼,🇽,🇾,🇿,⬜,▪";if(a.has("emoji_exclude_all")){c.emoji_exclude+=",☺,✌,☝,❤,☀,☁,❄,☎,✉,✂,✒,✏,⚾,✈,⚠,♨,⃣,⃣,⃣,⃣,⃣,⃣,⃣,⃣,⃣,⃣,⃣,⬆,⬇,⬅,➡,ℹ,↗,↖,↘,↙,↔,↕,◀,▶,↩,↪,⤵,⤴,🈷,🈂,Ⓜ,㊙,㊗,✳,❇,✴,‼,⁉,✖,♠,♥,♣,♦,✔,☑,〰,〽,◼,◻,▪,▫"}}}if(a.has("compose-doctype")){c["doctype"]="<!DOCTYPE html>"}if(patron.enableIncreaseFont){c.font_size_style_values="10px,12px,15px,18px,24px,36px,42px"}if(patron.enableIncreaseFont2){c.font_size_style_values="10px,12px,14px,18px,24px,36px,42px"}if(patron.IncreaseFontWidth&&patron.IncreaseFontHeight){var e,f;e=patron.IncreaseFontWidth-350;f=patron.IncreaseFontHeight-280;c.media_queries_sizes={width:e,height:f}}if(patron.UseCastomFont){c.use_castom_font=true}if($.browser.opera){c.forced_root_block="p"}if(!$.browser.msie&&!$.browser.opera){c.plugins+=",paste";$.extend(c,{paste_auto_cleanup_on_paste:true,paste_auto_process_on_paste:false,paste_enable_default_filters:false})}c.convert_urls=false;if(patron.enableIncreaseFont){c.body_class="increase-font"}if(patron.enableIncreaseFont2){c.body_class="increase-font-2"}if(a.has("compose2")){if(!c.body_class){c.body_class="compose2"}else{c.body_class+=" compose2"}}return c}});define("patron.build/Wysiwyg",["patron.v2/langs/tinymce","patron.v2/utils/tinyMCESettings","tinymce"],function(a,b){if(window.tinyMCE){window.tinyMCE.addI18n("ru.compose",a)}return{settings:b}});define("patron.compose/warning/empty",[],function(){"use strict";return{name:"empty",test:function(a,b){return b.isShowEmptyConfirm&&!a.isForward()&&!b.isShowReattachToReply},exec:function(a,b,c){a.$el.delegate(".confirm-ok","tap",b._submitEmptyMessageConfirmSuccess.bind(b));a.show()}}});define("patron.compose/warning/reattach",["jquery"],function($){"use strict";return{name:"reattach",test:function(a,b){return b.isShowReattachToReply},exec:function(a,b,c){var d=b._formElm("re_msg").val();a.$el.undelegate();a.$el.delegate(".confirm-ok","tap",b._reattachToReply.bind(b,d,true));a.$el.delegate(".confirm-cancel","tap",b._reattachToReply.bind(b,d,false));a.show();$.event.trigger("ui-abstract-action",{chain:["reattachToReply","show"]})}}});define("patron.compose/warning/missingAttach",["jquery","features","mrg-text-analyzer"],function($,a,b){"use strict";return{name:"missingAttach",test:function(c,d){return!c.hasAttachments()&&!c.isForward()&&!d.submitWithoutAttachConfirmSuccess&&a.has("check-missing-attach")&&b.hasAttachment(c.getEnteredText())},exec:function(a,b,c){a.$el.delegate(".confirm-ok","tap",function(){b.options.attachCorrectAssumption=false;b._submitWithoutAttachConfirmSuccess()});a.$el.delegate(".confirm-cancel","tap",function(){b.options.attachCorrectAssumption=true});a.func=function(a){a=a?"true":"false";$.event.trigger("ui-abstract-action",{chain:["missing","attach","analyzer",a]})};a.$div.parent(".popup").toggleMod("citylight",true);a.one("hide",function(){a.$div.parent(".popup").toggleMod("citylight",false)});a.show();$.event.trigger("ui-abstract-action",{chain:["missing","attach","analyzer","show"]})}}});define("patron.compose/warning/_all",["patron.v2.layer/patron.layer.MessagesLayers","patron.compose/warning/empty","patron.compose/warning/reattach","patron.compose/warning/missingAttach"],function(a){"use strict";var b=[].slice.call(arguments,1);return{get:function(c,d){var e=b.find(function(a){return a.test(c,d)});if(e){return function(){a("/compose/"+e.name,function(a){e.exec(a,c,d)})}}return null}}});define("mail/actions/Schedule",function(require){"use strict";var a=require("Action"),b=require("RPC");var c=a.extend({operation:function(a){switch(a.method){case c.UPDATE:return this._update(a.data);case c.REMOVE:return this._remove(a.data);default:throw new Error("Действие не найдено",a.method)}},_update:function(a){return b.post("messages/schedule/update",a)},_remove:function(a){return b.post("messages/schedule/remove",a)}});c.UPDATE="UPDATE";c.REMOVE="REMOVE";a.register("mail.Schedule",c);c.version="0.2.0";return c});define("patron.compose/patron.Compose.Translator",["features"],function(a){ajs.createClass("patron.Compose.Translator",{__construct:function(a){this.form=a;this.translateDebounceObserver=this._doTranslate.debounce(200,this);this.toggleEditorTypeObserver=this._onToggleEditorType.bind(this);this.textEditorEnabled=false;this._initEvents()},reset:function(){this.close()},_toggleEditorTranslatorState:function(b){this._toggleEditorEvents(b);var c=this.form;if(a.has("compose-translate-hide-toolbar")){c.toggleEditorToolbar(!b)}c._setEditorControlsState(["design","cards"],!b&&!this.textEditorEnabled);var d=c.getAppearance(),e=c.decoration.getItem("appearance");if(b){this.currentTemplate=d.getCurrentTemplate()||this.currentTemplate;e.triggerHandler("clear")}else{if(this.currentTemplate&&!this.textEditorEnabled){e.triggerHandler("select",[null,this.currentTemplate])}this.currentTemplate=null}c._updateGeometryWithTriggerResize()},_toggleEditorEvents:function(a){var b=this.form,c=b.getEditor(),d=b.getEditorElement(),e=a?"add":"remove",f=a?"bind":"unbind";if(c){["SetContent","Paste","KeyUp","ExecCommand"].forEach(function(a){c["on"+a][e](this._onEditorEvent,this)},this);c.selection["onSetContent"][e](this._onEditorEvent,this)}d[f]("keyup paste change",this.translateDebounceObserver);b[f]("enableTextEditor enableHTMLEditor",this.toggleEditorTypeObserver);$(window)[f]("editorToolbarButtonCardSelect.compose editorToolbarButtonAppearanceSelect.compose",this.translateDebounceObserver)},_onEditorEvent:function(a,b){if(!(b==="mceEnableTextEditor"||b==="mceEnableHTMLEditor"||b==="mceAppTransfer")){this.translateDebounceObserver()}},_onOpen:function(){this._toggleEditorEvents(false);this._toggleEditorTranslatorState(true)},_onClose:function(){this._toggleEditorTranslatorState(false)},_onSave:function(){this.form.setContent(this.form.composeUI.translator.getContent())},_onTranslate:function(){this.form.composeUI.translator.setScrollTop(this.form.getScrollTop())},_onToggleEditorType:function(){this.translate()},_initEvents:function(){this.form.composeUI.on("translate:open",this._onOpen.bind(this));this.form.composeUI.on("translate:close",this._onClose.bind(this));this.form.composeUI.on("translate:save",this._onSave.bind(this));this.form.composeUI.on("translate:translate",this._onTranslate.bind(this));this.form.bind("submit",this.close.bind(this))},_doTranslate:function(){if(this.form.isActive()){this.form.composeUI.translator.doTranslate()}},close:function(){this.form.composeUI.translator.informer.emit("close")},setHeight:function(a){this.form.composeUI.translator.setHeight(a)},translate:function(){this.form.composeUI.translate(this.form.isHTMLMode(),this.form.getEditor(),function(){return this.form.getContent()}.bind(this))}});return patron.Compose.Translator});define("patron.compose2/patron.Compose.Form.patch",["ajs/pkg","Promise","patron.compose2/providers/compose","patron.v2.layer/ComposeAttachmentsManager/mail","patron.v2.layer/ComposeAttachmentsManager/cloud","features","patron.v2/utils/userRealNames","mail/actions/Schedule","patron/patron.Notify","patron.v2/flags/flags","patron.compose/patron.Compose.Translator","patron.utils/patron.Utils"],function(ajs,Promise,provider,MailPopup,CloudPopup,features,userRealNames,ScheduleAction,Notify,flags){return{statics:{},methods:{__construct:function(a,b){var c;this.redraw=this.redraw.debounce(16,this);this.options=$.extend({},patron.Compose.Form.defaultOptions,b);this.composeUI=this.options.composeUI;c=this.options.domIDs;this.$form=$(this.composeUI.$el.find(c.form));this.form=this.$form.get(0);this.composeUI.wrap({scheduleEnabled:true,isTablet:patron.IsTablet,inlineAttachments:{uploadInlineFile:function(a,b){patron.Compose.Form.getActive().fileUploader.uploadInlineFile(a,b)},uploadAttachments:function(a){patron.Compose.Form.getActive().fileUploader.uploadFiles(a)},getEditor:function(){return patron.Compose.Form.getActive().getEditor()},parseResponse:function(a,b){return new Promise(function(c,d){patron.Ajax.parse(b,"success",{dataType:"json",complete:function(b){b=new patron.API.Response(b);var d=b.getBody(),e;if(b.isOK()){var f=d.attach.thumbnails;if(f&&$.isPlainObject(f.image)){f=f.image}if(f&&(e=f.original)){if(a.canPreview){var g=new Image;g.onload=function(){c({id:d.attach.id,src:e});g=g.onload=null};g.src=e}else{c({id:d.attach.id,src:e})}}else{c()}}else{c()}}})}).then(function(a){var b=patron.Compose.Form.getActive(),c=d();function d(){function a(a){return ajs.getRandomHash(a,true,true,true)}return a(4)+"@"+a(8)+"."+a(8)}if(a&&a.id&&a.src){b.Attaches.inlineUploaded[a.src]={id:a.id,content_id:c};b.options.map_inline_img[a.src]=c}return a})},needResizePreview:function(a){var b=features.get("compose2-inlinefromeditor");return b&&b.data&&+(b.data||0)<a}}});this._composeUIEvents();this.mobileVersion=$.browser.operamini;this.deviceVersion=tinyMCE.isIDevice||$.browser.operamobi||$.browser.android;this.supportBeforeUnload=true;this.disabled={};this.xhrs={};this.timers={};this.intervals={};this.popups={};this._from=patron.useremail;this.RealNamesSignatures=[];if(this.options.RealNames){Object.forEach(this.options.RealNames,function(a){if($.trim(a.signature)&&a.signature!==""){this.RealNamesSignatures.push(a)}else if(features.has("wysiwyg-signature")){if($.trim(a.signatureHtml)){this.RealNamesSignatures.push($.extend({},a,{signature:userRealNames.getEmptySignature()}))}}},this)}this._clearAttaches();if(this.options.html&&$.browser.opera){this.options.html="<div>"+this.options.html+"</div>"}this.sentmsgUrl="/compose/";this.validator=new patron.Compose.FormValidator(this.$form);this.fileUploader=new patron.Compose.FileUploader(this.$form,this.options.fileUploaderSettings,{name:this.options.name,domIDs:c,liteVersion:this.mobileVersion});this.multiAttachToComposeUI=new patron.ui.MultiAttachToCompose({filesLimit:this.fileUploader.settings.MaxAttachments});this.attachFromFileSearchUI=new patron.ui.AttachFromFileSearch({hasSpaceLimit:true,filesLimit:this.fileUploader.settings.MaxAttachments});this.attachFromCloudUI=new patron.ui.AttachFromCloud({hasSpaceLimit:false,filesLimit:this.fileUploader.settings.MaxAttachments});this.cards=new patron.Compose.Cards(this.form);this.decoration=new patron.Compose.Decoration(this.form);this.dragAndDrop=new patron.Compose.DragAndDrop(this);this.beforeUnloadObserver=(this.supportBeforeUnload?this._onBeforeUnload:this._onBeforeUnloadFix).bind(this);this.keyboardObserver=this._formKeyboard.bind(this);this.toggleEditorToolbarObserver=this._onToggleEditorFocus.bind(this);this._iV2();if(features.has("compose2")&&features.has("compose2-schedule")){this.composeUI.off("schedule:remove").on("schedule:remove",this.removeSchedule.bind(this))}var d=this;this.bind("ready",function(){jsHistory.oneTop(d.unactive.bind(d));$(window).triggerHandler("showForm.compose")});this.oldEditorFlags=patron.EditorFlags;if(this.fileUploader.uploaderHTML5){this.attachFilesListener=function(a,b){this._enableSave()}.bind(this);this.multiAttachToComposeUI.bind("select",function(a,b){this._attachFilesFromFileSearch(b.filesearch,b.restore);this._attachFilesFromCloud(b.cloud,b.restore);if(!b.restore){if(b.filesearch.length){$.event.trigger("ui-abstract-action",{chain:["compose","attaches","filesearch","add"]})}if(b.cloud.length){$.event.trigger("ui-abstract-action",{chain:["compose","attaches","cloud","add"]})}}}.bind(this));this.fileUploader.uploaderHTML5.bind("reset",function(){this._clearAttaches()}.bind(this));this.fileUploader.uploaderHTML5.bind("onInlineSelect",function(a,b){this.composeUI.putInlineFiles(b.files)}.bind(this));this.fileUploader.uploaderHTML5.List.bind("remove removeByUid",function(a,b){var c=this.Attaches;if(c.forward.files[b]){c.forward.size-=c.forward.sizes[b];delete c.forward.files[b];delete c.forward.sizes[b]}else if(c.cloud.files[b]){c.cloud.size-=c.cloud.sizes[b];delete c.cloud.files[b];delete c.cloud.sizes[b]}else if(c.cloud_link[b]){delete c.cloud_link[b]}else if(c.tnef[b]){delete c.tnef[b]}if(this.multiAttachToComposeUI){delete this.multiAttachToComposeUI.checkedFilesMap[b]}}.bind(this));$(".js-multi-attach",this.$form).on("tap",function(a){var b=$.extend({},this.Attaches.forward.files,this.Attaches.cloud.files),c={},d={},e=$(a.currentTarget).attr("data-source");Array.forEach(this.fileUploader.uploaderHTML5.getAll(),function(a){if(b[a.uid]){if(a.isFiles){d[a.uid]=a}else{c[a.uid]=a}}});this._initMultiattachPopup(e,b,c,d)}.bind(this));this.setSubjectFromAttachmentsObserver=this.setSubjectFromAttachmentsObserver.bind(this)}this.$selectFieldsDropdown=$();this.$selectFieldsDropdownItems=$();this.templates=new patron.Compose.Templates(this);this.translator=new patron.Compose.Translator(this);this._initContextMenu();this.$frame=$(c.composeFrame);this.$composeEditorFrame=$(c.composeEditorFrame);this.$composeDisableFormLayer=$(c.composeDisableFormLayer);this.$removeDraftContainer=$(".js-removeDraftContainer",this.$form);this.$sendButton=$(".js-send",this.$form);this.$draftButton=$(".js-draft",this.$form);this.$cancelButton=$(".js-cancel",this.$form);this.$footerDraftButton=$(".js-compose-footer-save",this.$form);this.$removeDraftContainer=$(".js-removeDraftContainer",this.$form);this._updateFrameHeight();if(b.name){patron.Compose.Form[b.name]=this}patron.Compose.Form[this.composeUI.uniquify()]=this;if(this.deviceVersion){this._deviceVersionInit()}else{userRealNames.loadRealNames().done(function(){this._initEditor();this.fileUploader.uploaderHTML5.registerInlineInput()}.bind(this))}this._initAddressBook();if(!patron.ComposeLabels){this._initAddressBookAutocomplete()}this.trigger("inited")},removeSchedule:function(){var a=this._formElm("schedule_msg").val(),b=this._formElm("draft_msg").val();if(a){ScheduleAction.execute({method:ScheduleAction.REMOVE,data:$.extend({id:a},b?{source:{draft:b}}:null)}).then(function(){this._formElm("schedule_msg").val("");this._formElm("draft_msg").val(a);this.updateCurrentFormData();Notify.add("ok",{text:i18n("Письмо перемещено в черновики"),delay:10})}.bind(this))}},_initMultiattachPopup:function(a,b,c,d){var e;if(features.has("compose-popup-files")){e=a==="mail"?MailPopup:CloudPopup;new e({checkedFilesMap:b,attachedFilesMap:c,linkedFilesMap:d,freeSpace:this.fileUploader.uploaderHTML5._spaceLeft,totalAttachedFiels:this.fileUploader.getFilesCount(),onAttache:function(b){if(a==="mail"){this._attachFilesFromFileSearch(b.mail||[],null)}else{this._attachFilesFromCloud(b.cloud||[],null)}if(a==="mail"){if(b.mail&&b.mail.length){$.event.trigger("ui-abstract-action",{chain:["compose","attaches","filesearch","add"]})}}else{if(b.cloud&&b.cloud.length){$.event.trigger("ui-abstract-action",{chain:["compose","attaches","cloud","add"]})}}}.bind(this)})}else{window.multiAttachToComposeUI=this.multiAttachToComposeUI;this.multiAttachToComposeUI.show({filesCount:this.fileUploader.getFilesCount(),checkedFilesMap:b,attachedFilesMap:c,linkedFilesMap:d,freeSpace:this.fileUploader.uploaderHTML5._spaceLeft})}},inlineAttach:function(){this.$form.find(".js-inline-input-file input").click()},reset:function(){var a=this.options.domIDs;var b=this.getMainFrame();this.$form[0].reset();this.composeUI.resetMoneyAttach();if(this.templates){this.templates.reset()}if(this.translator){this.translator.reset()}if(this.fileUploader.uploaderHTML5){this.fileUploader.uploaderHTML5.unbind("attachFiles",this.attachFilesListener);this.disableSubjectFromAttachments()}this._enableControls();this.enableEdit();$([a.composeEditor_toolbar1,a.composeEditor_toolbar3,a.composeEditor_toolbar4].join(","),this.$form).css("visibility","hidden");var c=$.extend(this.getData({attachments:false}),{letbody_html:"",letbody_plain:"",HTMLCompose:patron.HTMLCompose,To:"",CC:"",BCC:"",Subject:"",draft_msg:"",re_msg:"",fwd_msg:"",schedule_msg:"",files_id:"",files_ids:"",cloud_files_ids:"",actionId:"",template_id:"",HighPriority:"",remind:"",NeedRcpt:"",LeftMailSize:patron.Compose.fileUploaderSettings.MaxAttachmentSize,MessageId:ajs.getRandomHash(8,true,true,true)});this.redraw(c,true);b.addClass("jsvh");var d=this.getEditor();if(d){d.setContent("",{no_events:true,format:"raw"});this.setCaretPositionInStart();$(document.body).focus();d.nodeChanged()}this.triggerHandler("reset");this.$form.trigger("compose-success",{state:false}).trigger("compose-error",{state:false});this._disableAttachesKeepAlive();if(!features.has("compose2-visible-toolbar")){this.toggleEditorToolbar(false)}this.composeUI.reset();delete this._reattachedToReply;return this},redraw:function(data,reset){var formData={value:{actionId:data.actionId||"",files_id:data.files_id==null?"":data.files_id.toString(),files_ids:data.files_ids||"",cloud_files_ids:data.cloud_files_ids||"",message:data.MessageId||"",old_charset:data.old_charset||"",draft_msg:data.draft_msg||"",template_id:data.template_id||"",re_msg:data.re_msg||"",fwd_msg:data.fwd_msg||"",schedule_msg:data.schedule_msg||"",To:data.To||"",CC:data.CC||"",BCC:data.BCC||"",Subject:data.Subject||"",HTMLMessage:patron["ForceHtmlCompose"]||data.HTMLCompose?1:0},checked:{schedule:data.Schedule?data.Schedule*1e3:"",remind:data.remind,Priority:!!data.HighPriority,Receipt:!!data.NeedRcpt}},fileUploaderSettings={needReattach:data.needReattach,msg:data.msg,ServerName:data.ServerName||"",NoFlashUploader:!!data.NoFlashUploader,MaxAttachmentSize:parseInt(data.MaxAttachmentSize),MessageId:formData.value.message,DraftMsg:formData.value.draft_msg,LeftMailSize:parseInt(data.MaxAttachmentSize),files_id:formData.value.files_id,UploadOnlyFiles:!!data.UploadOnlyFiles,MaxAttachments:parseInt(data.MaxAttachments),mailRestoreList:[]},options={RealNames:userRealNames.getRealNames(),editorId:this.options.editorId,MessageId:data.MessageId||"",AbjsHash:data.AbjsHash||"",checkAvatarUrl:patron.Utils.getAvatarSrc(patron.useremail,null,90),fileUploaderSettings:fileUploaderSettings,map_inline_img:{},isNewMessage:0,submitEmptyMessageConfirmSuccess:false,html:""+(data.letbody_html||""),text:""+(data.letbody_plain_Text_HTML||data.letbody_plain||""),initialMessageText:data.initialMessageText};this._clearAttaches();if(data.Attaches){fileUploaderSettings["mailRestoreList"]=data.Attaches.files;this._restoreAttaches(data.Attaches.cloud_link,"cloud_link");this._restoreAttaches(data.Attaches.tnef,"tnef")}if(data.RADAR_ON){options.fileUploaderSettings["radar_config"]={t:data.radar_type,p:"mail3",f:data.front_name2}}options.text=options.text.replace(/\r/g,"");if(data.map_inline_img&&$.type(data.map_inline_img)=="string"){options["map_inline_img"]=eval("({"+data.map_inline_img+"})")}if(!(formData.value.re_msg||formData.value.draft_msg||formData.value.fwd_msg||formData.value.schedule_msg||formData.value.actionId)){options["isNewMessage"]=1}this.options=$.extend({},this.options,options);var headData=provider.getData(formData).head;headData.collapsed=this.composeUI.mode==="fast-reply"&&formData.value.re_msg;if(this._from){headData.email=this._from}this.composeUI.renderHead(headData);var editor=this.getEditor();var signId;$.each(this.options.RealNames,function(a,b){if(b.selected){signId=b.id;return false}});if(editor){var control=editor.controlManager.get("signature");if(control){control.setActiveRealName(signId)}}if(this.templates){this.templates.setActiveTemplate(formData.value.draft_msg,!data.noedit);if(this._getMessageMode()=="templates"){this.templates.setTemplate(null,true)}}if(reset){this.trigger("redraw-reset");return this}this._setRealName(signId);if(headData.emails.length>1){$.event.trigger("ui-abstract-action",{chain:["compose","sender","emails","many"]})}if(Object.keys(headData.signatures).length>1){$.event.trigger("ui-abstract-action",{chain:["compose","sender","names","many"]})}$(window).triggerHandler("changeFieldVisible.compose");this.messageMode=this._getMessageMode();if(this.multiAttachToComposeUI){this.multiAttachToComposeUI.reset()}if(this.mobileVersion){this._mobileVersionReady()}else{if(this.deviceVersion){this._deviceVersionReady()}else{this._fullVersionReady()}}this.triggerHandler("redraw");this.composeUI.redraw();if(this.multiAttachToComposeUI){if(data.Attaches){if(data.Attaches.forward.length){this.multiAttachToComposeUI.restoreFiles(data.Attaches.forward,"filesearch")}if(data.Attaches.cloud.length){this.multiAttachToComposeUI.restoreFiles(data.Attaches.cloud,"cloud")}}}if(ajs.offline){this._onChangeOfflineMode(null,true)}if(this.fileUploader.uploaderHTML5){this.fileUploader.uploaderHTML5.unbind("attachFiles",this.attachFilesListener).bind("attachFiles",this.attachFilesListener);this.enableSubjectFromAttachments.gap(this,100)()}if(data.showcards&&this.decoration){this.decoration.hide();this.decoration.show("cards",0);this.getEditor().controlManager.get("cards").setActive(true)}if((data.card||data.appearance)&&this.decoration){var type=data.card?"cards":"appearance",control=data.card?"cards":"design",itemId=data.card||data.appearance;this.decoration.hide();this.decoration.show(type,0,itemId);this.getEditor().controlManager.get(control).setActive(true)}$.event.trigger("compose-form-redraw",this._getState());this._disableSaveTemplates();return this},_composeUIEvents:function(){this.composeUI.on("openMoneyPopup",function(){var a=flags.get("money-send");if(a&&a.isActive()){a.save({state:true})}});this.composeUI.on("sender:change",function(a,b){var c,d;if(b.target==="signature"){c=this.getEditor();if(c){d=c.controlManager.get("signature");if(d){d.setActiveRealName(b.num)}}this._setRealName(b.num)}else if(b.target==="email"){this.setFrom(b.text)}}.bind(this));this.composeUI.on("controls:toggle",function(a,b){var c=patron.EditorBits[b.name];if(b.state){patron.EditorFlags|=c}else{patron.EditorFlags&=~c}this.setEditorFlags();this._updateGeometryWithTriggerResize()}.bind(this))},_initAddressBook:function(){this.$form.on("tap",".js-addressbook-link",function(a){var b=$(a.currentTarget);var c=function(a){return{compose_to:"To",compose_cc:"CC",compose_bcc:"BCC"}[a]}(b.attr("data-for"));this._openAddressBook(c)}.bind(this))},setFrom:function(a,b){this._from=a;this._setLastFrom(b)},_getFrom:function(){return this._from},_setNameDropdownValue:function(a,b){this.composeUI.setCurrentSignature(a,b)},_setLastFrom:function(a){this.composeUI.setCurrentEmail(this._from);var b=this.signatures.find(function(b){return a?b.default:b.selected});if(b){this._setRealName(b.id,a===false)}},_clearAttaches:function(){this.Attaches={tnef:{},inline:{},inlineUploaded:{},cloud_link:{},forward:{sizes:{},size:0,files:{}},cloud:{sizes:{},size:0,files:{}}};this.composeUI.removeAttachments()},_addToggleEditorToolbarObserver:function(){this._removeToggleEditorToolbarObserver();var a=this.getEditor();a.onFocus.add(this.toggleEditorToolbarObserver);a.onClick.add(this.toggleEditorToolbarObserver)},_removeToggleEditorToolbarObserver:function(){var a=this.getEditor();a.onFocus.remove(this.toggleEditorToolbarObserver);a.onClick.remove(this.toggleEditorToolbarObserver)},_onToggleEditorFocus:function(){this._removeToggleEditorToolbarObserver();if(!this._editorFocused){this.toggleEditorToolbar(true);this._updateGeometryWithTriggerResize();$.event.trigger("ui-abstract-action",{chain:["compose","editor-body","click"]})}},_showSuccessSaveMailMessage:function(a,b){var c=new Date;var d=b?Lang.get("compose.save_template_success"):Lang.get("compose.save_mail_success");if(this.isScheduleActive()){d=b?Lang.get("compose.save_template_success_short"):Lang.get("compose.save_mail_success_short");if(this.composeUI.mode==="fast-reply"){d=b?Lang.get("compose.save_template_success_fastreply"):Lang.get("compose.save_mail_success_fastreply")}}this.$form.trigger("compose-loading",{state:false}).trigger("compose-error",{state:false}).trigger("compose-success",{text:d,auto:a,time:c.getLocaleTime(),state:true})},_showLoading:function(){var a=this._isSavingTemplates?Lang.get("compose.save_template_progress"):Lang.get("compose.save_mail_progress");if(this.isScheduleActive()){a=this._isSavingTemplates?Lang.get("compose.save_template_progress_short"):Lang.get("compose.save_mail_progress");if(this.composeUI.mode==="fast-reply"){a=""}}this.$form.trigger("compose-error",{state:false}).trigger("compose-success",{state:false}).trigger("compose-loading",{text:a,state:true})},isScheduleActive:function(){return this.getSendDate()!==""},getSendDate:function(){return this.$form.find('[name="Schedule"]').val()||""},toggleEditorToolbar:function(a){this._editorFocused=a;var b=this.getEditorToolbar();if(a){b.removeAttr("style")}else{b.css({height:"0",overflow:"hidden"})}},getBottomControlsContainer:function(){return this.$form.find(".compose-attachments")},setUIMod:function(a){this.composeUI.setMode(a)},transfer:function(){this.translator.translate()}}}});define("plugins/AjaxCall",["jquery","plugins/jQueryEvent"],function(){(function($){jsClass.create("AjaxCall").statics({redirect:function(a){AjaxCall.triggerHandler("beforeredirect");window.location.href=a},parseArray:function(a){var b=null;if($.isArray(a)){var c=a[1];if(c==="Redirect"){AjaxCall.redirect(a[2])}else if(c==="OK"){b=a.slice(2);if(b.length==1)b=b.shift()}}return b},parseResponse:function(a){var b;try{b=$.parseJSON(a,{url:"AjaxCall.parseResponse"})}catch(a){}return AjaxCall.parseArray(b)},send:function(a,b,c,d,e){for(var f=[],g,h=0,i=c.length;h<i;h++){g=c[h];if(typeof g==="string"){g=g.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r")}f.push(g)}return $.ajax({url:a,type:"post",data:{ajax_call:1,func_name:b,data:'["'+f.join('","')+'"]'},dataType:"json",complete:function(b,c){return function(d){var e,f;try{e=$.parseJSON(d.responseText,{url:a})}catch(a){}if($.isArray(e)){var g=e[1];if(g==="Redirect"){AjaxCall.redirect(e[2])}else if(g==="OK"){f=e.slice(2);if(f.length==1)f=f.shift();b.call(d,f)}else{c.call(d)}}else{c.call(d)}}}(d||$.noop,e||$.noop)})}});$.extend(AjaxCall,new jQueryEvent)})(jQuery)});define("patron.ui/patron.ui.AttachToCompose",["ajs/pkg","liaz677","jquery","plugins/jQueryEvent","plugins/Layer","toolkit-common/waypoints/_min/waypoints_min"],function(a,b,$){jsClass.create("patron.ui.AttachToCompose").extend(jQueryEvent).statics({defaultOptions:{notFoundText:Lang.get("filesearch.not_found"),templateExpandId:"#AttachViewer__list__thumbnail_ejs",templateCompactId:"#files-search__messageline_ejs",waypoint:{context:".js-wrapper",offset:"bottom-in-view"},spaceLeft:0,filesLimit:0,filesCount:0,listClick:$.noop,load:$.noop}}).methods({__construct:function(a){this.options=$.extend({},patron.ui.AttachToCompose.defaultOptions,a);this.total=this.offset=0;this.files=[];this.filesMap={};this.checkedFilesMap={};this.isDataLoadSetFalse=function(){this.isDataLoad=false}.debounce(100,this);this.waypointTickObserver=this._waypointTick.bind(this);this.listClickObserver=this._listClick.bind(this);this.listMouseWheelObserver=this._listMouseWheel.bind(this);this.resizeObserver=this._resize.bind(this);this.switcherClickObserver=this._switcherClick.bind(this)},_initialize:function(){this.$switcher=this.layer.$div.find(".js-switcher");this.$waypoint=this.layer.$div.find(".js-waypoint");this.$list=this.layer.$div.find(".js-list");this.$wrapper=this.layer.$div.find(".js-wrapper");this.$loading=$("<p>"+Lang.get("notify.load")+"&#133;</p>");this.$notFound=$("<p>"+this.options.notFoundText+"</p>");this.$error=this.layer.$div.find(".js-error");this.$switcher.unbind("click").bind("click",this.switcherClickObserver);this.$list.unbind("click").bind("click",this.listClickObserver);this.triggerHandler("initialize")},show:function(a){$.extend(this.options,a);if(this.layer){this.layer.show()}else if(!this.layerloading){this.layerloading=true;Layer.get(this.options.layer,function(a){this.layer=a;a.bind({callback:function(a,b){if(b){var c=this._getSelectedFiles();this.triggerHandler("select",[c])}this.triggerHandler("layerCallback",[b])}.bind(this),show:function(){this._show()}.bind(this),hide:function(){this._hide()}.bind(this)});this._initialize();a.show()}.bind(this))}},hide:function(){this.layer.hide()},_show:function(){this.$switcher.toggleClass("attachlist__header__mode_short",!!patron.MailFilesViewStyle);this.$waypoint.waypoint(this.waypointTickObserver,this.options.waypoint);b.on("resize",this.resizeObserver);this.resizeObserver();this.$wrapper.show();this._updateDisabled();this.triggerHandler("show");this.reload()},_hide:function(){this.isDataLoad=false;this._clearData();this.filesMap={};this.checkedFilesMap={};this.$waypoint.waypoint("destroy");$(window).unbind("resize",this.resizeObserver);this.$wrapper.css("height","").hide();this.triggerHandler("hide")},_getSelectedFiles:function(){var a=[];$.each(this.checkedFilesMap,function(b){a.push(this.filesMap[b])}.bind(this));return a},_listMouseWheel:function(a){if(this.isDataLoad||this.total&&this.offset<this.total&&this.$wrapper[0].scrollHeight-this.$wrapper[0].scrollTop-this.$wrapper[0].offsetHeight<=0){a.preventDefault()}},_resize:function(){this._update();this.layer.mainDiv._resize();this.triggerHandler("resize")},_update:function(){var b=a.windowHeight();var c=this.layer.$div.height();var d=this.$wrapper[0].offsetHeight;var e=c-d;var f=a.windowHeight()/2;var g=175;var h=20;var i=Math.min(b-h-e,f);if(i<g)i=g;this.$wrapper.css("height",i)},_waypointTick:function(){if(!this.isDataLoad&&this.offset<this.total){this._load()}},_clearData:function(){this.$list.empty();this.files=[];this.total=this.offset=0},reload:function(){this._clearData();this._load()},_load:function(){var a=this.loadDeferred;this.isDataLoad=true;if(a){a.reject()}this.loadDeferred=a=new $.Deferred;this.$notFound.detach();this.$list.append(this.$loading);this.options.load(this.offset,function(b,c){a.done(function(){this._loadComplete(b,c)}.bind(this)).resolve()}.bind(this))},_loadComplete:function(b,c){if(b.length){this.total=c;this.offset+=b.length;$.each(b,function(b,c){var d=a.uuid(c.PartID);c.uid=d;this.filesMap[d]=c;this.files.push(c)}.bind(this));this.$list.html(this._getHTMLTemplate(b));this._updateDisabled()}else{this.$list.html(this.$notFound)}this.$loading.detach();$.waypoints("refresh");this.isDataLoadSetFalse()},_getHTMLTemplate:function(a){var b=this._getSelectedFiles();var c={disabled:b.length>=this.options.filesLimit-this.options.filesCount,selected:this.checkedFilesMap,newsnippets:1,Attachments:a,messages:a};var d=this.options.templateExpandId;if(patron.MailFilesViewStyle){d=this.options.templateCompactId}return $.tpl(d,c)},_updateDisabled:function(){var b=0;var c=this._getSelectedFiles();var d=false;if(c.length>=this.options.filesLimit-this.options.filesCount){d=true;this.$error.fadeIn().find(".js-error-text").text(String.sprintf.apply(a,[Lang.get("upload.limit"),a.plural(this.options.filesLimit,"files.plural"," ")]))}else{this.$error.hide()}$.each(c,function(a,c){b+=c.size});var e=Math.max(this.options.spaceLeft-b,0);var f={};if(this.options.hasSpaceLimit){$.each(this.files,function(a,b){if(b.size>e){f[b.PartID]=b}})}var g,h,i;$(".js-item",this.$list).each(function(){g=$(this);h=$(".js-input",g);i=g.data("fileId");if((f[i]||d)&&!h.prop("checked")){h.prop("disabled",true)}else{h.prop("disabled",false)}})},_listClick:function(a){var b=$(a.target);var c=b.closest(".js-item",this.$container);var d=b.closest(".js-link",c);var e=b.closest(".js-label",c);var f=c.find(".js-input");var g=b.closest(".js-preview",c);var h=c.data("fileId");if(!f.prop("disabled")&&!g.length&&h){var i=this.filesMap[h];if(i){if(e.length){if(f.prop("checked")){this.checkedFilesMap[h]=1}else{delete this.checkedFilesMap[h]}}else if(c.length&&d.length){if(f.prop("checked")){f.prop("checked",false);delete this.checkedFilesMap[h]}else{if(!i.disableShowCheckbox){f.prop("checked",true);this.checkedFilesMap[h]=1}if(!b.hasClass("js-input")){if(!this.options.listClick(i)){var j=this._getSelectedFiles();if(j.length==1){this.triggerHandler("select",[j]);this.hide()}}}}a.preventDefault()}this._updateDisabled()}}else if(f.prop("disabled")){a.preventDefault()}},_switcherClick:function(){patron.MailFilesViewStyle=!patron.MailFilesViewStyle;this.$switcher.toggleClass("attachlist__header__mode_short",!!patron.MailFilesViewStyle);if(this.files.length){var a=this._getHTMLTemplate(this.files);this.$list.html(a);this.$wrapper.scrollTop(0)}else{this.$list.html(this.$notFound)}this._updateDisabled();this.triggerHandler("switcherClick")}})});define("patron.ui/patron.ui.AttachFromFileSearch",["patron.ui/patron.ui.AttachToCompose","utils/Counter","plugins/Dropdown","patron.attachViewer/patron.FullAttachViewer.Utils"],function(){jsClass.create("patron.ui.AttachFromFileSearch").extend(jQueryEvent).statics({defaultOptions:{layer:"attachFromFileSearch",loadData:{name_needle:"",folder_id:0,content_type_id:-1,offset:0,limit:12}}}).methods({__construct:function(a){this.options=$.extend({},patron.ui.AttachFromFileSearch.defaultOptions,a);this.loadData=$.extend({},this.options.loadData);this.attachToCompose=new patron.ui.AttachToCompose($.extend(this.options,{load:this._load.bind(this)}));this.attachToCompose.bind({initialize:this._initialize.bind(this),show:this._show.bind(this),hide:this._hide.bind(this),select:this._select.bind(this),switcherClick:this._switcherClick.bind(this),layerCallback:this._layerCallback.bind(this)});this.searchButtonClickObserver=this._searchButtonClick.bind(this)},_initialize:function(){var a=this.attachToCompose.layer;this.$searchField=a.$div.find(".js-search-field");this.$searchButton=a.$div.find(".js-search-button");a.$div.find("#filesearch__folders").tpl("#filesearch__folders_ejs",{folders:patron.Folders.getAll()});this.$dropdownSelectFolder=$(".js-dropdown-select-folder",a.$div).dropdown({link:".dropdown__button-inline",container:".dropdown__list",orientation:"auto",onToggle:function(){Counter.sb(1345762)},onClick:function(b,c){var d=$(".js-prefix",a.$div);var e=$(b.target).closest(".dropdown__list__item",c.$container);var f=$(".dropdown__button-inline__text",c.$link);var g=e.data("id"),h=e.data("value"),i=e.data("prefix");if(e.length){f.text(h);d.text(i);if(this.loadData.folder_id!=g){this.loadData.folder_id=g;this.attachToCompose.reload()}}c.hide()}.bind(this)});this.$dropdownSelectType=$(".js-dropdown-select-type",a.$div).dropdown({link:".dropdown__button",container:".dropdown__list",orientation:"auto",onClick:function(a,b){var c=$(a.target).closest(".dropdown__list__item",b.$container);var d=$(".dropdown__list__item__link__text",c);var e=$(".dropdown__button__text",b.$link);var f=c.data("type");if(c.length){e.text(d.text());if(this.loadData.content_type_id!=f){this.loadData.content_type_id=f;this.attachToCompose.reload()}}if(f=="1")Counter.sb(1345752);else if(f=="4")Counter.sb(1345753);else if(f=="2")Counter.sb(1345754);else if(f=="3")Counter.sb(1345755);else if(f=="0")Counter.sb(1345756);else if(f=="-1")Counter.sb(1345759);b.hide()}.bind(this)});this.$searchButton.bind("click",this.searchButtonClickObserver)},_show:function(){this.$dropdownSelectType.find(".js-default").click();this.$searchField.val("");this.attachToCompose.layer.mainDiv.$innerDiv.css("width",722);$(window).triggerHandler("resize")},_hide:function(){this.attachToCompose.layer.mainDiv.$innerDiv.css("width","")},_load:function(a,b){patron.Ajax({url:"/cgi-bin/filesearch_ajax?ajax_call=1&func_name=ajax_search",data:$.extend(this.loadData,{offset:a}),complete:this._loadComplete.bind(this,b)})},_loadComplete:function(a,b){var c=b.getData(),d=[],e=0;if(c&&c.total){e=c.total;var f={MainMailHost:location.host};$.each(c.list,function(a,b){b=$.extend({PartID:[b.id].concat(b.n).join(";")},b);if(b.content_type_id==1){if(b.name){if(!/^tiff?$/i.test(b.name.replace(/(.*)\./,"").toLowerCase())){b.IsImage=b.ShowThumbnail=1}}}f.Id=b.id;var c=patron.FullAttachViewer.Utils.createFileDescription(f,b,a);d.push(c)})}a(d,e)},_select:function(a,b){this.triggerHandler("select",[b])},_searchButtonClick:function(a){a.preventDefault();this.loadData.name_needle=this.$searchField.val();this.attachToCompose.reload();Counter.sb(1345769)},_switcherClick:function(){Counter.sb(1345766)},_layerCallback:function(a,b){if(b){Counter.sb(1345771)}else if(b===false){Counter.sb(1345772)}},show:function(a){this.attachToCompose.show(a)},reset:function(){$.extend(this.loadData,this.options.loadData);if(this.$dropdownSelectFolder){this.$dropdownSelectFolder.find(".js-default").click()}}})});define("patron.ui/patron.ui.AttachFromCloud",["advert/mimic/Locator","patron.ui/patron.ui.AttachToCompose","fest!pages/b-nav__group","jQuery/jquery.fest-x"],function(a){var b=function(){var a={};var b;function c(b){return a[e(b)]!==undefined}function d(a){return Array.map(a.split(/\//),function(a){try{return decodeURIComponent(a)}catch(b){return a}}).join("/")}function e(a){return d(a)}function f(b,c){if(!(b instanceof Array)){b=[b]}Array.forEach(b,function(b){var d=a[b].parent;var e=g(b)?"sub_folders":"files";a[d].count[e]+=c});return this}function g(b){var c=a[b];return c&&(c.kind==="folder"||c.kind==="storage")}return{init:function(c,d,e){d=d||[];b=e;a["/"]={kind:"storage",name:c,items:[],id:"/"};Array.forEach(d,function(a){if(a&&a.list){this.setFolder(a)}},this);return this},sortParentItems:function(b){if(!(b instanceof Array)){b=[b]}var c={};b.forEach(function(b){c[a[b].parent]=true});Object.keys(c).forEach(function(b){a[b].items.sort(function(b,c){var d=g(b);var e=g(c);if(d!==e){return d?-1:1}else{var f=a[b].name.toLowerCase();var h=a[c].name.toLowerCase();return f==h?0:f>h?1:-1}})});return this},increaseParentCount:function(a){return f.call(this,a,1)},decreaseParentCount:function(a){return f.call(this,a,-1)},setFolder:function(b){if(!b.id){throw new Error("Bad folder")}b.id=e(b.id);if(!c(b.id)){this.setItem({id:b.id,name:b.name,items:[],count:{files:0,sub_folders:0},kind:"folder",parent:b.parent||b.folder},b.parent||b.folder)}if(!a[b.id].count){a[b.id].count=b.count}a[b.id].__loaded=true;if(b.list){Array.forEach(b.list,function(a){this.setItem(a,b.id)}.bind(this))}return this},setItem:function(b,c){if(!b.id){throw new Error("Bad item")}if(!a[c]){throw new Error("Bad parent "+c)}b.id=e(b.id);b.parent=c;a[b.id]=b;if(Array.indexOf(a[c].items,b.id)===-1){a[c].items.push(b.id)}if(b.kind==="folder"){if(b.items===undefined){b.items=[]}if(b.count===undefined){b.count={files:0,sub_folders:0}}}return this},remove:function(b){if(!(b instanceof Array)){b=[b]}Array.forEach(b,function(b){var c=a[b];a[c.parent].items=Array.filter(a[c.parent].items,function(a){return a!==b});delete a[b]});return this},move:function(b,c,d){var e=[];Array.forEach(c,function(b,c){e.push(a[b]);a[b].id=d[c]}.bind(this));this.remove(c);Array.forEach(e,function(a){this.setItem(a,b)}.bind(this));return this},rename:function(b,c,d){var e=a[b];this.remove(b);e.id=c;e.name=d;this.setItem(e,e.parent);return this},isLoaded:function(b){return c(b)&&(!g(b)||a[b].__loaded)},has:function(a){return c(a)},folder:function(b){if(!b){throw new Error("Undefined item")}var c=a[b];if(!c){throw new Error("Undefined item")}return g(b)?c.id:c.parent},file:function(b){var c=a[b];return g(b)?null:c},items:function(b){return Array.map(a[this.folder(b)].items,function(b){return a[b]})},get:function(b){return a[b]},isFile:function(a){return!g(a)},isFolder:g,ancestorsOrSelf:function(b){var c=[],d;while(d=a[b]){c.unshift(b);b=d.parent}return c},clearCache:function(){var b=this.get("/");b.__loaded=false;b.items=[];a={"/":b}},ancestors:function(a){var b=this.ancestorsOrSelf(a);if(b[b.length-1]===a){b=b.slice(0,-1)}return b}}};var c=function(a,b){var c={};var d={tree:function(){return a},cid:function(){return b.folder}};var e={buildHref:function(a){return"#"},folderItems:function(){return[]}};return{foldersTree:function(){var a=d.tree().ancestors(d.cid());var b={active:d.tree().folder(d.cid()),group:d.tree().get("/").name,groupId:"/",items:[]};var f=function(b,g){var h=d.tree().get(g);if(h&&h.items&&h.items instanceof Array){for(var i in h.items){var j=h.items[i];if(d.tree().isFolder(j)){var k=d.tree().get(j);var l={icon:"ico_folder_user",text:k.name,id:j,href:e.buildHref({id:j}),items:[]};if(k.count.sub_folders){var m=c[j]||Array.indexOf(a,j)!==-1;l.foldings=m?"open":"close"}b.items.push(l);f(l,j)}}}};f(b,"/");return b},foldingFolder:function(a,b){c[a]=b},isFolder:function(a){return d.tree().isFolder(a)},isFile:function(a){return d.tree().isFile(a)},folder:function(){return d.tree().get(d.tree().folder(d.cid()))},folderItems:function(){var a={active:d.tree().isFile(d.cid())?[d.cid()]:[],items:[]};d.tree().items(d.cid()).forEach(function(b){a.items.push($.extend({},b,{filename:b.name,title:b.name,src:b.thumbnails?b.thumbnails["160x120"]:"",id:b.id,href:d.tree().isFolder(b.id)?e.buildHref({id:b.id}):b.url.view,descr:b.size,ctrl:true}))});return a},folderFiles:function(){var a=e.folderItems();a.items=a.items.filter(function(a){return!d.tree().isFolder(a.id)});return a},foldersBreadcrumbs:function(){return Array.map(Array.filter(d.tree().ancestorsOrSelf(d.cid()),function(a){return d.tree().isFolder(a)}),function(a){return{text:d.tree().get(a).name,id:a,href:e.buildHref({id:a})}})},isSubTreeNode:function(a,b){var c=false;var e=d.tree().ancestorsOrSelf(b);a.forEach(function(a){if(!c&&Array.contains(e,a)){c=true}});return c}}};jsClass.create("patron.ui.AttachFromCloud").extend(jQueryEvent).statics({defaultOptions:{layer:"attachFromCloud",loadData:{storage:"home",folder:"/",offset:0,limit:500,sort:{type:"name",order:"asc"}}}}).methods({__construct:function(a){this.options=$.extend({},patron.ui.AttachFromCloud.defaultOptions,a);this.loadData=$.extend({},this.options.loadData);this.Tree=new b;this.Folder=new c(this.Tree,this.loadData);this.attachToCompose=new patron.ui.AttachToCompose($.extend(this.options,{load:this._load.bind(this),listClick:this._listClick.bind(this),notFoundText:Lang.get("filesearch.empty_dir")}));this.attachToCompose.bind({initialize:this._initialize.bind(this),show:this._show.bind(this),hide:this._hide.bind(this),select:this._select.bind(this),resize:this._resize.bind(this)});this.navigationLinkClickObserver=this._navigationLinkClick.bind(this);this.navigationToggleFoldingClickObserver=this._navigationToggleFoldingClick.bind(this)},_initialize:function(){var a=this.attachToCompose.layer;this.$navigation=a.$div.find(".js-navigation");this.$navigation.delegate('[data-name="toggle-foldings"]',"click",this.navigationToggleFoldingClickObserver);this.$navigation.delegate(".js-href","click",this.navigationLinkClickObserver);this.Tree.init(Lang.get("cloud"))},prepareFileData:function(a,b){a.id=a.id||a.home;var c={MainMailHost:location.host,Id:a.id};a=$.extend({PartID:[a.id].concat(a.n).join(";"),from_to_email:a.name,uid:ajs.MD5(a.id+";")},a);var d=patron.FullAttachViewer.Utils.createFileDescription(c,a,b);d.previewSrc=d.previewWithCropUrl=null;d.disableShowFrom=d.disableShowSubject=true;if(a.kind=="folder"){d.disableShowCheckbox=d.disableShowSize=true;d.iconType="folder"}if(a.thumbnails&&a.thumbnails["160x120"]){d.previewSrc=d.previewWithCropUrl=a.thumbnails["160x120"]}return d},show:function(a){this.attachToCompose.show(a)},reset:function(){$.extend(this.loadData,this.options.loadData)},_show:function(){this.attachToCompose.layer.mainDiv.$innerDiv.css("width",918);this.$navigation.show();$(window).triggerHandler("resize")},_hide:function(){this.attachToCompose.layer.mainDiv.$innerDiv.css("width","");this.$navigation.css("height","").hide()},_loadFolder:function(a,b){patron.API({url:"cloud/folder",data:$.extend({htmlencoded:false},a),complete:b})},_load:function(a,b){var c=this.loadData.folder,d;if(this.Tree.isLoaded(c)){var e=this.Tree.get(c);var f=this._getFolderData(e);var g=f.files.slice(a);if(g.length){d={files:g,total:f.total}}}if(d){this._renderNavigation(e);b(d.files,d.total)}else{this._loadFolder($.extend(this.loadData,{offset:a}),this._loadComplete.bind(this,b))}},_loadComplete:function(a,b){var c=[],d=0;if(b.isOK()){var e=b.getData();if(e){this.Tree.setFolder(e);var f=this.Tree.get(e.id);if($.isArray(e.list)){Array.forEach(e.list,function(a,b){c.push(this.prepareFileData(a,b))},this)}d=f.count.files+f.count.sub_folders;this._renderNavigation(f)}}a(c,d)},_getFolderData:function(a){var b=[],c=0,d=this.Tree.items(a.id);c=a.count.files+a.count.sub_folders;$.each(d,function(a,c){b.push(this.prepareFileData(c,a))}.bind(this));return{files:b,total:c}},_listClick:function(a){if(a.kind=="folder"){this.loadData.folder=a.id;this.attachToCompose.reload();return true}return false},_navigationLinkClick:function(a){a.preventDefault();a.stopPropagation();var b=$(a.currentTarget);this.loadData.folder=b.data("id");this.attachToCompose.reload()},_navigationToggleFoldingClick:function(b){b.preventDefault();b.stopPropagation();var c=$(b.currentTarget);var d=c.closest(a.selector(".b-nav__item"),this.$navigation);var e=c.find(a.selector(".b-nav__item__folding__arrow"));var f=d.data("id");var g=this.$navigation.find('[data-parent="'+f+'"]');e.toggleClass(a.lookup("b-nav__item__folding__arrow_open b-nav__item__folding__arrow_close"));g.toggleClass(a.lookup("b-nav__subitems_open b-nav__subitems_close"));var h=e.hasClass(a.lookup("b-nav__item__folding__arrow_open"));if(!this.Tree.isLoaded(f)){var i=d.find(".ico");if(h){this._loadFolder($.extend({},this.loadData,{folder:f}),function(a){if(a.isOK()){var b=a.getData();if(b){this.Tree.setFolder(b);var c=this.Tree.get(b.id);this.Folder.foldingFolder(b.id,h);this._renderNavigation(c)}}}.bind(this))}else{this.Folder.foldingFolder(f,h)}}else{this.Folder.foldingFolder(f,h)}},_renderNavigation:function(a){this.$navigation.fest("pages/b-nav__group",{folders:this.Folder.foldersTree(a.id),mods:["foldings-and-icons","cloud"]})},_resize:function(){this.$navigation.css("height",this.attachToCompose.$wrapper.height())},_select:function(a,b){this.triggerHandler("select",[b])}})});define("patron.compose/patron.Compose.FormValidator",["jquery"],function(){(function($){jsClass.create("patron.Compose.FormValidator").methods({__construct:function(a){var b=this;b.$form=$(a)},unactive:function(){},validate:function(){var a=this;var b;b=a._formElm("To");if(!$.trim(b.val())&&!$.trim(a._formElm("CC").val())&&!$.trim(a._formElm("BCC").val())){alert(Lang.get("compose.field_to_empty"));b.focus();$.event.trigger("ui-abstract-action",{chain:["compose","send_error","empty_address"]});return false}else if(patron.ComposeLabels){var c=["To","CC","BCC"],d,e=0;for(;e<c.length;e++){b=a._formElm(c[e]);d=b.closest(".js-compose-labels").composeLabels("widget");if(d&&!d.isValid()){ajs.log("invalid",c[e]);var f=Lang.get("compose.field.invalid_address"),g=Lang.get("compose.field."+c[e]);alert(String.sprintf(f,g));b.focus();return false}}}return true},_formElm:function(a){return $('input[name="'+a+'"], textarea[name="'+a+'"]',this.$form)}})})(jQuery)});define("patron.compose/patron.Compose.FileUploaderJS",["ajs/pkg","jquery","plugins/AjaxCall","plugins/Layer","plugins/jQueryEvent"],function(a,b){(function($){jsClass.create("patron.Compose.FileUploaderJS").extend(jQueryEvent).methods({__construct:function(b,c){var d=this;d.options=$.extend({},patron.Compose.FileUploaderJS.defaultOptions,c);d.$form=$(b);d.$form.data("defaultAction",d.$form.attr("action"));d.$form.data("defaultTarget",d.$form.attr("target"));d.filesCount=d.filesSize=0;d.fileMap={};d.filesData={};var e=d.options.domIDs;d.$container=$(e.JSUploaderContainer);d.$filesList=$(".list:first",d.$container);d.$filesCount=$(".fCount:first",d.$container);d.$filesSize=$(".fSize:first",d.$container);d.fileTpl=$(e.JSUploaderFileTpl).html();d.bind("onQueueChanged",$.proxy(function(){var a=this;a._updateFilesCount();a._updateFilesSize();a._updateContainerVisible()},d));d.$browseFileInput=$('input[type="file"]:first',e.BrowseFile);d._addBrowseInputFileEvents();d.$uploadFrame=$('<iframe src="javascript:false;" name="id'+a.uniqId()+'"/>').hide().appendTo(b).bind("load error",$.proxy(d._frameLoad,d))},_updateContainerVisible:function(){var a=this;a.$container.toggleClass("jsdn",a.filesCount<=0);$(window).resize()},_addBrowseInputFileEvents:function(){var a=this;a.$browseFileInput.change($.proxy(a._browseInputChange,a))},_browseInputChange:function(){var b=this;b.submiting=true;b.$form.attr({action:"/cgi-bin/sentmsg?ajax_upload=1&compose_name="+b.settings.name+"&r="+a.uniqId(),target:b.$uploadFrame.prop("name")}).trigger("submit",[{force:true}]);b.triggerHandler("onQueueStart")},_frameLoad:function(){var a=this;if(a.submiting){a.submiting=false;var b=a.$browseFileInput;var c=$('<input type="file"/>').prop({class:b.prop("class"),name:b.prop("name"),multiple:b.prop("multiple")});b.replaceWith(a.$browseFileInput=c);a._addBrowseInputFileEvents();a.$form.attr({action:a.$form.data("defaultAction"),target:a.$form.data("defaultTarget")});a.triggerHandler("onQueueChanged",[a.filesCount]);a.triggerHandler("onQueueFinsh")}},_updateFilesCount:function(){var a=this;a.$filesCount.html(String.num(a.filesCount,Lang.get("files.plural")," "))},_updateFilesSize:function(){var a=this;a.$filesSize.html(String.sizeFormat(a.filesSize))},_deleteFileClick:function(a){var b=this;var c=$(a.target);var d=c.parents(".mlr-snd_fls_itm:first");require(["patron.build/MessagesLayers"],function(){FestLayers("layers/messages/allactions",{uri:"/compose/deleteAttach"},function(a){var c=b.getConfirmLayer();c.one("callback",function(a){return function(c,d){if(d)b._deleteFile(a)}}(d))[0].show()})});a.preventDefault()},_deleteFile:function(a){var b=this;var c=a.data("file");AjaxCall.send(b.config.UploadConfig[1].AjaxURI.replace(/^https?:/,""),"cbHardDeleteFile",[c.Id,"message="+b.settings.MessageId]);a.remove();b.filesCount--;b.filesSize-=~~c.Size;delete b.filesData[c.Id];b.triggerHandler("onQueueChanged",[b.filesCount])},_addFileEvents:function(a){var b=this;$(".mlr-snd-del:first",a).click($.proxy(b._deleteFileClick,b))},_prepareFileData:function(a){a.Size=a.Size||0;return $.extend(a,{SizeForShow:String.sizeFormat(a.Size),FileExt:a.FileName.replace(/(.*)\./,"").toLowerCase()})},_progressUpload:function(){},_addFile:function(a,b){var c=this;var d=c._prepareFileData(b);var e=$(String.supplant(c.fileTpl,d));if(c.fileMap[a]){c.fileMap[a].replaceWith(e)}else{c.filesCount++;c.filesSize+=~~b.Size;c.$filesList.append(e)}c.filesData[d.Id]=d;e.data("file",b);c._addFileEvents(e)},getConfirmLayer:function(){var a=this;return a.layer||(a.layer=new Layer("is-compose-deleteAttach"))},init:function(a,b){var c=this;c.settings=a;c.config=b;c.initFiles(a.mailRestoreList)},unactive:function(){},reset:function(){var a=this;a.$filesList.empty();a.filesData={};a.filesCount=a.filesSize=0;a.triggerHandler("onQueueChanged",[a.filesCount])},getUploadedAttachments:function(){var a=this,b=[];$.each(a.filesData,function(a,c){b.push({fileid:c.Id,filesize:c.Size})});return b},getFiles:function(){return[]},initFiles:function(a){var b=this;b.$filesList.empty();b.filesCount=b.filesSize=0;if(a){$.each(a,$.proxy(function(a,b){var c=this;c.filesCount++;c.filesSize+=b.filesize;var d=c._prepareFileData({Id:b.fileid,Size:b.filesize,FileName:b.filename});c.filesData[d.Id]=d;var e=$(String.supplant(c.fileTpl,d)).appendTo(c.$filesList).data("file",d);c._addFileEvents(e)},b))}b.triggerHandler("onQueueChanged",[b.filesCount])},attachUpload:function(a,b,c){var d=this;if(b.Error){d.triggerHandler("fileLoadError",[b])}else{d._addFile(a,b,c);d.triggerHandler("onQueueChanged",[d.filesCount]);d.triggerHandler("onQueueFinsh")}}})})(b)});define("patron.compose/patron.Compose.FileUploaderSWF",["jquery","mrg-js-cookie","jsCore/swfobject","plugins/jQueryEvent"],function(a,b){(function($){jsClass.create("patron.Compose.FileUploaderSWF").extend(jQueryEvent).statics({previewSizeLimit:Math.MB*10,defaultOptions:{allowVersion:"10.0.12"},createPreviewDataURL:function(a,b,c){var d=Math.max(b/a.width,c/a.height),e=a.width*d,f=a.height*d,g=document.createElement("canvas"),h=g.getContext("2d"),i=document.createElement("canvas"),j=i.getContext("2d");i.width=a.width;i.height=a.height;j.drawImage(a,0,0);g.width=b;g.height=c;h.fillStyle="rgb(255,255,255)";h.fillRect(0,0,g.width,g.height);h.drawImage(i,0,0,i.width,i.height,(g.width-e)/2,(g.height-f)/2,e,f);i=h=j=null;return g.toDataURL("image/jpeg")}}).methods({__construct:function(a,b){var c=this;c.options=$.extend({},patron.Compose.FileUploaderSWF.defaultOptions,b);c.$form=$(a);c.completeUploadCallbacks={};c.startUpload={};var d=c.options.domIDs,e=d.flashUploader.substr(1);c.$flashUploaderContainer=$(d.flashUploaderContainer,c.$form);c.flashConfig={flashId:e,width:125,height:22,allowVersion:c.options.allowVersion,vars:{hidebutton:1,localChain:"ru_RU",FlashLog:"FlashLog"+e,MRUUploader:"MRUUploader"+e,GetUploadCookie:"GetUploadCookie"+e,OnChangeFlashScreen:"OnChangeFlashScreen"+e,setHeightToFileUploader:"setHeightToFileUploader"+e,_AjaxViaAdobeFlashIsReady:"_AjaxViaAdobeFlashIsReady"+e},params:{allowScriptAccess:"always",wmode:"transparent",menu:false,loop:false}};c.bind("flashLoad",$.proxy(function(a,b){var c=this;c.$flashObj=$(b);c.SWFJSApi=new patron.Compose.FileUploaderSWF.SWFJSApi(e);c.JSSWFApi=new patron.Compose.FileUploaderSWF.JSSWFApi(b);c.SWFJSApi.bind({_AjaxViaAdobeFlashIsReady:$.proxy(function(){var a=this;a.JSSWFApi.SetUploadConfig(JSON.stringify(a.config.UploadConfig),JSON.stringify(a.config.GlobalConfig));if(patron.EnableFlashLog){a.JSSWFApi.toggleFlashLog(true)}a.JSSWFApi.setLocalization(patron.fileUploaderSWFStrings);a.triggerHandler("_AjaxViaAdobeFlashIsReady",Array.prototype.slice.call(arguments,1))},c),OnChangeFlashScreen:$.proxy(function(a,b){var c=this;c.$flashObj.css("width",b?"100%":c.flashConfig.width);c.triggerHandler("OnChangeFlashScreen",Array.prototype.slice.call(arguments,1))},c),setHeightToFileUploader:$.proxy(function(a,b){var c=this;c.$flashObj.attr("height",b);$(window).resize();c.triggerHandler("setHeightToFileUploader",Array.prototype.slice.call(arguments,1))},c)});c.SWFJSApi.MRUUploader.bind("onQueueStart onQueueFinsh onQueueChanged onFilesLinkCodeChange",$.proxy(function(a){var b=this;b.triggerHandler(a.type,Array.prototype.slice.call(arguments,1))},c));patron.Compose.JSSWFApi=c.JSSWFApi},c))},_flashLoad:function(a){var b=this;setTimeout($.proxy(function(a){return function(){var b=this;if(a&&a.ref&&a.ref.style&&a.ref.style.display!="none"){b.triggerHandler("flashLoad",[a.ref])}else{b.triggerHandler("errorFlashLoad")}}}(a),b),100)},_progressUpload:function(){},_addFile:function(a,b){var c=this;var d=function(a,b,c){return function(){a.JSSWFApi.completeUpload(b,c.Id,c.FileName,c.Size)}}(c,a,b);if(c.startUpload[a]){d();delete c.startUpload[a]}else{c.completeUploadCallbacks[a]=d}},getUploadedAttachments:function(){var a=this;return a.JSSWFApi.getUploadedAttachments()},getFiles:function(){var a=this;var b=a.JSSWFApi.GetServerQueueItems("files","done");var c=a.JSSWFApi.GetServerQueueItems("mail","done");return b.concat(c)},init:function(a,b){var c=this;c.settings=a;c.config=b;if(window.IS_LOCAL){c.flashConfig["src"]="http://v.demidov.boom.corp.mail.ru/attachmentsuploader/uploader.swf?b="+Math.random()}else{c.flashConfig["src"]=patron.CssStaticUrl+"/r/photouploader/uploader_228.swf?b=1"}swfobject.embedSWF(c.flashConfig.src,c.flashConfig.flashId,c.flashConfig.width,c.flashConfig.height,c.flashConfig.allowVersion,null,c.flashConfig.vars,c.flashConfig.params,c.flashConfig.attrs,$.proxy(c._flashLoad,c));setTimeout(swfobject.callDomLoadFunctions,0)},unactive:function(){},reset:function(){var a=this;a.$flashUploaderContainer.html('<div id="'+a.flashConfig.flashId+'">')},attachUpload:function(a,b,c){var d=this;if(b.Error){d.triggerHandler("fileLoadError",[b])}else{d._addFile(a,b,c)}}})})(a);(function($){jsClass.create("patron.Compose.FileUploaderSWF.SWFJSApi").extend(jQueryEvent).methods({__construct:function(a){var b=this,c=window;b.MRUUploader=new patron.Compose.FileUploaderSWF.SWFJSMRUUploaderApi;c["MRUUploader"+a]=b.MRUUploader;c["GetUploadCookie"+a]=$.proxy(b.GetUploadCookie,b);c["OnChangeFlashScreen"+a]=$.proxy(b.OnChangeFlashScreen,b);c["setHeightToFileUploader"+a]=$.proxy(b.setHeightToFileUploader,b);c["_AjaxViaAdobeFlashIsReady"+a]=$.proxy(b._AjaxViaAdobeFlashIsReady,b);c["FlashLog"+a]=$.proxy(b.FlashLog,b)},_AjaxViaAdobeFlashIsReady:function(){var a=this;a.triggerHandler("_AjaxViaAdobeFlashIsReady",arguments);return false},OnChangeFlashScreen:function(){var a=this;a.triggerHandler("OnChangeFlashScreen",arguments)},setHeightToFileUploader:function(){var a=this;a.triggerHandler("setHeightToFileUploader",arguments)},GetUploadCookie:function(){var a=this;a.triggerHandler("GetUploadCookie",arguments);return"Mpop="+b.get("Mpop")+"; mrcu="+b.get("mrcu")+";"},FlashLog:function(a){patron.Compose.log(a)}})})(a);(function($){jsClass.create("patron.Compose.FileUploaderSWF.SWFJSMRUUploaderApi").extend(jQueryEvent).methods({onQueueStart:function(){var a=this;a.triggerHandler("onQueueStart",arguments)},onQueueChanged:function(){var a=this;a.triggerHandler("onQueueChanged",arguments)},onQueueFinsh:function(){var a=this;a.triggerHandler("onQueueFinsh",arguments)},onFilesLinkCodeChange:function(){var a=this;a.triggerHandler("onFilesLinkCodeChange",arguments)}})})(a);(function($){jsClass.create("patron.Compose.FileUploaderSWF.JSSWFApi").extend(jQueryEvent).methods({__construct:function(a){var b=this;b.flashObj=a},SetFilesOnlyUpload:function(a){var b=this;var c=b.flashObj.SetFilesOnlyUpload(a+0);b.triggerHandler("SetFilesOnlyUpload",arguments);return c},SetUploadConfig:function(a,b){var c=this;var d=c.flashObj.SetUploadConfig(a,b);c.triggerHandler("SetUploadConfig",arguments);return d},SetGroupCode:function(a,b){var c=this;var d=c.flashObj.SetGroupCode(a,b);c.triggerHandler("SetGroupCode",arguments);return d},GetServerQueueItems:function(a,b){var c=this,d=[];try{d=$.parseJSON(c.flashObj.GetServerQueueItems(a,b))}catch(a){}c.triggerHandler("GetServerQueueItems",arguments);return d},DeleteUploadItem:function(a){var b=this;var c=b.flashObj.DeleteUploadItem(a);b.triggerHandler("DeleteUploadItem",arguments);return c},GetServerStat:function(a){var b=this;var c=b.flashObj.GetServerStat(a);b.triggerHandler("GetServerStat",arguments);return c},startUpload:function(a,b,c,d){b=$("<div/>").html(b).text();var e=this;var f=e.flashObj.startUpload(a,b,c,d);e.triggerHandler("startUpload",arguments);return f},completeUpload:function(a,b,c,d){c=$("<div/>").html(c).text();var e=this;var f=e.flashObj.completeUpload(a,b,c,d);e.triggerHandler("completeUpload",arguments);return f},getUploadedAttachments:function(){var a=this,b=[];try{b=$.parseJSON(a.flashObj.getUploadedAttachments())}catch(a){}a.triggerHandler("getUploadedAttachments",arguments);return b},toggleFlashLog:function(a){var b=this;var c=b.flashObj.toggleFlashLog(a>>>0);return c},setLocalization:function(a){var b=this;var c=b.flashObj.setLocalization(a);return c}})})(a)});define("patron.compose2/patron.Compose.FileUploaderView.patch",[],function(){function a(a){var b=a.name.split(/\.([^\.]*$)/).slice(0,2);return{id:a.uid,filename:{name:b[0],extension:b[1]},size:a.size,isLink:a.isFiles,isUploaded:a.loaded||a.uploading}}return{_getUi:function(){if(this._ui){return this._ui}var a=patron.Compose.Form&&patron.Compose.Form.getActive();if(!a){return null}this._ui=a.composeUI;this._ui.on("remove",function(a,b){this.trigger("remove",[b]);$.event.trigger("ui-abstract-action",{chain:["compose","attaches","attach","remove"]})}.bind(this));this._ui.on("rotate",function(a,b,c){var d=this.getModel().getByUid(b);d.rotate(c);this.trigger("rotate",[b]);$.event.trigger("ui-abstract-action",{chain:["compose","attaches","attach","rotate"]})}.bind(this));this._ui.on("open",function(a,b){this.trigger("show",[b]);$.event.trigger("ui-abstract-action",{chain:["compose","attaches","attach","click"]})}.bind(this));return this._ui},_drawItem:function(b){var c=this.getModel(),d=b.uid;if(c._reattachData){c._doAction(function(){var c=this._getUi();if(c){c.addAttachment(d,a(b))}}.bind(this,b))}else{var e=this._getUi();if(e){e.addAttachment(d,a(b))}}},_eraseItem:function(a){var b=this.getModel(),c=a.uid;b._doAction(function(){var a=this._getUi();if(a){a.removeAttachment(c)}}.bind(this,a));return true},_updateItem:function(a,b,c){var d=this.getModel(),e=a.uid;d._doAction(function(){var a=this._getUi();if(!a){return}switch(b){case"progress":a.updateAttachment(e,{progress:c.loaded/c.total});break;case"uploading":a.updateAttachment(e,{uploading:c});break;case"removing":a.updateAttachment(e,{removing:c});break;case"uploadend":a.updateAttachment(e,{uploaded:true,progress:0});break;case"preview":a.updateAttachment(e,{preview:c.$image[0]});break}}.bind(this,a,b,c))},_redraw:function(){}}});define("jQuery/jquery.multiple",["ajs/pkg","patron.v2/utils/contentTypes"],function(a,b){var c=window,$=jQuery,d,e=c.document,f=c.FileReader,g=c.FormData,h=null,i=$.support.fileapi=patron.HTML5Uploader==2&&!!(c.File&&f)&&"withCredentials"in new XMLHttpRequest,j=!$.browser.ios,k=+new Date,l="_"+k,m=/%s/g,n=/\.(\w+)$/i,o=/.+\/.+/i,p=/png|jpe?g/i,q=[].slice,r=$.proxy;if($.browser.ios){if(window.navigator.userAgent.match(/OS\s8_0\s/)){var s=Lang.get("ios8-fileapi-bug-message").replace(/\{n\}/g,"\n");e.body.addEventListener("touchstart",function(a){if(a&&a.target&&(a.target.tagName=="INPUT"&&a.target.type=="file")){a.preventDefault();alert(s)}})}}c[l]={};function t(a,b,d){c[l]["_"+a]=d?r(b,d):b;return"window."+l+"._"+a}function u(a){delete c[l]["_"+a]}if($.event.props)$.each(["loaded","total"],function(a,b){if(!~$.inArray(b,$.event.props)){$.event.props.push(b)}});function v(a,b,c,d){if(b)c.namespace=b;if(d)d.call(a,c);$(a).triggerHandler(c.type+(b?"."+b:""),[c])}function w(a,c){this.uid=a.uid||++k;this._file=a;this._input=c;this._rotate=0;this.__rotate=0;this._minSide;this._maxSide;this.name=String(a.fileName||a.name);this.type=String(a.fileType||a.type);this.size=+(a.fileSize||a.size)||0;this.isFlash=!!a.isFlash;if(this.name){var d=this.extension=this.name.match(n)&&RegExp.$1;if(!o.test(this.type)){var e=b.getMimeTypes(d);this.type=e&&e[0]||d}}}w.fn=w.prototype={uid:0,getId:function(){return this.uid},getBoundary:function(){return this.uid},loadAsDataURL:function(a){v(this,"dataURL",{type:"error"},a)},loadAsBinaryString:function(a){v(this,"binaryString",{type:"error"},a)},abort:$.noop,isImage:function(){return b.is("image",this.type)},hasSupportTransform:function(){return p.test(this.type)},isNeedTransform:function(){if(this.hasSupportTransform()){return this._rotate!==this.__rotate||this.isNeedResize()}return false},isNeedResize:function(){return this._minSide&&(!this.width||this._maxSide<this.width)||this._minSide&&(!this.height||this._maxSide<this.height)},resize:function(a,b){this._minSide=a||0;this._maxSide=b||a},rotate:function(a){this._rotate=a},on:function(a,b){if(!b._proxy)b._proxy=r(function(a,c){c.namespace=a.namespace;b.call(this,c)},this);$(this).bind(a,b._proxy)},off:function(a,b){if(b._proxy)$(this).unbind(a,b._proxy)},emit:function(a,b){v(this,"",$.extend({type:a},b));return this},isLink:function(){return!(this._input&&this._input.nodeType)},loadAsImage:function(a){var b=function(b){var c=b.type;if(c=="load"){try{$(new Image)[b.cors?"attr":"removeAttr"]("crossOrigin","use-credentials").bind("error abort load",function(b){$(this).unbind();a({type:b.type,target:this})}).attr("src",this.dataURL)}catch(b){a({type:"error",error:b})}}else if(c=="abort"||c=="error"){a({type:c})}};if($.browser.msie&&parseInt($.browser.version)<8){b({type:"error"})}else if($.support.fileapi&&this.isLink()||this.fromFilesearch){if(!/^data:/.test(this.url)){this.url=/&/.test(this.url)?this.url+"&cors=1":this.url+"?cors=1"}b.call({dataURL:this.url},{type:"load"})}else{this.loadAsDataURL(b)}}};function x(){this.ready=false;this.active=false;this._flash="flashapi_"+l;if(this.hasFlash()){this._init(0)}else{setTimeout(this._fail.bind(this),1)}}x.prototype={hasFlash:function(){var a=navigator,b=a.mimeTypes,d=false;if(a.plugins&&typeof a.plugins["Shockwave Flash"]=="object"){d=a.plugins["Shockwave Flash"].description&&!(b&&b["application/x-shockwave-flash"]&&!b["application/x-shockwave-flash"].enabledPlugin)}else{try{d=!!(c.ActiveXObject&&new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(a){}}return d},_init:function(b){var d=e.getElementById("__FFA__");if(!d){if(++b<50){setTimeout(this._init.bind(this,b),500)}else{this._fail()}return}var f="//e.mail.ru/r/photouploader/UploaderFileAPI_702.swf?r=1";var g=location.protocol,h={id:this._flash,src:f,flashvars:a.toQuery({ping:g+"//"+location.host,storeKey:navigator.userAgent.match(/\d/g).join(""),clearError:+/flash_clear_error/.test(location.toString()),callback:t("__flash",this._event,this)})};var i=('<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="" id="#id#" width="100%" height="100%">'+'<param name="movie" value="#src#" />'+'<param name="flashvars" value="#flashvars#" />'+'<param name="swliveconnect" value="true" />'+'<param name="allowscriptaccess" value="always" />'+'<param name="wmode" value="transparent" />'+'<param name="menu" value="false" />'+'<embed flashvars="#flashvars#" swliveconnect="true" allowscriptaccess="always" name="#id#" src="#src#"  width="100%" height="100%" menu="false" wmode="transparent" type="application/x-shockwave-flash"></embed>'+"</object>").replace(/#(\w+)#/gi,function(a,b){return h[b]});this.$H=$(d).css({position:"absolute",zIndex:81100,overflow:"hidden"});$(c).scroll(r(this._scroll,this));a.log("FileAPI.SWF.publish");this.$H[0].innerHTML=i;this._engine=e[this._flash]||window[this._flash]||e.embeds[this._flash];this._event({type:"mouseleave"});setTimeout(function(){$.multiple.ready(true)},1e4)},_fail:function(){if(!this.ready){this._event=this._ready=a.F;$("body").addClass("fileapi-not-support");$.multiple.ready(true)}},_ready:function(){this._ready=a.F;var b={loadAsDataURL:function(b){a.log("loadAsDataURLById:",this.getId(),this.url);h._cmd(!this._input.nodeType?"load":"loadAsDataURL",{id:this.getId(),url:this.url,callback:t(++k,function(a){if(a.type=="load"){if(a.target.type)this.type=a.target.type;this.dataURL="data:"+this.type+";base64,"+a.target.result}v(this,"dataURL",a,b)},this)})},upload:function(b,c,d){a.log("uploadById:",this.getId());this.__failId=setTimeout(function(){patron.radar("flash_timeout",1);v(this,"upload",{type:"error",error:"timeout"});v(this,"upload",{type:"uploadend"});this.abort()}.bind(this),60*1e3);this.__rotate=this._rotate;this.uploading=true;this.on("abort.upload",d);this.on("uploadend.upload",function(){if(this.aborted){d.call(this,arguments[0])}}.bind(this));h._cmd("upload",$.extend({id:this.getId(),url:b,name:this._input.name,data:c.data||{},headers:c.headers||{},callback:t(++k,function(b){if(b.type=="progress"){if(this.__failId!==0){clearTimeout(this.__failId);this.__failId=0}}else{a.log(b.type," ",JSON.stringify(b))}v(this,"upload",b,d)},this)},c))},abort:function(){h._cmd("abort",{id:this.getId()});if(!this.__failId){this.aborted=true;v(this,"upload",{type:"abort"});v(this,"upload",{type:"uploadend"})}},rotate:function(a){this._rotate=a;h._cmd("rotate",{id:this.getId(),deg:a})}};$.each(b,function(a,b){var c=w.fn[a];w.fn[a]=function(){return(this.isFlash?b:c).apply(this,arguments)}});this.ready=$.support.flash=$.support.flashUpload=true;$.multiple.ready(true)},_scroll:function(){if(!this.active){this.$H.css({top:$(c).scrollTop(),left:$(c).scrollLeft(),width:2,height:2})}},_cancel:function(a){this.$Active=null;this.active=false;if(a){this._scroll()}else{$("body").one("mousemove",r(this._scroll,this))}},_event:function(b){var c=b.type;if(c!=="log"){a.log("[flash] --\x3e",c,": ",JSON.stringify(b))}if(c=="ready"){this._ready.gap(this,20)();return true}else if(c=="ping"){patron.log("flash_ping",b,1);if(b.status=="ok"&&b.savedStatus=="error"){patron.radar("flash_ping","ok_error=1")}else if(b.status=="error"&&b.savedStatus=="ok"){patron.radar("flash_ping","error_ok=1")}else if(b.status=="error"&&b.savedStatus=="error"){patron.radar("flash_ping","err_error=1")}else{patron.radar("flash_ping",b.status+"=1")}}else if(c=="log"){a.log("[flash.log] --\x3e",b.target)}else if(c=="mouseleave"){if(this.$Active)this.$Active.triggerHandler("mouseleave");this._cancel(true)}else if(c=="select"){$.each(b.target.files,function(a,b){b.name=unescape(b.name);b.isFlash=true});this.$Active.data(l,b.target.files).triggerHandler("change");this._cancel()}else if(c=="mouseDown"||c=="mouseUp"){this.$Active.triggerHandler(c)}},_cmd:function(a,b){if(this.ready)try{this._engine.cmd(a,b)}catch(a){}},mouseOver:function(a,b){if(this.ready){var c=$(a.currentTarget),d=c.offset();d.top-=1;d.left-=1;this.$H.css(d).css({width:c.outerWidth()+2,height:c.outerHeight()+2});this.active=true;this.$Active=b}},mouseOut:function(){if(this.ready){this._cancel(true)}},setAccept:function(a){h._cmd("accept",{"All files":a||"*"})},setResize:function(a){$.each(a,function(a,b){h._cmd("setResize",{type:a,enabled:b.enabled!=false,strategy:b.type=="min"?"byMinSide":"byMaxSide",resizeSize:b.min,bigImageSize:b.max||2e3})})},clear:function(){h._cmd("clear")}};$.support.canvas=!!function(){var a=e.createElement("canvas"),b=a.getContext&&~a.toDataURL("image/png").indexOf("data:image/png");a=null;return b}();if(i){function y(a,b){var c=e.createElement("canvas");if(b){c.width=a;c.height=b}else{var d=a;c.width=d.width;c.height=d.height;c.getContext("2d").drawImage(d,0,0,d.width,d.height)}return c}function z(a,b){var c=y(b==0||b==180?a.width:a.height,b==0||b==180?a.height:a.width),d=c.getContext("2d"),e=0,f=0;if(b==180||b==270)e=-a.width;if(b==90||b==180)f=-a.height;d.rotate(b*Math.PI/180);d.drawImage(a,e,f);d=null;return c}function A(a,b){var c=a.width>b?b/a.width:b/a.height,d=y(a.width*c,a.height*c);d.getContext("2d").drawImage(a,0,0,d.width,d.height);return d}function B(a,b,c){var d=c+"_lock",e=c+"_status",g="loadstart.%s error.%s abort.%s load.%s loadend.%s".replace(m,c);if(a[c]){a[e]="load";a[d]=true}if(!a[d]){a[d]=true;a.on(g,b);a.on("loadend."+c,function(){this[e]=c in this?"load":"error"});var h=new f;h.onabort=h.onerror=h.onprogress=h.onload=h.onloadstart=h.onloadend=function(b){if(b.type=="load")a[c]=b.target.result;v(a,c,b)};h["readAs"+c.charAt(0).toUpperCase()+c.substr(1)](a._file);h=null}else{b({type:"loadstart",namespace:c,target:{}});if(a[e]){b({type:a[e],namespace:c,target:{}});b({type:"loadend",namespace:c,target:{}})}else{a.on(g,b)}}}w.fn.loadAsDataURL=function(a){if(this._input.nodeType){B(this,a,"dataURL")}else{E(this,this.url,a)}};w.fn.loadAsBinaryString=function(a){B(this,a,"binaryString")};function C(a,b,c){if(a){var d=new g;d.append(b._input.name,b._file);$.each(c,function(a,b){d.append(a,b)});return d}else{var e=b.getBoundary();var f=b.binaryString;var h="--"+e+"\r\n";if(c)$.each(c,function(a,b){h+='Content-Disposition: form-data; name="'+encodeURIComponent(a)+'"\r\n'+"\r\n"+encodeURIComponent(b)+"\r\n"+"--"+e+"\r\n"});h+='Content-Disposition: form-data; name="'+b._input.name+'"; filename="'+encodeURIComponent(b.name)+'"\r\n'+"Content-Type: "+(b.type||"application/octet-stream")+"\r\n"+"\r\n"+f+"\r\n"+"--"+e+"--";return h}}w.fn.abort=function(){this.aborted=true;if(this._xhr)this._xhr.abort()};w.fn.upload=function(a,b,d){if($.isFunction(b)){d=b;b={}}this.uploading=true;v(this,"upload",{type:"uploadstart"},d);var e=this,f=function(c){if(e._input.nodeType==1){var f=$(e._input),g=f.clone(true).val(""),h=$("<form/>");h.append(g).trigger("reset");g.insertBefore(f).trigger("reinit-inp."+l);f.remove();h.remove()}e._xhr=$.ajax({url:a,type:"POST",crossDomain:true,processData:false,data:C(c,e,b.data),dataType:"text",xhrFields:{withCredentials:true},headers:b.headers||{},contentType:c?false:"multipart/form-data; boundary="+e.getBoundary(),xhr:function(){var a=$.ajaxSettings.xhr();if(!c){a.send=a.sendAsBinary||function(a){return function(b){var c=Array.prototype.map.call(b,function(a){return a.charCodeAt(0)&255});a.call(this,new Uint8Array(c).buffer)}}(a.send)}if(a.upload)a.upload.addEventListener("progress",function(a){if(a.lengthComputable){v(e,"upload",a,d)}},false);return a},success:function(a){v(e,"upload",{type:"progress",total:e.size,loaded:e.size},d);v(e,"upload",{type:"upload",target:{result:a}},d)},complete:function(a,b){e.uploading=false;if(b!="success"){v(e,"upload",{type:b!="abort"?"error":"abort",ajaxStatus:b},d);patron.log("html5.multiple.upload.error",{status:a.status,textStatus:b},true)}v(e,"upload",{type:"uploadend"},d)}})};if(g&&!e.isNeedTransform()){f(true)}else{e[e.isNeedTransform()?"loadAsDataURL":"loadAsBinaryString"](function(a){var b=a.type;if(e.aborted){return}else if(b=="abort"||b=="error"){v(e,"upload",a,d);v(e,"upload",{type:"uploadend"},d)}else if(b=="load"){if(e.isNeedTransform()){$(new Image).attr("src",e.dataURL).bind("load error",function(a){$(this).unbind();if(a.type=="error"){v(e,"upload",{type:"error"},d);v(e,"upload",{type:"uploadend"},d)}else{var b=y(a.target);e.width=b.width;e.height=b.height;if(e.isNeedTransform()){if(e.isNeedResize())b=A(b,e._minSide);if(e._rotate)b=z(b,e._rotate);e.__rotate=e._rotate}var g=~e.type.indexOf("png")?"image/png":"image/jpeg";e.binaryString=c.atob(b.toDataURL(g).substr(13+g.length));f()}})}else{f()}}})}}}if(!i){h=new x;w.fn.upload=function(a,b,c){if($.isFunction(b)){c=b;b={}}if(!c)c=$.noop;v(this,"upload",{type:"uploadstart"},c);var d=this.getId(),e=t(d,function(a){v(this,"upload",{type:"progress",loaded:1,total:1},c);v(this,"upload",{type:"upload",target:{result:a}},c);v(this,"upload",{type:"uploadend"},c);i();u(d)},this),f=$(this._input),g=$(f[0].form),h=$("<div></div>").css({position:"absolute",top:-1e3,width:1,height:1,overflow:"hidden",visibility:"hidden"}).insertAfter(g);h[0].innerHTML='<form target="'+d+'" action="'+a+'" method="POST" enctype="multipart/form-data">'+'<iframe name="'+d+'" src="about:blank"></iframe>'+'<input value="'+e.replace("window.","")+'" name="callback" type="hidden" />'+"</form>";$.each(b.data,function(a,b){h.find("form").append('<input value="'+b+'" name="'+a+'" type="hidden" />')});this.uploading=true;f.clone(true).val("").insertBefore(f).trigger("reinit-inp."+l);h.find("form").append(f)[0].submit();this.abort=function(){this.aborted=true;v(this,"upload",{type:"abort"},c);v(this,"upload",{type:"uploadend"},c);try{var a=h[0].contentWindow;if(a){if(a.stop)a.stop();else if(a.document)a.document.execCommand("Stop")}}catch(a){}i()};function i(){h.remove();h=null}}}function D(a,b){this.$Elm=a=$(a).bind("mouseenter mousedown",r(this,"_event"));this.$Inp=($.nodeName(a[0],"input")?a:a.find("input:file")).val("").prop("multiple",i&&j).bind("change reinit-inp."+l,r(this,"_event"));this.opts=b=$.extend({url:0,max:0,resize:{upload:{enabled:false},preview:{enabled:false}},types:{"All files":"*.*"},accept:0,onselect:$.noop},b);if(b.accept){this.$Inp.attr("accept",b.accept)}}D.prototype={_event:function(b){var c=this.opts,d=b.type;a.log("js -> ",b.type,b.pageX,b.pageY);if(d=="change"){var e=this.files();if(c.max){e=q.call(e,0,c.max)}if(e.length){c.onselect.call(this,e)}}else if(d=="reinit-inp"){var f=$(b.currentTarget);if($.nodeName(this.$Elm[0],"input"))this.$Elm=f;this.$Inp=f}else if(h!==null&&(d=="mouseenter"||d=="mousedown")){h.setResize(this.opts.resize);h.setAccept(this.getAccept());h.mouseOver(b,this.$Inp)}},newFile:function(a,b){h&&h.setResize(this.opts.resize);a=new w(a,b);return a},clear:function(){h&&h.clear()},mouseout:function(){h&&h.mouseOut()},resize:function(a){$.extend(this.opts.resize,a);h&&h.setResize(this.opts.resize)},getAccept:function(){if(this.opts.accept){var a=[],c=this.opts.accept,d;$.each(typeof c=="string"?c.split(/,\s*/g):c,function(c,e){if(!(d=b.getExtensions(e))){if(d=b.getExtensionsByType(e)){d=d.join("|")}}if(d){a=a.concat(d)}});return a.join(",")}},files:function(a){var b=this.$Inp,c=a||b.data(l)||b[0].files,d=this.getAccept(),e=this.opts;if(!(c&&c.length)&&$.trim(b.val())){c=[{name:b.val().split("/").shift()}]}c=$(c).map(function(){var a=new w(this,b[0]);if(e.resize&&e.resize.upload&&e.resize.upload.enabled){a.resize(e.resize.upload.min,e.resize.upload.max)}return a});if(d){d=new RegExp("("+d+")","i");c=c.filter(function(a,b){return d.test(b.type)})}return c.toArray()},select:function(a){this.opts.onselect.call(this,this.files(a))}};$.fn.multiple=function(a){var b,c=arguments;this.each(function(){var d=$(this);if(b=d.data("multiple.inst")){if($.isFunction(b[a])){b=b[a].apply(b,$.makeArray(c).slice(1))}}else{d.data("multiple.inst",new D(d,a))}});return b===d?this:b};$.multiple={_fn:[],isImage:function(a){return a.isImage?a.isImage():b.is("image",a.name.match(n)&&RegExp.$1)},file:function(a,b){return new w(a,b)},ready:function(a){if(a===true){this.ready=function(a){$.isFunction(a)&&a()};while(this._fn.length)this._fn.shift()()}else{this._fn.push(a)}}};if(i){$.multiple.ready(true)}$.multiple.File=w;function E(a,b,c){var d=$.ajaxSettings.xhr();if(d){d.open("GET",b,true);if(d.overrideMimeType){d.overrideMimeType("text/plain; charset=x-user-defined")}d.onreadystatechange=function(){if(d.readyState==4){d.onreadystatechange=null;if(d.status==200){b=b.split("/");$.extend(a,{name:b[b.length-1],size:d.getResponseHeader("Content-Length"),type:d.getResponseHeader("Content-Type")});a.dataURL="data:"+a.type+";base64,"+F(d.responseBody||d.responseText);c({type:"load",result:a})}else{c({type:"error"})}}};d.send(null)}else{c({type:"error"})}return d}function F(a){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c="",d=0;while(d<a.length){var e=a.charCodeAt(d++)&255,f=a.charCodeAt(d++)&255,g=a.charCodeAt(d++)&255,h=e>>2,i=(e&3)<<4|f>>4,j,k;if(isNaN(f)){j=k=64}else{j=(f&15)<<2|g>>6;k=isNaN(g)?64:g&63}c+=b.charAt(h)+b.charAt(i)+b.charAt(j)+b.charAt(k)}return c}});define("patron.compose/patron.Compose.FileUploaderHTML5",["jquery","ajs/pkg","features","RPC","patron.compose2/patron.Compose.FileUploaderView.patch","mrg-js-cookie","utils/jsHistory","jQuery/jquery.tpl","jQuery/extensions","jQuery/jquery.multiple","jQuery/jquery.xdr-transport","plugins/jQueryEvent","patron/patron.Ajax","toolkit-common/store/store"],function($,a,b,c,d,e){var f=location.protocol+"//"+location.host;function g(a){return{data:a.data,uid:a.uid,previewSrc:a.previewSrc,downloadlink:a.downloadlink,hasPreview:a.hasPreview,onlyPartId:a.onlyPartId,fromCloud:a.fromCloud,fromFilesearch:a.fromFilesearch,PartId:a.partId,isFiles:a.isFiles,isFlash:a.isFlash,loaded:a.loaded,size:a.size,type:a.type,uploading:a.uploading,name:a.name}}function h(){return"Mpop="+e.get("Mpop")+"; mrcu="+e.get("mrcu")+";"}function i(a,b){return a.size-b.size}function j(a,b){return a.name==b.name?0:a.name&&a.name.localeCompare?a.name.localeCompare(b.name):a.name>b.name?1:-1}function k(a,b){var c=q.test(a.extension),d=q.test(b.extension);return c==d?0:c?1:-1}function l(){return(location.protocol==="https:"?"ssl.":"")+patron.FilesHost}function m(a){return("#"+a).replace(/(:|;|\.)/g,"\\$1")}function n(a){return a.AttachId?0:a.size}function o(a){var c=patron.Compose.Form&&patron.Compose.Form.getActive();if(!c){return}["cloud","forward"].forEach(function(d){if(!b.has("send-use-"+d+"-add")){Object.forEach(c.Attaches[d].files,function(b){a-=n(b)})}});return Math.max(a,0)}var p=/\.(\w+)$/i,q=/gif|jpg|jpeg|bmp|png/i,r=/(image|video|audio)\//i,s={0:0,90:1,180:2,270:3};a.createClass("patron.Compose.FileUploaderHTML5",[jQueryEvent],{__construct:function(a,b){this.useUniqFilesId=patron.UploadFilesMultiGroup;this._filesHost=l();this.opts=b;this.$Form=$(a);var c=this.adaptive();patron.radar("picadapt",(c?"on":"off")+"=1");this.$Inp=$(".js-input-file",a).multiple({resize:{preview:{min:100,type:"min"},upload:{min:800,max:1280,type:"min",enabled:c}},onselect:this._onSelect.bind(this,"attach")});this.List=new patron.Compose.FileUploaderView($(".js-attachments",a),this);this._uploading=false;this.List.bind("remove rotate",this._fileEvent.bind(this));this.List.bind("show",this._show.bind(this));this.reset();this.restore();if($.browser.ios&&!$.support.fileapi){this.$Inp.bind("touchstart",function(){var a=this.$Form.find(".js-ios-fileapi-not-support");if(a[0]){a.show();this.$Inp.parent().hide();return false}}.bind(this))}$(window).bind("changeFieldVisible.compose",function(){try{var a=patron.Compose.Form.getActive(),b=a.$form.find(".js-file").length;if(b!=a.getFileUploader().getUploadedAttachments()){patron.radar("uploader","viewFail="+b)}}catch(a){}}.gap(2e3))},_show:function(a,b){var c;Array.some(this._files,function(a){if(a.uid==b){c=a}return c});if(c){this.triggerHandler("onFileShow",[c])}},_fileEvent:function(b,c){this._doAction(function(b,c){var d=b.type,e=this.getByUid(c);this.List.hold(c,true);if(d=="remove"||d=="rotate"&&e.isNeedTransform()){patron.log("html5._fileEvent."+d,{type:d,file:g(e)},1);this._removeFile(e,function(b){this.List.hold(c,false);if(b[1]=="OK"){this._count--;if(!e.aborted){if(!e.isFiles){if(a.isset(b[5])){this._spaceLeft=o(b[5]);a.log("html5._spaceLeft 1: "+this._spaceLeft)}else if(e.onlyPartId&&!e.AttachId){this._spaceLeft+=n(e);a.log("html5._spaceLeft 2: "+this._spaceLeft)}}this._loaded--}this.trigger("onQueueChanged",[this._loaded]);if(d=="rotate"){this._uploadFile(e)}else{this._removeItem(e);patron.radar("uploader","removeOk=1")}}else{this._error("remove",e)}}.bind(this))}else{patron.log("html5._fileEvent."+d+".warn",null,1)}}.bind(this,b,c))},_removeItem:function(b){this.List.remove(b);this._queue=a.remove(this._queue,b,true);this._files=a.remove(this._files,b,true);this._uploading=this._uploading&&!!this._queue.length;$(this.List).trigger("removeByUid",[b.uid]);if(!a.filter(this._files,function(a){return a.isFiles}).length){this.opts.files_id="";this.triggerHandler("onFilesLinkCodeChange","")}this._uploadNext()},_removeFile:function(a,b){patron.log("html5._removeFile",g(a),1);patron.radar("uploader","remove=1");if(a){var d=a.AttachId?a.AttachId:a.data?a.data.Id:null,e=this.opts.MessageId;if(a.onlyPartId&&(!a.AttachId||a.isFiles&&a.fromCloud)){b(["","OK"],a);this.triggerHandler("removeFromQueue",a)}else if(!a.data){a.abort();b(["","OK"],a);patron.log("html5._removeFile.abort",g(a),1)}else{this.List._updateItem(a,"removing",true);if(patron.UseSendAPIV1&&!a.isFiles){patron.API({type:"POST",url:"messages/attaches/remove",data:{message_id:e,ids:[d]},complete:function(c){this.List._updateItem(a,"removing",false);if(c.isOK()){var d=c.getData();var e=["","OK","DELETED",1,d.ids[0],d.space_left];a.data=null;b(e,a);patron.log("html5._removeFile.success",{file:g(a),result:e},1)}else{b(["","ERROR"],a);patron.log("html5._removeFile.error",g(a),1)}}.bind(this)})}else{if(a.bundle_id){c.call("cloud/attachment/remove",{bundle_id:a.bundle_id,file_id:d.split(":")[1]}).then(function(c){var d=["","OK","DELETED",1,c.data.file_id,0];a.data=null;b(d,a);patron.log("html5._removeFile.success",{file:a,result:d},1)},function(c){this.List._updateItem(a,"removing",false);b(["","ERROR"],a);patron.log("html5._removeFile.error",a,1)}.bind(this))}else{var h=f+"/cgi-bin/attach_upload2?"+$.param({"x-email":patron.useremail,ajax_call:1,func_name:"cbHardDeleteFile",data:JSON.stringify([d,"message="+e])});if(a.isFiles){h="//"+this._filesHost+"/cgi-bin/files/fajaxcall?"+$.param({"x-email":patron.useremail,ajax_call:1,func_name:"cbHardDeleteFileMail",data:JSON.stringify([d.replace(/^.+:/,""),d])})}$.ajax({url:h,type:"POST",xhrFields:{withCredentials:true},dataType:"json",success:function(c){this.List._updateItem(a,"removing",false);if(a.isFiles&&(c[1]=="OK"&&c[2]==1))c[2]=c.slice(2);else if(!(c[1]=="OK"&&c[2]=="DELETED"))c[1]="ERROR";if(c[1]=="OK")a.data=null;b(c,a);patron.log("html5._removeFile.success",{file:g(a),result:c},1)}.bind(this),error:function(){this.List._updateItem(a,"removing",false);b(["","ERROR"],a);patron.log("html5._removeFile.error",g(a),1)}.bind(this)})}}}}else{}},_onSelect:function(b,c){var d=this.opts.MaxAttachments-this.getFilesCount();if(b==="inline"){this.triggerHandler("onInlineSelect",{files:c});return}patron.radar("uploader",{select:c.length});if(d>0){if(c.length>d){if(d==1){this._notify("upload.overonefile",a.plural(this.opts.MaxAttachments,"files.plural"," "))}else{this._notify("upload.over",a.plural(this.opts.MaxAttachments,"files.plural"," "),a.plural(d,"files.plural"," "))}}c=c.slice(0,d);this._count+=c.length;this._queue=this._queue.concat(c);this._files=this._files.concat(c);patron.log("html5.onSelect",c.length);a.each(c,function(a){var b=a.size,c=b>this._spaceLeftEstimate||b>this.opts.MaxAttachmentSize;a.isFiles=c;this.List.add(a,true);if(!c)this._spaceLeftEstimate-=b},this);$.event.trigger("ui-abstract-action",{chain:["compose","attaches","load"]})}else{patron.radar("uploader","selectErr="+Math.abs(d));this._notify("upload.limit",a.plural(this.opts.MaxAttachments,"files.plural"," "))}this._uploadNext()},_uploadNext:function(){if(!this._uploading&&this._queue.length>0){if(!this._onQueueStart){this._onQueueStart=true;this.trigger("onQueueStart")}this._uploading=true;var a=this._queue.shift();patron.log("html5._uploadNext",a.name,1);if(patron.UploaderImageAdapt&&($.support.flashUpload||$.support.fileapi)&&store.get("upload.adaptive")==null&&a.isImage()&&!patron.IsMyCom){this.List.getLayer(function(b){this.adaptive(b&&b.state==1,true);this._uploadFile(a)}.bind(this))}else{this._uploadFile(a)}}else if(!this.isLoading()){this._onQueueStart=false;this._spaceLeftEstimate=this._spaceLeft;this.trigger("onQueueFinsh")}},_uploadComplete:function(b,c,d,e){if(e){var f="upload",g=false;b.data=e[2]||{};b.uploading=false;if(e[1]==="UPLOADED"&&e[2]&&!e[2].Error){g=true}else if(e[2]){if(e[2].Error==="EX_FILEEMPTY"){f="fileempty"}else if(e[2].Error==="EX_DISABLEDFILETYPE"){f="disabled_file_type"}else if(e[2].Error==="TOO_BIG_FILE"){f="toobig"}else if(e[2].Error==="FILE_EXIST"){f="fileExist"}}if(g){b.loaded=true;if(!b.isFiles){if(a.isset(b.data.SpaceLeft)){this._spaceLeft=o(b.data.SpaceLeft);a.log("html5._spaceLeft 3: "+this._spaceLeft)}else{this._spaceLeft-=n(b);a.log("html5._spaceLeft 4: "+this._spaceLeft)}}this.trigger("onQueueChanged",[++this._loaded]);patron.radar("attached","ok=1")}else{b.error=true;this._error(f,b,e);this._removeItem(b)}}if(d!=="progress"){patron.log("html5._uploadFile."+d,{url:c},1);if(d==="uploadend"){this._uploading=false}this._uploadNext()}},_doUploadFile:function(d,e,f,i,j){this.List._updateItem(d,"uploading",true);var k=i&&!(d.iframe||d.isFlash||e),l=p(j);var m={data:{swf:1,fuid:d.uid,url_charset:"utf-8",FileName:d.name,message:d.MessageId||this.opts.MessageId,groupcode:this.useUniqFilesId?"":this.opts.files_id,upmode:"contextflash",upload:1,sourcehost:"e.mail.ru",hidelinkcode:1},headers:{}};if(d.isFlash&&e){m.headers["Session-ID"]=a.uuid();m.headers["Content-Type"]="application/octet-stream";m.headers["Content-Disposition"]='attachment; filename="'+encodeURIComponent(d.name)+'"'}if(d.iframe){d._input.name="File";a.extend(m.data,patron.tokens.sentmsg)}else if(e){if(b.has("new-cloud-files")){d._input.name="file";m.headers["X-Requested-With"]="XMLHttpRequest"}else{m.headers["X-Cookie"]=h()}}else if(k){d._input.name="file"}if(d.isFlash){m.data.cookies=h()}var n=function(a,b,d){var e=d.split(/\n/)[0];e=String.trim(e).split(";");if(e&&e.length>0&&(e[e.length-1].charAt(0)==="-"||!/^\w/.test(e[0]))){d=["","ERROR"];this._uploadComplete(a,l,b,d)}else{a.hash=e[0];a.size=+e[1];a.name=a.name;if(Number.isNaN(a.size)){d=["","ERROR"];this._uploadComplete(a,l,b,d)}else{c.call("cloud/attachment/add",{name:a.name,size:a.size,hash:a.hash,bundle_id:a.bundle_id}).then(function(c){d=["OK","UPLOADED",{Id:a.bundle_id+":"+c.body.file_id,files:true}];this._uploadComplete(a,l,b,d)}.bind(this),function(c){d=["","ERROR"];var e;try{e=JSON.parse(c.responseText)}catch(a){}if(e&&e.body){if(e.body.error==="file_exists"){d.push({Error:"FILE_EXIST"})}}this._uploadComplete(a,l,b,d)}.bind(this))}}};var o=function(c){var g=c.type,h;switch(g){case"upload":h=c.target.result;if(d.iframe){h=h.slice(1);d.name=h[2].FileName;d.size=~~h[2].Size;this.List.add(d,false,true)}else if(e){if(b.has("new-cloud-files")){n.call(this,d,g,h);return null}else{h=a.toObject(h);if(this.useUniqFilesId){this.triggerHandler("onFilesLinkCodeAdded",h.ulinkcode||h.linkcode)}else{this.opts.files_id=this.opts.files_id||h.ulinkcode||h.linkcode;this.triggerHandler("onFilesLinkCodeChange",this.opts.files_id)}if(!h||!h.vfileid||!(h.ulinkcode||h.linkcode)){patron.radarLog("invalid_files_response",{url:f,response:c.target.result,file:{name:d.name,type:d.type,size:d.size},isFiles:d.isFiles,isFlash:d.isFlash})}h=["OK","UPLOADED",{Id:h.vfileid,files:true}]}}else{try{h=$.parseJSON(h).slice(1)}catch(a){h=["","ERROR"]}}break;case"error":h=["","ERROR"];break;case"uploadend":if(d._xhr&&typeof d._xhr.responseText==="string"&&~d._xhr.responseText.indexOf("TOO_BIG_FILE")){h=["OK","UPLOADED",{Error:"TOO_BIG_FILE"}]}break}this._uploadComplete(d,l,g,h)}.bind(this);function p(a){a=a===void 0||a===null?true:!!a;if(a){return f+"&token="+window.mailru_api_token}else{return f}}var q=k?function(a){var b=a.type;if(b==="upload"||b==="uploadend"){if(b==="upload"){$.extend(this,d._xhr);this.onreadystatechange()}}else{o(a)}}:function(a){o(a)};function r(a){d.uploading=true;d.upload(l=p(a),m,q.bind(this))}if(k){patron.API({url:"//"+location.host+l,xhr:function(){return{open:$.noop,send:r}},complete:function(a){var b=a.getBody(),c;if(a.isOK()){c=["OK","UPLOADED",{FileName:b.attach.name,Size:b.attach.size,Id:b.attach.id,SpaceLeft:b.space_left}]}else{c=["","ERROR"];if(b.file){if(b.file.error==="disabled_file_type"){c=["OK","UPLOADED",{Error:"EX_DISABLEDFILETYPE"}]}else if(b.file.error==="invalid"&&!b.file.value){c=["OK","UPLOADED",{Error:"EX_FILEEMPTY"}]}}}this._uploadComplete(d,l,"upload",c);this._uploadComplete(d,l,"uploadend")}.bind(this)})}else{r(j)}patron.log("html5._uploadFile",{url:l,file:g(d)},1)},_uploadFile:function(b,c){c=a.isset(c,!!b.isFiles);this._chooseStorage(c,b,this._doUploadFile.bind(this,b,c))},_attachFile:function(b){a.log("html5._attachFile: "+["needAttach->"+(b.needAttach?1:0),"fromCloud->"+(b.fromCloud?1:0),"isFiles->"+(b.isFiles?1:0)].join(", ")+"; _spaceLeft->"+this._spaceLeft+", file.size->"+b.size);return b.needAttach?b.fromCloud?this._attachCloud(b):this._attachForward(b):b.isFiles?$.Deferred().resolve(b,this._spaceLeft):$.Deferred().resolve(b,this._spaceLeft-n(b))},_attachForward:function(a){var c=$.Deferred(),d=a.PartId?a.PartId:a._file.id;if(b.has("send-use-forward-add")){patron.API({type:"POST",url:"messages/attaches/forward/add",data:{message_id:this.opts.MessageId,id:d},complete:function(b){var d=b.getData(),e;if(b.isOK()){e=d.attach}if(e){a.AttachId=e.id;c.resolve(a,o(d.space_left))}else{var f="upload";if(d){if(d.id){f=d.id.error}else{f=d}}c.reject(a,f)}}.bind(this)})}else{c.resolve(a,this._spaceLeft-n(a))}return c.promise()},_attachCloud:function(a){var c=$.Deferred(),d=a.PartId;if(patron.UseSendAPIV1){if(b.has("send-use-cloud-add")){patron.API({type:"POST",url:"messages/attaches/cloud/add",data:{message_id:this.opts.MessageId,cloud_id:d},complete:function(b){var d=b.getData(),e;if(b.isOK()){e=d.attach}if(e){a.AttachId=e.id;c.resolve(a,o(d.space_left))}else{var f="";if(d){if(d.cloud_id){f=d.cloud_id.error}else if(d.file){f=d.file.error}else{f=d}}if(f!=="disabled_file_type"){f="cloudupload"}c.reject(a,f)}}.bind(this)})}else{c.resolve(a,this._spaceLeft-n(a))}}else{patron.Ajax({type:"POST",url:f+"/cgi-bin/attach_upload2?func_name=attach_from_cloud",data:{message:this.opts.MessageId,cloud_file_id:d},complete:function(b){var d=(b.getAdditionalData()||[])[0],e;if(d&&d.Id&&!d.Error){e=d}if(e){a.AttachId=e.Id;c.resolve(a,o(e.SpaceLeft))}else{var f="cloudupload";if(d){switch(d.Error){case"EX_DISABLEDFILETYPE":f="disabled_file_type"}}c.reject(a,f)}}})}return c.promise()},_chooseStorage:function(d,e,g){patron.log("html5._chooseStorage",e.name,1);if(!$.support.fileapi&&!e.isFlash){e.iframe=true;g("/cgi-bin/sentmsg?x-email="+patron.useremail+"&ajax_upload=1&compose_name="+this.opts.name+"&rnd="+a.now())}else if(d){if(b.has("new-cloud-files")){if(this._cloud_store.bundle_id){e.bundle_id=this._cloud_store.bundle_id;g(this._cloud_store.loader_url,void 0,false)}else{c.call("cloud/attachment/create").then(function(a){var b=a.body;var c=a.xhr;if(!b.loader_url){var d=["","ERROR"];this._uploadComplete(e,"cloud/attachment/create","",d);patron.log("html5._chooseStorage.new-files.create-bundle.error.loader-url-not-exist",{xhrStatus:c.status,textStatus:c.textStatus},1);return}var f=jsHistory.buildUrl({"x-email":patron.useremail,cloud_domain:2},null,b.loader_url);e.bundle_id=b.bundle_id;this._cloud_store={bundle_id:b.bundle_id,loader_url:f};g(f,void 0,false)}.bind(this),function(a){var b=a.xhr;var c=["","ERROR"];this._uploadComplete(e,"cloud/attachment/create","",c);patron.log("html5._chooseStorage.new-files.create-bundle.error",{xhrStatus:b.status,textStatus:b.textStatus},1)}.bind(this))["catch"](function(a){var b=["","ERROR"];this._uploadComplete(e,"cloud/attachment/create","",a);patron.log("html5._chooseStorage.new-files.create-bundle.throw-error",{},1)}.bind(this))}}else{$.ajax({url:"//"+this._filesHost+"/cgi-bin/files/fajaxcall?x-email="+patron.useremail+'&func_name=cbChooseStorage&ajax_call=1&data=["'+e.size+'"]',type:"GET",dataType:"json",crossDomain:true,timeout:5e3,success:function(b){var c=this._filesUrl,d=b[2];if(b[1].toUpperCase()=="OK"&&d&&/http(s?):\/\/\w+/i.test(d.host)){c=d.host+d.url}c+=(~c.indexOf("?")?"&":"?")+"&rnd="+a.now();g(c)}.bind(this),error:function(a,b){g(this._filesUrl);patron.log("html5._chooseStorage.error",{xhrStatus:a.status,textStatus:b},1)}.bind(this)})}$.event.trigger("ui-abstract-action",{chain:["compose","attaches","link","add"]})}else{var h=patron.UseSendAPIV1&&!($.browser.msie&&$.browser.intVersion<10&&e.isFlash);if(h){g("/api/v1/messages/attaches/add?"+$.param({email:patron.useremail,htmlencoded:false,message_id:e.MessageId||this.opts.MessageId,rnd:a.now()}),h)}else{g(f+"/cgi-bin/attach_upload2?ajax_call=1&x-email="+patron.useremail+"&rnd="+a.now())}}},_error:function(a,b,c){patron.radar("uploader",a+"Err=1");patron.log("html5._error."+a,{file:b.name,result:c},1);switch(a){case"disabled_file_type":patron.Notify.add("error",{html:String.sprintf(Lang.get("upload.error."+a),b.name),delay:10});break;case"filesize_limit_exceeded":this._notify("upload.limit.template",b.name);break;default:this._notify("upload.error."+a,b.name);break}if(a!=="remove"){this.List.remove(b)}},_notify:function(b){var c=arguments,d=Lang.get(b);c[0]=$.isEmptyObject(d)?Lang.get("upload.error.upload"):d;alert(String.sprintf.apply(a,c))},_notifyReattachError:function(a,b){var c,d,e,f;c=patron.Compose.Form.getActive().composeUI;d=b.filter(function(a){return a.error==="not_exists"&&a.type==="link"}).map(function(a){return{name:"https://"+patron.FilesHost+"/"+a.origin_id,type:"warning"}});f=b.filter(function(a){return a.error==="filesize_limit_exceeded"});e=f&&f.length;if(e){this._notify("upload.error.reattach")}else{c.showError(a,{items:d})}},_notifyExpiredError:function(a,b){var c,d;c=patron.Compose.Form.getActive().composeUI;d=b.map(function(a){var b=a.name.split(/\.([^\.]*$)/).slice(0,2);return{name:b[0],extension:b[1],type:"warning"}});c.showError(a,{items:d})},notifyAttachError:function(a,b){var c=b||[];var d=patron.Compose.Form.getActive().composeUI;var e;return new Promise(function(b,f){e=b;d.on("troubleshower:close",b);if(a==="reattach"){this._notifyReattachError(a,c)}else if(a==="expired"){this._notifyExpiredError(a,c)}}.bind(this)).then(function(){d.off("troubleshower:close",e)})},getByUid:function(a){for(var b=0,c=this._files.length;b<c;b++){if(this._files[b].uid==a){return this._files[b]}}},getByPartId:function(a){for(var b=0,c=this._files.length;b<c;b++){if(this._files[b].PartId==a){return this._files[b]}}},getByFileId:function(a){var b,c,d,e;for(d=0,e=this._files.length;d<e;d++){b=a.split(":");c=b[1]?b[1]:b[0];if(c==this._files[d].AttachId||c==this._files[d].data.Id){return this._files[d]}}},getByType:function(b){var c;var d;if(b.type==="link"||b.type==="cloud_stock"){d=b.origin_id}else if(b.type==="cloud"){d=a.uuid(b.origin_id.split(":")[0])}else if(b.type==="attach"){if(b.tnef_id){d=a.uuid(b.origin_id+b.tnef_id)}else{d=a.MD5(b.origin_id)}}var e=this.getByPartId(d);if(e&&b.type==="cloud_stock"){e.isFiles=true;e.onlyPartId=false;c=e}else{c=this.getByUid(d)}if(b.type==="cloud_stock"&&c){c.bundle_id=b.attach.id.split(":")[0]}return c},getAll:function(){return this._files},registerInlineInput:function(){if(this.$InlineInp){return}this.$InlineInp=this.$Form.find(".js-inline-input-file").multiple({resize:{preview:{min:100,type:"min"},upload:{min:800,max:1280,type:"min",enabled:this._adaptive}},onselect:this._onSelect.bind(this,"inline")})},uploadInlineFile:function(a,b){if(!(a instanceof $.multiple.File)){a=this.$Inp.multiple("newFile",a,{name:"Filedata"})}a.on("uploadstart.upload upload.upload error.upload abort.upload progress.upload uploadend.upload",b);this._uploadFile(a)},reattachInfo:function(){return this._reattachData.info},_reattachComplete:function(a){if(this._reattachData.done=a){while(this._reattachData.callbacks.length){this._reattachData.callbacks.shift()()}}},_doAction:function(a){if(this._reattachData.done){a()}else{this._reattachData.callbacks.push(a)}},_reattach:function(c,d){return new Promise(function(d,e){this._reattachComplete(false);this._reattachData.xhr=patron.API.post("messages/attaches/reattach",{forwarded_id:c,message_id:this.opts.MessageId},function(c){var f=c.getData();var g=false;var h;if(c.isOK()){if(f.error_files.length>0){h=f.error_files[0].error;if(b.has("compose2-notify")){g=true;this.notifyAttachError("reattach",f.error_files).then(function(){if(b.has("reattach-with-expired")){d(f.okay_files)}})}else{this._notify("upload.error.reattach")}$.event.trigger("ui-abstract-action",{chain:["messages","attaches","reattach","error",h]});if(!b.has("reattach-with-expired")){this.reset();e();return}}if(f.okay_files.length>0){Array.forEach(f.okay_files,function(a){var b=this.getByType(a);if(b){b.AttachId=a.attach.id}else{if(a.type==="cloud_stock"&&!a.attach.id){$.event.trigger("ui-abstract-action",{chain:["messages","attaches","reattach","error","cloud-stock-file","has-not-id"]})}else if(a.type==="cloud_stock"){$.event.trigger("ui-abstract-action",{chain:["messages","attaches","reattach","error","cloud-stock-file","unknown"]})}else{this._reattachData.inline[a.origin_id]=a.attach}}},this);this._spaceLeftEstimate=this._spaceLeft=f.space_left;a.log("html5._spaceLeft 5: "+this._spaceLeft)}this._reattachComplete(true);this._reattachData.info={done:true,okay:f.okay_files.length!==0,error:f.error_files.length!==0};if(b.has("compose2")){$(window).resize()}if(!g){d(f.okay_files)}}else if(c.isAbort()){$.event.trigger("ui-abstract-action",{chain:["messages","attaches","reattach","abort"]});e()}else{$.event.trigger("ui-abstract-action",{chain:["messages","attaches","reattach","error","unknown"]});e()}}.bind(this))}.bind(this))},redraw:function(c,d){this.opts=c;this.opts.files_id=a.filter(d.UploadConfig,function(a){return a.name=="files"})[0].GroupCode;this._spaceLeft=this.opts.LeftMailSize;this._spaceLeftEstimate=this._spaceLeft;this._restoreUrl=this.opts.files_id;this._reattachData={done:true,callbacks:[],inline:{},info:{}};if(patron.UseSendAPIV1){if(b.has("compose-reattach")&&c.needReattach&&c.msg){this._reattach(c.msg)}}this.restore()},restore:function(b){$.multiple.ready(function(){if(this._restoreUrl){var c=this._restoreUrl;delete this._restoreUrl;Array.forEach(c.split(","),function(a){$.ajax({url:"//"+this._filesHost+"/"+a+"?json=1&uploader=1",type:"GET",dataType:"json",crossDomain:true,success:function(a){this.restore(a.file_list)}.bind(this)})},this)}b=a.map((b||[]).concat(this.opts.mailRestoreList||[]).concat(this.opts.cloudLinks||[]),function(a){var b=defined(a.filename,"")+"";return{uid:a.fileid,name:b,size:~~a.filesize,isRFC822:~~a.isRFC822,partId:a.partid,isFiles:!!a.dlink,onlyPartId:a.onlyPartId,hasPreview:a.is_previewable||q.test(b.match(p)),previewSrc:a.is_previewable&&a.static?a.static:0}},this);delete this.opts.mailRestoreList;this.attach(b)}.bind(this))},active:$.noop,unactive:function(){this.reset();if(this.$Inp){var a=this.$Inp.multiple("mouseout");if(a){a.multiple("clear")}}},reset:function(){var a=this.getLoadingFiles().sort(function(a,b){return!!a.uploading>!!b.uploading});this.removeFiles(Array.map(a,function(a){return a.uid}));this._filesUrl="//"+this._filesHost+"/upload_ext/";this._restoreUrl=this.opts.files_id;this._spaceLeft=this.opts.LeftMailSize;this._spaceLeftEstimate=this._spaceLeft;this._count=0;this._loaded=0;this._queue=[];this._files=[];this._cloud_store={bundle_id:null,loader_url:null};this._uploading=this._onQueueStart=false;if(this._reattachData){this._reattachData.callbacks.length=0;this._reattachData.info={};if(this._reattachData.xhr){this._reattachData.xhr.abort()}}this.List.clear();this.triggerHandler("reset")},getLoadingFiles:function(){return a.filter(this._files||[],function(a){return!(a.loaded||a.error)})},isLoading:function(){return this.getLoadingFiles().length>0},getUploadedAttachments:function(){var b=a.filter(this._files,function(a){return a.loaded&&!a.onlyPartId&&!a.isFiles});return a.map(b,function(a){return{fileid:a.data.Id,fuid:a.uid,filename:a.name,bundle_id:a.bundle_id}})},getFilesAttachments:function(){var b=a.filter(this._files,function(a){return a.loaded&&(!patron.UseSendAPIV1||!a.onlyPartId)&&a.isFiles&&!a.fromCloud});return a.map(b,function(a){return{fileid:a.AttachId||a.data.Id,fuid:a.uid,filename:a.name,bundle_id:a.bundle_id}})},getUploaderSize:function(){var b=0;a.each(this._files,function(a){b+=a.loaded?a.size:0});return b},getFilesCount:function(){return this.List?this.List._count:this._count},attach:function(c,d){var e=this,f=[],g=[],h=[],i=$.Deferred();i.done(function(){h.forEach(function(a){g.push(a)});g.forEach(e._removeItem,e);e.trigger("onQueueFinsh")});function j(){var b=g.shift();if(b){e.List._updateItem(b,"uploading");e._attachFile(b).then(function(b,c){b.uploading=false;b.loaded=true;e.List._updateItem(b,"progress",{});e.List._updateItem(b,"uploadend");f.push(b);e._spaceLeftEstimate=e._spaceLeft=Math.max(c,0);a.log("html5._spaceLeft 6: "+e._spaceLeft+" "+c);j()},function(a,b){a.uploading=false;a.error=true;var c=false,d=a.name;switch(b){case"total_count_limit_exceeded":case"mrim_disabled":c=true}h.push(a);if(c){g.forEach(function(b){d+=", "+a.name})}e._error(b,$.extend({},a,{name:d}));if(c){i.resolve(f)}else{j()}})}else{i.resolve(f)}}c.forEach(function(a){var c=this.$Inp.multiple("newFile",a,{name:"Filedata"});$.extend(c,{data:{Id:a.uid},isFiles:a.isFiles,previewSrc:a.previewSrc,downloadlink:a.downloadlink,hasPreview:a.hasPreview,onlyPartId:a.onlyPartId,fromCloud:a.fromCloud,fromFilesearch:a.fromFilesearch,PartId:a.partId,MessageId:this.opts.MessageId,uploading:true,notTransform:true});if(!d||a.external){c.needAttach=!a.isFiles&&(a.fromFilesearch&&b.has("send-use-forward-add")||a.fromCloud&&b.has("send-use-cloud-add"))}this._count++;this._loaded++;this._files.push(c);this.List.add(c,c.needAttach,true,c.needAttach);g.push(c)},this);(function(){e.trigger("onQueueStart");e.trigger("onQueueChanged",[e._loaded]);j()}).gap(0)();e.triggerHandler("attachFiles",[g]);return i.promise()},removeFiles:function(a){Array.forEach(a,function(a){this.List.trigger("remove",[a])},this)},adaptive:function(a,b){if(this._adaptive==null){try{this._adaptive=store.get("upload.adaptive")==1}catch(a){}}if(a!=null){if(b){store.set("upload.adaptive",+a)}this._adaptive=a;this.$Inp.multiple("resize",{upload:{min:800,max:1280,type:"min",enabled:a}});patron.log("html5.images.adaptive",a);patron.radar("picadapt","change=1")}return!!(patron.UploaderImageAdapt&&this._adaptive)}});a.createClass("patron.Compose.FileUploaderView",[jQueryEvent],$.extend({__construct:function(a,b){this.$View=a=$(a).delegate("i","click",this._onClick.bind(this)).delegate(".js-item,.js-img","click",this._onItemClick.bind(this));this.$hr=$(".js-hr",a).display(0);this.$Files=$(".js-files",a).display(0);this.$Images=$(".js-images",a).display(0);this._model=function(){return b};this._size=0;this._count=0;this._files=0;this._cloud=0;this._images=0;this._map={};this._redraw=this._redraw.bind(this);this._adaptive()},_adaptive:function(){var a=this._model().adaptive();this.$View.find(".js-adapted-on").display(a).end().find(".js-adapted-off").display(!a)},_onItemClick:function(a){var b=$(a.currentTarget).closest(".js-file");if(b.hasClass("upload__file__canOpen")){var c=b.attr("id");if(c){this.trigger("show",[c])}}},_onClick:function(a){var b=a.target,c=b.getAttribute("data-act"),d=$(b).closest(".js-file").prop("id"),e=this.getModel().getByUid(d);if(c){patron.radar("uploader","act"+c+"=1");if(c=="rotate"){e.rotate(u(d,b.getAttribute("data-rotate")=="cw"?1:-1));clearTimeout(e._rpid);e._rpid=setTimeout(this.trigger.bind(this,c,d),1e3)}else if(c=="adapted"){this.getLayer(function(a){if(a){this._model().adaptive(a.state==1,a.remember);this._adaptive();this.trigger(c)}}.bind(this))}else{this.trigger(c,[d]);a.stopPropagation()}a.preventDefault()}},getLayer:function(a){var b=this;require(["plugins/Layer"],function(){Layer.get("uploadAdaptedPhotos",function(c){c.$div.find(".js-adapted-"+(b._model().adaptive()?"on":"off")).prop("checked",true);c.func=function(b){a(b?this.$div.toObject():null)};c.show()})})},_upload:function(a,b,c){var d=c.type,e={};if(d!="progress"){patron.radar("uploader",d+"=1")}else{e.loaded=c.loaded;e.total=c.total}this._updateItem(b,d,e)},_redraw:function(){var b=Math.round(patron.MaxAttachmentSize/Math.MB)||25;var c=this._count-this._images+this._files+this._cloud;a.log("html5.List._redraw: this._size->"+this._size);this.$View.display(this._count);this.$hr.display(c&&this._images);this.$Files.display(c);this.$Images.display(this._images);var d=String.sprintf(Lang.get("upload.info."+(this._files&&this._cloud?"mixed":this._files?"files":"cloud")),b);$(".upload__file_file",this.$Files).width(Math.max(this.$Files.width()/3-5,180));$(".js-all-size",this.$View).html(String.sizeFormat(this._size));$(".js-all-count",this.$View).html(String.num(this._count,Lang.get("files.plural")," "));$(".js-files-external",this.$View).display(this._files||this._cloud);$(".js-files-external-text",this.$View).html(d);$(".js-adapted-info",this.$View).display(!!(patron.UploaderImageAdapt&&this._images&&!patron.IsMyCom))},getModel:function(){return this._model()},add:function(b,c,d,e){var f=b.uid,g=!b._imgError&&($.support.fileapi||b.isFlash||b.hasPreview||b.fromFilesearch)&&b.isImage(),h=b.isFiles&&!b.fromCloud,i=b.isFiles&&b.fromCloud,j=document.getElementById(f),k=String(b.name).match(p)&&RegExp.$1.toLowerCase();this._map[b.uid]=b;if(g&&(b.isFiles&&b.data||(!($.support.fileapi||$.support.flashUpload||b.fromFilesearch)||b.fromCloud&&!b.previewSrc))){g=false}if(!d&&j){this._redraw();return}b._img=g=g&&q.test(k);if(!this._count){$(window).bind("resize",this._redraw)}a.log("html5.List.add before: "+["this._count->"+this._count,"this._size->"+this._size].join(", ")+"; file.size->"+b.size);if(!j){this._count++;this._size+=b.size;if(g)this._images++;if(h)this._files++;if(i)this._cloud++}a.log("html5.List.add after: "+["this._count->"+this._count,"this._size->"+this._size].join(", "));this._drawItem(b,{id:f,ext:String(b.type).match(r)&&RegExp.$1||k,name:b.name,size:b.size?String.sizeFormat(b.size):"",nameHTML:replaceEntity(b.name),isImg:g,isFiles:h||i,hasTrans:b.hasSupportTransform()&&!b.notTransform,await:!!c,unremovable:!!e,loaded:b.loaded},{force:d,exists:j});if(g){this._loadPreview(b)}b.on("uploadstart.upload upload.upload error.upload abort.upload progress.upload uploadend.upload",this._upload.bind(this,f,b));this._redraw()},remove:function(a){if(this._eraseItem(a)){delete this._map[a.uid];this._size-=a.size;this._count--;if(a._img)this._images--;if(a.isFiles&&!a.fromCloud)this._files--;if(a.isFiles&&a.fromCloud)this._cloud--;this._redraw()}if(!this._count){$(window).unbind("resize",this._redraw)}},getFiles:function(){return this._map},hold:function(a,b){b=b===undef||b;$(m(a)).animate({opacity:b?.5:1},"fast")[b?"bind":"unbind"]("mousedown mouseup click",false)},clear:function(){if(this._count){this.$Files.empty();this.$Images.empty();this._size=0;this._count=0;this._files=0;this._cloud=0;this._images=0;this._map={};this._redraw()}},_drawItem:function(a,b,c){var d=$($.tpl("#compose__attach_ejs",b));if(c.force&&c.exists){d.replaceAll(m(b.id))}else{d.appendTo(this[b.isImg?"$Images":"$Files"]).fadeIn("slow")}if(a.loaded&&!a.isFiles){d.addClass("upload__file__canOpen")}},_eraseItem:function(a){var b=$(m(a.uid)).unbind().stop().remove();return b.length},_updateItem:function(a,b,c){var d=$(m(a.uid));if(d[0])switch(b){case"uploadend":d.addClass("upload__file_loaded"+(d.data("error")?"-error":""));if(!a.isFiles){d.addClass("upload__file__canOpen")}$(".js-ok",d).display(1);$(".js-del",d).display(1);case"uploadstart":var e=b=="uploadend";$(".js-hide",d).display(e);$(".js-bar",d)[e?"F":"css"]("width",0);$(".js-progress",d).display(!e);break;case"abort":case"error":d.data("error",true);break;case"progress":if(!d.data("progress")){$(".js-loader",d).display(0)}if(isNaN(c.total))c.total=1;if(isNaN(c.loaded))c.loaded=0;var f=Math.round(c.loaded/c.total*100);f=Math.round(f/5)*5;if(f!=d.data("progress")){$(".js-bar",d.data("progress",f)).dequeue().animate({width:f+"%"},"slow")}break;case"preview":c.$image.addClass("js-img").replaceAll(m(a.uid)+" .js-img");if(c.$image[0].naturalWidth>c.$image[0].naturalHeight){c.$image.css({display:"inline-block",height:"100%",margin:"0 -50%"}).parent().css({textAlign:"center"})}else{c.$image.css({width:"100%"})}c.$image.removeAttr("width").removeAttr("height");if(a.loaded){$(m(a.uid)).addClass("upload__file_loaded")}break}},_loadPreview:function(a){a.url=a.previewSrc||(patron.IsWinDev||patron.IsDevMyCom?"http:":location.protocol)+"//"+(patron.MailAttachPreviewHost||"apf."+(patron.SingleDomainName||"mail.ru"))+"/cgi-bin/readmsg/"+encodeURIComponent(a.name)+"?id="+a.PartId+"&exif=1&mode=attachment";if(!$.support.fileapi&&$.support.flashUpload)a.isFlash=true;patron.Utils.logAPFRequest(a.url);a.loadAsImage(function(b){var c=b.type;if(this._map[a.uid]){if(c=="load"){try{var d=!a.isLink()&&$.support.fileapi&&t(b.target,200,200);this._updateItem(a,"preview",{$image:d?$(new Image).attr("src",d):$(b.target)})}catch(a){c="error";b.error=a}}if(c=="error"){a._imgError=true;patron.log("html5.loadAsImage.error",{url:a.name},1)}}}.bind(this))}},b.has("compose2")?d:{}));function t(b,c,d){try{var e=Math.max(c/b.width,d/b.height),f=b.width*e,g=b.height*e,h=document.createElement("canvas"),i=h.getContext("2d");h.width=c;h.height=d;i.fillStyle="rgb(255,255,255)";i.fillRect(0,0,h.width,h.height);i.drawImage(b,0,0,b.width,b.height,(c-f)/2,(d-g)/2,f,g);i=null;return h.toDataURL("image/png")}catch(b){a.log("preview.error:",b);patron.radar("uploader","errcanvas=1")}}function u(a,b){var c=$(m(a)+" .js-img"),d;c[0]._deg=d=b*90+(c[0]._deg|0);b=b*90+(c[0].rotate|0);if(b<0)b=360+b;c[0].rotate=b=s[b]?b:0;c.css3({transform:"rotate("+d+"deg)"});if($.browser.msie&&parseInt($.browser.version)<9){c.css({filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation="+s[b]+")"})}return b}if(!patron.AllowDropInlineImageInEditor&&$.support.fileapi)$(function(){var c,d,e=function(a){if(d!==a){$("#mailru-drop-zone").display(d=a)}},f=e.bind(0,true),g=e.bind(0,false),h=b.has("compose.dnd");$("#mailru-drop-zone").bind("click",e.bind(0,false));$(document).bind("dragover dragenter",function(a){clearTimeout(c);var b=Array.indexOf(a.originalEvent.dataTransfer.types,"Files")>-1;var d=patron.Compose.Form&&patron.Compose.Form.getActive();if(b&&(h||d)){f();try{var e=a.originalEvent.dataTransfer.effectAllowed;a.originalEvent.dataTransfer.dropEffect=e=="move"||e=="linkMove"?"move":"copy";a.preventDefault();a.stopPropagation()}catch(a){}return false}}).bind("dragleave",function(){c=setTimeout(g,50)}).bind("drop",function(b){if(!b.originalEvent||!b.originalEvent.dataTransfer){return}var c=patron.Compose.Form.getActive();var d=b.originalEvent.dataTransfer;var f=d.files;var g=Array.indexOf(d.types,"Files")>-1;var i=function(b){f=a.filter(f,function(a){return a.size>0});b.getFileUploader().uploadFiles(f)};if(g){if(c){i(c)}else if(h){var j=0;jsHistory.set("sentmsg");setTimeout(function a(){c=patron.Compose.Form.getActive();if(c){i(c)}else if(j++<5){setTimeout(a,200*j)}},500)}e(false);return false}})})});define("patron.compose/patron.Compose.FileUploader",["jquery","jsCore/swfobject","utils/Counter","plugins/jQueryEvent","patron.compose/patron.Compose.FileUploaderJS","patron.compose/patron.Compose.FileUploaderSWF","patron.compose/patron.Compose.FileUploaderHTML5"],function($){patron.Compose.log=patron.Compose.log||function(a){if(window.console&&$.isFunction(console.log)){console.log("[patron.Compose.log]",a)}};var a=$(window),b=Array.prototype.slice;jsClass.create("patron.Compose.FileUploader").extend(jQueryEvent).statics({defaultOptions:{flashReadyTimeout:1e4}}).methods({__construct:function(c,d,e){var f=this;f.options=$.extend({},patron.Compose.FileUploader.defaultOptions,e);f.$form=$(c);f.filesCount=0;f.timers={};var g=f.options.domIDs;f.$controlsContainer=$(g.composeControlsContainer);f.$attachBigFileContainer=$(g.composeAttachBigFileContainer);f.$JSUploaderContainer=$(g.JSUploaderContainer);f.$JSSWFInputContainer=$(g.composeJSSWFInputContainer);f.$liteInputContainer=$(g.composeLiteInputContainer);f.$filesInputContainer=$(g.composeFilesInputContainer);f.$flashUploaderContainer=$(g.flashUploaderContainer);f.$uploaderSettings=$(g.composeUploaderSettings);f.$sendToFilesMailContainer=$(g.sendToFilesMailContainer);f.$browseFileContainer=$(g.BrowseFile);f.$flashLoader=$(".js-loaderLoadProgress",f.$JSSWFInputContainer);f.flashReady=0;$.multiple&&$.multiple.ready(function(){if($.support.fileapi){patron.radar("uploader","html5=1")}else if($.support.flashUpload){patron.radar("uploader","flash=1")}else{patron.radar("uploader","iframe=1")}});if(patron.HTML5Uploader){f.uploaderHTML5=new patron.Compose.FileUploaderHTML5(c,d);f._initJSUploader=f._initSWFUploader=f._initLiteUploader=ajs.F;f._getReadyUploader=function(){return f.uploaderHTML5};f.redraw=function(a){f._setSettings(a);f.uploaderHTML5.redraw(f.settings,f.config);if(ajs.offline){f._onChangeOfflineMode(null,true)}};f.bind("reset active unactive",function(a){f.uploaderHTML5[a.type]()});f.uploaderHTML5.bind({onFilesLinkCodeAdded:function(){f.triggerHandler("onFilesLinkCodeAdded",b.call(arguments,1))},onFilesLinkCodeChange:function(){f.triggerHandler("onFilesLinkCodeChange",b.call(arguments,1))},onQueueStart:function(){f.isFileLoading=true},onQueueFinsh:function(){f.isFileLoading=false;f.triggerHandler("onQueueFinsh",b.call(arguments,1))},onQueueChanged:function(a,c){f.filesCount=c;f.triggerHandler("onQueueChanged",b.call(arguments,1))},onFileShow:function(a){f.triggerHandler("onFileShow",b.call(arguments,1))}})}else{f.uploaderSWF=new patron.Compose.FileUploaderSWF(c,{domIDs:g});f.uploaderJS=new patron.Compose.FileUploaderJS(c,{domIDs:g});f.bind({unactive:function(){var a=this;a.uploaderSWF.unactive();a.uploaderJS.unactive()},reset:function(){var a=this;a.uploaderSWF.reset();a.uploaderJS.reset()},attachUpload:function(a,b,c){var d=this;var e=AjaxCall.parseArray(b);var f=d.dragFiles[c];if($.isArray(e)){var g=e[1];if(g){var h=d._getReadyUploader();h.attachUpload(c,g,f)}}}});f.uploaderJS.bind({onQueueStart:$.proxy(function(){var a=this;var b=a.getBrowseFakeInput();a.isFileLoading=true;a._disableInput();b.val(Lang.get("Loading").messages)},f),onQueueFinsh:$.proxy(function(){var a=this;var c=a.getBrowseFakeInput();a.isFileLoading=false;a._toggleInputStatus();c.val(c.data("defaultValue"));a.triggerHandler("onQueueFinsh",b.call(arguments,1))},f),onQueueChanged:$.proxy(function(a,c){var d=this;d.filesCount=c;d._toggleInputStatus();d.triggerHandler("onQueueChanged",b.call(arguments,1))},f),fileLoadError:$.proxy(function(){var a=this;a.triggerHandler("fileLoadError",b.call(arguments,1))},f)});f.uploaderSWF.bind({onFilesLinkCodeChange:$.proxy(function(){var a=this;a.triggerHandler("onFilesLinkCodeChange",b.call(arguments,1))},f),onQueueStart:$.proxy(function(){var a=this;a.isFileLoading=true},f),onQueueFinsh:$.proxy(function(){var a=this;a.isFileLoading=false;a.triggerHandler("onQueueFinsh",b.call(arguments,1))},f),onQueueChanged:$.proxy(function(a,c){var d=this;d.filesCount=c;d.triggerHandler("onQueueChanged",b.call(arguments,1))},f)})}f.getBrowseFileInput().mousedown(function(){f._initJSUploader()}).click(function(){a.triggerHandler("uploaderAddFileJSClick.compose")});f.$uploaderSettings.mousedown(function(){a.triggerHandler("uploaderSettingsLinkClick.compose")});f._setSettings(d);this.onChangeOfflineModeObserver=this._onChangeOfflineMode.bind(this);$(window).bind("offlinechange",this.onChangeOfflineModeObserver)},_setSettings:function(a){var b=this,c=location.protocol,d=(c=="https:"?"ssl.":"")+patron.FilesHost;b.settings=a;$.extend(b.settings,{name:b.options.name});b.config={UploadConfig:[]};b.config["UploadConfig"].push({name:"files",UpURI:c+"//"+d+"/upload_ext/",UpPhotoURI:c+"//"+d+"/cgi-bin/files/fupload",AjaxURI:c+"//"+d+"/cgi-bin/files/fajaxcall",RestoreURI:a.files_id?c+"//"+d+"/"+a.files_id+"?json=1&uploader=1":"",MaxFileSize:1024*1024*1024,SpaceLeft:20*1024*1024*1024,SrvListLimit:a.FilesLimit||50,GroupCode:a.files_id,ServerPriority:window.location.toString().match(/forcefiles/i)?1:10});b.config["UploadConfig"].push({name:"mail",UpURI:c+"//"+a.ServerName+"/cgi-bin/attach_upload2",AjaxURI:c+"//"+a.ServerName+"/cgi-bin/attach_upload2",MaxFileSize:a.MaxAttachmentSize,SpaceLeft:a.LeftMailSize,SrvListLimit:a.MailLimit||50,GroupCode:a.MessageId,DraftMsg:a.DraftMsg,ServerPriority:5,list:a.mailRestoreList});b.config["GlobalConfig"]={SrvListLimit:a.GlobalLimit||50,uploaddelay:10,resizeto:800,resizethreshold:1280,statURI:c+"//"+a.ServerName+"/cgi-bin/attstat"}},_initLiteUploader:function(){var a=this;a.$JSSWFInputContainer.add(a.$attachBigFileContainer).hide();a.$liteInputContainer.show();a.$controlsContainer.removeClass("pAbs");a.$JSUploaderContainer.css("paddingTop",7).toggleClass("jsdn",a.settings.mailRestoreList.length<=0)},_initSWFUploader:function(){var a=this;if(a.jsReady)return;a.$uploaderSettings.css("left",140);a.$flashUploaderContainer.add(a.$uploaderSettings).css("display","block");if(a.settings.mailRestoreList.length>0){a.$flashLoader.show();$(window).resize()}a.uploaderSWF.one({"_AjaxViaAdobeFlashIsReady.SWFUploader":$.proxy(function(){var a=this;if(!a.jsReady){a.flashReady=1;a.$flashUploaderContainer.css("zIndex",2);a._removeFlashReadyTimer();patron.radar("uploader","init_foto=1")}},a),"onQueueChanged.SWFUploader":$.proxy(function(){var a=this;a.uploaderSWF.one("setHeightToFileUploader.SWFUploader",$.proxy(function(){var a=this;a.$flashLoader.hide()},a))},a),"errorFlashLoad.SWFUploader":$.proxy(function(){var a=this;patron.Compose.log("_deinitSWFUploader: errorFlashLoad.SWFUploader");a._deinitSWFUploader();a._initJSUploader()},a)});a.uploaderSWF.init(a.settings,a.config);if(patron.isSentMsg||a.$form.is(":visible")){swfobject.addDomLoadEvent($.proxy(a._setFlashReadyTimer,a))}},_deinitSWFUploader:function(){var a=this,b=a.getBrowseFileInput();b.add($(a.uploaderSWF)).unbind(".SWFUploader");a.flashReady=0;a._removeFlashReadyTimer();a.$flashUploaderContainer.hide()},_initJSUploader:function(){var a=this;a.jsReady=1;a._deinitSWFUploader();a.$sendToFilesMailContainer.removeClass("jsdn");a.$uploaderSettings.css("left",295);a.$flashUploaderContainer.hide();a.$browseFileContainer.css("zIndex",3);a.uploaderJS.init(a.settings,a.config);patron.radar("uploader","init_js=1")},_onChangeOfflineMode:function(a,b){return;if(b){this._disableInput()}else{this._enableInput()}},_removeFlashReadyTimer:function(){var a=this;clearTimeout(a.timers["flashReadyTimer"])},_setFlashReadyTimer:function(){var a=this;a._removeFlashReadyTimer();a.timers["flashReadyTimer"]=setTimeout($.proxy(function(){var a=this;patron.Compose.log("_deinitSWFUploader: flashReadyTimer");a._deinitSWFUploader();a._initJSUploader()},a),a.options.flashReadyTimeout)},_disableInput:function(){var a=this.getBrowseFileInput(),b=this.getBrowseFakeInput();if(patron.HTML5Uploader){a.prop("disabled",true);b.addClass("form__button_disabled")}else{a.prop("disabled",true);b.prop("disabled",true);b.addClass("button-a_disabled")}},_enableInput:function(){var a=this.getBrowseFileInput(),b=this.getBrowseFakeInput();if(patron.HTML5Uploader){a.prop("disabled",false);b.removeClass("form__button_disabled")}else{a.prop("disabled",false);b.prop("disabled",false);b.removeClass("button-a_disabled")}},_toggleInputStatus:function(){var a=this;a.filesCount>=a.settings.MaxAttachments?a._disableInput():a._enableInput()},_getReadyUploader:function(){var a=this,b;if(a.flashReady){b=a.uploaderSWF}else{if(!a.jsReady){patron.Compose.log("_deinitSWFUploader: _getReadyUploader");a._deinitSWFUploader();a._initJSUploader()}b=a.uploaderJS}return b},getFilesCount:function(){return patron.HTML5Uploader&&this.uploaderHTML5?this.uploaderHTML5.getFilesCount():this.filesCount},unactive:function(){var a=this;for(var b in a.timers)clearTimeout(a.timers[b]);a.triggerHandler("unactive")},reset:function(){var a=this;a.jsReady=0;a.flashReady=0;a.filesCount=0;a.isFileLoading=false;a.$sendToFilesMailContainer.addClass("jsdn");a.$uploaderSettings.add(a.$flashUploaderContainer).show();a.$browseFileContainer.add(a.$flashUploaderContainer).css("zIndex","");a.$flashUploaderContainer.show();a.$flashLoader.hide();a.triggerHandler("reset")},redraw:function(a){var b=this;var c=patron.Compose.FileUploaderSWF.defaultOptions.allowVersion;var d=!a.NoFlashUploader&&swfobject.hasFlashPlayerVersion(c);b._setSettings(a);if(b.options.liteVersion){b._initLiteUploader()}else{if(d){b._initSWFUploader()}else{b._initJSUploader()}}b._enableInput();if(ajs.offline){this._onChangeOfflineMode(null,true)}},getBrowseFileInput:function(){if(patron.HTML5Uploader){return $('input[name="Filedata"]:first',this.uploaderHTML5.$Form)}else{return $('input[type="file"]:first',this.$browseFileContainer)}},getBrowseFakeInput:function(){if(patron.HTML5Uploader){return $(".js-button,.js-dropdown",this.uploaderHTML5.$Form)}else{var a=$(".js-fakeInput:first",this.$browseFileContainer);a.data("defaultValue",a.val()||"");return a}},isLoading:function(){var a=this;return a.isFileLoading},getUploadedAttachments:function(){var a=this;var b=a._getReadyUploader();return b.getUploadedAttachments()},getFilesAttachments:function(){return this._getReadyUploader().getFilesAttachments()},attach:function(a,b){if(patron.HTML5Uploader){return this.uploaderHTML5.attach(a,b)}},removeFiles:function(a){if(patron.HTML5Uploader){this.uploaderHTML5.removeFiles(a)}},uploadFiles:function(a){if(this.uploaderHTML5){a=a.map(function(a){if(a instanceof $.multiple.File){return a._file}else{return a}});this.uploaderHTML5.$Inp.first().multiple("select",a)}},uploadInlineFile:function(a,b){if(this.uploaderHTML5){this.uploaderHTML5.uploadInlineFile(a,b)}}})});define("patron.compose/patron.Compose.AppearanceTemplates",["ajs/pkg","jquery"],function(a,$){jsClass.create("patron.Compose.AppearanceTemplates").statics({defaultOptions:{imgPath:"https:"+patron.CssStaticUrl+"/mail/ru/images/templates/"}}).methods({__construct:function(a){var b=this;b.options=$.extend({},patron.Compose.AppearanceTemplates.defaultOptions,a);patron.lang["compose_appearance"]={categories:[{id:1,title:Lang.get("appearancecategory.love"),items:[{id:64,name:Lang.get("appearancetemplates.romance"),background:"#ffffff",color:"#000",textAlign:"left",fontFamily:"Georgia",topRow:{cells:[{width:"76",height:34,align:"right",img:b.options.imgPath+"64/tr.png"}],valign:"top"},bottomRow:{cells:[{width:"112",height:100,align:"left",img:b.options.imgPath+"64/bl.png"}],valign:"bottom"},middleRow:{cells:[{isCenterMiddle:true}]}},{id:53,name:Lang.get("appearancetemplates.hearts_rainbow"),background:"#280440",color:"#ffffff",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{width:"100%",height:94,align:"left",img:b.options.imgPath+"53/ltc.gif"}],valign:"top"},bottomRow:{cells:[{width:"100%",height:101,align:"right",img:b.options.imgPath+"53/rbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:166,valign:"top",align:"left",img:b.options.imgPath+"53/lt.gif"},{isCenterMiddle:true},{width:60}]}},{id:52,name:Lang.get("appearancetemplates.valentines_tree"),background_old:"#ffd2ff",background:"#f9ddfe",color:"#1e0000",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{width:"100%",height:74,align:"left",img:b.options.imgPath+"52/ltc.gif"}],valign:"top"},bottomRow:{cells:[{width:112,height:124,align:"left",img:b.options.imgPath+"52/lbc.gif"},{width:"100%"},{width:574,align:"right",img:b.options.imgPath+"52/rbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:60},{isCenterMiddle:true},{width:212,valign:"bottom",align:"right",img:b.options.imgPath+"52/rb.gif"}]}},{id:12,name:Lang.get("appearancetemplates.turtledoves"),background:"#8fbbd6",color:"#303b46",textAlign:"center",fontFamily:"arial",topRow:{cells:[{width:124,height:180,align:"left",img:b.options.imgPath+"12/ltc.gif"},{width:"100%",align:"center",img:b.options.imgPath+"12/tc.gif"},{width:129,height:180,align:"right",img:b.options.imgPath+"12/rtc.gif"}],valign:"top"},bottomRow:{cells:[{height:50}]},middleRow:{cells:[{width:45},{isCenterMiddle:true},{width:40}]}},{id:2,name:Lang.get("appearancetemplates.romance"),background:"#fdfad9",color:"#811a21",topRow:{cells:[{height:40}]},bottomRow:{cells:[{width:104,height:51,align:"left",img:b.options.imgPath+"2/lbc.gif"},{width:"100%",valign:"bottom",HTML:'<table cellspacing="0" cellpadding="0" width="100%"><tr><td class="cell" height="11" bgcolor="#a5c941"> </td></tr></table>'},{width:113,align:"right",img:b.options.imgPath+"2/rbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:160,valign:"bottom",align:"left",img:b.options.imgPath+"2/lb.gif"},{isCenterMiddle:true},{width:50}]}}]},{id:7,title:Lang.get("appearancecategory.classics"),items:[{id:34,name:Lang.get("appearancetemplates.frame2"),background:"#ffffff",color:"#000000",fontFamily:"verdana",topRow:{cells:[{width:"100%"},{width:217,height:64,align:"right",img:b.options.imgPath+"34/rt.gif"}]},bottomRow:{cells:[{width:"100%",height:88,align:"left",img:b.options.imgPath+"34/lb.gif"}]},middleRow:{cells:[{width:130,align:"left",valign:"bottom",img:b.options.imgPath+"34/lm.gif"},{isCenterMiddle:true},{width:130,align:"right",valign:"top",img:b.options.imgPath+"34/rm.gif"}]}},{id:16,name:Lang.get("appearancetemplates.vintage_template_4"),background:"#feeedc",color:"#000000",textAlign:"center",fontFamily:"times new roman",topRow:{cells:[{width:"100%",height:102,align:"center",valign:"top",img:b.options.imgPath+"16/tc.gif",background:b.options.imgPath+"16/ts.gif"}]},bottomRow:{cells:[{width:"100%",height:70,align:"center",valign:"bottom",img:b.options.imgPath+"16/bc.gif",background:b.options.imgPath+"16/bs.gif"}]},middleRow:{cells:[{width:45},{isCenterMiddle:true,paddingTop:35,paddingBottom:35},{width:45}]}},{id:30,name:Lang.get("appearancetemplates.pattern"),background:"#ffffff",color:"#000000",fontFamily:"Trebuchet MS",topRow:{cells:[{width:"100%"},{width:287,height:97,align:"right",valign:"top",img:b.options.imgPath+"30/rt.gif"}]},bottomRow:{cells:[{width:145,height:85,align:"left",img:b.options.imgPath+"30/lb.gif"},{width:"100%"}]},middleRow:{cells:[{width:145,align:"left",valign:"bottom",img:b.options.imgPath+"30/lm.gif"},{isCenterMiddle:true},{width:120}]}},{id:39,name:Lang.get("appearancetemplates.invitation1"),background:"#e5ffd3",color:"#859e7f",textAlign:"center",fontFamily:"MonotypeCorsiva",fontStyle:"italic",topRow:{cells:[{width:"100%",height:95,align:"center",valign:"middle",img:b.options.imgPath+"39/mt.gif"}]},bottomRow:{cells:[{width:"100%",height:75,align:"center",valign:"middle",img:b.options.imgPath+"39/mb.gif"}]},middleRow:{cells:[{width:100},{isCenterMiddle:true},{width:100}]}},{id:40,name:Lang.get("appearancetemplates.invitation1"),background:"#f4d7ff",color:"#72667c",textAlign:"center",fontFamily:"MonotypeCorsiva",fontStyle:"italic",topRow:{cells:[{width:"100%",height:95,align:"center",valign:"bottom",img:b.options.imgPath+"40/mt.gif"}]},bottomRow:{cells:[{width:"100%",height:50,align:"center",valign:"middle",img:b.options.imgPath+"40/mb.gif"}]},middleRow:{cells:[{width:100},{isCenterMiddle:true},{width:100}]}}]},{id:2,title:Lang.get("appearancecategory.animals"),items:[{id:20,name:Lang.get("appearancetemplates.teddy_bears"),background:"#f3e7d9",color:"#000000",fontFamily:"Verdana",topRow:{cells:[{height:50}]},bottomRow:{cells:[{width:98,height:195,align:"left",valign:"bottom",img:b.options.imgPath+"20/lbc.gif"},{width:"100%"},{width:103,height:195,align:"right",valign:"bottom",img:b.options.imgPath+"20/rbc.gif"}]},middleRow:{cells:[{width:35},{isCenterMiddle:true},{width:30}]}},{id:17,name:Lang.get("appearancetemplates.zebra"),background:"#d5d2ca",color:"#000000",topRow:{cells:[{width:250,height:219,align:"left",img:b.options.imgPath+"17/ltc.jpg",background:"#f5f3f4"},{width:"100%",height:219,valign:"bottom",background:"#f5f3f4",HTML:'<table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td class="cell" bgcolor="#dfdfdf" height="1"> </td></tr></table><table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td class="cell" bgcolor="#fefefc" height="13"> </td></tr></table><table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td class="cell" bgcolor="#d5d2cb" height="77"> </td></tr></table>'}]},bottomRow:{cells:[{width:52,background:"#f3f3f5"},{width:1,background:"#dfdfdf"},{width:13,background:"#ffffff"},{height:20,HTML:"&nbsp;"}]},middleRow:{cells:[{width:52,background:"#f3f3f5"},{width:1,background:"#dfdfdf"},{width:13,background:"#ffffff"},{width:23},{isCenterMiddle:true},{width:15}]}},{id:4,name:Lang.get("appearancetemplates.cheese_mouse"),background:"#fcebab",color:"#232014",topRow:{cells:[{width:83,height:55,align:"left",img:b.options.imgPath+"4/ltc.gif"}],valign:"top"},bottomRow:{cells:[{width:"100%"},{width:142,height:41,align:"right",img:b.options.imgPath+"4/rbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:35},{isCenterMiddle:true},{width:140,valign:"bottom",align:"right",img:b.options.imgPath+"4/rb.gif"}]}},{id:6,name:Lang.get("appearancetemplates.butterflies"),background:"#c9f5fc",color:"#23597e",printBackground:"none",topRow:{cells:[{height:35}]},bottomRow:{cells:[{width:214,height:177,align:"left",img:b.options.imgPath+"6/lbc.png",imgWidth:203,imgHeight:176},{width:"100%"},{width:189,align:"right",img:b.options.imgPath+"6/rbc.png",imgWidth:193,imgHeight:154}],valign:"bottom"},middleRow:{cells:[{width:110,valign:"top",align:"left",img:b.options.imgPath+"6/lt.png",imgWidth:98,imgHeight:54},{isCenterMiddle:true},{width:55}]}},{id:18,name:Lang.get("appearancetemplates.snail"),background:"#fdf8eb",color:"#1d1d11",topRow:{cells:[{height:35}]},bottomRow:{cells:[{width:162,height:102,align:"left",valign:"top",img:b.options.imgPath+"18/lbc.gif"},{width:"100%",height:102,valign:"top",HTML:'<table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td class="cell" height="10"> </td></tr></table><table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td class="cell" bgcolor="#ada1b5" height="1"> </td></tr></table>'},{width:141,height:102,align:"right",valign:"top",img:b.options.imgPath+"18/rbc.gif"}]},middleRow:{cells:[{width:110,align:"left",valign:"bottom",img:b.options.imgPath+"18/lb.gif"},{isCenterMiddle:true},{width:80}]}},{id:23,name:Lang.get("appearancetemplates.doggy"),background:"#ffffff",color:"#000000",fontFamily:"georgia",topRow:{cells:[{width:375,height:170,img:b.options.imgPath+"23/ltc.gif",align:"left",valign:"top"}]},bottomRow:{cells:[{height:100}]},middleRow:{cells:[{width:20},{isCenterMiddle:true},{width:40}]}},{id:25,name:Lang.get("appearancetemplates.dalmatian"),background:"#ffffff",color:"#000000",topRow:{cells:[{width:"100%",height:99,background:b.options.imgPath+"25/bbg.gif",HTML:"&nbsp;"}]},bottomRow:{cells:[{width:"100%",height:112,background:b.options.imgPath+"25/tbg.gif",HTML:"&nbsp;"}]},middleRow:{cells:[{width:103,background:b.options.imgPath+"25/lbg.gif",HTML:"&nbsp;"},{isCenterMiddle:true},{width:89,background:b.options.imgPath+"25/rbg.gif",HTML:"&nbsp;"}]}},{id:50,name:Lang.get("appearancetemplates.cat_on_tree"),background:"#ffffff",color:"#5d8f0f",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{width:"100%",height:25,align:"right",img:b.options.imgPath+"50/rtc.gif"}],valign:"top"},bottomRow:{cells:[{width:"100%",height:116,align:"left",img:b.options.imgPath+"50/lbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:30},{isCenterMiddle:true},{width:142,valign:"top",align:"right",img:b.options.imgPath+"50/rt.gif"}]}},{id:51,name:Lang.get("appearancetemplates.watercolor"),background:"#ffffff",color:"#c1876c",textAlign:"left",fontFamily:"Georgia",topRow:{cells:[{width:"100%",height:34,align:"right",img:b.options.imgPath+"51/rtc.gif"}],valign:"top"},bottomRow:{cells:[{width:"100%",height:100,align:"left",img:b.options.imgPath+"51/lbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:64,valign:"bottom",align:"left",img:b.options.imgPath+"51/lb.gif"},{isCenterMiddle:true},{width:162,valign:"top",align:"right",img:b.options.imgPath+"51/rt.gif"}]}}]},{id:4,title:Lang.get("appearancecategory.nature"),items:[{id:63,name:Lang.get("appearancetemplates.strawberry"),background:"#ffffff",color:"#202c17",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{width:"100%",height:64,background:b.options.imgPath+"63/ts.gif",HTML:"&nbsp;"}]},bottomRow:{cells:[{width:"100%",height:63,align:"right",valign:"top",img:b.options.imgPath+"63/rbc.gif",background:b.options.imgPath+"63/bs.gif"}]},middleRow:{cells:[{width:60},{isCenterMiddle:true,paddingBottom:20},{width:240,align:"right",valign:"bottom",img:b.options.imgPath+"63/rb.gif"}]}},{id:62,name:Lang.get("appearancetemplates.stones"),background:"#e9eff6",color:"#202c17",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{width:"100%",height:35,align:"right",valign:"bottom",img:b.options.imgPath+"62/rtc.jpg"}]},bottomRow:{cells:[{width:"100%",height:67,background:b.options.imgPath+"62/bs.gif",HTML:"&nbsp;"}]},middleRow:{cells:[{width:55},{isCenterMiddle:true,paddingBottom:40},{width:217,align:"right",valign:"top",img:b.options.imgPath+"62/rt.jpg"}]}},{id:7,name:Lang.get("appearancetemplates.trees"),background:"#ffffff",color:"#394805",topRow:{cells:[{height:40}]},bottomRow:{cells:[{width:"100%"},{width:451,height:120,align:"right",img:b.options.imgPath+"7/rbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:50},{isCenterMiddle:true},{width:50}]}},{id:13,name:Lang.get("appearancetemplates.snow_peaks"),background:"#3c5e8a",color:"#ffffff",fontFamily:"verdana",topRow:{cells:[{height:30}]},bottomRow:{cells:[{width:"100%"},{width:434,height:210,valign:"bottom",align:"right",img:b.options.imgPath+"13/rbc.gif"}]},middleRow:{cells:[{width:15},{isCenterMiddle:true},{width:15}]}},{id:14,name:Lang.get("appearancetemplates.4_hills"),background:"#f5f1f0",printBackground:"none",color:"#000000",fontFamily:"arial",topRow:{cells:[{width:123,height:140,align:"left",valign:"top",img:b.options.imgPath+"14/ltc_mod.gif"}]},bottomRow:{cells:[{width:"100%"},{width:437,height:125,align:"right",valign:"bottom",img:b.options.imgPath+"14/rbc_mod.gif"}]},middleRow:{cells:[{width:45},{isCenterMiddle:true},{width:30}]}},{id:32,name:Lang.get("appearancetemplates.high_grass"),background:"#ffffff",color:"#70950d",fontFamily:"georgia",topRow:{cells:[{width:"100%"},{width:152,height:43,align:"right",img:b.options.imgPath+"32/rt.gif"}]},bottomRow:{cells:[{width:"100%",height:56,align:"left",img:b.options.imgPath+"32/lb.gif"}]},middleRow:{cells:[{width:130,align:"left",valign:"bottom",img:b.options.imgPath+"32/lm.gif"},{isCenterMiddle:true},{width:152,align:"right",valign:"top",img:b.options.imgPath+"32/rm.gif"}]}}]},{id:5,title:Lang.get("appearancecategory.flowers"),items:[{id:55,name:Lang.get("appearancetemplates.tulips"),background_old:"#d390fe",background:"#d3a9fd",color:"#42016b",textAlign:"left",fontFamily:"Verdana",topRow:{cells:[{width:"100%",height:50,align:"right",img:b.options.imgPath+"55/rtc.jpg"}],valign:"top"},bottomRow:{cells:[{width:"100%",height:140,align:"left",img:b.options.imgPath+"55/lbc.jpg"}],valign:"bottom"},middleRow:{cells:[{width:169,valign:"bottom",align:"left",img:b.options.imgPath+"55/lb.jpg"},{isCenterMiddle:true},{width:156,valign:"top",align:"right",img:b.options.imgPath+"55/rt.jpg"}]}},{id:59,name:Lang.get("appearancetemplates.camomiles"),background:"#319a12",color:"#ffffff",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{width:"100%",height:35,align:"left",img:b.options.imgPath+"59/ltc.gif"}],valign:"top"},bottomRow:{cells:[{width:"100%",height:92,background:b.options.imgPath+"59/bs.gif",HTML:"&nbsp;"}]},middleRow:{cells:[{width:150,valign:"top",align:"left",img:b.options.imgPath+"59/lt.gif"},{isCenterMiddle:true,paddingBottom:20},{width:120}]}},{id:60,name:Lang.get("appearancetemplates.lilies"),background:"#faf8e5",color:"#2c5000",textAlign:"left",fontFamily:"Trebuchet MS",topRow:{cells:[{width:"100%",height:1}]},bottomRow:{cells:[{width:"100%",height:1}]},middleRow:{cells:[{width:110,background:b.options.imgPath+"60/ls.gif",HTML:"&nbsp;"},{isCenterMiddle:true,paddingTop:35,paddingBottom:65},{width:216,valign:"bottom",align:"right",img:b.options.imgPath+"60/rbc.gif"}]}},{id:56,name:Lang.get("appearancetemplates.flowers_painting"),background:"#e6fbac",color:"#35010f",textAlign:"left",fontFamily:"Times New Roman",topRow:{cells:[{width:"100%",height:65,align:"left",img:b.options.imgPath+"56/ltc.gif"}],valign:"top"},bottomRow:{cells:[{width:"100%",height:60,align:"right",img:b.options.imgPath+"56/rbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:72,valign:"top",align:"left",img:b.options.imgPath+"56/lt.gif"},{isCenterMiddle:true},{width:86,valign:"bottom",align:"right",img:b.options.imgPath+"56/rb.gif"}]}},{id:54,name:Lang.get("appearancetemplates.roses"),background:"#dbf1f0",color:"#3a0c12",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{width:"100%",height:40,align:"left",img:b.options.imgPath+"54/ltc.gif"}],valign:"top"},bottomRow:{cells:[{width:"100%",height:151,align:"right",img:b.options.imgPath+"54/rbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:60},{isCenterMiddle:true},{width:189,valign:"bottom",align:"right",img:b.options.imgPath+"54/rb.gif"}]}},{id:22,name:Lang.get("appearancetemplates.flowers"),background:"#b1aa99",color:"#000000",fontFamily:"georgia",topRow:{cells:[{width:127,height:177,img:b.options.imgPath+"22/ltc.gif",align:"left",valign:"top"},{width:"100%"},{width:199,height:177,img:b.options.imgPath+"22/rtc.gif",align:"right",valign:"top"}]},bottomRow:{cells:[{height:50}]},middleRow:{cells:[{width:75,align:"left",valign:"top",img:b.options.imgPath+"22/lt.gif"},{isCenterMiddle:true},{width:5}]}}]},{id:6,title:Lang.get("appearancecategory.others"),items:[{id:11,name:Lang.get("appearancetemplates.city_lights"),background:"#373c4a",printColor:"#000",printBackground:"none",color:"#ffffff",topRow:{cells:[{height:1}]},bottomRow:{cells:[{width:"100%"},{width:388,height:188,align:"right",valign:"bottom",img:b.options.imgPath+"11/rbc.png",imgWidth:358,imgHeight:188}]},middleRow:{cells:[{width:25},{isCenterMiddle:true},{width:10}]}},{id:24,name:Lang.get("appearancetemplates.bow"),background:"#ffffff",color:"#000000",fontFamily:"georgia",topRow:{cells:[{width:173,height:78,align:"left",valign:"bottom",img:b.options.imgPath+"24/ltc.gif"}]},bottomRow:{cells:[{width:"100%"},{width:133,height:81,align:"right",valign:"top",img:b.options.imgPath+"24/rbc.gif"}]},middleRow:{cells:[{width:95,align:"left",valign:"top",img:b.options.imgPath+"24/lmc.gif"},{isCenterMiddle:true},{width:45,align:"right",valign:"bottom",img:b.options.imgPath+"24/rmc.gif"}]}},{id:58,name:Lang.get("appearancetemplates.camouflage"),background:"#505227",color:"#ffffff",textAlign:"left",fontFamily:"Times New Roman",topRow:{cells:[{width:"100%",height:65,align:"left",img:b.options.imgPath+"58/ltc.gif"}],valign:"top"},bottomRow:{cells:[{width:"100%",height:90,align:"right",img:b.options.imgPath+"58/rbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:126,valign:"top",align:"left",img:b.options.imgPath+"58/lt.gif"},{isCenterMiddle:true},{width:143,valign:"bottom",align:"right",img:b.options.imgPath+"58/rb.gif"}]}},{id:1,name:Lang.get("appearancetemplates.girl_with_house"),background:"#e6fbff",color:"#13363f",printColor:"#000",printBackground:"none",fontFamily:"arial",topRow:{cells:[{height:"40px"}]},bottomRow:{cells:[{width:170,height:163,align:"left",img:b.options.imgPath+"1/lbc.png",imgWidth:170,imgHeight:148},{width:"100%"},{width:235,height:163,align:"right",img:b.options.imgPath+"1/rbc.png",imgWidth:235,imgHeight:155}],valign:"bottom"},middleRow:{cells:[{width:85},{isCenterMiddle:true},{width:55}]}},{id:3,name:Lang.get("appearancetemplates.night"),background:"#1e4799",color:"#c8daff",topRow:{cells:[{width:422,height:67,align:"left",img:b.options.imgPath+"3/ltc.gif"}],valign:"top"},bottomRow:{cells:[{width:321,height:134,align:"left",img:b.options.imgPath+"3/lbc.gif",background:b.options.imgPath+"3/bs.gif"},{width:"100%",background:b.options.imgPath+"3/bs.gif"},{width:199,height:134,align:"right",img:b.options.imgPath+"3/rbc.gif",background:b.options.imgPath+"3/bs.gif"}],valign:"bottom"},middleRow:{cells:[{width:105,valign:"top",align:"left",img:b.options.imgPath+"3/lt.gif"},{isCenterMiddle:true},{width:110,valign:"bottom",align:"right",img:b.options.imgPath+"3/rb.gif"}]}},{id:5,name:Lang.get("appearancetemplates.scheme"),background:"#3b7951",color:"#d0ffd9",topRow:{cells:[{width:439,height:43,align:"left",valign:"top",img:b.options.imgPath+"5/ltc.gif"},{width:"100%"},{width:480,height:43,align:"left",valign:"top",img:b.options.imgPath+"5/rtc.gif"}],valign:"top"},bottomRow:{cells:[{width:85,height:96,align:"left",valign:"bottom",img:b.options.imgPath+"5/lbc.gif"},{width:"100%"},{width:74,height:89,align:"right",valign:"bottom",img:b.options.imgPath+"5/rbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:120,valign:"top",align:"left",img:b.options.imgPath+"5/lt.gif"},{isCenterMiddle:true},{width:45,valign:"top",align:"right",img:b.options.imgPath+"5/rt.gif"}]}},{id:8,name:Lang.get("appearancetemplates.game"),background:"#d3f8fe",color:"#252514",topRow:{cells:[{height:86,width:"100%",align:"center",valign:"top",img:b.options.imgPath+"8/tc.gif",background:b.options.imgPath+"8/ts.gif"}]},bottomRow:{cells:[{height:71,width:"100%",align:"center",valign:"bottom",img:b.options.imgPath+"8/bc.gif",background:b.options.imgPath+"8/bs.gif"}],valign:"bottom"},middleRow:{cells:[{width:50},{isCenterMiddle:true,paddingTop:10,paddingBottom:10},{width:50}]}},{id:15,name:Lang.get("appearancetemplates.sport"),background:"#000000",color:"#ffffff",fontFamily:"verdana",topRow:{cells:[{width:"100%",height:220,align:"left",valign:"top",img:b.options.imgPath+"15/ltc.gif",background:b.options.imgPath+"15/ts.gif"}]},bottomRow:{cells:[{height:35}]},middleRow:{cells:[{width:40},{isCenterMiddle:true,paddingTop:20},{width:45}]}},{id:21,name:Lang.get("appearancetemplates.stamps"),background:"#ffffff",color:"#000000",topRow:{cells:[{width:192,height:160,img:b.options.imgPath+"21/ltc.gif",align:"left",valign:"top"}]},bottomRow:{cells:[{height:70}]},middleRow:{cells:[{width:12},{isCenterMiddle:true},{width:110}]}},{id:27,name:Lang.get("appearancetemplates.blots"),background:"#ffffff",color:"#000000",topRow:{cells:[{width:109,height:51,align:"left",img:b.options.imgPath+"27/lt.gif"},{width:"100%"},{width:61,align:"right",img:b.options.imgPath+"27/rt.gif"}]},bottomRow:{cells:[{width:"100%",height:82,align:"left",valign:"bottom",img:b.options.imgPath+"27/lb.gif"}]},middleRow:{cells:[{width:109,align:"left",valign:"top",img:b.options.imgPath+"27/lm.gif"},{isCenterMiddle:true},{width:61,align:"right",valign:"top",img:b.options.imgPath+"27/rm.gif"}]}},{id:28,name:Lang.get("appearancetemplates.prehistoric"),background:"#c1bdb6",color:"#4e4037",fontFamily:"Comic Sans MS",topRow:{cells:[{width:476,height:177,align:"left",valign:"top",img:b.options.imgPath+"28/lt.gif"}]},bottomRow:{cells:[{width:"100%",height:80}]},middleRow:{cells:[{width:150},{isCenterMiddle:true},{width:120}]}},{id:29,name:Lang.get("appearancetemplates.hammer_and_sickle"),background:"#c00c0c",color:"#ffe55b",fontFamily:"courier",topRow:{cells:[{width:115,height:135,align:"left",valign:"middle",img:b.options.imgPath+"29/lt.gif"}]},bottomRow:{cells:[{width:"100%",height:80}]},middleRow:{cells:[{width:150},{isCenterMiddle:true},{width:120}]}},{id:33,name:Lang.get("appearancetemplates.book"),background:"#ddc182",color:"#411800",fontFamily:"georgia",topRow:{cells:[{width:"100%",height:111,align:"center",valign:"middle",img:b.options.imgPath+"33/mt_mb.gif"}]},bottomRow:{cells:[{width:"100%",height:111,align:"center",valign:"middle",img:b.options.imgPath+"33/mt_mb.gif"}]},middleRow:{cells:[{width:90},{isCenterMiddle:true},{width:70}]}},{id:35,name:Lang.get("appearancetemplates.manuscript"),background:"#ffffff",color:"#000000",fontFamily:"arial",topRow:{cells:[{width:"100%"},{width:611,height:90,align:"right",valign:"top",img:b.options.imgPath+"35/rt.gif"}]},bottomRow:{cells:[{width:"100%",height:75,align:"left",valign:"bottom",img:b.options.imgPath+"35/lb.gif"}]},middleRow:{cells:[{width:75},{isCenterMiddle:true},{width:60}]}},{id:36,name:Lang.get("appearancetemplates.exercise_book"),background:"#ffffff",color:"#000000",fontFamily:"times new roman",topRow:{cells:[{width:"100%"},{width:611,height:90,align:"right",valign:"top",img:b.options.imgPath+"36/rt.gif"}]},bottomRow:{cells:[{width:"100%",height:75,align:"left",valign:"bottom",img:b.options.imgPath+"36/lb.gif"}]},middleRow:{cells:[{width:75},{isCenterMiddle:true},{width:60}]}},{id:37,name:Lang.get("appearancetemplates.greek_style"),background:"#faf4cb",color:"#102501",fontFamily:"palatino linotype",fontStyle:"italic",topRow:{cells:[{width:"100%"},{width:241,height:156,align:"right",valign:"top",img:b.options.imgPath+"37/rt.gif"}]},bottomRow:{cells:[{width:"100%",background:b.options.imgPath+"37/bbg.gif"},{width:283,height:93,align:"right",valign:"bottom",img:b.options.imgPath+"37/rb.gif"}]},middleRow:{cells:[{width:130},{isCenterMiddle:true},{width:118,align:"right",valign:"top",background:b.options.imgPath+"37/rbg.gif"}]}},{id:38,name:Lang.get("appearancetemplates.labirynth"),background:"#f6e5c3",color:"#4e3509",textAlign:"center",fontFamily:"CenturyGothic",topRow:{cells:[{width:"100%",height:70}]},bottomRow:{cells:[{width:"100%",height:113,align:"left",valign:"bottom",background:"#f9ebcd",img:b.options.imgPath+"38/lb.gif"}]},middleRow:{cells:[{width:100},{isCenterMiddle:true},{width:100}]}}]},{id:5,title:Lang.get("appearancecategory.wintry"),items:[{id:44,name:Lang.get("appearancetemplates.grandfather"),background:"#a7c5ff",color:"#330066",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{width:286,height:110,align:"left",img:b.options.imgPath+"44/ltc.jpg"},{width:"100%",align:"right",img:b.options.imgPath+"44/rtc.jpg"}],valign:"top"},bottomRow:{cells:[{width:286,height:56,align:"left",img:b.options.imgPath+"44/lbc.jpg"},{width:"100%",align:"left",img:b.options.imgPath+"44/bc.jpg",background:b.options.imgPath+"44/bcbg.jpg"},{width:59,align:"center",img:b.options.imgPath+"44/rbc.jpg"}],valign:"bottom"},middleRow:{cells:[{width:286,valign:"bottom",align:"left",img:b.options.imgPath+"44/lc.jpg"},{isCenterMiddle:true},{width:40}]}},{id:43,name:Lang.get("appearancetemplates.christmas_toys"),background:"#00468c",color:"#ffffff",textAlign:"left",fontFamily:"Tahoma",topRow:{cells:[{width:279,height:72,align:"left",valign:"top",img:b.options.imgPath+"43/ltc.jpg"},{width:"100%",height:72,align:"right",img:b.options.imgPath+"43/rtc.jpg"}],valign:"top"},bottomRow:{cells:[{width:105,height:45,align:"left",img:b.options.imgPath+"43/lbc.jpg"},{width:"100%",height:45,align:"center",img:b.options.imgPath+"43/bc.jpg"}],valign:"bottom"},middleRow:{cells:[{width:105,valign:"bottom",align:"left",img:b.options.imgPath+"43/lc.jpg"},{isCenterMiddle:true},{width:115,valign:"top",align:"right",img:b.options.imgPath+"43/rc.jpg"}]}},{id:46,name:Lang.get("appearancetemplates.winter"),background:"#54abe0",color:"#ffffff",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{width:94,height:63,align:"left",img:b.options.imgPath+"46/ltc.gif"},{width:"100%",background:b.options.imgPath+"46/tcbg.gif"},{width:110,align:"right",img:b.options.imgPath+"46/rtc.gif"}]},bottomRow:{cells:[{height:"30px"}]},middleRow:{cells:[{width:94,valign:"top",align:"left",img:b.options.imgPath+"46/lc.gif"},{isCenterMiddle:true},{width:110,valign:"top",align:"right",img:b.options.imgPath+"46/rc.gif"}]}},{id:47,name:Lang.get("appearancetemplates.panorama"),background:"#f6fcff",color:"#4b6e88",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{width:110,height:54,align:"left",img:b.options.imgPath+"47/ltc.gif"},{width:"100%",align:"center",valign:"top",img:b.options.imgPath+"47/tc.gif"}]},bottomRow:{cells:[{width:118,height:89,align:"left",img:b.options.imgPath+"47/lbc.gif"},{width:"100%",background:b.options.imgPath+"47/bcbg.gif"},{width:478,align:"right",img:b.options.imgPath+"47/rbc.gif"}],valign:"bottom"},middleRow:{cells:[{width:60},{isCenterMiddle:true},{width:50}]}},{id:48,name:Lang.get("appearancetemplates.balls"),background:"#ffaa00",color:"#000000",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{width:"100%",height:51,align:"right",img:b.options.imgPath+"48/rtc.gif"}]},bottomRow:{cells:[{width:50}]},middleRow:{cells:[{width:30},{isCenterMiddle:true},{width:130,align:"right",valign:"top",img:b.options.imgPath+"48/rc.gif"}]}},{id:45,name:Lang.get("appearancetemplates.snowflakes"),background:"#84cff0",color:"#ffffff",textAlign:"left",fontFamily:"Arial",topRow:{cells:[{height:30}]},bottomRow:{cells:[{width:164,height:66,align:"left",img:b.options.imgPath+"45/lbc.jpg"},{width:"100%",align:"left",img:b.options.imgPath+"45/bc.jpg"}],valign:"bottom"},middleRow:{cells:[{width:164,valign:"bottom",align:"left",img:b.options.imgPath+"45/lc.jpg"},{isCenterMiddle:true},{width:40}]}}]}]}},getTemplates:function(){return patron.lang["compose_appearance"]}})});define("patron.compose/patron.Compose.AppearanceChanger",["jquery","ajs/pkg"],function($,a){jsClass.create("patron.Compose.AppearanceChanger").methods({__construct:function(a){var b=this;$.extend(b,a);b.heightOffset=0},unactive:function(){},clear:function(){var a=this;a.setTemplate({})},setTemplate:function(a){var b=this;b._clearRows();if(/\.(gif|jpg|png|bmp)$/i.test(a.background)){b.$mainTable.attr("background",a.background)}else if(a.background){b.$mainTable.attr("bgColor",a.background)}else{b.$mainTable.attr({background:"",bgColor:""})}b._appendRows(a)},getHeightOffset:function(){var a=this;return a.heightOffset},getWidthOffset:function(){var a=this;var b=0;a.$middleRow.children().each($.proxy(function(a,c){if(c!=this.$mainCellHolder[0])b+=c.offsetWidth},a));return b},_clearRows:function(){var a=this;a.$mainCellHolder.removeAttr("height");a.$paddingTopCell.attr("height",1);a.$paddingBottomCell.attr("height",1);a.heightOffset=0;$.each([a.$topRow,a.$bottomRow,a.$middleRow],$.proxy(function(a,b){$(b).children().each($.proxy(function(a,b){var c=$(b);if(c[0]!=this.$mainCellHolder[0])c.remove()},this))},a))},_appendRows:function(a){var b=this;var c=[b.$topRow,b.$bottomRow,b.$middleRow],d=[];if(a.topRow)d.push(a.topRow);if(a.bottomRow)d.push(a.bottomRow);if(a.middleRow)d.push(a.middleRow);var e=1;if(a.middleRow){$.each(a.middleRow.cells,function(a,b){if(b.isCenterMiddle)e=a})}$.each(d,$.proxy(function(a,b){var d=this;var f=c[a];if(b.align)f.attr("align",b.align).css("textAlign",b.align);if(b.valign)f.attr("vAlign",b.valign).css("verticalAlign",b.valign);if(b.background)f.attr("bgColor",b.background);$.each(b.cells,$.proxy(function(a,b){var c=this;var d=$("<td/>").addClass("cell");if(b.width)d.attr("width",b.width);if(b.height)d.attr("height",b.height);if(b.align)d.attr("align",b.align).css("textAlign",b.align);if(b.valign)d.attr("vAlign",b.valign).css("verticalAlign",b.valign);if(/\.(gif|jpg|png|bmp)$/.test(b.background)){d.attr("background",b.background)}else if(b.background){d.attr("bgColor",b.background)}if(b.img){var g=$('<img title="" alt=""/>').attr("src",b.img);if($.browser.msie&&parseInt($.browser.version)<7){if(/\.png($|\?)/i.test(b.img)){g.attr("src",patron.CssStaticUrl+"/0.gif");g[0].style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+b.img+"',sizingMethod='scale')"}}if(/\.png($|\?)/i.test(b.img))g.addClass("png");if(b.imgWidth)g.attr("width",b.imgWidth);if(b.imgHeight)g.attr("height",b.imgHeight);if(b.imgPrintVisible)g.addClass("visible-"+b.imgPrintVisible);if(b.align)g.attr("align",b.align).css("textAlign",b.align);d.append(g)}if(b.HTML)d.html(b.HTML);if(f[0]==c.$middleRow[0]&&b.isCenterMiddle){if(b.paddingTop)c.$paddingTopCell.attr("height",b.paddingTop);if(b.paddingBottom)c.$paddingBottomCell.attr("height",b.paddingBottom)}if(!b.isCenterMiddle){if(f[0]==c.$middleRow[0]&&a<e){d.insertBefore(c.$mainCellHolder)}else{f.append(d)}}},d));if(f[0]!=d.$middleRow[0])d.heightOffset+=f[0].offsetHeight},b))}})});define("patron.compose/patron.Compose.Appearance",["jquery","ajs/pkg","plugins/jQueryEvent","patron.compose/patron.Compose.AppearanceTemplates","patron.compose/patron.Compose.AppearanceChanger"],function($,a){var b=$(window);jsClass.create("patron.Compose.Appearance").extend(jQueryEvent).statics({defaultOptions:{templateClassPrefix:"mlruTmpId",templates:[]}}).methods({__construct:function(a,b){var c=this;c.options=$.extend({},patron.Compose.Appearance.defaultOptions,b);var d=c.options.domIDs;c.$frame=$(a);c.$container=$(d.composeTemplatesContainer);c.$prev=$(".prev",c.$container);c.$next=$(".next",c.$container);c.$listFrame=$(".listFrame",c.$container);c.$list=$(".list",c.$container).bind("click",$.proxy(c._listClick,c)).bind("DOMMouseScroll mousewheel",$.proxy(c._listMouseWheel,c));c.$topRow=$(d.topRow_sht);c.$bottomRow=$(d.bottomRow_sht);c.$middleRow=$(d.middleRow_sht);c.$middleTable=$(d.middleTable);c.$mainTable=$(d.shell__text);c.$mainCell=$(d.shell__text_cell);c.$mainCellHolder=$(d.shell__text_cell_holder);c.$paddingTopCell=$(d.paddingTop_sht);c.$paddingBottomCell=$(d.paddingBottom_sht);c.templateMap={};c.themesMap={};c.layerVisible=false;c.listFrameHeight=0;c._initList();c.$prev.add(c.$next).bind("mousedown",$.proxy(c._controlMouseDown,c)).bind("click",$.proxy(c._controlClick,c));c.changer=new patron.Compose.AppearanceChanger({$topRow:c.$topRow,$bottomRow:c.$bottomRow,$middleRow:c.$middleRow,$mainTable:c.$mainTable,$mainCell:c.$mainCell,$mainCellHolder:c.$mainCellHolder,$paddingTopCell:c.$paddingTopCell,$paddingBottomCell:c.$paddingBottomCell})},unactive:function(){},reset:function(){var a=this;a.clear();a.hideLayer()},_listMouseWheel:function(a){var b=this;var c=0;if(a.wheelDelta)c=a.wheelDelta/120;if(a.detail)c=-a.detail/3;b._mouseWheelSlide(c<0);a.preventDefault()},_listClick:function(c){var d=this;var e=$(c.target);if(e.is("a")){var f=e.data("id");if(!f){f=a.$onClick(c.target);e.data("id",f)}b.triggerHandler("editorToolbarButtonStyleChangeClick.compose");d.setTemplate(f)}c.preventDefault()},_controlClick:function(a){a.preventDefault()},_controlMouseUp:function(a){var b=this;b.$list.stop();b._updateControlsClasses();b.$prev.removeClass("prev-down");b.$next.removeClass("next-down");$(document).unbind("mouseup",arguments.callee)},_controlMouseDown:function(a){var b=this;var c=$(a.target);c.addClass(c.is(".prev")?"prev-down":"next-down");b.$prev.removeClass("prev-disabled");b.$next.removeClass("next-disabled");b._slide(c.is(".next"));$(document).mouseup($.proxy(b._controlMouseUp,b))},_slide:function(a){var b=this;var c=5e3;var d=b.getListHeight();var e=b.getListFrameHeight();if(d>e){var f=b.getListOffsetY();var g=(d+e)/c;var h=d-(a?e-f:f+d);var i=h/g;b.$list.stop().animate({top:a?e-d:0},i,"linear",$.proxy(b._updateControlsClasses,b))}},_mouseWheelSlide:function(a){var b=this;var c=100;var d=b.getListHeight();var e=b.getListFrameHeight();if(d>e){var f=b.getListOffsetY();var g=e-d;var h=0;b.$list.stop().animate({top:a?Math.max(g,f-e):Math.min(h,f+e)},c,$.proxy(b._updateControlsClasses,b))}},_updateControlsClasses:function(){var a=this;var b=a.getListHeight();var c=a.getListFrameHeight();var d=a.getListOffsetY();a.$prev.toggleClass("prev-disabled",d>=0);a.$next.toggleClass("next-disabled",d<=c-b)},_initList:function(){$.each(this.getTemplates().categories,$.proxy(function(a,b){$.each(b.items,$.proxy(function(a,c){this.templateMap[c.id]=c;if(!this.themesMap[b.id]){this.themesMap[b.id]=[]}this.themesMap[b.id].push(c)},this))},this))},getMiddleTable:function(){var a=this;return a.$middleTable},getMiddleRow:function(){var a=this;return a.middleRow},getMainCell:function(){var a=this;return a.$mainCell},getMainCellHolder:function(){var a=this;return a.$mainCellHolder},getMainTable:function(){var a=this;return a.$mainTable},getHTML:function(a){var b=this;var c=b.getCurrentTemplate();if(c){var d='<font size="2" face="'+(c.fontFamily||"")+'" color="'+(c.color||"")+'">'+a+"</font>";var e=b.$frame.clone();var f=$("#"+b.$mainCell.attr("id"),e);var g=$("#"+b.$mainCellHolder.attr("id"),e);f.attr("align",c.textAlign||"").html(d);g.removeAttr("height");return e.html()}return a},getTemplateId:function(a){var b=this;var c=0;var d=$("<div>"+a+"</div>");var e=$(b.options.domIDs.main_html_cell,d);if(e.length){c=e.attr("template_id")}else{var f=$("#"+b.$mainTable.attr("id"),d);if(f.length){var g=new RegExp(b.options.templateClassPrefix+"(\\d+)");var h=f[0].className;if(g.test(h))c=h.match(g)[1]}}return c},removeTemplate:function(a){var b=this;var c=$("<div>"+a+"</div>");var d=$("#"+b.$mainTable.attr("id"),c);if(d.length){var e=$(b.options.domIDs.main_html_cell+" > font:first, #"+b.$mainCell.attr("id")+" > font:first",d);if(e.length)d.replaceWith(e.html())}return c.html()},setListFrameHeight:function(a){var b=this;b.listFrameHeight=a;if(b.isLayerVisible()){var c=b.getListHeight();var d=b.getListOffsetY();b.$listFrame.css("height",a);if(a-d-c>0)b.$list.css("top",a-c);b._updateControlsClasses()}},applyTheme:function(a){var b=this;var c="";c+='<a href="javascript:void(0);" title="'+Lang.get("compose.appearance_without_style")+'" class="empty" onclick="return 0;">'+Lang.get("compose.appearance_without_style")+"</a>";$.each(b.getTemplatesByThemeId(a),$.proxy(function(a,b){if(!b.disabled)c+='<a href="javascript:void(0);" title="'+b.name+'" onclick="return '+b.id+';" style="background-position: '+-68*(b.id-1)+'px 0;"></a>'},b));b.$list.css("top",0).html(c);b._updateControlsClasses()},showLayer:function(){var a=this;a.layerVisible=true;a.$container.show();a.setListFrameHeight(a.getListFrameHeight());a.triggerHandler("showLayer")},hideLayer:function(){var a=this;a.layerVisible=false;a.$container.hide();a.triggerHandler("hideLayer")},isLayerVisible:function(){var a=this;return a.layerVisible},getTemplates:function(){return patron.Compose.AppearanceTemplates.getInstance().getTemplates()},getTemplatesByThemeId:function(a){var b=this;return b.themesMap[a]||b.getTemplates()},getTemplateById:function(a){var b=this;return b.templateMap[a]},getCurrentTemplate:function(){var a=this;return a.currentTemplate},getHeightOffset:function(){var a=this;return a.getCurrentTemplate()?a.changer.getHeightOffset():0},getListOffsetY:function(){var a=this;return parseInt(a.$list.css("top"))},getListHeight:function(){var a=this;return a.$list.height()},getListFrameHeight:function(){var a=this;return a.listFrameHeight},getWidthOffset:function(){var a=this;return a.getCurrentTemplate()?a.changer.getWidthOffset():0},getMainCellHeight:function(){var a=this;return a.changer.getMainCellHeight()},setTemplate:function(a){var b=this;var c=b.getTemplateById(a);if(c){b.$mainTable[0].className=b.options.templateClassPrefix+a;b.changer.setTemplate(c);b.currentTemplate=c;b.triggerHandler("changeTemplate",[c])}else{b.clear()}},clear:function(){var a=this;a.$mainTable[0].className=a.options.templateClassPrefix+"0";a.currentTemplate=null;a.changer.clear();a.triggerHandler("clear")}})});define("patron.compose/patron.Compose.DecorationSlider",["jquery","plugins/jQueryEvent"],function(){jsClass.create("patron.Compose.DecorationSlider").extend(jQueryEvent).statics({defaultOptions:{}}).methods({__construct:function(a,b){this.options=$.extend({},patron.Compose.DecorationSlider.defaultOptions,b);this.$document=$(document);this.$container=$(a);this.itemClickObserver=this._itemClick.bind(this);this.controlMouseDownObserver=this._controlMouseDown.bind(this);this.controlMouseUpObserver=this._controlMouseUp.bind(this);this.controlClickObserver=this._controlClick.bind(this);this.listMouseWheelObserver=this._listMouseWheel.bind(this)},initialize:function(){this.$inner=$(".js-inner",this.$container);this.$list=$(".js-list",this.$container);this.$prev=$(".js-prev",this.$container);this.$next=$(".js-next",this.$container);this.$list.delegate(".js-clear","click",this.controlClickObserver);this.$list.delegate(".js-item","click",this.itemClickObserver);this.$container.bind("DOMMouseScroll mousewheel",this.listMouseWheelObserver);this.$container.delegate(".js-prev,.js-next","mousedown mouseenter",this.controlMouseDownObserver)},show:function(){},hide:function(){},setCategory:function(a){var b=0,c=$(".js-category:eq("+a+")",this.$list);if(a>0){b=-c[0].offsetTop}this.$list.css("top",b);this._slideEnd()},getListHeight:function(){return this.$list.height()},getWrapHeight:function(){return this.$inner.height()},getListOffset:function(){return parseInt(this.$list.css("top"))||0},_itemClick:function(a){var b=$(a.target).closest(".js-item",this.$list);this.triggerHandler("select",[b.data("category"),b.data("item")]);a.preventDefault()},_controlMouseDown:function(a){var b=$(a.target).closest(".js-control",this.$inner),c=b.hasClass("js-prev");if(c){this._slide(false)}else{this._slide(true)}this.$document.bind("mouseup",this.controlMouseUpObserver);this.$container.delegate(".js-prev,.js-next","mouseleave",this.controlMouseUpObserver);if(this.options.slider&&this.options.slider.counters){if(c){$.event.trigger("ui-abstract-action",{chain:this.options.slider.counters.prev})}else{$.event.trigger("ui-abstract-action",{chain:this.options.slider.counters.next})}}},_controlClick:function(a){var b=$(a.target).closest(".js-control",this.$list);if(b.hasClass("js-clear")){this.triggerHandler("clear")}},_controlMouseUp:function(a){this.$list.stop();this.$document.unbind("mouseup",this.controlMouseUpObserver);this.$container.undelegate(".js-prev,.js-next","mouseleave",this.controlMouseUpObserver)},_slide:function(a){var b=2;var c=this.getListHeight();var d=this.getWrapHeight();var e=c-d;var f=this.getListOffset();var g=-f,h=0;if(a){g=e+f;h=-e}b=b*e;var i=100-100/e*g;var j=b-i*b/100;if(c>d){if(f!=h){this.$list.stop().animate({top:h},{duration:j,easing:"linear",complete:this._slideEnd.bind(this),step:this._slideEnd.bind(this)})}}},_listMouseWheel:function(a){var b=0;if(a.wheelDelta||a.originalEvent.wheelDelta)b=(a.wheelDelta||a.originalEvent.wheelDelta)/120;if(a.detail||a.originalEvent.detail)b=-(a.detail||a.originalEvent.detail)/3;if(!b&&a.deltaY)b=a.deltaY;var c=this.getListHeight();var d=this.getWrapHeight();var e=this.getListOffset();var f=Math.min(0,Math.max(e+b*100,d-c));if(c>d){if(e!=f){this.$list.stop().css("top",f);a.preventDefault()}}this._slideEnd()},_slideEnd:function(){var a=this.getListOffset();var b=this.getListHeight();var c=this.getWrapHeight();this.$prev.css("opacity",+(a<0));this.$next.css("opacity",+(a>c-b))}})});define("patron.compose/patron.Compose.DecorationAppearance",["ajs/pkg","jquery","plugins/jQueryEvent","patron.compose/patron.Compose.DecorationSlider"],function(a,$){jsClass.create("patron.Compose.DecorationAppearance").extend(jQueryEvent).statics({defaultOptions:{baseSrc:"https:"+patron.CssStaticUrl+"/r/default/compose/"+(patron.ComposeCardsNew?"appearance_v2":"appearance"),templateId:"#compose__decoration_ejs"}}).methods({__construct:function(b,c){this.options=$.extend({},patron.Compose.DecorationAppearance.defaultOptions,c);this.$container=$(".js-decoration_appearance",b);this.slider=new patron.Compose.DecorationSlider(this.$container,c);this.slider.bind({clear:function(a){this.triggerHandler("clear")}.bind(this),select:function(a,b,c){this.selectedItem=this.data.categories[b].items[c];this.triggerHandler("select",[this.data.categories[b],this.selectedItem])}.bind(this)});this.cardContainerId=a.uniqId()+a.getRandomHash(10,false,true,false);this.cardMarkerId=a.uniqId()+a.getRandomHash(10,false,true,false);this.cardId=a.uniqId()+a.getRandomHash(10,false,true,false)},_initialize:function(){this.data=patron.lang["compose_appearance"];$.each(this.data.categories,function(a,b){$.each(b.items,function(a,b){b.preview=b.id+".png"}.bind(this));b.path=this.options.baseSrc}.bind(this));this.$container.tpl(this.options.templateId,{type:"appearance",Categories:this.data.categories});this.slider.initialize()},setCategory:function(a){this.slider.setCategory(a)},show:function(){if(this.visible)return;if(!this.initialized){this._initialize();this.initialized=1}this.$container.show();this.slider.show();this.visible=1;this.triggerHandler("show")},hide:function(){if(!this.visible)return;this.$container.hide();this.slider.hide();this.visible=0;this.triggerHandler("hide")},setItem:function(a){var b=this.data.categories,c,d,e;Array.some(b,function(b,f){c=b;d=f;return Array.some(b.items,function(b){if(b.id==a){e=b;return true}return false})});if(e){this.selectedItem=e;this.setCategory(d);this.triggerHandler("select",[c,e]);$.event.trigger("ui-abstract-action",{chain:["compose","appearance","set",a]})}}})});define("patron.compose/patron.Compose.DecorationCards",["ajs/pkg","jquery","plugins/jQueryEvent","patron.compose/patron.Compose.DecorationSlider"],function(a,$){jsClass.create("patron.Compose.DecorationCards").extend(jQueryEvent).statics({defaultOptions:{baseSrc:"https:"+patron.CssStaticUrl+"/r/default/compose/"+(patron.ComposeCardsNew?"cards_v4":"cards_v3"),templateId:"#compose__decoration_ejs",previewTemplateId:"#compose__card__template_ejs",slider:{counters:{next:["compose","card","slide_next"],prev:["compose","card","slide_prev"]}}}}).methods({__construct:function(b,c){this.options=$.extend({},patron.Compose.DecorationCards.defaultOptions,c);this.$container=$(".js-decoration_cards",b);this.slider=new patron.Compose.DecorationSlider(this.$container,this.options);this.slider.bind({clear:function(a){this.triggerHandler("clear")}.bind(this),select:function(a,b,c){this.selectedItem=this.data.categories[b].items[c];this.triggerHandler("select",[this.data.categories[b],this.selectedItem])}.bind(this)});this.cardContainerId=a.uniqId()+a.getRandomHash(10,false,true,false);this.cardMarkerId=a.uniqId()+a.getRandomHash(10,false,true,false);this.cardId=a.uniqId()+a.getRandomHash(10,false,true,false)},_initialize:function(){this.data=patron.lang["compose_cards"];$.each(this.data.categories,function(a,b){b.path=this.options.baseSrc+"/"+b.id}.bind(this));this.$container.tpl(this.options.templateId,{type:"cards",Categories:this.data.categories});this.slider.initialize()},setCategory:function(a){this.slider.setCategory(a)},show:function(){if(this.visible)return;if(!this.initialized){this._initialize();this.initialized=1}this.$container.show();this.slider.show();this.visible=1;this.triggerHandler("show")},hide:function(){if(!this.visible)return;this.$container.hide();this.slider.hide();this.visible=0;this.triggerHandler("hide")},getPreviewHTML:function(a,b){var c=Math.rand(0,a.cardTitles.length-1);var d=a.cardTitles[c];return $.tpl(this.options.previewTemplateId,{imgTitle:d,imgWidth:b.img.width,imgHeight:b.img.height,imgSrc:this.options.baseSrc+"/"+a.id+"/"+b.img.src,cardContainerId:this.cardContainerId,cardId:this.cardId,markerId:this.cardMarkerId})},setItem:function(a){var b=this.data.categories,c,d,e;Array.some(b,function(b,f){c=b;d=f;return Array.some(b.items,function(b){if(b.id==a){e=b;return true}return false})});if(e){this.selectedItem=e;this.setCategory(d);this.triggerHandler("select",[c,e]);$.event.trigger("ui-abstract-action",{chain:["compose","card","set",a]})}}})});define("patron.compose/patron.Compose.Decoration",["jquery","plugins/jQueryEvent","patron.compose/patron.Compose.DecorationAppearance","patron.compose/patron.Compose.DecorationCards"],function(){jsClass.create("patron.Compose.Decoration").extend(jQueryEvent).statics({defaultOptions:{}}).methods({__construct:function(a,b){this.options=$.extend({},patron.Compose.Decoration.defaultOptions,b);this.$container=$(".js-decoration",a);this.controlClickObserver=this._controlClick.bind(this);this.$container.delegate(".js-decoration_control_hide","click",this.controlClickObserver);this.items={cards:new patron.Compose.DecorationCards(this.$container,this.options),appearance:new patron.Compose.DecorationAppearance(this.$container,this.options)}},show:function(a,b,c){$.each(this.items,function(a,b){b.hide()});if(this.visible){this.items[a].show();this.items[a].setCategory(b);if(c){this.items[a].setItem(c)}}else{this.$container.show();this.items[a].show();this.items[a].setCategory(b);if(c){this.items[a].setItem(c)}this.visible=1;this.triggerHandler("show")}},hide:function(){if(!this.visible)return;this.$container.hide();this.visible=0;this.triggerHandler("hide")},setHeight:function(a){this.$container.css("height",a)},getItem:function(a){return this.items[a]},_controlClick:function(a){var b=$(a.target).closest(".js-decoration_control",this.$inner);if(b.hasClass("js-decoration_control_hide")){this.hide()}}})});define("patron.compose/patron.Compose.Cards",["ajs/pkg","jquery","plugins/jQueryEvent"],function(a,$){jsClass.create("patron.Compose.Cards").extend(jQueryEvent).statics({defaultOptions:{cardBaseSrc:"https:"+patron.CssStaticUrl+"/r/default/compose/cards_v2",templateId:"#compose__cards_ejs",previewTemplateId:"#compose__card__template_ejs",selectedItemClass:"compose__cards__slider__item_selected",easing:"swing",speed:500,itemGeometry:{width:68,height:68}}}).methods({__construct:function(b,c){this.options=$.extend({},patron.Compose.Cards.defaultOptions,c);this.data=patron.lang["compose_cards"];this.$container=$(".js-cards",b);this.cardContainerId=a.uniqId()+a.getRandomHash(10,false,true,false);this.cardMarkerId=a.uniqId()+a.getRandomHash(10,false,true,false);this.cardId=a.uniqId()+a.getRandomHash(10,false,true,false);this.categoryClickObserver=this._categoryClick.bind(this);this.cardClickObserver=this._cardClick.bind(this);this.controlClickObserver=this._controlClick.bind(this);this.$container.delegate(".js-category","click",this.categoryClickObserver);this.$container.delegate(".js-card","click",this.cardClickObserver);this.$container.delegate(".js-prev,.js-next,.js-hide","click",this.controlClickObserver);this.$container.delegate(".js-card,.js-prev,.js-next,.js-hide","mousedown",a.retFalse);this.selectedCategoryIndex=0;this.selectedCardIndex=-1;this.itemCount=0;this.offset=0},show:function(){if(this.visible)return;if(!this.drawed){this._redraw();this.drawed=1}this.$container.show();this._update();this.visible=1;this.triggerHandler("show")},hide:function(){if(!this.visible)return;this.$container.hide();this.visible=0;this.triggerHandler("hide")},redraw:function(){this.cardContainerId=a.uniqId()+a.getRandomHash(10,false,true,false);this.cardMarkerId=a.uniqId()+a.getRandomHash(10,false,true,false);this.cardId=a.uniqId()+a.getRandomHash(10,false,true,false)},reset:function(){this.hide()},setSlide:function(a,b){var c=0,d=this.cards.length-this.itemCount;if(this.cards.length>this.itemCount){this.$prev.toggle(a>c);this.$next.toggle(a<d)}else{this.$prev.add(this.$next).hide()}if(this.cards.length>this.itemCount){this.offset=a=Math.min(d,Math.max(a,c));var e=-(a*this.options.itemGeometry.width);if(b){this.$list.animate({left:e},this.options.speed,this.options.easing)}else{this.$list.css("left",e)}}},setSelected:function(a){this.selectedCard=this.cards[a];this.selectedCardIndex=a;if(this.$previosSelected){this.$previosSelected.removeClass(this.options.selectedItemClass)}this.$previosSelected=this.$list.find(".js-card:eq("+a+")").addClass(this.options.selectedItemClass)},resize:function(){if(this.visible){this._update()}},getPreviewHTML:function(a,b){var c=Math.rand(0,a.cardTitles.length-1);var d=a.cardTitles[c];return $.tpl(this.options.previewTemplateId,{imgTitle:d,imgWidth:b.img.width,imgHeight:b.img.height,imgSrc:this.options.cardBaseSrc+"/"+a.id+"/"+b.img.src+"?4",cardContainerId:this.cardContainerId,cardId:this.cardId,markerId:this.cardMarkerId})},_redraw:function(){var a=this.data.categories[this.selectedCategoryIndex];this.categories=this.data.categories;this.cards=a.items;this.$container.tpl(this.options.templateId,{Categories:this.categories,Cards:this.cards,SelectedCategoryIndex:this.selectedCategoryIndex,SelectedCardIndex:this.selectedCardIndex,CardPreviewBaseUrl:this.options.cardBaseSrc+"/"+a.id});this.$prev=$(".js-prev",this.$container);this.$next=$(".js-next",this.$container);this.$inner=$(".js-inner",this.$container);this.$list=$(".js-list",this.$container)},_update:function(){this.itemCount=Math.floor(this.$inner.css("width","").width()/this.options.itemGeometry.width);this.$inner.css("width",this.options.itemGeometry.width*this.itemCount);this.setSlide(this.selectedCardIndex)},_categoryClick:function(a){var b=$(a.currentTarget);var c=b.index();if(c!=this.selectedCategoryIndex){this.selectedCategoryIndex=c;this.setSlide(0);this.setSelected(-1);this._redraw();this._update()}a.preventDefault()},_cardClick:function(a){var b=$(a.currentTarget);var c=b.index();if(c!=this.selectedCardIndex&&this.cards[c]){this.setSelected(c)}this.triggerHandler("click",[this.categories[this.selectedCategoryIndex],this.cards[this.selectedCardIndex]]);a.preventDefault()},_controlClick:function(a){var b=$(a.currentTarget);if(b.hasClass("js-hide")){this.hide()}else if(b.hasClass("js-prev")){this.setSlide(this.offset-this.itemCount+1,true)}else{this.setSlide(this.offset+this.itemCount-1,true)}a.preventDefault()}})});define("patron.compose/patron.Compose.Templates",["ajs/pkg","patron/patron.API","patron.compose/patron.Compose.Utils","patron/patron.Messages","patron.v2/models/Message","features"],function(a,b,c,d,e,f){(function($){jsClass.create("patron.Compose.Templates").statics({defaultOptions:{templatesFolderId:500006,maxMessages:25}}).methods({__construct:function(a,b){this.opts=Object.extend({},patron.Compose.Templates.defaultOptions,b);this.form=a;this.templates=[];this.templatesLoaded=false;this.isCreatingTemplateMode=false;this.hasAppliedTemplate=false;this.prevTemplate=null;this.checkboxesPrevValue=null},reset:function(){this.isCreatingTemplateMode=false;this.hasAppliedTemplate=false;this.setActiveTemplate(null);this.templatesLoaded=false;this.templates=[];this.prevTemplate=null;this.checkboxesPrevValue=null},getTemplates:function(c){if(!this.templatesLoaded){b({url:"messages/status",data:{folder:this.opts.templatesFolderId,limit:this.opts.maxMessages,force:1,cts:a.now(),now:a.now(),last_modified:a.now()},complete:this._onLoadTemplates.bind(this,c)});return false}return this.templates},updateTemplate:function(b){var c,d;$.each(this.templates,function(a,b){if(b&&b.selected){c=b;return false}});if(!c){c={selected:true};this.templates.unshift(c)}d=this.form.$form.toObject();c.id=b;c.subject=d["Subject"];c.attaches=c.attaches||[];var e=c.attaches?c.attaches.length:0;if(this.form.fileUploader.uploaderHTML5._count!=e){c.bodyLoaded=false}else{c.bodyLoaded=true;c.body=this.form.getContent();c.bodyPlain=this.form.getEditor()&&this.form.getEditor().getContent({format:"text"});c.snippet=a.HTML.escape(c.bodyPlain.substr(0,150).replace(/(\n|<br>)+/g," "));Array.forEach(["To","CC","BCC","Priority","Receipt","remind"],function(a){c[a]=d[a];c[a]=d[a]})}},setTemplate:function(a,b){var c;this.setActiveTemplate(a);c=this.getActiveTemplate();if(!c){if(b){this.isCreatingTemplateMode=true;$(document).one("compose-form-redraw",function(){this.form._removeAutoSaveInterval();this.form.updateCurrentFormData()}.bind(this))}else{this.form.parentView.load("templates")}}else{this.count("set");this.isCreatingTemplateMode=false;this._showTemplatesButton();this.form._setEnableSaveInterval();if(c.bodyLoaded){this._setTemplateContent(c)}else{this.form.disableEdit();d.find({id:c.id}).done(this._onLoadTemplate.bind(this,c))}}},setActiveTemplate:function(a,b){function c(){Array.forEach(this.templates,function(c){if(c){c.selected=a&&c.id==a;if(c.selected&&b!==undefined){var d=this.form._formElm("draft_msg");if(d.val()==a){d.val("");this.form.options.isNewMessage=1;this.form.options.initialMessageText=true}if(b){this.isCreatingTemplateMode=true;this._showTemplatesButton();this.form._removeAutoSaveInterval();this.form.updateCurrentFormData()}}}}.bind(this))}if(!this.templatesLoaded&&a){this.getTemplates(c.bind(this))}else{c.call(this)}},getActiveTemplate:function(){var a;Array.forEach([].concat(this.templates),function(b){if(b&&b.selected){a=b}});return a},_showTemplatesButton:function(){this.form.$form.trigger("compose-button-state",this.form._getState())},_hideTemplatesButton:function(){this.form.$form.trigger("compose-button-state",this.form._getState())},_setTemplateContent:function(a){var b=this.form,d=b.isNew()||b.isDraft()&&!b.isReply()&&!b.isForward(),e=b.isHTMLMode(),g=a.id?"compose.switch_template_confirm_text":"compose.before_unload_confirm_text",h;if((d&&b.isChanged()||this.hasAppliedTemplate)&&!confirm(Lang.get(g))){a.selected=false;if(this.prevTemplate){this.prevTemplate.selected=true}return}if(d){b.parentView.load("drafts&noedit=1&id="+a.id);return}h=e?a.body:a.bodyPlain;if(this.hasAppliedTemplate){var i=b.options[e?"html":"text"];b.setContent(i);b.setCaretPositionInStart()}h=h.replace(/<blockquote .*>[\s\S]+<\/blockquote>/g,"");h=c.replaceSignature(h," ",b.getSignatures(),e,true,true).text;if($.browser.msie&&$.browser.intVersion<9){b.setCaretPositionInStart()}var j=b.getEditor();j&&j.selection&&j.selection.setContent(h);if(!this.checkboxesPrevValue){this.checkboxesPrevValue={}}if(f.has("compose2")){["Priority","Receipt","remind"].forEach(function(c){var d=c.toLowerCase(),e=b.composeUI.$('[data-blockid="'+d+'"]').getBlock(),f=a[c];e.toggleActive(!!f,String(f));if(c!=="remind"){e.val(f?"1":"")}}.bind(this))}else{Array.forEach(["Priority","Receipt","remind"],function(c){var d=a[c],e,f,g,h;if(d){this.checkboxesPrevValue[c]=d;e=b.$selectFieldsDropdownItems.filter('[data-type="'+c+'"]');e.toggleClass("dropdown__list__item__link_selected",true);g=b.$form.find(".js-row-"+c);g.show();h=b.$form.find(".js-row-Property");h.show();f=b._formElm(c);if(c=="remind"){f.val(d);b.updateNotify()}f.prop("checked",d?true:false).triggerHandler("change")}else if(this.checkboxesPrevValue[c]!==undefined){f=b._formElm(c);if(c=="remind"){f.val(this.checkboxesPrevValue[c]);b.updateNotify()}f.prop("checked",this.checkboxesPrevValue[c]?true:false).triggerHandler("change")}}.bind(this))}var k=[];if(this.prevTemplate){var l=this.prevTemplate.Attaches;k=[].concat(l.forward,l.tnef,l.cloud,l.cloud_link,l.files);Array.forEach([].concat(l.forward,l.cloud),function(a){if(b.multiAttachToComposeUI.checkedFilesMap[a.uid]){delete b.multiAttachToComposeUI.checkedFilesMap[a.uid]}})}var m=Array.map(k,function(a){return a&&a.uid});b.fileUploader.removeFiles(m);var n=b.fileUploader.uploaderHTML5._spaceLeft,o=[],p=0,q=[];Array.forEach([].concat(a.Attaches.forward),function(a){if(a){if(p+a.size>n){q.push(a.name)}else{a.external=true;o.push(a);p+=a.size}}});b.multiAttachToComposeUI.restoreFiles(o,"filesearch");o=[];var r=[];Array.forEach([].concat(a.Attaches.cloud),function(a){if(a){if(p+a.size>n){r.push(a)}else{a.external=true;o.push(a);p+=a.size}}});b.multiAttachToComposeUI.restoreFiles(o,"cloud");b._restoreAttaches(r.concat(a.Attaches.cloud_link),"cloud_link");b._restoreAttaches(a.Attaches.tnef,"tnef");if(patron.UseSendAPIV1){Array.forEach([].concat(a.Attaches.files),function(a){a.loaded=a.isFiles=true});b.fileUploader.uploaderHTML5.opts.mailRestoreList=a.Attaches.files;b.fileUploader.uploaderHTML5.restore()}if(q.length){var s=10;alert(String.sprintf(Lang.get("upload.limit.template"),"\n"+q.slice(0,10).join(",\n"))+(q.length>s?" "+String.sprintf(Lang.get("upload.limit.template_more"),q.length-s):""))}this.hasAppliedTemplate=!!a.id;this.prevTemplate=a.id?a:null},_onLoadTemplates:function(a,b){if(b&&b.isOK()){var c=b.getData();if(c){var d=this.templates.length?this.templates[this.templates.length-1].id:null;this.templatesLoaded=true;if($.isArray(c.messages)&&c.messages.length){for(var e=0,f,g;e<c.messages.length;e++){f=c.messages[e];if(f&&f.id!=d){g={id:f.id,subject:f.subject.replace(/(^<)|(>$)/g,"")==Lang.get("message.email.untitled")?"":f.subject,snippet:f.snippet,body:"",bodyPlain:"",attaches:null,bodyLoaded:false};this.templates.push(g)}}}}if(a&&$.isFunction(a)){a(this.templates)}}},_onLoadTemplate:function(a,b){this.form.enableEdit();if(b){a.bodyLoaded=true;var c=this.form.getFieldsByType("templates",b);a.body=b.get("body").html;a.bodyPlain=b.get("body").text;a.Attaches=c.Attaches;a.To=c.To;a.CC=c.CC;a.BCC=c.BCC;a.Priority=c.HighPriority;a.Receipt=c.NeedRcpt;a.remind=c.remind;this._setTemplateContent(a)}},count:function(a){var b;var c=this.form;switch(a){case"save":b=["compose","templates",this.getActiveTemplate()?"update":"create",c.fileUploader.uploaderHTML5._count?"has_files":"no_files"];break;case"set":b=["compose","templates","set",c.messageMode];break;case"send":if(this.getActiveTemplate()){b=["compose","templates","send",c.messageMode]}break}if(b){$.event.trigger("ui-abstract-action",{chain:b})}}})})(jQuery);return patron.Compose.Templates});define("patron.compose/patron.Compose.DragAndDrop",["ajs/pkg","jquery","features","patron/patron.API"],function(a,$,b){"use strict";var c=/^image\/(?!(x-)?(tif|bmp))/i;var d=/^image\/(vnd\.adobe\.photoshop|svg\+xml)/i;var e=/^text\/(rtf)/i;var f=function(a){if(a.type=="dragover"||a.type=="dragenter"){try{var b=a.dataTransfer.effectAllowed;a.dataTransfer.dropEffect=b=="move"||b=="linkMove"?"move":"copy"}catch(a){}}};var g;var h=function(b,c){var d;var e=false;$(b).on("dragenter dragleave dragover",function(b){var c=b.originalEvent;var h=c.dataTransfer&&c.dataTransfer.types;var i=h?h.length:0;var j=false;while(i--){if(h[i].includes("File")){f(c);c.preventDefault();if(d!==c.type){e=true;d=c.type;j=true;if(d!=="dragleave"){a.log("toggleDropZone 1",d);$(window).triggerHandler("toggleDropZone",[true])}}break}}if(j){clearTimeout(g);g=setTimeout(function(){a.log("toggleDropZone 2",d);$(window).triggerHandler("toggleDropZone",[d!=="dragleave"])},10)}});if(c){$(b).on("drop",function(b){if(!e)return;var f=b.isPropagationStopped();b.preventDefault();b.stopPropagation();clearTimeout(g);a.log(b.type);d=0;if(!f){c.call(b.currentTarget,b)}a.log("toggleDropZone 3");$(window).triggerHandler("toggleDropZone",[false]);if($.browser.edge){setTimeout(function(){a.log("toggleDropZone 4");$(window).triggerHandler("toggleDropZone",[false])},100)}})}};var i=function(a,b){$(a).on("paste",function(a){b.call(a.currentTarget,a)})};function j(){function b(b){return a.getRandomHash(b,true,true,true)}return b(4)+"@"+b(8)+"."+b(8)}function k(a){return a.replace(/\//g,".")}jsClass.create("patron.Compose.DragAndDrop").methods({__construct:function(a){this.form=a;this.loadingData={}},initialize:function(){this._initDom();this._active=false;this.editor=this.form.getEditor();this.editorDoc=this.editor.getDoc();this.uploader=this.form.fileUploader;this._initEvents()},_initEvents:function(){if(patron.AllowDropInlineImageInEditor){h(this.$allDropZone.add(this.editorDoc).add(document.body).add(document),this._onDrop.bind(this));h(this.$dropZone,this._onDrop.bind(this));h(this.editorDoc,this._onDrop.bind(this));$(window).bind("toggleDropZone",function(a,b){this._onDragHover(b);this._onHoverDragZone("files",b);this._onHoverDragZone("images",b)}.bind(this))}if(b.has("compose2-inline-paste")){i($(this.editorDoc),this._onDrop.throttle(1e3,this))}this.$allDropZone.on("tap",this._onTapDragZone.bind(this))},_initDom:function(){var a=this.form.onlyInEditor?1:2e3;if(this.form.onlyInEditor){this.$overlay=$()}else{this.$overlay=$("<div/>").css({zIndex:a-1,position:"absolute",top:0,right:0,width:"100%"}).display(0).appendTo("body")}this.$dropZone=this.form.$form.find(".js-drop-zone").css("z-index",a);this.$dropImages=this.form.$form.find(".js-drop-images").css("z-index",a);this.$allDropZone=this.$dropZone.add(this.$dropImages).add(this.$overlay)},_onDragHoverLog:function(a,b){if(this._active!==a){$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","drag"],state:a})}},_onTapDragZone:function(){this._toggleDropZone(false);this._toggleAttachesToolbar(false)},_onHoverDragZone:function(a,c){var d=a==="files";if(!b.has("compose2")){this.$dropZone.toggleClass("b-compose__drop_hover",c&&d);this.$dropZone.toggleClass("b-compose__drop_hover_bottom",c&&!d);this.$dropImages.toggleClass("b-compose__drop_hover",c&&!d)}},_onDragHover:function(a){clearTimeout(this.hideTimeoutId);if(b.has("compose2")){this._toggleAttachesToolbar(a)}this._toggleDropZone(a);$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","drag"],state:a})},_toggleAttachesToolbar:function(a){if(a){this._toolbarState=true;this.form.composeUI.attachments.toggle(true)}else{this._toolbarState=this.form.composeUI.attachments.updateVisible()}$(window).resize()},_toggleDropZone:function(a){if(b.has("compose2")){if(a){this.$overlay.css("height",$(document).outerHeight());this.$allDropZone.css("visibility","hidden").display(1);this.$allDropZone.css("visibility","visible");this._active=true}else{this.hideTimeoutId=setTimeout(function(){this.$allDropZone.display(0)}.bind(this),50);this._active=false}}else{this._active=a;this.$allDropZone.display(a)}},_onDrop:function(a){var b=this.editorDoc,f=b===a._currentTarget||this.$dropImages[0]===a.target,g=a.originalEvent,h,i=false,j=[];if(!this.form.onlyInEditor||f){if(a.type==="paste"){h=g.clipboardData;try{if(window.File&&h.items&&h.items.length){i=Array.some(h.items,function(a){return e.test(a.type)});if(i){$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","paste","createfile-textexists"]});return}Array.prototype.forEach.call(h.items,function(b){var e="file",f;if(b&&b.kind==="file"&&b.getAsFile&&b.getAsFile()){if(b.type){e=k(b.type)}try{f=new File([b.getAsFile()],e,{type:b.type})}catch(a){f=b.getAsFile()}if(f&&f.size&&!d.test(f.type)&&c.test(f.type)){j.push(f);a.preventDefault();$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","paste","createfile"],file:f})}else{$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","paste","invalidefile"],file:f})}}})}}catch(a){$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","paste","createfile-error"]})}}else{h=g.dataTransfer;j=h.files}}if(j&&j.length){a.preventDefault();this.putInlineFiles(j,f,a)}if(window.clipboardData&&window.clipboardData.getData&&!window.clipboardData.getData("Text")){a.preventDefault()}},putInlineFiles:function(a,b,e){var f=this.uploader,g=f.uploaderHTML5._spaceLeft,h=[];if(a.length){Array.forEach(a,function(a){if(a.type||a.size){if(b&&!d.test(a.type)&&c.test(a.type)&&(g-=a.size)>0){this._uploadInlineImage(e,a)}else{$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","useattaches"],data:{is_editor:b,correct_type:c.test(a.type),space_left:g>0,type:e&&e.type}});h.push(a)}}},this);if(h.length>0){f.uploadFiles(h)}}this._toggleDropZone(false)},_uploadInlineImage:function(b,c){var d="id"+a.uuid(),e='<img id="'+d+'" alt="" style="display: none;"/>',f=this.editor,g=this.editorDoc,h=f.getContainer(),i=h&&h.getBoundingClientRect(),j=this.uploader,k=b.originalEvent,l=c.size<Math.MB*2,m;if(b.type!=="paste"){f.selection.setContent(e)}else{f.execCommand("mceInsertContent",false,e)}var n=this.loadingData[d]={getPreview:function(){return $(f.dom.get(this.previewId))},previewId:d,canPreview:l,file:c,type:b.type};j.uploadInlineFile(c,this._onUploadInlineFile.bind(this,$.extend(n,{deferred:this._createTemporaryPreview(n)})));$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","put"],file:c,type:n.type})},_needResizePreview:function(a){var c=b.get("compose2-inlinefromeditor");return c&&c.data&&+(c.data||0)<a},getEditor:function(){return this.editor},_createTemporaryPreview:function(a){var b=new $.Deferred,c=new $.Deferred,d=$(this.getEditor().getBody());c.done(function(){var b=a.getPreview();b.removeAttr("_mce_src").css({visibility:"hidden",display:""});if(this._needResizePreview(b.width())&&d.width()<b.width()){b.attr("width",Math.round(d.width()*.9))}b.css({visibility:"",opacity:.3});$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","temp","done"],data:a})}.bind(this));c.fail(function(){$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","temp","fail"],data:a})});if(a.canPreview){var e=new FileReader;var f=new $.Deferred;b.fail(function(){var b=a.getPreview();if(b&&b.length){b[0].onload=null}f.reject();c.reject()});f.done(function(b){var d=a.getPreview();if(d&&d.length){d[0].onload=null;d.attr("src","");d[0].onload=c.resolve;d.attr("src",b.target.result)}});e.onload=f.resolve;e.readAsDataURL(a.file)}else{b.fail(function(){c.reject()});c.resolve()}return b},_onUploadComplete:function(a,b){var c=this.form;var d=new $.Deferred;d.done(function(b){var d=a.getPreview();a.deferred.reject();if(b){d.attr("src",b.src);d.removeAttr("data-mce-src");var e=j();c.Attaches.inlineUploaded[b.src]={id:b.id,content_id:e};c.options.map_inline_img[b.src]=e;d.css({opacity:"",display:"",width:"",height:""});d.removeAttr("data-mce-style");delete this.loadingData[a.previewId]}else{d.remove()}$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","upload","done"],data:a,attach:b})}.bind(this));patron.Ajax.parse(b,"success",{dataType:"json",complete:function(b){b=new patron.API.Response(b);var c=b.getBody(),e;if(b.isOK()){var f=c.attach.thumbnails;if(f&&$.isPlainObject(f.image)){f=f.image}if(f&&(e=f.original)){if(a.canPreview){var g=new Image;g.onload=function(){d.resolve({id:c.attach.id,src:e});g=g.onload=null};g.src=e}else{d.resolve({id:c.attach.id,src:e})}}else{d.resolve()}}else{d.resolve();$.event.trigger("ui-abstract-action",{chain:["compose-inline-attaches","upload","fail"],data:a,result:b})}}})},_onUploadInlineFile:function(a,b){switch(b.type){case"upload":case"error":this._onUploadComplete(a,b.target&&b.target.result);break}}});return patron.Compose.DragAndDrop});define("patron.compose/patron.Compose.Form",["ajs/pkg","patron.v2/models/Folder","Promise","patron.v2/models/Message","patron.v2/utils/features","liaz677","patron.v2.ui/patron.ui.letter.ContextMenu","patron.v2.view/attachment/utils","patron.model/MailboxStatus","patron.v2.utils/userStore","patron.v2.layer/ComposeContactsManager/AdressBook","patron.v2.layer/ComposeAttachmentsManager/popupCloudMail","patron.v2.layer/patron.layer.MessagesLayers","patron.v2/utils/parsers/emoji","mrg-text-analyzer","patron.build/Wysiwyg","patron.v2/utils/userRealNames","patron.v2/models/Alias","patron.compose/warning/_all","patron.compose2/patron.Compose.Form.patch","patron/patron","utils/Counter","plugins/AjaxCall","plugins/jQueryEvent","plugins/Layer","plugins/Dropdown","jQuery/extensions","jQuery/autocomplete","jQuery/addressbookSuggest","jQuery/composeLabels","jQuery/expandField","patron/patron.Ajax","patron/patron.BindedCounters","patron.ui/patron.ui.AttachFromFileSearch","patron.ui/patron.ui.AttachFromCloud","patron.ui/patron.ui.MultiAttachToCompose","patron.utils/patron.Utils","patron.compose/patron.Compose.FormValidator","patron.compose/patron.Compose.FileUploader","patron.compose/patron.Compose.Appearance","patron.compose/patron.Compose.Decoration","patron.compose/patron.Compose.Cards","patron.compose/patron.Compose.Templates","patron.compose/patron.Compose.Utils","patron.compose/patron.Compose.DragAndDrop","patron.utils/patron.Utils.Fishing","toolkit/b-dropdown/b-dropdown","patron.translator/patron.Translator","mrg-polyfills"],function(ajs,Folder,Promise,Message,features,bus,ContextMenu,utils,MailboxStatus,userStore,AddressBook,PopupCloudMail,MessagesLayers,emoji,MrgTextAnalyzer,Wysiwyg,userRealNames,Alias,warnings,Compose2Patch){patron.v2&&patron.toolkit&&patron.toolkit["b-dropdown"]&&patron.toolkit.create("b-compose__head__switcher","b-dropdown",{});(function($){var $win=$(window),$doc=$(document),_rurl717=/https:[^"]+url717=/g,_sendmsg_log={},tmpContent;var _request_log_timers={};function _request_limit_log(a){patron.radar("SendmsgXHR","limit_"+a+"s=1")}function _request_time_log(a){if(Math.random()*100<patron.SendmsgXHRTimeLogPercent){patron.radar("SendmsgXHR","time="+a)}}function _request_timer(a,b){if(Math.random()*100<patron.SendmsgXHRLimitLogPercent){if(b<=120){a.id=setTimeout(function(b){_request_limit_log(b);_request_timer(a,b+10)}.bind(this,b),1e4)}}}var restoreExpiredAttachments=features.get("restore-expired-attachments");var popupId=0;jsClass.create("patron.Compose.Form").extend(jQueryEvent).statics({M_TEXT:0,M_HTML:1,defaultOptions:{autoSaveTimeout:6e4,keepAliveTimeout:18e5,keepAliveExpirationTime:restoreExpiredAttachments?parseInt(restoreExpiredAttachments.data,10):18e5,checkConnectionTimeout:6e4,updateEditorGeometryTimeout:25,updateEditorFrameOnResizeTimeout:25,enableSaveTimeout:500,defaultEditorHeight:436,minEditorHeight:378,maxEditorHeight:570,minEditorWithAppearanceHeight:478,maxEditorWithAppearanceHeight:570,hasFormattedPattern:/<(b|strong|em|i|font|u|strike|img)(\s|>)/i,issetContentPattern:/<(img)(\s|>)/i,resizeDisabled:false},getActive:function(){var a;if("MCompose"in window&&MCompose.isActive()){a=MCompose}else{var b=patron.Compose.Form,c,d;for(d in b){if(b.hasOwnProperty(d)){c=b[d];if(c&&c.isActive&&c.isActive()){a=c}}}}return a}}).methods($.extend({__construct:function(a,b){var c=this;c.redraw=c.redraw.debounce(16,this);c.$form=$(a);c.options=$.extend({},patron.Compose.Form.defaultOptions,b);patron.log("compose.form.init",b);c.mobileVersion=$.browser.operamini;c.deviceVersion=tinyMCE.isIDevice||$.browser.operamobi||$.browser.android;c.supportBeforeUnload=true;c.disabled={};c.xhrs={};c.timers={};c.intervals={};c.popups={};c.RealNamesSignatures=[];if(this.options.RealNames){Object.forEach(this.options.RealNames,function(a){if($.trim(a.signature)&&a.signature!==""){this.RealNamesSignatures.push(a)}else if(features.has("wysiwyg-signature")){if($.trim(a.signatureHtml)){this.RealNamesSignatures.push($.extend({},a,{signature:userRealNames.getEmptySignature()}))}}},this)}this._clearAttaches();if(c.options.html&&$.browser.opera){c.options.html="<div>"+c.options.html+"</div>"}c.sentmsgUrl="/compose/";if(patron.UseFSentmsg){c.sentmsgUrl="/fsentmsg"}c.validator=new patron.Compose.FormValidator(c.$form);c.fileUploader=new patron.Compose.FileUploader(c.$form,c.options.fileUploaderSettings,{name:c.options.name,domIDs:c.options.domIDs,liteVersion:c.mobileVersion});this.multiAttachToComposeUI=new patron.ui.MultiAttachToCompose({filesLimit:this.fileUploader.settings.MaxAttachments});this.attachFromFileSearchUI=new patron.ui.AttachFromFileSearch({hasSpaceLimit:true,filesLimit:this.fileUploader.settings.MaxAttachments});this.attachFromCloudUI=new patron.ui.AttachFromCloud({hasSpaceLimit:false,filesLimit:this.fileUploader.settings.MaxAttachments});this.cards=new patron.Compose.Cards(a);this.decoration=new patron.Compose.Decoration(a);this.dragAndDrop=new patron.Compose.DragAndDrop(this);this.beforeUnloadObserver=$.proxy(this.supportBeforeUnload?this._onBeforeUnload:this._onBeforeUnloadFix,this);this.keyboardObserver=$.proxy(this._formKeyboard,this);patron.v2&&this._iV2();c.bind("ready",function(){if(!(this.isNew()||this.isForward())){c.setCaretPositionInStart()}jsHistory.oneTop($.proxy(c.unactive,c));$win.triggerHandler("showForm.compose")});$('input[name="Priority"]',c.$form).click(function(){$win.triggerHandler("priorityCheckboxClick.compose")});$('input[name="Receipt"]',c.$form).click(function(){$win.triggerHandler("receiptCheckboxClick.compose")});c.oldEditorFlags=patron.EditorFlags;var d=$(".js-compose__select_email",this.$form);var e=$(".dropdown__button-inline__text",d);this._fromDropdownClick=this._fromDropdownClick.bind(this,e);d.dropdown({link:".dropdown__button-inline",container:".dropdown__list",onClick:function(a,b){a.preventDefault();this._fromDropdownClick($(a.target).data("email")||patron.useremail);b.hide()}.bind(this)});if(this.fileUploader.uploaderHTML5){this.attachFilesListener=function(a,b){this._enableSave()}.bind(this);if(patron.EnableComposeMultiAttach){this.multiAttachToComposeUI.bind("select",function(a,b){c._attachFilesFromFileSearch(b.filesearch,b.restore);c._attachFilesFromCloud(b.cloud,b.restore)})}else{this.attachFromFileSearchUI.bind("select",function(a,b){c._attachFilesFromFileSearch(b)});this.attachFromCloudUI.bind("select",function(a,b){c._attachFilesFromCloud(b)})}this.fileUploader.uploaderHTML5.bind("reset",function(){this._clearAttaches()}.bind(this));this.fileUploader.uploaderHTML5.List.bind("remove removeByUid",function(a,b){var c=this.Attaches;if(c.forward.files[b]){c.forward.size-=c.forward.sizes[b];delete c.forward.files[b];delete c.forward.sizes[b]}else if(c.cloud.files[b]){c.cloud.size-=c.cloud.sizes[b];delete c.cloud.files[b];delete c.cloud.sizes[b]}else if(c.cloud_link[b]){delete c.cloud_link[b]}else if(c.tnef[b]){delete c.tnef[b]}if(this.multiAttachToComposeUI){delete this.multiAttachToComposeUI.checkedFilesMap[b]}}.bind(this));if(patron.EnableComposeMultiAttach){$(".js-multi-attach",this.$form).click(function(a){if($(a.delegateTarget).hasMod("disabled")){return}var b=$.extend({},this.Attaches.forward.files,this.Attaches.cloud.files);var d={},e={};Array.forEach(c.fileUploader.uploaderHTML5.getAll(),function(a){if(b[a.uid]){if(a.isFiles){e[a.uid]=a}else{d[a.uid]=a}}});this._initMultiattachPopup(b,d,e)}.bind(this))}else{c.uploaderDropDown=$(".js-dropdown-uploader",this.$form).dropdown({hideByMousedown:true,hideByBlur:true,timeout:0,link:".js-dropdown",container:".js-dropdown-list",onToggle:function(a,b){Counter.sb(1345750)},onClick:function(a,b){var c=this.fileUploader.uploaderHTML5._spaceLeft;var d=this.fileUploader.getFilesCount();var e=$(a.target).closest(".js-dropdown-list-item",b.$container);if(e.hasClass("js-filesearchlink")){this.attachFromFileSearchUI.show({spaceLeft:c,filesCount:d});Counter.sb(1345751);b.hide()}else if(e.hasClass("js-cloudlink")){this.attachFromCloudUI.show({spaceLeft:c,filesCount:d});b.hide()}else{if($.browser.opera||$.browser.mozilla&&$.browser.intVersion<4){setTimeout(function(){$doc.one("mousemove",function(a){b.hide()})},1e3)}else{b.hide()}}}.bind(this)}).dropdown("widget")}this.setSubjectFromAttachmentsObserver=this.setSubjectFromAttachmentsObserver.bind(this)}$(".js-dropdown-select-notify",this.$form).dropdown({link:".dropdown__button-inline",container:".dropdown__list",orientation:"auto",onClick:function(a,b){var c=$(a.target).closest(".dropdown__list__item",b.$container);var d=$(".dropdown__list__item__link__text",c).text();var e=$(".dropdown__button-inline__text",b.$link);var f=c.data("time");if(c.length){if(f){e.text(d);this._formElm("remind").val(f)}}if(f=="3600")Counter.sb(1345741);else if(f=="7200")Counter.sb(1345742);else if(f=="86400")Counter.sb(1345744);else if(f=="172800")Counter.sb(1345747);else if(f=="432000")Counter.sb(1345749);b.hide()}.bind(this)});this.updateNotify();this.$selectFieldsDropdown=$(".js-dropdown-select-fields",this.$form).dropdown({link:".button-a",container:".dropdown__list",orientation:"auto",onToggle:function(a,b){Counter.sb(1345721)},onClick:function(a,b){var c=$(a.target).closest(".dropdown__list__item",b.$container);var d=c.data("type"),e=parseInt(c.data("bit"));if(d){var f=$(".js-row-"+d,this.$form);var g=!c.hasClass("dropdown__list__item__link_selected");if(g){f.show()}else{f.hide();if(d=="CC"||d=="BCC"){f.find('input[type="text"], textarea').val("");if(patron.ComposeLabels){var h=f.find(".js-compose-labels").first().composeLabels("widget");if(h)h.clear()}}}c.toggleClass("dropdown__list__item__link_selected",g);if(d=="Notify"||d=="Priority"||d=="Receipt"){var i=$(".js-row-Property",this.$form);var j=$(".js-row-Notify,.js-row-Priority,.js-row-Receipt",this.$form);i.toggle(g||j.filter(":visible").length>0);f.find('input[type="checkbox"]').prop("checked",g)}if(c.hasClass("dropdown__list__item__link_selected")){patron.EditorFlags|=e}else{patron.EditorFlags&=~e}this.setEditorFlags();if(d=="CC")Counter.sb(1345723);else if(d=="BCC")Counter.sb(1345726);else if(d=="From")Counter.sb(1345730);else if(d=="Receipt")Counter.sb(1345731);else if(d=="Priority")Counter.sb(1345737);else if(d=="Notify")Counter.sb(1345740);this._updateComposeLabelsDND();$win.triggerHandler("changeFieldVisible.compose")}b.hide()}.bind(this)});this.$selectFieldsDropdownItems=$(".dropdown__list__item",this.$selectFieldsDropdown);c.changeNameDropDown=$(".js-dropdown-select-name",this.$form).dropdown({link:".dropdown__button-inline",container:".dropdown__list",orientation:"auto",onClick:function(a){this._setActiveName(a)}.bind(this)}).dropdown("widget");$win.bind("changeFieldVisible.compose",function(){$(".js-expand-field, .js-compose-labels",this.$form).each(function(){var a=$(this);if(a.is(":visible")){a.change()}})}.bind(this));c.templates=new patron.Compose.Templates(c);c._initContextMenu();var f=c.options.domIDs;c.$frame=$(f.composeFrame);c.$composeEditorFrame=$(f.composeEditorFrame);c.$composeDisableFormLayer=$(f.composeDisableFormLayer);c.$toolbarComposeTop=$(f.toolbarComposeTop);c.$showCustomFieldsLink=$(".mlr-snd_rw_safld .mlr-psd_lnk",c.$form).bind("click",{scope:c},c._showCustomFieldsLinkClick);c.$sendButton=$(".js-send",c.$form);c.$draftButton=$(".js-draft",c.$form);c.$cancelButton=$(".js-cancel",c.$form);c.$footerDraftButton=$(".js-compose-footer-save",c.$form);c.$removeDraftContainer=$(".js-removeDraftContainer",c.$form);this.onChangeOfflineModeObserver=this._onChangeOfflineMode.bind(this);$(window).bind("offlinechange",this.onChangeOfflineModeObserver);c._updateFrameHeight();if(b.name){patron.Compose.Form[b.name]=this}if(c.mobileVersion){c._mobileVersionInit()}else{if(c.deviceVersion){c._deviceVersionInit()}else{if(!patron.ComposeLabels){c._initExpandFields()}userRealNames.loadRealNames().done(function(){c._initEditor()})}c._initAddressBook();if(!patron.ComposeLabels){c._initAddressBookAutocomplete()}}this.bind("ready",$.proxy(function(){var a=this,b=$(new Image).attr("src",a.options.checkAvatarUrl).one("load error",function(b){$(this).unbind();a._checkAvatar(b)})},this));Counter.d(326613);this._disableCloudAttache();this.trigger("inited")},_iV2:function(){var a=this.$form;a.delegate("[data-compose-btn]","click",function(a){a.preventDefault();var b=$.attr(a.currentTarget,"data-compose-btn");if(b=="send"){this._send(a)}else if(b=="cancel"){this._cancel(a)}else if(b=="saveDraft"){this._toDrafts(a)}else if(b=="saveTemplate"){this._toTemplates(a)}}.bind(this));this.ModeSwitcher=new patron.toolkit["b-compose__head__switcher"]({el:this.$form.find(".b-compose__head__switcher"),select:function(a){var b=this.$('[data-name="'+a+'"]');this.$("__ctrl").find(".js-text").text(b.find(".js-text").text()).end().find(".ico").replaceWith(b.find(".ico").clone())},onMode:function(b,c){this.select(c.name);a.trigger("composeswitchmode",c)}})},_initMultiattachPopup:function(a,b,c){if(features.has("compose-popup-files")){new PopupCloudMail({checkedFilesMap:a,attachedFilesMap:b,linkedFilesMap:c,freeSpace:this.fileUploader.uploaderHTML5._spaceLeft,totalAttachedFiels:this.fileUploader.getFilesCount(),onAttache:function(a){this._attachFilesFromCloud(a.cloud||[],null);this._attachFilesFromFileSearch(a.mail||[],null)}.bind(this)})}else{window.multiAttachToComposeUI=this.multiAttachToComposeUI;this.multiAttachToComposeUI.show({filesCount:this.fileUploader.getFilesCount(),checkedFilesMap:a,attachedFilesMap:b,linkedFilesMap:c,freeSpace:this.fileUploader.uploaderHTML5._spaceLeft})}},_onChangeOfflineMode:function(a,b){return;this._setEditorControlsState(["design","cards","appspelling","apptransfer","apptranslit","appkeyboard","appspelling2","apptransfer2","apptranslit2","appkeyboard2"],!b);if(this.uploaderDropDown){this.uploaderDropDown.$link.toggleClass("form_disabled",b)}if(this.$addressbookLinks){this.$addressbookLinks.toggleClass("compose__header__label__box_addressbook",!b)}if(b){this._disableSave();this.decoration.hide()}else{this._enableSave()}},_formElm:function(a){return $('input[name="'+a+'"], textarea[name="'+a+'"]',this.$form)},isActive:function(){return this.$form&&this.$form.is(":visible")},unactive:function(){var a=this;for(var b in a.xhrs){try{a.xhrs[b].abort()}catch(a){}}for(var c in a.timers)clearTimeout(a.timers[c]);for(var d in a.intervals)clearInterval(a.intervals[d]);$win.add($doc).add(this.$form).unbind(".composeinner").unbind("."+this.uniqId);this._removeUnloadConfirm();this._disableAttachesKeepAlive();a.triggerHandler("unactive")},reset:function(){var a=this.options.domIDs;var b=this.getMainFrame();this.$form[0].reset();this._hideCustomFields();if(this.templates){this.templates.reset()}this._enableControls();this.enableEdit();if(this.fileUploader.uploaderHTML5){this.fileUploader.uploaderHTML5.unbind("attachFiles",this.attachFilesListener);this.disableSubjectFromAttachments()}this.getSaveMailSuccessMessageContainer().add(this.getSaveMailErrorMessageContainer()).add(this.getSaveMailErrorMessageContainer(true)).hide();this._formElm("To").add(this._formElm("CC")).add(this._formElm("BCC")).add($('input[name="Subject"]',this.$form)).val("").triggerHandler("clearPreviousValue");if(patron.ComposeLabels&&$.browser.opera){$(".js-compose-labels",this.$form).each(function(){if($(this).composeLabels("widget")){$(this).composeLabels("widget").clear()}})}$('input[name="Priority"], input[name="Receipt"]',this.$form).prop("checked",false);$([a.composeEditor_toolbar1,a.composeEditor_toolbar3,a.composeEditor_toolbar4].join(","),this.$form).css("visibility","hidden");var c=$.extend(this.getData({attachments:false}),{letbody_html:"",letbody_plain:"",HTMLCompose:patron.HTMLCompose,To:"",CC:"",BCC:"",Subject:"",draft_msg:"",re_msg:"",fwd_msg:"",files_id:"",files_ids:"",cloud_files_ids:"",actionId:"",template_id:"",HighPriority:"",remind:"",NeedRcpt:"",LeftMailSize:patron.Compose.fileUploaderSettings.MaxAttachmentSize,MessageId:ajs.getRandomHash(8,true,true,true)});this.redraw(c,true);this._clearCaptcha();b.addClass("jsvh");var d=this.getEditor();if(d){d.setContent("",{no_events:true,format:"raw"});this.setCaretPositionInStart();$(document.body).focus()}this.triggerHandler("reset");this.$form.trigger("compose-success",{state:false}).trigger("compose-error",{state:false});this._disableAttachesKeepAlive();delete this._reattachedToReply;return this},resetNotify:function(){var a=$(".js-row-Notify",this.$form),b=$(".js-input",a),c=$(".js-dropdown-select-notify",this.$form),d=$(".js-default",c),e=$(".dropdown__list__item__link__text",d),f=$(".dropdown__button-inline__text",c);f.text(e.text());b.val(d.data("time"))},updateNotify:function(){var a=$(".js-row-Notify",this.$form),b=$(".js-input",a),c=b.val()|0,d=$(".js-dropdown-select-notify",this.$form),e=$(".js-default",d),f=d.find('.dropdown__list__item[data-time="'+c+'"]');if(!f.length){f=e}var g=$(".dropdown__list__item__link__text",f),h=$(".dropdown__button-inline__text",d);h.text(g.text())},setTo:function(a){this._formElm("To").val(a).trigger("change");return this},setCC:function(a){this._formElm("CC").val(a).closest(".js-row-CC",this.$form).toggle(!!a).end()[!a?"F":"trigger"]("change");return this},setSubject:function(a){this._formElm("Subject").val(a);return this},_getAttachesCount:function(){var a=this.fileUploader.getFilesCount();return this.composeUI.getMoneyAttach()?++a:a},setSubjectFromAttachmentsObserver:function(){var a=this._prevSubjectState;var b=this._formElm("Subject").val();if(!a){if(b){this.disableSubjectFromAttachments();return}a={subject:"",attachesCount:0}}var c=this._getAttachesCount();if(c!==a.attachesCount){if(b!==a.subject){this.disableSubjectFromAttachments()}else{var d=this.fileUploader.uploaderHTML5.getAll().map(function(a){return a.name})||[];var e=this.composeUI.getMoneyAttach();if(e){d.push(Lang.get("compose.money.subject.default"))}var f=d.slice(0,3).join(", ");if(d.length>3){f+=" "+String.sprintf(String.num(d.length-3,Lang.get("upload.limit.more.plural")),d.length-3)}this.setSubject(f);this._prevSubjectState={subject:f,attachesCount:c}}}},enableSubjectFromAttachments:function(){if(features.has("subject-from-attachments")){if(this.isReply()||this.isForward()||(this.isDraft()||this.templates.getActiveTemplate())&&this.fileUploader.getFilesCount()>0){return}this.fileUploader.uploaderHTML5.List.unbind("remove removeByUid",this.setSubjectFromAttachmentsObserver).bind("remove removeByUid",this.setSubjectFromAttachmentsObserver);this.fileUploader.unbind("onQueueFinsh onQueueChanged",this.setSubjectFromAttachmentsObserver).bind("onQueueFinsh onQueueChanged",this.setSubjectFromAttachmentsObserver);this.composeUI.on("moneyManipulate",this.setSubjectFromAttachmentsObserver)}},disableSubjectFromAttachments:function(){this.fileUploader.uploaderHTML5.List.unbind("remove removeByUid",this.setSubjectFromAttachmentsObserver);this.fileUploader.unbind("onQueueFinsh onQueueChanged",this.setSubjectFromAttachmentsObserver);this._prevSubjectState=null},getFieldsByType:function(a,b,c,d){var e={re_msg:"",fwd_msg:"",schedule_msg:"",To:"",CC:"",BCC:"",Subject:"",Attachments:""};e.Attaches={forward:[],tnef:[],cloud:[],cloud_link:[],files:[]};var f=b&&b.id;if($.type(b)=="string"){b=patron.Messages.get(f=b)}e.re_msg=/reply/.test(a)?f:"";e.fwd_msg=/forward/.test(a)?f:"";e.draft_msg=/drafts/.test(a)?f:"";e.schedule_msg=/outbox/.test(a)?f:"";if(b){b.ReplyTo=(b.ReplyTo||"").split(";").join(" ");b.ReplyAllTo=(b.ReplyAllTo||"").split(";").join(" ");b.SubjectFwd=(b.SubjectFwd||"").split(";").join(" ");switch(a){case"reply":e.Subject=b.SubjectRe;e.To=b.ReplyTo;break;case"replyall":e.Subject=b.SubjectRe;e.To=b.ReplyAllTo||b.ReplyTo;e.CC=b.ReplyAllCC;break;case"forward":e.Subject=b.SubjectFwd;break;case"outbox":e.Schedule=b.get("send_date");e.schedule_msg=b.id;case"drafts":case"templates":e.Subject=b.get("subject")||"";if(e.Subject===ajs.Html.escape("<"+Lang.get("message.email.untitled")+">")||e.Subject.replace(/(^<)|(>$)/g,"")===ajs.Html.escape(Lang.get("message.email.untitled"))){e.Subject=""}e.To=b.ToList;if(e.To==="<"+Lang.get("readmsg.not_specified")+">"){e.To=""}e.CC=b.Cc;e.BCC=b.BccList;break}Array.forEach(["To","CC","BCC","Subject"],function(a){e[a]=replaceEntity(e[a])});e["msg"]=b.id}if(patron.UseSendAPIV1&&(a=="forward"||a=="drafts")||a=="templates"||a=="outbox"){e.LeftMailSize=patron.Compose.fileUploaderSettings.MaxAttachmentSize;if(b){var g=e.LeftMailSize;Array.forEach(b.Attachments,function(a){if(a.isTNEF){e.Attaches.tnef.push({uid:ajs.uuid(a.PartID+a.tnef_id),name:a.name,size:a.size,partId:a.PartID,tnef_id:a.tnef_id,onlyPartId:true})}else{e.Attaches.forward.push({PartID:a.PartID,uid:ajs.MD5(a.PartID),size:a.size,name:a.isRFC822?a.Subject+".eml":a.name})}g-=a.size});Array.forEach(b.Attachlinks,function(a){if(a.cloud){if(g-a.size>0){g-=a.size;e.Attaches.cloud.push({uid:ajs.MD5(a.downloadlink),name:a.name,size:a.size,downloadlink:a.downloadlink,isFiles:false,fromCloud:true,onlyPartId:true})}else{e.Attaches.cloud_link.push({uid:ajs.uuid(a.downloadlink),name:a.name,size:a.size,downloadlink:a.downloadlink,isFiles:true,fromCloud:true,onlyPartId:true})}}else{e.Attaches.files.push({uid:a.Id,fileid:a.Id,filename:a.name,filesize:a.size,dlink:a.Id})}});e.LeftMailSize=g;if(a==="drafts"||a==="templates"||a==="outbox"){e.HighPriority=b.Priority==1;e.NeedRcpt=b.Receipt;e.remind=b.remind}}if(c){var h=function(){var a=-1;return function(){return"message"+(++a?a:"")}}();Array.forEach(c,function(a,b){var c=a.Subject||a.subject||a.get&&a.get("subject");if(c==="<"+Lang.get("message.email.untitled")+">"){c=""}c=c||"";if(b===0){e["Subject"]="Fwd: "+c}var d=a.Size;if(ajs.isset(a.size)){d=a.size}else{if(ajs.isString(d)){d=parseInt(d,10)}d*=Math.KB}var f=c||h();e.Attaches.forward.push({uid:ajs.uuid(a.Id),PartID:a.Id,name:f+".eml",size:d,external:true});e.LeftMailSize-=a.Size});if(c.length>1){e["Subject"]+=" (+"+ajs.plural(c.length-1,Lang.get("Messages").letter," ")+")"}}if(d){Array.forEach(d,function(a,b){var c=a.id||a.get("id"),d=a.name||a.get("name"),f=a.size||a.get("size");if(b===0){e["Subject"]="Fwd: "+d}e.Attaches.forward.push({PartID:c,uid:ajs.MD5(c),size:f,name:d,external:true});e.LeftMailSize-=f});if(d.length>1){e["Subject"]+=" (+"+ajs.plural(d.length-1,Lang.get("Files").file," ")+")"}}}return e},setMode:function(a,b){var c=this.getFieldsByType(a,b);this._hideCustomFields();this._formElm("re_msg").val(c["re_msg"]);this._formElm("fwd_msg").val(c["fwd_msg"]);this._formElm("draft_msg").val(c["draft_msg"]);this.setTo(c["To"]).setCC(c["CC"]).setSubject(c["Subject"]);this.currentFormData=this.$form.serialize();return this},getData:function(a){var b=$.extend({},this.options.fileUploaderSettings,this.options),c=this.$form.toObject();$.each("files_id,message,old_charset,draft_msg,template_id,re_msg,fwd_msg,To,CC,BCC,Subject".split(","),function(a,d){b[d]=c[d]});b.HTMLCompose=c.HTMLMessage;b.NeedRcpt=c.Receipt;b.HighPriority=c.Priority;b.remind=c.remind;if(a){if(a.attachments===false){b.mailRestoreList=void 0;var d=1,e="AttachedFiles_",f=e+d;while(b[f+"_Id"]){b[f+"_Id"]=void 0;f=e+ ++d}}}return b},_restoreAttaches:function(a,b){if(a&&a.length){this.fileUploader.uploaderHTML5.one("attachFiles",function(a,c){Array.forEach(c,function(a){this.Attaches[b][a.uid]=a},this)}.bind(this));this.fileUploader.attach(a,true)}},_clearAttaches:function(){this.Attaches={tnef:{},inline:{},inlineUploaded:{},cloud_link:{},forward:{sizes:{},size:0,files:{}},cloud:{sizes:{},size:0,files:{}}}},getInlineAttach:function(a){var b=this.Attaches.inline,c=Object.keys(b),d,e,f;for(d=0,e=c.length;d<e;d++){f=b[c[d]];if(f.id===a){return{id:f.id,content_id:f.content_id,link:c[d],type:"inline"}}}},getFileById:function(a){var b=this.fileUploader.uploaderHTML5;var c=b.getByFileId(a);if(!c){c=this.getInlineAttach(a)}return c},_showAttachError:function(a,b,c){var d=this.fileUploader.uploaderHTML5,e,f,g,h;if(a==="expired"){e=[];f=[];g=false;b.forEach(function(a){var b=this.getFileById(a);if(b){if(b.type==="inline"){g=true}else{f.push(b.uid);e.push({name:b.name})}}else{$.event.trigger("ui-abstract-action",{chain:["compose","attaches","expired","error","unknown_type"]})}}.bind(this));if(g){e.push({name:Lang.get("notify.send.invalid_inline_attaches")})}if(features.has("compose2-notify")){d.notifyAttachError(a,e)}else{h=e.map(function(a){return a.filename}).join(", ");h=Lang.get("notify.send.invalid_attaches").replace("%attaches",h);this._showErrorSaveMailMessage(h,1,null,c)}d.removeFiles(f)}},_reattachToReply:function(a,b){$.event.trigger("ui-abstract-action",{chain:["reattachToReply",b?"yes":"no"]});(b?this.fileUploader.uploaderHTML5._reattach(a):Promise.resolve()).then(function(b){var c=patron.Message.all.get(a);var d=c.get("attaches").list;this._reattachedToReply=(b||[]).filter(function(b){return d.get(b.origin_id.replace(a+";",""))||b.type==="cloud"||b.type==="cloud_stock"});if(this._reattachedToReply.length){this.options.submitEmptyMessageConfirmSuccess=true}this.options.submitWithoutAttachConfirmSuccess=true;this.$form.trigger("submit")}.bind(this))},redraw:function(data,reset){var t=this;this._clearAttaches();var formData={value:{actionId:data.actionId||"",files_id:data.files_id==null?"":data.files_id.toString(),files_ids:data.files_ids||"",cloud_files_ids:data.cloud_files_ids||"",message:data.MessageId||"",old_charset:data.old_charset||"",draft_msg:data.draft_msg||"",template_id:data.template_id||"",re_msg:data.re_msg||"",fwd_msg:data.fwd_msg||"",To:data.To||"",CC:data.CC||"",BCC:data.BCC||"",Subject:data.Subject||"",HTMLMessage:patron["ForceHtmlCompose"]||data.HTMLCompose?1:0},checked:{remind:data.remind,Priority:!!data.HighPriority,Receipt:!!data.NeedRcpt}};var fileUploaderSettings={needReattach:data.needReattach,msg:data.msg,ServerName:data.ServerName||"",NoFlashUploader:!!data.NoFlashUploader,MaxAttachmentSize:parseInt(data.MaxAttachmentSize),MessageId:formData.value.message,DraftMsg:formData.value.draft_msg,LeftMailSize:parseInt(data.MaxAttachmentSize),files_id:formData.value.files_id,UploadOnlyFiles:!!data.UploadOnlyFiles,MaxAttachments:parseInt(data.MaxAttachments),mailRestoreList:[]};if(patron.UseSendAPIV1){if(data.Attaches){fileUploaderSettings["mailRestoreList"]=data.Attaches.files}}else{var i=1,pr="AttachedFiles_",pk=pr+i;while(data[pk+"_Id"]){fileUploaderSettings["mailRestoreList"].push({fileid:data[pk+"_Id"]||"",filename:data[pk+"_FileName"]||"",partid:data[pk+"_partID"]||"",isRFC822:data[pk+"_isRFC822"]>>>0,filesize:parseInt(data[pk+"_Size"])});pk=pr+ ++i}}var cloudLinks=[];if(patron.UseSendAPIV1){if(data.Attaches){cloudLinks=data.Attaches.cloud_link}}else{for(var a=1,key;a<=data.Attachlinks_Items;a++){key="Attachlinks_"+a+"_";if(data[key+"cloud"]){cloudLinks.push({uid:ajs.uuid(data[key+"downloadlink"]),name:data[key+"name"],ext:data[key+"ext"],size:data[key+"size_exact"],downloadlink:data[key+"downloadlink"],isFiles:true,fromCloud:true,onlyPartId:true})}}}this._restoreAttaches(cloudLinks,"cloud_link");if(patron.UseSendAPIV1){if(data.Attaches){this._restoreAttaches(data.Attaches.tnef,"tnef")}}if(data.RADAR_ON)fileUploaderSettings["radar_config"]={t:data.radar_type,p:"mail3",f:data.front_name2};var o=t.options;var FromName=null;if(!patron.v2){$.each(t.options.RealNames,function(a,b){if(b.selected){FromName=b.name;return false}})}var options={RealNames:userRealNames.getRealNames(),editorId:o.editorId,MessageId:data.MessageId||"",AbjsHash:data.AbjsHash||"",checkAvatarUrl:patron.Utils.getAvatarSrc(patron.useremail,FromName,90),fileUploaderSettings:fileUploaderSettings,map_inline_img:{},isNewMessage:0,submitEmptyMessageConfirmSuccess:false,html:""+(data.letbody_html||""),text:""+(data.letbody_plain_Text_HTML||data.letbody_plain||""),initialMessageText:data.initialMessageText};options.text=options.text.replace(/\r/g,"");if(data.map_inline_img&&$.type(data.map_inline_img)=="string"){options["map_inline_img"]=eval("({"+data.map_inline_img+"})")}if(!(formData.value.re_msg||formData.value.draft_msg||formData.value.fwd_msg||formData.value.actionId)){options.isNewMessage=1}this.options=$.extend({},this.options,options);this.$toolbarComposeTop.toggleClass(this.options.toolberTopCornerClass,patron.isSentMsg);this.$selectFieldsDropdownItems.each(function(a,b){var c=$(b),d=c.data("type"),e=parseInt(c.data("bit"));var f=$(".js-row-"+d,this.$form);var g=formData.value[d],h=formData.checked[d];if(d=="Notify"){h=formData.checked["remind"]}var i=!!(g||h);i=i||(patron.EditorFlags&e)===e;if(i){f.show()}else{f.hide()}c.toggleClass("dropdown__list__item__link_selected",i);if(d=="Notify"||d=="Priority"||d=="Receipt"){var j=$(".js-row-Property",this.$form);var k=$(".js-row-Notify,.js-row-Priority,.js-row-Receipt",this.$form);j.toggle(i||k.filter(":visible").length>0)}}.bind(this));this._updateComposeLabelsDND();if(formData.checked&&formData.checked.remind){var $input=this._formElm("remind");$input.val(formData.checked.remind);this.updateNotify()}else{this.resetNotify()}$.each(formData.value,function(a,b){var c=this._formElm(a);c.val(b);c.triggerHandler("clearPreviousValue")}.bind(this));$.each(formData.checked,function(a,b){var c=this._formElm(a);c.prop("checked",b).triggerHandler("change")}.bind(this));var editor=this.getEditor();var signId;$.each(t.options.RealNames,function(a,b){if(b.selected){signId=b.id;return false}});if(editor){var control=editor.controlManager.get("signature");if(control){control.setActiveRealName(signId)}}this._setRealName(signId);if(this.templates){this.templates.setActiveTemplate(formData.value.draft_msg,!data.noedit);if(this._getMessageMode()=="templates"){this.templates.setTemplate(null,true)}}if(reset){this.trigger("redraw-reset");return this}$win.triggerHandler("changeFieldVisible.compose");this.messageMode=this._getMessageMode();if(patron.EnableComposeMultiAttach){if(this.multiAttachToComposeUI){this.multiAttachToComposeUI.reset()}}else{if(this.attachFromFileSearchUI){this.attachFromFileSearchUI.reset()}if(this.attachFromCloudUI){this.attachFromCloudUI.reset()}}if(t.mobileVersion){t._mobileVersionReady()}else{if(t.deviceVersion){t._deviceVersionReady()}else{t._fullVersionReady()}}t.triggerHandler("redraw");if(patron.UseSendAPIV1){if(patron.EnableComposeMultiAttach){if(this.multiAttachToComposeUI){if(data.Attaches){if(data.Attaches.forward.length){this.multiAttachToComposeUI.restoreFiles(data.Attaches.forward,"filesearch")}if(data.Attaches.cloud.length){this.multiAttachToComposeUI.restoreFiles(data.Attaches.cloud,"cloud")}}}}}if(ajs.offline){this._onChangeOfflineMode(null,true)}if(this.fileUploader.uploaderHTML5){this.fileUploader.uploaderHTML5.unbind("attachFiles",this.attachFilesListener).bind("attachFiles",this.attachFilesListener);this.enableSubjectFromAttachments.gap(this,100)()}if(patron.ComposeLabels){$(".js-compose-labels",this.$form).each(function(){if($(this).composeLabels("widget"))$(this).composeLabels("widget").redraw()});patron.radar("composelabels"+(patron["UsePortalSuggest"]?"_v2":""),"show=1")}if(patron.LANG&&patron.LANG!=="ru_RU"&&patron.LANG!=="en_US"){$win.bind("compose-form-redraw changeFieldVisible.compose",function(){var a=0;$(".js-label",this.$form).width("auto").each(function(b,c){a=Math.max(a,c.offsetWidth)}).width(a);$(".compose__header__row",this.$form).removeClass("invisible")}.bind(this))}if(data.showcards&&this.decoration){this.decoration.hide();this.decoration.show("cards",0);this.getEditor().controlManager.get("cards").setActive(true)}if((data.card||data.appearance)&&this.decoration){var type=data.card?"cards":"appearance",control=data.card?"cards":"design",itemId=data.card||data.appearance;this.decoration.hide();this.decoration.show(type,0,itemId);this.getEditor().controlManager.get(control).setActive(true)}$.event.trigger("compose-form-redraw",this._getState());this._disableSaveTemplates();this._checkIsReplyDoc();return this},_checkIsReplyDoc:function(){this._isReplyDoc=false;if(this.isReply()){var a=patron.Messages.get(this._formElm("re_msg").val());if(a){var b=a.get("attaches").list.map(function(a){return a.name}).filter(function(a){return/\.docx?$/i.test(a)});if(b.length){this._isReplyDoc=true;$.event.trigger("ui-abstract-action",{chain:["compose","reply","doc-msg-enter"]})}}}},resizeDisabled:function(a){this.options.resizeDisabled=!!a;return this},_formKeyboard:function(a){if(!patron.v2||!patron.ShortcutEnabled||a.target.tagName=="INPUT"||a.target.tagName=="TEXTAREA"||a.target.tagName=="BODY"){if(a.ctrlKey||a.metaKey){var b=a.keyCode||a.which;if(b==13||b==10){a.preventDefault();this.$form.submit();$.event.trigger("ui-abstract-action",{chain:["shortcut","ctrl+enter"]})}else if(b==83||b==19){a.preventDefault();this._toDrafts($.Event("anonymous"));$.event.trigger("ui-abstract-action",{chain:["shortcut","ctrl+s"]})}}}},_setUnloadConfirm:function(){this._removeUnloadConfirm();if(this.supportBeforeUnload){$win.bind("beforeunload.composeform",this.beforeUnloadObserver)}else{$doc.bind("click.composeform",this.beforeUnloadObserver)}},_removeUnloadConfirm:function(){$win.unbind("beforeunload.composeform");$doc.unbind("click.composeform")},_onBeforeUnload:function(){var a=this,b=a.getEditor();if(a.isHTMLMode()){b.save({format:"raw"})}var c=a.$form.serialize();if(c!=a.currentFormData||a.getFileUploader().isLoading()){return Lang.get("compose.before_unload_confirm_text")}},_onBeforeUnloadFix:function(a){var b=this,c=b.getEditor(),d=b.$form.serialize();if(b.isHTMLMode())c.save({format:"raw"});if(d!=b.currentFormData||b.getFileUploader().isLoading()){var e=$(a.target);if(e.is("a")&&!/^(javascript|#)/.test(e.attr("href"))){if(!confirm(Lang.get("compose.before_unloadfix_confirm_text")))a.preventDefault()}}},_editorSetup:function(a){a.onFocus.add(function(a){$("body").trigger("tap")},this);a[$.browser.opera?"onKeyPress":"onKeyDown"].add(function(a,b){this._formKeyboard(b)},this)},_initEditor:function(){var a=Wysiwyg.settings({oninit:this._fullVersionInit.bind(this),setup:this._editorSetup.bind(this),elements:this.getEditorId(),theme_compose_toolbar_external_id:this.options.domIDs.toolbar_external.substr(1),real_names:this.RealNamesSignatures,theme_compose_buttons1:"bold,italic,underline,forecolor,backcolor,fontactions,justifyselect,textindentactions,bullistactions,emotions,undo,redo,inlineattach,appspelling,apptransfer,|,moreactions,|,enableTextEditor",theme_compose_buttons2:"signature,design,cards",theme_compose_buttons3:"appspelling2,apptransfer2,apptranslit2,appkeyboard2,|,enableHTMLEditor",moreactions_controls:{expand_controls:["appspelling","apptransfer","undo","redo"],controls:["hr","addlink","strikethrough","apptranslit","appkeyboard","removeformat"]}});tinyMCE.init(a);features.use("compose.userpic",this)},_initAddressBookAutocomplete:function(){if(patron.CanUseNewAddressbookSuggests){$(".js-ac-addressbook",this.$form).addressbookSuggest({width:"322px"})}else{$(".js-ac-addressbook",this.$form).bind("focus keyup",function a(){patron.Utils.getAddressBook();$(this).unbind("focus keyup",a)}).each(function(){$.Autocompleter.addressbook(this,true,true)})}},_initAddressBook:function(){this.$addressbookLinks=$(".js-addressbook-link",this.$form).click(function(a){var b=$(a.currentTarget),c=b.data("type");if(b.hasClass("compose__header__label__box_addressbook")){this._openAddressBook(c);$win.triggerHandler("addressBookLinksClick.compose")}}.bind(this))},_initExpandFields:function(){$(".js-expand-field",this.$form).expandField({fixedWidth:false})},_initContextMenu:function(){if(features.has("letter-contacts-copy")){var a=this;this.contextMenu=new ContextMenu({$el:this.$form.find(".js-compose-labels"),selector:".js-compose-label",mnemo:"compose_contextmenu",_onContextMenu:function(b){if(!b.shiftKey){var c=$(b.currentTarget);a._activeWidget=c.closest(".js-compose-labels").composeLabels("widget");if(a._activeWidget){if(!c.hasMod("selected")){a._activeWidget.deselectAll();a._activeWidget.select(c,true)}if(!ContextMenu.noFlash||a._activeWidget.getSelected().length==1){ContextMenu.fn._onContextMenu.call(this,b)}}}},onHide:function(a){this._activeWidget=null;this._activeWidgetData=null}.bind(this),getData:function(){var a=this._activeWidget,b=a.getSelected(),c=a.hasSelectedGrouds(),d=a.getSelectedText(),e;e={text:d,multiselect:b.length>1||c,contacts:b,noCompose:true};if(b.length==1){e.isInAB=patron.Utils.isInAddressBookSync(b[0].email)}this._activeWidgetData=e;return e}.bind(this),onAdd:function(a){var b=this._activeWidgetData&&this._activeWidgetData.contacts[0];if(b){patron.API.post("ab/contacts/add",{contacts:[{nick:b.name,emails:[b.email]}]},function(a){if(a.isOk()){var c=Lang.get("Messages").Actions["abook"].replace("%s",String.num(1,Lang.get("Messages")["contacts_abook"],false));patron.Notify.add("ok",c);patron.Utils.addToAddressBook([b.name?b.name+" <"+b.email+">":b.email])}else{patron.Notify.add("error",null,"compose_contacts_add")}})}}.bind(this),onSearch:function(a){var b=this._activeWidgetData&&this._activeWidgetData.contacts[0];if(b){jsHistory.set(patron.getPageURL("search")+"?"+ajs.toQuery({q_from:b.email}))}}.bind(this)});this.$form.find(".js-compose-labels").bind("mousedown",function(a){if(this.contextMenu&&this._activeWidgetData){this.contextMenu._hide($.Event())}}.bind(this))}},_updateComposeLabelsDND:function(){var a=patron.ComposeLabelsDnd&&($(".js-row-CC",this.$form).is(":visible")||$(".js-row-BCC",this.$form).is(":visible")),b;$(".js-compose-labels",this.$form).each(function(){if(b=$(this).composeLabels("widget")){b.toggleDragNDrop(a)}})},_checkAvatar:function(a){var b=Lang.get("compose.avatar")["add"];if(a.type!="error"){var c;$.each(this.options.RealNames,function(a,b){if(b.selected){c=b.name;return false}});$(this.options.domIDs.composeAvatar).css("backgroundImage","url("+patron.Utils.getAvatarSrc(patron.useremail,c,90)+")");b=Lang.get("compose.avatar")["change"]}$("span.mlr-snd_av_ttl:first",this.$form).text(b)},_preventDefault:function(a){a.preventDefault()},_setActiveName:function(a){a.preventDefault();var b=this.getEditor();var c=ajs.$onClick(a.target,1);var d=$(a.target).closest(".dropdown__list__item",this.changeNameDropDown.$container);if(d.length){c=d.data("type")}if(b){var e=b.controlManager.get("signature");if(e){e.setActiveRealName(c)}}this._setRealName(c);this.changeNameDropDown.hide()},_setRealName:function(a,b){var c=this.options.RealNames[a];if(c){var d=c.name.replace(/&apos;|&#39;/g,"'").replace(/&amp;|&#38;/g,"&").replace(/&#35;/g,"#").replace(/&#123;/g,"{").replace(/&#125;/g,"}");var e=$('input[name="HTMLMessage"]',this.$form).val()>0;this._setNameDropdownValue(a,d);$('input[name="RealName"]:first',this.$form).val(c.id);var f=this.signatures;if(!f){this.signatures=f=[];var g=patron.Compose.Utils.getSignatureOrEmpty(e);if(g){g=g.replace(/<br>/g,"\n");f.push({id:"current",signature:g})}f.push({id:"empty",signature:patron.Compose.Utils.getEmptySignature(e)});$.each(this.options.RealNames,function(a,b){f.push(b)})}if(!b){if(!patron.IsPddAccount&&Alias.get({alias:this._getFrom()})){this._clearSignature()}else{var h=patron.Compose.Utils.replaceSignature(this.getContent(),userRealNames.getSignature(e,a),this.getSignatures(),e,this.options.SignatureBeforeQuotation);if(h){if(f[0].id=="current"){f[0].signature=h.newSignature}else{f.splice(0,0,{id:"current",signature:h.newSignature})}if(h.found){this.setContent(h.text)}}}}f.forEach(function(b){b.selected=b.id==a})}$win.triggerHandler("realNameChange.compose")},_getContentWithoutSignature:function(a){var b=$('input[name="HTMLMessage"]',this.$form).val()>0;a=a||this.getContent();var c=patron.Compose.Utils.replaceSignature(a,patron.Compose.Utils.getEmptySignature(b),this.getSignatures(),b,this.options.SignatureBeforeQuotation);return c.text},_clearSignature:function(){var a=this._getContentWithoutSignature(),b=$('input[name="HTMLMessage"]',this.$form).val()>0,c=this.getEditor();this.setContent(a);if(b){c.save({format:"raw"})}},_setNameDropdownValue:function(a,b){if(this.changeNameDropDown&&!!this.changeNameDropDown.$link){$(".dropdown__button-inline__text",this.changeNameDropDown.$link).text(b)}},getSignatures:function(){return Array.map(this.signatures||this.options.RealNames||[],function(a){return a.signature})},getCurrentSignature:function(){var a="";if(this.signatures&&this.signatures[0]&&this.signatures[0].id=="current"){a=this.signatures[0].signature}else{var b;$.each(this.options.RealNames,function(a,c){if(c.selected){b=c.id;return false}});a=this.options.RealNames[b].signature||""}return a},_showCustomFieldsLinkClick:function(a){a.preventDefault();var b=a.data.scope;b._showCustomFields();$win.triggerHandler("showAllFieldsLinkClick.compose")},_removeUpdateEditorGeometryTimeout:function(){var a=this;clearTimeout(a.timers["updateEditorGeometry"])},_setUpdateEditorGeometryTimeout:function(){var a=this,b=a.options;a._removeUpdateEditorGeometryTimeout();a.timers["updateEditorGeometry"]=setTimeout($.proxy(a._updateEditorGeometry,a),b.updateEditorGeometryTimeout)},_removeUpdateEditorFrameOnResizeTimeout:function(){var a=this;clearTimeout(a.timers["updateEditorFrameOnResize"])},_setUpdateEditorFrameOnResizeTimeout:function(){var a=this,b=a.options;a._removeUpdateEditorFrameOnResizeTimeout();a.timers["updateEditorFrameOnResize"]=setTimeout($.proxy(a._updateGeometry,a),b.updateEditorFrameOnResizeTimeout)},_clearEditorGeometry:function(){var a=this;var b=a.getAppearance();var c=b.getMiddleTable();var d=a.getEditorElement();c.css("width","");d.css("width","100%");if($.browser.msie&&parseInt($.browser.version)<8){var e=b.getMainTable();e.css("width","")}},_parentHeightFunc:function(){try{return ajs.windowHeight()-this.getMainFrame().offset().top+ajs.scrollTop()}catch(a){}},_updateGeometryWithTriggerResize:function(){this._updateGeometry();$(window).resize()},_updateFrameHeight:function(){if(!this.options.resizeDisabled){var a=this,b=a.options,c=a.getEditorElement(),d=a.getCaptchaContainer(),e=a.getBottomControlsHeight(),f=this.parentHeight()-e-d[0].offsetHeight,g=Math.max(b.minEditorHeight,Math.min(b.maxEditorHeight,f));c.css("height",g)}},parentHeight:function(a){if($.isFunction(a)){this._parentHeightFunc=a;return this}return this._parentHeightFunc.call(this,this)},_updateEditorGeometry:function(){var a=this.getEditorElement();var b=this.getAppearance();var c=this.getMainFrame();if(this.options.resizeDisabled&&this.__uEGHM===this.isHTMLMode())return;this.__uEGHM=this.isHTMLMode();if(this.isHTMLMode()){var d=b.getCurrentTemplate();var e=this.getEditor();var f=this.getEditorFrame();var g=b.getMainTable();var h=b.getMiddleTable();var i=b.getMainCellHolder();var j=b.getWidthOffset();var k=e.getDoc();var l=e.getBody();var m=this.getEditorFrameBody();var n=c[0];var o=n.offsetHeight;var p="";var q=0;if(d){if(l.scrollWidth+j>n.offsetWidth){if($.browser.msie){m.css("display","inline");q=l.scrollWidth+j;if(q>n.offsetWidth){p=q}h.css("width",p);m.css("display","")}else{m.css("display","inline-block");q=l.offsetWidth+j;if(q>n.offsetWidth){p=q}h.css("width",p);m.css("display","")}}if($.browser.msie&&parseInt($.browser.version)<8){g.css("width","");if(n.scrollHeight>n.clientHeight){g.css("width",n.offsetWidth-16)}}o=l.scrollHeight;if(!$.browser.msie){var r=l.appendChild(k.createElement("div"));o=r.offsetTop-r.offsetHeight;l.removeChild(r)}o+=35;var s=n.offsetHeight-b.getHeightOffset();if(n.scrollWidth>n.clientWidth){s-=16}i.attr("height",s)}o=Math.max(defined(x,o),this.options.minEditorHeight);f.css("height",o)}else{var t=this.getCaptchaContainer();var u=this.getBottomControlsHeight();var v=this.options.minEditorHeight;var w=this.options.maxEditorHeight;var x=this.parentHeight()-u-t[0].offsetHeight;x=Math.max(v,Math.min(w,x));if($.browser.msie&&parseInt($.browser.version)<8){x-=16}a.css({height:x});if(features.has("compose2")&&features.has("use-translate-api")){this.translator.setHeight(x)}b.setListFrameHeight(x-38)}},_updateFrameGeometry:function(a,b){this._clearEditorGeometry();if(this.options.resizeDisabled&&this.__uFGHM===this.isHTMLMode()){return}this.__uFGHM=this.isHTMLMode();if(this.isHTMLMode()){var c=this.getMainFrame();var d=this.getAppearance();var e=d.getCurrentTemplate();var f=this.getBottomControlsHeight();var g=this.getCaptchaContainer();c.css("width","");var h=this.options.minEditorHeight;var i=this.options.maxEditorHeight;if(e){h=this.options.minEditorWithAppearanceHeight;i=this.options.maxEditorWithAppearanceHeight}a=defined(a,c.width());if(!defined(b)){b=this.parentHeight()-f-g[0].offsetHeight;b=Math.max(h,Math.min(i,b))}d.setListFrameHeight(b-38);if(this.composeUI){this.decoration.setHeight(b+(c.offset().top-this.$frame.offset().top))}else{this.decoration.setHeight(b)}c.css("height",b);c.css("width",a)}},_updateGeometry:function(){$win.triggerHandler("changeFieldVisible.compose");this._updateFrameGeometry();this._updateEditorGeometry()},_frameClick:function(a){a.data.scope.focus()},updateCurrentFormData:function(){if(this.isHTMLMode()){this.getEditor().save({format:"raw"})}this.currentFormData=this.$form.serialize()},_setAutoSaveInterval:function(){var a=this,b=a.options;a._removeAutoSaveInterval();a.intervals["autoSave"]=setInterval($.proxy(a._autosave,a),b.autoSaveTimeout)},_removeAutoSaveInterval:function(){var a=this;clearInterval(a.intervals["autoSave"])},_autosaveCompleteCallback:function(a){var b,c;this._autosaveActive=false;if(a.isOK()){b=a.getData()}if(b){if(patron.UseSendAPIV1){c=b.id}else{c=b.Id}}if(c){this._formElm("draft_msg").val(c);this._updateAffectedMessage(c);this.updateCurrentFormData();this._disableSave();this._showSuccessSaveMailMessage(true);this.Attaches.cloud.size=this.Attaches.forward.size=0;this._clearCaptcha()}},_saveCompleteCallback:function(a){var b,c,d=this._isSavingTemplates?Lang.get("compose.save_template_error"):Lang.get("compose.save_mail_error"),e=this._isSavingTemplates?"compose_save-template":"compose_save-mail";this._autosaveActive=false;this._hideLoading();if(a.isOK()){b=a.getData()}if(b){if(patron.UseSendAPIV1){c=b.id}else{c=b.Id}}if(c){if(this._isSavingTemplates){this.templates.count("save");this.templates.updateTemplate(c);this._formElm("draft_msg").val(this._currentDraftMsgId)}else{this._formElm("draft_msg").val(c)}this._updateAffectedMessage(c);this.updateCurrentFormData();this.Attaches.cloud.size=this.Attaches.forward.size=0;this._isSavingTemplates?this._disableSaveTemplates():this._disableSave();this._showSuccessSaveMailMessage(false,this._isSavingTemplates);this._clearCaptcha()}else{if(!a.isAbort()){this._showErrorSaveMailMessage(d,!!patron.v2,!patron.v2,b,e)}}this._isSavingTemplates=false;$win.triggerHandler("updated.drafts",b);MailboxStatus.fetch()},_getActualDraft:function(){var a=$.Deferred();this._saveProcess(function(b){var c,d;if(b.isOK()){c=b.getData()}else{a.reject(b)}if(c){if(patron.UseSendAPIV1){d=c.id}else{d=c.Id}}if(d){patron.Messages.load({id:d},function(c,d){if(!c){a.resolve(d)}else{a.reject(b,c)}});this._clearCaptcha();this._autosaveCompleteCallback(b)}}.bind(this));return a.promise()},_autosave:function(){if(patron.Compose.Form.getActive()){if(!this._autosaveActive){if(this.isHTMLMode()){this.getEditor().save({format:"raw"})}if(!this.disabled.draft){var a=this.$form.serialize();if(a!=this.currentFormData){this._autosaveActive=true;this._isSavingTemplates=false;this._saveProcess(this._autosaveCompleteCallback)}}}}else{this._disableSave()}},_save:function(){if(!this._autosaveActive){this._autosaveActive=true;if(patron["ComposeLabels"]){$(".js-compose-labels",this.$form).each(function(){$(this).composeLabels("widget").blur(false)})}this._showLoading(this._isSavingTemplates?Lang.get("compose.save_template_progress"):Lang.get("compose.save_mail_progress"));this._saveProcess(this._saveCompleteCallback,true)}},updateEditorElement:function(){if(this.isHTMLMode()){var a=this.getEditor(),b=this.getAppearance(),c=this.getEditorElement();var d=b.getHTML(a.getContent({format:"raw"}));c.val(this._prepareContent(d))}},_saveProcess:function(a,b){var c=restoreExpiredAttachments&&this._isKeepAliveExpired()?this._restoreExpiredAttachments():Promise.resolve();c.then(function(){var c=$('input[name="old_charset"]:first',this.$form);var d=c.val();this.updateEditorElement();c.val("utf-8");this._updateAttachesFields();if(this.xhrs["save"]){this.xhrs["save"].abort()}var e=this.$form.toObject();c.val(d);var f=this._constructFrom(this.$form);if(f){e.From=f}delete e["send"];delete e["draft"];delete e["cancel"];delete e["Filedata"];var g=this._createRequestData(e);if(patron.UseSendAPIV1){if(this._isSavingTemplates){g["save_as_template"]=true}patron.API({type:"POST",url:"messages/draft",data:g,complete:$.proxy(a,this)})}else{this.xhrs["save"]=patron.Ajax({type:"POST",url:"/compose/?func_name=message_to_draft&draft="+(this._isSavingTemplates?"2":"1"),data:g,isUser:!!b,complete:$.proxy(a,this)})}}.bind(this))},_enableCloudAttache:function(){this.$form.find(".js-multi-attach").toggleMod("disabled",false)},_disableCloudAttache:function(){this.$form.find(".js-multi-attach").toggleMod("disabled",true)},_enableSave:function(){this._enableSaveControl();this._enableTemplatesControl();this._removeEnableSaveInterval();if(!this.templates||!this.templates.isCreatingTemplateMode){this._setAutoSaveInterval()}},_disableSave:function(){this._disableSaveControl();this._removeAutoSaveInterval();this._setEnableSaveInterval()},_disableSaveTemplates:function(){this._disableTemplatesControl();this._removeAutoSaveInterval();this._setEnableSaveInterval()},_enableControls:function(){this._enableSendControl();this._enableSaveControl();this._enableTemplatesControl();this._enableCancelControl()},_disableControls:function(){this._disableSendControl();this._disableSaveControl();this._disableTemplatesControl();this._disableCancelControl()},_enableSendControl:function(){this.disabled.send=false;this.$sendButton.prop("disabled",false).removeClass("button-a_disabled");this.$form.trigger("compose-button-state",this._getState({type:"send",state:true}))},_disableSendControl:function(){this.disabled.send=true;this.$sendButton.prop("disabled",true).addClass("button-a_disabled");this.$form.trigger("compose-button-state",this._getState({type:"send",state:false}))},_enableSaveControl:function(){this.disabled.draft=false;this.$draftButton.prop("disabled",false).removeClass("button-a_disabled");this.$footerDraftButton.form__enable();this.$form.trigger("compose-button-state",this._getState({type:"saveDraft",state:true}))},_enableAttachesKeepAlive:function(a,b){this._disableAttachesKeepAlive();this._setAttachesKeepAliveTimeout(a);if(!b){this._lastKeepAliveDate=(new Date).getTime()}},_disableAttachesKeepAlive:function(){clearTimeout(this.attachesKeepAliveTimeout)},_isKeepAliveExpired:function(){return(new Date).getTime()-this._lastKeepAliveDate>this.options.keepAliveExpirationTime},_setAttachesKeepAliveTimeout:function(a){this.attachesKeepAliveTimeout=setTimeout(this._sendAttachesKeepAliveRequest.bind(this),a)},_sendAttachesKeepAliveRequest:function(){if(!this._isKeepAliveExpired()){if(features.has("send-use-v1-keepalive")){patron.API({url:"messages/attaches/keepalive",type:"POST",data:{message_id:this.options.MessageId},complete:function(a){if(a.isOK()){this._enableAttachesKeepAlive(this.options.keepAliveTimeout)}else{this._enableAttachesKeepAlive(this.options.checkConnectionTimeout,true)}}.bind(this)})}else{patron.Ajax({url:"/cgi-bin/attach_keepalive",type:"POST",data:{func_name:"touch",message_id:this.options.MessageId},complete:function(a){if(a.isOK()){var b=a.getData();if(b&&b.Result==="OK"){this._enableAttachesKeepAlive(this.options.keepAliveTimeout)}}else{this._enableAttachesKeepAlive(this.options.checkConnectionTimeout,true)}}.bind(this)})}}},_disableSaveControl:function(){this.disabled.draft=true;this.$draftButton.prop("disabled",true).addClass("button-a_disabled");this.$footerDraftButton.form__disable();this.$form.trigger("compose-button-state",this._getState({type:"saveDraft",state:false}))},_enableTemplatesControl:function(){this.disabled.templates=false;this.$form.trigger("compose-button-state",this._getState())},_disableTemplatesControl:function(){this.disabled.templates=true;this.$form.trigger("compose-button-state",this._getState())},_enableCancelControl:function(){this.disabled.cancel=false;this.$cancelButton.prop("disabled",false).removeClass("button-a_disabled");this.$form.trigger("compose-button-state",this._getState({type:"cancel",state:true}))},_disableCancelControl:function(){this.disabled.cancel=true;this.$cancelButton.prop("disabled",true).addClass("button-a_disabled");this.$form.trigger("compose-button-state",this._getState({type:"cancel",state:false}))},_checkEnableSave:function(){var a=this;if(a.isHTMLMode())a.getEditor().save({format:"raw"});var b=a.$form.serialize();if(b!=a.currentFormData){a._enableSave()}},_setEnableSaveInterval:function(){var a=this,b=a.options;a._removeEnableSaveInterval();a.intervals["enableSave"]=setInterval($.proxy(a._checkEnableSave,a),b.enableSaveTimeout)},_removeEnableSaveInterval:function(){var a=this;clearInterval(a.intervals["enableSave"])},_showSuccessSaveMailMessage:function(a,b){var c=new Date;var d=this.getSaveMailSuccessMessageContainer();var e=this.getSaveMailErrorMessageContainer();var f=this.getSaveMailErrorMessageContainer(true);var g=this.getLoadingContainer();var h=b?Lang.get("compose.save_template_success"):Lang.get("compose.save_mail_success");d.html(h);$(".auto:first",d).toggle(a);$(".time:first",d).text(c.getLocaleTime());e.add(f).add(g).hide();d.show();this.$form.trigger("compose-loading",{state:false}).trigger("compose-error",{state:false}).trigger("compose-success",{text:h,auto:a,time:c.getLocaleTime(),state:true})},_showErrorSaveMailMessage:function(a,b,c,d,e){var f=this.getSaveMailSuccessMessageContainer();var g=this.getSaveMailErrorMessageContainer(c);var h=this.getLoadingContainer();f.add(h).hide();if(c){a=a.replace("</center><br><br>","");patron.Notify.add("error",{text:a.replace(/\n/g,""),radar_postfix:"compose_save",data:d})}else{var i=b?a:String.sprintf(Lang.get("ErrorTable"),a);if(patron["v2"]){if(b){var j=i.replace(/\n/g,"").match(/<\/tr><tr><td class="oranzhe">(.*?)<\/td><\/tr><\/table>$/);if(j){i=j[1]}}patron.Notify.add("error",{html:i,radar_postfix:e||"compose_save",data:d})}else{g.html(i).show()}}this.$form.trigger("compose-loading",{state:false}).trigger("compose-success",{state:false})},_applyTranslit:function(a){var b=this;var c=b.getEditor();var d=b.getEditorElement();if(a){if(b.isHTMLMode()){c.setContent(a,{format:"raw"})}else{d.val(a)}}},_restoreExpiredAttachments:function(){var a;if(this.isReply()){a=this._formElm("re_msg").val()}else if(this.isForward()){a=this._formElm("fwd_msg").val()}else if(this.isDraft()){a=this._formElm("draft_msg").val()}return(a?this.fileUploader.uploaderHTML5._reattach(a):Promise.resolve()).then(function(a){this._enableAttachesKeepAlive(this.options.keepAliveTimeout)}.bind(this))},_onSubmit:function(a,b){var c=this,d=c.options;if(!this.isActive()){a.preventDefault();return}b=b||{};if(!b.force){var e=new patron.Collector,f=null;a.preventDefault();if(c.submitting){return}patron.log("compose.submit",b);var g=c.getFileUploader();if(patron["ComposeLabels"]){$(".js-compose-labels",c.$form).each(function(){$(this).composeLabels("widget").blur(false)})}if(!c.validator.validate()){}else if(g.isLoading()){c._disableControls();c.disableEdit();patron.Notify.add("send",{group:"send",delay:0});g.one("onQueueFinsh",{scope:c},function(a){a.data.scope.$form.trigger("submit")})}else if(!features.has("no-collectors-in-compose")&&!(f=e.cache())){e.list(function(){c.$form.trigger("submit")},{profile:true})}else{var h=!g.getFilesCount()&&!d.submitEmptyMessageConfirmSuccess&&(c.isEmptyContent()||c.isDefaultContent()&&c.isSignatureContent()||c.isDefaultContent()&&c.isReply())&&!d.initialMessageText&&!c._getAttachments().length;h=c.isReplyDraft()?false:h;var i=function(){function a(a){var b=0;var c=["application/ics"];var d=new RegExp(/.ics$/);a.list.forEach(function(a){if(!a.attributes||!c.includes(a.attributes.content_type)||!d.test(a.attributes.name)){b++}});return b}var b=this._formElm("re_msg").val();if(!features.has("reattach-to-reply")||!b){return false}var d=patron.Message.get(b);if(!d){return false}var e=d.get("correspondents");var f=[].concat(e.from,e.to,e.cc,e.bcc).map(function(a){return a.email});var g=this.$form.toObject();var h={to:g.To?patron.Utils.extractEmailsAndNames(g.To):[],cc:g.CC?patron.Utils.extractEmailsAndNames(g.CC):[],bcc:g.BCC?patron.Utils.extractEmailsAndNames(g.BCC):[]};var i=[].concat(h.to,h.cc,h.bcc);var j=i.some(function(a){return!~f.indexOf(a.email)});var k=a(d.get("attaches"));return j&&k&&!this._getAttachments(g).length&&!c._reattachedToReply}.bind(this)();var j=this._getFrom();var k=null,l=null;Array.forEach(f||[],function(a){if(!a){return 0}else if(a.email==patron.useremail){return 0}if(a.email==j&&/extra_auth|blocked/.test(a.state)){k=a;try{if(a.flags.used_oauth){l=a}}catch(a){}return false}});var m=warnings.get(this,{isShowEmptyConfirm:h,isShowReattachToReply:i,submitWithoutAttachConfirmSuccess:d.submitWithoutAttachConfirmSuccess});if(m){m()}else if(restoreExpiredAttachments&&this._isKeepAliveExpired()){this._restoreExpiredAttachments().then(function(){this.$form.trigger("submit")}.bind(this))}else if(l){require(["patron.ui/layers/collectors/collector_update-token"],function(a){a({collector:l})})}else if(k){require(["patron.ui/layers/collectors/collector_edit-password"],function(a){a({collector:k,complete:function(a,b){c.$form.trigger("submit")}})})}else{c.triggerHandler("submit",[this]);c.updateEditorElement();if(patron.uiRadar)patron.uiRadar("sendmsgok")("all")("prepare");var n=$('input[name="old_charset"]:first',c.$form);var o=n.val();n.val("utf-8");this._updateAttachesFields();var p=ajs.uniqId()+ajs.getRandomHash(10,false,true,false);if(c.xhrs["send"]){c.xhrs["send"].abort()}var q=c.$form.toObject();var r="";if(patron.IsExternalAccount){if(q.Name){r=q.Name=q.Name.trim()}}else if((patron.EnableIMAP&&patron.hasCollectors()||patron.IsPddAccount)&&c.$form.find('.b-dropdown[data-blockid="email"]').length){r=this.options.RealNames[q.RealName];if(r){r=r.name}else{r=patron.username}}if(r||patron.useremail!==j){r=ajs.Html.unescape(r)+" <"+j+">";q.From=r.replace(/\s+/g," ")}if(Alias.get({alias:j})){q.From=j}q["EditorFlags"]=this.oldEditorFlags=patron.EditorFlags;if(this.isForward()||this.isReply()){var s=patron.Folders.getSafe();if(s){q["folder"]=s.id}}q["SocialBitmask"]=patron["SocialConnect"].mask;Array.forEach(["To","CC","BCC"],function(a){q[a]=q[a].replace(/,$/,"")});delete q["send"];delete q["draft"];delete q["cancel"];delete q["Filedata"];_sendmsg_log.load_start=new Date;var t=this._createRequestData(q,true);if((d.submitWithoutAttachConfirmSuccess||d.attachCorrectAssumption)&&features.has("check-missing-attach")){t.analyzer_assumption=t.analyzer_assumption||{};t.analyzer_assumption.has_attachments=d.attachCorrectAssumption;d.attachCorrectAssumption=null;d.submitWithoutAttachConfirmSuccess=null}c.submitting=1;this._sendNotifyTimeout=setTimeout(function(){patron.Notify.add("send",{group:"send",delay:0})},2e3);this._lastLocationHref=location.href;if(patron.UseSendAPIV1){var u,v;try{if(Array.some(t.attaches.list,function(a){return a.type==="forward"||a.type==="inline"})){Array.some(Object.keys(t.source),function(a){return t.source[a]&&(u=a)})}}catch(a){}v="messages/send?logid="+p+(u?"&fromStorage="+u:"");if(t.send_date){v="messages/schedule";$.event.trigger("ui-abstract-action",{id:"schedule",chain:["compose","compose-widget","send"]})}patron.API({type:"POST",url:v,data:t,log_prepare:{time:_sendmsg_log.load_start},complete:this._sendComplete.bind(this,p,q,t)});if(u){$.event.trigger("ui-abstract-action",{chain:["mail","APIS","messages","send","fromStorage",u]})}}else{this.xhrs["send"]=patron.Ajax({type:"POST",url:this.sentmsgUrl+"?func_name=send&send=1"+(patron.IS_PREVIEW?"&preview="+parseInt(patron.IS_PREVIEW):"")+"&logid="+p,data:t,isUser:true,sentmsg:true,loading:"send",storeMe:"sentmsg",log_prepare:{time:_sendmsg_log.load_start},complete:this._sendComplete.bind(this,p,q,t)})}var w=_request_log_timers[p]={start_time:+new Date};_request_timer(w,10);patron.HTMLCompose=c.isHTMLMode();n.val(o);if(patron.uiRadar)patron.uiRadar("sendmsgok")("prepare",1);c._removeUnloadConfirm();c._disableControls();c._removeAutoSaveInterval();c.disableEdit();if(c.fileUploader.uploaderHTML5){c.fileUploader.uploaderHTML5.unbind("attachFiles",c.attachFilesListener);c.disableSubjectFromAttachments()}if(!q.message){(function(){var a=Array.filter(patron.log(1),function(a){return(a.label||a.type)==="onerror"});patron.radar("send_no_message",1,1,{rlog:"send_no_message",rlog_message:JSON.stringify({email:patron.useremail,page_init:patron.CurrentURL,page_from:jsHistory.get(),errors:a,fileapi:$.support.fileapi,flashUpload:$.support.flashUpload,HTML5Uploader:patron.HTML5Uploader})})})()}this.templates&&this.templates.count("send");if(this.isReply()){var x=/\.docx?$/i,y=function(a){return x.test(a)},z=g.getUploadedAttachments().map(function(a){return a.filename}).filter(y),A=patron.Messages.get(t.source?t.source.reply:t["re_msg"]);Object.forEach(this.Attaches.forward.files,function(a){if(y(a.name)){z.push(a.name)}});if(z.length&&A){var B=A.get("attaches").list.map(function(a){return a.name}).filter(y),C=/^(.+)\.(\w+)$/i,D=/\s[\d()\[\]]*/g;compareFileNames=function(a,b){a=a.replace(C,"$1");b=b.replace(C,"$1");if(a===b)return true;a=a.replace(D,"");b=b.replace(D,"");return a==b};if(z.some(function(a){return B.some(function(b){return compareFileNames(b,a)})})){$.event.trigger("ui-abstract-action",{chain:["compose","reply","same-doc-attach"]})}}if(this._isReplyDoc){$.event.trigger("ui-abstract-action",{chain:["compose","reply","doc-msg-send"]})}}if(patron["ComposeLabels"]){var E=false;var F=false;$(".js-compose-labels",c.$form).each(function(){E=E||$(this).composeLabels("widget").hasGroups();F=F||$(this).composeLabels("widget").hasFromInbox()});if(E){$.event.trigger("ui-abstract-action",{chain:["compose","sent","group"]})}if(F){$.event.trigger("ui-abstract-action",{chain:["compose","sent","from_inbox"]})}}}}$win.triggerHandler("sendClick.compose")}},_updateAttachesFields:function(){var a={attached_ids:[],cloud_files_links:[],cloud_files_ids:[],files_ids:[]};Array.forEach(this.fileUploader.getUploadedAttachments(),function(b){a.attached_ids.push(b.fileid)});Object.forEach(this.Attaches.cloud_link,function(b){a.cloud_files_links.push(b.downloadlink+":"+b.size+":"+encodeURIComponent(b.name))});Object.forEach(this.Attaches.cloud.files,function(b,c){var d=this.fileUploader.uploaderHTML5.getByUid(c);if(d.isFiles||!patron.NewCloudUpload){a.cloud_files_ids.push(b.PartId)}},this);Object.forEach(this.Attaches.forward.files,function(b){a.files_ids.push(b.PartId)});Object.forEach(a,function(a,b){var c=a.join(",");if(b==="cloud_files_ids"){c=JSON.stringify(a)}this._formElm(b).val(c)},this)},_createRequestData:function(a,b){var c=a,d,e;features.use("compose.before_send_virus",a);features.use("compose.before_send_mailto",a);var f=[];if(b&&patron.editableContactsV2&&patron.ComposeLabels){f=this._prepareEditContacts(this._getContacts(a))}if(patron.UseSendAPIV1){c={from:a.From,htmlencoded:false,id:a["message"],source:{draft:a["draft_msg"]?a["draft_msg"]:"",reply:a["re_msg"]?a["re_msg"]:"",forward:a["fwd_msg"]?a["fwd_msg"]:"",schedule:a["schedule_msg"]?a["schedule_msg"]:""},template:a.template_id?a.template_id:"",sign:a.RealName?a.RealName:"",remind:a.remind?a.remind:"",receipt:!!a.Receipt,subject:a.Subject,priority:a.Priority?a.Priority:"",capcha:a.security_image_word?a.security_image_word:"",correspondents:{to:a.To,cc:a.CC,bcc:a.BCC},edited_contacts:f,attaches:{list:this._getAttachments(a)}};var g=this.isHTMLMode()?"html":"text",h=a.Schedule&&patron.Utils.getCorrectedSendDate(a.Schedule);if(h&&this.composeUI.isScheduled()){c.send_date=h}if(features.has("compose-new-body-format")){c[g]=a.Body}else{c.body={};c.body[g]=a.Body}}else{c.EditContacts=f.join(",")}return c},_constructFrom:function(a){var b=a.toObject();var c="";var d=this._getFrom();var e="";if(patron.IsExternalAccount){if(b.Name){c=b.Name.trim()}}else if((patron.EnableIMAP&&patron.hasCollectors()||patron.IsPddAccount)&&a.find('.b-dropdown[data-blockid="email"]').length){c=this.options.RealNames[b.RealName];if(c){c=c.name}else{c=patron.username}}if(c||patron.useremail!==d){c=ajs.Html.unescape(c)+" <"+d+">";e=c.replace(/\s+/g," ")}if(Alias.get({alias:d})){e=d}return e},_getAttachments:function(a){function b(a,b){var c=false;a.forEach(function(a){if(c)return;if(a.type==="cloud_stock"&&a.id===b){c=true}});return c}var c=[];Array.forEach(this.fileUploader.getUploadedAttachments(),function(a){c.push({id:a.fileid,type:"attach"})});Array.forEach(this.fileUploader.getFilesAttachments(),function(d){if(d.bundle_id){if(!b(c,d.bundle_id)){c.push({id:d.bundle_id,type:"cloud_stock"})}}else{if(/^\d+$/.test(d.fileid)){c.push({id:a.files_id+":"+d.fileid,type:"files"})}else{c.push({id:d.fileid,type:"files"})}}});Object.forEach(this.Attaches.tnef,function(a){if(a.AttachId){c.push({id:a.AttachId,type:"attach"})}else{c.push({id:a.partId,tnef_id:a.tnef_id,type:"tnef"})}});Object.forEach(this.Attaches.cloud.files,function(a){if(a.AttachId){c.push({id:a.AttachId,type:"attach"})}else{c.push({id:a.PartId,type:"cloud"})}});Object.forEach(this.Attaches.cloud_link,function(a){if(a.AttachId){c.push({id:a.AttachId,type:"cloud"})}else{c.push({id:a.downloadlink+":"+a.size+":"+encodeURIComponent(a.name),type:"cloud"})}});Object.forEach(this.Attaches.forward.files,function(a){if(a.AttachId){if(!a.bundle_id){c.push({id:a.AttachId,type:"attach"})}}else{c.push({id:a.PartId,type:"forward"})}});Object.forEach(this.Attaches.inline,function(a){if(a.id){c.push({id:a.id,content_id:a.content_id,type:"inline"})}else{c.push({part_id:a.part_id,content_id:a.content_id,type:"inline"})}});if(this._reattachedToReply&&this._reattachedToReply.length){Object.forEach(this._reattachedToReply,function(a){if(a.type==="cloud_stock"){var d=a.attach.id.split(":")[0];if(!b(c,d)){c.push({id:d,type:"cloud_stock"})}}else{c.push({id:a.attach.id,type:{link:"files"}[a.type]||a.type})}})}var d=this.composeUI.getMoneyAttach();if(d){c.push({id:d.transactionId,type:"money",meta:{phone:d.phone,card_type:d.cardType,amount:d.amount}})}return c},getEditorFlags:function(){return patron.EditorFlags},setEditorFlags:function(){var a=patron.tokens["ajax_settings"];if(a&&a["form_sign"]&&a["form_token"]){this.saveEditorFlags(a["form_sign"],a["form_token"])}else{patron.API.post("tokens",function(a){if(a.isOK()){var b=String(a.getBody().token).split(":");patron.tokens["ajax_settings"]={form_sign:b[0],form_token:b[1]};this.saveEditorFlags(b[0],b[1])}}.bind(this))}},saveEditorFlags:function(a,b){if(this.xhrs["flags"]){this.xhrs["flags"].abort()}this.xhrs["flags"]=patron.Ajax({url:"/settings/ajax_settings?ajax_call=1&func_name=set_editorflags&editor_flags="+patron.EditorFlags,type:"GET",data:{form_sign:a,form_token:b}})},_getContacts:function(a){var b={},c={},d={},e=["To","CC","BCC"],f,g,h,i,j;while(f=e.pop()){g=this._formElm(f);if(h=a[f]){i=g.closest(".js-compose-labels").composeLabels("widget");Array.forEach(i.getUsed(true),function(a){var c=patron.ui.ComposeLabels.suggestToEmail(a),e=patron.ui.ComposeLabels.suggestToName(a);patron.Utils.isInAddressBook(c,function(b){if(!b){a=patron.ui.ComposeLabels.normalizeContact(a);c=patron.ui.ComposeLabels.suggestToEmail(a);e=patron.ui.ComposeLabels.suggestToName(a);d[c]=e}});b[c]=e});ajs.extend(c,i.getChangedContacts())}}return{all:b,changed:c,unknown:d}},_prepareEditContacts:function(a){var b=ajs.extend({},a.unknown,a.changed),c=[],d;for(d in b){c.push(b[d]+" <"+d+">")}return c},__addNewContactsToLocalAB:function(a){var b=this._getContacts(a);patron.Utils.addToAddressBook(patron.editableContactsV2?this._prepareEditContacts(b):b.all)},_sendComplete:function(a,b,c,d){if(patron.uiRadar)patron.uiRadar("sendmsgok")("all",1)(true);_sendmsg_log.load_end=_sendmsg_log.render_start=new Date;var e=_request_log_timers[a];if(e){e.time=new Date-e.start_time;clearTimeout(e.id);_request_time_log(e.time)}var f=d.getXHR(),g=d.getData(),h=false,i,j,k,l,m,n,o,p=[],q=/attaches\.list\[\d+\]\.id/i;if(d.isOK()&&g){if(features.has("check-sent-messages")){var r=g.id||g.message_id;var s=userStore.get("sentMessages")||{};var t=this.fileUploader.uploaderHTML5.List.getFiles();s[r]={date:(new Date).getTime(),host:d.getXHR().getResponseHeader("X-Host"),requestId:d.getOpts().headers["X-Request-Id"],attachments:Object.keys(t).map(function(a){return{name:t[a].name,size:t[a].size}})};userStore.set("sentMessages",s)}if(features.has("sendmsgok-template")){var u,v,w=c,x=g;if(!patron.UseSendAPIV1){x={id:g.message_id};w={source:{reply:c.re_msg,forward:c.fwd_msg},correspondents:{bcc:c.BCC,cc:c.CC,to:c.To}};j=g.ShowSecurityImage;if(g.Error){m=g.Error}}if(w.source){if(w.source.reply){v=w.source.reply}else if(w.source.forward){v=w.source.forward}}if(v){u=patron.Messages.get(v)}if(!u){u={}}k={id:x.id,data:w,message:u};l="sendmsgok?id="+x.id}else{j=g.ShowSecurityImage;k=g.Ok;l=g.redir_url;if(g.Error){m=g.Error}}if(j){this._showCaptcha(patron.AccountVerified,!!b["security_image_word"])}else if(m){this.triggerHandler("submiterror",[this,g]);this._showErrorSaveMailMessage(m,1,null,g)}else if(k){h=true;if(patron.v2&&patron.view&&patron.view.compose){patron.view.compose.SENT_HTML=k}else{var y=jsView.get("sendmsgok");if(y){y.preload(k);this.enableEdit()}}$.event.trigger("letter:send",function(){var a={};if(c.re_msg){a.mode="re";a.id=c.re_msg}else if(c.fwd_msg){a.mode="fwd";a.id=c.fwd_msg}else{a.mode="new"}return a}());if(l){if(this.triggerHandler("sent",l)!==false){if(this._lastLocationHref===location.href){if(!patron.isReadMsgPage(location.href)||!features.has("compose.stay_in_letter")){var z=patron.Router.request.query.thread;if(z){l=jsHistory.buildUrl({thread:z},null,l)}jsHistory.set(l)}else{patron.Notify.add("ok","letter.sent");this.$form.trigger("lettersent")}}}_sendmsg_log.render_end=new Date}else{i={log:"sentmsg",logid:a,status:"empty_field_redir_url",email:patron.useremail};_sendmsg_log.render_end=new Date}}else{i={log:"sentmsg",logid:a,status:"empty_field_ok",email:patron.useremail}}}else{if(!d.isOK()){if(d.getStatus()==="parsererror"){i={log:"sentmsgparseerror3",statusText:f.statusText,error:d.getError().toString(),email:patron.useremail}}else{i={log:"sentmsg",logid:a,status:"no_result_ok",result:d.getStatus(),email:patron.useremail}}}if(!d.isAbort()){if(g&&patron.UseSendAPIV1){p=Object.keys(g).filter(function(a){return q.test(a)}).map(function(a){return g[a]});if(g.correspondents){switch(g.correspondents.error){case"over_limit":m=Lang.get("notify.send.over_limit").replace("%limit",g.correspondents.limit);n=g.correspondents.error;break}}else if(p.length){p=p.filter(function(a){return a.error==="not_exists"}).map(function(a){return a.value});if(p.length>0){n="attach_not_exists";o="expired"}}else{var A=[];var B;Array.forEach(["to","cc","bcc"],function(a){Array.forEach(g["correspondents."+a]||[],function(a){if(a.error==="invalid"){A.push(a.value)}})});if(A.length>0){B=ajs.Html.escape(A.join(", "));if(A.length>1){m=Lang.get("notify.send.invalid_addresses").replace("%emails",B)}else{m=Lang.get("notify.send.invalid_address").replace("%email",B)}n="address"}}if(d.isManyRequests()||g.capcha&&g.capcha.error==="invalid"){j=true}}if(!i){i={log:"sentmsg",logid:a,status:"no_data",email:patron.useremail}}if(j){this._showCaptcha(patron.AccountVerified,g.capcha&&g.capcha.error==="invalid")}else if(o&&features.has("remove-expired-attach")){this._showAttachError(o,p,g)}else if(m){this.triggerHandler("submiterror",[this,g]);this._showErrorSaveMailMessage(m,1,null,g)}else if(g&&g.send_date&&g.send_date.error==="invalid"){patron.Notify.add("error",{text:i18n("Указана неверная дата отправки"),delay:6,radar_postfix:"compose_send_schedule",_log:i});n="other"}else if(g&&g.source&&g.source.schedule&&g.source.schedule.error==="in_process"){patron.Notify.add("error",{text:i18n("Невозможно изменить письмо. Письмо уже отправлено"),delay:6,radar_postfix:"compose_send",_log:i});n="other"}else if(g==="too_many_tasks"){patron.Notify.add("error",{text:i18n("Достигнут лимит писем с отложенной отправкой"),delay:6,radar_postfix:"compose_send",_log:i})}else{setTimeout(function(){patron.Notify.hide("ajax")},1e3);patron.Notify.add("error",{text:Lang.get("notify.send.error"),delay:6,radar_postfix:"compose_send",_log:i});n="other"}}}if(h){if(patron.IsExternalAccount&&b.Name){this.$form.find(".js-compose__header__from").show().addClass("js-row-From").find(".js-compose__header__from_name").text(b.Name);this.$form.find(".js-compose__header__name").remove()}if(patron.IsTablet&&document.activeElement&&$.isFunction(document.activeElement.blur)){document.activeElement.blur()}this._updateAffectedMessage(null);this.triggerHandler("submitsuccess",[this,g]);Counter.sb(326613);if(patron.ComposeLabels&&patron.editableContactsV2){this.__addNewContactsToLocalAB(b);$(".js-compose-labels",this.$form).each(function(){var a=$(this).composeLabels("widget")||null;delete b.EditContacts;delete b.edited_contacts;a.clearOriginContacts();a.clearChangedContacts()})}}else{if(this.isActive()){this._enableControls();this._setUnloadConfirm()}}this.submitting=0;this._hideLoading();patron.Notify.hide("send");if(this._sendNotifyTimeout){clearTimeout(this._sendNotifyTimeout);this._sendNotifyTimeout=void 0}this.enableEdit();(function(){var a=_sendmsg_log.load_end-_sendmsg_log.load_start|0,b=_sendmsg_log.render_end-_sendmsg_log.render_start|0,c="sendmsg",d=["load="+a,"render="+b,"done="+(a+b)],e;if(window.WebAgent&&WebAgent.ma&&WebAgent.ma._active){c+="_WA";if(WebAgent.ma.contactList&&WebAgent.ma.contactList.visible){c+="V"}}c+="_"+$.browser.label;patron.radar(c,d.join("&"));if(n){e={};if(this.getFileUploader().reattachInfo){e=this.getFileUploader().reattachInfo()}$.event.trigger("ui-abstract-action",{data:e,chain:["compose","send_error",n]})}}).bind(this)()},_updateAffectedMessage:function(a){var b=this._getAffectedMessage(),c=this.getDraftModeForSave(),d={};if(c==="drafts"&&b&&b.is("drafts.last_type")){c=b.get("drafts.last_type")}if(patron.MessageFromDraft&&b){d["drafts."+c]=a;d["drafts.last_type"]=c;b.set(d)}if(a){this._reloadViewer(a)}},_reloadViewer:function(a,b){var c=this.popups[b||this._popupName];try{var d=c.location.pathname,e=/^(\/attachment\/)[^\/]+/;if(e.test(d)){c.location=d.replace(e,"$1"+a)}}catch(a){}},_closeViewer:function(a){var b=this.popups[a||this._popupName];try{b.close()}catch(a){}},_saveDraftAndReloadViewer:function(a){var b=this.popups[a||this._popupName];try{if(b&&!b.closed){this._getActualDraft().done(function(b){if(b){if(b.flags.attach){this._reloadViewer(b.id,a)}else{this._closeViewer(a)}}}.bind(this))}}catch(a){}},getDraftModeForSave:function(){var a=this._getMessageMode();var b=[],c=[];Array.forEach(["To","CC"],function(a){b=b.concat(this._formElm(a).val().split(","))}.bind(this));Array.forEach(b,function(a){if(~a.indexOf("@")&&!~Array.indexOf(c,a)){c.push(a)}});if(a=="replyall"&&c.length===1){a="reply"}if(a=="reply"&&c.length>1){a="replyall"}return a},_getAffectedMessage:function(){var a,b=this._formElm("re_msg").val()||this._formElm("fwd_msg").val()||this._formElm("schedule_msg").val();if(b){a=patron.Messages.get(b)}return a},setFrom:function(a,b){this._fromDropdownClick(a,!b)},_fromDropdownClick:function(a,b,c){a.text(b);var d=this.signatures.find(function(a){return a.selected});if(d){this._setRealName(d.id,c)}},_getFrom:function(){return this.$form.find(".js-compose__select_email .dropdown__button-inline__text").text()||patron.useremail},_getMessageMode:function(){return this.parentView&&this.parentView.mode||"reply"},_getMessageFolderId:function(){var a={FolderId:null},b;if(this.parentView){b=this.parentView._url}if(b){a=patron.Messages.getSafe(String.toObject(b).id)}return a.FolderId},_closeDraftContainer:function(){this.$removeDraftContainer.display(0);require(["promo/build/balloons"],function(){patron.Balloon.updateStatus(patron.HelperIndex.draftInfomessage)});Counter.sb(1186800)},_openDraftContainer:function(a){a.preventDefault();a.stopPropagation();var b=this._formElm("draft_msg").val();var c="drafts&lazyreset&id="+b;Array.forEach(["reply","replyall","forward"],function(a){if(this.parentView.mode===a){var b=a==="forward"?"fwd_msg":"re_msg";c+="&draftrefid="+this._formElm(b).val();patron.radar("MessageFromDraft",a+"_loads=1")}}.bind(this));this.parentView.load(c);this.$removeDraftContainer.display(0)},_removeDraftContainer:function(a){a.preventDefault();this.$removeDraftContainer.display(0);Array.forEach(["reply","replyall","forward"],function(a){if(this.parentView.mode===a){patron.radar("MessageFromDraft",a+"_closes=1")}}.bind(this));var b=this._formElm("draft_msg").val();if(b){patron.Ajax({url:"/cgi-bin/movemsg",type:"POST",data:{id:b,remove:1,noredir:1,folder:Folder.TRASH},complete:function(a){this._updateAffectedMessage(null);Counter.sb(1033805)}.bind(this)})}},_submitWithoutAttachConfirmSuccess:function(){var a=this,b=a.options;b.isNewMessage=0;b.submitWithoutAttachConfirmSuccess=true;a.$form.trigger("submit")},_submitEmptyMessageConfirmSuccess:function(){var a=this,b=a.options;b.isNewMessage=0;b.submitEmptyMessageConfirmSuccess=true;a.$form.trigger("submit")},_send:function(a){a.preventDefault();if(this.disabled.send){return}this.$form.trigger("submit")},_toDrafts:function(a,b){a.preventDefault();if(this._isSavingTemplates&&!b){this._formElm("draft_msg").val(this._currentDraftMsgId||"")}this._isSavingTemplates=b;var c=b?this.disabled.templates:this.disabled.draft;if(c){return}var d=this.getFileUploader();if(d.isLoading()){this._disableSaveControl();this._removeAutoSaveInterval();d.one("onQueueFinsh",{scope:this},function(a){var c=a.data.scope;c._enableSave();c._toDrafts($.Event("anonymous"),b)})}else{this._save()}$win.triggerHandler("saveClick.compose")},_toTemplates:function(a){var b=this.templates.getActiveTemplate(),c=this._formElm("draft_msg");this._currentDraftMsgId=c.val();c.val(b?b.id:"");this._toDrafts(a,true)},_cancel:function(a){a.preventDefault();if(this.disabled.cancel||!this._confirmCancelChanges()){return}if(this.triggerHandler("cancel")!==false){jsHistory.set(jsHistory.previous||"/messages/inbox")}$win.triggerHandler("cancelClick.compose");this.$form.trigger("composecancel")},_confirmCancelChanges:function(){var a=this,b=a.getEditor();var c="compose.before_"+(a.supportBeforeUnload?"unload":"unloadfix")+"_confirm_text";if(a.isHTMLMode()){b.save({format:"raw"})}var d=a.$form.serialize();if(d!=a.currentFormData||a.getFileUploader().isLoading()){return confirm(Lang.get(c))}return true},_openAddressBook:function(a){AddressBook.open(a,this.$form)},_onUploaderFileShow:function(a){var b=this._popupName;this._popupName="viewer"+this.uniqId+popupId++;var c=this._openPopup("about:blank",this._popupName);if(b){this._closeViewer(b)}if(!c){return}c.onbeforeunload=function(){delete this.popups[this._popupName];c=null}.bind(this);this._getActualDraft().done(function(b){if(!c){return}if(b){var d="0;1";Array.some(b.get("attaches.list").toJSON(),function(b){var c=b.name;if(b.thumbnails.eml.subject){c=b.thumbnails.eml.subject+".eml"}var e=c===a.name;if(e){d=b.id}return e});var e=utils.createUrl("message",{messageId:b.id,partIds:d});c.onbeforeunload=null;this._openPopup(e,this._popupName)}}.bind(this)).fail(function(b){if(!c){return}this._closeViewer();var d=b.getData().capcha&&b.getData().capcha.error==="invalid";if(b.isManyRequests()||d){this._showCaptcha(patron.AccountVerified,d,function(b,c){var d=b.data.scope;$('input[name="security_image_word"]',d.$form).val(c||"");this.hide();d._onUploaderFileShow(a)})}}.bind(this))},_mobileVersionInit:function(){var a=this,b=a.options;var c=a.getEditorToolbar();c.hide();$(".mlr-snd_book",a.$form).hide();if(b.isStatic){a._mobileVersionReady();a.triggerHandler("redraw")}a.triggerHandler("init");$win.triggerHandler("init."+b.name);ajs.notify(b.name+".init")},_mobileVersionReady:function(){var a=this,b=a.options;var c=b.text;var d=a.getMainFrame();a._HTMLToTextSuccessCallback(c);d.removeClass("jsvh");a.defaultBodyText=c;a.currentFormData=a.$form.serialize();a.triggerHandler("ready")},_deviceVersionInit:function(){var a=this,b=a.options;var c=a.getEditorToolbar();var d=a.getMainFrame();d.removeClass("jsvh");c.hide();a.$form.bind("submit",$.proxy(a._onSubmit,a));a.$sendButton.bind("click",$.proxy(a._send,a));a.$draftButton.bind("click",$.proxy(a._toDrafts,a));a.$cancelButton.bind("click",$.proxy(a._cancel,a));if(b.isStatic){a._deviceVersionReady();a.triggerHandler("redraw")}this._fileUploaderInit();a.triggerHandler("init");$win.triggerHandler("init."+b.name);ajs.notify(b.name+".init")},_deviceVersionReady:function(){var a=this,b=a.options;var c=b.text;var d=a.getMainFrame();a._HTMLToTextSuccessCallback(c);d.removeClass("jsvh");a.defaultBodyText=c;a.currentFormData=a.$form.serialize();a._setResizeEvent();a._setKeyboardEvent();a._setUnloadConfirm();a._activeJsView();a._updateGeometry();a._enableCloudAttache();a.triggerHandler("ready");setTimeout(function(){$win.triggerHandler("ready."+b.name)},0)},_fileUploaderInit:function(){var a=this.getFileUploader(),b=this;a.bind({fileLoadError:function(a,c){b._showErrorSaveMailMessage(c.Error.replace("</center>",""),null,null,c)},onFilesLinkCodeChange:function(a,c){$('input[name="files_id"]',b.$form).val(c)},onFilesLinkCodeAdded:function(a,c){var d=$('input[name="files_id"]',b.$form),e=$.trim(d.val());d.val([].concat(c,e?e.split(","):[]).join(","))},onQueueChanged:function(a,c){b._enableSave();b._saveDraftAndReloadViewer.gap(b,0)();$win.resize()}});if(features.has("viewer-from-compose")){a.bind("onFileShow",function(a,c){b._onUploaderFileShow(c)})}this.bind("unactive reset redraw",function(b){var c=b.type;if(c=="unactive"){a.unactive()}else if(c=="reset"){a.reset()}else if(c=="redraw"){a.redraw(this.options.fileUploaderSettings)}})},_fullVersionInit:function(){var a=this,b=a.options;var c=a.getEditor();var d=a.getEditorToolbar();var e=a.getAppearance();var f=a.getEditorElement();var g=a.getMainFrame();var h=a.getEditorFrame();if($.browser.opera){f[0].spellcheck=c.getBody().spellcheck=0}this._fileUploaderInit();a.$form.bind("submit",$.proxy(a._onSubmit,a));a.$removeDraftContainer.find(".js-link").bind("click",a._openDraftContainer.bind(this));a.$removeDraftContainer.find(".js-close").bind("click",a._removeDraftContainer.bind(this));h.attr({hideFocus:"true",tabindex:f.attr("tabindex"),allowtransparency:"true"});if(!features.has("compose2")){g.bind("click",{scope:this},this._frameClick);f.click(function(a){a.stopPropagation()})}this.decoration.getItem("cards").bind({select:function(a,b,c){var d=a.currentTarget,e=this._formElm("Subject"),f=$.trim(e.val());if(!f||f==this.previosSubject){e.val(this.previosSubject=c.title)}var g=this.getEditor();g.focus();var h=g.selection;if(h.getNode()==g.getDoc()){var i=h.dom.createRng();i.setStart(g.getBody(),0);i.setEnd(g.getBody(),0);h.setRng(i)}var j=d.getPreviewHTML(b,c);var k=$(g.dom.get(d.cardContainerId));if(k.length){k.replaceWith(j)}else{h.setContent(j)}var l=$(g.dom.get(d.cardContainerId));var m=g.dom.get(d.cardMarkerId);h.select(m);h.collapse();this._updateFrameGeometry(undefined,l.height()+150);this._updateEditorGeometry();Counter.d(c.counter);$win.triggerHandler("editorToolbarButtonCardSelect.compose",[c.id])}.bind(this),clear:function(a){var b=a.currentTarget,c=this._formElm("Subject"),d=$.trim(c.val());var e=this.getEditor(),f=$(e.dom.get(b.cardContainerId));if(d==this.previosSubject){c.val("")}if(f.length){f.remove()}this.decoration.hide()}.bind(this)});this.decoration.getItem("appearance").bind({select:function(a,b,c){var d=this.getAppearance();d.setTemplate(c.id);$win.triggerHandler("editorToolbarButtonAppearanceSelect.compose",[c.id])}.bind(this),clear:function(a){var b=this.getAppearance();b.reset();this.decoration.hide()}.bind(this)});this.decoration.bind("show hide",function(a){var b=this.getEditor();var c={cards:b.controlManager.get("cards"),appearance:b.controlManager.get("design")};if(a.type=="hide"){$.each(c,function(a,b){if(b){b.setActive(false)}})}this._updateGeometry()}.bind(this));if(patron.ComposeCards){this.bind("submit",function(a){var b=this.getEditorElement(),c;var d=this.decoration.getItem("cards");c=d.selectedItem;if(c&&c.counter&&b.val().indexOf(d.cardId)!==-1){Counter.sb(c.counter)}}.bind(this))}e.bind({changeTemplate:$.proxy(function(a,b){var c=this;var d=c.getEditorFrame();var e=c.getEditorFrameBody();e.css({backgroundColor:b.background||"",color:b.color||"",fontFamily:b.fontFamily||"",textAlign:b.textAlign||"",overflow:"hidden"});d.attr("scrolling","no")},a),clear:$.proxy(function(){var a=this;var b=a.getEditorFrame();var c=a.getEditorFrameBody();c.css({backgroundColor:"",color:"",fontFamily:"",textAlign:"",overflow:"auto"});b.attr("scrolling","auto")},a),"showLayer hideLayer":$.proxy(function(a){var b=this;var c=b.getEditor();var d=c.controlManager.get("design");if(d)d.setActive(a.type=="showLayer")},a),"showLayer hideLayer changeTemplate clear":$.proxy(a._updateGeometry,a),"changeTemplate clear":$.proxy(function(){var a=this;var b=a.getAppearance().getCurrentTemplate();$('input[name="template_id"]:first',a.$form).val(b?b.id:"")},a)});a.bind("enableTextEditor",function(){var a=this.getMainFrame();a.css({width:"auto",height:"auto"})});if($.browser.opera){a.one("enableTextEditor",function(){var a=this,b=a.getEditorElement();setTimeout(function(){b.css("display","block")},0)})}this.bind("unactive reset redraw",function(a){var b=a.type;if(b=="unactive"){this.appearance.unactive()}else if(b=="reset"){this.appearance.reset();this.decoration.hide()}});if(b.ShowSecurityImage){a.one("ready",function(){this._showCaptcha(patron.AccountVerified)})}c.selection.onSetContent.add(a._setUpdateEditorGeometryTimeout,a);c.onEvent.add(a._setUpdateEditorGeometryTimeout,a);c.onSetContent.add(a._setUpdateEditorGeometryTimeout,a);c.onClick.add(function(a,b){if(b.target.nodeName=="A"){try{window.open(b.target.href)}catch(a){}}},a);c.onCreateLink.add(function(a,b){$.event.trigger("ui-abstract-action",{chain:["compose","editor","createlink"]})});function i(a){var b=a.id.replace(c.id+"_","");$win.triggerHandler("editorToolbarButtonDropDownClick.compose",[b])}$.each(["emotions","forecolor","backcolor","fontactions","justifyselect","textindentactions","bullistactions"],function(a,b){var d=c.controlManager.get(b);d&&d.onShowMenu.add(i)});var j=c.controlManager.get("signature");if(j){j.onShowMenu.add(i)}var k=c.controlManager.get("emoji");if(k){k.onShowMenu.add(function(){$.event.trigger("ui-abstract-action",{chain:["click-emoji-dropdown","click"]})})}var l=c.controlManager.get("moreactions");if(l){l.onShowMenu.add(i)}c.onExecCommand.add(function(a,b,c,d,e){var f=this.getAppearance();var g={cards:a.controlManager.get("cards"),appearance:a.controlManager.get("design")};if(b=="mceAppKeyboard"){this.keyboard()}else if(b=="mceAppTransfer"){this.transfer()}else if(b=="mceAppTranslit"){this.translit()}else if(b=="mceInlineAttach"){this.inlineAttach()}else if(b=="mceAppSpelling"){this.spelling()}else if(b=="mceEnableTextEditor"){this.enableTextEditor()}else if(b=="mceEnableHTMLEditor"){this.enableHTMLEditor()}else if(b=="mceSetSignature"){this._setRealName(d);$win.triggerHandler("editorToolbarSignatureClick.compose",[d])}if(b=="mceShowCards"||b=="mceHideCards"||b=="mceShowTemplates"||b=="mceHideTemplates"){this.decoration.hide()}if(b=="mceShowCards"){this.decoration.show("cards",0);g["cards"].setActive(true)}else if(b=="mceShowTemplates"){this.decoration.show("appearance",0);g["appearance"].setActive(true)}$win.triggerHandler("editorToolbarButtonClick.compose",[b])},a);if($.support.fileapi){this.dragAndDrop.initialize()}if(b.isStatic){setTimeout(function(){a._fullVersionReady();a.triggerHandler("redraw")},0)}a.triggerHandler("init");$win.triggerHandler("init."+b.name);ajs.notify(b.name+".init");this._triggerBalloon()},_triggerBalloon:function(){require(["promo/build/balloons"],function(){bus.emit("show-html-signature-balloon")})},inlineAttach:function(){},_addToggleEditorToolbarObserver:function(){},_fullVersionReady:function(){var a=this,b=a.options;var c=a.getEditor();var d=a.getMainFrame();var e=a.getAppearance();var f=$('input[name="HTMLMessage"]',a.$form).val()>0;var g=b.text,h=b.html;a._addToggleEditorToolbarObserver();c.undoManager.clear();d.removeClass("jsvh");try{if(f){var i=e.getTemplateId(h);if(i){e.setTemplate(i);h=e.removeTemplate(h)}a._textToHTMLSuccessCallback(h,true)}else{a._HTMLToTextSuccessCallback(g,true);c.setContent(h,{format:"raw"})}}catch(a){}this.defaultBodyHTML=c.getContent({format:"raw"});this.defaultBodyText=g;a._setResizeEvent();a._setKeyboardEvent();a._enableSave();a._setUnloadConfirm();a._enableCloudAttache();a._enableAttachesKeepAlive(a.options.keepAliveTimeout);a._activeJsView();a._updateGeometry();c.onInit.dispatch(c);a.focus();this.currentFormData=a.$form.serialize();a.triggerHandler("ready");patron.Utils.getAddressBook();var j=this._getMessageFolderId();var k=this._formElm("draft_msg").val();var l=this._getMessageMode();if(patron.MessageFromDraft&&j!=Folder.DRAFTS&&k&&l!=="drafts"&&(this.isReply()||this.isForward())){this.$removeDraftContainer.display(1);Array.forEach(["reply","replyall","forward"],function(a){if(this.parentView.mode===a){patron.radar("MessageFromDraft",a+"_shown=1")}}.bind(this))}else{this.$removeDraftContainer.display(0)}var m;if(patron["EnableAttachFromCloud"]){m=$('input[name="cloud_files_ids"]',a.$form).val()}if(m){var n=[];try{n=JSON.parse(m)}catch(a){}if(n.length){var o=[];Array.forEach(n,function(a){o.push({method:"file",params:{home:a}})});patron.API({url:"cloud/batch",data:{batch:o,htmlencoded:false},complete:function(b){var c=[];if(b.isOK()){var d=b.getData();Array.forEach(d,function(b,d){var e=new patron.API.Response(b);if(e.isOK()){c.push(a.attachFromCloudUI.prepareFileData(e.getData(),d))}})}if(c.length){a._attachFilesFromCloud(c)}}})}}$(".js-compose-labels",this.$form).each(function(){$(this).composeLabels("widget").disable(false)});setTimeout(function(){$win.triggerHandler("ready."+b.name)},0)},_attachFilesFromFileSearch:function(a,b){this._attachFilesFrom(a,"fileSearch",b)},_attachFilesFromCloud:function(a,b){this._attachFilesFrom(a,"cloud",b)},_attachFilesFrom:function(a,b,c){var d=this.fileUploader.uploaderHTML5._spaceLeft,e=[],f={},g=[],h=b=="cloud",i=b=="fileSearch",j=h?this.Attaches.cloud:this.Attaches.forward;Array.forEach(a,function(a){var b=patron.EnableComposeMultiAttach?a.uid:a.uid=ajs.uniqId();f[b]=true;a.partId=h?a.id:a.PartID;a.onlyPartId=true;a.fromCloud=h;a.fromFilesearch=i;if(!j.files[b]){if(d-a.size<0){a.isFiles=!patron.UseSendAPIV1||!c}else{d-=a.size}e.push(a)}});Object.forEach(j.files,function(a,b){if(!patron.EnableComposeMultiAttach||f[b]){}else{g.push(b)}});this.fileUploader.removeFiles(g);if(e.length){this.fileUploader.uploaderHTML5.one("attachFiles",function(a,b){Array.forEach(b,function(a){var b=a.fromCloud?this.Attaches.cloud:this.Attaches.forward;if(!a.PartId&&a.fromCloud&&a._file){a.PartId=a._file.downloadlink+":"+a.size}if(!b.files[a.uid]){b.files[a.uid]=a;b.sizes[a.uid]=a.size;b.size+=a.size}}.bind(this))}.bind(this));this.fileUploader.attach(e,c)}},_activeJsView:function(){ajs.wait("patron.Views.ready",function(){var a=this,b=jsView.get(a.options.name);if(b){b.$Loader&&b.$Loader.hide();if(b.isActive()){b.getView().show();$win.resize();if($.browser.msie){var c=a.getEditorFrameBody();if($.browser.intVersion<8){setTimeout(function(){c[0].innerHTML=c[0].innerHTML+"";a.setCaretPositionInStart()},0)}else if(patron.v2&&$.browser.intVersion<9){var d=c.css("overflow");c.css("overflow","");setTimeout(function(){c.css("overflow",d)},0)}}}a.focus()}}.bind(this))},_showCaptcha:function(a,b,c){c=c||this._captchaCheckSuccess;this._clearCaptcha();if(a){require(["patron.compose/patron.Compose.Captcha"],function(a){MessagesLayers("/compose/captcha",function(){if(this.captcha){this.captcha.unbind("checkSuccess")}this.captcha=new patron.Compose.Captcha({is_verified:true,layer:a});this.captcha.bind("checkSuccess",{scope:this},c);this.captcha.show(b)}.bind(this))}.bind(this))}else{require(["patron.compose/patron.Compose.CaptchaCombine"],function(){MessagesLayers("/account/verify",function(a){if(this.captchaVerified){this.captchaVerified.unbind("verifySuccess")}this.captchaVerified=new patron.Compose.CaptchaCombine({is_verified:false,layer:a});this.captchaVerified.bind("verifySuccess",{scope:this},c);this.captchaVerified.show(b)}.bind(this))}.bind(this))}},_captchaCheckSuccess:function(a,b){var c=this,d=a.data.scope;$('input[name="security_image_word"]',d.$form).val(b||"");c.hide();d.$form.trigger("submit")},_clearCaptcha:function(){$('input[name="security_image_word"]',this.$form).val("")},_setKeyboardEvent:function(){this.$form.bind("keydown.composeinner",this.keyboardObserver)},_setResizeEvent:function(){$win.bind("resize.composeinner",$.proxy(this._setUpdateEditorFrameOnResizeTimeout,this))},_prepareContent:function(a){a=patron.Utils.Fishing.removeRedirectorFromText(a);a=patron.Compose.Utils.removeEmptySignature(a);if(patron.UseSendAPIV1){var b,c=/(?:\?|&)id=([^&]+)/,d=this.Attaches.inline={},e=this.Attaches.inlineUploaded,f=this.fileUploader.uploaderHTML5._reattachData.inline;Object.forEach(this.options.map_inline_img,function(g,h){a=a.replace(new RegExp(String.preg_quote(ajs.Html.escape(h)),"gi"),function(){if(!d[h]){if(e[h]){d[h]=e[h]}else if(b=h.match(c)){if(f[b[1]]){d[h]={id:f[b[1]].id,content_id:g}}else{d[h]={part_id:b[1],content_id:g}}}}return"cid:"+g})})}else{Object.forEach(this.options.map_inline_img,function(b,c){var d=new RegExp("\\/\\/((ap?f(\\d+(-\\d+)?)?)|((ima\\d+(-\\d+)?)|af\\.dev|aftest\\d+))\\.mail\\.ru\\/cgi-bin\\/readmsg\\?id="+c+'\\&(amp;)?mode=attachment[^"]*',"gi");a=a.replace(d,b)})}a=a.replace(_rurl717,"http://");return a},_enableTextEditorConfirmSuccess:function(){this._convertHTMLToText()},_enableTextEditor:function(){var a=this.getEditor();var b=this.getEditorElement();var c=this.getEditorContainer();var d=this.getAppearance();b.show();c.hide();this.editorMode=patron.Compose.Form.M_TEXT;this.$form.addClass("editorTextMode").removeClass("editorHTMLMode");d.reset();this.decoration.hide();$('input[name="HTMLMessage"]:first',this.$form).val(0);this._setEditorControlsState(["design","cards"],false);var e=this.options.domIDs;$(e.composeEditor_toolbar1,this.$form).css("visibility","hidden");$(e.composeEditor_toolbar3,this.$form).css("visibility","visible");if(this.translator){this.translator.textEditorEnabled=true}this._updateGeometry()},_setEditorControlsState:function(a,b){var c=this.getEditor();if(c){a.forEach(function(a){var d=c.controlManager.get(a);if(d){d.setDisabled(!b)}})}},_convertHTMLToText:function(){var a=this;var b=a.getEditor();var c=b.getContent({format:"raw"});c=patron.Compose.Utils.convertEmptySignatureToText(c);var d=/[\0-\x1F\x7F-\x9F\xAD\u0378\u0379\u037F-\u0383\u038B\u038D\u03A2\u0528-\u0530\u0557\u0558\u0560\u0588\u058B-\u058E\u0590\u05C8-\u05CF\u05EB-\u05EF\u05F5-\u0605\u061C\u061D\u06DD\u070E\u070F\u074B\u074C\u07B2-\u07BF\u07FB-\u07FF\u082E\u082F\u083F\u085C\u085D\u085F-\u089F\u08A1\u08AD-\u08E3\u08FF\u0978\u0980\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FC-\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A76-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B55\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0C00\u0C04\u0C0D\u0C11\u0C29\u0C34\u0C3A-\u0C3C\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5A-\u0C5F\u0C64\u0C65\u0C70-\u0C77\u0C80\u0C81\u0C84\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDD\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0D01\u0D04\u0D0D\u0D11\u0D3B\u0D3C\u0D45\u0D49\u0D4F-\u0D56\u0D58-\u0D5F\u0D64\u0D65\u0D76-\u0D78\u0D80\u0D81\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E86\u0E89\u0E8B\u0E8C\u0E8E-\u0E93\u0E98\u0EA0\u0EA4\u0EA6\u0EA8\u0EA9\u0EAC\u0EBA\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F5-\u13FF\u169D-\u169F\u16F1-\u16FF\u170D\u1715-\u171F\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u180F\u181A-\u181F\u1878-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191D-\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE-\u1AFF\u1B4C-\u1B4F\u1B7D-\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C80-\u1CBF\u1CC8-\u1CCF\u1CF7-\u1CFF\u1DE7-\u1DFB\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2072\u2073\u208F\u209D-\u209F\u20BB-\u20CF\u20F1-\u20FF\u218A-\u218F\u23F4-\u23FF\u2427-\u243F\u244B-\u245F\u2700\u2B4D-\u2B4F\u2B5A-\u2BFF\u2C2F\u2C5F\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E3C-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u312E-\u3130\u318F\u31BB-\u31BF\u31E4-\u31EF\u321F\u32FF\u4DB6-\u4DBF\u9FCD-\u9FFF\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA698-\uA69E\uA6F8-\uA6FF\uA78F\uA794-\uA79F\uA7AB-\uA7F7\uA82C-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C5-\uA8CD\uA8DA-\uA8DF\uA8FC-\uA8FF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9E0-\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAA7C-\uAA7F\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F-\uABBF\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC2-\uFBD2\uFD40-\uFD4F\uFD90\uFD91\uFDC8-\uFDEF\uFDFE\uFDFF\uFE1A-\uFE1F\uFE27-\uFE2F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD-\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFFB\uFFFE\uFFFF]/g;c=c.replace(d,"");if(a.xhrs["HTMLToText"])a.xhrs["HTMLToText"].abort();if($.trim(c)){if(c===a.defaultBodyHTML){a._HTMLToTextSuccessCallback(a.defaultBodyText)}else{a.xhrs["HTMLToText"]=AjaxCall.send("/cgi-bin/ajax_text_utils","to_text",[c],$.proxy(a._HTMLToTextSuccessCallback,a),$.proxy(a._HTMLToTextErrorCallback,a))}}else{a._HTMLToTextSuccessCallback("")}},_enableTextEditorConfirmError:function(){var a=this;var b=a.getEditor();b.focus()},_HTMLToTextSuccessCallback:function(a,b){var c=this,d=c.getEditorElement();c._enableTextEditor();d.val(a).show();if(!b)c.setCaretPositionInStart();c.triggerHandler("enableTextEditor")},_HTMLToTextErrorCallback:function(){},_textToHTMLSuccessCallback:function(a,b){var c=this;var d=c.getEditor();var e=c.getEditorContainer();c._enableHTMLEditor();d.setContent(a,{format:"raw",initial:true});d.save({format:"raw"});if(!b)c.setCaretPositionInStart();c.triggerHandler("enableHTMLEditor")},_textToHTMLErrorCallback:function(){},_enableHTMLEditor:function(){var a=this;var b=a.getEditor();var c=a.getEditorElement();var d=a.getEditorContainer();c.hide();d.show();a.editorMode=patron.Compose.Form.M_HTML;a.$form.removeClass("editorTextMode").addClass("editorHTMLMode");$('input[name="HTMLMessage"]:first',a.$form).val(1);this._setEditorControlsState(["design","cards"],true);var e=a.options.domIDs;$(e.composeEditor_toolbar1,this.$form).css("visibility","visible");$(e.composeEditor_toolbar3,this.$form).css("visibility","hidden");if(this.translator){this.translator.textEditorEnabled=false}a._updateGeometry()},_convertTextToHTML:function(){var a=this;var b=a.getEditorElement();var c=b.val();if(a.xhrs["textToHTML"])a.xhrs["textToHTML"].abort();if($.trim(c)){if(c===a.defaultBodyText){a._textToHTMLSuccessCallback(a.defaultBodyHTML)}else{a.xhrs["textToHTML"]=AjaxCall.send("/cgi-bin/ajax_text_utils","to_html",[c],$.proxy(a._textToHTMLSuccessCallback,a),$.proxy(a._textToHTMLErrorCallback,a))}}else{a._textToHTMLSuccessCallback("")}},isEmptyContent:function(){var a=this,b=a.options;var c=a.getEditorElement();if(a.isHTMLMode()){var d=a.getEditorFrameBody();return!b.issetContentPattern.test(d.html())&&!$.trim(d.text())}else{return!$.trim(c.val())}},isDefaultContent:function(){var a=$.trim(this.isHTMLMode()?this.defaultBodyHTML:this.defaultBodyText),b=$.trim(this.isHTMLMode()?this.getEditor().getContent({format:"raw"}):this.getEditorElement().val());return a===b},isReplyDraft:function(){return this.isReply()&&this.isDraft()},isSignatureContent:function(){var a=false;if(!this.RealNamesSignatures.length){return a}this.RealNamesSignatures.forEach(function(b){var c=/[\n\r]/g,d=b.signature.trim().replace(c,""),e=this.defaultBodyText.trim().replace(c,"");if(ajs.HTML.unescape(d)===e){a=true}}.bind(this));return a},isNew:function(){return this.options["isNewMessage"]},isReply:function(){return this._formElm("re_msg").val()!=""},isDraft:function(){return!this.isNew()&&this._formElm("draft_msg").val()!=""},isForward:function(){return this._formElm("fwd_msg").val()!=""},isNewTemplate:function(){return this.templates&&this.templates.isCreatingTemplateMode},getTemplates:function(a){return this.templates&&this.templates.getTemplates(a)},_getState:function(a){return Object.extend({isNewMessage:this.isNew()||this.isDraft()&&!this.isReply()&&!this.isForward()||this.isReply(),isNewTemplate:this.isNewTemplate(),disabled:this.disabled,messageMode:this._getMessageMode()},a)},isChanged:function(){var a=this.$form.serialize();return a!=this.currentFormData},_hasFormatted:function(){var a=this,b=a.options;var c=a.getEditor();return a.isHTMLMode()&&b.hasFormattedPattern.test(c.getContent({format:"raw"}))},_showCustomFields:function(){var a=this;a.$showCustomFieldsLink.parents(".mlr-snd_rw:first").hide();$(".mlr-snd_h",a.$form).removeClass("jsdn");$win.resize()},_hideCustomFields:function(){var a=this;a.$showCustomFieldsLink.parents(".mlr-snd_rw:first").show();$(".mlr-snd_h",a.$form).addClass("jsdn");$win.resize()},_openPopup:function(a,b,c){var d;try{if(arguments.length===3){d=window.open(a,b,c)}else{d=window.open(a,b)}this.popups[b]=d;d.focus()}catch(a){}return d},_showLoading:function(a){var b=this.getSaveMailSuccessMessageContainer();var c=this.getSaveMailErrorMessageContainer();var d=a||Lang.get("Loading").messages;var e=this.getLoadingContainer();b.add(c).hide();e.text(d).show();this.$form.trigger("compose-error",{state:false}).trigger("compose-success",{state:false}).trigger("compose-loading",{text:d,state:true})},_hideLoading:function(){var a=this.getLoadingContainer();a.hide();this.$form.trigger("compose-loading",{state:false})},disableEdit:function(){var a=this;if($.browser.msie&&parseInt($.browser.version)<8)a.$composeDisableFormLayer.css("height",a.$composeDisableFormLayer.parent()[0].offsetHeight);a.$composeDisableFormLayer.show();return this},enableEdit:function(){var a=this;a.$composeDisableFormLayer.hide();return this},saveContentTemporally:function(){if(this._getMessageMode()!=="forward"){tmpContent=this.getContent()}},applyTemporallySavedContent:function(){if(tmpContent!==undefined&&this._getMessageMode()!=="forward"){this.setContent(tmpContent)}},getContent:function(){var a=this;var b=a.getEditor();var c=a.getEditorElement();return a.isHTMLMode()?b.getContent({format:"raw"}):c.val()},setContent:function(a){var b=this;var c=b.getEditor();var d=b.getEditorElement();var e=b.isHTMLMode()?c.setContent(a,{format:"raw"}):d.val(a);if($.browser.safari){this.setCaretPositionInStart()}return e},isHTMLMode:function(){var a=this;return a.editorMode==patron.Compose.Form.M_HTML},enableTextEditor:function(){if(!this.isHTMLMode()){return}var a=this.getEditor(),b=a.getContent({format:"raw"});if(this._hasFormatted()){MessagesLayers("/compose/textMode",function(){var a=this.getEnableTextConfirmLayer();a.one("callback",function(a,b){if(b){this._enableTextEditorConfirmSuccess()}else{this._enableTextEditorConfirmError()}}.bind(this))[0].show()}.bind(this))}else{this._enableTextEditorConfirmSuccess()}},enableHTMLEditor:function(){var a=this;if(a.isHTMLMode())return;a._convertTextToHTML()},keyboard:function(){var a=this;var b=a.isHTMLMode()?3:0;a._openPopup("/keyboard?form=Compose&text=Body&keymode=2&savemode="+b,"keyb","height=384,width=610,toolbar=no,menubar=no,location=no,scrollbars=no,focus=yes,top=50,left=50")},transfer:function(){if(features.has("compose2")&&features.has("use-translate-api")){return Compose2Patch.methods.transfer.call(this)}var a=this,b=a.getEditor(),c=a.getEditorElement();if(a.isHTMLMode()){b.save({format:"raw"})}$('input[name="text"]:first',a.$form).val(c.val());if(patron.IsMyCom){if($.trim(a.getContent())!==""){LayerManager.translator({getContent:function(){return a.getContent()},setContent:function(b){a.setContent(b)}})}}else{a._openPopup("/cgi-bin/translate","transfer","menubar=no,resizable=yes,width=750,height=500,toolbar=no,focus=yes,scrollbars=yes,screenX=50,screenY=50,left=50,top=50")}},spelling:function(){var a=this;var b=a.getEditor();var c=a.getEditorElement();if(a.isHTMLMode())b.save({format:"raw"});$('input[name="text"]:first',a.$form).val(c.val());a._openPopup("/compose/spellcheck/","spelling","menubar=no,resizable=yes,width=750,height=524,toolbar=no,focus=yes,scrollbars=yes,screenX=50,screenY=50,left=50,top=50")},translit:function(){var a=this;var b=a.getEditor();var c=a.getEditorElement();if(a.isHTMLMode())b.save({format:"raw"});if(a.xhrs["translit"])a.xhrs["translit"].abort();var d=c.val();if($.trim(d)){var e=[d,"1"];a.xhrs["translit"]=AjaxCall.send("/cgi-bin/ajax_spell","ajax_translit",e,$.proxy(a._applyTranslit,a))}},focus:function(a){var b=this.getEditor();var c=this.getEditorElement();var d=document.activeElement;if(d&&d.id!="ScrollBodyFocus"&&d.tagName=="INPUT"||$.browser.ios){return}if(this.isNew()||this.isForward()||a=="to"){this._formElm("To").focus()}else{this.setCaretPositionInStart()}return this},getScrollTop:function(){if(this.isHTMLMode()){return this.getEditorFrameBody().prop("scrollTop")}else{return this.getEditorElement().prop("scrollTop")}},setCaretPositionInStart:function(){var a=this;var b=a.getEditor();var c=a.getEditorElement();if(a.isHTMLMode()){try{var d=b.selection;var e=d.dom.createRng();e.setStart(b.getBody(),0);e.setEnd(b.getBody(),0);d.setRng(e);b.getWin().scrollTo(0,0);b.focus()}catch(a){}}else{$.Autocompleter.Selection(c[0],0,0)}},getEnableTextConfirmLayer:function(){return new Layer("is-compose-textMode")},getAppearance:function(){return this.appearance||(this.appearance=new patron.Compose.Appearance(this.getMainFrame(),{domIDs:this.options.domIDs}))},getFileUploader:function(){return this.fileUploader},getEditorId:function(){return this.options.editorId},getMainFrame:function(){return this.$composeEditorFrame},getEditor:function(){return this.editor||(this.editor=tinyMCE.get(this.getEditorId()))},getEditorElement:function(){return this.$editorElement||(this.$editorElement=$("#"+this.getEditorId()))},getEditorContainer:function(){var a=this.getEditor();return this.$editorContainer||(this.$editorContainer=a&&$(a.getContainer())||$())},getEditorFrame:function(){return this.$editorFrame||(this.$editorFrame=$("#"+this.getEditor().id+"_ifr"))},getEditorToolbar:function(){return this.$editorToolbar||(this.$editorToolbar=$(this.options.domIDs.toolbar_external))},getEditorFrameBody:function(){return this.$editorFrameBody||(this.$editorFrameBody=$(this.getEditor().getBody()))},getSaveMailSuccessMessageContainer:function(){return this.$saveMailSuccessMessage||(this.$saveMailSuccessMessage=$(".saveMailSuccessMessage:first",this.$form))},getSaveMailErrorMessageContainer:function(a){if(a){return this.$saveMailErrorMessage||(this.$saveMailErrorMessage=$(".saveMailErrorMessage:first",this.$form))}else{return this.$errorContainer||(this.$errorContainer=$(this.options.domIDs.composeError))}},getLoadingContainer:function(){return this.$loading||(this.$loading=$(".js-saveMailLoadProgress",this.$form))},getBottomControlsContainer:function(){return this.$bottomControls||(this.$bottomControls=$(this.options.domIDs.bottomComposeControls))},getBottomControlsHeight:function(){var a=this.getBottomControlsContainer();return a[0]&&!features.has("compose2-attachments-atop")?a[0].offsetHeight:0},getCaptchaContainer:function(){return this.$captchaContainer||(this.$captchaContainer=$(this.options.domIDs.composeCaptchaContainer))},getClientRect:function(){return this.$form[0].getBoundingClientRect()},hasAttachments:function(){this.updateEditorElement();this._updateAttachesFields();return!!this._getAttachments(this.$form.toObject()).length},getEnteredText:function(){var a=this.getEditor(),b,c,d;if(!a){c=this._getContentWithoutSignature(this.getContent());d=c.split("\n");if(d&&d.length){c=d.filter(function(a){return!/>.+/.test(a)}).join("\n")}}else{b=$(a.getBody()).clone();b=b.find("blockquote").remove().end();b=b.find("br").replaceWith("\n").end();c=this._getContentWithoutSignature(b.html())}return c}},features.has("compose2")?Compose2Patch.methods:{}))})(jQuery)});define("patron.build/Compose",["tinymce","patron.compose/patron.Compose.Form"],function(){});window.$=window.jQuery=jQuery});